- en: '7'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '7'
- en: Monitoring with CloudWatch, CloudTrail, and Config
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 CloudWatch、CloudTrail 和 Config 进行监控
- en: We’ve already looked at many aspects of security, such as **Confidentiality**
    , **Integrity** , and **Availability** ( **CIA** ) and **Authentication** , **Authorization**
    , and **Accounting** ( **AAA** ). Accounting can be achieved through **continuous
    monitoring** , **alerting** , and regular **auditing** . Proper monitoring and
    alerting can also help in better availability through **auto-remediation** . In
    this chapter, we will look into **Amazon CloudWatch** , **AWS CloudTrail** , and
    **AWS Config** . CloudWatch is the primary service within AWS for **logging**
    , **monitoring** , and alerting. CloudTrail can log AWS API calls. AWS Config
    can record and evaluate configurations against predefined config rules. We will
    also learn about **Simple Notification Service** ( **SNS** ), which will allow
    us to send notifications.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经讨论了许多关于安全的方面，例如**保密性**、**完整性**和**可用性**（**CIA**）以及**认证**、**授权**和**审计**（**AAA**）。审计可以通过**持续监控**、**警报**和定期**审计**来实现。适当的监控和警报也可以通过**自动修复**来提高可用性。在本章中，我们将研究**Amazon
    CloudWatch**、**AWS CloudTrail**和**AWS Config**。CloudWatch 是 AWS 中用于**日志记录**、**监控**和警报的主要服务。CloudTrail
    可以记录 AWS API 调用。AWS Config 可以记录并评估配置是否符合预定义的配置规则。我们还将了解**简单通知服务**（**SNS**），它将帮助我们发送通知。
- en: 'In this chapter, we will cover the following recipes:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将涵盖以下食谱：
- en: Creating an SNS topic to send emails
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 创建 SNS 主题以发送电子邮件
- en: Working with CloudWatch alarms and metrics
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 CloudWatch 警报和指标
- en: Creating a CloudWatch log group
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 创建一个 CloudWatch 日志组
- en: Working with EventBridge (previously CloudWatch Events)
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 EventBridge（之前是 CloudWatch Events）
- en: Reading and filtering logs in CloudTrail
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 CloudTrail 中读取并过滤日志
- en: Creating a trail in CloudTrail
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 CloudTrail 中创建轨迹
- en: Using Athena to query CloudTrail logs in S3
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 Athena 查询 S3 中的 CloudTrail 日志
- en: Integrating CloudWatch with CloudTrail making use of a CloudFormation template
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 CloudFormation 模板将 CloudWatch 与 CloudTrail 集成
- en: Setting up and using AWS Config
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 设置和使用 AWS Config
- en: Technical requirements
  id: totrans-13
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'Before diving into the recipes of this chapter, we need to ensure we have the
    following requirements and knowledge in place:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 在开始本章的操作之前，我们需要确保具备以下要求和知识：
- en: We need an active AWS account to complete the recipes within this chapter. We
    can use an account that is part of an AWS Organization or a standalone account.
    I will be using the **awsseccb-sandbox-1** account that we created in the *Multi-account
    management with AWS Organizations* recipe in [*Chapter 1*](B21384_01.xhtml#_idTextAnchor020)
    . However, I won’t be utilizing any AWS Organizations features, meaning you can
    follow these steps with a standalone account too.
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们需要一个有效的 AWS 账户来完成本章的所有操作。我们可以使用属于 AWS 组织的一部分的账户或独立账户。我将使用我们在[*第1章*](B21384_01.xhtml#_idTextAnchor020)的*使用
    AWS 组织进行多账户管理*食谱中创建的**awsseccb-sandbox-1**账户。不过，我不会使用任何 AWS 组织功能，这意味着你也可以使用独立账户跟随这些步骤。
- en: For administrative actions, we need a user who has **AdministratorAccess** permission
    to the AWS account we are working with. This can be an **Identity and Access Management**
    ( **IAM** ) Identity Center user or an IAM user. I will be using the **awsseccbadmin1**
    IAM Identity Center user we created in the *User management and SSO with IAM Identity
    Center* recipe in [*Chapter 1*](B21384_01.xhtml#_idTextAnchor020) . However, I
    won’t be utilizing any IAM Identity Center features, meaning you can follow these
    steps with an IAM user, too, if the user has **AdministratorAccess** permission
    within the account. You can create an IAM user following the *Setting up IAM,
    an account aliases, and billing alerts* recipe in [*Chapter 1*](B21384_01.xhtml#_idTextAnchor020)
    .
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于管理操作，我们需要一个具有**AdministratorAccess**权限的用户来操作 AWS 账户。这可以是一个**身份与访问管理**（**IAM**）身份中心用户或
    IAM 用户。我将使用我们在[*第1章*](B21384_01.xhtml#_idTextAnchor020)的*使用 IAM Identity Center
    进行用户管理和 SSO*食谱中创建的**awsseccbadmin1** IAM Identity Center 用户。不过，我不会使用任何 IAM Identity
    Center 功能，这意味着如果用户在账户中具有**AdministratorAccess**权限，你也可以使用 IAM 用户执行这些步骤。你可以按照[*设置
    IAM、账户别名和账单警报*](B21384_01.xhtml#_idTextAnchor020)食谱创建一个 IAM 用户。
- en: The code files for this chapter are available at [https://github.com/PacktPublishing/AWS-Security-Cookbook-Second-Edition/tree/main/Chapter07](https://github.com/PacktPublishing/AWS-Security-Cookbook-Second-Edition/tree/main/Chapter07)
    .
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 本章的代码文件可在[https://github.com/PacktPublishing/AWS-Security-Cookbook-Second-Edition/tree/main/Chapter07](https://github.com/PacktPublishing/AWS-Security-Cookbook-Second-Edition/tree/main/Chapter07)找到。
- en: Creating an SNS topic to send emails
  id: totrans-18
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建 SNS 主题以发送电子邮件
- en: In this recipe, we will learn how to create an SNS topic for sending emails.
    SNS is a managed **publish/subscribe messaging service** and can be used with
    many endpoints, such as email, **SMS** , **Lambda** , **Simple Queue Service**
    ( **SQS** ), and more.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在本示例中，我们将学习如何创建一个SNS主题来发送电子邮件。SNS是一个托管的**发布/订阅消息服务**，可以与多种端点一起使用，如电子邮件、**短信（SMS）**、**Lambda**、**简单队列服务（SQS）**等。
- en: Getting ready
  id: totrans-20
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备开始
- en: To successfully complete this recipe, we need a working AWS account, and a user
    as described in the *Technical requirements* section, and a working email address.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 为了成功完成本示例，我们需要一个有效的AWS账户，一个如*技术要求*部分所述的用户，以及一个有效的电子邮件地址。
- en: How to do it...
  id: totrans-22
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'We can configure an SNS topic to send emails as follows:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以按照以下方式配置SNS主题来发送电子邮件：
- en: Go to the **Simple Notification Service** service in the console.
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 进入控制台中的**简单通知服务（SNS）**。
- en: From the left sidebar, click on **Topics** .
  id: totrans-25
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在左侧边栏，点击**主题**。
- en: Click on **Create topic** .
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**创建主题**。
- en: For **Type** , select **Standard** .
  id: totrans-27
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对于**类型**，选择**标准**。
- en: For the **Name** and **Display name - optional** fields, give meaningful values.
    I have given the name **MyEmailTopic** and the display name **My** **Email Topic**
    .
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对于**名称**和**显示名称（可选）**字段，输入有意义的值。我输入的名称是**MyEmailTopic**，显示名称是**My Email Topic**。
- en: Leave the other options as-is and scroll down to the bottom of the page. Click
    on **Create topic** .
  id: totrans-29
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 保持其他选项不变，向下滚动至页面底部，点击**创建主题**。
- en: Go to the **Subscriptions** tab of our topic.
  id: totrans-30
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 进入我们主题的**订阅**标签。
- en: Click on **Create subscription** .
  id: totrans-31
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**创建订阅**。
- en: On the **Create subscription** page, set the **Protocol** field to **Email**
    , and provide an email address that we have access to as the value for the **Endpoint**
    field.
  id: totrans-32
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**创建订阅**页面，将**协议**字段设置为**电子邮件**，并提供一个我们可以访问的电子邮件地址作为**端点**字段的值。
- en: Scroll down and click **Create subscription** . The status of our subscription
    will be **Pending** **confirmation** initially.
  id: totrans-33
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 向下滚动并点击**创建订阅**。我们的订阅状态将初始为**等待确认**。
- en: Log in to your email and click on the **Confirm subscription** hyperlink. We
    should get a **Subscription confirmed** message. If we go back to our subscription
    in the AWS console and refresh the page, our status should be **Confirmed** .
  id: totrans-34
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 登录您的电子邮件，点击**确认订阅**超链接。我们应该会收到**订阅确认**消息。如果我们返回AWS控制台中的订阅并刷新页面，我们的状态应该是**已确认**。
- en: We have created an SNS topic in this recipe. We will be using this topic in
    future recipes within this chapter.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经在本示例中创建了一个SNS主题。我们将在本章中的后续示例中使用该主题。
- en: How it works...
  id: totrans-36
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: In this recipe, we created an SNS topic with an email subscription. To avoid
    spam, AWS requires us to manually confirm the ownership of the email address by
    clicking on the confirmation link that was sent to the specified email address.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 在本示例中，我们创建了一个带电子邮件订阅的SNS主题。为了避免垃圾邮件，AWS要求我们通过点击发送到指定电子邮件地址的确认链接手动确认该电子邮件地址的所有权。
- en: There’s more...
  id: totrans-38
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 更多内容...
- en: 'In this recipe, we selected the **Email** protocol. The following protocols
    are currently supported: **Email** , **Amazon Kinesis Data Firehose** , **Amazon
    SQS** , **Amazon Lambda** , **Email-JSON** , **HTTP** , **HTTPS** , **Platform
    application endpoint** , and **SMS** . **Email-JSON** is different from the **Email**
    protocol. The **Email-JSON** protocol structures the output as JSON and is useful
    for services that read emails and process them automatically.'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 在本示例中，我们选择了**电子邮件**协议。当前支持的协议有：**电子邮件**、**Amazon Kinesis 数据 Firehose**、**Amazon
    SQS**、**Amazon Lambda**、**电子邮件-JSON**、**HTTP**、**HTTPS**、**平台应用端点**和**SMS**。**电子邮件-JSON**与**电子邮件**协议不同。**电子邮件-JSON**协议将输出结构化为JSON，适用于自动读取并处理电子邮件的服务。
- en: See also
  id: totrans-40
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 参见
- en: You can read more about SNS at [https://www.cloudericks.com/blog/getting-started-with-amazon-sns-service](https://www.cloudericks.com/blog/getting-started-with-amazon-sns-service)
    .
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您可以在[https://www.cloudericks.com/blog/getting-started-with-amazon-sns-service](https://www.cloudericks.com/blog/getting-started-with-amazon-sns-service)上阅读更多关于SNS的信息。
- en: We can also use **Simple Email Service** ( **SES** ) to send email notifications
    instead of using SNS. SES is a cloud-based email service for sending and receiving
    emails. It uses the **Simple Mail Transfer Protocol** ( **SMTP** ) interface,
    and all connections to the SMTP endpoint should be encrypted using **Transport
    Layer Security** ( **TLS** ). The default port for SES is **25** , but to avoid
    **Elastic Compute Cloud** ( **EC2** ) throttling email traffic, we can also use
    port **587** or **2587** . Read more about SES at [https://www.cloudericks.com/blog/getting-started-with-amazon-ses](https://www.cloudericks.com/blog/getting-started-with-amazon-ses)
    .
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们还可以使用**简单电子邮件服务**（**SES**）来发送电子邮件通知，而不是使用 SNS。SES 是一种基于云的电子邮件服务，用于发送和接收电子邮件。它使用**简单邮件传输协议**（**SMTP**）接口，所有到
    SMTP 端点的连接应使用**传输层安全性**（**TLS**）加密。SES 的默认端口是**25**，但为了避免**弹性计算云**（**EC2**）限制电子邮件流量，我们还可以使用端口**587**或**2587**。了解更多关于
    SES 的信息，请访问 [https://www.cloudericks.com/blog/getting-started-with-amazon-ses](https://www.cloudericks.com/blog/getting-started-with-amazon-ses)。
- en: Working with CloudWatch alarms and metrics
  id: totrans-43
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 CloudWatch 警报和度量标准
- en: In this recipe, we will create a **CloudWatch alarm** using one of the metrics
    already available. Being the first recipe about CloudWatch, we will also learn
    about some of the important features of CloudWatch.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个示例中，我们将使用已有的度量标准来创建一个**CloudWatch 警报**。作为关于 CloudWatch 的第一个示例，我们还将学习一些 CloudWatch
    的重要功能。
- en: Getting ready
  id: totrans-45
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备就绪
- en: 'We need the following to successfully complete this recipe:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 为了成功完成这个示例，我们需要以下内容：
- en: A working AWS account and a user as described in the *Technical* *requirements*
    section.
  id: totrans-47
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个有效的 AWS 账户和如*技术要求*部分所述的用户。
- en: An SNS topic with an email subscription following the *Creating an SNS topic
    to send emails* recipe from this chapter.
  id: totrans-48
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 根据本章中*创建 SNS 主题以发送电子邮件*示例中的步骤创建一个带有电子邮件订阅的 SNS 主题。
- en: How to do it...
  id: totrans-49
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'We can create a CloudWatch alarm using existing metrics as follows:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以使用现有的度量标准创建 CloudWatch 警报，步骤如下：
- en: Go to the **CloudWatch** service in the console.
  id: totrans-51
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 进入控制台中的**CloudWatch**服务。
- en: Expand **Alarms** from the left sidebar then click on **In alarm** .
  id: totrans-52
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从左侧边栏展开**警报**，然后点击**处于警报状态**。
- en: Click on **Create alarm** .
  id: totrans-53
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**创建警报**。
- en: Click on **Select metric** . This should show us all the metrics that are available
    to us based on the services we use.
  id: totrans-54
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**选择度量标准**。这将显示我们基于所使用服务的所有可用度量标准。
- en: '![Figure 7.1 – Selecting a metric](image/B21384_07_1.jpg)'
  id: totrans-55
  prefs: []
  type: TYPE_IMG
  zh: '![图 7.1 – 选择度量标准](image/B21384_07_1.jpg)'
- en: Figure 7.1 – Selecting a metric
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.1 – 选择度量标准
- en: Click on **Billing** .
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**计费**。
- en: Click on **By Service** .
  id: totrans-58
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**按服务**。
- en: Select **Amazon EC2** and click on **Select metric** . This will take us to
    the **Specify metric and** **conditions** screen.
  id: totrans-59
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择**Amazon EC2**并点击**选择度量标准**。这将带我们到**指定度量标准和条件**页面。
- en: 'In the **Metric** section of the **Specify metric and conditions** screen,
    use the defaults shown in the following screenshot:'
  id: totrans-60
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**指定度量标准和条件**页面的**度量标准**部分，使用以下屏幕截图所示的默认设置：
- en: '![Figure 7.2 – EstimatedCharges metric configuration](image/B21384_07_2.jpg)'
  id: totrans-61
  prefs: []
  type: TYPE_IMG
  zh: '![图 7.2 – 估计费用度量标准配置](image/B21384_07_2.jpg)'
- en: Figure 7.2 – EstimatedCharges metric configuration
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.2 – 估计费用度量标准配置
- en: In the **Conditions** section, define the threshold value as **1** and use the
    defaults for the other fields.
  id: totrans-63
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**条件**部分，定义阈值为**1**，并使用其他字段的默认值。
- en: '![Figure 7.3 – Conditions for the metric](image/B21384_07_3.jpg)'
  id: totrans-64
  prefs: []
  type: TYPE_IMG
  zh: '![图 7.3 – 度量标准的条件](image/B21384_07_3.jpg)'
- en: Figure 7.3 – Conditions for the metric
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.3 – 度量标准的条件
- en: Click **Next** .
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**下一步**。
- en: 'On the **Configure actions** page, select **In alarm** for **Alarm state trigger**
    . Under **Send a notification to the following SNS topic** , select the **Select
    an existing SNS topic** option and select the SNS topic we created for this recipe
    as mentioned in the *Getting ready* section. Leave the other options as-is, as
    shown in the following screenshot:'
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**配置操作**页面，选择**警报状态触发器**中的**处于警报状态**。在**向以下 SNS 主题发送通知**下，选择**选择现有 SNS 主题**选项，并选择我们在*准备就绪*部分中为这个示例创建的
    SNS 主题。保持其他选项不变，如下图所示：
- en: '![Figure 7.4 – Notification configuration for metric](image/B21384_07_4.jpg)'
  id: totrans-68
  prefs: []
  type: TYPE_IMG
  zh: '![图 7.4 – 度量标准的通知配置](image/B21384_07_4.jpg)'
- en: Figure 7.4 – Notification configuration for metric
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.4 – 度量标准的通知配置
- en: Scroll down and click **Next** .
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 向下滚动并点击**下一步**。
- en: Provide **Name** and **Alarm description - optional** values for our alarm.
    I have set the name to **MyEC2BillingAlarm** and the alarm description to **My
    EC2 Billing Alarm** . Click **Next** .
  id: totrans-71
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为我们的警报提供**名称**和**警报描述（可选）**值。我已将名称设置为**MyEC2BillingAlarm**，并将警报描述设置为**My EC2
    Billing Alarm**。点击**下一步**。
- en: Review the details, scroll down, and click on **Create alarm** . The alarm will
    appear now on the **Alarms** page. Initially, the **State** field of the alarm
    will have a value of **Insufficient data** . The state should change to **OK**
    in some time. Make sure we have a running EC2 instance. When the alarm state changes
    to the **In Alarm** state, we should get a notification in the email configured
    with SNS.
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 查看详细信息，向下滚动，并点击**创建警报**。警报现在会出现在**警报**页面上。最初，警报的**状态**字段将显示为**数据不足**。该状态应在一段时间后更改为**正常**。确保我们有一个正在运行的
    EC2 实例。当警报状态更改为**报警**状态时，我们应该会收到配置 SNS 的电子邮件通知。
- en: Important note
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: I have used a considerably lower value for the threshold and used the EC2 service
    enough to trigger an alarm. You may use a threshold value as per your requirements.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 我为阈值使用了一个相对较低的值，并使用了足够的 EC2 服务来触发警报。您可以根据需要使用适合您的要求的阈值值。
- en: How it works...
  id: totrans-75
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理...
- en: We specify the metric while creating a CloudWatch alarm. We can also specify
    the time period to evaluate the metric, the number of such periods to evaluate
    before raising an alarm, and the number of data points within the evaluation period,
    during which the threshold should be crossed, for an alarm to trigger. An alarm’s
    trigger can further trigger additional actions, such as sending a notification
    through an email, configuring Auto Scaling actions, as well as EC2 actions such
    as rebooting a failed instance.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建 CloudWatch 警报时，我们指定了度量标准。我们还可以指定评估度量标准的时间段、在触发警报之前评估的此类时间段的数量，以及在评估期间内，超过阈值所需的数个数据点，才能触发警报。警报触发器还可以进一步触发其他操作，例如通过电子邮件发送通知、配置自动扩展操作以及执行
    EC2 操作，例如重启失败的实例。
- en: A CloudWatch alarm has three states, namely **INSUFFICIENT DATA** , **OK** ,
    and **ALARM** . Until it gets enough data to do the analysis, the state will be
    **INSUFFICIENT DATA** . After it has enough data points to evaluate and if the
    result does not cross the threshold over the specified time periods, the state
    will be **OK** . If the result crosses the threshold in the specified time periods,
    the alarm is triggered and the CloudWatch alarm goes to the **ALARM** state.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: CloudWatch 警报有三种状态，分别是**数据不足**、**正常**和**报警**。在获取足够的数据进行分析之前，状态将为**数据不足**。当它有足够的数据点进行评估，并且结果在指定的时间段内没有超过阈值时，状态将为**正常**。如果结果在指定的时间段内超过了阈值，则触发警报，CloudWatch
    警报将进入**报警**状态。
- en: There’s more...
  id: totrans-78
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多内容...
- en: 'Let’s go through some important concepts related to CloudWatch:'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们通过一些与 CloudWatch 相关的重要概念：
- en: CloudWatch metrics support alarms, metrics, and dashboards.
  id: totrans-80
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: CloudWatch 度量标准支持警报、度量标准和仪表盘。
- en: CloudWatch Logs provides log streams and log groups so that we can log data
    from our applications.
  id: totrans-81
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: CloudWatch Logs 提供日志流和日志组，以便我们可以记录来自应用程序的数据。
- en: CloudWatch events support notifications and auto-remediation using AWS Lambda.
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: CloudWatch 事件支持使用 AWS Lambda 进行通知和自动修复。
- en: AWS gives us some metrics out of the box and allows us to create custom metrics
    for our applications.
  id: totrans-83
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: AWS 提供了一些开箱即用的度量标准，并允许我们为应用程序创建自定义度量标准。
- en: Amazon CloudWatch can integrate with AWS X-Ray to provide traces and metrics
    related to your application’s performance.
  id: totrans-84
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 亚马逊 CloudWatch 可以与 AWS X-Ray 集成，以提供与应用程序性能相关的跟踪和度量。
- en: CloudWatch integrates with services such as SNS, SQS, AWS Lambda, AWS Auto Scaling,
    and more for notifications and auto-remediation.
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: CloudWatch 与 SNS、SQS、AWS Lambda、AWS Auto Scaling 等服务集成，用于通知和自动修复。
- en: Under **Alarms** in the left sidebar, we have a dedicated **Billing** option.
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在左侧边栏的**警报**下，我们有一个专门的**计费**选项。
- en: The default EC2 metrics support important operations, including CPU utilization,
    disk read and write operations, network input and output operations, and status
    check failures.
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 默认的 EC2 度量标准支持重要的操作，包括 CPU 利用率、磁盘读写操作、网络输入和输出操作，以及状态检查失败。
- en: See also
  id: totrans-88
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: 'Read about CloudWatch custom metrics here: [https://www.cloudericks.com/blog/getting-started-with-amazon-cloudwatch-custom-metrics](https://www.cloudericks.com/blog/getting-started-with-amazon-cloudwatch-custom-metrics)
    .'
  id: totrans-89
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 了解 CloudWatch 自定义度量标准，请阅读：[https://www.cloudericks.com/blog/getting-started-with-amazon-cloudwatch-custom-metrics](https://www.cloudericks.com/blog/getting-started-with-amazon-cloudwatch-custom-metrics)。
- en: CloudWatch dashboards provide us with a single place to look into related metrics.
    Read about creating a dashboard in CloudWatch at [https://www.cloudericks.com/blog/creating-an-amazon-cloudwatch-dashboard](https://www.cloudericks.com/blog/creating-an-amazon-cloudwatch-dashboard)
    .
  id: totrans-90
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: CloudWatch 仪表板为我们提供了一个单一的地方来查看相关的指标。阅读关于在 CloudWatch 中创建仪表板的内容，请访问 [https://www.cloudericks.com/blog/creating-an-amazon-cloudwatch-dashboard](https://www.cloudericks.com/blog/creating-an-amazon-cloudwatch-dashboard)。
- en: Creating a CloudWatch log group
  id: totrans-91
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建一个 CloudWatch 日志组
- en: In this recipe, we will create a **CloudWatch log group** that will be used
    in other recipes in this book.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个配方中，我们将创建一个 **CloudWatch 日志组**，该日志组将在本书中的其他配方中使用。
- en: Getting ready
  id: totrans-93
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: To successfully complete this recipe, we need a working AWS account, and a user
    as described in the *Technical* *requirements* section.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 为了成功完成这个配方，我们需要一个有效的 AWS 账户和一个如 *技术* *要求* 部分所描述的用户。
- en: How to do it...
  id: totrans-95
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何做...
- en: 'We can create a CloudWatch log group as follows:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以按如下方式创建 CloudWatch 日志组：
- en: Go to the **CloudWatch** service in the console.
  id: totrans-97
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在控制台中进入 **CloudWatch** 服务。
- en: Expand **Logs** from the left sidebar.
  id: totrans-98
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从左侧边栏展开 **日志**。
- en: Click on **Log groups** and click on **Create** **log group** .
  id: totrans-99
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击 **日志组** 并点击 **创建** **日志组**。
- en: Give the log group a name that describes its purpose and leave other settings
    as default, then click on **Create** .
  id: totrans-100
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 给日志组起一个能描述其用途的名称，其他设置保持默认，然后点击 **创建**。
- en: This will create a new log group for us.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 这将为我们创建一个新的日志组。
- en: How it works...
  id: totrans-102
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: There are not many settings that need to be provided while creating a log group.
    We can use this log group within other recipes where we log in to CloudWatch.
    A log group is a group of log streams. A log stream is a sequence of log events
    from the same source. Log streams within a log group share the same retention,
    monitoring, and access control settings. We can specify which streams to put into
    each log group. There is no limit on the number of log streams in a log group.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 创建日志组时需要提供的设置不多。我们可以在其他配方中使用这个日志组，在那里我们将日志记录到 CloudWatch。一个日志组是多个日志流的集合。一个日志流是来自同一来源的日志事件序列。日志组中的日志流共享相同的保留、监控和访问控制设置。我们可以指定每个日志组中包含哪些日志流。一个日志组中的日志流数量没有限制。
- en: There’s more...
  id: totrans-104
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 更多内容...
- en: Log groups may be used from other services and features, such as VPC Flow Logs,
    as we’ve seen in the book. Log groups can also be used for our custom-built applications
    and microservices.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 日志组可能会被其他服务和功能使用，例如我们在本书中看到的 VPC 流日志。日志组也可以用于我们自定义构建的应用程序和微服务。
- en: See also
  id: totrans-106
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: Read more about CloudWatch logs at [https://www.cloudericks.com/blog/getting-started-with-amazon-cloudwatch-logs](https://www.cloudericks.com/blog/getting-started-with-amazon-cloudwatch-logs)
    .
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 阅读更多关于 CloudWatch 日志的信息，请访问 [https://www.cloudericks.com/blog/getting-started-with-amazon-cloudwatch-logs](https://www.cloudericks.com/blog/getting-started-with-amazon-cloudwatch-logs)。
- en: Working with EventBridge (previously CloudWatch Events)
  id: totrans-108
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 EventBridge（以前是 CloudWatch 事件）
- en: In this recipe, we will learn how to create and use the **EventBridge** service
    (previously **CloudWatch Events** ). CloudWatch events provide us with a near-real-time
    stream of system events from various AWS resources, and we can create rules to
    take actions based on the event data.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个配方中，我们将学习如何创建并使用 **EventBridge** 服务（以前称为 **CloudWatch Events**）。CloudWatch
    事件为我们提供了来自各种 AWS 资源的近实时系统事件流，我们可以创建规则来根据事件数据采取行动。
- en: Getting ready
  id: totrans-110
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'We need the following to successfully complete this recipe:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 我们需要以下内容来成功完成这个配方：
- en: A working AWS account and a user as described in the *Technical* *requirements*
    section.
  id: totrans-112
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个有效的 AWS 账户和一个如 *技术* *要求* 部分所描述的用户。
- en: An SNS topic with an email subscription following the *Creating an SNS topic
    to send emails* recipe from this chapter.
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 创建一个 SNS 主题，并通过本章中的 *创建 SNS 主题以发送电子邮件* 配方订阅电子邮件。
- en: How to do it...
  id: totrans-114
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何做...
- en: 'We can work with EventBridge (or CloudWatch events) as follows:'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以按如下方式使用 EventBridge（或 CloudWatch 事件）：
- en: Go to the **Amazon EventBridge** service in the console.
  id: totrans-116
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在控制台中进入 **Amazon EventBridge** 服务。
- en: On the left sidebar, expand **Buses** and click on **Rules** . Click on **Create
    rule** .
  id: totrans-117
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在左侧边栏，展开 **总线** 并点击 **规则**。点击 **创建规则**。
- en: Tip
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 提示
- en: If you are creating events using the CloudWatch service, you have to go to the
    **Amazon CloudWatch** service from the console. On the left sidebar, select **Rules**
    under **Events** , and you will be redirected to the EventBridge console to create
    a rule with a **CloudWatch Events console is now deprecated** message and use
    the EventBridge console to create and manage event buses and rules. Click on **Create
    rule** . The remaining steps are the same for creating events.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
- en: Enter **my-sec-cb-rule-1** as the name and an optional description of **My Sec
    CB Rule 1** . Leave the **Event bus** selection as **default** . Lastly, choose
    **Rule with an event pattern** as the rule type. Click on **Next** .
  id: totrans-120
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.5 – Rule detail](image/B21384_07_5.jpg)'
  id: totrans-121
  prefs: []
  type: TYPE_IMG
- en: Figure 7.5 – Rule detail
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: Under **Event source** , select **AWS events or EventBridge** **partner events**
    .
  id: totrans-123
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Under **Sample event - optional** , leave the default selection for **Sample
    event type** of **AWS events** as-is, and do not select any sample events.
  id: totrans-124
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Important note
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
- en: Including sample events is optional but recommended, as they can assist us in
    writing and testing event patterns or filtering criteria. We can reference a sample
    event when creating an event pattern or use it to test if the event pattern matches.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
- en: Under **Creation method** , select **Use** **pattern form** .
  id: totrans-127
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Under **Event pattern** , do the following, as shown in *Figure 7* *.6* :'
  id: totrans-128
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Set **Event source** to **AWS services** .
  id: totrans-129
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Set **AWS service** to **EC2** .
  id: totrans-130
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Set **Event type** to **EC2 Instance** **State-change Notification** .
  id: totrans-131
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Set **Event Type Specification 1** to **Any state** .
  id: totrans-132
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Set **Event Type Specification 2** to **Any instance** .
  id: totrans-133
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.6 – Event pattern section](image/B21384_07_6.jpg)'
  id: totrans-134
  prefs: []
  type: TYPE_IMG
- en: Figure 7.6 – Event pattern section
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
- en: Click on **Next** .
  id: totrans-136
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Under **Target 1** , do as shown in *Figure 7* *.7* . For **Target types** ,
    select **AWS service** . Under **Select a target** , select **SNS topic** . For
    **Topic** , select the topic we created for this recipe, as mentioned in the *Getting*
    *ready* section.
  id: totrans-137
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.7 – Target 1 section](image/B21384_07_7.jpg)'
  id: totrans-138
  prefs: []
  type: TYPE_IMG
- en: Figure 7.7 – Target 1 section
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
- en: Click on **Next** .
  id: totrans-140
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the **Tags** page, optionally add tags and click **Next** . A tag is a label
    assigned to an AWS resource, consisting of a key and an optional value. Tags can
    be used to search and filter resources or track AWS costs.
  id: totrans-141
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the **Review and create** page, review all details, and click **Create rule**
    at the bottom-right corner.
  id: totrans-142
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We should now receive a notification email with state change details whenever
    an EC2 instance changes state. To test this, go to the EC2 dashboard and either
    create a new instance or change the state of an existing instance.
  id: totrans-143
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-144
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this recipe, we selected an event pattern and set the service name to **EC2**
    and event type to **EC2 Instance State-change Notification** to match EC2 events
    whose state gets changed. Instead of an event pattern, we can select **Schedule**
    to invoke our targets on a schedule, just as we can with cron jobs.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 在本教程中，我们选择了一个事件模式，并将服务名称设置为**EC2**，事件类型设置为**EC2实例状态变化通知**，以匹配状态发生变化的EC2事件。除了事件模式，我们还可以选择**计划**，按计划调用我们的目标，就像使用cron作业一样。
- en: We configured to notify any state change. We can also select a specific state,
    such as **pending** , **running** , **shutting down** , **stopped** , **stopping**
    , or **terminated** . We also configured to apply this rule to all instances within
    our account. Instead of doing this, we can select a specific EC2 instance. We
    selected our SNS topic as the target. When we configure a target, CloudWatch events
    will provide necessary permissions for targets so that they can be invoked when
    rules are triggered.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 我们配置为通知任何状态变化。我们也可以选择一个特定状态，比如**待处理**、**运行中**、**关机中**、**已停止**、**停止中**或**已终止**。我们还配置为将此规则应用于账户内的所有实例。我们也可以选择一个特定的EC2实例。我们选择了我们的SNS主题作为目标。当我们配置目标时，CloudWatch事件将提供必要的权限，以便在规则触发时调用目标。
- en: There’s more...
  id: totrans-147
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: 'While configuring the event, we selected **SNS topic** as our target. The following
    is a current list of target types available for us to select: **Amazon Redshift**
    , **API Gateway** , **AppSync** , **Batch job queue** , **CloudWatch log group**
    , **CodeBuild project** , **CodePipeline** , **EBS Create Snapshot** , **EC2 ImageBuilder**
    , **EC2 RebootInstances API call** , **ECS task** , **Firehose stream** , **Glue
    workflow** , **Incident Manager response plan** , **Inspector assessment template**
    , **Kinesis stream** , **Lambda function** , **SageMaker pipeline** , **SNS topic**
    , **SQS queue** , **Step Functions state machine** , **System Manager Automation**
    , **System Manager OpsItem** , **System Manager** **Run Command** .'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 在配置事件时，我们选择了**SNS主题**作为目标。以下是目前可供我们选择的目标类型的完整列表：**Amazon Redshift**、**API Gateway**、**AppSync**、**Batch作业队列**、**CloudWatch日志组**、**CodeBuild项目**、**CodePipeline**、**EBS创建快照**、**EC2
    ImageBuilder**、**EC2重启实例API调用**、**ECS任务**、**Firehose流**、**Glue工作流**、**Incident
    Manager响应计划**、**Inspector评估模板**、**Kinesis流**、**Lambda函数**、**SageMaker管道**、**SNS主题**、**SQS队列**、**Step
    Functions状态机**、**System Manager自动化**、**System Manager OpsItem**、**System Manager运行命令**。
- en: See also
  id: totrans-149
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另请参见
- en: You can read more about CloudWatch events at [https://www.cloudericks.com/blog/getting-started-with-amazon-cloudwatch-events](https://www.cloudericks.com/blog/getting-started-with-amazon-cloudwatch-events)
    .
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在[https://www.cloudericks.com/blog/getting-started-with-amazon-cloudwatch-events](https://www.cloudericks.com/blog/getting-started-with-amazon-cloudwatch-events)了解更多关于CloudWatch事件的信息。
- en: Reading and filtering logs in CloudTrail
  id: totrans-151
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在CloudTrail中读取和过滤日志
- en: In this recipe, we will learn how to read and filter **CloudTrail log events**
    that are automatically generated and made available through the CloudTrail dashboard.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个教程中，我们将学习如何读取和过滤**CloudTrail日志事件**，这些事件是自动生成的，并通过CloudTrail仪表盘提供。
- en: Getting ready
  id: totrans-153
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: We need a working AWS account. I will be using the **awsseccb-sandbox-1** account
    that we created in [*Chapter 1*](B21384_01.xhtml#_idTextAnchor020) .
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 我们需要一个有效的AWS账户。我将使用我们在[*第1章*](B21384_01.xhtml#_idTextAnchor020)中创建的**awsseccb-sandbox-1**账户。
- en: How to do it...
  id: totrans-155
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'We can check automatically populated event logs in CloudTrail as follows:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以按以下方式检查自动填充的事件日志：
- en: Log in to the management console and go to the **CloudTrail** service.
  id: totrans-157
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 登录到管理控制台，进入**CloudTrail**服务。
- en: Click on **Event history** from the left sidebar. This will take us to the **Event**
    **history** page.
  id: totrans-158
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击左侧边栏的**事件历史**。这将带我们进入**事件历史**页面。
- en: '![Figure 7.8 – Event history](image/B21384_07_8.jpg)'
  id: totrans-159
  prefs: []
  type: TYPE_IMG
  zh: '![图 7.8 – 事件历史](image/B21384_07_8.jpg)'
- en: Figure 7.8 – Event history
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.8 – 事件历史
- en: Under **Lookup attributes** , select **User name** from the dropdown. Type our
    user’s name on the next field (or any name from the list, as seen in *Figure 7*
    *.8* ) and search for all activity from that user for 10 days using the **Filter
    by date and time** field. We should now see the filtered list.
  id: totrans-161
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**查找属性**下，从下拉菜单中选择**用户名**。在下一个字段中输入我们的用户名（或列表中的任何名称，如*图7.8*所示），并使用**按日期和时间筛选**字段搜索该用户在10天内的所有活动。现在我们应该能看到筛选后的列表。
- en: Click on the **Download events** icon at the top-right corner and then click
    on **Download as CSV** to download the result as a CSV file.
  id: totrans-162
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击右上角的**下载事件**图标，然后点击**下载为CSV**，将结果下载为CSV文件。
- en: '![Figure 7.9 – Download events](image/B21384_07_9.jpg)'
  id: totrans-163
  prefs: []
  type: TYPE_IMG
  zh: '![图 7.9 – 下载事件](image/B21384_07_9.jpg)'
- en: Figure 7.9 – Download events
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.9 – 下载事件
- en: We can also download the result as a JSON file.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 我们也可以将结果下载为 JSON 文件。
- en: How it works...
  id: totrans-166
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: 'AWS CloudTrail is a service from Amazon that can continuously monitor and log
    API activities within an AWS account. Without any additional configuration, CloudTrail
    will log API activity events into our account and event logs are made available
    for 90 days through the CloudTrail console. After going to the **Events history**
    page, we can filter based on various criteria and time ranges. We filtered based
    on the **User name** parameter in this recipe. Apart from **User name** , we can
    also filter based on the following parameters: **Event name** , **Resource type**
    , **Resource name** , **Event source** , **Event ID** , **AWS access key** , and
    **Read only** .'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: AWS CloudTrail 是 Amazon 提供的一项服务，可以持续监控并记录 AWS 账户中的 API 活动。无需额外配置，CloudTrail
    会将 API 活动事件记录到我们的账户中，并且事件日志可以通过 CloudTrail 控制台访问 90 天。在进入 **事件历史** 页面后，我们可以基于各种标准和时间范围进行过滤。在本教程中，我们是根据
    **用户名** 参数进行过滤的。除了 **用户名** 外，我们还可以根据以下参数进行过滤：**事件名称**、**资源类型**、**资源名称**、**事件来源**、**事件
    ID**、**AWS 访问密钥** 和 **只读**。
- en: There’s more...
  id: totrans-168
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: 'In this recipe, we queried our logs from the console. We can also query logs
    from the CLI. The following are some important CLI commands for querying CloudTrail
    logs:'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个教程中，我们查询了来自控制台的日志。我们也可以通过命令行界面（CLI）查询日志。以下是一些用于查询 CloudTrail 日志的重要 CLI 命令：
- en: The **aws cloudtrail lookup-events** command can be used to query the last 90
    days of automatically generated event logs. A pagination token is returned if
    there are more results.
  id: totrans-170
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**aws cloudtrail lookup-events** 命令可用于查询过去 90 天内自动生成的事件日志。如果有更多结果，将返回分页令牌。'
- en: We can limit the number of items that are returned by the **aws cloudtrail lookup-events**
    command by specifying the **max-items** option; for example, **aws cloudtrail
    lookup-events --** **max-items 10** .
  id: totrans-171
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们可以通过指定 **max-items** 选项来限制 **aws cloudtrail lookup-events** 命令返回的项数；例如，**aws
    cloudtrail lookup-events --** **max-items 10**。
- en: We can specify a date range using the **start-time** and **end-time** parameters;
    for example, **aws cloudtrail lookup-events --start-time 2019-01-12 --end-time
    2019-10-12** . We can also specify hours, minutes, and seconds with one of these
    parameters; for example, **--** **start-time 2019-01-12T00:30:45** .
  id: totrans-172
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们可以使用 **start-time** 和 **end-time** 参数指定日期范围；例如，**aws cloudtrail lookup-events
    --start-time 2019-01-12 --end-time 2019-10-12**。我们也可以通过这些参数指定小时、分钟和秒；例如，**--**
    **start-time 2019-01-12T00:30:45**。
- en: We can use the **lookup-attributes** parameter to specify the values of any
    parameter; for example, **aws cloudtrail lookup-events --** **lookupattributes
    "AttributeKey=Username,AttributeValue=i-07d6614e1dec5e537"** .
  id: totrans-173
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们可以使用 **lookup-attributes** 参数指定任何参数的值；例如，**aws cloudtrail lookup-events --**
    **lookupattributes "AttributeKey=Username,AttributeValue=i-07d6614e1dec5e537"**。
- en: 'Let’s go through some more important concepts related to CloudTrail logs:'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们再看一些与 CloudTrail 日志相关的重要概念：
- en: The CloudTrail service helps us achieve event-driven security by analyzing events
    and responding to them.
  id: totrans-175
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: CloudTrail 服务通过分析事件并响应这些事件，帮助我们实现事件驱动的安全性。
- en: CloudTrail only records events that involve AWS API calls. Therefore, if an
    application running on an EC2 instance throws an error, it won’t be captured.
    CloudWatch can be used for logging from applications on EC2 or from Lambda functions.
  id: totrans-176
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: CloudTrail 仅记录涉及 AWS API 调用的事件。因此，如果在 EC2 实例上运行的应用程序抛出错误，它将不会被捕获。CloudWatch
    可以用于记录来自 EC2 上的应用程序或 Lambda 函数的日志。
- en: By default, a trail will record events in one region. However, we can configure
    a trail as a multi-region trail. CloudTrail can integrate with other AWS services
    to provide additional security and compliance. These integrations include CloudWatch
    for raising alarms, GuardDuty for analyzing patterns, Macie to discover, classify,
    and protect sensitive data, and so on.
  id: totrans-177
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 默认情况下，CloudTrail 将在一个区域记录事件。然而，我们可以将 CloudTrail 配置为多区域的跟踪。CloudTrail 可以与其他 AWS
    服务集成，以提供额外的安全性和合规性。这些集成包括：CloudWatch 用于触发警报、GuardDuty 用于分析模式、Macie 用于发现、分类和保护敏感数据等。
- en: 'The current CloudTrail pricing model is as follows: the first tier in each
    region is free (except **Simple Storage Service** ( **S3** ) and Lambda data events).
    After the free tier, CloudTrail charges us for management events and data events.'
  id: totrans-178
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当前的 CloudTrail 定价模型如下：每个区域的第一层是免费的（**简单存储服务**（**S3**）和 Lambda 数据事件除外）。免费层之后，CloudTrail
    会对管理事件和数据事件进行收费。
- en: See also
  id: totrans-179
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: You can read more about CloudTrail at [https://www.cloudericks.com/blog/getting-started-with-aws-cloudtrail](https://www.cloudericks.com/blog/getting-started-with-aws-cloudtrail)
    .
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
- en: Creating a trail in CloudTrail
  id: totrans-181
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this recipe, we will learn how to create a trail in **CloudTrail** and how
    to read logs from the associated **S3 bucket** . By default, **CloudTrail API
    event logs** are made available for 90 days. Data events, such as S3 bucket operations
    and Lambda invocations, are also not logged by default. To store our logs for
    more than 90 days, to enable logging data events from S3 or Lambda, and for additional
    flexibility in searching logs, we can create a trail to log data in an S3 bucket.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-183
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To successfully complete this recipe, we need a working AWS account, and a user
    as described in the *Technical* *requirements* section.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-185
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We can create a trail in CloudTrail as follows:'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
- en: Log in to the **CloudTrail** service in the console.
  id: totrans-187
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on **Trails** from the left sidebar.
  id: totrans-188
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on **Create trail** .
  id: totrans-189
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Provide a **Trail name** value of **aws-sec-cb-events** .
  id: totrans-190
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Leave **Enable for all accounts in my organization** unchecked. To enable this,
    we need to log in to the management account of our organization.
  id: totrans-191
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Under **Storage location** , select **Create a new** **S3 bucket** .
  id: totrans-192
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: For **Trail log bucket and folder** , enter a unique name for a new S3 bucket
    and specify a folder (prefix) to store your logs. We may also use the auto-populated
    value. Remember – bucket names must be globally unique.
  id: totrans-193
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: For **Log file SSE-KMS encryption** , unselect the **Enabled** checkbox.
  id: totrans-194
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: For **Log file Validation** , select **Enabled** .
  id: totrans-195
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Do not select **Enabled** for **SNS** **notification delivery** .
  id: totrans-196
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Do not select **Enabled** for **CloudWatch Logs** .
  id: totrans-197
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Optionally, add **Tags** and click on **Next** .
  id: totrans-198
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: For **Event type** , select **Management events** .
  id: totrans-199
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.10 – Choosing event type](image/B21384_07_10.jpg)'
  id: totrans-200
  prefs: []
  type: TYPE_IMG
- en: Figure 7.10 – Choosing event type
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
- en: Under **Management events** , select **Read** and **Write** for **API activity**
    and click on **Next** .
  id: totrans-202
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.11 – Configuring management events](image/B21384_07_11.jpg)'
  id: totrans-203
  prefs: []
  type: TYPE_IMG
- en: Figure 7.11 – Configuring management events
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
- en: Click **Next** at the bottom right of the screen.
  id: totrans-205
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the **Review and create** page, review all details, and click on **Create
    trail** . We should see a **Trail successfully** **created** message.
  id: totrans-206
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Go to the **Trails** page and click on our trail’s S3 bucket name to go to our
    trail’s S3 bucket. We can also manually go to the S3 dashboard and access this
    bucket. We should see **CloudTrail** and **CloudTrail-Digest** folders. Within
    the folders, we should see sub-folders per region.
  id: totrans-207
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Go inside the folders until we see the actual log files.
  id: totrans-208
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.12 – CloudTrail log files](image/B21384_07_12.jpg)'
  id: totrans-209
  prefs: []
  type: TYPE_IMG
- en: Figure 7.12 – CloudTrail log files
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
- en: Select a file in S3, and from the **Actions** dropdown, click on **Query with**
    **S3 Select** .
  id: totrans-211
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.13 – Query with S3 Select](image/B21384_07_13.jpg)'
  id: totrans-212
  prefs: []
  type: TYPE_IMG
- en: Figure 7.13 – Query with S3 Select
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.13 – 使用 S3 Select 的查询
- en: Select **JSON** as the format, **Lines** as the JSON content type, and **GZIP**
    for compression.
  id: totrans-214
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择 **JSON** 作为格式，**行** 作为 JSON 内容类型，**GZIP** 作为压缩选项。
- en: '![Figure 7.14 – Input settings](image/B21384_07_14.jpg)'
  id: totrans-215
  prefs: []
  type: TYPE_IMG
  zh: '![图 7.14 – 输入设置](image/B21384_07_14.jpg)'
- en: Figure 7.14 – Input settings
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.14 – 输入设置
- en: For **Output settings** , select **JSON** .
  id: totrans-217
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对于 **输出设置**，选择 **JSON** 格式。
- en: Scroll down, and we should now see the **Structured Query Language** ( **SQL**
    ) query to run. Modify the SQL as required and click on **Run** **SQL query**
    .
  id: totrans-218
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 向下滚动，我们现在应该看到 **结构化查询语言**（**SQL**）查询语句。根据需要修改 SQL，并点击 **运行 SQL 查询**。
- en: '![Figure 7.15 – Run SQL query](image/B21384_07_15.jpg)'
  id: totrans-219
  prefs: []
  type: TYPE_IMG
  zh: '![图 7.15 – 运行 SQL 查询](image/B21384_07_15.jpg)'
- en: Figure 7.15 – Run SQL query
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.15 – 运行 SQL 查询
- en: 'We should see the actual result in another textbox, as shown in the following
    screenshot:'
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 我们应该在另一个文本框中看到实际的结果，如下图所示：
- en: '![Figure 7.16 – Query result response partial](image/B21384_07_16.jpg)'
  id: totrans-222
  prefs: []
  type: TYPE_IMG
  zh: '![图 7.16 – 查询结果响应（部分）](image/B21384_07_16.jpg)'
- en: Figure 7.16 – Query result response partial
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.16 – 查询结果响应（部分）
- en: Click **Download results** to download the result. We can open the downloaded
    file using any compatible application, such as Microsoft Word.
  id: totrans-224
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击 **下载结果** 下载结果。我们可以使用任何兼容的应用程序打开下载的文件，例如 Microsoft Word。
- en: We created a trail and used it in this recipe. From the **Trails** page, we
    can go to the configuration page for our trail, and then we can select **Delete**
    or **Stop logging** if needed.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 我们创建了一个跟踪，并在本教程中使用了它。从 **跟踪** 页面，我们可以进入跟踪的配置页面，然后可以选择 **删除** 或 **停止日志记录**（如有需要）。
- en: How it works...
  id: totrans-226
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: For storing logs for more than 90 days, we need to create a trail, and trails
    will send logs into an S3 bucket. In this recipe, we created a multi-region trail.
    We configured options to log all events. We can also select activities to log.
    We also saw the option to stop logging for a trail on the trail’s configuration
    page. Stopping logging will stop any new events from being sent to the log, but
    existing logs will still be available.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 对于存储超过 90 天的日志，我们需要创建一个跟踪（trail），并将日志发送到 S3 桶中。在本教程中，我们创建了一个多区域的跟踪。我们配置了记录所有事件的选项，也可以选择记录特定活动。我们还在跟踪的配置页面看到可以停止日志记录的选项。停止日志记录将阻止任何新事件发送到日志，但现有日志仍然可以访问。
- en: We configured management events in AWS CloudTrail to monitor AWS service API
    activities and track read and write operations, as well as changes to resources
    and configurations across our AWS account. This setup captures actions such as
    creating, deleting, modifying, and describing AWS resources, ensuring comprehensive
    oversight for auditing and compliance.
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在 AWS CloudTrail 中配置了管理事件，以监控 AWS 服务 API 活动并跟踪读写操作，以及对资源和配置的更改，涵盖我们 AWS 账户中的所有活动。此设置捕获了如创建、删除、修改和描述
    AWS 资源等操作，确保对审计和合规性的全面监管。
- en: There’s more...
  id: totrans-229
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多内容...
- en: We did not enable data events and Insights events in this recipe. Data events
    log operations such as S3 object changes and Lambda function calls, offering detailed
    resource monitoring, but enabling them increases logging costs. CloudTrail allows
    logging of data events options, such as **S3** , **DynamoDB** , **Lambda** , **Amazon
    Q apps** , **Amazon Q Business application** , **Amazon Q Business data source**
    , **Amazon Q Business index** , **Amazon Verified Permissions** , **AWS AppConfig**
    , **AWS Cloud Map namespace** , **AWS Cloud Map service** , **B2B Data Interchange**
    , **Bedrock agent alias** , **Bedrock knowledge base** , **Cassandra table** ,
    **CloudFront KeyValueStore** , **CloudTrail channel** , **CloudWatch metric**
    , **CodeWhisperer** , **CodeWhisperer customization** , **Cognito Identity Pools**
    , **DynamoDB Streams** , **EBS direct APIs** , **EMR write-ahead log workspace**
    , **FinSpace** , **Guard Duty detector** , **IoT certificate** , **IoT Greengrass
    component version** , **IoT Greengrass deployment** , **IoT SiteWise asset** ,
    **IoT SiteWise time series** , **IoT thing** , **IoT TwinMaker entity** , **IoT
    TwinMaker workspace** , **Kendra Ranking** , **Kinesis stream** , **Kinesis stream
    consumer** , **Kinesis video stream** , **Lake Formation** , **Machine Learning
    MIModel** , **Managed Blockchain** , **Managed Blockchain network** , **Managed
    Blockchain Query** , **MedicalImaging data store** , **Neptune Graph** , **Private
    CA Connector for Active Directory** , **Private CA Connector for SCEP** , **RDS
    Data API - DB Cluster** , **S3 Access Point** , **S3 Object Lambda** , **S3 Outposts**
    , **SageMaker endpoint** , **SageMaker Feature Store** , **SageMaker metrics experiment
    trial component** , **SNS platform endpoint** , **SNS topic** , **SQS** , **Step
    Functions state machine** , **Supply Chain** , **SWF domain** , **Systems Manager**
    , **Systems Manager managed node** , **Thin Client Device** , **Thin Client Environment**
    , **Timestream database** , **Timestream table** , and **X-Ray trace** . These
    options provide additional insight into activities within our AWS resources.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
- en: Insight events logging focuses on detecting abnormal usage patterns or potential
    security threats related to API calls that modify or manage AWS resources. Insight
    events cannot be selected alone but should be paired with management events to
    ensure comprehensive logging coverage and contextual analysis of AWS API activity
    for security, compliance, and operational purposes.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
- en: In this recipe, we queried logs in S3 directly from the S3 console. For more
    flexibility when querying CloudTrail logs in S3, we can use Amazon Athena. We
    will learn how to use Amazon Athena to query CloudTrail logs in the *Using Athena
    to query CloudTrail logs in S3* recipe of this chapter.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
- en: See also
  id: totrans-233
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Explore more about CloudTrail at [https://www.cloudericks.com/blog/deep-dive-into-aws-cloudtrail](https://www.cloudericks.com/blog/deep-dive-into-aws-cloudtrail)
    .
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
- en: Using Athena to query CloudTrail logs in S3
  id: totrans-235
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this recipe, we will learn how to use **Amazon Athena** to query CloudTrail
    logs. Using Athena to query CloudTrail logs provides us with greater flexibility.
    For example, we cannot filter based on an account ID from the CloudTrail console
    when multiple accounts are sending logs to CloudTrail’s S3 bucket. However, we
    can use Athena to query for logs from CloudTrail’s S3 bucket based on the account
    ID.
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-237
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We need the following to successfully complete this recipe:'
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
- en: A working AWS account and a user as described in the *Technical* *requirements*
    section.
  id: totrans-239
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A trail in CloudTrail following the *Creating a trail in CloudTrail* recipe
    from this chapter.
  id: totrans-240
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'If we are new to Athena, before we can run our queries, we should set up a
    query result location in Amazon S3, as follows:'
  id: totrans-241
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Create a bucket for query results. I’ve named my bucket **aws-sec-cb2-query-results**
    . Choose a unique name for your bucket.
  id: totrans-242
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Go to the **Athena** service in the management console.
  id: totrans-243
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Go to **Query editor tabs** . If we are new to Athena, we should see a warning
    stating **Before you run your first query, you need to set up a query result location
    in Amazon S3** . Click on **Edit settings** .
  id: totrans-244
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Browse S3 and choose the bucket we created for query results.
  id: totrans-245
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Leave other options as-is and click on **Save** .
  id: totrans-246
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.17 – Setting query results location](image/B21384_07_17.jpg)'
  id: totrans-247
  prefs: []
  type: TYPE_IMG
- en: Figure 7.17 – Setting query results location
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-249
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We can set up Athena and query CloudTrail logs as follows:'
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
- en: Log in to the **CloudTrail** service in the management console.
  id: totrans-251
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on **Event history** from the left sidebar. This will take us to the **Event**
    **history** page.
  id: totrans-252
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on **Create Athena table** , as we saw in *Figure 7* *.9* .
  id: totrans-253
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: For **Storage location** , select the S3 bucket of our trail.
  id: totrans-254
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.18 – Creating Athena table](image/B21384_07_18.jpg)'
  id: totrans-255
  prefs: []
  type: TYPE_IMG
- en: Figure 7.18 – Creating Athena table
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
- en: Scroll down and click on **Create table** . We should see a success message
    that the table has been created.
  id: totrans-257
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Now, go to **Athena** service in the management console.
  id: totrans-258
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Go to the **Query editor** tab. We should see our table under **Tables** , on
    the left, and a query editor window on the right. It might take some time for
    the table to be created and appear on the Athena dashboard after we’ve initiated
    its creation from the CloudTrail dashboard. We can manually refresh the table
    list using the refresh icon in the left sidebar.
  id: totrans-259
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on the button with three dots next to our table and click on **Preview
    Table** . A sample query will be created that we can modify so that it meets our
    needs.
  id: totrans-260
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'I have set the limit to **2** in the query as follows: **SELECT * FROM "default"."cloudtrail_logs_aws_cloudtrail_logs_370598287390_66c52071"**
    **limit 2;** .'
  id: totrans-261
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click **Run** .
  id: totrans-262
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on the **Download results** icon on the top right of the page to download
    the results in CSV format.
  id: totrans-263
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If we go to the S3 bucket that we created for storing results, which is **aws-sec-cb2-query-results**
    in my case, we should see the query results saved there too.
  id: totrans-264
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-265
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this recipe, we used Amazon Athena to query CloudTrail logs in S3. Athena
    uses queries based on SQL and creates virtual tables. If we are new to Athena,
    before we can run our queries, we should set up a query result location in Amazon
    S3. We created an Athena table from the CloudTrail dashboard. Then, we went to
    Athena and ran a preview query. We modified the query and executed it. Finally,
    we exported the results into a CSV file from the results screen.
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
- en: There’s more...
  id: totrans-267
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Let’s quickly go through some important concepts related to Amazon Athena:'
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
- en: Athena is a query service provided by AWS to analyze data in Amazon S3 using
    SQL.
  id: totrans-269
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Athena can only query S3 data and not CloudTrail directly.
  id: totrans-270
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Amazon Athena now supports federated queries. We can run SQL queries across
    data stored in relational, non-relational, object, and custom data sources and
    then store the result in Amazon S3. At the time of writing, this feature is in
    preview. Athena is serverless. We do not have to set up any infrastructure and
    we only pay for the queries we run.
  id: totrans-271
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Athena, integrated with AWS Glue, allows us to crawl data sources, populate
    table and partition definitions, and even maintain schema versioning.
  id: totrans-272
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Cross-account CloudTrail logging
  id: totrans-273
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: With cross-account CloudTrail logging, we can store logs in a separate account
    from the account in which logs are generated. By storing logs in a separate account,
    we isolate the logs from the source account, which will prevent anyone with access
    to the source account from tampering with the logs. We can provide account-level
    access to the log account to a limited set of people. Sending logs from multiple
    accounts to a single account also provides a central place for us to query logs.
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
- en: 'To set up cross-account CloudTrail logging, we need two AWS accounts: a log
    account (where logs are stored) and a logger account (which sends the logs). If
    we are using AWS Organizations, we can enable CloudTrail across accounts from
    the management account by selecting **Enable for all accounts in my organization**
    while creating a trail. An organization’s trail is then created in all member
    accounts, which means we don’t have to modify the bucket policy. However, enabling
    this option may lead to additional charges if the member accounts already have
    trails since only the first trail within a region is free.'
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
- en: In this recipe, we did not select the option to enable CloudTrail across accounts
    using AWS Organizations. To set up cross-account CloudTrail logging without using
    AWS Organizations, first configure a CloudTrail trail in the log account and set
    up an S3 bucket to store the logs. Modify the bucket policy to allow the CloudTrail
    service and specific IAM roles from both accounts to write logs to the bucket.
    Then, create a trail in the logger account, specifying the log account’s S3 bucket
    as the storage location. Verify that logs from the logger account are being correctly
    stored in the specified S3 bucket within the log account. This setup isolates
    the logs from the source account and centralizes log storage, enhancing security
    and manageability.
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
- en: See also
  id: totrans-277
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Read more about Amazon Athena at [https://www.cloudericks.com/blog/getting-started-with-amazon-athena](https://www.cloudericks.com/blog/getting-started-with-amazon-athena)
    .
  id: totrans-278
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Read more about cross-account CloudTrail logging at [https://www.cloudericks.com/blog/getting-started-with-cross-account-cloudtrail-logging](https://www.cloudericks.com/blog/getting-started-with-cross-account-cloudtrail-logging)
    .
  id: totrans-279
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Integrating CloudWatch with CloudTrail making use of a CloudFormation template
  id: totrans-280
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this recipe, we will learn how to integrate CloudWatch with CloudTrail. Once
    integrated, we can create **metric filters** and alarms within CloudWatch based
    on CloudTrail logs. We will also learn how to use the CloudFormation template
    provided by AWS to create a set of alarms within CloudWatch that uses CloudTrail
    logs.
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-282
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We need the following to successfully complete this recipe:'
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
- en: A working AWS account and a user as described in the *Technical* *requirements*
    section.
  id: totrans-284
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A trail, by following the *Creating a trail in CloudTrail* recipe of this chapter.
  id: totrans-285
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Important note
  id: totrans-286
  prefs: []
  type: TYPE_NORMAL
- en: You can also perform the steps in this recipe while creating a trail by making
    minor modifications to them.
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-288
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We can integrate CloudWatch with an existing trail as follows:'
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
- en: Go to the **CloudTrail** service in the management console.
  id: totrans-290
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on **Trails** from the left sidebar.
  id: totrans-291
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on the name of our trail to go to the trail’s configuration page.
  id: totrans-292
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Scroll down to the **CloudWatch Logs** section and click on **Edit** .
  id: totrans-293
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: For **CloudWatch Logs** , select the **Enabled** checkbox.
  id: totrans-294
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: For **Log group** , select **New** and leave the log group name as-is, which
    is **aws-cloudtrail-logs-370598287390-b9277b0a** in my case. We can also use an
    existing log group using the **Existing** option.
  id: totrans-295
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: For **IAM Role** , select **New** , provide a role name, and click on **Save
    changes** .
  id: totrans-296
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Download the CloudFormation template from [https://s3-us-west-2.amazonaws.com/awscloudtrail/cloudwatch-alarms-for-cloudtrail-api-activity/CloudWatch_Alarms_for_CloudTrail_API_Activity.json](https://www.cloudericks.com/blog/getting-started-with-amazon-sns-service)
    and save it locally.
  id: totrans-297
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Go to the **CloudFormation** service in the management console and click on
    **Create stack** .
  id: totrans-298
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: For **Prepare template** , select the **Choose an existing** **template** option.
  id: totrans-299
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.19 – Prepare template](image/B21384_07_19.jpg)'
  id: totrans-300
  prefs: []
  type: TYPE_IMG
- en: Figure 7.19 – Prepare template
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
- en: Under **Specify template** , choose the **Upload a template file** option, and
    using the **Choose file** option, upload the template we downloaded in *Step 8*
    of this section.
  id: totrans-302
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.20 – Specify template](image/B21384_07_20.jpg)'
  id: totrans-303
  prefs: []
  type: TYPE_IMG
- en: Figure 7.20 – Specify template
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
- en: Scroll down and click **Next** .
  id: totrans-305
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the **Specify stack details** page, provide a stack name and email address
    so that we’ll be notified when an API activity has triggered an alarm.
  id: totrans-306
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Leave the cloud trail log group name as-is and click on **Next** .
  id: totrans-307
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the **Configure stack options** page, leave the defaults as-is and click
    on **Next** .
  id: totrans-308
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the **Review and create** page, review everything and click on **Submit**
    . Wait for our CloudFormation stack to be created.
  id: totrans-309
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: After the CloudFormation stack has been successfully created, we will receive
    an email asking us to verify our email address. To start receiving email notifications
    when alarms are activated, click on the **Confirm subscription** link provided
    in the email.
  id: totrans-310
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If we go to the **Alarms** page in **CloudWatch** , we will be able to view
    the new alarms that were created. We can wait until the alarm state changes to
    **OK** or **ALARM** and play around with these alarms to learn more about them.
  id: totrans-311
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-312
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In this recipe, we integrated CloudWatch with CloudTrail through our trail’s
    settings. CloudTrail asked us for permission to deliver CloudTrail events associated
    with API activity in our account to our log group. We allowed this from the console.
    The following permissions were granted:'
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
- en: '**CreateLogStream** , to create a log stream in the log group we specified'
  id: totrans-314
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**PutLogEvents** , to deliver CloudTrail events to the log stream'
  id: totrans-315
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We used the CloudFormation template provided by AWS to set up some CloudWatch
    alarms for security and network-related API activity. If we delete the CloudFormation
    stack, all the alarms will also be deleted.
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
- en: AWS uses SNS to send notifications and created an SNS topic subscription for
    us. We had to confirm the email subscription by verifying our email address since
    SNS will not send notifications until we manually confirm the subscription.
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
- en: There’s more...
  id: totrans-318
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this recipe, we integrated CloudWatch with CloudTrail and used the CloudFormation
    template provided by Amazon to create some alarms that are related to security
    and network-related API activity. You can add these alarms to a dashboard following
    the reference in the *See also* section of the *Working with CloudWatch alarms
    and metrics* recipe from this chapter.
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
- en: See also
  id: totrans-320
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Read more about CloudFormation at [https://www.cloudericks.com/blog/aws-cloudformation-for-absolute-beginners](https://www.cloudericks.com/blog/aws-cloudformation-for-absolute-beginners)
    .
  id: totrans-321
  prefs: []
  type: TYPE_NORMAL
- en: Setting up and using AWS Config
  id: totrans-322
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this recipe, we will learn how to set up and use AWS Config. We can use Config
    to record and evaluate configurations of our AWS resources. We can create rules
    that define security standards and find out about resources that do not comply
    with security standards. Config also supports the auto-remediation of problems
    whenever they are detected.
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  id: totrans-324
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We need the following to successfully complete this recipe:'
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
- en: A working AWS account and a user as described in the *Technical* *requirements*
    section.
  id: totrans-326
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If you want to add an SNS topic for notifications, you can create an SNS topic
    with an email subscription by following the *Creating an SNS topic to send emails*
    recipe of this chapter.
  id: totrans-327
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: For testing, we need at least one IAM user without **multi-factor authentication**
    ( **MFA** ) enabled.
  id: totrans-328
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-329
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'First, we will set up AWS Config for the first time, and then we will see how
    to use AWS Config. Let us get started:'
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
- en: When we log in to the **AWS Config** service in the management console for the
    first time, we will see a **Getting started** page. Click on **Get started** ,
    and we will be taken to the **Settings** page.
  id: totrans-331
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Recording method** section, for **Recording strategy** , select **All
    resource types with** **customizable overrides** .
  id: totrans-332
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.21 – AWS Config recording method](image/B21384_07_21.jpg)'
  id: totrans-333
  prefs: []
  type: TYPE_IMG
- en: Figure 7.21 – AWS Config recording method
  id: totrans-334
  prefs: []
  type: TYPE_NORMAL
- en: For **Recording frequency** , select **Continuous recording** .
  id: totrans-335
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.22 – Recording frequency](image/B21384_07_22.jpg)'
  id: totrans-336
  prefs: []
  type: TYPE_IMG
- en: Figure 7.22 – Recording frequency
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
- en: Under the **Override settings** section, click on **Remove** .
  id: totrans-338
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.23 – Override settings](image/B21384_07_23.jpg)'
  id: totrans-339
  prefs: []
  type: TYPE_IMG
- en: Figure 7.23 – Override settings
  id: totrans-340
  prefs: []
  type: TYPE_NORMAL
- en: In the **Data governance** section, select **Create AWS Config service-linked
    role** . Alternatively, we may choose a role from our account.
  id: totrans-341
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Delivery method** section, select **Create a bucket** and give an S3
    bucket name.
  id: totrans-342
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.24 – Delivery method section](image/B21384_07_24.jpg)'
  id: totrans-343
  prefs: []
  type: TYPE_IMG
- en: Figure 7.24 – Delivery method section
  id: totrans-344
  prefs: []
  type: TYPE_NORMAL
- en: In the **Amazon SNS topic** section, select **Stream configuration changes and
    notifications to an Amazon SNS topic** , then select **Choose a topic from your
    account** , and finally select the topic we created as mentioned in the *Getting
    ready* section. Alternatively, we may create a topic or choose a topic from another
    account.
  id: totrans-345
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 7.25 – Choosing an Amazon SNS topic](image/B21384_07_25.jpg)'
  id: totrans-346
  prefs: []
  type: TYPE_IMG
- en: Figure 7.25 – Choosing an Amazon SNS topic
  id: totrans-347
  prefs: []
  type: TYPE_NORMAL
- en: At the bottom of the page, click **Next** .
  id: totrans-348
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the **AWS Managed Rules** page, search for and select the **iam-user-mfa-enabled**
    rule. Click **Next** . We can add more rules if we want. We can also add rules
    after completing the setup process.
  id: totrans-349
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the **Review** page, review the changes and click **Confirm** at the bottom-right
    corner. We will be redirected to the AWS Config dashboard. In the dashboard, we
    can see **Conformance Packs by Compliance Score** , **Compliance status** , **Noncompliant
    rules by noncompliant resource count** , **Resource inventory** , **AWS Config
    usage metrics** , and **AWS Config** **success metrics** .
  id: totrans-350
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If we have an IAM user without MFA enabled, as discussed in the *Getting ready*
    section, we should see that user as not compliant with our **iam-user-mfa-enabled**
    rule.
  id: totrans-351
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Please note that it will take some time for the non-compliant resources to
    be shown in the dashboard. We can also do the following actions for the rule:
    **Manage remediation** , **Re-evaluate** , **Delete results** , and **Delete rule**
    .'
  id: totrans-352
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: How it works...
  id: totrans-353
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this recipe, we set up AWS Config on our account. We selected **Record all
    resources supported in this region** and **Include global resources** (for example,
    AWS IAM resources) against **All resources** in order to record all resources
    across all regions. We can also configure recording for specific resources by
    unchecking **Record all resources supported in this region** and selecting the
    resources we want in the **Specific** **types** field.
  id: totrans-354
  prefs: []
  type: TYPE_NORMAL
- en: We enabled SNS notifications to receive email notifications by selecting an
    SNS topic with an email subscription from our account. We can also choose an SNS
    topic from another account by selecting the **Choose a topic from another account**
    option. In the **AWS Config role** section, we selected the **Create AWS Config
    service-linked** role. This role grants read-only access for Config to our AWS
    resources so that we can record configuration information. The role also grants
    permission to send information to S3 and SNS.
  id: totrans-355
  prefs: []
  type: TYPE_NORMAL
- en: Here, we selected the **iam-user-mfa-enabled** rule, which is a periodic rule.
    Periodic rules are run periodically, whereas non-periodic rules (configuration
    changes-based rules) are run immediately when a change is made to an associated
    configuration.
  id: totrans-356
  prefs: []
  type: TYPE_NORMAL
- en: There’s more...
  id: totrans-357
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Let’s go through some important concepts related to AWS Config:'
  id: totrans-358
  prefs: []
  type: TYPE_NORMAL
- en: 'Some of the checks that we can do with AWS Config include the following: check
    if MFA is enabled, check if S3 buckets are not public, databases are encrypted,
    VPC flow logs are enabled, and so on.'
  id: totrans-359
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We can write our own custom rules using AWS Lambda.
  id: totrans-360
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: AWS Config can perform auto-remediation actions for a rule. For example, we
    can change the configuration of an EC2 instance based on a rule. However, AWS
    may stop and restart the EC2 instance, so we need to consider possible downtime.
  id: totrans-361
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: To configure auto-remediation from the new console, we can go to our rule, click
    on the **Actions** dropdown, and select **Manage remediation** .
  id: totrans-362
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We can use the same set of Config rules across multiple accounts to ensure they
    all follow a common set of rules.
  id: totrans-363
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We can create an aggregator in AWS Config to view the AWS resource inventory
    or Config rule compliance status for multiple accounts across all regions. In
    the current console, we can create an aggregator by going to the **Aggregate**
    view from the left sidebar and then clicking on **Add aggregator** .
  id: totrans-364
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: AWS Config is charged based on the number of rules evaluations that are recorded.
  id: totrans-365
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The steps for creating a custom rule can be summarized as follows:'
  id: totrans-366
  prefs: []
  type: TYPE_NORMAL
- en: Create an IAM role that can be used by a Lambda with the required permissions.
    To report back to AWS Config, we need to provide **AWSConfigRulesExecutionRole**
    . To send logs to CloudWatch, we will need to add **AWSLambdaBasicExecutionRole**
    . Finally, we need to give access to the service it will monitor (for example,
    **AmazonS3ReadOnlyAccess** for accessing S3).
  id: totrans-367
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Create a Lambda by selecting the IAM role we created in the previous step using
    any of the supported programming languages.
  id: totrans-368
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Write some code within Lambda in order to evaluate the service parameters that
    we are monitoring (for example, S3 bucket properties), update a **ResultToken**
    object per evaluation, and return a list of **ResultToken** objects back to Config.
    The **ResultToken** objects should consist of the following information: **ComplianceResourceType**
    (for example, **AWS::S3::Bucket** ), **ComplianceResourceId** (for example, bucket
    name), **ComplianceType** ( **COMPLIANT** or **NON_COMPLIANT** ), and **OrderingTimestamp**
    .'
  id: totrans-369
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Within the Config dashboard, we can go to **Rules** , then to **Add rule** ,
    and select **Add Custom rule** . The exact screen names of these options may be
    different when you do this.
  id: totrans-370
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Set the **Trigger type** field to **Configuration changes** or **Periodic**
    .
  id: totrans-371
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Next, we can choose a remediation action or notification for our rule.
  id: totrans-372
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click **Save** . Our rule should be listed along with the other rules on the
    **Rules** page.
  id: totrans-373
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: See also
  id: totrans-374
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Read more about AWS Config at [https://www.cloudericks.com/blog/getting-started-with-aws-config.vp](https://www.cloudericks.com/blog/getting-started-with-aws-config.vp)
    .
  id: totrans-375
  prefs: []
  type: TYPE_NORMAL
