<html><head></head><body>
<div id="_idContainer063">
<h1 class="chapter-number" id="_idParaDest-38"><a id="_idTextAnchor037"/><span class="koboSpan" id="kobo.1.1">3</span></h1>
<h1 id="_idParaDest-39"><a id="_idTextAnchor038"/><span class="koboSpan" id="kobo.2.1">Succeeding with Infrastructure as Code Tools and Strategies</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In the previous chapter, we manually created our first vulnerable lab environment using the </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">AWS Management Console</span></strong><span class="koboSpan" id="kobo.5.1">. </span><span class="koboSpan" id="kobo.5.2">It </span><a id="_idIndexMarker189"/><span class="koboSpan" id="kobo.6.1">probably took us about an hour and a half to set everything up. </span><span class="koboSpan" id="kobo.6.2">After completing the lab setup, it may have taken us an additional 30 minutes to test whether everything was (mis)configured as expected. </span><span class="koboSpan" id="kobo.6.3">What if we wanted to set up 10 lab environments similar to what we prepared in </span><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.7.1">Chapter 2</span></a></em></span><span class="koboSpan" id="kobo.8.1"> for a security training course? </span><em class="italic"><span class="koboSpan" id="kobo.9.1">Do we really need around 20 hours to set all of these up?</span></em><span class="koboSpan" id="kobo.10.1"> In addition to this, remember that we only worked on a small component of an entire cloud penetration testing lab environment! </span><span class="koboSpan" id="kobo.10.2">Complete lab environments generally have about 5 to 10 times more resources compared to what we prepared in </span><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.11.1">Chapter 2</span></a></em></span><span class="koboSpan" id="kobo.12.1">. </span><span class="koboSpan" id="kobo.12.2">Assuming the complete environment is at least five times larger than what we initially prepared, and taking into account the need to create and delete the entire environment every time to manage costs, it is worth considering whether the manual setup process for these environments (which typically takes around 10 hours each) is truly necessary. </span><span class="koboSpan" id="kobo.12.3">That said, is there a better way to create and manage the cloud infrastructure resources for our penetration testing </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1">lab environments?</span></span></p>
<p><span class="koboSpan" id="kobo.14.1">In this chapter, we will answer these questions by taking a closer look at how </span><strong class="bold"><span class="koboSpan" id="kobo.15.1">Infrastructure as Code</span></strong><span class="koboSpan" id="kobo.16.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.17.1">IaC</span></strong><span class="koboSpan" id="kobo.18.1">) solves</span><a id="_idIndexMarker190"/><span class="koboSpan" id="kobo.19.1"> these challenges and requirements! </span><span class="koboSpan" id="kobo.19.2">That said, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.21.1">Diving deeper into IaC tools </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">and strategies</span></span></li>
<li><span class="koboSpan" id="kobo.23.1">Setting up Terraform in </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">AWS CloudShell</span></span></li>
<li><span class="koboSpan" id="kobo.25.1">Getting our feet wet </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">with Terraform</span></span></li>
<li><span class="koboSpan" id="kobo.27.1">Understanding the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">configuration language</span></span></li>
<li><span class="koboSpan" id="kobo.29.1">Building our vulnerable lab environment </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">with Terraform</span></span></li>
<li><span class="koboSpan" id="kobo.31.1">Configuring a Terraform backend with </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">state locking</span></span></li>
<li><span class="koboSpan" id="kobo.33.1">Verifying the </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">state-locking setup</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.35.1">The hands-on solutions in this chapter will equip you with the skills and confidence needed to convert existing cloud infrastructure resources into IaC configuration files. </span><span class="koboSpan" id="kobo.35.2">With these configuration files, we should be able to set up multiple penetration testing lab environments quickly within minutes using automated tools </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">and services!</span></span></p>
<h1 id="_idParaDest-40"><a id="_idTextAnchor039"/><span class="koboSpan" id="kobo.37.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.38.1">Before we start, we must have the </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">following ready:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.40.1">Required</span></strong><span class="koboSpan" id="kobo.41.1">: The “target” AWS account used in </span><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.42.1">Chapter 2</span></a></em></span><span class="koboSpan" id="kobo.43.1">, which will contain the vulnerable environment </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">and resources</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.45.1">Optional</span></strong><span class="koboSpan" id="kobo.46.1">: A second AWS account (also used in </span><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.47.1">Chapter 2</span></a></em></span><span class="koboSpan" id="kobo.48.1">), which will serve as the “</span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">attacker’s account”</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.50.1">In case you skipped </span><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.51.1">Chapter 2</span></a></em></span><span class="koboSpan" id="kobo.52.1">, </span><em class="italic"><span class="koboSpan" id="kobo.53.1">Preparing Our First Vulnerable Cloud Lab Environment</span></em><span class="koboSpan" id="kobo.54.1">, feel free to create the AWS accounts using the following link: </span><a href="https://aws.amazon.com/free/"><span class="koboSpan" id="kobo.55.1">https://aws.amazon.com/free/</span></a><span class="koboSpan" id="kobo.56.1">. </span><span class="koboSpan" id="kobo.56.2">You may proceed with the next steps once the accounts </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">are ready.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.58.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.59.1">This chapter primarily focuses on using Terraform to build a sample vulnerable lab environment on AWS. </span><span class="koboSpan" id="kobo.59.2">Of course, we need to have our </span><strong class="bold"><span class="koboSpan" id="kobo.60.1">Microsoft Azure</span></strong><span class="koboSpan" id="kobo.61.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.62.1">Google Cloud Platform</span></strong><span class="koboSpan" id="kobo.63.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.64.1">GCP</span></strong><span class="koboSpan" id="kobo.65.1">) accounts ready once we reach the hands-on portion of the succeeding chapters of this book (</span><span class="No-Break"><em class="italic"><a href="B19755_04.xhtml"><span class="koboSpan" id="kobo.66.1">Chapter 4</span></a></em></span><span class="koboSpan" id="kobo.67.1"> onward). </span><span class="koboSpan" id="kobo.67.2">In the meantime, setting up two AWS accounts should do the trick </span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">for now.</span></span></p>
<p><span class="koboSpan" id="kobo.69.1">The source code and other files used for each chapter are available in this book’s </span><span class="No-Break"><span class="koboSpan" id="kobo.70.1">GitHub repository:</span></span></p>
<p><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud"><span class="No-Break"><span class="koboSpan" id="kobo.71.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud</span></span></a></p>
<h1 id="_idParaDest-41"><a id="_idTextAnchor040"/><span class="koboSpan" id="kobo.72.1">Diving deeper into IaC tools and strategies</span></h1>
<p><span class="koboSpan" id="kobo.73.1">Before we dive into the practical exercises in this chapter, we will first establish a clear understanding of IaC in this section and discuss how it can be harnessed for building complex penetration </span><span class="No-Break"><span class="koboSpan" id="kobo.74.1">testing labs.</span></span></p>
<h2 id="_idParaDest-42"><a id="_idTextAnchor041"/><span class="koboSpan" id="kobo.75.1">Demystifying IaC</span></h2>
<p><span class="koboSpan" id="kobo.76.1">IaC is the </span><a id="_idIndexMarker191"/><span class="koboSpan" id="kobo.77.1">practice and process of using code to provision and manage infrastructure resources. </span><span class="koboSpan" id="kobo.77.2">This code works similarly to how a blueprint of a house is used as a reference when building the actual house. </span><span class="koboSpan" id="kobo.77.3">The cool thing when dealing with IaC code is that the actual infrastructure resources are created and configured automatically from the code that represents the desired final state of the infrastructure. </span><span class="koboSpan" id="kobo.77.4">Behind the scenes, the IaC automation tools simply make use of the same set of APIs we would use when trying to automate specific processes. </span><span class="koboSpan" id="kobo.77.5">The process is illustrated in the </span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">following diagram:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer049">
<span class="koboSpan" id="kobo.79.1"><img alt="" src="image/B19755_03_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.80.1">Figure 3.1 – Using IaC tools and services to create and manage cloud resources</span></p>
<p><span class="koboSpan" id="kobo.81.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.82.1">Figure 3</span></em></span><em class="italic"><span class="koboSpan" id="kobo.83.1">.1</span></em><span class="koboSpan" id="kobo.84.1">, we can see that the same set of configuration files (representing the desired state) can be used to generate and configure multiple environments with the same set of resources and properties. </span><span class="koboSpan" id="kobo.84.2">For example, we can use IaC configuration files when provisioning and ensuring the consistency of development, staging, and production environments used by developers </span><span class="No-Break"><span class="koboSpan" id="kobo.85.1">and engineers.</span></span></p>
<p><span class="koboSpan" id="kobo.86.1">At this point, you might be wondering how configuration files are used to generate actual cloud infrastructure resources. </span><span class="koboSpan" id="kobo.86.2">Let’s start with a configuration file where a single resource is defined. </span><span class="koboSpan" id="kobo.86.3">This configuration file is then passed as input to the IaC tool, which then runs the code </span><a id="_idIndexMarker192"/><span class="koboSpan" id="kobo.87.1">specified (an </span><strong class="bold"><span class="koboSpan" id="kobo.88.1">imperative approach</span></strong><span class="koboSpan" id="kobo.89.1">) or, alternatively, “magically” converts the configuration</span><a id="_idIndexMarker193"/><span class="koboSpan" id="kobo.90.1"> code into actual infrastructure resources (a </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.91.1">declarative approach</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.92.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.93.1">The following diagram depicts how</span><a id="_idIndexMarker194"/><span class="koboSpan" id="kobo.94.1"> IaC tools and services </span><span class="No-Break"><span class="koboSpan" id="kobo.95.1">manage changes:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer050">
<span class="koboSpan" id="kobo.96.1"><img alt="" src="image/B19755_03_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.97.1">Figure 3.2 – How IaC tools and services manage changes</span></p>
<p><em class="italic"><span class="koboSpan" id="kobo.98.1">Assuming that we used the declarative approach to provision the initial set of cloud resources, can we modify the configuration code and use the IaC tool again to update the existing set of infrastructure resources?</span></em><span class="koboSpan" id="kobo.99.1"> Similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.100.1">Figure 3</span></em></span><em class="italic"><span class="koboSpan" id="kobo.101.1">.2</span></em><span class="koboSpan" id="kobo.102.1">, certain IaC tools can manage the changes for us automatically and generate an </span><strong class="bold"><span class="koboSpan" id="kobo.103.1">execution plan</span></strong><span class="koboSpan" id="kobo.104.1"> that </span><a id="_idIndexMarker195"/><span class="koboSpan" id="kobo.105.1">modifies the infrastructure to reach the desired state as specified in the IaC configuration templates. </span><span class="koboSpan" id="kobo.105.2">These changes are then applied to the existing </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">infrastructure resources.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.107.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.108.1">It is important to note that IaC tools may either (1) perform in-place modifications in the infrastructure or (2) replace the entire infrastructure resources instead. </span><span class="koboSpan" id="kobo.108.2">This varies depending on the IaC tool, along with the type of change being performed. </span><span class="koboSpan" id="kobo.108.3">When working on resources deployed inside penetration testing lab environments, we generally want to replace the entire thing since old infrastructure resources may already be in an unstable or misconfigured state due to previous exploitation attempts </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">and activities.</span></span></p>
<h2 id="_idParaDest-43"><a id="_idTextAnchor042"/><span class="koboSpan" id="kobo.110.1">Leveraging IaC for penetration testing labs</span></h2>
<p><span class="koboSpan" id="kobo.111.1">Now, let’s talk </span><a id="_idIndexMarker196"/><span class="koboSpan" id="kobo.112.1">about why IaC</span><a id="_idIndexMarker197"/><span class="koboSpan" id="kobo.113.1"> mixes well with the preparation and management of penetration testing labs in the cloud. </span><span class="koboSpan" id="kobo.113.2">Creating and managing dedicated penetration testing lab environments in the cloud can be complex and time-consuming. </span><span class="koboSpan" id="kobo.113.3">Utilizing IaC can simplify this process and provide </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">numerous benefits.</span></span></p>
<p><span class="koboSpan" id="kobo.115.1">Here is a quick list of the advantages of using IaC when building penetration testing labs in </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">the cloud:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.117.1">Faster deployment</span></strong><span class="koboSpan" id="kobo.118.1">: Since</span><a id="_idIndexMarker198"/><span class="koboSpan" id="kobo.119.1"> the configuration code contains the properties and desired state of the resources to be created, we can quickly create and destroy various lab resources through an automated process within seconds (to, at most, a few minutes). </span><span class="koboSpan" id="kobo.119.2">This helps us easily rebuild specific cloud infrastructure resources that require a “refresh” after a penetration testing lab activity or experiment (since these activities may intentionally or unintentionally leave some services or resources in an unstable or </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">misconfigured state).</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.121.1">Collaboration</span></strong><span class="koboSpan" id="kobo.122.1">: We can easily share the lab environment configuration and setup as code with other engineers. </span><span class="koboSpan" id="kobo.122.2">This allows for easier collaboration and discussion when troubleshooting security configuration settings of resources deployed inside penetration testing lab environments (that is, without having to share your entire </span><span class="No-Break"><span class="koboSpan" id="kobo.123.1">cloud account).</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.124.1">Consistency</span></strong><span class="koboSpan" id="kobo.125.1">: If there are multiple vulnerable lab environments set up from a single instance of IaC configuration code, we only need to modify the IaC code once and apply the changes automatically to these lab environments. </span><span class="koboSpan" id="kobo.125.2">We can guarantee the repeatability of the infrastructure management process and ensure that the resource configuration and versions stay consistent every time we build our penetration testing lab environments. </span><span class="koboSpan" id="kobo.125.3">It is important to note that the exploitability of certain vulnerabilities and misconfigurations depends on the version of the applications and </span><span class="No-Break"><span class="koboSpan" id="kobo.126.1">resources used.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.127.1">Transparency</span></strong><span class="koboSpan" id="kobo.128.1">: Auditing infrastructure configuration mistakes is easier since we can check the current configuration using the code representing </span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">the infrastructure.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.130.1">Optimized</span></strong><span class="koboSpan" id="kobo.131.1">: Infrastructure cost management is easier</span><a id="_idIndexMarker199"/><span class="koboSpan" id="kobo.132.1"> since we can have our cloud resources turned off (or deleted) when nobody is using the penetration testing lab environments. </span><span class="koboSpan" id="kobo.132.2">Once the resources need to be created, it only takes a few minutes for the resources to be prepared from the infrastructure configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">code </span></span><span class="No-Break"><a id="_idIndexMarker200"/></span><span class="No-Break"><span class="koboSpan" id="kobo.134.1">available.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.135.1">As we can see, IaC enables faster deployment of lab resources through an automated process, allowing for quick creation and destruction of resources within seconds to a few minutes. </span><span class="koboSpan" id="kobo.135.2">Collaboration is simplified as engineers can easily share lab environment configurations and setups as code, facilitating troubleshooting of security settings without sharing the entire cloud account. </span><span class="koboSpan" id="kobo.135.3">Additionally, IaC ensures consistency by modifying the code once to apply changes automatically to multiple lab environments, guaranteeing repeatability and maintaining consistent resource configurations </span><span class="No-Break"><span class="koboSpan" id="kobo.136.1">and versions.</span></span></p>
<p><span class="koboSpan" id="kobo.137.1">With these points in mind, let’s proceed with best practices and strategies when using </span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">IaC solutions.</span></span></p>
<h2 id="_idParaDest-44"><a id="_idTextAnchor043"/><span class="koboSpan" id="kobo.139.1">Embracing IaC best practices and strategies</span></h2>
<p><span class="koboSpan" id="kobo.140.1">A variety of IaC tools</span><a id="_idIndexMarker201"/><span class="koboSpan" id="kobo.141.1"> have been used by developers and engineers these past </span><a id="_idIndexMarker202"/><span class="koboSpan" id="kobo.142.1">couple of years </span><a id="_idIndexMarker203"/><span class="koboSpan" id="kobo.143.1">to</span><a id="_idIndexMarker204"/><span class="koboSpan" id="kobo.144.1"> create</span><a id="_idIndexMarker205"/><span class="koboSpan" id="kobo.145.1"> and manage infrastructure. </span><span class="koboSpan" id="kobo.145.2">Some of the most popular ones </span><a id="_idIndexMarker206"/><span class="koboSpan" id="kobo.146.1">include </span><strong class="bold"><span class="koboSpan" id="kobo.147.1">Chef</span></strong><span class="koboSpan" id="kobo.148.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.149.1">Puppet</span></strong><span class="koboSpan" id="kobo.150.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.151.1">Vagrant</span></strong><span class="koboSpan" id="kobo.152.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.153.1">(R)?ex</span></strong><span class="koboSpan" id="kobo.154.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.155.1">SaltStack</span></strong><span class="koboSpan" id="kobo.156.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.157.1">Pulumi</span></strong><span class="koboSpan" id="kobo.158.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.159.1">Ansible</span></strong><span class="koboSpan" id="kobo.160.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.161.1">AWS Cloud Development Kit</span></strong><span class="koboSpan" id="kobo.162.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.163.1">AWS CDK</span></strong><span class="koboSpan" id="kobo.164.1">), </span><strong class="bold"><span class="koboSpan" id="kobo.165.1">AWS CloudFormation</span></strong><span class="koboSpan" id="kobo.166.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.167.1">GCP Deployment Manager</span></strong><span class="koboSpan" id="kobo.168.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.169.1">Azure Resource Manager</span></strong><span class="koboSpan" id="kobo.170.1">. </span><span class="koboSpan" id="kobo.170.2">Some</span><a id="_idIndexMarker207"/><span class="koboSpan" id="kobo.171.1"> of</span><a id="_idIndexMarker208"/><span class="koboSpan" id="kobo.172.1"> these tools (such as AWS CDK, AWS CloudFormation, GCP </span><a id="_idIndexMarker209"/><span class="koboSpan" id="kobo.173.1">Deployment </span><a id="_idIndexMarker210"/><span class="koboSpan" id="kobo.174.1">Manager, and </span><a id="_idIndexMarker211"/><span class="koboSpan" id="kobo.175.1">Azure Resource Manager) have been built to </span><a id="_idIndexMarker212"/><span class="koboSpan" id="kobo.176.1">automate the </span><a id="_idIndexMarker213"/><span class="koboSpan" id="kobo.177.1">creation, configuration, and management of resources for specific cloud providers. </span><span class="koboSpan" id="kobo.177.2">The rest are cloud-agnostic—that is, these tools should work across multiple cloud</span><a id="_idIndexMarker214"/><span class="koboSpan" id="kobo.178.1"> platforms such </span><a id="_idIndexMarker215"/><span class="koboSpan" id="kobo.179.1">as </span><strong class="bold"><span class="koboSpan" id="kobo.180.1">AWS</span></strong><span class="koboSpan" id="kobo.181.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.182.1">Microsoft Azure</span></strong><span class="koboSpan" id="kobo.183.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.184.1">GCP</span></strong><span class="koboSpan" id="kobo.185.1">. </span><span class="koboSpan" id="kobo.185.2">From</span><a id="_idIndexMarker216"/><span class="koboSpan" id="kobo.186.1"> this list, certain tools (such as Ansible, Chef, and Puppet) primarily focus on setting up applications and configuring </span><em class="italic"><span class="koboSpan" id="kobo.187.1">what’s inside a virtual machine</span></em><span class="koboSpan" id="kobo.188.1">, while others (such as Terraform) primarily focus on deploying and provisioning cloud infrastructure resources </span><span class="No-Break"><span class="koboSpan" id="kobo.189.1">from code.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.190.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.191.1">We can use multiple tools at the same time when deploying, provisioning, and configuring infrastructure. </span><span class="koboSpan" id="kobo.191.2">For example, we can use Terraform along with Ansible to automate the deployment of cloud infrastructure resources along with the applications running inside virtual machines. </span></p>
<p><span class="koboSpan" id="kobo.192.1">Before we </span><a id="_idIndexMarker217"/><span class="koboSpan" id="kobo.193.1">proceed with the next section, let’s discuss</span><a id="_idIndexMarker218"/><span class="koboSpan" id="kobo.194.1"> some strategies we can use when using IaC tools </span><span class="No-Break"><span class="koboSpan" id="kobo.195.1">and services:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.196.1">We can use </span><strong class="bold"><span class="koboSpan" id="kobo.197.1">version control systems</span></strong><span class="koboSpan" id="kobo.198.1"> (for example, Git) to track and manage changes to the IaC</span><a id="_idIndexMarker219"/><span class="koboSpan" id="kobo.199.1"> configuration code used to manage and deploy our penetration testing lab environments. </span><span class="koboSpan" id="kobo.199.2">In addition to this, we can have a </span><strong class="bold"><span class="koboSpan" id="kobo.200.1">Continuous Integration/Continuous Deployment</span></strong><span class="koboSpan" id="kobo.201.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.202.1">CI/CD</span></strong><span class="koboSpan" id="kobo.203.1">) pipeline</span><a id="_idIndexMarker220"/><span class="koboSpan" id="kobo.204.1"> automatically deploy the resources specified in the IaC files after changes in the code have been pushed to the </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">code repository.</span></span></li>
<li><span class="koboSpan" id="kobo.206.1">We can easily modularize and manage the different resource groups used in the lab environment by properly separating the code into multiple files. </span><span class="koboSpan" id="kobo.206.2">Once the components of the penetration testing labs have been modularized, we can easily generate different variations of vulnerable lab environments using the </span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">modules available.</span></span></li>
<li><span class="koboSpan" id="kobo.208.1">Cost plays a big factor in the design of penetration testing lab environments. </span><span class="koboSpan" id="kobo.208.2">IaC allows environment or cloud account owners to have cloud resources turned off (or non-existent) until they are needed. </span><em class="italic"><span class="koboSpan" id="kobo.209.1">Why?</span></em><span class="koboSpan" id="kobo.210.1"> Because IaC tools make it easy to create and bring resources back up from configuration files (generally within a matter of seconds or minutes). </span><span class="koboSpan" id="kobo.210.2">When designing and building penetration testing lab environments in the cloud, we also have the option  whether we allow multiple users to share the same environment or have each user have their own dedicated environments (which could be more costly). </span><span class="koboSpan" id="kobo.210.3">With IaC, we can easily allow the second option to be cost-effective since we can just create and provision the infrastructure from a template when the user needs to use it. </span><em class="italic"><span class="koboSpan" id="kobo.211.1">What’s the disadvantage of the first option?</span></em><span class="koboSpan" id="kobo.212.1"> Since the lab is shared by multiple users, a certain user might encounter unexpected issues during the penetration testing process since the resources involved may already be misconfigured due to an action (or actions) performed by another user. </span><span class="koboSpan" id="kobo.212.2">If one of the users decides to refresh or rest the box, then </span><a id="_idIndexMarker221"/><span class="koboSpan" id="kobo.213.1">any active work another user is doing will be </span><a id="_idIndexMarker222"/><span class="koboSpan" id="kobo.214.1">reset </span><span class="No-Break"><span class="koboSpan" id="kobo.215.1">as well.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.216.1">At this point, we should have a solid understanding of what IaC is and how we can leverage it to effectively manage penetration testing lab environments. </span><span class="koboSpan" id="kobo.216.2">In the next section, we’ll have our first look at one of the most popular IaC tools used by </span><span class="No-Break"><span class="koboSpan" id="kobo.217.1">professionals globally.</span></span></p>
<h1 id="_idParaDest-45"><a id="_idTextAnchor044"/><span class="koboSpan" id="kobo.218.1">Setting up Terraform in AWS CloudShell</span></h1>
<p><span class="koboSpan" id="kobo.219.1">In this chapter, we will focus on using </span><strong class="bold"><span class="koboSpan" id="kobo.220.1">Terraform</span></strong><span class="koboSpan" id="kobo.221.1"> to</span><a id="_idIndexMarker223"/><span class="koboSpan" id="kobo.222.1"> provision and manage our cloud infrastructure. </span><span class="koboSpan" id="kobo.222.2">Terraform is an open source IaC tool created by </span><strong class="bold"><span class="koboSpan" id="kobo.223.1">HashiCorp</span></strong><span class="koboSpan" id="kobo.224.1">. </span><span class="koboSpan" id="kobo.224.2">It’s one </span><a id="_idIndexMarker224"/><span class="koboSpan" id="kobo.225.1">of the most powerful and most used IaC tools at the moment. </span><span class="koboSpan" id="kobo.225.2">It enables users to define and provision infrastructure resources using a high-level configuration language. </span><span class="koboSpan" id="kobo.225.3">By utilizing a simple, declarative, and intuitive syntax, this IaC tool</span><a id="_idIndexMarker225"/><span class="koboSpan" id="kobo.226.1"> simplifies the process of creating, updating, and</span><a id="_idIndexMarker226"/><span class="koboSpan" id="kobo.227.1"> versioning infrastructure, which provides a powerful way to automate </span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">infrastructure management.</span></span></p>
<p><span class="koboSpan" id="kobo.229.1">Here’s an example of how Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.230.1">code looks:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.231.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.232.1">google_compute_firewall</span></strong><span class="koboSpan" id="kobo.233.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.234.1">allow-ssh-from-my-ip</span></strong><span class="koboSpan" id="kobo.235.1">" {  </span><strong class="bold"><span class="koboSpan" id="kobo.236.1">name</span></strong><span class="koboSpan" id="kobo.237.1">    = "allow-ssh-from-my-ip"
  </span><strong class="bold"><span class="koboSpan" id="kobo.238.1">network</span></strong><span class="koboSpan" id="kobo.239.1"> = local.net_02
  allow {
    protocol = "tcp"
    ports    = ["22"]
  }
  </span><strong class="bold"><span class="koboSpan" id="kobo.240.1">source_ranges</span></strong><span class="koboSpan" id="kobo.241.1"> = ["${</span><strong class="bold"><span class="koboSpan" id="kobo.242.1">var.my_ip</span></strong><span class="koboSpan" id="kobo.243.1">}/32"]
}</span></pre>
<p><span class="koboSpan" id="kobo.244.1">Here, we are simply defining a firewall rule (in GCP) that will allow us to initiate SSH connections (via port </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">22</span></strong><span class="koboSpan" id="kobo.246.1">) from our local </span><a id="_idIndexMarker227"/><span class="koboSpan" id="kobo.247.1">machine to resources in the specified </span><strong class="bold"><span class="koboSpan" id="kobo.248.1">Virtual Private Cloud</span></strong><span class="koboSpan" id="kobo.249.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.250.1">VPC</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.251.1">) network.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.252.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.253.1">Do not worry if the sample Terraform code doesn’t make complete sense at the moment! </span><span class="koboSpan" id="kobo.253.2">In succeeding chapters of the book, we will dive deeper into how Terraform is used to manage penetration testing lab environment resources on cloud platforms such as AWS, Azure, and GCP. </span><span class="koboSpan" id="kobo.253.3">We will explore the concepts, syntax, and practical examples specific to these cloud providers, which will help us gain a clearer understanding of Terraform’s usage in </span><span class="No-Break"><span class="koboSpan" id="kobo.254.1">real-world scenarios.</span></span></p>
<p><span class="koboSpan" id="kobo.255.1">As we can see in the sample code provided, the Terraform code used to build the vulnerable cloud infrastructure is </span><strong class="bold"><span class="koboSpan" id="kobo.256.1">declarative</span></strong><span class="koboSpan" id="kobo.257.1"> and</span><a id="_idIndexMarker228"/><span class="koboSpan" id="kobo.258.1"> self-documenting. </span><span class="koboSpan" id="kobo.258.2">Instead of focusing on </span><em class="italic"><span class="koboSpan" id="kobo.259.1">how</span></em><span class="koboSpan" id="kobo.260.1"> these infrastructure resources are prepared, we simply just need to specify the desired state, and Terraform takes care of the details to convert the current state into the desired state. </span><span class="koboSpan" id="kobo.260.2">Other tools utilize the </span><strong class="bold"><span class="koboSpan" id="kobo.261.1">imperative</span></strong><span class="koboSpan" id="kobo.262.1"> approach</span><a id="_idIndexMarker229"/><span class="koboSpan" id="kobo.263.1"> in automation, where engineers define the commands in order to reach the desired state. </span><span class="koboSpan" id="kobo.263.2">The advantage of the imperative approach in automation is the ability to have fine-grained control over the sequence of commands and actions taken to reach the desired state. </span><span class="koboSpan" id="kobo.263.3">This can be useful in complex scenarios that require specific scripting or procedural logic. </span><span class="koboSpan" id="kobo.263.4">This is in contrast with the </span><strong class="bold"><span class="koboSpan" id="kobo.264.1">declarative</span></strong><span class="koboSpan" id="kobo.265.1"> approach, where we just need to specify how the desired state of the infrastructure should look. </span><span class="koboSpan" id="kobo.265.2">We will primarily use the declarative approach in this book whenever we can. </span><span class="koboSpan" id="kobo.265.3">If you are just starting out with IaC and automation concepts, starting with the declarative approach in Terraform can provide a more intuitive and straightforward way to understand and manage infrastructure resources. </span><span class="koboSpan" id="kobo.265.4">That said, the declarative approach offers a clear and concise representation of the desired state, making it easier to learn and </span><span class="No-Break"><span class="koboSpan" id="kobo.266.1">work with.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.267.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.268.1">Note that it is possible to use the </span><a id="_idIndexMarker230"/><span class="koboSpan" id="kobo.269.1">imperative approach with Terraform using </span><strong class="bold"><span class="koboSpan" id="kobo.270.1">CDK for Terraform</span></strong><span class="koboSpan" id="kobo.271.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.272.1">CDKTF</span></strong><span class="koboSpan" id="kobo.273.1">). </span><span class="koboSpan" id="kobo.273.2">For more information about CDKTF, feel free to check out the</span><a id="_idIndexMarker231"/><span class="koboSpan" id="kobo.274.1"> following </span><span class="No-Break"><span class="koboSpan" id="kobo.275.1">link: </span></span><a href="https://developer.hashicorp.com/terraform/cdktf"><span class="No-Break"><span class="koboSpan" id="kobo.276.1">https://developer.hashicorp.com/terraform/cdktf</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.277.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.278.1">Of course, before we can use Terraform, we have to make sure that it is properly installed and set up in our environment! </span><span class="koboSpan" id="kobo.278.2">There are different ways to install Terraform. </span><span class="koboSpan" id="kobo.278.3">One way would be to </span><a id="_idIndexMarker232"/><span class="koboSpan" id="kobo.279.1">use </span><strong class="bold"><span class="koboSpan" id="kobo.280.1">tfenv</span></strong><span class="koboSpan" id="kobo.281.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.282.1">Terraform version manager</span></strong><span class="koboSpan" id="kobo.283.1">) to help us easily work with and manage different </span><span class="No-Break"><span class="koboSpan" id="kobo.284.1">Terraform versions.</span></span></p>
<p><span class="koboSpan" id="kobo.285.1">In the next set </span><a id="_idIndexMarker233"/><span class="koboSpan" id="kobo.286.1">of steps, we will set up and install Terraform in our </span><a id="_idIndexMarker234"/><span class="koboSpan" id="kobo.287.1">AWS CloudShell environment using the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">version manager:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.289.1">Open a new browser tab and then navigate to the AWS console. </span><span class="koboSpan" id="kobo.289.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">shell</span></strong><span class="koboSpan" id="kobo.291.1"> in the search bar and then select </span><strong class="bold"><span class="koboSpan" id="kobo.292.1">CloudShell</span></strong><span class="koboSpan" id="kobo.293.1"> from the list of results. </span><span class="koboSpan" id="kobo.293.2">Alternatively, you may simply locate and click the </span><strong class="bold"><span class="koboSpan" id="kobo.294.1">CloudShell</span></strong><span class="koboSpan" id="kobo.295.1"> button located in the upper-left corner of the AWS Management Console (near the region selection </span><span class="No-Break"><span class="koboSpan" id="kobo.296.1">drop-down menu).</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.297.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.298.1">Wait for around a minute or two for the AWS CloudShell environment to be ready. </span><span class="koboSpan" id="kobo.298.2">Given that the CloudShell environment offers a maximum of 1 GB disk space (per AWS region), it becomes necessary to monitor disk usage regularly using commands such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">df -h</span></strong><span class="koboSpan" id="kobo.300.1"> (disk free) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">du -sh</span></strong><span class="koboSpan" id="kobo.302.1"> (disk usage). </span><span class="koboSpan" id="kobo.302.2">These commands provide insights into the amount of disk space utilized and help determine whether we are approaching the 1 GB limit. </span><span class="koboSpan" id="kobo.302.3">By actively monitoring disk space, we can avoid potential storage constraints within the CloudShell environment. </span><span class="koboSpan" id="kobo.302.4">For </span><a id="_idIndexMarker235"/><span class="koboSpan" id="kobo.303.1">more information, feel free to check out the following </span><span class="No-Break"><span class="koboSpan" id="kobo.304.1">link: </span></span><a href="https://docs.aws.amazon.com/cloudshell/latest/userguide/limits.html"><span class="No-Break"><span class="koboSpan" id="kobo.305.1">https://docs.aws.amazon.com/cloudshell/latest/userguide/limits.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.306.1">.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.307.1">In the AWS CloudShell terminal (after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">$</span></strong><span class="koboSpan" id="kobo.309.1"> sign), run the following </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">git clone</span></strong><span class="koboSpan" id="kobo.311.1"> command to clone the </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">tfutils/tfenv</span></strong><span class="koboSpan" id="kobo.313.1"> repository to our </span><span class="No-Break"><span class="koboSpan" id="kobo.314.1">CloudShell environment:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.315.1">git clone </span></strong><a href="https://github.com/tfutils/tfenv.git"><strong class="bold"><span class="koboSpan" id="kobo.316.1">https://github.com/tfutils/tfenv.git</span></strong></a><strong class="bold"><span class="koboSpan" id="kobo.317.1"> ~/.tfenv</span></strong></pre></li> <li><span class="koboSpan" id="kobo.318.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.319.1">bin</span></strong><span class="koboSpan" id="kobo.320.1"> directory (inside the user home directory) using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.321.1">mkdir</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.322.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.323.1">mkdir ~/bin</span></strong></pre></li> <li><span class="koboSpan" id="kobo.324.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">ls</span></strong><span class="koboSpan" id="kobo.326.1"> command to list the files stored </span><span class="No-Break"><span class="koboSpan" id="kobo.327.1">inside </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">~/.tfenv/bin/</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.330.1">ls -hF ~/.tfenv/bin/</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.331.1">This should yield a list of results similar to </span><span class="No-Break"><span class="koboSpan" id="kobo.332.1">the following:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.333.1">terraform*  tfenv*</span></pre></li> <li><span class="koboSpan" id="kobo.334.1">Next, let’s </span><a id="_idIndexMarker236"/><span class="koboSpan" id="kobo.335.1">use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">ln -s</span></strong><span class="koboSpan" id="kobo.337.1"> command to create a </span><a id="_idIndexMarker237"/><span class="koboSpan" id="kobo.338.1">soft symbolic link for the executable files stored </span><span class="No-Break"><span class="koboSpan" id="kobo.339.1">inside </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.340.1">~/.tfenv/bin/</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.341.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.342.1">ln -s ~/.tfenv/bin/* ~/bin/</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.343.1">What are soft symbolic links?</span></p>
<p class="callout"><strong class="bold"><span class="koboSpan" id="kobo.344.1">Soft symbolic links</span></strong><span class="koboSpan" id="kobo.345.1">, also known as </span><strong class="bold"><span class="koboSpan" id="kobo.346.1">symlinks</span></strong><span class="koboSpan" id="kobo.347.1">, are special files in a filesystem that serve as pointers to other files or</span><a id="_idIndexMarker238"/><span class="koboSpan" id="kobo.348.1"> directories. </span><span class="koboSpan" id="kobo.348.2">They reference the target by its path and essentially create a shortcut to the target file </span><span class="No-Break"><span class="koboSpan" id="kobo.349.1">or directory.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.350.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">readlink</span></strong><span class="koboSpan" id="kobo.352.1"> command</span><a id="_idIndexMarker239"/><span class="koboSpan" id="kobo.353.1"> to verify whether the previous</span><a id="_idIndexMarker240"/><span class="koboSpan" id="kobo.354.1"> command worked </span><span class="No-Break"><span class="koboSpan" id="kobo.355.1">as expected:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.356.1">readlink -f ~/bin/*</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.357.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.358.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.359.1">/home/cloudshell-user/.tfenv/bin/</span><strong class="bold"><span class="koboSpan" id="kobo.360.1">terraform</span></strong><span class="koboSpan" id="kobo.361.1">
/home/cloudshell-user/.tfenv/bin/</span><strong class="bold"><span class="koboSpan" id="kobo.362.1">tfenv</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.363.1">Here, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.364.1">readlink</span></strong><span class="koboSpan" id="kobo.365.1"> command to obtain the full paths of files in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.366.1">~/bin</span></strong><span class="koboSpan" id="kobo.367.1"> directory by resolving the symbolic links and providing the absolute paths of </span><span class="No-Break"><span class="koboSpan" id="kobo.368.1">each file.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.369.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.370.1">Since </span><strong class="source-inline"><span class="koboSpan" id="kobo.371.1">~/bin</span></strong><span class="koboSpan" id="kobo.372.1"> has already been added to </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">$PATH</span></strong><span class="koboSpan" id="kobo.374.1">, we should be able to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">terraform</span></strong><span class="koboSpan" id="kobo.376.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">tfenv</span></strong><span class="koboSpan" id="kobo.378.1"> after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">ln -s</span></strong><span class="koboSpan" id="kobo.380.1"> command in the </span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">previous step.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.382.1">Let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">tfenv install</span></strong><span class="koboSpan" id="kobo.384.1"> command to install a specific version (</span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">1.3.9</span></strong><span class="koboSpan" id="kobo.386.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.387.1">of Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.388.1">tfenv install 1.3.9</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.389.1">By running </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">tfenv install 1.3.9</span></strong><span class="koboSpan" id="kobo.391.1">, we instruct </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">tfenv</span></strong><span class="koboSpan" id="kobo.393.1"> to download and set up Terraform version </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">1.3.9</span></strong><span class="koboSpan" id="kobo.395.1"> on our system. </span><span class="koboSpan" id="kobo.395.2">This specific version will be installed in a separate directory, keeping it isolated from other installed versions </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">of Terraform.</span></span></p></li> <li><span class="koboSpan" id="kobo.397.1">Next, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.398.1">tfenv use</span></strong><span class="koboSpan" id="kobo.399.1"> command to switch to and use version </span><strong class="source-inline"><span class="koboSpan" id="kobo.400.1">1.3.9</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.401.1">of Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.402.1">tfenv use 1.3.9</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.403.1">When we run this command, </span><strong class="source-inline"><span class="koboSpan" id="kobo.404.1">tfenv</span></strong><span class="koboSpan" id="kobo.405.1"> will configure our system to use Terraform version </span><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">1.3.9</span></strong><span class="koboSpan" id="kobo.407.1"> for any subsequent Terraform commands executed in the current shell session or directory. </span><span class="koboSpan" id="kobo.407.2">This allows us to work with the features and functionality specific to </span><span class="No-Break"><span class="koboSpan" id="kobo.408.1">this version.</span></span></p></li> <li><span class="koboSpan" id="kobo.409.1">Finally, let’s check whether Terraform has been successfully installed using the </span><span class="No-Break"><span class="koboSpan" id="kobo.410.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.411.1">terraform --version</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.412.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.413.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.414.1">Terraform v</span><strong class="bold"><span class="koboSpan" id="kobo.415.1">1.3.9</span></strong><span class="koboSpan" id="kobo.416.1">
on linux_amd64</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.417.1">This confirms </span><a id="_idIndexMarker241"/><span class="koboSpan" id="kobo.418.1">that Terraform version </span><strong class="source-inline"><span class="koboSpan" id="kobo.419.1">1.3.9</span></strong><span class="koboSpan" id="kobo.420.1"> has </span><a id="_idIndexMarker242"/><span class="koboSpan" id="kobo.421.1">been installed and is ready </span><span class="No-Break"><span class="koboSpan" id="kobo.422.1">for use!</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.423.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.424.1">By the time you read the book, a newer version of Terraform might already be available. </span><span class="koboSpan" id="kobo.424.2">However, it’s still recommended to use the version used in this chapter to avoid any issues with running the hands-on solutions and examples. </span><span class="koboSpan" id="kobo.424.3">Simply use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.425.1">tfenv</span></strong><span class="koboSpan" id="kobo.426.1"> command to “time-travel” and use an older version of Terraform if needed. </span><span class="koboSpan" id="kobo.426.2">This will help make sure that all examples in this chapter will continue to work without issues. </span><span class="koboSpan" id="kobo.426.3">If a newer version of Terraform is available, you can always use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">tfenv</span></strong><span class="koboSpan" id="kobo.428.1"> command to install and switch to that version if desired. </span><span class="koboSpan" id="kobo.428.2">This flexibility allows you to stay up to date with the latest features and improvements. </span><span class="koboSpan" id="kobo.428.3">However, it’s important to note that using the version specified in the book ensures consistency and avoids any potential </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">compatibility issues.</span></span></p>
<p><span class="koboSpan" id="kobo.430.1">With Terraform set up in our AWS CloudShell environment, let’s proceed to the </span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">next section!</span></span></p>
<h1 id="_idParaDest-46"><a id="_idTextAnchor045"/><span class="koboSpan" id="kobo.432.1">Getting our feet wet with Terraform</span></h1>
<p><span class="koboSpan" id="kobo.433.1">In this section, we will provide a brief overview of the essential Terraform workflow and then move on to a “</span><em class="italic"><span class="koboSpan" id="kobo.434.1">Hello World</span></em><span class="koboSpan" id="kobo.435.1">” example to test </span><span class="No-Break"><span class="koboSpan" id="kobo.436.1">our setup.</span></span></p>
<h2 id="_idParaDest-47"><a id="_idTextAnchor046"/><span class="koboSpan" id="kobo.437.1">Understanding the core Terraform workflow</span></h2>
<p><span class="koboSpan" id="kobo.438.1">It </span><a id="_idIndexMarker243"/><span class="koboSpan" id="kobo.439.1">may take most of us around 2-4 weeks to learn a new tool, platform, or framework. </span><span class="koboSpan" id="kobo.439.2">However, it would probably take us just a few hours (to, at most, a few days) to learn Terraform since using it is straightforward and easy. </span><span class="koboSpan" id="kobo.439.3">When using Terraform, engineers generally follow a process similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.440.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.441.1">.3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.442.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer051">
<span class="koboSpan" id="kobo.443.1"><img alt="" src="image/B19755_03_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.444.1">Figure 3.3 – A common workflow when using Terraform to create and update resources</span></p>
<p><span class="koboSpan" id="kobo.445.1">Once we have the configuration file (or files) ready, we simply run </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">terraform init</span></strong><span class="koboSpan" id="kobo.447.1"> to initialize the Terraform environment. </span><span class="koboSpan" id="kobo.447.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">terraform init</span></strong><span class="koboSpan" id="kobo.449.1"> command is usually executed when our environment has not been initialized yet or when additional files or plugins need to be downloaded. </span><span class="koboSpan" id="kobo.449.2">The next step involves using </span><strong class="source-inline"><span class="koboSpan" id="kobo.450.1">terraform plan</span></strong><span class="koboSpan" id="kobo.451.1"> to process the configuration code and generate an execution plan for us to review. </span><span class="koboSpan" id="kobo.451.2">Note that running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.452.1">terraform plan</span></strong><span class="koboSpan" id="kobo.453.1"> command is not required but </span><em class="italic"><span class="koboSpan" id="kobo.454.1">recommended</span></em><span class="koboSpan" id="kobo.455.1">. </span><span class="koboSpan" id="kobo.455.2">Finally, we can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">terraform apply</span></strong><span class="koboSpan" id="kobo.457.1"> to implement the changes described in the </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">execution plan.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.459.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.460.1">Running </span><strong class="source-inline"><span class="koboSpan" id="kobo.461.1">terraform init</span></strong><span class="koboSpan" id="kobo.462.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">terraform plan</span></strong><span class="koboSpan" id="kobo.464.1"> are generally </span><em class="italic"><span class="koboSpan" id="kobo.465.1">safe</span></em><span class="koboSpan" id="kobo.466.1"> commands to run since (1) these involve </span><strong class="bold"><span class="koboSpan" id="kobo.467.1">idempotent</span></strong><span class="koboSpan" id="kobo.468.1"> operations and (2) they won’t create/modify any infrastructure resources yet. </span><span class="koboSpan" id="kobo.468.2">In this context, idempotent means that executing these commands multiple times will have the </span><em class="italic"><span class="koboSpan" id="kobo.469.1">same</span></em><span class="koboSpan" id="kobo.470.1"> outcome without causing unintended side effects. </span><span class="koboSpan" id="kobo.470.2">This makes them suitable for safely initializing and planning </span><span class="No-Break"><span class="koboSpan" id="kobo.471.1">infrastructure configurations.</span></span></p>
<p><span class="koboSpan" id="kobo.472.1">There are other </span><a id="_idIndexMarker244"/><span class="koboSpan" id="kobo.473.1">commands we can use to help us perform specific tasks (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.474.1">terraform show</span></strong><span class="koboSpan" id="kobo.475.1">), but other than these three primary commands, one other command we need to know would be the </span><strong class="source-inline"><span class="koboSpan" id="kobo.476.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.477.1"> command. </span><span class="koboSpan" id="kobo.477.2">Running this command would delete the resources created and managed </span><span class="No-Break"><span class="koboSpan" id="kobo.478.1">using Terraform.</span></span></p>
<h2 id="_idParaDest-48"><a id="_idTextAnchor047"/><span class="koboSpan" id="kobo.479.1">Testing our Terraform setup with a Hello World example</span></h2>
<p><span class="koboSpan" id="kobo.480.1">Now that we have a</span><a id="_idIndexMarker245"/><span class="koboSpan" id="kobo.481.1"> good idea of how to use</span><a id="_idIndexMarker246"/><span class="koboSpan" id="kobo.482.1"> Terraform, let’s work on a very simple Terraform example, </span><span class="No-Break"><span class="koboSpan" id="kobo.483.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.484.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.485.1">hello_terraform</span></strong><span class="koboSpan" id="kobo.486.1"> directory using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">mkdir</span></strong><span class="koboSpan" id="kobo.488.1"> command. </span><span class="koboSpan" id="kobo.488.2">Navigate to the directory created using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">cd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.490.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.491.1">mkdir hello_terraform</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.492.1">cd hello_terraform</span></strong></pre></li> <li><span class="koboSpan" id="kobo.493.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.494.1">touch</span></strong><span class="koboSpan" id="kobo.495.1"> command to create an empty </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.496.1">main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.497.1"> file:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.498.1">touch main.tf</span></strong></pre></li> <li><span class="koboSpan" id="kobo.499.1">Run the following command to open the empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">main.tf</span></strong><span class="koboSpan" id="kobo.501.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.502.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.503.1">vim main.tf</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.504.1">Learning how to use a command-line text editor such as Vim may be a bit daunting at first. </span><span class="koboSpan" id="kobo.504.2">However, you’ll see that Vim is relatively easy and fun to use once you get a hang </span><span class="No-Break"><span class="koboSpan" id="kobo.505.1">of it!</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.506.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.507.1">You may type </span><strong class="source-inline"><span class="koboSpan" id="kobo.508.1">:set nu</span></strong><span class="koboSpan" id="kobo.509.1"> and then press the </span><em class="italic"><span class="koboSpan" id="kobo.510.1">Enter</span></em><span class="koboSpan" id="kobo.511.1"> key to show the </span><span class="No-Break"><span class="koboSpan" id="kobo.512.1">line numbers.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.513.1">Next, press </span><em class="italic"><span class="koboSpan" id="kobo.514.1">i</span></em><span class="koboSpan" id="kobo.515.1"> to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.516.1">insert mode</span></strong><span class="koboSpan" id="kobo.517.1"> so that we can edit </span><span class="No-Break"><span class="koboSpan" id="kobo.518.1">the file.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.519.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.520.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.521.1">insert mode</span></strong><span class="koboSpan" id="kobo.522.1"> in</span><a id="_idIndexMarker247"/><span class="koboSpan" id="kobo.523.1"> Vim allows us to type and make changes as we would in a regular text editor. </span><span class="koboSpan" id="kobo.523.2">In this mode, we can freely add, delete, or modify characters without affecting the </span><span class="No-Break"><span class="koboSpan" id="kobo.524.1">surrounding text.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.525.1">Type or paste the following block of code into our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.526.1">main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.527.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.528.1">
resource "null_resource" "hello" {
  provisioner "local-exec" {
    command = "</span><strong class="bold"><span class="koboSpan" id="kobo.529.1">touch hello.txt</span></strong><span class="koboSpan" id="kobo.530.1">"
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.531.1">Here, we </span><a id="_idIndexMarker248"/><span class="koboSpan" id="kobo.532.1">declare a </span><strong class="source-inline"><span class="koboSpan" id="kobo.533.1">null_resource</span></strong><span class="koboSpan" id="kobo.534.1"> resource, which is useful for actions and operations that do not involve the creation </span><a id="_idIndexMarker249"/><span class="koboSpan" id="kobo.535.1">of resources. </span><span class="koboSpan" id="kobo.535.2">In this case, we’re using it to run a script or </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">a command.</span></span></p></li> <li><span class="koboSpan" id="kobo.537.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.538.1">Esc</span></em><span class="koboSpan" id="kobo.539.1"> key to switch </span><a id="_idIndexMarker250"/><span class="koboSpan" id="kobo.540.1">to </span><strong class="bold"><span class="koboSpan" id="kobo.541.1">normal mode</span></strong><span class="koboSpan" id="kobo.542.1">. </span><span class="koboSpan" id="kobo.542.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">:wq!</span></strong><span class="koboSpan" id="kobo.544.1">. </span><span class="koboSpan" id="kobo.544.2">Press </span><em class="italic"><span class="koboSpan" id="kobo.545.1">Enter</span></em><span class="koboSpan" id="kobo.546.1"> afterward. </span><span class="koboSpan" id="kobo.546.2">This will save the changes made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">main.tf</span></strong><span class="koboSpan" id="kobo.548.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.549.1">as well.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.550.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.551.1">Earlier, we described how the insert mode works in Vim. </span><span class="koboSpan" id="kobo.551.2">Now, let’s quickly talk about the normal mode. </span><span class="koboSpan" id="kobo.551.3">The </span><strong class="bold"><span class="koboSpan" id="kobo.552.1">normal mode</span></strong><span class="koboSpan" id="kobo.553.1"> allows</span><a id="_idIndexMarker251"/><span class="koboSpan" id="kobo.554.1"> us to navigate through text, execute commands, and perform various operations on the file. </span><span class="koboSpan" id="kobo.554.2">In this mode, specific keystrokes (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.555.1">:wq!</span></strong><span class="koboSpan" id="kobo.556.1">) can be used to move the cursor, search for text, copy and paste, and perform editing actions such as deleting, replacing, and undoing changes. </span><span class="koboSpan" id="kobo.556.2">For instance, “</span><strong class="source-inline"><span class="koboSpan" id="kobo.557.1">w</span></strong><span class="koboSpan" id="kobo.558.1">” represents the </span><em class="italic"><span class="koboSpan" id="kobo.559.1">write</span></em><span class="koboSpan" id="kobo.560.1"> command (which saves changes to the file), and “</span><strong class="source-inline"><span class="koboSpan" id="kobo.561.1">q</span></strong><span class="koboSpan" id="kobo.562.1">” represents the </span><em class="italic"><span class="koboSpan" id="kobo.563.1">quit</span></em><span class="koboSpan" id="kobo.564.1"> command (which exits the editor). </span><span class="koboSpan" id="kobo.564.2">What’s the exclamation point (</span><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">!</span></strong><span class="koboSpan" id="kobo.566.1">) for? </span><span class="koboSpan" id="kobo.566.2">“</span><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">!</span></strong><span class="koboSpan" id="kobo.568.1">” is simply an optional modifier that forces the command to execute, even if there are unsaved changes along with </span><span class="No-Break"><span class="koboSpan" id="kobo.569.1">other warnings.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.570.1">Now that </span><a id="_idIndexMarker252"/><span class="koboSpan" id="kobo.571.1">our </span><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">main.tf</span></strong><span class="koboSpan" id="kobo.573.1"> file is</span><a id="_idIndexMarker253"/><span class="koboSpan" id="kobo.574.1"> ready, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.575.1">terraform init</span></strong><span class="koboSpan" id="kobo.576.1"> command to initialize the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.577.1">working directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.578.1">terraform init</span></strong></pre></li> <li><span class="koboSpan" id="kobo.579.1">To help us have a better idea of what </span><strong class="source-inline"><span class="koboSpan" id="kobo.580.1">terraform init</span></strong><span class="koboSpan" id="kobo.581.1"> initialized and set up for us, let’s install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.582.1">tree</span></strong><span class="koboSpan" id="kobo.583.1"> utility using the </span><span class="No-Break"><span class="koboSpan" id="kobo.584.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.585.1">sudo yum install tree -y</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.586.1">With the </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">tree</span></strong><span class="koboSpan" id="kobo.588.1"> utility installed, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">tree</span></strong><span class="koboSpan" id="kobo.590.1"> command to help us check and visualize the directories and files in our </span><span class="No-Break"><span class="koboSpan" id="kobo.591.1">current directory:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.592.1">tree -a</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.593.1">This should yield a tree similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.594.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.595.1">.4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.596.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer052">
<span class="koboSpan" id="kobo.597.1"><img alt="" src="image/B19755_03_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.598.1">Figure 3.4 – Results after running the tree command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.599.1">Here, we can see that after running </span><strong class="source-inline"><span class="koboSpan" id="kobo.600.1">terraform init</span></strong><span class="koboSpan" id="kobo.601.1">, we suddenly have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.602.1">.terraform</span></strong><span class="koboSpan" id="kobo.603.1"> directory with a tree structure of directories </span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">and file(s).</span></span></p></li>
</ol>
<ol>
<li value="9"><span class="koboSpan" id="kobo.605.1">Next, let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">terraform plan</span></strong><span class="koboSpan" id="kobo.607.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.608.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.609.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.610.1">This should yield</span><a id="_idIndexMarker254"/><span class="koboSpan" id="kobo.611.1"> a set of logs similar to </span><a id="_idIndexMarker255"/><span class="koboSpan" id="kobo.612.1">what we have in the following block of </span><span class="No-Break"><span class="koboSpan" id="kobo.613.1">log messages:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.614.1">Terraform used the selected providers to generate the following execution plan. </span><span class="koboSpan" id="kobo.614.2">Resource actions are indicated with the following symbols:
  + create
Terraform will perform the following actions:
  # null_resource.hello will be created
  + resource "null_resource" "hello" {
      + id = (known after apply)
    }
Plan: 1 to add, 0 to change, 0 to destroy.</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.615.1">Here, we have an </span><strong class="bold"><span class="koboSpan" id="kobo.616.1">execution plan</span></strong><span class="koboSpan" id="kobo.617.1"> that</span><a id="_idIndexMarker256"/><span class="koboSpan" id="kobo.618.1"> indicates which resources will be created (</span><strong class="source-inline"><span class="koboSpan" id="kobo.619.1">1</span></strong><span class="koboSpan" id="kobo.620.1">), modified (</span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">0</span></strong><span class="koboSpan" id="kobo.622.1">), or destroyed (</span><strong class="source-inline"><span class="koboSpan" id="kobo.623.1">0</span></strong><span class="koboSpan" id="kobo.624.1">) once we run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.625.1">terraform apply</span></strong><span class="koboSpan" id="kobo.626.1"> command in a </span><span class="No-Break"><span class="koboSpan" id="kobo.627.1">later step.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.628.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.629.1">Terraform’s execution plan is like a blueprint that outlines the steps and actions it will execute to achieve the desired infrastructure state (as defined in the Terraform configuration code). </span><span class="koboSpan" id="kobo.629.2">It is similar to how the SQL </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">EXPLAIN</span></strong><span class="koboSpan" id="kobo.631.1"> command provides a detailed breakdown of how a database management system will execute a specific query. </span><span class="koboSpan" id="kobo.631.2">That said, given that Terraform abstracts what’s happening behind the scenes with its declarative syntax, the execution plan serves as a valuable mechanism for previewing changes that will be made to </span><span class="No-Break"><span class="koboSpan" id="kobo.632.1">the infrastructure.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.633.1">With everything</span><a id="_idIndexMarker257"/><span class="koboSpan" id="kobo.634.1"> ready, let’s use </span><a id="_idIndexMarker258"/><span class="koboSpan" id="kobo.635.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.636.1">terraform apply</span></strong><span class="koboSpan" id="kobo.637.1"> command to implement the changes specified in the execution plan returned after running </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.638.1">terraform plan</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.639.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.640.1">terraform apply</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.641.1">This should yield a set of logs similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.642.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.643.1">.5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.644.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer053">
<span class="koboSpan" id="kobo.645.1"><img alt="" src="image/B19755_03_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.646.1">Figure 3.5 – Verification step after running the terraform apply command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.647.1">During the</span><a id="_idIndexMarker259"/><span class="koboSpan" id="kobo.648.1"> verification</span><a id="_idIndexMarker260"/><span class="koboSpan" id="kobo.649.1"> step (that is, when you see an </span><strong class="bold"><span class="koboSpan" id="kobo.650.1">Enter a value:</span></strong><span class="koboSpan" id="kobo.651.1"> message), type in </span><strong class="source-inline"><span class="koboSpan" id="kobo.652.1">yes</span></strong><span class="koboSpan" id="kobo.653.1"> to proceed with the creation of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.654.1">hello.txt</span></strong><span class="koboSpan" id="kobo.655.1"> file. </span><span class="koboSpan" id="kobo.655.2">After pressing the </span><em class="italic"><span class="koboSpan" id="kobo.656.1">Enter</span></em><span class="koboSpan" id="kobo.657.1"> key, we should get the following set </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">of logs:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.659.1">
null_resource.hello: Creating...null_resource.hello: Provisioning with 'local-exec'...
</span><span class="koboSpan" id="kobo.659.2">null_resource.hello (local-exec): Executing: ["/bin/sh" "-c" "</span><strong class="bold"><span class="koboSpan" id="kobo.660.1">touch hello.txt</span></strong><span class="koboSpan" id="kobo.661.1">"]
null_resource.hello: Creation complete after 0s [id=2409621687302957875]</span></pre>
<p class="list-inset"><span class="koboSpan" id="kobo.662.1">Here, we can see that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.663.1">terraform apply</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.664.1">command succeeded!</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.665.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.666.1">Running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">terraform apply</span></strong><span class="koboSpan" id="kobo.668.1"> command should execute </span><strong class="source-inline"><span class="koboSpan" id="kobo.669.1">touch hello.txt</span></strong><span class="koboSpan" id="kobo.670.1"> and create an empty </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.671.1">hello.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.672.1"> file.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.673.1">Before celebrating, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.674.1">ls</span></strong><span class="koboSpan" id="kobo.675.1"> command to check whether our </span><strong class="source-inline"><span class="koboSpan" id="kobo.676.1">hello.txt</span></strong><span class="koboSpan" id="kobo.677.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.678.1">got created:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.679.1">ls</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.680.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.681.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.682.1">hello.txt  main.tf  terraform.tfstate</span></pre></li> <li><span class="koboSpan" id="kobo.683.1">Now, let’s inspect the </span><strong class="source-inline"><span class="koboSpan" id="kobo.684.1">terraform.tfstate</span></strong><span class="koboSpan" id="kobo.685.1"> file using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.686.1">cat</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.687.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.688.1">cat terraform.tfstate</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.689.1">This should </span><a id="_idIndexMarker261"/><span class="koboSpan" id="kobo.690.1">give us a nested JSON</span><a id="_idIndexMarker262"/><span class="koboSpan" id="kobo.691.1"> structure similar to what we have in the </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">following block:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.693.1">{
  "version": 4,
  "terraform_version": "1.3.9",
  "serial": 1,
  "lineage": "6e0599fb-00c6-e724-2dd1-e600ea7726a0",
  "outputs": {},
  "resources": [
    {
      "mode": "managed",
      "type": "null_resource",
      "name": "hello",
       ...
</span><span class="koboSpan" id="kobo.693.2">    }
  ],
  "check_results": null
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.694.1">Here, we have confirmed that Terraform has stored the information that represents the current set of infrastructure resources (managed by Terraform) inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.695.1">terraform.tfstate</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.696.1"> file.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.697.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.698.1">Terraform utilizes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.699.1">terraform.tfstate</span></strong><span class="koboSpan" id="kobo.700.1"> file to keep track of the current state of the infrastructure. </span><span class="koboSpan" id="kobo.700.2">This file stores critical information such as resource IDs, dependencies, and metadata. </span><span class="koboSpan" id="kobo.700.3">Terraform makes use of this file when performing diff checks before infrastructure resources are created or modified. </span><span class="koboSpan" id="kobo.700.4">Make sure </span><em class="italic"><span class="koboSpan" id="kobo.701.1">not</span></em><span class="koboSpan" id="kobo.702.1"> to edit or delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.703.1">terraform.tfstate</span></strong><span class="koboSpan" id="kobo.704.1"> file in your working directory as this can lead to inconsistencies and potential errors in your Terraform workflow. </span><span class="koboSpan" id="kobo.704.2">In case you’ve accidentally deleted the </span><strong class="source-inline"><span class="koboSpan" id="kobo.705.1">terraform.tfstate</span></strong><span class="koboSpan" id="kobo.706.1"> file, do not panic as there are various ways to recover from this scenario! </span><span class="koboSpan" id="kobo.706.2">In addition to this, we can utilize </span><strong class="bold"><span class="koboSpan" id="kobo.707.1">remote state backends</span></strong><span class="koboSpan" id="kobo.708.1"> to </span><a id="_idIndexMarker263"/><span class="koboSpan" id="kobo.709.1">store our state file securely and enable easier collaboration and disaster recovery as well. </span><span class="koboSpan" id="kobo.709.2">We will discuss this in more detail in the </span><em class="italic"><span class="koboSpan" id="kobo.710.1">Configuring a Terraform backend with state locking</span></em><span class="koboSpan" id="kobo.711.1"> section of </span><span class="No-Break"><span class="koboSpan" id="kobo.712.1">this chapter.</span></span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.713.1">Navigate to the </span><a id="_idIndexMarker264"/><span class="koboSpan" id="kobo.714.1">user home directory</span><a id="_idIndexMarker265"/><span class="koboSpan" id="kobo.715.1"> using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.716.1">cd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.717.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.718.1">cd ..</span></strong></pre></li> <li><span class="koboSpan" id="kobo.719.1">Finally, let’s delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">hello_terraform</span></strong><span class="koboSpan" id="kobo.721.1"> directory (and everything inside it) using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.722.1">rm -</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.723.1">rf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.724.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.725.1">rm -rf hello_terraform</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.726.1">This will help free up some space since we only have a total of 1 GB of storage available in our CloudShell environment (for each AWS region). </span><span class="koboSpan" id="kobo.726.2">Note that it’s recommended to run </span><strong class="source-inline"><span class="koboSpan" id="kobo.727.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.728.1"> first inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.729.1">hello_terraform</span></strong><span class="koboSpan" id="kobo.730.1"> directory before performing these types of deletion or cleanup steps (as we might accidentally delete the state file). </span><span class="koboSpan" id="kobo.730.2">Given that the only “infrastructure resource” we created is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.731.1">.txt</span></strong><span class="koboSpan" id="kobo.732.1"> file, there’s no need to run </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.733.1">terraform destroy</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.734.1">.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.735.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.736.1">If you require a dedicated environment specifically for utilizing Terraform in creating and managing infrastructure resources, you can explore </span><strong class="bold"><span class="koboSpan" id="kobo.737.1">AWS Cloud9</span></strong><span class="koboSpan" id="kobo.738.1"> and set up a development environment. </span><span class="koboSpan" id="kobo.738.2">This environment offers </span><a id="_idIndexMarker266"/><span class="koboSpan" id="kobo.739.1">more disk space compared to CloudShell (currently at 1 GB only for each AWS region). </span><span class="koboSpan" id="kobo.739.2">Additionally, Cloud9 enables you to utilize a code editor for writing and modifying code, offering enhanced flexibility and convenience. </span><span class="koboSpan" id="kobo.739.3">It’s important to note that while AWS CloudShell</span><a id="_idIndexMarker267"/><span class="koboSpan" id="kobo.740.1"> is a free service provided by AWS, AWS Cloud9 may incur additional costs depending on your usage. </span><span class="koboSpan" id="kobo.740.2">While CloudShell offers a limited disk space of 1 GB, it is available at no extra charge. </span><span class="koboSpan" id="kobo.740.3">On the other hand, AWS Cloud9 may have associated costs based on usage and the instance type selected for the environment. </span><span class="koboSpan" id="kobo.740.4">Before opting for AWS Cloud9, it is advisable to review the pricing details and ensure that it aligns with your requirements </span><span class="No-Break"><span class="koboSpan" id="kobo.741.1">and budget.</span></span></p>
<p><em class="italic"><span class="koboSpan" id="kobo.742.1">Wasn’t that easy?</span></em><span class="koboSpan" id="kobo.743.1"> When learning Terraform (or any other new tool), it’s a good idea to start with simple and small examples similar to what we worked on in this section. </span><span class="koboSpan" id="kobo.743.2">In the next section, we’ll build on top of this simple example and work on a relatively longer Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.744.1">configuration file.</span></span></p>
<h1 id="_idParaDest-49"><a id="_idTextAnchor048"/><span class="koboSpan" id="kobo.745.1">Understanding the Terraform configuration language</span></h1>
<p><span class="koboSpan" id="kobo.746.1">In this section, we will dive into the core aspects of Terraform’s configuration language and then proceed with working with relatively simple configuration code to equip us with the foundational knowledge needed to manage IaC </span><span class="No-Break"><span class="koboSpan" id="kobo.747.1">with Terraform.</span></span></p>
<h2 id="_idParaDest-50"><a id="_idTextAnchor049"/><span class="koboSpan" id="kobo.748.1">Demystifying commonly used Terraform configuration blocks</span></h2>
<p><span class="koboSpan" id="kobo.749.1">Understanding how to write and </span><a id="_idIndexMarker268"/><span class="koboSpan" id="kobo.750.1">interpret Terraform configuration code is </span><a id="_idIndexMarker269"/><span class="koboSpan" id="kobo.751.1">essential for effective infrastructure management. </span><span class="koboSpan" id="kobo.751.2">This knowledge allows us to customize and modify existing infrastructure resources created and managed using Terraform. </span><span class="koboSpan" id="kobo.751.3">It also enables us to troubleshoot issues more effectively and save time when resolving errors and blockers while using the </span><span class="No-Break"><span class="koboSpan" id="kobo.752.1">IaC tool.</span></span></p>
<p><em class="italic"><span class="koboSpan" id="kobo.753.1">So, where do we start?</span></em><span class="koboSpan" id="kobo.754.1"> For one thing, simple and complex Terraform configuration code generally makes use of the same set of elements and building blocks. </span><span class="koboSpan" id="kobo.754.2">This common foundation allows us to gradually build our understanding by starting with simple configurations and gradually progressing toward more complex scenarios. </span><span class="koboSpan" id="kobo.754.3">By mastering the fundamental elements, we can confidently navigate and interpret both simple and complex Terraform configuration code, enabling us to tackle a wide range of infrastructure management </span><a id="_idIndexMarker270"/><span class="No-Break"><span class="koboSpan" id="kobo.755.1">challenges effectively.</span></span></p>
<p><span class="koboSpan" id="kobo.756.1">Before we work on the next hands-on example, let’s have a quick look at some of the elements we would generally see in a Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.757.1">configuration file:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.758.1">Resources</span></strong><span class="koboSpan" id="kobo.759.1">—These are</span><a id="_idIndexMarker271"/><span class="koboSpan" id="kobo.760.1"> code blocks used to define how infrastructure resources would be provisioned and configured. </span><span class="koboSpan" id="kobo.760.2">These blocks have the </span><span class="No-Break"><span class="koboSpan" id="kobo.761.1">following structure:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.762.1">resource</span></strong><span class="koboSpan" id="kobo.763.1"> "&lt;type&gt;" "&lt;name&gt;" {
  &lt;argument 01&gt; = &lt;value 01&gt;
  &lt;argument 02&gt; = &lt;value 02&gt;
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.764.1">A resource is configured using one or more arguments, where each argument is represented by a key-value pair. </span><span class="koboSpan" id="kobo.764.2">Depending on the specific resource being created, the arguments could include things such as region, instance type, subnet ID, and security groups, </span><span class="No-Break"><span class="koboSpan" id="kobo.765.1">among others.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.766.1">Let’s look at a quick example of how to define a resource block for an Azure public IP address </span><span class="No-Break"><span class="koboSpan" id="kobo.767.1">using Terraform:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.768.1">resource</span></strong><span class="koboSpan" id="kobo.769.1"> "azurerm_public_ip" "public_ip_03" {
  </span><strong class="bold"><span class="koboSpan" id="kobo.770.1">name</span></strong><span class="koboSpan" id="kobo.771.1">                = "public-ip-03"
  ...
</span><span class="koboSpan" id="kobo.771.2">  </span><strong class="bold"><span class="koboSpan" id="kobo.772.1">resource_group_name</span></strong><span class="koboSpan" id="kobo.773.1"> = local.rg_02.name
  </span><strong class="bold"><span class="koboSpan" id="kobo.774.1">allocation_method</span></strong><span class="koboSpan" id="kobo.775.1">   = "Dynamic"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.776.1">Here, we specify </span><a id="_idIndexMarker272"/><span class="koboSpan" id="kobo.777.1">various attributes, such as the resource group name obtained from a local variable, along with the allocation method set </span><span class="No-Break"><span class="koboSpan" id="kobo.778.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.779.1">"Dynamic"</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.780.1">.</span></span></p></li> <li><strong class="bold"><span class="koboSpan" id="kobo.781.1">Providers</span></strong><span class="koboSpan" id="kobo.782.1">—These are</span><a id="_idIndexMarker273"/><span class="koboSpan" id="kobo.783.1"> plugins that enable cloud</span><a id="_idIndexMarker274"/><span class="koboSpan" id="kobo.784.1"> platform and SaaS API interactions. </span><span class="koboSpan" id="kobo.784.2">These blocks have the </span><span class="No-Break"><span class="koboSpan" id="kobo.785.1">following structure:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.786.1">provider</span></strong><span class="koboSpan" id="kobo.787.1"> "&lt;name&gt;" {
  &lt;argument 01&gt; = &lt;value 01&gt;
  &lt;argument 02&gt; = &lt;value 02&gt;
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.788.1">Providers can include </span><strong class="bold"><span class="koboSpan" id="kobo.789.1">cloud service providers</span></strong><span class="koboSpan" id="kobo.790.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.791.1">CSPs</span></strong><span class="koboSpan" id="kobo.792.1">) such </span><a id="_idIndexMarker275"/><span class="koboSpan" id="kobo.793.1">as AWS, Azure, and GCP, as well as other third-party providers. </span><span class="koboSpan" id="kobo.793.2">Depending on the specific provider being used, the arguments could include things such as access keys, region, and endpoints, </span><span class="No-Break"><span class="koboSpan" id="kobo.794.1">among others.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.795.1">Let’s look at a quick example of how to define </span><span class="No-Break"><span class="koboSpan" id="kobo.796.1">a provider:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.797.1">provider "aws" {
  alias  = "default"
  region = "us-east-1"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.798.1">By configuring this provider with the appropriate region, Terraform will be able to interact with AWS services within the specified region for resource provisioning </span><span class="No-Break"><span class="koboSpan" id="kobo.799.1">and management.</span></span></p></li> <li><strong class="bold"><span class="koboSpan" id="kobo.800.1">Data sources</span></strong><span class="koboSpan" id="kobo.801.1">—These are</span><a id="_idIndexMarker276"/><span class="koboSpan" id="kobo.802.1"> elements that allow us to query data at runtime. </span><span class="koboSpan" id="kobo.802.2">These blocks have the </span><span class="No-Break"><span class="koboSpan" id="kobo.803.1">following structure:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.804.1">data</span></strong><span class="koboSpan" id="kobo.805.1"> "&lt;type&gt;" "&lt;name&gt;" {
  ...
</span><span class="koboSpan" id="kobo.805.2">}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.806.1">The configuration for the data source depends on the specific data source being used and can include things such as queries, filters, and </span><span class="No-Break"><span class="koboSpan" id="kobo.807.1">authentication information.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.808.1">Let’s look at a quick example of how to define a </span><span class="No-Break"><span class="koboSpan" id="kobo.809.1">data source:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.810.1">data "</span><strong class="bold"><span class="koboSpan" id="kobo.811.1">aws_ip_ranges</span></strong><span class="koboSpan" id="kobo.812.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.813.1">ec2_instance_connect</span></strong><span class="koboSpan" id="kobo.814.1">" {
  regions  = ["us-east-1"]
  services = ["EC2_INSTANCE_CONNECT"]
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.815.1">With this data block, we can retrieve information about the IP ranges used by the AWS EC2 Instance Connect service in the </span><span class="No-Break"><span class="koboSpan" id="kobo.816.1">specified region.</span></span></p></li> <li><strong class="bold"><span class="koboSpan" id="kobo.817.1">Local values</span></strong><span class="koboSpan" id="kobo.818.1">—These are</span><a id="_idIndexMarker277"/><span class="koboSpan" id="kobo.819.1"> code blocks that allow us to </span><a id="_idIndexMarker278"/><span class="koboSpan" id="kobo.820.1">assign and store static values for later use. </span><span class="koboSpan" id="kobo.820.2">These blocks have the </span><span class="No-Break"><span class="koboSpan" id="kobo.821.1">following structure:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.822.1">locals</span></strong><span class="koboSpan" id="kobo.823.1"> {
  &lt;name 01&gt; = &lt;expression 01&gt;
  &lt;name 02&gt; = &lt;expression 02&gt;
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.824.1">The expressions can be any valid Terraform expression, including other variables or functions. </span><span class="koboSpan" id="kobo.824.2">Using this code block, we can easily define local variables in our Terraform configuration to make our code more readable, maintainable, </span><span class="No-Break"><span class="koboSpan" id="kobo.825.1">and reusable.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.826.1">Let’s look at an example of how to define a few </span><span class="No-Break"><span class="koboSpan" id="kobo.827.1">local variables:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.828.1">locals {
  </span><strong class="bold"><span class="koboSpan" id="kobo.829.1">net_01</span></strong><span class="koboSpan" id="kobo.830.1"> = google_compute_network.vpc_01.self_link
  </span><strong class="bold"><span class="koboSpan" id="kobo.831.1">net_02</span></strong><span class="koboSpan" id="kobo.832.1"> = google_compute_network.vpc_02.self_link
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.833.1">Here, we simply </span><a id="_idIndexMarker279"/><span class="koboSpan" id="kobo.834.1">define two local variables (</span><strong class="source-inline"><span class="koboSpan" id="kobo.835.1">net_01</span></strong><span class="koboSpan" id="kobo.836.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.837.1">net_02</span></strong><span class="koboSpan" id="kobo.838.1">) with values equal to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.839.1">self_link</span></strong><span class="koboSpan" id="kobo.840.1"> attribute values of the corresponding </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.841.1">google_compute_network</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.842.1"> resources.</span></span></p></li> <li><strong class="bold"><span class="koboSpan" id="kobo.843.1">Input variables</span></strong><span class="koboSpan" id="kobo.844.1">—These are</span><a id="_idIndexMarker280"/><span class="koboSpan" id="kobo.845.1"> code blocks that allow users to specify dynamic values. </span><span class="koboSpan" id="kobo.845.2">These blocks have the </span><span class="No-Break"><span class="koboSpan" id="kobo.846.1">following structure:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.847.1">variable</span></strong><span class="koboSpan" id="kobo.848.1"> "&lt;name&gt;" {
  type = &lt;type&gt;
  default = &lt;value&gt;
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.849.1">Variables in Terraform are used to parameterize the configuration, allowing code to be reused in different scenarios </span><span class="No-Break"><span class="koboSpan" id="kobo.850.1">or environments.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.851.1">Let’s look at a quick</span><a id="_idIndexMarker281"/><span class="koboSpan" id="kobo.852.1"> example of how to define </span><span class="No-Break"><span class="koboSpan" id="kobo.853.1">a variable:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.854.1">variable</span></strong><span class="koboSpan" id="kobo.855.1"> "</span><strong class="bold"><span class="koboSpan" id="kobo.856.1">instance_name</span></strong><span class="koboSpan" id="kobo.857.1">" {
    type = string
    default = "kali"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.858.1">This variable can be utilized within the Terraform configuration to dynamically customize the instance name based on </span><span class="No-Break"><span class="koboSpan" id="kobo.859.1">specific requirements.</span></span></p></li> <li><strong class="bold"><span class="koboSpan" id="kobo.860.1">Output values</span></strong><span class="koboSpan" id="kobo.861.1">—These </span><a id="_idIndexMarker282"/><span class="koboSpan" id="kobo.862.1">help return and print values as well as share values across modules. </span><span class="koboSpan" id="kobo.862.2">These blocks have the </span><span class="No-Break"><span class="koboSpan" id="kobo.863.1">following structure:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.864.1">output</span></strong><span class="koboSpan" id="kobo.865.1"> "&lt;name&gt;" {
  value = &lt;expression&gt;
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.866.1">Outputs in</span><a id="_idIndexMarker283"/><span class="koboSpan" id="kobo.867.1"> Terraform are used to define values that are exposed to the user after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.868.1">terraform apply</span></strong><span class="koboSpan" id="kobo.869.1"> operation is complete. </span><span class="koboSpan" id="kobo.869.2">The output can then be referenced in other parts of the configuration or in other configurations that use the current module as </span><span class="No-Break"><span class="koboSpan" id="kobo.870.1">a dependency.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.871.1">Let’s look at a quick example of this </span><span class="No-Break"><span class="koboSpan" id="kobo.872.1">in action:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.873.1">output</span></strong><span class="koboSpan" id="kobo.874.1"> "</span><strong class="bold"><span class="koboSpan" id="kobo.875.1">vm_kali_public_ip</span></strong><span class="koboSpan" id="kobo.876.1">" {
  value = local.vm_kali.public_ip_address
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.877.1">Here, we simply define an output block to retrieve the public IP address of a virtual machine (</span><span class="No-Break"><span class="koboSpan" id="kobo.878.1">in Azure).</span></span></p></li> </ul>
<p><span class="koboSpan" id="kobo.879.1">While there are certainly more Terraform elements to consider, the ones we’ve discussed should be enough for the time being. </span><span class="koboSpan" id="kobo.879.2">As you continue your Terraform journey, you can explore additional elements to expand your repertoire for managing infrastructure. </span><span class="koboSpan" id="kobo.879.3">Building upon the foundation we have established already, these elements will further enhance our ability to create various penetration testing labs in the cloud </span><span class="No-Break"><span class="koboSpan" id="kobo.880.1">using Terraform.</span></span></p>
<h2 id="_idParaDest-51"><a id="_idTextAnchor050"/><span class="koboSpan" id="kobo.881.1">Working with simple Terraform configurations</span></h2>
<p><span class="koboSpan" id="kobo.882.1">Now that we have </span><a id="_idIndexMarker284"/><span class="koboSpan" id="kobo.883.1">a good idea of which blocks of code to expect in a Terraform </span><a id="_idIndexMarker285"/><span class="koboSpan" id="kobo.884.1">configuration file, let’s proceed with the </span><span class="No-Break"><span class="koboSpan" id="kobo.885.1">next example:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.886.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.887.1">basics</span></strong><span class="koboSpan" id="kobo.888.1"> directory using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.889.1">mkdir</span></strong><span class="koboSpan" id="kobo.890.1"> command. </span><span class="koboSpan" id="kobo.890.2">Navigate to the directory created using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.891.1">cd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.892.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.893.1">mkdir basics &amp;&amp; cd basics</span></strong></pre></li> <li><span class="koboSpan" id="kobo.894.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.895.1">touch</span></strong><span class="koboSpan" id="kobo.896.1"> command to create an empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.897.1">main.tf</span></strong><span class="koboSpan" id="kobo.898.1"> file inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.899.1">basics</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.900.1"> directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.901.1">touch main.tf</span></strong></pre></li> <li><span class="koboSpan" id="kobo.902.1">Run the following command to open the empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.903.1">main.tf</span></strong><span class="koboSpan" id="kobo.904.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.905.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.906.1">vim main.tf</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.907.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.908.1">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.909.1">:set nu</span></strong><span class="koboSpan" id="kobo.910.1"> and then press the </span><em class="italic"><span class="koboSpan" id="kobo.911.1">Enter</span></em><span class="koboSpan" id="kobo.912.1"> key to show the </span><span class="No-Break"><span class="koboSpan" id="kobo.913.1">line numbers.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.914.1">Next, press </span><em class="italic"><span class="koboSpan" id="kobo.915.1">i</span></em><span class="koboSpan" id="kobo.916.1"> to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.917.1">insert mode</span></strong><span class="koboSpan" id="kobo.918.1"> so that we can edit </span><span class="No-Break"><span class="koboSpan" id="kobo.919.1">the file.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.920.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.921.1">At this point, you should have a better idea of how to use Vim. </span><span class="koboSpan" id="kobo.921.2">To switch to insert mode (assuming we’re currently in normal mode), simply press the </span><em class="italic"><span class="koboSpan" id="kobo.922.1">i</span></em><span class="koboSpan" id="kobo.923.1"> key. </span><span class="koboSpan" id="kobo.923.2">Then, to switch to normal mode, press the </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.924.1">Esc</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.925.1"> key.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.926.1">Let’s</span><a id="_idIndexMarker286"/><span class="koboSpan" id="kobo.927.1"> start by declaring and configuring the AWS provider by</span><a id="_idIndexMarker287"/><span class="koboSpan" id="kobo.928.1"> typing (or pasting) the following block of code into our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.929.1">main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.930.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.931.1">
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~&gt; 4.0"
    }
  }
}
provider "aws" {
  alias  = "default"
  region = "us-east-1"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.932.1">With this code block, Terraform is able to locate and use the required AWS provider for the specified version and source to provision and manage AWS resources in the specified </span><span class="No-Break"><span class="koboSpan" id="kobo.933.1">region (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.934.1">us-east-1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.935.1">).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.936.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.937.1">Note that Terraform would automatically use the credentials configured in the </span><span class="No-Break"><span class="koboSpan" id="kobo.938.1">CloudShell environment.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.939.1">Next, add</span><a id="_idIndexMarker288"/><span class="koboSpan" id="kobo.940.1"> the following</span><a id="_idIndexMarker289"/><span class="koboSpan" id="kobo.941.1"> code </span><span class="No-Break"><span class="koboSpan" id="kobo.942.1">as well:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.943.1">data</span></strong><span class="koboSpan" id="kobo.944.1"> "</span><strong class="bold"><span class="koboSpan" id="kobo.945.1">aws_canonical_user_id</span></strong><span class="koboSpan" id="kobo.946.1">" "current" {}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.947.1">This would give us </span><a id="_idIndexMarker290"/><span class="koboSpan" id="kobo.948.1">access to the AWS canonical user ID (which is an alphanumeric value used when granting access to S3 buckets and objects) of the account used to </span><span class="No-Break"><span class="koboSpan" id="kobo.949.1">run Terraform.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.950.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.951.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.952.1">AWS canonical user ID</span></strong><span class="koboSpan" id="kobo.953.1"> (that is, the “obfuscated form” of the AWS account ID) is primarily used for operations </span><a id="_idIndexMarker291"/><span class="koboSpan" id="kobo.954.1">related to object-level access control in Amazon S3. </span><span class="koboSpan" id="kobo.954.2">When granting access permissions to S3 objects or buckets, this ID is used to specify who has the necessary permissions. </span><span class="koboSpan" id="kobo.954.3">Note that the AWS canonical user ID is different from the AWS account ID, which is a 12-digit number associated with each AWS account. </span><span class="koboSpan" id="kobo.954.4">For </span><a id="_idIndexMarker292"/><span class="koboSpan" id="kobo.955.1">more information, feel free to check the following </span><span class="No-Break"><span class="koboSpan" id="kobo.956.1">link: </span></span><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/finding-canonical-user-id.html"><span class="No-Break"><span class="koboSpan" id="kobo.957.1">https://docs.aws.amazon.com/AmazonS3/latest/userguide/finding-canonical-user-id.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.958.1">.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.959.1">Let’s also declare a few local variables, </span><span class="No-Break"><span class="koboSpan" id="kobo.960.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.961.1">
locals {
  user = data.aws_canonical_user_id.current
  name = local.user.display_name
}</span></pre></li> <li><span class="koboSpan" id="kobo.962.1">Finally, let’s </span><a id="_idIndexMarker293"/><span class="koboSpan" id="kobo.963.1">add the following code, which prints the </span><strong class="source-inline"><span class="koboSpan" id="kobo.964.1">display_name</span></strong><span class="koboSpan" id="kobo.965.1"> value of the canonical user ID of the AWS account we </span><span class="No-Break"><span class="koboSpan" id="kobo.966.1">are using:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.967.1">
resource "null_resource" "debug" {
  provisioner "local-exec" {
    command = "echo NAME=${local.name}"
  }
}</span></pre></li> <li><span class="koboSpan" id="kobo.968.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.969.1">Esc</span></em><span class="koboSpan" id="kobo.970.1"> key to</span><a id="_idIndexMarker294"/><span class="koboSpan" id="kobo.971.1"> switch back to normal mode. </span><span class="koboSpan" id="kobo.971.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.972.1">:wq!</span></strong><span class="koboSpan" id="kobo.973.1"> and then press </span><em class="italic"><span class="koboSpan" id="kobo.974.1">Enter</span></em><span class="koboSpan" id="kobo.975.1">. </span><span class="koboSpan" id="kobo.975.2">This will save the changes made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.976.1">main.tf</span></strong><span class="koboSpan" id="kobo.977.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.978.1">as well.</span></span></li>
<li><span class="koboSpan" id="kobo.979.1">Now that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.980.1">main.tf</span></strong><span class="koboSpan" id="kobo.981.1"> file is ready, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.982.1">terraform init</span></strong><span class="koboSpan" id="kobo.983.1"> command to initialize the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.984.1">working directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.985.1">terraform init</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.986.1">This should yield a set of logs similar to what is shown in the following set of </span><span class="No-Break"><span class="koboSpan" id="kobo.987.1">log messages:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.988.1">Initializing the backend...
</span><span class="koboSpan" id="kobo.988.2">Initializing provider plugins...
</span><span class="koboSpan" id="kobo.988.3">- Finding hashicorp/aws versions matching "~&gt; 4.0"...
</span><span class="koboSpan" id="kobo.988.4">- Finding latest version of hashicorp/null...
</span><span class="koboSpan" id="kobo.988.5">- Installing hashicorp/null v3.2.1...
</span><span class="koboSpan" id="kobo.988.6">- Installed hashicorp/null v3.2.1 (signed by HashiCorp)
- Installing hashicorp/aws v4.57.0...
</span><span class="koboSpan" id="kobo.988.7">- Installed hashicorp/aws v4.57.0 (signed by HashiCorp)</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.989.1">Here, we can see that the relevant files and binaries have been downloaded from the </span><span class="No-Break"><span class="koboSpan" id="kobo.990.1">Terraform Registry.</span></span></p></li> <li><span class="koboSpan" id="kobo.991.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.992.1">terraform plan</span></strong><span class="koboSpan" id="kobo.993.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.994.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.995.1">terraform plan</span></strong></pre></li> <li><span class="koboSpan" id="kobo.996.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.997.1">terraform apply</span></strong><span class="koboSpan" id="kobo.998.1"> command to implement the changes specified in the execution plan returned after running </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.999.1">terraform plan</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1000.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1001.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1002.1">Note that this time, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1003.1">-auto-approve</span></strong><span class="koboSpan" id="kobo.1004.1"> flag to skip the verification step, similar to what we encountered in the last section. </span><span class="koboSpan" id="kobo.1004.2">Running the command should yield</span><a id="_idIndexMarker295"/><span class="koboSpan" id="kobo.1005.1"> the </span><span class="No-Break"><span class="koboSpan" id="kobo.1006.1">following</span></span><span class="No-Break"><a id="_idIndexMarker296"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1007.1"> output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1008.1">Plan: 1 to add, 0 to change, 0 to destroy.
</span><span class="koboSpan" id="kobo.1008.2">null_resource.debug: Creating...
</span><span class="koboSpan" id="kobo.1008.3">null_resource.debug: Provisioning with 'local-exec'...
</span><span class="koboSpan" id="kobo.1008.4">null_resource.debug (local-exec): Executing: ["/bin/sh" "-c" "echo NAME=john.doe"]
null_resource.debug (local-exec): </span><strong class="bold"><span class="koboSpan" id="kobo.1009.1">NAME=john.doe</span></strong><span class="koboSpan" id="kobo.1010.1">
null_resource.debug: Creation complete after 0s [id=6076855428035859265]</span></pre><p class="list-inset"><em class="italic"><span class="koboSpan" id="kobo.1011.1">What happened here?</span></em><span class="koboSpan" id="kobo.1012.1"> The code simply executed a command that printed the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1013.1">name</span></strong><span class="koboSpan" id="kobo.1014.1"> local value (that is, the display name of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1015.1">canonical user).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1016.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1017.1">We can see that when using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1018.1">terraform apply -auto-approve</span></strong><span class="koboSpan" id="kobo.1019.1"> command, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1020.1">-auto-approve</span></strong><span class="koboSpan" id="kobo.1021.1"> flag allows for automatic approval and execution of planned changes without user confirmation. </span><span class="koboSpan" id="kobo.1021.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1022.1">-auto-approve</span></strong><span class="koboSpan" id="kobo.1023.1"> flag is valuable in non-interactive or automated scenarios as it eliminates the need for manual intervention. </span><span class="koboSpan" id="kobo.1023.2">However, it is important to exercise caution when utilizing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1024.1">-auto-approve</span></strong><span class="koboSpan" id="kobo.1025.1"> flag as it bypasses confirmation prompts, and changes are immediately applied. </span><span class="koboSpan" id="kobo.1025.2">Thoroughly reviewing Terraform code and changes prior to running </span><strong class="source-inline"><span class="koboSpan" id="kobo.1026.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1027.1"> with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1028.1">-auto-approve</span></strong><span class="koboSpan" id="kobo.1029.1"> is crucial to prevent unintended modifications </span><span class="No-Break"><span class="koboSpan" id="kobo.1030.1">to infrastructure.</span></span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.1031.1">Now, let’s perform a minor modification to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1032.1">main.tf</span></strong><span class="koboSpan" id="kobo.1033.1"> file. </span><span class="koboSpan" id="kobo.1033.2">Run the following command again to open the empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.1034.1">main.tf</span></strong><span class="koboSpan" id="kobo.1035.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1036.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1037.1">vim main.tf</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1038.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1039.1">You may type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1040.1">:set nu</span></strong><span class="koboSpan" id="kobo.1041.1"> and then press the </span><em class="italic"><span class="koboSpan" id="kobo.1042.1">Enter</span></em><span class="koboSpan" id="kobo.1043.1"> key to show the </span><span class="No-Break"><span class="koboSpan" id="kobo.1044.1">line numbers.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.1045.1">Next, press </span><em class="italic"><span class="koboSpan" id="kobo.1046.1">i</span></em><span class="koboSpan" id="kobo.1047.1"> to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.1048.1">insert mode</span></strong><span class="koboSpan" id="kobo.1049.1"> so that we can edit </span><span class="No-Break"><span class="koboSpan" id="kobo.1050.1">the file.</span></span></li>
<li><span class="koboSpan" id="kobo.1051.1">Locate the</span><a id="_idIndexMarker297"/><span class="koboSpan" id="kobo.1052.1"> following line </span><a id="_idIndexMarker298"/><span class="koboSpan" id="kobo.1053.1">using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1054.1">arrow keys:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1055.1">
command = "echo </span><strong class="bold"><span class="koboSpan" id="kobo.1056.1">NAME</span></strong><span class="koboSpan" id="kobo.1057.1">=${local.</span><strong class="bold"><span class="koboSpan" id="kobo.1058.1">name</span></strong><span class="koboSpan" id="kobo.1059.1">}"</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1060.1">Once you’ve located the line in the previous code block, replace it </span><span class="No-Break"><span class="koboSpan" id="kobo.1061.1">with this:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1062.1">command = "echo </span><strong class="bold"><span class="koboSpan" id="kobo.1063.1">ID</span></strong><span class="koboSpan" id="kobo.1064.1">=${local.</span><strong class="bold"><span class="koboSpan" id="kobo.1065.1">user.id</span></strong><span class="koboSpan" id="kobo.1066.1">}"</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1067.1">Here, we are planning to log and print the ID (instead of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1068.1">display_name</span></strong><span class="koboSpan" id="kobo.1069.1"> value) once when we run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1070.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1071.1"> command in a </span><span class="No-Break"><span class="koboSpan" id="kobo.1072.1">later step.</span></span></p></li> <li><span class="koboSpan" id="kobo.1073.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.1074.1">Esc</span></em><span class="koboSpan" id="kobo.1075.1"> key to switch back to normal mode. </span><span class="koboSpan" id="kobo.1075.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1076.1">:wq!</span></strong><span class="koboSpan" id="kobo.1077.1"> and then press </span><em class="italic"><span class="koboSpan" id="kobo.1078.1">Enter</span></em><span class="koboSpan" id="kobo.1079.1">. </span><span class="koboSpan" id="kobo.1079.2">This will save the changes made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1080.1">main.tf</span></strong><span class="koboSpan" id="kobo.1081.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.1082.1">as well.</span></span></li>
<li><span class="koboSpan" id="kobo.1083.1">Before running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1084.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1085.1"> command, let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1086.1">terraform fmt</span></strong><span class="koboSpan" id="kobo.1087.1"> to format our </span><span class="No-Break"><span class="koboSpan" id="kobo.1088.1">Terraform code:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1089.1">terraform fmt</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1090.1">Here, we are using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1091.1">terraform fmt</span></strong><span class="koboSpan" id="kobo.1092.1"> to ensure a consistent coding style across all Terraform configuration files. </span><span class="koboSpan" id="kobo.1092.2">This command scans the Terraform configuration files, adjusting indentation, spacing, and line breaks to match the official Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.1093.1">style guide.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1094.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1095.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1096.1">terraform fmt</span></strong><span class="koboSpan" id="kobo.1097.1"> command automatically adjusts the indentation of blocks, statements, and expressions to ensure consistent alignment. </span><span class="koboSpan" id="kobo.1097.2">It typically uses two spaces for each level of indentation. </span><span class="koboSpan" id="kobo.1097.3">In addition to this, the command adds or removes spaces to maintain consistent spacing around operators, colons, commas, and other elements. </span><span class="koboSpan" id="kobo.1097.4">For example, it ensures spaces are present before and after equals signs in variable assignments. </span><span class="koboSpan" id="kobo.1097.5">Similarly, it inserts or removes line breaks to improve readability by introducing line breaks between resource blocks or variable declarations to make the code more visually structured. </span><span class="koboSpan" id="kobo.1097.6">There are a few more formatting tweaks that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1098.1">terraform fmt</span></strong><span class="koboSpan" id="kobo.1099.1"> applies, but these should do the trick </span><span class="No-Break"><span class="koboSpan" id="kobo.1100.1">for now.</span></span></p>
<ol>
<li value="18"><span class="koboSpan" id="kobo.1101.1">Now, let’s </span><a id="_idIndexMarker299"/><span class="koboSpan" id="kobo.1102.1">run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1103.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1104.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1105.1">by</span></span><span class="No-Break"><a id="_idIndexMarker300"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1106.1"> Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1107.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1108.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.1109.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1110.1">No changes. </span><span class="koboSpan" id="kobo.1110.2">Your infrastructure matches the configuration.
</span><span class="koboSpan" id="kobo.1110.3">Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed.</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1111.1">It seems that changes are not detected when provisioner commands have </span><span class="No-Break"><span class="koboSpan" id="kobo.1112.1">been altered!</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1113.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1114.1">Here, Terraform is supposed to detect changes when altering provisioner commands within a resource block. </span><span class="koboSpan" id="kobo.1114.2">However, in certain cases, modifications to provisioner commands may not be recognized as modifications by the IaC tool. </span><span class="koboSpan" id="kobo.1114.3">Consequently, Terraform may not execute the updated provisioner commands, potentially leading to inconsistencies in the deployed infrastructure. </span><span class="koboSpan" id="kobo.1114.4">For more information about this topic, feel free to check out the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1115.1">link: </span></span><a href="https://github.com/hashicorp/terraform/issues/14405"><span class="No-Break"><span class="koboSpan" id="kobo.1116.1">https://github.com/hashicorp/terraform/issues/14405</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1117.1">.</span></span></p>
<ol>
<li value="19"><span class="koboSpan" id="kobo.1118.1">To force the</span><a id="_idIndexMarker301"/><span class="koboSpan" id="kobo.1119.1"> replacement of the resource(s) created, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1120.1">-replace</span></strong><span class="koboSpan" id="kobo.1121.1"> flag while</span><a id="_idIndexMarker302"/><span class="koboSpan" id="kobo.1122.1"> running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1123.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1124.1">apply</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1125.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1126.1">terraform apply -auto-approve \</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1127.1">-replace=null_resource.debug</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1128.1">This should yield the following set </span><span class="No-Break"><span class="koboSpan" id="kobo.1129.1">of logs:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1130.1">null_resource.debug: Destroying... </span><span class="koboSpan" id="kobo.1130.2">[id=6076855428035859265]
null_resource.debug: Destruction complete after 0s
null_resource.debug: Creating...
</span><span class="koboSpan" id="kobo.1130.3">null_resource.debug: Provisioning with 'local-exec'...
</span><span class="koboSpan" id="kobo.1130.4">null_resource.debug (local-exec): Executing: ["/bin/sh" "-c" "echo ID=abcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh"]
null_resource.debug (local-exec): </span><strong class="bold"><span class="koboSpan" id="kobo.1131.1">ID=abcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh</span></strong><span class="koboSpan" id="kobo.1132.1">
null_resource.debug: Creation complete after 0s [id=9009508010716198837]</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1133.1">Here, we can see that the ID value has been logged after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1134.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1135.1">apply</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1136.1"> command.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1137.1">Note</span></p>
<p class="callout"><em class="italic"><span class="koboSpan" id="kobo.1138.1">What happened here?</span></em><span class="koboSpan" id="kobo.1139.1"> Here, we instructed Terraform to automatically apply changes without user confirmation, while specifically replacing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1140.1">null_resource.debug</span></strong><span class="koboSpan" id="kobo.1141.1"> resource. </span><span class="koboSpan" id="kobo.1141.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1142.1">-replace=null_resource.debug</span></strong><span class="koboSpan" id="kobo.1143.1"> argument specifically targets the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1144.1">null_resource.debug</span></strong><span class="koboSpan" id="kobo.1145.1"> resource, indicating that it should be replaced during the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1146.1">apply</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1147.1"> operation.</span></span></p>
<ol>
<li value="20"><span class="koboSpan" id="kobo.1148.1">Navigate to the user home directory using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1149.1">cd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1150.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1151.1">cd ..</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1152.1">Finally, let’s delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1153.1">basics</span></strong><span class="koboSpan" id="kobo.1154.1"> directory (and everything inside it) using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1155.1">rm -</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1156.1">rf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1157.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1158.1">rm -rf basics</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1159.1">This will help free up some space since we need to manage the space available in our </span><a id="_idIndexMarker303"/><span class="No-Break"><span class="koboSpan" id="kobo.1160.1">CloudShell </span></span><span class="No-Break"><a id="_idIndexMarker304"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1161.1">environment.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.1162.1">Great work completing our second Terraform example! </span><span class="koboSpan" id="kobo.1162.2">At this point, we should have the confidence needed to work on more complex </span><span class="No-Break"><span class="koboSpan" id="kobo.1163.1">Terraform code.</span></span></p>
<h1 id="_idParaDest-52"><a id="_idTextAnchor051"/><span class="koboSpan" id="kobo.1164.1">Building our vulnerable lab environment with Terraform</span></h1>
<p><span class="koboSpan" id="kobo.1165.1">The previous sections of this </span><a id="_idIndexMarker305"/><span class="koboSpan" id="kobo.1166.1">chapter allowed us to have a </span><a id="_idIndexMarker306"/><span class="koboSpan" id="kobo.1167.1">better understanding of how Terraform works. </span><span class="koboSpan" id="kobo.1167.2">We worked with relatively simple examples, and it’s about time we worked on a relatively more complete and realistic example! </span><span class="koboSpan" id="kobo.1167.3">That said, we will now use Terraform to automatically create and configure the vulnerable lab environment we manually prepared in </span><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.1168.1">Chapter 2</span></a></em></span><span class="koboSpan" id="kobo.1169.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1170.1">Preparing Our First Vulnerable Cloud Lab Environment</span></em><span class="koboSpan" id="kobo.1171.1">. </span><span class="koboSpan" id="kobo.1171.2">By utilizing Terraform, we should be able to streamline the process of setting up the vulnerable lab environment that we previously </span><span class="No-Break"><span class="koboSpan" id="kobo.1172.1">prepared manually.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1173.1">Note</span></p>
<p class="callout"><em class="italic"><span class="koboSpan" id="kobo.1174.1">What happened again in </span></em><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.1175.1">Chapter 2</span></a></em></span><em class="italic"><span class="koboSpan" id="kobo.1176.1">?</span></em><span class="koboSpan" id="kobo.1177.1"> In </span><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.1178.1">Chapter 2</span></a></em></span><span class="koboSpan" id="kobo.1179.1">, we manually created an empty S3 bucket through the AWS Management Console and configured it for static website hosting. </span><span class="koboSpan" id="kobo.1179.2">We then modified the access control settings of the bucket to allow authenticated AWS users to list and retrieve objects. </span><span class="koboSpan" id="kobo.1179.3">To complete the setup, we uploaded sample files to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1180.1">S3 bucket.</span></span></p>
<p><span class="koboSpan" id="kobo.1181.1">That said, this</span><a id="_idIndexMarker307"/><span class="koboSpan" id="kobo.1182.1"> section is composed of four </span><a id="_idIndexMarker308"/><span class="koboSpan" id="kobo.1183.1">subparts, </span><span class="No-Break"><span class="koboSpan" id="kobo.1184.1">as follows:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.1185.1">Creating an S3 bucket </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1186.1">with Terraform</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1187.1">Updating the security configuration of the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1188.1">S3 bucket</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1189.1">Uploading files to the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1190.1">S3 bucket</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1191.1">Cleaning up and deleting the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1192.1">S3 bucket</span></em></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1193.1">Without further ado, </span><span class="No-Break"><span class="koboSpan" id="kobo.1194.1">let’s begin!</span></span></p>
<h2 id="_idParaDest-53"><a id="_idTextAnchor052"/><span class="koboSpan" id="kobo.1195.1">Part 1 of 4 – Creating an S3 bucket with Terraform</span></h2>
<p><span class="koboSpan" id="kobo.1196.1">Continuing where </span><a id="_idIndexMarker309"/><span class="koboSpan" id="kobo.1197.1">we left off in the previous section, let’s create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1198.1">basics</span></strong><span class="koboSpan" id="kobo.1199.1"> directory using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1200.1">mkdir</span></strong><span class="koboSpan" id="kobo.1201.1"> command, then proceed </span><span class="No-Break"><span class="koboSpan" id="kobo.1202.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1203.1">Navigate to the directory created using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1204.1">cd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1205.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1206.1">mkdir vulnerable_s3_lab</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1207.1">cd vulnerable_s3_lab</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1208.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1209.1">touch</span></strong><span class="koboSpan" id="kobo.1210.1"> command to create an empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.1211.1">main.tf</span></strong><span class="koboSpan" id="kobo.1212.1"> file inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1213.1">vulnerable_s3_lab</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1214.1"> directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1215.1">touch main.tf</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1216.1">Run the following command to open the empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.1217.1">main.tf</span></strong><span class="koboSpan" id="kobo.1218.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1219.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1220.1">vim main.tf</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1221.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1222.1">You may type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1223.1">:set nu</span></strong><span class="koboSpan" id="kobo.1224.1"> and then press the </span><em class="italic"><span class="koboSpan" id="kobo.1225.1">Enter</span></em><span class="koboSpan" id="kobo.1226.1"> key to show the </span><span class="No-Break"><span class="koboSpan" id="kobo.1227.1">line numbers.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1228.1">Next, press </span><em class="italic"><span class="koboSpan" id="kobo.1229.1">i</span></em><span class="koboSpan" id="kobo.1230.1"> to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.1231.1">insert mode</span></strong><span class="koboSpan" id="kobo.1232.1"> so that we can edit </span><span class="No-Break"><span class="koboSpan" id="kobo.1233.1">the file.</span></span></li>
<li><span class="koboSpan" id="kobo.1234.1">Type or </span><a id="_idIndexMarker310"/><span class="koboSpan" id="kobo.1235.1">paste the following block of code into our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1236.1">main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1237.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1238.1">
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~&gt; 4.0"
    }
  }
}
provider "aws" {
  alias  = "default"
  region = "us-east-1"
}</span></pre></li> <li><span class="koboSpan" id="kobo.1239.1">Next, let’s declare an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1240.1">aws_s3_bucket</span></strong><span class="koboSpan" id="kobo.1241.1"> resource by adding the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.1242.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1243.1">
resource "aws_s3_bucket" "bucket" {
  bucket = "</span><strong class="bold"><span class="koboSpan" id="kobo.1244.1">&lt;INSERT BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.1245.1">"
  force_destroy = true
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1246.1">Make </span><a id="_idIndexMarker311"/><span class="koboSpan" id="kobo.1247.1">sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1248.1">&lt;INSERT BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.1249.1"> with a bucket name that is globally unique across all AWS users. </span><span class="koboSpan" id="kobo.1249.2">If you are wondering what </span><strong class="source-inline"><span class="koboSpan" id="kobo.1250.1">force_destroy</span></strong><span class="koboSpan" id="kobo.1251.1"> does, it simply allows us to delete the S3 bucket along with all objects inside it without issues in a </span><span class="No-Break"><span class="koboSpan" id="kobo.1252.1">later step.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1253.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1254.1">For guidelines and rules on how to name S3 buckets, feel free to check out the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1255.1">link: </span></span><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html"><span class="No-Break"><span class="koboSpan" id="kobo.1256.1">https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1257.1">.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1258.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.1259.1">Esc</span></em><span class="koboSpan" id="kobo.1260.1"> key to switch back to normal mode. </span><span class="koboSpan" id="kobo.1260.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1261.1">:wq!</span></strong><span class="koboSpan" id="kobo.1262.1"> and then press </span><em class="italic"><span class="koboSpan" id="kobo.1263.1">Enter</span></em><span class="koboSpan" id="kobo.1264.1">. </span><span class="koboSpan" id="kobo.1264.2">This will save the changes made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1265.1">main.tf</span></strong><span class="koboSpan" id="kobo.1266.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.1267.1">as well.</span></span></li>
<li><span class="koboSpan" id="kobo.1268.1">Now that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1269.1">main.tf</span></strong><span class="koboSpan" id="kobo.1270.1"> file is ready, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1271.1">terraform init</span></strong><span class="koboSpan" id="kobo.1272.1"> command to initialize the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.1273.1">working directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1274.1">terraform init</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1275.1">Next, let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1276.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1277.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1278.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1279.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1280.1">This should yield a set of logs similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1281.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1282.1">.6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1283.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer054">
<span class="koboSpan" id="kobo.1284.1"><img alt="" src="image/B19755_03_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1285.1">Figure 3.6 – Logs generated after running the terraform plan command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1286.1">Here, we</span><a id="_idIndexMarker312"/><span class="koboSpan" id="kobo.1287.1"> can see that the values of some of the properties will only be known after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1288.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1289.1"> command is executed (that is, when the resource has </span><span class="No-Break"><span class="koboSpan" id="kobo.1290.1">been created).</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1291.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1292.1">Understanding that certain property values are determined only after executing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1293.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1294.1"> command is crucial. </span><span class="koboSpan" id="kobo.1294.2">This dynamic nature of property values allows Terraform to accurately reflect the state of resources once they </span><span class="No-Break"><span class="koboSpan" id="kobo.1295.1">are created.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1296.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1297.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1298.1"> command to implement the changes specified in the execution plan returned after running </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1299.1">terraform plan</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1300.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1301.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1302.1">This should yield a set of logs showing that we’ve successfully created the </span><span class="No-Break"><span class="koboSpan" id="kobo.1303.1">S3 bucket.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1304.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1305.1">Feel free to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1306.1">terraform show</span></strong><span class="koboSpan" id="kobo.1307.1"> to check the current configuration settings of our </span><span class="No-Break"><span class="koboSpan" id="kobo.1308.1">S3 bucket.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.1309.1">Before we celebrate, let’s run the following to verify that our S3 bucket has </span><span class="No-Break"><span class="koboSpan" id="kobo.1310.1">been created:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1311.1">
aws s3 ls | grep </span><strong class="bold"><span class="koboSpan" id="kobo.1312.1">&lt;INSERT BUCKET NAME&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1313.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1314.1">&lt;INSERT BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.1315.1"> with the bucket name specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1316.1">main.tf</span></strong><span class="koboSpan" id="kobo.1317.1"> file (from a previous step in this section). </span><span class="koboSpan" id="kobo.1317.2">This should yield an output with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1318.1">following format:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1319.1">&lt;DATE&gt;</span></strong> <strong class="bold"><span class="koboSpan" id="kobo.1320.1">&lt;TIME&gt;</span></strong> <strong class="bold"><span class="koboSpan" id="kobo.1321.1">&lt;INSERT BUCKET NAME&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1322.1">If the bucket name you specified is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1323.1">vuln-s3-abcdef-12345</span></strong><span class="koboSpan" id="kobo.1324.1">, we should get an output</span><a id="_idIndexMarker313"/><span class="koboSpan" id="kobo.1325.1"> with a format similar to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1326.1">2023-10-01 </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1327.1">12:00:00 vuln-s3-abcdef-12345</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1328.1">.</span></span></p></li> </ol>
<h2 id="_idParaDest-54"><a id="_idTextAnchor053"/><span class="koboSpan" id="kobo.1329.1">Part 2 of 4 – Updating the security configuration of the S3 bucket</span></h2>
<p><span class="koboSpan" id="kobo.1330.1">We’re just getting</span><a id="_idIndexMarker314"/><span class="koboSpan" id="kobo.1331.1"> started! </span><span class="koboSpan" id="kobo.1331.2">In the following steps, we’ll learn how to update the </span><span class="No-Break"><span class="koboSpan" id="kobo.1332.1">security configuration:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1333.1">Now, let’s run the following command to open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1334.1">main.tf</span></strong><span class="koboSpan" id="kobo.1335.1"> file again </span><span class="No-Break"><span class="koboSpan" id="kobo.1336.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1337.1">vim main.tf</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1338.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1339.1">You may type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1340.1">:set nu</span></strong><span class="koboSpan" id="kobo.1341.1"> and then press the </span><em class="italic"><span class="koboSpan" id="kobo.1342.1">Enter</span></em><span class="koboSpan" id="kobo.1343.1"> key to show the </span><span class="No-Break"><span class="koboSpan" id="kobo.1344.1">line numbers.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1345.1">Next, hold the </span><em class="italic"><span class="koboSpan" id="kobo.1346.1">Shift</span></em><span class="koboSpan" id="kobo.1347.1"> key and then press </span><em class="italic"><span class="koboSpan" id="kobo.1348.1">g</span></em><span class="koboSpan" id="kobo.1349.1"> to navigate to the last line. </span><span class="koboSpan" id="kobo.1349.2">Press </span><em class="italic"><span class="koboSpan" id="kobo.1350.1">o</span></em><span class="koboSpan" id="kobo.1351.1"> afterward. </span><span class="koboSpan" id="kobo.1351.2">This should insert a new line after the current line (along with switching to </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1352.1">insert mode</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1353.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.1354.1">Now that we’re in </span><a id="_idIndexMarker315"/><span class="koboSpan" id="kobo.1355.1">insert mode, let’s proceed by adding the following block of code to specify the public access block configuration for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1356.1">S3 bucket:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1357.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.1358.1">aws_s3_bucket_public_access_block</span></strong><span class="koboSpan" id="kobo.1359.1">" "bucket" {
  bucket = aws_s3_bucket.bucket.id
  block_public_acls       = false
  block_public_policy     = false
  ignore_public_acls      = false
  restrict_public_buckets = false
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1360.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1361.1">block_public_acls</span></strong><span class="koboSpan" id="kobo.1362.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1363.1">block_public_policy</span></strong><span class="koboSpan" id="kobo.1364.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1365.1">ignore_public_acls</span></strong><span class="koboSpan" id="kobo.1366.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1367.1">restrict_public_buckets</span></strong><span class="koboSpan" id="kobo.1368.1"> attributes are set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1369.1">false</span></strong><span class="koboSpan" id="kobo.1370.1">. </span><span class="koboSpan" id="kobo.1370.2">This means that the S3 bucket does not block public </span><strong class="bold"><span class="koboSpan" id="kobo.1371.1">access control lists</span></strong><span class="koboSpan" id="kobo.1372.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1373.1">ACLs</span></strong><span class="koboSpan" id="kobo.1374.1">) or </span><a id="_idIndexMarker316"/><span class="koboSpan" id="kobo.1375.1">public policies, does not ignore public ACLs, and does not restrict </span><span class="No-Break"><span class="koboSpan" id="kobo.1376.1">public buckets.</span></span></p></li> <li><span class="koboSpan" id="kobo.1377.1">Let’s also add the following to specify ownership controls for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1378.1">S3 bucket:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1379.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.1380.1">aws_s3_bucket_ownership_controls</span></strong><span class="koboSpan" id="kobo.1381.1">" "bucket" {
  bucket = aws_s3_bucket.bucket.id
  rule {
    object_ownership = "</span><strong class="bold"><span class="koboSpan" id="kobo.1382.1">ObjectWriter</span></strong><span class="koboSpan" id="kobo.1383.1">"
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1384.1">The ownership </span><a id="_idIndexMarker317"/><span class="koboSpan" id="kobo.1385.1">controls are set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1386.1">ObjectWriter</span></strong><span class="koboSpan" id="kobo.1387.1">. </span><span class="koboSpan" id="kobo.1387.2">This ensures that objects in the bucket can only be modified by the </span><strong class="bold"><span class="koboSpan" id="kobo.1388.1">Identity and Access Management</span></strong><span class="koboSpan" id="kobo.1389.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1390.1">IAM</span></strong><span class="koboSpan" id="kobo.1391.1">) user or role </span><a id="_idIndexMarker318"/><span class="koboSpan" id="kobo.1392.1">that </span><span class="No-Break"><span class="koboSpan" id="kobo.1393.1">uploaded them.</span></span></p></li> <li><span class="koboSpan" id="kobo.1394.1">Next, let’s configure the S3 bucket</span><a id="_idIndexMarker319"/><span class="koboSpan" id="kobo.1395.1"> for </span><strong class="bold"><span class="koboSpan" id="kobo.1396.1">static website hosting</span></strong><span class="koboSpan" id="kobo.1397.1"> by adding the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.1398.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1399.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.1400.1">aws_s3_bucket_website_configuration</span></strong><span class="koboSpan" id="kobo.1401.1">" "bucket" {
  bucket = aws_s3_bucket.bucket.bucket
  index_document {
    suffix = "index.html"
  }
}</span></pre></li> <li><span class="koboSpan" id="kobo.1402.1">Let’s define an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1403.1">aws_iam_policy_document</span></strong><span class="koboSpan" id="kobo.1404.1"> data source block </span><span class="No-Break"><span class="koboSpan" id="kobo.1405.1">as well:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1406.1">
data "</span><strong class="bold"><span class="koboSpan" id="kobo.1407.1">aws_iam_policy_document</span></strong><span class="koboSpan" id="kobo.1408.1">" "policy" {
  statement {
    sid = "SampleStatement"
    principals {
      type        = "AWS"
      identifiers = ["*"]
    }
    actions = [
      "s3:GetObject"
    ]
    resources = [
      "${aws_s3_bucket.bucket.arn}/*"
    ]
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1409.1">The policy </span><a id="_idIndexMarker320"/><span class="koboSpan" id="kobo.1410.1">described in the block of code grants permission to AWS principals (that is, </span><em class="italic"><span class="koboSpan" id="kobo.1411.1">any</span></em><span class="koboSpan" id="kobo.1412.1"> AWS account or IAM user) to perform the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1413.1">s3:GetObject</span></strong><span class="koboSpan" id="kobo.1414.1"> action on objects within an S3 bucket. </span><span class="koboSpan" id="kobo.1414.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1415.1">resources</span></strong><span class="koboSpan" id="kobo.1416.1"> attribute specifies the </span><strong class="bold"><span class="koboSpan" id="kobo.1417.1">Amazon Resource Name</span></strong><span class="koboSpan" id="kobo.1418.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1419.1">ARN</span></strong><span class="koboSpan" id="kobo.1420.1">) of the S3 bucket, followed by a wildcard </span><a id="_idIndexMarker321"/><span class="koboSpan" id="kobo.1421.1">character (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1422.1">*</span></strong><span class="koboSpan" id="kobo.1423.1">) to allow access to all objects within </span><span class="No-Break"><span class="koboSpan" id="kobo.1424.1">the bucket.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1425.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1426.1">If you are wondering what a data source block is, it is simply a resource we can read data from. </span><span class="koboSpan" id="kobo.1426.2">It allows us to retrieve information from existing resources or external systems. </span><span class="koboSpan" id="kobo.1426.3">In addition to this, it acts as a </span><em class="italic"><span class="koboSpan" id="kobo.1427.1">read-only</span></em><span class="koboSpan" id="kobo.1428.1"> reference, providing valuable data that can be used in our configuration. </span><span class="koboSpan" id="kobo.1428.2">We’ll see the data source block used in the succeeding set </span><span class="No-Break"><span class="koboSpan" id="kobo.1429.1">of steps.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1430.1">Let’s also define </span><strong class="source-inline"><span class="koboSpan" id="kobo.1431.1">s3_policy</span></strong><span class="koboSpan" id="kobo.1432.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1433.1">au_uri</span></strong><span class="koboSpan" id="kobo.1434.1"> local variables, which we will use in the succeeding </span><span class="No-Break"><span class="koboSpan" id="kobo.1435.1">configuration blocks:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1436.1">
locals {
  </span><strong class="bold"><span class="koboSpan" id="kobo.1437.1">s3_policy</span></strong><span class="koboSpan" id="kobo.1438.1"> = data.aws_iam_policy_document.policy
  </span><strong class="bold"><span class="koboSpan" id="kobo.1439.1">au_uri</span></strong><span class="koboSpan" id="kobo.1440.1"> = "http://acs.amazonaws.com/groups/global/</span><strong class="bold"><span class="koboSpan" id="kobo.1441.1">AuthenticatedUsers</span></strong><span class="koboSpan" id="kobo.1442.1">"
}</span></pre></li> <li><span class="koboSpan" id="kobo.1443.1">Next, define</span><a id="_idIndexMarker322"/><span class="koboSpan" id="kobo.1444.1"> an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1445.1">aws_s3_bucket_policy</span></strong><span class="koboSpan" id="kobo.1446.1"> resource using the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.1447.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1448.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.1449.1">aws_s3_bucket_polic</span></strong><span class="koboSpan" id="kobo.1450.1">y" "</span><strong class="bold"><span class="koboSpan" id="kobo.1451.1">allow_access_policy</span></strong><span class="koboSpan" id="kobo.1452.1">" {
  bucket = aws_s3_bucket.bucket.id
  policy = local.s3_policy.json
}</span></pre></li> <li><span class="koboSpan" id="kobo.1453.1">Let’s define another data source block, </span><span class="No-Break"><span class="koboSpan" id="kobo.1454.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1455.1">
data "</span><strong class="bold"><span class="koboSpan" id="kobo.1456.1">aws_canonical_user_id</span></strong><span class="koboSpan" id="kobo.1457.1">" "current" {}</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1458.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1459.1">This is the same data source block used in the previous section of this chapter. </span><span class="koboSpan" id="kobo.1459.2">If you can’t remember what this is used for, this data source block will give us access to the AWS canonical user ID of the account used to </span><span class="No-Break"><span class="koboSpan" id="kobo.1460.1">run Terraform.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1461.1">Let’s define an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1462.1">aws_s3_bucket_acl</span></strong><span class="koboSpan" id="kobo.1463.1"> resource as well to set the S3 bucket’s ACL </span><span class="No-Break"><span class="koboSpan" id="kobo.1464.1">configuration settings:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1465.1">
resource "aws_s3_bucket_acl" "bucket_acl" {
  bucket = aws_s3_bucket.bucket.id
  access_control_policy {
    </span><strong class="bold"><span class="koboSpan" id="kobo.1466.1">grant</span></strong><span class="koboSpan" id="kobo.1467.1"> {
      </span><strong class="bold"><span class="koboSpan" id="kobo.1468.1">grantee</span></strong><span class="koboSpan" id="kobo.1469.1"> {
        id   = data.aws_canonical_user_id.current.id
        type = "CanonicalUser"
      }
      </span><strong class="bold"><span class="koboSpan" id="kobo.1470.1">permission = "FULL_CONTROL"</span></strong><span class="koboSpan" id="kobo.1471.1">
    }
    </span><strong class="bold"><span class="koboSpan" id="kobo.1472.1">grant</span></strong><span class="koboSpan" id="kobo.1473.1"> {
      </span><strong class="bold"><span class="koboSpan" id="kobo.1474.1">grantee</span></strong><span class="koboSpan" id="kobo.1475.1"> {
        type = "Group"
        uri  = local.au_uri
      }
      </span><strong class="bold"><span class="koboSpan" id="kobo.1476.1">permission = "READ"</span></strong><span class="koboSpan" id="kobo.1477.1">
    }
    owner {
      id = data.aws_canonical_user_id.current.id
    }
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1478.1">This code block </span><a id="_idIndexMarker323"/><span class="koboSpan" id="kobo.1479.1">configures the ACL of an S3 bucket. </span><span class="koboSpan" id="kobo.1479.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1480.1">aws_s3_bucket_acl</span></strong><span class="koboSpan" id="kobo.1481.1"> resource sets permissions for two grants: one for a canonical user with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1482.1">FULL_CONTROL</span></strong><span class="koboSpan" id="kobo.1483.1"> permission, and another for a group with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1484.1">READ</span></strong><span class="koboSpan" id="kobo.1485.1"> permission. </span><span class="koboSpan" id="kobo.1485.2">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1486.1">data.aws_canonical_user_id</span></strong><span class="koboSpan" id="kobo.1487.1"> data source returns the canonical user ID for the first grantee. </span><span class="koboSpan" id="kobo.1487.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1488.1">local.au_uri</span></strong><span class="koboSpan" id="kobo.1489.1"> local value, on the other hand, returns the URI (referring to an AWS pre-defined group called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1490.1">AuthenticatedUsers</span></strong><span class="koboSpan" id="kobo.1491.1">) for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1492.1">second grantee.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1493.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1494.1">You’ve probably noticed that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1495.1">main.tf</span></strong><span class="koboSpan" id="kobo.1496.1"> file has got longer. </span><span class="koboSpan" id="kobo.1496.2">It’s important to note that we can divide and group the resources across different files. </span><span class="koboSpan" id="kobo.1496.3">When we have multiple </span><strong class="source-inline"><span class="koboSpan" id="kobo.1497.1">.tf</span></strong><span class="koboSpan" id="kobo.1498.1"> files in the working directory, Terraform simply concatenates these files and proceeds with its usual set of infrastructure management operations. </span><span class="koboSpan" id="kobo.1498.2">We won’t dive deep into the strategies and best practices in this chapter since we’ll tackle these in the succeeding chapters of this book as we build a variety of penetration testing lab environments in AWS, Azure, </span><span class="No-Break"><span class="koboSpan" id="kobo.1499.1">and GCP.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.1500.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.1501.1">Esc</span></em><span class="koboSpan" id="kobo.1502.1"> key to switch back to normal mode. </span><span class="koboSpan" id="kobo.1502.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1503.1">:wq!</span></strong><span class="koboSpan" id="kobo.1504.1"> and then press </span><em class="italic"><span class="koboSpan" id="kobo.1505.1">Enter</span></em><span class="koboSpan" id="kobo.1506.1">. </span><span class="koboSpan" id="kobo.1506.2">This will save the changes made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1507.1">main.tf</span></strong><span class="koboSpan" id="kobo.1508.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.1509.1">as well.</span></span></li>
<li><span class="koboSpan" id="kobo.1510.1">Before running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1511.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1512.1"> command, let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1513.1">terraform fmt</span></strong><span class="koboSpan" id="kobo.1514.1"> to format our </span><span class="No-Break"><span class="koboSpan" id="kobo.1515.1">Terraform code:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1516.1">terraform fmt</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1517.1">Here, we make use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1518.1">terraform fmt</span></strong><span class="koboSpan" id="kobo.1519.1"> to establish a consistent coding style across our Terraform configuration files. </span><span class="koboSpan" id="kobo.1519.2">By analyzing the files, this command adjusts indentation, spacing, and line breaks to align with the prescribed Terraform</span><a id="_idIndexMarker324"/> <span class="No-Break"><span class="koboSpan" id="kobo.1520.1">style guide.</span></span></p></li> <li><span class="koboSpan" id="kobo.1521.1">Now, let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1522.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1523.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1524.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1525.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1526.1">This should yield an execution plan similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1527.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1528.1">.7</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1529.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer055">
<span class="koboSpan" id="kobo.1530.1"><img alt="" src="image/B19755_03_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1531.1">Figure 3.7 – Results after running the terraform plan command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1532.1">Here, we can see that the execution plan now includes the updates on the security configuration settings of our </span><span class="No-Break"><span class="koboSpan" id="kobo.1533.1">S3 bucket.</span></span></p></li>
</ol>
<ol>
<li value="14"><span class="koboSpan" id="kobo.1534.1">With </span><a id="_idIndexMarker325"/><span class="koboSpan" id="kobo.1535.1">everything ready, let’s run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1536.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1537.1">apply</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1538.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1539.1">terraform apply -auto-approve</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1540.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1541.1">In case you encounter issues running </span><strong class="source-inline"><span class="koboSpan" id="kobo.1542.1">terraform apply -auto-approve</span></strong><span class="koboSpan" id="kobo.1543.1">, feel free to rerun the same command as this may solve these issues automatically without having to modify the Terraform code. </span><span class="koboSpan" id="kobo.1543.2">For example, if you encounter an “</span><strong class="bold"><span class="koboSpan" id="kobo.1544.1">Error putting S3 policy: AccessDenied: Access Denied</span></strong><span class="koboSpan" id="kobo.1545.1">” error message, simply run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1546.1">terraform apply -auto-approve</span></strong><span class="koboSpan" id="kobo.1547.1"> again. </span><span class="koboSpan" id="kobo.1547.2">Note that an alternative for resolving issues would be to delete the resources first using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1548.1">terraform destroy -auto-approve</span></strong><span class="koboSpan" id="kobo.1549.1"> and then create the resources again with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1550.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1551.1">apply -auto-approve</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1552.1">.</span></span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.1553.1">Now, let’s verify whether the ACL configuration for the bucket has been applied using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1554.1">following command:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1555.1">
aws s3api get-bucket-acl --bucket=</span><strong class="bold"><span class="koboSpan" id="kobo.1556.1">&lt;INSERT BUCKET NAME&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1557.1">Make sure to </span><a id="_idIndexMarker326"/><span class="koboSpan" id="kobo.1558.1">replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1559.1">&lt;INSERT BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.1560.1"> with the name of your </span><span class="No-Break"><span class="koboSpan" id="kobo.1561.1">S3 bucket.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.1562.1">After running the command, we should get a JSON response similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1563.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1564.1">.8</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1565.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer056">
<span class="koboSpan" id="kobo.1566.1"><img alt="" src="image/B19755_03_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1567.1">Figure 3.8 – Results returned after running the aws s3api get-bucket-acl command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1568.1">Here, we can see that the new ACL configuration settings have been applied to our </span><span class="No-Break"><span class="koboSpan" id="kobo.1569.1">S3 bucket.</span></span></p></li>
</ol>
<h2 id="_idParaDest-55"><a id="_idTextAnchor054"/><span class="koboSpan" id="kobo.1570.1">Part 3 of 4 – Uploading files to the S3 bucket</span></h2>
<p><span class="koboSpan" id="kobo.1571.1">Next, let’s add files to</span><a id="_idIndexMarker327"/><span class="koboSpan" id="kobo.1572.1"> the S3 bucket created previously, </span><span class="No-Break"><span class="koboSpan" id="kobo.1573.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1574.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1575.1">touch</span></strong><span class="koboSpan" id="kobo.1576.1"> command to create an empty </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1577.1">upload.sh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1578.1"> file:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1579.1">touch upload.sh</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1580.1">To make the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1581.1">upload.sh script</span></strong><span class="koboSpan" id="kobo.1582.1"> file executable, run the following command </span><span class="No-Break"><span class="koboSpan" id="kobo.1583.1">as well:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1584.1">chmod +x upload.sh</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1585.1">Run the following command to open the empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.1586.1">upload.sh</span></strong><span class="koboSpan" id="kobo.1587.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1588.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1589.1">vim upload.sh</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1590.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1591.1">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1592.1">:set nu</span></strong><span class="koboSpan" id="kobo.1593.1"> and then press the </span><em class="italic"><span class="koboSpan" id="kobo.1594.1">Enter</span></em><span class="koboSpan" id="kobo.1595.1"> key to show the </span><span class="No-Break"><span class="koboSpan" id="kobo.1596.1">line numbers.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1597.1">Next, press </span><em class="italic"><span class="koboSpan" id="kobo.1598.1">i</span></em><span class="koboSpan" id="kobo.1599.1"> to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.1600.1">insert mode</span></strong><span class="koboSpan" id="kobo.1601.1"> so that we can edit the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1602.1">upload.sh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1603.1"> file.</span></span></li>
<li><span class="koboSpan" id="kobo.1604.1">Now that we are in insert mode, let’s proceed by adding the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.1605.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1606.1">
mkdir files
cd files
SOURCE=</span><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/raw/main/ch03/sample_website.zip"><span class="koboSpan" id="kobo.1607.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/raw/main/ch03/sample_website.zip</span></a><span class="koboSpan" id="kobo.1608.1">
wget $SOURCE -O sample_website.zip
unzip sample_website.zip
rm sample_website.zip
aws s3 cp --recursive . </span><span class="koboSpan" id="kobo.1608.2">s3://$1</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1609.1">This set of commands simply (1) downloads a ZIP file from a GitHub repository containing a sample website and (2) uploads its contents to an Amazon S3 bucket. </span><span class="koboSpan" id="kobo.1609.2">Make sure that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1610.1">SOURCE</span></strong><span class="koboSpan" id="kobo.1611.1"> variable value is correct by removing any extra spaces and checking if the download link is working when accessed directly using </span><span class="No-Break"><span class="koboSpan" id="kobo.1612.1">the browser.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1613.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1614.1">This is the same set of terminal commands used in </span><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.1615.1">Chapter 2</span></a></em></span><span class="koboSpan" id="kobo.1616.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1617.1">Preparing Our First Vulnerable Cloud Lab Environment</span></em><span class="koboSpan" id="kobo.1618.1">, to upload files to our </span><span class="No-Break"><span class="koboSpan" id="kobo.1619.1">S3 bucket.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1620.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.1621.1">Esc</span></em><span class="koboSpan" id="kobo.1622.1"> key </span><a id="_idIndexMarker328"/><span class="koboSpan" id="kobo.1623.1">to switch back to normal mode. </span><span class="koboSpan" id="kobo.1623.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1624.1">:wq!</span></strong><span class="koboSpan" id="kobo.1625.1"> and then press </span><em class="italic"><span class="koboSpan" id="kobo.1626.1">Enter</span></em><span class="koboSpan" id="kobo.1627.1">. </span><span class="koboSpan" id="kobo.1627.2">This will save the changes made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1628.1">upload.sh</span></strong><span class="koboSpan" id="kobo.1629.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.1630.1">as well.</span></span></li>
<li><span class="koboSpan" id="kobo.1631.1">Run the following command to open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1632.1">main.tf</span></strong><span class="koboSpan" id="kobo.1633.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1634.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1635.1">vim main.tf</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1636.1">Hold the </span><em class="italic"><span class="koboSpan" id="kobo.1637.1">Shift</span></em><span class="koboSpan" id="kobo.1638.1"> key and then press </span><em class="italic"><span class="koboSpan" id="kobo.1639.1">g</span></em><span class="koboSpan" id="kobo.1640.1"> to navigate to the last line. </span><span class="koboSpan" id="kobo.1640.2">Press </span><em class="italic"><span class="koboSpan" id="kobo.1641.1">o</span></em><span class="koboSpan" id="kobo.1642.1"> afterward. </span><span class="koboSpan" id="kobo.1642.2">This should insert a new line after the current line (along with switching to </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1643.1">insert mode</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1644.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.1645.1">Add the following block of code after the new line inserted in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1646.1">previous step:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1647.1">
resource "null_resource" "s3_upload" {
  provisioner "local-exec" {
    command = "./</span><strong class="bold"><span class="koboSpan" id="kobo.1648.1">upload.sh</span></strong><span class="koboSpan" id="kobo.1649.1"> ${aws_s3_bucket.bucket.id}"
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1650.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1651.1">provisioner</span></strong><span class="koboSpan" id="kobo.1652.1"> block specifies that a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1653.1">local-exec</span></strong><span class="koboSpan" id="kobo.1654.1"> provisioner will be used, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1655.1">command</span></strong><span class="koboSpan" id="kobo.1656.1"> attribute specifies the shell command to be executed, which in this case is a shell script </span><span class="No-Break"><span class="koboSpan" id="kobo.1657.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1658.1">upload.sh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1659.1">.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1660.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1661.1">Note that the provisioner code in the preceding block of code can also be placed inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1662.1">aws_s3_bucket</span></strong><span class="koboSpan" id="kobo.1663.1"> resource block or in other resource blocks (with a few minor modifications to get it working). </span><span class="koboSpan" id="kobo.1663.2">For more information on how the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1664.1">local-exec</span></strong><span class="koboSpan" id="kobo.1665.1"> provisioner works, feel free to check out the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1666.1">link: </span></span><a href="https://developer.hashicorp.com/terraform/language/resources/provisioners/local-exec"><span class="No-Break"><span class="koboSpan" id="kobo.1667.1">https://developer.hashicorp.com/terraform/language/resources/provisioners/local-exec</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1668.1">.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1669.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.1670.1">Esc</span></em><span class="koboSpan" id="kobo.1671.1"> key to switch back to normal mode. </span><span class="koboSpan" id="kobo.1671.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1672.1">:wq!</span></strong><span class="koboSpan" id="kobo.1673.1"> and then press </span><em class="italic"><span class="koboSpan" id="kobo.1674.1">Enter</span></em><span class="koboSpan" id="kobo.1675.1">. </span><span class="koboSpan" id="kobo.1675.2">This will save the changes made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1676.1">main.tf</span></strong><span class="koboSpan" id="kobo.1677.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.1678.1">as well.</span></span></li>
<li><span class="koboSpan" id="kobo.1679.1">Now, let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1680.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1681.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1682.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1683.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1684.1">This should give us </span><a id="_idIndexMarker329"/><span class="koboSpan" id="kobo.1685.1">an error message similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1686.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1687.1">.9</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1688.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer057">
<span class="koboSpan" id="kobo.1689.1"><img alt="" src="image/B19755_03_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1690.1">Figure 3.9 – Inconsistent dependency lock file error</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1691.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.1692.1">Inconsistent dependency lock file</span></strong><span class="koboSpan" id="kobo.1693.1"> error in Terraform typically occurs when there is a mismatch between the dependency lock file and the configuration files. </span><span class="koboSpan" id="kobo.1693.2">This inconsistency can arise due to changes made to the configuration without updating the lock file accordingly. </span><span class="koboSpan" id="kobo.1693.3">That said, to resolve the </span><strong class="bold"><span class="koboSpan" id="kobo.1694.1">Inconsistent dependency lock file</span></strong><span class="koboSpan" id="kobo.1695.1"> error, let’s use the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1696.1">command again:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1697.1">terraform init</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.1698.1">This will sync the lock file with the configuration, resolving any inconsistencies and ensuring consistent dependencies for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1699.1">Terraform deployment.</span></span></p></li>
</ol>
<ol>
<li value="12"><span class="koboSpan" id="kobo.1700.1">Next, let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1701.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1702.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1703.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1704.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1705.1">You should see the</span><a id="_idIndexMarker330"/><span class="koboSpan" id="kobo.1706.1"> command succeed </span><span class="No-Break"><span class="koboSpan" id="kobo.1707.1">this time.</span></span></p></li> <li><span class="koboSpan" id="kobo.1708.1">With everything ready, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1709.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1710.1"> command to implement the changes specified in the execution plan returned after running </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1711.1">terraform plan</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1712.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1713.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1714.1">This should run the commands coded in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1715.1">upload.sh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1716.1"> script.</span></span></p></li> <li><span class="koboSpan" id="kobo.1717.1">Let’s perform a few quick checks by running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1718.1">aws s3 ls</span></strong><span class="koboSpan" id="kobo.1719.1"> command, </span><span class="No-Break"><span class="koboSpan" id="kobo.1720.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1721.1">
aws s3 ls s3://</span><strong class="bold"><span class="koboSpan" id="kobo.1722.1">&lt;INSERT BUCKET NAME&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1723.1">This should list the objects stored in our </span><span class="No-Break"><span class="koboSpan" id="kobo.1724.1">S3 bucket.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1725.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1726.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1727.1">&lt;INSERT BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.1728.1"> with the name of your S3 bucket before running </span><span class="No-Break"><span class="koboSpan" id="kobo.1729.1">the command.</span></span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.1730.1">Now, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1731.1">aws s3api get-bucket-website</span></strong><span class="koboSpan" id="kobo.1732.1"> command to check the static website </span><span class="No-Break"><span class="koboSpan" id="kobo.1733.1">hosting configuration:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1734.1">
aws s3api get-bucket-website --bucket </span><strong class="bold"><span class="koboSpan" id="kobo.1735.1">&lt;INSERT BUCKET NAME&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1736.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1737.1">&lt;INSERT BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.1738.1"> with the bucket name specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1739.1">main.tf</span></strong><span class="koboSpan" id="kobo.1740.1"> file (from a previous step in this section). </span><span class="koboSpan" id="kobo.1740.2">This should return the </span><span class="No-Break"><span class="koboSpan" id="kobo.1741.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1742.1">{
    "IndexDocument": {
        "Suffix": "index.html"
    }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1743.1">This confirms that the static website hosting configuration is properly set up for the specified </span><span class="No-Break"><span class="koboSpan" id="kobo.1744.1">S3 bucket.</span></span></p></li> <li><span class="koboSpan" id="kobo.1745.1">Let’s also check whether our static website hosting setup works by navigating to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1746.1">following link:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1747.1">
http://</span><strong class="bold"><span class="koboSpan" id="kobo.1748.1">&lt;BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.1749.1">.s3-website.</span><strong class="bold"><span class="koboSpan" id="kobo.1750.1">&lt;REGION&gt;</span></strong><span class="koboSpan" id="kobo.1751.1">.amazonaws.com</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1752.1">Make sure to </span><a id="_idIndexMarker331"/><span class="koboSpan" id="kobo.1753.1">replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1754.1">&lt;BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.1755.1"> with the name of the S3 bucket we created. </span><span class="koboSpan" id="kobo.1755.2">Do not forget to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1756.1">&lt;REGION&gt;</span></strong><span class="koboSpan" id="kobo.1757.1"> with the region where the S3 bucket was created (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1758.1">us-east-1</span></strong><span class="koboSpan" id="kobo.1759.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.1760.1">as well.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.1761.1">If everything went well, we should see a maintenance page similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1762.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1763.1">.10</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1764.1">:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer058">
<span class="koboSpan" id="kobo.1765.1"><img alt="" src="image/B19755_03_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1766.1">Figure 3.10 – Verifying that the static website hosting setup is working</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1767.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1768.1">At this point, the vulnerable lab environment similar to what we prepared in </span><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.1769.1">Chapter 2</span></a></em></span><span class="koboSpan" id="kobo.1770.1">,</span><em class="italic"><span class="koboSpan" id="kobo.1771.1"> Preparing Our First Vulnerable Cloud Lab Environment</span></em><span class="koboSpan" id="kobo.1772.1">, is ready! </span><span class="koboSpan" id="kobo.1772.2">Feel free to test the security configuration of our lab environment by following the steps specified in the </span><em class="italic"><span class="koboSpan" id="kobo.1773.1">Testing and hacking our first vulnerable environment</span></em><span class="koboSpan" id="kobo.1774.1"> section of </span><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.1775.1">Chapter 2</span></a></em></span><span class="koboSpan" id="kobo.1776.1"> (where we will need the second </span><span class="No-Break"><span class="koboSpan" id="kobo.1777.1">AWS account).</span></span></p>
<h2 id="_idParaDest-56"><a id="_idTextAnchor055"/><span class="koboSpan" id="kobo.1778.1">Part 4 of 4 – Cleaning up and deleting the S3 bucket</span></h2>
<p><span class="koboSpan" id="kobo.1779.1">Before we end </span><a id="_idIndexMarker332"/><span class="koboSpan" id="kobo.1780.1">this section, let’s clean up! </span><span class="koboSpan" id="kobo.1780.2">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1781.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1782.1">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1783.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.1784.1"> to clean up the resources we </span><span class="No-Break"><span class="koboSpan" id="kobo.1785.1">created earlier:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1786.1">terraform destroy</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1787.1">During the verification step (that is, when you see an </span><strong class="bold"><span class="koboSpan" id="kobo.1788.1">Enter a value:</span></strong><span class="koboSpan" id="kobo.1789.1"> message), type in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1790.1">yes</span></strong><span class="koboSpan" id="kobo.1791.1"> to proceed with the deletion of the resources. </span><span class="koboSpan" id="kobo.1791.2">After the resources are deleted, a backup file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1792.1">terraform.tfstate.backup</span></strong><span class="koboSpan" id="kobo.1793.1">) containing a copy of the properties of the state file becomes available in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1794.1">same directory.</span></span></p></li> <li><span class="koboSpan" id="kobo.1795.1">You may use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1796.1">less</span></strong><span class="koboSpan" id="kobo.1797.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1798.1">cat</span></strong><span class="koboSpan" id="kobo.1799.1"> command to check the properties stored in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1800.1">terraform.tfstate.backup</span></strong><span class="koboSpan" id="kobo.1801.1"> file. </span><span class="koboSpan" id="kobo.1801.2">Alternatively, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1802.1">terraform show</span></strong><span class="koboSpan" id="kobo.1803.1"> command on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1804.1">terraform.tfstate.backup</span></strong><span class="koboSpan" id="kobo.1805.1"> file to read </span><span class="No-Break"><span class="koboSpan" id="kobo.1806.1">its contents:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1807.1">terraform show terraform.tfstate.backup</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1808.1">This should yield an output similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1809.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1810.1">.11</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1811.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer059">
<span class="koboSpan" id="kobo.1812.1"><img alt="" src="image/B19755_03_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1813.1">Figure 3.11 – Output after running terraform show</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1814.1">In case you are </span><a id="_idIndexMarker333"/><span class="koboSpan" id="kobo.1815.1">tempted to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1816.1">terraform show</span></strong><span class="koboSpan" id="kobo.1817.1"> to convert a state file into a config file (similar to what we code inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1818.1">main.tf</span></strong><span class="koboSpan" id="kobo.1819.1"> file), it is important to note that the output we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1820.1">Figure 3</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1821.1">.11</span></em><span class="koboSpan" id="kobo.1822.1"> is not intended for direct programmatic consumption (as it is made available primarily for us humans to troubleshoot and inspect the state stored inside </span><span class="No-Break"><span class="koboSpan" id="kobo.1823.1">a file).</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1824.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1825.1">If you use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1826.1">terraform show</span></strong><span class="koboSpan" id="kobo.1827.1"> (without any additional argument(s)), we should get an empty response since the resources have been deleted already at this point using </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1828.1">terraform destroy</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1829.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1830.1">Wow! </span><span class="koboSpan" id="kobo.1830.2">We were able to successfully convert the manual steps from </span><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.1831.1">Chapter 2</span></a></em></span><span class="koboSpan" id="kobo.1832.1"> into a single configuration file. </span><span class="koboSpan" id="kobo.1832.2">At this point, if we want to create 10 clones of the S3 bucket (with all resources having the same set of properties and configuration settings except for the bucket name), we will just need a few minor modifications to what we have right now and then use Terraform to automatically create and configure the S3 resources </span><span class="No-Break"><span class="koboSpan" id="kobo.1833.1">for us.</span></span></p>
<h1 id="_idParaDest-57"><a id="_idTextAnchor056"/><span class="koboSpan" id="kobo.1834.1">Configuring a Terraform backend with state locking</span></h1>
<p><span class="koboSpan" id="kobo.1835.1">In this section, we will explore how Terraform remote backends work and understand how state locking ensures the integrity and consistency of our infrastructure state when managing infrastructure deployments. </span><span class="koboSpan" id="kobo.1835.2">Then, we will delve into the step-by-step process of configuring a remote backend to enable </span><span class="No-Break"><span class="koboSpan" id="kobo.1836.1">state locking.</span></span></p>
<h2 id="_idParaDest-58"><a id="_idTextAnchor057"/><span class="koboSpan" id="kobo.1837.1">Understanding Terraform remote backends</span></h2>
<p><span class="koboSpan" id="kobo.1838.1">Up until this point, we</span><a id="_idIndexMarker334"/><span class="koboSpan" id="kobo.1839.1"> have used the default </span><strong class="bold"><span class="koboSpan" id="kobo.1840.1">local backend</span></strong><span class="koboSpan" id="kobo.1841.1">, which </span><a id="_idIndexMarker335"/><span class="koboSpan" id="kobo.1842.1">stores the state as a local file (that is, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1843.1">terraform.tfstate</span></strong><span class="koboSpan" id="kobo.1844.1"> file). </span><span class="koboSpan" id="kobo.1844.2">This type of setup should be okay when only a single engineer is involved. </span><span class="koboSpan" id="kobo.1844.3">Once another engineer wants to apply configuration changes to the same set of resources with Terraform, using a </span><strong class="bold"><span class="koboSpan" id="kobo.1845.1">remote backend</span></strong><span class="koboSpan" id="kobo.1846.1"> will make more sense since the second engineer needs to have access to the existing state file (used by the first engineer). </span><span class="koboSpan" id="kobo.1846.2">In addition to this, we need to make sure that configuration changes to the same set of resources are not applied at the same time to </span><a id="_idIndexMarker336"/><span class="koboSpan" id="kobo.1847.1">prevent </span><strong class="bold"><span class="koboSpan" id="kobo.1848.1">race conditions, </span></strong><span class="koboSpan" id="kobo.1849.1">which could lead to a </span><span class="No-Break"><span class="koboSpan" id="kobo.1850.1">corrupted state.</span></span></p>
<p><span class="koboSpan" id="kobo.1851.1">One of the best practices when using Terraform involves the usage of an external remote backend to store and lock the state (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1852.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1853.1">.12</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1854.1">):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer060">
<span class="koboSpan" id="kobo.1855.1"><img alt="" src="image/B19755_03_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1856.1">Figure 3.12 – Local versus remote backend</span></p>
<p><span class="koboSpan" id="kobo.1857.1">This allows multiple engineers</span><a id="_idIndexMarker337"/><span class="koboSpan" id="kobo.1858.1"> to work on the same set of resources without having to worry about corrupting the setup. </span><span class="koboSpan" id="kobo.1858.2">Configuring the right backend is critical as the Terraform backend dictates how state is loaded, which in turn affects the resource creation and </span><span class="No-Break"><span class="koboSpan" id="kobo.1859.1">modification processes.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1860.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1861.1">Carefully selecting and configuring the backend ensures secure collaboration, version control, and proper state management throughout the infrastructure life cycle. </span><span class="koboSpan" id="kobo.1861.2">This enhances the reliability and scalability of the Terraform workflow for teams working on the same set of resources. </span><span class="koboSpan" id="kobo.1861.3">For more information, feel free to check out the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1862.1">link: </span></span><a href="https://developer.hashicorp.com/terraform/language/settings/backends/configuration"><span class="No-Break"><span class="koboSpan" id="kobo.1863.1">https://developer.hashicorp.com/terraform/language/settings/backends/configuration</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1864.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1865.1">That said, to address the challenges of collaboration and prevent potential conflicts, it is recommended to switch from the default local backend to a remote backend in Terraform. </span><span class="koboSpan" id="kobo.1865.2">By using a remote backend, such as an S3 bucket, multiple engineers can securely access and modify the same state file. </span><span class="koboSpan" id="kobo.1865.3">This facilitates coordination and ensures consistency when making configuration changes to shared resources. </span><span class="koboSpan" id="kobo.1865.4">Additionally, utilizing a remote backend helps mitigate the risk of race conditions, as it provides a centralized mechanism for managing and locking the state, reducing the likelihood of encountering a </span><span class="No-Break"><span class="koboSpan" id="kobo.1866.1">corrupted state.</span></span></p>
<h2 id="_idParaDest-59"><a id="_idTextAnchor058"/><span class="koboSpan" id="kobo.1867.1">Configuring a Terraform remote backend</span></h2>
<p><strong class="bold"><span class="koboSpan" id="kobo.1868.1">State locking</span></strong><span class="koboSpan" id="kobo.1869.1"> plays </span><a id="_idIndexMarker338"/><span class="koboSpan" id="kobo.1870.1">a vital role in avoiding conflicts and race conditions. </span><span class="koboSpan" id="kobo.1870.2">By allowing only one user or process to modify the state at any given time, it ensures integrity and synchronization across Terraform deployments. </span><span class="koboSpan" id="kobo.1870.3">This mechanism is crucial for maintaining data consistency and preventing unwanted changes during collaborative </span><span class="No-Break"><span class="koboSpan" id="kobo.1871.1">infrastructure management.</span></span></p>
<p><span class="koboSpan" id="kobo.1872.1">When configuring </span><a id="_idIndexMarker339"/><span class="koboSpan" id="kobo.1873.1">state locking for a Terraform backend in an AWS cloud environment, it is common to use an S3 bucket and a DynamoDB table. </span><span class="koboSpan" id="kobo.1873.2">The S3 bucket acts as secure storage for the Terraform state file, while the DynamoDB table serves as a distributed lock mechanism. </span><span class="koboSpan" id="kobo.1873.3">With state locking, only one Terraform command can hold the lock at a time, and others wait until it’s released. </span><span class="koboSpan" id="kobo.1873.4">This setup ensures consistency and prevents conflicts in collaborative or automated Terraform environments. </span><span class="koboSpan" id="kobo.1873.5">We will label the S3 bucket </span><strong class="source-inline"><span class="koboSpan" id="kobo.1874.1">BACKEND_S3</span></strong><span class="koboSpan" id="kobo.1875.1"> and the DynamoDB table </span><strong class="source-inline"><span class="koboSpan" id="kobo.1876.1">BACKEND_TABLE</span></strong><span class="koboSpan" id="kobo.1877.1"> as we will refer to these resources multiple times in this chapter. </span><span class="koboSpan" id="kobo.1877.2">Note that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1878.1">BACKEND_S3</span></strong><span class="koboSpan" id="kobo.1879.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1880.1">BACKEND_TABLE</span></strong><span class="koboSpan" id="kobo.1881.1"> are just arbitrary labels we will use in this chapter to make it easier for us to refer to the resources we will be creating in the succeeding set of steps. </span><span class="koboSpan" id="kobo.1881.2">That said, these labels are different from the actual resource names of the cloud </span><span class="No-Break"><span class="koboSpan" id="kobo.1882.1">infrastructure resources.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1883.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1884.1">If you are wondering what DynamoDB</span><a id="_idIndexMarker340"/><span class="koboSpan" id="kobo.1885.1"> is, it is a fully managed NoSQL database service in AWS. </span><span class="koboSpan" id="kobo.1885.2">In DynamoDB, tables consist of items and attributes. </span><span class="koboSpan" id="kobo.1885.3">Each item represents a distinct piece of data, similar to a row in a traditional database. </span><span class="koboSpan" id="kobo.1885.4">Items are composed of attributes, which are key-value pairs that store the actual data. </span><span class="koboSpan" id="kobo.1885.5">One thing to note is that DynamoDB tables do not require a fixed schema, meaning each item can have a different set of attributes. </span><span class="koboSpan" id="kobo.1885.6">To implement the distributed lock mechanism, Terraform utilizes the DynamoDB table by creating a unique item or record as a lock indicator. </span><span class="koboSpan" id="kobo.1885.7">When a Terraform command attempts to acquire a lock, it checks whether the designated item exists. </span><span class="koboSpan" id="kobo.1885.8">If it does not exist, the command adds the item to the DynamoDB table, indicating that it has acquired the lock. </span><span class="koboSpan" id="kobo.1885.9">This prevents other Terraform commands from acquiring the </span><span class="No-Break"><span class="koboSpan" id="kobo.1886.1">lock concurrently.</span></span></p>
<p><span class="koboSpan" id="kobo.1887.1">In the next set of steps, we will upgrade our setup by configuring a Terraform backend to store and </span><span class="No-Break"><span class="koboSpan" id="kobo.1888.1">lock state:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1889.1">Navigate to the </span><a id="_idIndexMarker341"/><span class="koboSpan" id="kobo.1890.1">home directory using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1891.1">cd</span></strong><span class="koboSpan" id="kobo.1892.1"> command, </span><span class="No-Break"><span class="koboSpan" id="kobo.1893.1">as follows:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1894.1">cd ~</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1895.1">Let’s create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1896.1">backend</span></strong><span class="koboSpan" id="kobo.1897.1"> directory using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1898.1">mkdir</span></strong><span class="koboSpan" id="kobo.1899.1"> command. </span><span class="koboSpan" id="kobo.1899.2">After creating the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1900.1">backend</span></strong><span class="koboSpan" id="kobo.1901.1"> directory, let’s navigate to the directory using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1902.1">cd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1903.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1904.1">mkdir backend &amp;&amp; cd backend</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1905.1">Next, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1906.1">touch</span></strong><span class="koboSpan" id="kobo.1907.1"> command to create an empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.1908.1">main.tf</span></strong><span class="koboSpan" id="kobo.1909.1"> file inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1910.1">backend</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1911.1"> directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1912.1">touch main.tf</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1913.1">Run the following command to open the empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.1914.1">main.tf</span></strong><span class="koboSpan" id="kobo.1915.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1916.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1917.1">vim main.tf</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1918.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1919.1">You may type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1920.1">:set nu</span></strong><span class="koboSpan" id="kobo.1921.1"> and then press the </span><em class="italic"><span class="koboSpan" id="kobo.1922.1">Enter</span></em><span class="koboSpan" id="kobo.1923.1"> key to show the </span><span class="No-Break"><span class="koboSpan" id="kobo.1924.1">line numbers.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1925.1">Next, press </span><em class="italic"><span class="koboSpan" id="kobo.1926.1">i</span></em><span class="koboSpan" id="kobo.1927.1"> to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.1928.1">insert mode</span></strong><span class="koboSpan" id="kobo.1929.1"> so that we can edit </span><span class="No-Break"><span class="koboSpan" id="kobo.1930.1">the file.</span></span></li>
<li><span class="koboSpan" id="kobo.1931.1">Add the following block of code to our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1932.1">main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1933.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1934.1">
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~&gt; 4.0"
    }
  }
}
provider "aws" {
  alias  = "default"
  region = "us-east-1"
}</span></pre></li> <li><span class="koboSpan" id="kobo.1935.1">Next, let’s define a </span><em class="italic"><span class="koboSpan" id="kobo.1936.1">new</span></em> <strong class="source-inline"><span class="koboSpan" id="kobo.1937.1">aws_s3_bucket</span></strong><span class="koboSpan" id="kobo.1938.1"> resource (for the backend). </span><span class="koboSpan" id="kobo.1938.2">Note that this S3 bucket resource is different from the misconfigured S3 bucket used in our vulnerable </span><span class="No-Break"><span class="koboSpan" id="kobo.1939.1">lab environment:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1940.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.1941.1">aws_s3_bucket</span></strong><span class="koboSpan" id="kobo.1942.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.1943.1">remote_state</span></strong><span class="koboSpan" id="kobo.1944.1">" {
  bucket = "</span><strong class="bold"><span class="koboSpan" id="kobo.1945.1">&lt;INSERT S3 BACKEND BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.1946.1">"
  lifecycle {
    prevent_destroy = true
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1947.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1948.1">lifecycle</span></strong><span class="koboSpan" id="kobo.1949.1"> block </span><a id="_idIndexMarker342"/><span class="koboSpan" id="kobo.1950.1">includes a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1951.1">prevent_destroy</span></strong><span class="koboSpan" id="kobo.1952.1"> attribute set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1953.1">true</span></strong><span class="koboSpan" id="kobo.1954.1">, ensuring that the bucket cannot be destroyed accidentally. </span><span class="koboSpan" id="kobo.1954.2">This means that the Terraform state file stored in this bucket is protected from being </span><span class="No-Break"><span class="koboSpan" id="kobo.1955.1">accidentally deleted.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1956.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1957.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1958.1">&lt;INSERT S3 BACKEND BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.1959.1"> with a unique S3 bucket name (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1960.1">tf-remote-backend-abcdef-&lt;random string&gt;</span></strong><span class="koboSpan" id="kobo.1961.1">). </span><span class="koboSpan" id="kobo.1961.2">Note that at this point, this bucket should </span><em class="italic"><span class="koboSpan" id="kobo.1962.1">not</span></em><span class="koboSpan" id="kobo.1963.1"> exist yet as we have not executed the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1964.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1965.1">apply</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1966.1"> command.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.1967.1">Now, let’s add the following block of code to</span><a id="_idIndexMarker343"/><span class="koboSpan" id="kobo.1968.1"> enable </span><strong class="bold"><span class="koboSpan" id="kobo.1969.1">bucket versioning</span></strong><span class="koboSpan" id="kobo.1970.1"> and configure </span><strong class="bold"><span class="koboSpan" id="kobo.1971.1">server-side encryption</span></strong><span class="koboSpan" id="kobo.1972.1"> for </span><a id="_idIndexMarker344"/><span class="koboSpan" id="kobo.1973.1">our </span><span class="No-Break"><span class="koboSpan" id="kobo.1974.1">S3 bucket:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1975.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.1976.1">aws_s3_bucket_versioning</span></strong><span class="koboSpan" id="kobo.1977.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.1978.1">versioning</span></strong><span class="koboSpan" id="kobo.1979.1">" {
  bucket = aws_s3_bucket.remote_state.id
  versioning_configuration {
    status = "Enabled"
  }
}
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.1980.1">aws_s3_bucket_server_side_encryption_configuration</span></strong><span class="koboSpan" id="kobo.1981.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.1982.1">encryption</span></strong><span class="koboSpan" id="kobo.1983.1">" {
  bucket = aws_s3_bucket.remote_state.id
  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "aws:kms"
    }
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1984.1">Here, bucket versioning and </span><a id="_idIndexMarker345"/><span class="koboSpan" id="kobo.1985.1">server-side encryption are used for the S3 bucket, which will store the Terraform remote state. </span><span class="koboSpan" id="kobo.1985.2">Versioning ensures that previous versions of the remote state are retained, allowing for easy recovery in the event of accidental deletion or corruption. </span><span class="koboSpan" id="kobo.1985.3">Server-side encryption, on the other hand, ensures that sensitive data in the remote state is encrypted at rest to add an extra layer </span><span class="No-Break"><span class="koboSpan" id="kobo.1986.1">of security.</span></span></p></li> <li><span class="koboSpan" id="kobo.1987.1">Next, let’s define an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1988.1">aws_dynamodb_table</span></strong><span class="koboSpan" id="kobo.1989.1"> resource using the following block of code (using the name of our S3 bucket for the name of our </span><span class="No-Break"><span class="koboSpan" id="kobo.1990.1">DynamoDB table):</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1991.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.1992.1">aws_dynamodb_table</span></strong><span class="koboSpan" id="kobo.1993.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.1994.1">state_lock</span></strong><span class="koboSpan" id="kobo.1995.1">" {
  hash_key = "LockID"
  name = "</span><strong class="bold"><span class="koboSpan" id="kobo.1996.1">${aws_s3_bucket.remote_state.id}</span></strong><span class="koboSpan" id="kobo.1997.1">"
  attribute {
    name = "LockID"
    type = "S"
  }
  billing_mode = "PAY_PER_REQUEST"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1998.1">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1999.1">billing_mode</span></strong><span class="koboSpan" id="kobo.2000.1"> is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2001.1">"PAY_PER_REQUEST"</span></strong><span class="koboSpan" id="kobo.2002.1">, meaning that (1) we only pay for read and write requests to the table, and (2) there are no upfront costs or </span><span class="No-Break"><span class="koboSpan" id="kobo.2003.1">minimum fees.</span></span></p></li> <li><span class="koboSpan" id="kobo.2004.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.2005.1">Esc</span></em><span class="koboSpan" id="kobo.2006.1"> key to </span><a id="_idIndexMarker346"/><span class="koboSpan" id="kobo.2007.1">switch back to normal mode. </span><span class="koboSpan" id="kobo.2007.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.2008.1">:wq!</span></strong><span class="koboSpan" id="kobo.2009.1"> and then press </span><em class="italic"><span class="koboSpan" id="kobo.2010.1">Enter</span></em><span class="koboSpan" id="kobo.2011.1">. </span><span class="koboSpan" id="kobo.2011.2">This will save the changes made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2012.1">main.tf</span></strong><span class="koboSpan" id="kobo.2013.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.2014.1">as well.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2015.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2016.1">At this point, we should have two </span><strong class="source-inline"><span class="koboSpan" id="kobo.2017.1">main.tf</span></strong><span class="koboSpan" id="kobo.2018.1"> files: (1) </span><strong class="source-inline"><span class="koboSpan" id="kobo.2019.1">~/vulnerable_s3_lab/main.tf</span></strong><span class="koboSpan" id="kobo.2020.1"> and (</span><span class="No-Break"><span class="koboSpan" id="kobo.2021.1">2) </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2022.1">~/backend/main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2023.1">.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.2024.1">Now that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.2025.1">~/backend/main.tf</span></strong><span class="koboSpan" id="kobo.2026.1"> file is ready, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2027.1">terraform init</span></strong><span class="koboSpan" id="kobo.2028.1"> command to initialize the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.2029.1">working directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2030.1">terraform init</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2031.1">Next, let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2032.1">terraform plan</span></strong><span class="koboSpan" id="kobo.2033.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.2034.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2035.1">terraform plan</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2036.1">With everything ready, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2037.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2038.1"> command to implement the changes specified in the execution plan returned after running </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2039.1">terraform plan</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2040.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2041.1">terraform apply -auto-approve</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2042.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2043.1">Wait for a few minutes for this step to complete. </span><span class="koboSpan" id="kobo.2043.2">After successfully running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2044.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2045.1"> command, we should have a new S3 bucket and a new DynamoDB table. </span><span class="koboSpan" id="kobo.2045.2">Let’s label these resources </span><strong class="source-inline"><span class="koboSpan" id="kobo.2046.1">BACKEND_S3</span></strong><span class="koboSpan" id="kobo.2047.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2048.1">BACKEND_TABLE</span></strong><span class="koboSpan" id="kobo.2049.1"> respectively as we will refer to these resources multiple times in this chapter. </span><span class="koboSpan" id="kobo.2049.2">Note that this S3 bucket will be used for the Terraform remote backend and is different from the intentionally misconfigured S3 bucket used for the vulnerable lab environment (which we will label </span><strong class="source-inline"><span class="koboSpan" id="kobo.2050.1">VULNERABLE_S3</span></strong><span class="koboSpan" id="kobo.2051.1">). </span><span class="koboSpan" id="kobo.2051.2">With the Terraform remote backend ready, we can now proceed with configuring our existing Terraform code to use this remote backend. </span><span class="koboSpan" id="kobo.2051.3">Make sure to take note of the names of the AWS S3 bucket (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2052.1">BACKEND_S3</span></strong><span class="koboSpan" id="kobo.2053.1">) and DynamoDB table (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2054.1">BACKEND_TABLE</span></strong><span class="koboSpan" id="kobo.2055.1">) resources created after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2056.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2057.1"> command before proceeding. </span><span class="koboSpan" id="kobo.2057.2">You may use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2058.1">terraform show</span></strong><span class="koboSpan" id="kobo.2059.1"> command to inspect the existing infrastructure resources managed </span><span class="No-Break"><span class="koboSpan" id="kobo.2060.1">by Terraform.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.2061.1">Navigate</span><a id="_idIndexMarker347"/><span class="koboSpan" id="kobo.2062.1"> back to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2063.1">vulnerable_s3_lab</span></strong><span class="koboSpan" id="kobo.2064.1"> directory using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2065.1">cd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2066.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2067.1">cd ~/vulnerable_s3_lab</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2068.1">Run the following command to open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2069.1">main.tf</span></strong><span class="koboSpan" id="kobo.2070.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.2071.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2072.1">vim main.tf</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2073.1">Next, press </span><em class="italic"><span class="koboSpan" id="kobo.2074.1">i</span></em><span class="koboSpan" id="kobo.2075.1"> to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.2076.1">insert mode</span></strong><span class="koboSpan" id="kobo.2077.1"> so that we can edit </span><span class="No-Break"><span class="koboSpan" id="kobo.2078.1">the file.</span></span></li>
<li><span class="koboSpan" id="kobo.2079.1">Locate the following block of code using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2080.1">arrow keys:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2081.1">
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~&gt; 4.0"
    }
  }
}</span></pre></li> <li><span class="koboSpan" id="kobo.2082.1">Once </span><a id="_idIndexMarker348"/><span class="koboSpan" id="kobo.2083.1">you’ve located the previous block of code, update it with the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.2084.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2085.1">
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~&gt; 4.0"
    }
  }
  backend "s3" {
    bucket         = "</span><strong class="bold"><span class="koboSpan" id="kobo.2086.1">&lt;INSERT BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.2087.1">"
    key            = "terraform/terraform.tfstate"
    region         = "us-east-1"
    dynamodb_table = "</span><strong class="bold"><span class="koboSpan" id="kobo.2088.1">&lt;INSERT TABLE NAME&gt;</span></strong><span class="koboSpan" id="kobo.2089.1">"
    encrypt        = true
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2090.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2091.1">&lt;INSERT BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.2092.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2093.1">&lt;INSERT TABLE NAME&gt;</span></strong><span class="koboSpan" id="kobo.2094.1"> with the S3 bucket (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2095.1">BACKEND_S3</span></strong><span class="koboSpan" id="kobo.2096.1">) and DynamoDB table (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2097.1">BACKEND_TABLE</span></strong><span class="koboSpan" id="kobo.2098.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.2099.1">names respectively.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2100.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2101.1">Here, we will specify the resource names of the existing S3 bucket (labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.2102.1">BACKEND_S3</span></strong><span class="koboSpan" id="kobo.2103.1">) and DynamoDB table (labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.2104.1">BACKEND_TABLE</span></strong><span class="koboSpan" id="kobo.2105.1">) resources created in an earlier step for the Terraform remote backend setup. </span><span class="koboSpan" id="kobo.2105.2">Note that </span><strong class="source-inline"><span class="koboSpan" id="kobo.2106.1">BACKEND_S3</span></strong><span class="koboSpan" id="kobo.2107.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2108.1">BACKEND_TABLE</span></strong><span class="koboSpan" id="kobo.2109.1"> are just arbitrary labels we’ve used in this chapter to make it easier for us to refer to the resources we created in earlier steps. </span><span class="koboSpan" id="kobo.2109.2">That said, these are </span><em class="italic"><span class="koboSpan" id="kobo.2110.1">not</span></em><span class="koboSpan" id="kobo.2111.1"> the resource names that will be used to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2112.1">&lt;INSERT BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.2113.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2114.1">&lt;INSERT TABLE NAME&gt;</span></strong><span class="koboSpan" id="kobo.2115.1"> in the code block. </span><span class="koboSpan" id="kobo.2115.2">Feel free to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2116.1">terraform show</span></strong><span class="koboSpan" id="kobo.2117.1"> command again inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2118.1">~/backend</span></strong><span class="koboSpan" id="kobo.2119.1"> directory to get the </span><span class="No-Break"><span class="koboSpan" id="kobo.2120.1">resource names.</span></span></p>
<ol>
<li value="19"><span class="koboSpan" id="kobo.2121.1">Now</span><a id="_idIndexMarker349"/><span class="koboSpan" id="kobo.2122.1"> that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.2123.1">~/vulnerable_s3_lab/main.tf</span></strong><span class="koboSpan" id="kobo.2124.1"> file has been updated, let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2125.1">terraform fmt</span></strong><span class="koboSpan" id="kobo.2126.1"> to format our </span><span class="No-Break"><span class="koboSpan" id="kobo.2127.1">Terraform code:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2128.1">terraform fmt</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2129.1">Here, we are using </span><strong class="source-inline"><span class="koboSpan" id="kobo.2130.1">terraform fmt</span></strong><span class="koboSpan" id="kobo.2131.1"> to ensure a consistent coding style across all Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.2132.1">configuration files.</span></span></p></li> <li><span class="koboSpan" id="kobo.2133.1">Let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2134.1">terraform init</span></strong><span class="koboSpan" id="kobo.2135.1"> command to reinitialize the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.2136.1">working directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2137.1">terraform init</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2138.1">Next, let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2139.1">terraform plan</span></strong><span class="koboSpan" id="kobo.2140.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.2141.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2142.1">terraform plan</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2143.1">Now, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2144.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2145.1">apply</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2146.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2147.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2148.1">This will create a misconfigured S3 bucket (labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.2149.1">VULNERABLE_S3</span></strong><span class="koboSpan" id="kobo.2150.1">) for our vulnerable </span><span class="No-Break"><span class="koboSpan" id="kobo.2151.1">lab environment.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2152.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2153.1">In case you encounter issues running </span><strong class="source-inline"><span class="koboSpan" id="kobo.2154.1">terraform apply -auto-approve</span></strong><span class="koboSpan" id="kobo.2155.1">, feel free to rerun the same command as this may solve these issues automatically without having to modify the Terraform code. </span><span class="koboSpan" id="kobo.2155.2">Note that an alternative for resolving issues would be to delete the resources first using </span><strong class="source-inline"><span class="koboSpan" id="kobo.2156.1">terraform destroy -auto-approve</span></strong><span class="koboSpan" id="kobo.2157.1"> and then create the resources again with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2158.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2159.1">apply -auto-approve</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2160.1">.</span></span></p>
<ol>
<li value="23"><span class="koboSpan" id="kobo.2161.1">Before we</span><a id="_idIndexMarker350"/><span class="koboSpan" id="kobo.2162.1"> celebrate, let’s verify whether the S3 bucket used for the backend (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2163.1">BACKEND_S3</span></strong><span class="koboSpan" id="kobo.2164.1">) has the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2165.1">terraform.tfstate</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2166.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2167.1">
aws s3 ls s3://</span><strong class="bold"><span class="koboSpan" id="kobo.2168.1">&lt;S3 BACKEND BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.2169.1"> --recursive</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2170.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2171.1">&lt;S3 BACKEND BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.2172.1"> with the name of the S3 bucket (labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.2173.1">BACKEND_S3</span></strong><span class="koboSpan" id="kobo.2174.1">) used for the Terraform backend specified in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.2175.1">~/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2176.1">backend/main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2177.1"> file.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.2178.1">After running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2179.1">aws s3 ls</span></strong><span class="koboSpan" id="kobo.2180.1"> command, we should get the </span><span class="No-Break"><span class="koboSpan" id="kobo.2181.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2182.1">... </span><span class="koboSpan" id="kobo.2182.2">terraform/terraform.tfstate</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2183.1">This means that we have successfully reconfigured our Terraform code to store the state file inside an S3 bucket (instead of the </span><span class="No-Break"><span class="koboSpan" id="kobo.2184.1">local directory).</span></span></p></li> <li><span class="koboSpan" id="kobo.2185.1">Next, let’s open a new browser tab and navigate to the home page of the AWS </span><span class="No-Break"><span class="koboSpan" id="kobo.2186.1">Management Console.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2187.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2188.1">Do not close the browser tab where we are running commands inside the AWS </span><span class="No-Break"><span class="koboSpan" id="kobo.2189.1">CloudShell terminal.</span></span></p>
<ol>
<li value="25"><span class="koboSpan" id="kobo.2190.1">Navigate</span><a id="_idIndexMarker351"/><span class="koboSpan" id="kobo.2191.1"> to the DynamoDB console by typing </span><strong class="source-inline"><span class="koboSpan" id="kobo.2192.1">dynamodb</span></strong><span class="koboSpan" id="kobo.2193.1"> in the search bar and then selecting </span><strong class="bold"><span class="koboSpan" id="kobo.2194.1">DynamoDB</span></strong><span class="koboSpan" id="kobo.2195.1"> from the list of results. </span><span class="koboSpan" id="kobo.2195.2">In the navigation pane on the left side of the DynamoDB console, choose </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2196.1">PartiQL editor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2197.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2198.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2199.1">If you are wondering </span><a id="_idIndexMarker352"/><span class="koboSpan" id="kobo.2200.1">what </span><strong class="bold"><span class="koboSpan" id="kobo.2201.1">PartiQL</span></strong><span class="koboSpan" id="kobo.2202.1"> is, it is simply a SQL-compatible query language for DynamoDB. </span><span class="koboSpan" id="kobo.2202.2">With PartiQL, we can query our DynamoDB tables similarly to how we would query our SQL database tables. </span><span class="koboSpan" id="kobo.2202.3">This allows us to leverage our existing SQL knowledge and skills when working with DynamoDB, making it easier to write and execute complex queries against our </span><span class="No-Break"><span class="koboSpan" id="kobo.2203.1">NoSQL data.</span></span></p>
<ol>
<li value="26"><span class="koboSpan" id="kobo.2204.1">Specify the following query in the PartiQL editor (</span><span class="No-Break"><span class="koboSpan" id="kobo.2205.1">text area):</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2206.1">
SELECT * FROM "</span><strong class="bold"><span class="koboSpan" id="kobo.2207.1">&lt;INSERT TABLE NAME&gt;</span></strong><span class="koboSpan" id="kobo.2208.1">";</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2209.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2210.1">&lt;INSERT TABLE NAME&gt;</span></strong><span class="koboSpan" id="kobo.2211.1"> with the name of the DynamoDB table (labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.2212.1">BACKEND_TABLE</span></strong><span class="koboSpan" id="kobo.2213.1">) we created (using Terraform) in an earlier step in </span><span class="No-Break"><span class="koboSpan" id="kobo.2214.1">this section.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2215.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2216.1">Feel free to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2217.1">terraform show</span></strong><span class="koboSpan" id="kobo.2218.1"> command again inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2219.1">~/backend</span></strong><span class="koboSpan" id="kobo.2220.1"> directory to get the resource name of the DynamoDB table we </span><span class="No-Break"><span class="koboSpan" id="kobo.2221.1">labeled </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2222.1">BACKEND_TABLE</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2223.1">.</span></span></p>
<ol>
<li value="27"><span class="koboSpan" id="kobo.2224.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2225.1">Run</span></strong><span class="koboSpan" id="kobo.2226.1"> button to execute </span><span class="No-Break"><span class="koboSpan" id="kobo.2227.1">the query.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.2228.1">Our query should return a single item where the </span><strong class="bold"><span class="koboSpan" id="kobo.2229.1">LockID</span></strong><span class="koboSpan" id="kobo.2230.1"> value is </span><strong class="source-inline"><span class="koboSpan" id="kobo.2231.1">&lt;BACKEND_S3 BUCKET NAME&gt;/terraform/terraform.tfstate-md5</span></strong><span class="koboSpan" id="kobo.2232.1">. </span><span class="koboSpan" id="kobo.2232.2">This item should also have a randomly generated alphanumeric </span><strong class="bold"><span class="koboSpan" id="kobo.2233.1">Digest</span></strong><span class="koboSpan" id="kobo.2234.1"> value similar to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2235.1">51f8a19d543d54b0481f1823b1784896</span></strong><span class="koboSpan" id="kobo.2236.1">. </span><span class="koboSpan" id="kobo.2236.2">This </span><strong class="source-inline"><span class="koboSpan" id="kobo.2237.1">digest</span></strong><span class="koboSpan" id="kobo.2238.1"> value is a representation of the Terraform state file’s content. </span><span class="koboSpan" id="kobo.2238.2">It is used to detect changes in the state file and ensure consistency during operations such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2239.1">plan</span></strong><span class="koboSpan" id="kobo.2240.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2241.1">apply</span></strong><span class="koboSpan" id="kobo.2242.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2243.1">destroy</span></strong><span class="koboSpan" id="kobo.2244.1">. </span><span class="koboSpan" id="kobo.2244.2">When we modify the infrastructure, Terraform will make changes to the state file, but the digest itself will not change unless the content of the state file has changed. </span><span class="koboSpan" id="kobo.2244.3">That said, this value acts as a checksum or hash of the state file’s content, which allows Terraform to determine whether the state file has been modified externally (or whether there are concurrent modifications that may result </span><span class="No-Break"><span class="koboSpan" id="kobo.2245.1">in conflicts).</span></span></p></li>
<li><span class="koboSpan" id="kobo.2246.1">Finally, navigate back to the</span><a id="_idIndexMarker353"/><span class="koboSpan" id="kobo.2247.1"> CloudShell browser tab and then use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2248.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.2249.1"> command to clean up the resources we </span><span class="No-Break"><span class="koboSpan" id="kobo.2250.1">created earlier:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2251.1">terraform destroy</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2252.1">During the verification step (that is, when you see </span><strong class="bold"><span class="koboSpan" id="kobo.2253.1">Enter a value:</span></strong><span class="koboSpan" id="kobo.2254.1">), type in </span><strong class="source-inline"><span class="koboSpan" id="kobo.2255.1">yes</span></strong><span class="koboSpan" id="kobo.2256.1"> to proceed with the deletion of </span><span class="No-Break"><span class="koboSpan" id="kobo.2257.1">the resources.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2258.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2259.1">The resources deleted in the last step do not include the Terraform backend resources (that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2260.1">BACKEND_S3</span></strong><span class="koboSpan" id="kobo.2261.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2262.1">BACKEND_TABLE</span></strong><span class="koboSpan" id="kobo.2263.1">) as these resources were defined </span><span class="No-Break"><span class="koboSpan" id="kobo.2264.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2265.1">~/backend/main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2266.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.2267.1">We’re not done yet! </span><span class="koboSpan" id="kobo.2267.2">In the next section, we will verify whether our state-locking setup </span><span class="No-Break"><span class="koboSpan" id="kobo.2268.1">is working.</span></span></p>
<h1 id="_idParaDest-60"><a id="_idTextAnchor059"/><span class="koboSpan" id="kobo.2269.1">Verifying the state-locking setup</span></h1>
<p><span class="koboSpan" id="kobo.2270.1">Verifying the Terraform state-lock setup</span><a id="_idIndexMarker354"/><span class="koboSpan" id="kobo.2271.1"> is crucial to ensure the integrity of our infrastructure management process. </span><span class="koboSpan" id="kobo.2271.2">By verifying the state-lock setup, we can confirm that the distributed lock mechanism using S3 and DynamoDB from the previous section is functioning correctly. </span><span class="koboSpan" id="kobo.2271.3">That said, what happens when two users attempt to run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2272.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2273.1"> almost at the same time? </span><span class="koboSpan" id="kobo.2273.2">We will see what happens in the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.2274.1">of steps!</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.2275.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2276.1">This scenario of concurrent </span><strong class="source-inline"><span class="koboSpan" id="kobo.2277.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2278.1"> commands highlights the importance of state locking to prevent conflicts and ensure data consistency. </span><span class="koboSpan" id="kobo.2278.2">In this section, we will explore how Terraform manages state locks and handles concurrent operations. </span><span class="koboSpan" id="kobo.2278.3">This will help us have a better understanding of the behavior and safeguards implemented by Terraform in </span><span class="No-Break"><span class="koboSpan" id="kobo.2279.1">such situations.</span></span></p>
<h2 id="_idParaDest-61"><a id="_idTextAnchor060"/><span class="koboSpan" id="kobo.2280.1">Part 1 of 4 – Adding a 60-second delay to the upload script</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.2281.1">Continuing</span><a id="_idIndexMarker355"/><span class="koboSpan" id="kobo.2282.1"> from where we left off in the previous section, let’s navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2283.1">vulnerable_s3_lab</span></strong><span class="koboSpan" id="kobo.2284.1"> directory using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2285.1">cd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2286.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2287.1">cd ~/vulnerable_s3_lab</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2288.1">Run the following command to open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2289.1">upload.sh</span></strong><span class="koboSpan" id="kobo.2290.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.2291.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2292.1">vim upload.sh</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2293.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2294.1">You may type </span><strong class="source-inline"><span class="koboSpan" id="kobo.2295.1">:set nu</span></strong><span class="koboSpan" id="kobo.2296.1"> and then press the </span><em class="italic"><span class="koboSpan" id="kobo.2297.1">Enter</span></em><span class="koboSpan" id="kobo.2298.1"> key to show the </span><span class="No-Break"><span class="koboSpan" id="kobo.2299.1">line numbers.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2300.1">Use the arrow keys to put the cursor before the first character of the first line. </span><span class="koboSpan" id="kobo.2300.2">After that, press </span><em class="italic"><span class="koboSpan" id="kobo.2301.1">i</span></em><span class="koboSpan" id="kobo.2302.1"> to switch to insert mode so that we can edit </span><span class="No-Break"><span class="koboSpan" id="kobo.2303.1">the file.</span></span></li>
<li><span class="koboSpan" id="kobo.2304.1">Add the following lines of code at the start of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2305.1">upload.sh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2306.1"> script:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2307.1">
echo "Sleeping for 60 seconds"
sleep 60</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2308.1">The 2 lines added at the start of the script should make the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2309.1">upload.sh</span></strong><span class="koboSpan" id="kobo.2310.1"> script run 60 seconds longer. </span><span class="koboSpan" id="kobo.2310.2">This should give us a few extra seconds to run the commands needed to verify whether the state-locking setup </span><span class="No-Break"><span class="koboSpan" id="kobo.2311.1">is working.</span></span></p></li> <li><span class="koboSpan" id="kobo.2312.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.2313.1">Esc</span></em><span class="koboSpan" id="kobo.2314.1"> key to switch to normal mode. </span><span class="koboSpan" id="kobo.2314.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.2315.1">:wq!</span></strong><span class="koboSpan" id="kobo.2316.1">. </span><span class="koboSpan" id="kobo.2316.2">Press </span><em class="italic"><span class="koboSpan" id="kobo.2317.1">Enter</span></em><span class="koboSpan" id="kobo.2318.1"> afterward. </span><span class="koboSpan" id="kobo.2318.2">This will save the changes made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2319.1">upload.sh</span></strong><span class="koboSpan" id="kobo.2320.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.2321.1">as well.</span></span></li>
<li><span class="koboSpan" id="kobo.2322.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2323.1">cat</span></strong><span class="koboSpan" id="kobo.2324.1"> command (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2325.1">cat upload.sh</span></strong><span class="koboSpan" id="kobo.2326.1">) to verify our updated </span><strong class="source-inline"><span class="koboSpan" id="kobo.2327.1">upload.sh</span></strong><span class="koboSpan" id="kobo.2328.1"> file looks similar to </span><a id="_idIndexMarker356"/><span class="koboSpan" id="kobo.2329.1">what we have in the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.2330.1">of code:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2331.1">echo "Sleeping for 60 seconds"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2332.1">sleep 60</span></strong><span class="koboSpan" id="kobo.2333.1">
mkdir files
cd files
SOURCE=</span><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/raw/main/ch03/sample_website.zip"><span class="koboSpan" id="kobo.2334.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/raw/main/ch03/sample_website.zip</span></a><span class="koboSpan" id="kobo.2335.1">
wget $SOURCE -O sample_website.zip
unzip sample_website.zip
rm sample_website.zip
aws s3 cp --recursive . </span><span class="koboSpan" id="kobo.2335.2">s3://$1</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2336.1">Here, we basically have the same </span><strong class="source-inline"><span class="koboSpan" id="kobo.2337.1">upload.sh</span></strong><span class="koboSpan" id="kobo.2338.1"> file except that the first 2 lines have been added to add a 60-second delay when running </span><span class="No-Break"><span class="koboSpan" id="kobo.2339.1">the script.</span></span></p></li> </ol>
<h2 id="_idParaDest-62"><a id="_idTextAnchor061"/><span class="koboSpan" id="kobo.2340.1">Part 2 of 4 – Acquiring the state lock</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.2341.1">Now, let’s split </span><a id="_idIndexMarker357"/><span class="koboSpan" id="kobo.2342.1">the CloudShell terminal screen vertically. </span><span class="koboSpan" id="kobo.2342.2">Press the </span><em class="italic"><span class="koboSpan" id="kobo.2343.1">Ctrl</span></em><span class="koboSpan" id="kobo.2344.1"> key while pressing </span><em class="italic"><span class="koboSpan" id="kobo.2345.1">b</span></em><span class="koboSpan" id="kobo.2346.1">. </span><span class="koboSpan" id="kobo.2346.2">Release both keys and then press </span><em class="italic"><span class="koboSpan" id="kobo.2347.1">%</span></em><span class="koboSpan" id="kobo.2348.1"> (or </span><em class="italic"><span class="koboSpan" id="kobo.2349.1">Shift</span></em><span class="koboSpan" id="kobo.2350.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.2351.1">5</span></em><span class="koboSpan" id="kobo.2352.1">) after about half a second. </span><span class="koboSpan" id="kobo.2352.2">This should create a vertical split similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2353.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2354.1">.13</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2355.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer061">
<span class="koboSpan" id="kobo.2356.1"><img alt="" src="image/B19755_03_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2357.1">Figure 3.13 – Vertical split in tmux</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2358.1">Since AWS</span><a id="_idIndexMarker358"/><span class="koboSpan" id="kobo.2359.1"> CloudShell comes pre-installed with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2360.1">tmux</span></strong><span class="koboSpan" id="kobo.2361.1">, we should be able to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2362.1">tmux</span></strong><span class="koboSpan" id="kobo.2363.1"> commands directly without having to install the </span><span class="No-Break"><span class="koboSpan" id="kobo.2364.1">utility separately.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2365.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2366.1">If this is your first time using </span><strong class="source-inline"><span class="koboSpan" id="kobo.2367.1">tmux</span></strong><span class="koboSpan" id="kobo.2368.1">, do not worry as it may take a few tries before getting the key combinations right! </span><span class="koboSpan" id="kobo.2368.2">Feel free to watch this tutorial video for more information on how to</span><a id="_idIndexMarker359"/><span class="koboSpan" id="kobo.2369.1"> use </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2370.1">tmux</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2371.1">: </span></span><a href="https://www.youtube.com/watch?v=Yl7NFenTgIo"><span class="No-Break"><span class="koboSpan" id="kobo.2372.1">https://www.youtube.com/watch?v=Yl7NFenTgIo</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2373.1">.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.2374.1">Let’s jump to the left pane. </span><span class="koboSpan" id="kobo.2374.2">Press the </span><em class="italic"><span class="koboSpan" id="kobo.2375.1">Ctrl</span></em><span class="koboSpan" id="kobo.2376.1"> key while pressing </span><em class="italic"><span class="koboSpan" id="kobo.2377.1">b</span></em><span class="koboSpan" id="kobo.2378.1">. </span><span class="koboSpan" id="kobo.2378.2">Release both keys and then press the </span><em class="italic"><span class="koboSpan" id="kobo.2379.1">left arrow</span></em><span class="koboSpan" id="kobo.2380.1"> key after about half </span><span class="No-Break"><span class="koboSpan" id="kobo.2381.1">a second.</span></span></li>
<li><span class="koboSpan" id="kobo.2382.1">Now, run the following command on the </span><span class="No-Break"><span class="koboSpan" id="kobo.2383.1">left pane:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2384.1">cd ~/vulnerable_s3_lab &amp;&amp; terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2385.1">This should yield a set of logs similar to the logs generated after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2386.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2387.1"> command in </span><a id="_idIndexMarker360"/><span class="koboSpan" id="kobo.2388.1">the </span><em class="italic"><span class="koboSpan" id="kobo.2389.1">Building our vulnerable lab environment with Terraform</span></em><span class="koboSpan" id="kobo.2390.1"> section of this chapter. </span><span class="koboSpan" id="kobo.2390.2">You may ignore any </span><strong class="source-inline"><span class="koboSpan" id="kobo.2391.1">AccessDenied</span></strong><span class="koboSpan" id="kobo.2392.1"> error messages as these can easily be solved by retrying the command in the left pane (which we don't need to do at </span><span class="No-Break"><span class="koboSpan" id="kobo.2393.1">this point).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2394.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2395.1">Running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2396.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2397.1"> command will acquire a state lock to ensure that concurrent operations do not modify the infrastructure state simultaneously. </span><span class="koboSpan" id="kobo.2397.2">This lock is essential for maintaining consistency and preventing conflicts in collaborative or automated environments. </span><span class="koboSpan" id="kobo.2397.3">By acquiring the lock before making any modifications, we ensure that multiple </span><strong class="source-inline"><span class="koboSpan" id="kobo.2398.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2399.1"> commands wait for the lock to be released before proceeding. </span><span class="koboSpan" id="kobo.2399.2">That said, do </span><em class="italic"><span class="koboSpan" id="kobo.2400.1">not</span></em><span class="koboSpan" id="kobo.2401.1"> wait for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2402.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2403.1"> command to finish! </span><span class="koboSpan" id="kobo.2403.2">Proceed to the next set of steps right after running the command on the </span><span class="No-Break"><span class="koboSpan" id="kobo.2404.1">left pane.</span></span></p>
<h2 id="_idParaDest-63"><a id="_idTextAnchor062"/><span class="koboSpan" id="kobo.2405.1">Part 3 of 4 – Testing our state-lock setup</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.2406.1">To test </span><a id="_idIndexMarker361"/><span class="koboSpan" id="kobo.2407.1">our state-lock setup, we will run another </span><strong class="source-inline"><span class="koboSpan" id="kobo.2408.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2409.1"> command while the first </span><strong class="source-inline"><span class="koboSpan" id="kobo.2410.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2411.1"> command is still running. </span><span class="koboSpan" id="kobo.2411.2">That said, let’s jump to the right pane. </span><span class="koboSpan" id="kobo.2411.3">Press the </span><em class="italic"><span class="koboSpan" id="kobo.2412.1">Ctrl</span></em><span class="koboSpan" id="kobo.2413.1"> key while pressing </span><em class="italic"><span class="koboSpan" id="kobo.2414.1">b</span></em><span class="koboSpan" id="kobo.2415.1">. </span><span class="koboSpan" id="kobo.2415.2">Release both keys and then press the </span><em class="italic"><span class="koboSpan" id="kobo.2416.1">right arrow</span></em><span class="koboSpan" id="kobo.2417.1"> key after about half </span><span class="No-Break"><span class="koboSpan" id="kobo.2418.1">a second.</span></span></li>
<li><span class="koboSpan" id="kobo.2419.1">While the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2420.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2421.1"> command is running on the left pane, run the following command on the </span><span class="No-Break"><span class="koboSpan" id="kobo.2422.1">right pane:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2423.1">cd ~/vulnerable_s3_lab &amp;&amp; terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2424.1">This should give us an error similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2425.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2426.1">.14</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2427.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer062">
<span class="koboSpan" id="kobo.2428.1"><img alt="" src="image/B19755_03_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2429.1">Figure 3.14 – Error acquiring the state lock</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2430.1">This </span><a id="_idIndexMarker362"/><span class="koboSpan" id="kobo.2431.1">means that we can’t acquire a state lock at the moment while the first </span><strong class="source-inline"><span class="koboSpan" id="kobo.2432.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2433.1"> command is still running (in the left pane). </span><span class="koboSpan" id="kobo.2433.2">Once the command in the left pane succeeds (or fails due to an error), the state lock will be released. </span><em class="italic"><span class="koboSpan" id="kobo.2434.1">Is this the expected behavior? </span><span class="koboSpan" id="kobo.2434.2">YES!</span></em><span class="koboSpan" id="kobo.2435.1"> By acquiring the state lock in an earlier step, we have ensured that only one </span><strong class="source-inline"><span class="koboSpan" id="kobo.2436.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2437.1"> command can modify the state at a time. </span><span class="koboSpan" id="kobo.2437.2">This sequential approach guarantees consistency and prevents race conditions. </span><span class="koboSpan" id="kobo.2437.3">Therefore, it is normal for subsequent </span><strong class="source-inline"><span class="koboSpan" id="kobo.2438.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2439.1"> commands to wait until the initial command completes and releases the state lock </span><span class="No-Break"><span class="koboSpan" id="kobo.2440.1">before proceeding.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2441.1">Of course, there will be cases where the state lock is not released automatically (most likely due to an unexpected issue). </span><span class="koboSpan" id="kobo.2441.2">To resolve this issue, you may use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2442.1">terraform force-unlock -force &lt;ID&gt;</span></strong><span class="koboSpan" id="kobo.2443.1"> to manually unlock the state. </span><span class="koboSpan" id="kobo.2443.2">You can find the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2444.1">ID</span></strong><span class="koboSpan" id="kobo.2445.1"> value in the </span><strong class="bold"><span class="koboSpan" id="kobo.2446.1">Lock Info</span></strong><span class="koboSpan" id="kobo.2447.1"> section of the error message (similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2448.1">Figure 3</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2449.1">.14</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2450.1">).</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2451.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2452.1">In case you missed the timing (that is, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2453.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2454.1"> command in the left pane finished executing before you were able to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2455.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2456.1"> command in the right pane), feel free to destroy the created resources by running </span><strong class="source-inline"><span class="koboSpan" id="kobo.2457.1">terraform destroy -auto-approve</span></strong><span class="koboSpan" id="kobo.2458.1"> inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2459.1">~/vulnerable_s3_lab</span></strong><span class="koboSpan" id="kobo.2460.1"> directory so that you can try repeating the last set of steps. </span><span class="koboSpan" id="kobo.2460.2">You may also replace the 60-second delay with a 120-second delay by modifying the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2461.1">upload.sh</span></strong><span class="koboSpan" id="kobo.2462.1"> file to give you more time to jump between </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2463.1">tmux</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2464.1"> panes.</span></span></p>
<h2 id="_idParaDest-64"><a id="_idTextAnchor063"/><span class="koboSpan" id="kobo.2465.1">Part 4 of 4 – Cleaning up</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.2466.1">With our </span><a id="_idIndexMarker363"/><span class="koboSpan" id="kobo.2467.1">state-lock verification experiment complete, let’s exit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2468.1">tmux</span></strong><span class="koboSpan" id="kobo.2469.1"> session on the right pane using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2470.1">exit</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2471.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2472.1">exit</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2473.1">This should leave us with a single pane (removing the </span><span class="No-Break"><span class="koboSpan" id="kobo.2474.1">vertical split).</span></span></p></li> <li><span class="koboSpan" id="kobo.2475.1">Before we end this section, let’s use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2476.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.2477.1"> to clean up the resources we </span><span class="No-Break"><span class="koboSpan" id="kobo.2478.1">created earlier:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2479.1">terraform destroy</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2480.1">During the verification step (that is, when you see </span><strong class="bold"><span class="koboSpan" id="kobo.2481.1">Enter a value:</span></strong><span class="koboSpan" id="kobo.2482.1">), type in </span><strong class="source-inline"><span class="koboSpan" id="kobo.2483.1">yes</span></strong><span class="koboSpan" id="kobo.2484.1"> to proceed with the deletion of the resources. </span><span class="koboSpan" id="kobo.2484.2">This will delete the resources (primarily the S3 bucket labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.2485.1">VULNERABLE_S3</span></strong><span class="koboSpan" id="kobo.2486.1">) specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2487.1">main.tf</span></strong><span class="koboSpan" id="kobo.2488.1"> file inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2489.1">vulnerable_s3_lab</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2490.1"> directory.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2491.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2492.1">Feel free to delete the remaining S3 bucket (used as the remote state backend we labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.2493.1">BACKEND_S3</span></strong><span class="koboSpan" id="kobo.2494.1">) along with the DynamoDB table (labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.2495.1">BACKEND_TABLE</span></strong><span class="koboSpan" id="kobo.2496.1">) as well. </span><span class="koboSpan" id="kobo.2496.2">We will leave this to you as </span><span class="No-Break"><span class="koboSpan" id="kobo.2497.1">an exercise.</span></span></p>
<p><span class="koboSpan" id="kobo.2498.1">Wow! </span><span class="koboSpan" id="kobo.2498.2">That was one productive and action-packed chapter! </span><span class="koboSpan" id="kobo.2498.3">At this point, we should already have a good grasp of how we can utilize Terraform (along with IaC concepts and strategies) to create and configure cloud resources. </span><span class="koboSpan" id="kobo.2498.4">In the succeeding chapters, we will dive deeper into how the things we learned in this chapter play a pivotal role in building penetration testing labs in </span><span class="No-Break"><span class="koboSpan" id="kobo.2499.1">the cloud.</span></span></p>
<h1 id="_idParaDest-65"><a id="_idTextAnchor064"/><span class="koboSpan" id="kobo.2500.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.2501.1">In this chapter, we talked about how IaC can help us automatically prepare, configure, and manage our penetration testing lab environments in the cloud. </span><span class="koboSpan" id="kobo.2501.2">We then used Terraform, one of the most powerful and most used IaC tools available, to create, modify, and delete cloud infrastructure resources. </span><span class="koboSpan" id="kobo.2501.3">After setting up Terraform in our environment, we then proceeded with several hands-on examples to demonstrate the different capabilities of the tool. </span><span class="koboSpan" id="kobo.2501.4">In addition to this, we rebuilt the vulnerable lab environment we prepared in </span><span class="No-Break"><em class="italic"><a href="B19755_02.xhtml"><span class="koboSpan" id="kobo.2502.1">Chapter 2</span></a></em></span><span class="koboSpan" id="kobo.2503.1"> using Terraform (this time, automatically). </span><span class="koboSpan" id="kobo.2503.2">Finally, we had a quick look at how to configure a Terraform backend with state locking to help prevent conflicts when multiple engineers are using Terraform to modify </span><span class="No-Break"><span class="koboSpan" id="kobo.2504.1">infrastructure resources.</span></span></p>
<p><span class="koboSpan" id="kobo.2505.1">In the next chapter, we’ll dive deep into the different strategies for isolating accounts and environments in the cloud. </span><span class="koboSpan" id="kobo.2505.2">The information, along with the hands-on solutions in the next chapter, will help us secure and manage our penetration testing lab environments in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2506.1">cloud properly.</span></span></p>
<h1 id="_idParaDest-66"><a id="_idTextAnchor065"/><span class="koboSpan" id="kobo.2507.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.2508.1">For more information on the topics covered in this chapter, feel free to check out the </span><span class="No-Break"><span class="koboSpan" id="kobo.2509.1">following resources:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.2510.1">Finding the canonical user ID for your AWS </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2511.1">account</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2512.1"> (</span></span><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/finding-canonical-user-id.html"><span class="No-Break"><span class="koboSpan" id="kobo.2513.1">https://docs.aws.amazon.com/AmazonS3/latest/userguide/finding-canonical-user-id.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2514.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2515.1">Terraform Language </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2516.1">Documentation</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2517.1"> (</span></span><a href="https://developer.hashicorp.com/terraform/language"><span class="No-Break"><span class="koboSpan" id="kobo.2518.1">https://developer.hashicorp.com/terraform/language</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2519.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2520.1">Terraform—Remote </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2521.1">State</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2522.1"> (</span></span><a href="https://developer.hashicorp.com/terraform/language/state/remote"><span class="No-Break"><span class="koboSpan" id="kobo.2523.1">https://developer.hashicorp.com/terraform/language/state/remote</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2524.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2525.1">Terraform—State </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2526.1">Locking</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2527.1"> (</span></span><a href="https://developer.hashicorp.com/terraform/language/state/locking"><span class="No-Break"><span class="koboSpan" id="kobo.2528.1">https://developer.hashicorp.com/terraform/language/state/locking</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2529.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2530.1">Terraform—Recovering from State </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2531.1">Disasters</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2532.1"> (</span></span><a href="https://developer.hashicorp.com/terraform/cli/state/recover"><span class="No-Break"><span class="koboSpan" id="kobo.2533.1">https://developer.hashicorp.com/terraform/cli/state/recover</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2534.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2535.1">A Great Vim Cheat </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2536.1">Sheet</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2537.1"> (</span></span><a href="https://vimsheet.com/"><span class="No-Break"><span class="koboSpan" id="kobo.2538.1">https://vimsheet.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2539.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2540.1">Tmux Cheat Sheet &amp; Quick </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2541.1">Reference</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2542.1"> (</span></span><a href="https://tmuxcheatsheet.com/"><span class="No-Break"><span class="koboSpan" id="kobo.2543.1">https://tmuxcheatsheet.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2544.1">)</span></span></li>
</ul>
</div>


<div class="Content" id="_idContainer064">
<h1 id="_idParaDest-67" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor066"/><span class="koboSpan" id="kobo.1.1">Part 2:  Setting Up Isolated Penetration Testing Lab Environments in the Cloud</span></h1>
<p><span class="koboSpan" id="kobo.2.1">In this part, you will learn how to build and automate isolated penetration testing lab environments on AWS, Azure, </span><span class="No-Break"><span class="koboSpan" id="kobo.3.1">and GCP.</span></span></p>
<p><span class="koboSpan" id="kobo.4.1">This part contains the </span><span class="No-Break"><span class="koboSpan" id="kobo.5.1">following chapters:</span></span></p>
<ul>
<li><em class="italic"><a href="B19755_04.xhtml"><span class="koboSpan" id="kobo.6.1">Chapter 4</span></a></em><span class="koboSpan" id="kobo.7.1">, </span><em class="italic"><span class="koboSpan" id="kobo.8.1">Setting Up Isolated Penetration Testing Lab Environments on GCP</span></em></li>
<li><em class="italic"><a href="B19755_05.xhtml"><span class="koboSpan" id="kobo.9.1">Chapter 5</span></a></em><span class="koboSpan" id="kobo.10.1">, </span><em class="italic"><span class="koboSpan" id="kobo.11.1">Setting Up Isolated Penetration Testing Lab Environments on Azure</span></em></li>
<li><em class="italic"><a href="B19755_06.xhtml"><span class="koboSpan" id="kobo.12.1">Chapter 6</span></a></em><span class="koboSpan" id="kobo.13.1">, </span><em class="italic"><span class="koboSpan" id="kobo.14.1">Setting Up Isolated Penetration Testing Lab Environments on AWS</span></em></li>
</ul>
</div>
<div>
<div id="_idContainer065">
</div>
</div>
</body></html>