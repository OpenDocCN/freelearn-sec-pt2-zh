<html><head></head><body>
<div id="_idContainer111">
<h1 class="chapter-number" id="_idParaDest-68"><a id="_idTextAnchor067"/><span class="koboSpan" id="kobo.1.1">4</span></h1>
<h1 id="_idParaDest-69"><a id="_idTextAnchor068"/><span class="koboSpan" id="kobo.2.1">Setting Up Isolated Penetration Testing Lab Environments on GCP</span></h1>
<p><span class="koboSpan" id="kobo.3.1">While setting up cloud-based penetration testing labs, we are deliberately creating a vulnerable and misconfigured environment where we can practice various security techniques. </span><span class="koboSpan" id="kobo.3.2">It is critical that we secure the resources inside this lab environment from unauthorized external attacks and mitigate the risk of planned interference with any of the authorized testing activities or simulations inside the environment. </span><em class="italic"><span class="koboSpan" id="kobo.4.1">Imagine attackers managing to gain unauthorized access to vulnerable resources inside your penetration testing lab environment!</span></em><span class="koboSpan" id="kobo.5.1"> These attackers would be able to leverage the cloud resources to perform various malicious activities—including launching </span><strong class="bold"><span class="koboSpan" id="kobo.6.1">Distributed Denial-of-Service</span></strong><span class="koboSpan" id="kobo.7.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.8.1">DDoS</span></strong><span class="koboSpan" id="kobo.9.1">) attacks, attacking the systems owned by other users and </span><a id="_idIndexMarker364"/><span class="koboSpan" id="kobo.10.1">organizations, and even spreading malware from inside the compromised cloud account. </span><em class="italic"><span class="koboSpan" id="kobo.11.1">Scary, right?</span></em><span class="koboSpan" id="kobo.12.1"> By isolating vulnerable lab resources using a properly configured network environment, we can maintain a secure testing environment and minimize the risks associated with having penetration testing lab environments in </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1">the cloud.</span></span></p>
<p><span class="koboSpan" id="kobo.14.1">In this chapter, we will prepare an isolated network environment in </span><strong class="bold"><span class="koboSpan" id="kobo.15.1">Google Cloud Platform</span></strong><span class="koboSpan" id="kobo.16.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.17.1">GCP</span></strong><span class="koboSpan" id="kobo.18.1">) and</span><a id="_idIndexMarker365"/><span class="koboSpan" id="kobo.19.1"> use this network environment for setting up a penetration testing lab environment secured from unauthorized external attacks. </span><span class="koboSpan" id="kobo.19.2">Inside one of</span><a id="_idIndexMarker366"/><span class="koboSpan" id="kobo.20.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.21.1">Virtual Private Cloud</span></strong><span class="koboSpan" id="kobo.22.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.23.1">VPC</span></strong><span class="koboSpan" id="kobo.24.1">) networks of the overall network environment, we will set up a target </span><strong class="bold"><span class="koboSpan" id="kobo.25.1">virtual machine</span></strong><span class="koboSpan" id="kobo.26.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.27.1">VM</span></strong><span class="koboSpan" id="kobo.28.1">) instance</span><a id="_idIndexMarker367"/><span class="koboSpan" id="kobo.29.1"> that hosts an intentionally vulnerable web application </span><a id="_idIndexMarker368"/><span class="koboSpan" id="kobo.30.1">called the </span><strong class="bold"><span class="koboSpan" id="kobo.31.1">OWASP Juice Shop</span></strong><span class="koboSpan" id="kobo.32.1">. </span><span class="koboSpan" id="kobo.32.2">Then, in a separate VPC network, we will launch an attacker VM instance (running a penetration testing-focused Linux distribution called </span><strong class="bold"><span class="koboSpan" id="kobo.33.1">Kali Linux</span></strong><span class="koboSpan" id="kobo.34.1">) and</span><a id="_idIndexMarker369"/><span class="koboSpan" id="kobo.35.1"> configure it with browser-based access to its desktop environment. </span><span class="koboSpan" id="kobo.35.2">We will then establish VPC peering to create a connection between the target VPC network and the attacker VPC network. </span><span class="koboSpan" id="kobo.35.3">Finally, we will perform a quick penetration testing simulation inside the isolated network environment to verify that everything is </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">working correctly.</span></span></p>
<p><span class="koboSpan" id="kobo.37.1">That said, we will cover the following topics in </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.39.1">Preparing the necessary components </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">and prerequisites</span></span></li>
<li><span class="koboSpan" id="kobo.41.1">Defining the </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">project structure</span></span></li>
<li><span class="koboSpan" id="kobo.43.1">Preparing the </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">isolated network</span></span></li>
<li><span class="koboSpan" id="kobo.45.1">Setting up the target </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">VM instance</span></span></li>
<li><span class="koboSpan" id="kobo.47.1">Importing the Kali Linux Generic </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">Cloud Image</span></span></li>
<li><span class="koboSpan" id="kobo.49.1">Manually setting up the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.50.1">VM instance</span></span></li>
<li><span class="koboSpan" id="kobo.51.1">Leveraging Terraform to automatically set up the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">VM instance</span></span></li>
<li><span class="koboSpan" id="kobo.53.1">Simulating penetration testing in an isolated </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">network environment</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.55.1">Cleaning up</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.56.1">In the first few chapters of this book, we primarily focused on using AWS when setting up penetration testing lab environments in the cloud. </span><span class="koboSpan" id="kobo.56.2">However, in this chapter, our attention will shift to GCP, where we will deploy various cloud resources inside a new GCP account. </span><span class="koboSpan" id="kobo.56.3">Since its introduction in 2008, GCP has rapidly evolved to offer a diverse range of infrastructure and platform services—including VMs and database services, along with data engineering and </span><strong class="bold"><span class="koboSpan" id="kobo.57.1">machine learning</span></strong><span class="koboSpan" id="kobo.58.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.59.1">ML</span></strong><span class="koboSpan" id="kobo.60.1">) services. </span><span class="koboSpan" id="kobo.60.2">That said, it is essential for us to explore the process of building penetration testing lab environments within this mature and versatile </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">cloud platform.</span></span></p>
<p><span class="koboSpan" id="kobo.62.1">With these points in mind, </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">let’s begin!</span></span></p>
<h1 id="_idParaDest-70"><a id="_idTextAnchor069"/><span class="koboSpan" id="kobo.64.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.65.1">Before we start, we must have the </span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">following ready:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.67.1">A GCP account</span></strong><span class="koboSpan" id="kobo.68.1">—You may start with a free trial account by completing the steps specified in the</span><a id="_idIndexMarker370"/><span class="koboSpan" id="kobo.69.1"> following link: </span><a href="https://cloud.google.com/free/"><span class="koboSpan" id="kobo.70.1">https://cloud.google.com/free/</span></a><span class="koboSpan" id="kobo.71.1">. </span><span class="koboSpan" id="kobo.71.2">In case you have not set up a billing account in your GCP account, make sure that you have properly set up billing information/profile so that you can access and use the GCP services without interruption. </span><span class="koboSpan" id="kobo.71.3">For more information on how to create a billing account, check the following </span><span class="No-Break"><span class="koboSpan" id="kobo.72.1">link: </span></span><a href="https://www.youtube.com/watch?v=NeRYUoR4u0s"><span class="No-Break"><span class="koboSpan" id="kobo.73.1">https://www.youtube.com/watch?v=NeRYUoR4u0s</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.74.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.75.1">Any text editor (such as Notepad++, Visual Studio Code, or Sublime Text) where we can temporarily store specific values (for example, your local machine’s IP address) used in the hands-on solutions in </span><span class="No-Break"><span class="koboSpan" id="kobo.76.1">this chapter.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.77.1">You may proceed with the next steps once these </span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">are ready.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.79.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.80.1">Make sure </span><em class="italic"><span class="koboSpan" id="kobo.81.1">NOT</span></em><span class="koboSpan" id="kobo.82.1"> to use any existing GCP account with production (or staging) environment resources for the hands-on exercises and solutions in this book. </span><span class="koboSpan" id="kobo.82.2">It is strongly recommended to create a </span><em class="italic"><span class="koboSpan" id="kobo.83.1">new</span></em><span class="koboSpan" id="kobo.84.1"> GCP account specifically for launching intentionally vulnerable resources. </span><span class="koboSpan" id="kobo.84.2">This will ensure that your production (or staging) environment resources remain separate and secure. </span><span class="koboSpan" id="kobo.84.3">In addition to this, make sure to read the available documentation along with the FAQs to have a solid understanding of what is free (and what is not free) when creating resources in GCP. </span><span class="koboSpan" id="kobo.84.4">For more information, see the following </span><span class="No-Break"><span class="koboSpan" id="kobo.85.1">link: </span></span><a href="https://cloud.google.com/free/docs/free-cloud-features"><span class="No-Break"><span class="koboSpan" id="kobo.86.1">https://cloud.google.com/free/docs/free-cloud-features</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.87.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.88.1">The source code and other files used for each chapter are available in this book’s GitHub repository </span><span class="No-Break"><span class="koboSpan" id="kobo.89.1">at </span></span><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud"><span class="No-Break"><span class="koboSpan" id="kobo.90.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.91.1">.</span></span></p>
<h1 id="_idParaDest-71"><a id="_idTextAnchor070"/><span class="koboSpan" id="kobo.92.1">Preparing the necessary components and prerequisites</span></h1>
<p><span class="koboSpan" id="kobo.93.1">In this section, we will focus on preparing the prerequisites needed for this chapter. </span><span class="koboSpan" id="kobo.93.2">We will start by retrieving the IP address of your local machine. </span><span class="koboSpan" id="kobo.93.3">We’ll use this IP address value later when configuring the firewall rules to allow our local machine to access specific resources inside the lab environment. </span><span class="koboSpan" id="kobo.93.4">In addition to this, we will also set up the Google Cloud project where the cloud resources will be deployed in </span><span class="No-Break"><span class="koboSpan" id="kobo.94.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.95.1">Lastly, we will generate SSH </span><a id="_idIndexMarker371"/><span class="koboSpan" id="kobo.96.1">keys (a </span><strong class="bold"><span class="koboSpan" id="kobo.97.1">public key</span></strong><span class="koboSpan" id="kobo.98.1"> and</span><a id="_idIndexMarker372"/><span class="koboSpan" id="kobo.99.1"> a </span><strong class="bold"><span class="koboSpan" id="kobo.100.1">private key</span></strong><span class="koboSpan" id="kobo.101.1">) for accessing the attacker VM instance later in this chapter. </span><span class="koboSpan" id="kobo.101.2">As we can see in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.102.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.103.1">.1</span></em><span class="koboSpan" id="kobo.104.1">, the</span><a id="_idIndexMarker373"/><span class="koboSpan" id="kobo.105.1"> private key will be stored inside your local machine while the public key will be stored inside the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">VM instance.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer066">
<span class="koboSpan" id="kobo.107.1"><img alt="" src="image/B19755_04_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.108.1">Figure 4.1 – Generating SSH keys for accessing the attacker VM instance</span></p>
<p><span class="koboSpan" id="kobo.109.1">With this setup, the server (the attacker VM instance) can confirm the identity of the client (your local machine) using the private key without having to transmit sensitive credentials. </span><span class="koboSpan" id="kobo.109.2">This will then allow us to access the attacker VM instance via SSH and establish a secure connection</span><a id="_idIndexMarker374"/><span class="koboSpan" id="kobo.110.1"> for running commands and managing the </span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">instance remotely.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.112.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.113.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.114.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.115.1">.1</span></em><span class="koboSpan" id="kobo.116.1">, we can see the target VM instance along with the other components of the penetration testing lab environment. </span><span class="koboSpan" id="kobo.116.2">We will dive deeper into how the other resources in the lab environment will be configured in the succeeding sections of </span><span class="No-Break"><span class="koboSpan" id="kobo.117.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.118.1">That said, we’ll divide this section into three parts, </span><span class="No-Break"><span class="koboSpan" id="kobo.119.1">as follows:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.120.1">Part 1 of 3 – Retrieving the IP address of your </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.121.1">local machine</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.122.1">Part 2 of 3 – Setting up the Google </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.123.1">Cloud project</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.124.1">Part 3 of 3 – Generating SSH keys to access the attacker </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.125.1">VM instance</span></em></span></li>
</ul>
<p><span class="koboSpan" id="kobo.126.1">With these points in mind, let’s proceed with the preparation of the necessary components and prerequisites for </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">this chapter.</span></span></p>
<h2 id="_idParaDest-72"><a id="_idTextAnchor071"/><span class="koboSpan" id="kobo.128.1">Part 1 of 3 – Retrieving the IP address of your local machine</span></h2>
<p><span class="koboSpan" id="kobo.129.1">Follow</span><a id="_idIndexMarker375"/><span class="koboSpan" id="kobo.130.1"> the </span><a id="_idIndexMarker376"/><span class="No-Break"><span class="koboSpan" id="kobo.131.1">next steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.132.1">Take note of your local machine’s IP address using </span><a href="https://ipinfo.io/ip"><span class="koboSpan" id="kobo.133.1">https://ipinfo.io/ip</span></a><span class="koboSpan" id="kobo.134.1">, </span><a href="https://ifconfig.io/"><span class="koboSpan" id="kobo.135.1">https://ifconfig.io/</span></a><span class="koboSpan" id="kobo.136.1">, or other similar websites and online tools. </span><span class="koboSpan" id="kobo.136.2">Alternatively, you may use Google search to retrieve your local machine’s </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">IP address.</span></span></li>
<li><span class="koboSpan" id="kobo.138.1">Store and save your IP address information in a text editor as we will use this to allow our local machine to access the attacker VM instance later in </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">this chapter.</span></span></li>
</ol>
<h2 id="_idParaDest-73"><a id="_idTextAnchor072"/><span class="koboSpan" id="kobo.140.1">Part 2 of 3 – Setting up the Google Cloud project</span></h2>
<p><span class="koboSpan" id="kobo.141.1">Now, let’s create the</span><a id="_idIndexMarker377"/><span class="koboSpan" id="kobo.142.1"> Google Cloud project where we will deploy the cloud resources in this chapter. </span><span class="koboSpan" id="kobo.142.2">Proceed </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.144.1">Navigate to the Google Cloud console by opening the following link in your web </span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">browser: </span></span><a href="https://console.cloud.google.com/"><span class="No-Break"><span class="koboSpan" id="kobo.146.1">https://console.cloud.google.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.147.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.148.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.149.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.150.1">Google Cloud console</span></strong><span class="koboSpan" id="kobo.151.1"> is a </span><a id="_idIndexMarker378"/><span class="koboSpan" id="kobo.152.1">web interface provided by GCP for managing cloud resources. </span><span class="koboSpan" id="kobo.152.2">You can think of it as the counterpart of the </span><strong class="bold"><span class="koboSpan" id="kobo.153.1">AWS Management Console</span></strong><span class="koboSpan" id="kobo.154.1"> we </span><a id="_idIndexMarker379"/><span class="koboSpan" id="kobo.155.1">used in the first few chapters of this book. </span><span class="koboSpan" id="kobo.155.2">If you need a quick introduction to how to use the Google Cloud console, feel free to watch the following 6-minute </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">video: </span></span><a href="https://www.youtube.com/watch?v=27Pb5g7bEAA"><span class="No-Break"><span class="koboSpan" id="kobo.157.1">https://www.youtube.com/watch?v=27Pb5g7bEAA</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.158.1">.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.159.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.160.1">Google Cloud</span></strong><span class="koboSpan" id="kobo.161.1"> console, open</span><a id="_idIndexMarker380"/><span class="koboSpan" id="kobo.162.1"> the navigation </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">menu (</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.164.1">☰</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.165.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer067">
<span class="koboSpan" id="kobo.166.1"><img alt="" src="image/B19755_04_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.167.1">Figure 4.2 – Navigating to the Create a Project page</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.168.1">Locate and click </span><strong class="bold"><span class="koboSpan" id="kobo.169.1">Create a project</span></strong><span class="koboSpan" id="kobo.170.1"> under </span><strong class="bold"><span class="koboSpan" id="kobo.171.1">IAM &amp; Admin</span></strong><span class="koboSpan" id="kobo.172.1">, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.173.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.174.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.175.1">.</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.176.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.177.1">Project name</span></strong><span class="koboSpan" id="kobo.178.1"> field, specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">secure-network-environments</span></strong><span class="koboSpan" id="kobo.180.1">.  </span><span class="koboSpan" id="kobo.180.2">Keep the value in the </span><strong class="bold"><span class="koboSpan" id="kobo.181.1">Location</span></strong><span class="koboSpan" id="kobo.182.1"> field as it is (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.183.1">No organization</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.185.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.186.1">CREATE</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.187.1">button </span></span><span class="No-Break"><a id="_idIndexMarker381"/></span><span class="No-Break"><span class="koboSpan" id="kobo.188.1">afterward.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.189.1">Note</span></p>
<p class="callout"><strong class="bold"><span class="koboSpan" id="kobo.190.1">Projects</span></strong><span class="koboSpan" id="kobo.191.1"> in </span><a id="_idIndexMarker382"/><span class="koboSpan" id="kobo.192.1">GCP are used to organize resources into logical groups. </span><span class="koboSpan" id="kobo.192.2">Inside a project, we can have a set of users who have access to the project resources. </span><span class="koboSpan" id="kobo.192.3">A project includes the users and the APIs, along with specific configuration settings for these APIs. </span><span class="koboSpan" id="kobo.192.4">For </span><a id="_idIndexMarker383"/><span class="koboSpan" id="kobo.193.1">more information, feel free to check the following </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">link: </span></span><a href="https://cloud.google.com/storage/docs/projects"><span class="No-Break"><span class="koboSpan" id="kobo.195.1">https://cloud.google.com/storage/docs/projects</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.196.1">.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.197.1">Once the project </span><a id="_idIndexMarker384"/><span class="koboSpan" id="kobo.198.1">has been successfully created, click the drop-down menu highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.199.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.200.1">.3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.201.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer068">
<span class="koboSpan" id="kobo.202.1"><img alt="" src="image/B19755_04_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.203.1">Figure 4.3 – Opening the Select a project popup</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.204.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.205.1">Select a project</span></strong><span class="koboSpan" id="kobo.206.1"> popup, select the </span><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">secure-network-environments</span></strong><span class="koboSpan" id="kobo.208.1"> project and then click the </span><strong class="bold"><span class="koboSpan" id="kobo.209.1">OPEN</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.210.1">button afterward.</span></span></p></li>
</ol>
<ol>
<li value="6"><span class="koboSpan" id="kobo.211.1">Locate and click the </span><strong class="bold"><span class="koboSpan" id="kobo.212.1">Activate Cloud Shell</span></strong><span class="koboSpan" id="kobo.213.1"> button, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.214.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.215.1">.4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.216.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer069">
<span class="koboSpan" id="kobo.217.1"><img alt="" src="image/B19755_04_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.218.1">Figure 4.4 – Activating Cloud Shell</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.219.1">This should open a terminal where we can run </span><span class="No-Break"><span class="koboSpan" id="kobo.220.1">command-line commands.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.221.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.222.1">It may take a minute or two for Cloud Shell to </span><span class="No-Break"><span class="koboSpan" id="kobo.223.1">be ready.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.224.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.225.1">Open Editor</span></strong><span class="koboSpan" id="kobo.226.1"> button located at the upper right-hand corner of the Cloud Shell</span><a id="_idIndexMarker385"/><span class="koboSpan" id="kobo.227.1"> terminal pane. </span><span class="koboSpan" id="kobo.227.2">This should open the Cloud Shell editor, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.228.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.229.1">.5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.230.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer070">
<span class="koboSpan" id="kobo.231.1"><img alt="" src="image/B19755_04_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.232.1">Figure 4.5 – Cloud Shell editor</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.233.1">If you can’t see a terminal similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.234.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.235.1">.5</span></em><span class="koboSpan" id="kobo.236.1">, open the </span><strong class="bold"><span class="koboSpan" id="kobo.237.1">Terminal</span></strong><span class="koboSpan" id="kobo.238.1"> menu of the Cloud Shell editor and then select </span><strong class="bold"><span class="koboSpan" id="kobo.239.1">New Terminal</span></strong><span class="koboSpan" id="kobo.240.1"> from the list </span><span class="No-Break"><span class="koboSpan" id="kobo.241.1">of options.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.242.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.243.1">Google </span><strong class="bold"><span class="koboSpan" id="kobo.244.1">Cloud Shell</span></strong><span class="koboSpan" id="kobo.245.1"> provides </span><a id="_idIndexMarker386"/><span class="koboSpan" id="kobo.246.1">a web-based interactive shell environment where we can run commands, write scripts, and manage resources when working with cloud resources and applications. </span><span class="koboSpan" id="kobo.246.2">Since we </span><a id="_idIndexMarker387"/><span class="koboSpan" id="kobo.247.1">used </span><strong class="bold"><span class="koboSpan" id="kobo.248.1">AWS CloudShell</span></strong><span class="koboSpan" id="kobo.249.1"> in the previous chapters, we should easily adapt to using Google Cloud Shell in this chapter. </span><span class="koboSpan" id="kobo.249.2">It is important to note that Google Cloud Shell also provides an integrated code editor, allowing us to write, edit, and save scripts and configuration files directly within </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">the environment.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.251.1">In the </span><a id="_idIndexMarker388"/><span class="koboSpan" id="kobo.252.1">terminal (right after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">$</span></strong><span class="koboSpan" id="kobo.254.1"> sign), run the following command to list the projects in your </span><span class="No-Break"><span class="koboSpan" id="kobo.255.1">GCP account:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.256.1">gcloud projects list</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.257.1">If you see the </span><strong class="bold"><span class="koboSpan" id="kobo.258.1">Authorize Cloud Shell</span></strong><span class="koboSpan" id="kobo.259.1"> popup (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.260.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.261.1">.6</span></em><span class="koboSpan" id="kobo.262.1">), make sure to click the </span><strong class="bold"><span class="koboSpan" id="kobo.263.1">AUTHORIZE</span></strong><span class="koboSpan" id="kobo.264.1"> button to allow the </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">gcloud </span></strong><strong class="bold"><span class="koboSpan" id="kobo.266.1">command-line interface</span></strong><span class="koboSpan" id="kobo.267.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.268.1">CLI</span></strong><span class="koboSpan" id="kobo.269.1">) to make</span><a id="_idIndexMarker389"/><span class="koboSpan" id="kobo.270.1"> API calls </span><span class="No-Break"><span class="koboSpan" id="kobo.271.1">for us:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer071">
<span class="koboSpan" id="kobo.272.1"><img alt="" src="image/B19755_04_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.273.1">Figure 4.6 – Authorize Cloud Shell</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.274.1">If this is your first time using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">gcloud</span></strong><span class="koboSpan" id="kobo.276.1"> CLI, it is simply a command-line tool that helps us create and manage a variety of Google </span><span class="No-Break"><span class="koboSpan" id="kobo.277.1">Cloud resources.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.278.1">Running the preceding command should then give us the </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">following output:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.280.1">
...PROJECT_ID: </span><strong class="bold"><span class="koboSpan" id="kobo.281.1">&lt;PROJECT_ID&gt;</span></strong><span class="koboSpan" id="kobo.282.1">
NAME: secure-network-environments
PROJECT_NUMBER: ...</span></pre>
<p class="list-inset"><span class="koboSpan" id="kobo.283.1">Make sure to take note of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">PROJECT_ID</span></strong><span class="koboSpan" id="kobo.285.1"> value as we’ll need this when configuring the active project in the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.286.1">of steps.</span></span></p></li>
</ol>
<ol>
<li value="9"><span class="koboSpan" id="kobo.287.1">Next, run the following command to check the </span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">active project:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.289.1">gcloud config get-value project</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.290.1">If the previous command returned a project ID that does not match the </span><strong class="source-inline"><span class="koboSpan" id="kobo.291.1">&lt;PROJECT_ID&gt;</span></strong><span class="koboSpan" id="kobo.292.1"> value from the previous step, run the following command to configure a new active project—this time specifying the </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">&lt;PROJECT_ID&gt;</span></strong><span class="koboSpan" id="kobo.294.1"> value obtained from the </span><span class="No-Break"><span class="koboSpan" id="kobo.295.1">previous step:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.296.1">gcloud config set project &lt;PROJECT_ID&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.297.1">Feel free to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.298.1">gcloud config get-value project</span></strong><span class="koboSpan" id="kobo.299.1"> command again to verify that the previous command succeeded. </span><span class="koboSpan" id="kobo.299.2">Note that when the Cloud Shell environment restarts, we may have to configure the active project again using </span><strong class="source-inline"><span class="koboSpan" id="kobo.300.1">gcloud config set project &lt;PROJECT_ID&gt;</span></strong><span class="koboSpan" id="kobo.301.1"> so that we’re running </span><a id="_idIndexMarker390"/><span class="koboSpan" id="kobo.302.1">commands and creating cloud resources inside the </span><span class="No-Break"><span class="koboSpan" id="kobo.303.1">correct project.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.304.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.305.1">Make sure </span><em class="italic"><span class="koboSpan" id="kobo.306.1">NOT</span></em><span class="koboSpan" id="kobo.307.1"> to use the project name (that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">secure-network-environments</span></strong><span class="koboSpan" id="kobo.309.1">) for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">&lt;PROJECT_ID&gt;</span></strong><span class="koboSpan" id="kobo.311.1"> value when using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">gcloud config set project</span></strong><span class="koboSpan" id="kobo.313.1"> command. </span><span class="koboSpan" id="kobo.313.2">Specifying the incorrect </span><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">&lt;PROJECT_ID&gt;</span></strong><span class="koboSpan" id="kobo.315.1"> value will yield the following warning message: </span><strong class="bold"><span class="koboSpan" id="kobo.316.1">You do not appear to have access to project [secure-network-environments] or it does </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.317.1">not exist.</span></strong></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.318.1">Using the search bar, navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.319.1">VPC networks</span></strong><span class="koboSpan" id="kobo.320.1"> page using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.321.1">vpc networks</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.322.1">search query.</span></span></li>
<li><span class="koboSpan" id="kobo.323.1">If the Compute Engine API is not enabled yet, you will be redirected to the Compute Engine API page, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.324.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.325.1">.7</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.326.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer072">
<span class="koboSpan" id="kobo.327.1"><img alt="" src="image/B19755_04_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.328.1">Figure 4.7 – Enabling the Compute Engine API</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.329.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.330.1">ENABLE</span></strong><span class="koboSpan" id="kobo.331.1"> button to </span><a id="_idIndexMarker391"/><span class="koboSpan" id="kobo.332.1">proceed. </span><span class="koboSpan" id="kobo.332.2">Wait for about 3-5 minutes for the Compute Engine API to be enabled. </span><span class="koboSpan" id="kobo.332.3">Note that this step is necessary to ensure that you have access to Compute Engine services and functionalities within </span><span class="No-Break"><span class="koboSpan" id="kobo.333.1">your project.</span></span></p></li>
</ol>
<h2 id="_idParaDest-74"><a id="_idTextAnchor073"/><span class="koboSpan" id="kobo.334.1">Part 3 of 3 – Generating SSH keys to access the attacker VM instance</span></h2>
<p><span class="koboSpan" id="kobo.335.1">Now, let’s generate SSH</span><a id="_idIndexMarker392"/><span class="koboSpan" id="kobo.336.1"> keys for accessing the attacker VM instance (which we’ll set up later in this chapter). </span><span class="koboSpan" id="kobo.336.2">Follow the </span><span class="No-Break"><span class="koboSpan" id="kobo.337.1">next steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.338.1">Continuing where we left off in the previous part, let’s open a new </span><strong class="bold"><span class="koboSpan" id="kobo.339.1">Cloud Shell</span></strong><span class="koboSpan" id="kobo.340.1"> terminal (or reuse an existing one). </span><span class="koboSpan" id="kobo.340.2">Make sure that we are using </span><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">secure-network-environments</span></strong><span class="koboSpan" id="kobo.342.1"> as the active project configured </span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">before proceeding.</span></span></li>
<li><span class="koboSpan" id="kobo.344.1">In the terminal (right after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">$</span></strong><span class="koboSpan" id="kobo.346.1"> sign), run the following commands to create a new directory (named </span><strong class="source-inline"><span class="koboSpan" id="kobo.347.1">kali_keys</span></strong><span class="koboSpan" id="kobo.348.1">) and navigate </span><span class="No-Break"><span class="koboSpan" id="kobo.349.1">to it:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.350.1">cd ~</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.351.1">mkdir kali_keys &amp;&amp; cd kali_keys</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.352.1">We will store the generated keys inside </span><span class="No-Break"><span class="koboSpan" id="kobo.353.1">this directory.</span></span></p></li> <li><span class="koboSpan" id="kobo.354.1">Generate a new SSH key pair and save the generated key files in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">kali_keys</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.356.1"> directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.357.1">ssh-keygen -t rsa -C kali -f ./kali-ssh</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.358.1">When asked </span><a id="_idIndexMarker393"/><span class="koboSpan" id="kobo.359.1">for a passphrase, just press </span><em class="italic"><span class="koboSpan" id="kobo.360.1">Enter</span></em><span class="koboSpan" id="kobo.361.1"> as we won’t add a passphrase to our key (the same goes for the password confirmation). </span><span class="koboSpan" id="kobo.361.2">This will generate two files—</span><strong class="source-inline"><span class="koboSpan" id="kobo.362.1">kali-ssh</span></strong><span class="koboSpan" id="kobo.363.1"> (the private key) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.364.1">kali-ssh.pub</span></strong><span class="koboSpan" id="kobo.365.1"> (the </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">public key).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.367.1">Note</span></p>
<p class="callout"><em class="italic"><span class="koboSpan" id="kobo.368.1">How do these SSH key files work?</span></em><span class="koboSpan" id="kobo.369.1"> SSH key files consist </span><a id="_idIndexMarker394"/><span class="koboSpan" id="kobo.370.1">of a </span><strong class="bold"><span class="koboSpan" id="kobo.371.1">private key</span></strong><span class="koboSpan" id="kobo.372.1"> (stored and kept </span><a id="_idIndexMarker395"/><span class="koboSpan" id="kobo.373.1">on the client’s machine) and a corresponding </span><strong class="bold"><span class="koboSpan" id="kobo.374.1">public key</span></strong><span class="koboSpan" id="kobo.375.1"> uploaded to the remote server. </span><span class="koboSpan" id="kobo.375.2">During authentication, the client uses its private key to generate a</span><a id="_idIndexMarker396"/><span class="koboSpan" id="kobo.376.1"> digital signature, and the server verifies it using the corresponding public key. </span><span class="koboSpan" id="kobo.376.2">Here, the server can confirm the client’s identity based on the possession of the private key without having to transmit </span><span class="No-Break"><span class="koboSpan" id="kobo.377.1">sensitive credentials.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.378.1">Print the public key value using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">cat</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.380.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.381.1">cat kali-ssh.pub</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.382.1">Store this value in a text editor on your local machine as we will use this later in the </span><em class="italic"><span class="koboSpan" id="kobo.383.1">Manually setting up the attacker VM instance</span></em><span class="koboSpan" id="kobo.384.1"> section of </span><span class="No-Break"><span class="koboSpan" id="kobo.385.1">this chapter.</span></span></p></li> <li><span class="koboSpan" id="kobo.386.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.387.1">Open Editor</span></strong><span class="koboSpan" id="kobo.388.1"> button (in case the editor is not </span><span class="No-Break"><span class="koboSpan" id="kobo.389.1">yet open).</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.390.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.391.1">It may take a minute or two for the </span><strong class="bold"><span class="koboSpan" id="kobo.392.1">Cloud Shell editor</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.393.1">to load.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.394.1">Locate the generated private key (</span><strong class="source-inline"><span class="koboSpan" id="kobo.395.1">kali-ssh</span></strong><span class="koboSpan" id="kobo.396.1">) in the file tree of the editor (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.397.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.398.1">.8</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.399.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer073">
<span class="koboSpan" id="kobo.400.1"><img alt="" src="image/B19755_04_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.401.1">Figure 4.8 – Downloading the generated private key file</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.402.1">Right-click </span><a id="_idIndexMarker397"/><span class="koboSpan" id="kobo.403.1">on the file and then select </span><strong class="bold"><span class="koboSpan" id="kobo.404.1">Download</span></strong><span class="koboSpan" id="kobo.405.1"> from the options in the context menu. </span><span class="koboSpan" id="kobo.405.2">Feel free to perform the same set of steps for the public key (</span><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">kali-ssh.pub</span></strong><span class="koboSpan" id="kobo.407.1">) to download it to your </span><span class="No-Break"><span class="koboSpan" id="kobo.408.1">local machine.</span></span></p></li>
</ol>
<p><span class="koboSpan" id="kobo.409.1">Now that we have the prerequisites ready, we can now proceed with setting up and defining the </span><span class="No-Break"><span class="koboSpan" id="kobo.410.1">project structure!</span></span></p>
<h1 id="_idParaDest-75"><a id="_idTextAnchor074"/><span class="koboSpan" id="kobo.411.1">Defining the project structure</span></h1>
<p><span class="koboSpan" id="kobo.412.1">In this chapter, we will introduce the usage of Terraform </span><strong class="bold"><span class="koboSpan" id="kobo.413.1">modules</span></strong><span class="koboSpan" id="kobo.414.1"> to</span><a id="_idIndexMarker398"/><span class="koboSpan" id="kobo.415.1"> help define and organize our </span><strong class="bold"><span class="koboSpan" id="kobo.416.1">Infrastructure-as-Code</span></strong><span class="koboSpan" id="kobo.417.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.418.1">IaC</span></strong><span class="koboSpan" id="kobo.419.1">) project structure. </span><span class="koboSpan" id="kobo.419.2">Modules allow us to </span><a id="_idIndexMarker399"/><span class="koboSpan" id="kobo.420.1">encapsulate and reuse sets of resources to make our Terraform code more modular, maintainable, and scalable. </span><span class="koboSpan" id="kobo.420.2">By leveraging modules, we will be able to simplify the management of complex infrastructure deployments and abstract common configurations into </span><span class="No-Break"><span class="koboSpan" id="kobo.421.1">reusable components.</span></span></p>
<p><span class="koboSpan" id="kobo.422.1">In </span><span class="No-Break"><em class="italic"><a href="B19755_03.xhtml"><span class="koboSpan" id="kobo.423.1">Chapter 3</span></a></em></span><span class="koboSpan" id="kobo.424.1">, </span><em class="italic"><span class="koboSpan" id="kobo.425.1">Succeeding with Infrastructure as Code Tools and Strategies</span></em><span class="koboSpan" id="kobo.426.1">, we stored all our </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">.tf</span></strong><span class="koboSpan" id="kobo.428.1"> files in a single directory. </span><em class="italic"><span class="koboSpan" id="kobo.429.1">It feels a bit messy, right?</span></em><span class="koboSpan" id="kobo.430.1"> In case you are wondering how modules change how we organize our code and our files, here’s an example of what the project</span><a id="_idIndexMarker400"/><span class="koboSpan" id="kobo.431.1"> structure might look like once we utilize </span><span class="No-Break"><span class="koboSpan" id="kobo.432.1">Terraform modules:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer074">
<span class="koboSpan" id="kobo.433.1"><img alt="" src="image/B19755_04_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.434.1">Figure 4.9 – Sample file and folder structure using Terraform modules</span></p>
<p><span class="koboSpan" id="kobo.435.1">We have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.436.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.437.1">.9</span></em><span class="koboSpan" id="kobo.438.1"> a sample file and folder structure (left) along with how module directories are loaded in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">main.tf</span></strong><span class="koboSpan" id="kobo.440.1"> file of the root module (right). </span><span class="koboSpan" id="kobo.440.2">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">root_module</span></strong><span class="koboSpan" id="kobo.442.1"> directory serves as the main entry point for the Terraform configuration. </span><span class="koboSpan" id="kobo.442.2">Directories such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">module1</span></strong><span class="koboSpan" id="kobo.444.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">module2</span></strong><span class="koboSpan" id="kobo.446.1"> inside the project root directory will contain Terraform files such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.447.1">main.tf</span></strong><span class="koboSpan" id="kobo.448.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.449.1">variables.tf</span></strong><span class="koboSpan" id="kobo.450.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.451.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.452.1"> specific to those modules. </span><span class="koboSpan" id="kobo.452.2">The modules are then defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.453.1">main.tf</span></strong><span class="koboSpan" id="kobo.454.1"> file of the root module using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.455.1">module</span></strong><span class="koboSpan" id="kobo.456.1"> block, similar to what we have in the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.457.1">of code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.458.1">
module "</span><strong class="bold"><span class="koboSpan" id="kobo.459.1">module1</span></strong><span class="koboSpan" id="kobo.460.1">" {
  </span><strong class="bold"><span class="koboSpan" id="kobo.461.1">source = "./module1"</span></strong><span class="koboSpan" id="kobo.462.1">
  ...
</span><span class="koboSpan" id="kobo.462.2">}
module "</span><strong class="bold"><span class="koboSpan" id="kobo.463.1">module2</span></strong><span class="koboSpan" id="kobo.464.1">" {
  </span><strong class="bold"><span class="koboSpan" id="kobo.465.1">source = "./module2"</span></strong><span class="koboSpan" id="kobo.466.1">
  ...
</span><span class="koboSpan" id="kobo.466.2">}</span></pre>
<p><span class="koboSpan" id="kobo.467.1">Note that while it is</span><a id="_idIndexMarker401"/><span class="koboSpan" id="kobo.468.1"> common practice to have a separate directory named </span><strong class="source-inline"><span class="koboSpan" id="kobo.469.1">modules</span></strong><span class="koboSpan" id="kobo.470.1"> to store individual module directories such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.471.1">module1</span></strong><span class="koboSpan" id="kobo.472.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">module2</span></strong><span class="koboSpan" id="kobo.474.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">module3</span></strong><span class="koboSpan" id="kobo.476.1">, we will follow the current project and folder structure shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.477.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.478.1">.9</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.480.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.481.1">It is important to note that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.482.1">module1</span></strong><span class="koboSpan" id="kobo.483.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.484.1">module2</span></strong><span class="koboSpan" id="kobo.485.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">module3</span></strong><span class="koboSpan" id="kobo.487.1"> directory names used in our example are arbitrary and can be renamed according to the user’s preference. </span><span class="koboSpan" id="kobo.487.2">For instance, alternative names such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.488.1">secure_network</span></strong><span class="koboSpan" id="kobo.489.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.490.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.491.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">target_vm</span></strong><span class="koboSpan" id="kobo.493.1"> can be used to provide more descriptive and meaningful names for </span><span class="No-Break"><span class="koboSpan" id="kobo.494.1">the modules.</span></span></p>
<p><span class="koboSpan" id="kobo.495.1">The organization and modularization of the IaC configuration files are influenced by the overall design of the penetration testing lab environment along with how the resources are grouped together. </span><span class="koboSpan" id="kobo.495.2">It is crucial that we discuss (at a high level for now) what our lab environment will look like in this section. </span><span class="koboSpan" id="kobo.495.3">Have a look at the </span><span class="No-Break"><span class="koboSpan" id="kobo.496.1">following diagram:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer075">
<span class="koboSpan" id="kobo.497.1"><img alt="" src="image/B19755_04_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.498.1">Figure 4.10 – High-level diagram of our penetration testing lab environment in GCP</span></p>
<p><span class="koboSpan" id="kobo.499.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.500.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.501.1">.10</span></em><span class="koboSpan" id="kobo.502.1">, we have two </span><a id="_idIndexMarker402"/><span class="koboSpan" id="kobo.503.1">VPC networks: </span><strong class="bold"><span class="koboSpan" id="kobo.504.1">VPC 01</span></strong><span class="koboSpan" id="kobo.505.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.506.1">VPC 02</span></strong><span class="koboSpan" id="kobo.507.1">. </span><span class="koboSpan" id="kobo.507.2">If you are wondering what VPC networks are, these are simply isolated virtual networks within a cloud computing environment that allow us to securely separate and manage resources. </span><em class="italic"><span class="koboSpan" id="kobo.508.1">That being said, which resources are we planning to have inside these networks?</span></em><span class="koboSpan" id="kobo.509.1"> Inside </span><strong class="bold"><span class="koboSpan" id="kobo.510.1">VPC 01</span></strong><span class="koboSpan" id="kobo.511.1">, we’ll have the target VM instance. </span><span class="koboSpan" id="kobo.511.2">On the other hand, we’ll have the attacker VM instance inside </span><strong class="bold"><span class="koboSpan" id="kobo.512.1">VPC 02</span></strong><span class="koboSpan" id="kobo.513.1">. </span><span class="koboSpan" id="kobo.513.2">One way to group these resources together is by using the </span><span class="No-Break"><span class="koboSpan" id="kobo.514.1">following groups:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.515.1">Group 1</span></strong><span class="koboSpan" id="kobo.516.1">—</span><strong class="bold"><span class="koboSpan" id="kobo.517.1">VPC 01</span></strong><span class="koboSpan" id="kobo.518.1"> and the target </span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">VM instance</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.520.1">Group 2</span></strong><span class="koboSpan" id="kobo.521.1">—</span><strong class="bold"><span class="koboSpan" id="kobo.522.1">VPC 02</span></strong><span class="koboSpan" id="kobo.523.1"> and the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.524.1">VM instance</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.525.1">We should take into consideration the possible limitations of this approach. </span><span class="koboSpan" id="kobo.525.2">Grouping </span><strong class="bold"><span class="koboSpan" id="kobo.526.1">VPC 01</span></strong><span class="koboSpan" id="kobo.527.1"> and the target VM instance together may restrict the flexibility and scalability of the network environment (from a modularization standpoint). </span><span class="koboSpan" id="kobo.527.2">If we want to add more target VM instances in the future, we will need to modify the existing group and potentially cause the first group to have too </span><span class="No-Break"><span class="koboSpan" id="kobo.528.1">many resources.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.529.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.530.1">If you are unfamiliar with VPCs and VM instances, do not worry as we will discuss these in more detail in the upcoming section of </span><span class="No-Break"><span class="koboSpan" id="kobo.531.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.532.1">Alternatively, another option involves creating three distinct modules, </span><span class="No-Break"><span class="koboSpan" id="kobo.533.1">as follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.534.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">secure_network</span></strong><span class="koboSpan" id="kobo.536.1"> module—Network resources such as </span><strong class="bold"><span class="koboSpan" id="kobo.537.1">VPC 01</span></strong><span class="koboSpan" id="kobo.538.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.539.1">VPC 02</span></strong><span class="koboSpan" id="kobo.540.1">, along with other relevant resources </span><span class="No-Break"><span class="koboSpan" id="kobo.541.1">grouped together</span></span></li>
<li><span class="koboSpan" id="kobo.542.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">target_vm</span></strong><span class="koboSpan" id="kobo.544.1"> module—The target </span><span class="No-Break"><span class="koboSpan" id="kobo.545.1">VM instance</span></span></li>
<li><span class="koboSpan" id="kobo.546.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.548.1"> module—The attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.549.1">VM instance</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.550.1">This alternative </span><a id="_idIndexMarker403"/><span class="koboSpan" id="kobo.551.1">appears to be a more favorable choice as it leans toward the preparation of a reusable network environment module that can be easily utilized for various iterations of our penetration testing lab environments in GCP. </span><span class="koboSpan" id="kobo.551.2">In addition to this, it provides the flexibility to swap out the target VM instance module with one or more alternative vulnerable-by-design target modules. </span><span class="koboSpan" id="kobo.551.3">While this approach is not perfect, this should do the trick for now as it offers significant advantages in terms of scalability, modularity, and adaptability for building dynamic penetration testing lab environments </span><span class="No-Break"><span class="koboSpan" id="kobo.552.1">in GCP.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.553.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.554.1">If the overview of our penetration testing lab environment in this section feels a bit vague and lacking in detail, do not worry – we will have a more comprehensive discussion as we go through each of the succeeding sections in </span><span class="No-Break"><span class="koboSpan" id="kobo.555.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.556.1">Now, let’s proceed with setting up the initial project files </span><span class="No-Break"><span class="koboSpan" id="kobo.557.1">and directories:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.558.1">Continuing where we left off in the previous section, let’s make sure that we have a terminal ready where we’ll run </span><span class="No-Break"><span class="koboSpan" id="kobo.559.1">the commands:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer076">
<span class="koboSpan" id="kobo.560.1"><img alt="" src="image/B19755_04_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.561.1">Figure 4.11 – Opening a new terminal</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.562.1">Open the </span><strong class="bold"><span class="koboSpan" id="kobo.563.1">Terminal</span></strong><span class="koboSpan" id="kobo.564.1"> menu of the Cloud Shell editor (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.565.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.566.1">.11</span></em><span class="koboSpan" id="kobo.567.1">). </span><span class="koboSpan" id="kobo.567.2">Select </span><strong class="bold"><span class="koboSpan" id="kobo.568.1">New Terminal</span></strong><span class="koboSpan" id="kobo.569.1"> from the list of </span><span class="No-Break"><span class="koboSpan" id="kobo.570.1">options available.</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.571.1">In the </span><a id="_idIndexMarker404"/><span class="koboSpan" id="kobo.572.1">terminal (right after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">$</span></strong><span class="koboSpan" id="kobo.574.1"> sign), run the following commands to create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.575.1">pentest_lab</span></strong><span class="koboSpan" id="kobo.576.1"> project directory (and navigate to the new directory </span><span class="No-Break"><span class="koboSpan" id="kobo.577.1">as well):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.578.1">cd ~</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.579.1">mkdir -p pentest_lab &amp;&amp; cd pentest_lab</span></strong></pre></li> <li><span class="koboSpan" id="kobo.580.1">Inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">pentest_lab</span></strong><span class="koboSpan" id="kobo.582.1"> directory, let’s also create </span><strong class="source-inline"><span class="koboSpan" id="kobo.583.1">secure_network</span></strong><span class="koboSpan" id="kobo.584.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">target_vm</span></strong><span class="koboSpan" id="kobo.586.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.588.1"> directories, </span><span class="No-Break"><span class="koboSpan" id="kobo.589.1">like so:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.590.1">mkdir -p secure_network</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.591.1">mkdir -p target_vm</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.592.1">mkdir -p attacker_vm</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.593.1">We’ll store the corresponding module files later in </span><span class="No-Break"><span class="koboSpan" id="kobo.594.1">these directories.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.595.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.596.1">While it is common practice to have a separate directory named </span><strong class="source-inline"><span class="koboSpan" id="kobo.597.1">modules</span></strong><span class="koboSpan" id="kobo.598.1"> to store individual module directories such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.599.1">secure_network</span></strong><span class="koboSpan" id="kobo.600.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.601.1">target_vm</span></strong><span class="koboSpan" id="kobo.602.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.603.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.604.1">, our current project and folder structure should suffice </span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">for now.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.606.1">Let’s create</span><a id="_idIndexMarker405"/><span class="koboSpan" id="kobo.607.1"> the files we’ll have in the root folder of </span><span class="No-Break"><span class="koboSpan" id="kobo.608.1">our project:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.609.1">touch main.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.610.1">touch variables.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.611.1">touch outputs.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.612.1">touch terraform.tfvars</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.613.1">touch versions.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.614.1">touch provider.tf</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.615.1">Note that at this point, these files are still empty. </span><span class="koboSpan" id="kobo.615.2">We will populate them with the necessary configurations as we go along. </span><span class="koboSpan" id="kobo.615.3">This is what our project structure currently </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">looks like:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer077">
<span class="koboSpan" id="kobo.617.1"><img alt="" src="image/B19755_04_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.618.1">Figure 4.12 – What our current project structure looks like in the file tree</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.619.1">At this point, we have three empty directories (</span><strong class="source-inline"><span class="koboSpan" id="kobo.620.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.621.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.622.1">secure_network</span></strong><span class="koboSpan" id="kobo.623.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.624.1">target_vm</span></strong><span class="koboSpan" id="kobo.625.1">) along with six empty files (</span><strong class="source-inline"><span class="koboSpan" id="kobo.626.1">main.tf</span></strong><span class="koboSpan" id="kobo.627.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.629.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">provider.tf</span></strong><span class="koboSpan" id="kobo.631.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.632.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.633.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.634.1">variables.tf</span></strong><span class="koboSpan" id="kobo.635.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.636.1">versions.tf</span></strong><span class="koboSpan" id="kobo.637.1">) inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.638.1">pentest_lab</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.639.1"> directory.</span></span></p></li>
</ol>
<ol>
<li value="5"><span class="koboSpan" id="kobo.640.1">By locating the</span><a id="_idIndexMarker406"/><span class="koboSpan" id="kobo.641.1"> file in the file tree (left of the editor), open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.642.1">provider.tf</span></strong><span class="koboSpan" id="kobo.643.1"> file in the editor and add the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.644.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.645.1">
provider "</span><strong class="bold"><span class="koboSpan" id="kobo.646.1">google</span></strong><span class="koboSpan" id="kobo.647.1">" {
  </span><strong class="bold"><span class="koboSpan" id="kobo.648.1">region</span></strong><span class="koboSpan" id="kobo.649.1">      = "us-central1"
  </span><strong class="bold"><span class="koboSpan" id="kobo.650.1">zone</span></strong><span class="koboSpan" id="kobo.651.1">        = "us-central1-c"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.652.1">Here, we are configuring the Google provider, specifying the region as </span><strong class="source-inline"><span class="koboSpan" id="kobo.653.1">us-central1</span></strong><span class="koboSpan" id="kobo.654.1"> and the zone as </span><strong class="source-inline"><span class="koboSpan" id="kobo.655.1">us-central1-c</span></strong><span class="koboSpan" id="kobo.656.1">. </span><span class="koboSpan" id="kobo.656.2">This provider configuration ensures that the resources we deploy with Terraform will be provisioned within the specified region and zone in GCP. </span><span class="koboSpan" id="kobo.656.3">With this in mind, make sure to save any modifications made to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.657.1">provider.tf</span></strong><span class="koboSpan" id="kobo.658.1"> file before moving on to the </span><span class="No-Break"><span class="koboSpan" id="kobo.659.1">next step.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.660.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.661.1">In the next set of steps, we will be updating and adding code to multiple files inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.662.1">~/pentest_lab</span></strong><span class="koboSpan" id="kobo.663.1"> directory. </span><span class="koboSpan" id="kobo.663.2">Make sure that any changes made to each of the files are saved so that we don’t encounter unexpected errors when running the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.664.1">terraform</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.665.1"> commands.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.666.1">Next, let’s open </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">versions.tf</span></strong><span class="koboSpan" id="kobo.668.1"> in the editor. </span><span class="koboSpan" id="kobo.668.2">Let’s add the following block of code to specify the required version constraints for the </span><span class="No-Break"><span class="koboSpan" id="kobo.669.1">providers used:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.670.1">
terraform {
  required_providers {
    </span><strong class="bold"><span class="koboSpan" id="kobo.671.1">random</span></strong><span class="koboSpan" id="kobo.672.1"> = {
      source = "hashicorp/random"
      version = "</span><strong class="bold"><span class="koboSpan" id="kobo.673.1">2.3.0</span></strong><span class="koboSpan" id="kobo.674.1">"
    }
    </span><strong class="bold"><span class="koboSpan" id="kobo.675.1">google</span></strong><span class="koboSpan" id="kobo.676.1"> = {
      source = "hashicorp/google"
      version = "</span><strong class="bold"><span class="koboSpan" id="kobo.677.1">4.61.0</span></strong><span class="koboSpan" id="kobo.678.1">"
    }
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.679.1">Here, we’re </span><a id="_idIndexMarker407"/><span class="koboSpan" id="kobo.680.1">specifying the source and version for the random and Google Cloud providers. </span><em class="italic"><span class="koboSpan" id="kobo.681.1">Why is this necessary?</span></em><span class="koboSpan" id="kobo.682.1"> This ensures that the correct versions of the providers are used to maintain compatibility and consistency while using Terraform. </span><span class="koboSpan" id="kobo.682.2">That said, make sure to save any modifications made to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.683.1">versions.tf</span></strong><span class="koboSpan" id="kobo.684.1"> file before moving on to the </span><span class="No-Break"><span class="koboSpan" id="kobo.685.1">next step.</span></span></p></li> <li><span class="koboSpan" id="kobo.686.1">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.687.1">variables.tf</span></strong><span class="koboSpan" id="kobo.688.1"> in the editor and add the following blocks </span><span class="No-Break"><span class="koboSpan" id="kobo.689.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.690.1">
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.691.1">my_ip</span></strong><span class="koboSpan" id="kobo.692.1">" {
    type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.693.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.694.1">" {
    type = string
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.695.1">Here, we are defining two variables—</span><strong class="source-inline"><span class="koboSpan" id="kobo.696.1">my_ip</span></strong><span class="koboSpan" id="kobo.697.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.698.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.699.1">. </span><span class="koboSpan" id="kobo.699.2">Note that we won’t be specifying default values this time since we’ll be using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.700.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.701.1"> file to store the variable values instead. </span><span class="koboSpan" id="kobo.701.2">Make sure to save any modifications made to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.702.1">variables.tf</span></strong><span class="koboSpan" id="kobo.703.1"> file before moving on to the </span><span class="No-Break"><span class="koboSpan" id="kobo.704.1">next step.</span></span></p></li> <li><span class="koboSpan" id="kobo.705.1">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.706.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.707.1"> in the editor and add the following lines </span><span class="No-Break"><span class="koboSpan" id="kobo.708.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.709.1">
my_ip = "</span><strong class="bold"><span class="koboSpan" id="kobo.710.1">&lt;IP ADDRESS OF YOUR LOCAL MACHINE&gt;</span></strong><span class="koboSpan" id="kobo.711.1">"
my_public_ssh_key = "</span><strong class="bold"><span class="koboSpan" id="kobo.712.1">&lt;PUBLIC SSH KEY&gt;</span></strong><span class="koboSpan" id="kobo.713.1">"</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.714.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.715.1">&lt;IP ADDRESS OF YOUR LOCAL MACHINE&gt;</span></strong><span class="koboSpan" id="kobo.716.1"> with the current IP address value of the laptop or desktop you are using. </span><span class="koboSpan" id="kobo.716.2">In addition to this, make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.717.1">&lt;PUBLIC SSH KEY&gt;</span></strong><span class="koboSpan" id="kobo.718.1"> with the public key string value (after running </span><strong class="source-inline"><span class="koboSpan" id="kobo.719.1">cat kali-ssh.pub</span></strong><span class="koboSpan" id="kobo.720.1"> in an earlier step). </span><span class="koboSpan" id="kobo.720.2">Note that the value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.721.1">&lt;PUBLIC SSH KEY&gt;</span></strong><span class="koboSpan" id="kobo.722.1"> should follow a format resembling </span><strong class="source-inline"><span class="koboSpan" id="kobo.723.1">ssh-rsa ... </span><span class="koboSpan" id="kobo.723.2">kali</span></strong><span class="koboSpan" id="kobo.724.1">. </span><span class="koboSpan" id="kobo.724.2">Do not forget to save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.725.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.726.1"> file before proceeding to </span><a id="_idIndexMarker408"/><span class="koboSpan" id="kobo.727.1">the </span><span class="No-Break"><span class="koboSpan" id="kobo.728.1">next step.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.729.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.730.1">At this point, you might be wondering what this file is used for! </span><span class="koboSpan" id="kobo.730.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.731.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.732.1"> file is used to store input variable values in a Terraform project. </span><span class="koboSpan" id="kobo.732.2">It provides a convenient way to manage and customize the properties of the infrastructure without having to modify the configuration code. </span><span class="koboSpan" id="kobo.732.3">In addition to this, the values stored in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.733.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.734.1"> file are automatically loaded when using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.735.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.736.1">apply</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.737.1"> command.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.738.1">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.739.1">main.tf</span></strong><span class="koboSpan" id="kobo.740.1"> in the editor and add the following blocks of code to define the modules that will be used for </span><span class="No-Break"><span class="koboSpan" id="kobo.741.1">this project:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.742.1">
module "</span><strong class="bold"><span class="koboSpan" id="kobo.743.1">secure_network</span></strong><span class="koboSpan" id="kobo.744.1">" {
  source = "</span><strong class="bold"><span class="koboSpan" id="kobo.745.1">./secure_network</span></strong><span class="koboSpan" id="kobo.746.1">"
}
module "</span><strong class="bold"><span class="koboSpan" id="kobo.747.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.748.1">" {
  source = "</span><strong class="bold"><span class="koboSpan" id="kobo.749.1">./attacker_vm</span></strong><span class="koboSpan" id="kobo.750.1">"
}
module "</span><strong class="bold"><span class="koboSpan" id="kobo.751.1">target_vm</span></strong><span class="koboSpan" id="kobo.752.1">" {
  source = "</span><strong class="bold"><span class="koboSpan" id="kobo.753.1">./target_vm</span></strong><span class="koboSpan" id="kobo.754.1">"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.755.1">Here, we are adding module blocks in </span><strong class="source-inline"><span class="koboSpan" id="kobo.756.1">main.tf</span></strong><span class="koboSpan" id="kobo.757.1"> to include the </span><strong class="source-inline"><span class="koboSpan" id="kobo.758.1">secure_network</span></strong><span class="koboSpan" id="kobo.759.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.761.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.762.1">target_vm</span></strong><span class="koboSpan" id="kobo.763.1"> modules from their respective source directories. </span><span class="koboSpan" id="kobo.763.2">Make sure to save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">main.tf</span></strong><span class="koboSpan" id="kobo.765.1"> file before proceeding to the </span><span class="No-Break"><span class="koboSpan" id="kobo.766.1">next step.</span></span></p></li> <li><span class="koboSpan" id="kobo.767.1">In the</span><a id="_idIndexMarker409"/><span class="koboSpan" id="kobo.768.1"> terminal (right after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.769.1">$</span></strong><span class="koboSpan" id="kobo.770.1"> sign), let’s run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.771.1">terraform init</span></strong><span class="koboSpan" id="kobo.772.1"> command to initialize the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.773.1">working directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.774.1">terraform init</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.775.1">This should return the </span><span class="No-Break"><span class="koboSpan" id="kobo.776.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.777.1">...
</span><span class="koboSpan" id="kobo.777.2">Terraform has been successfully initialized!
</span><span class="koboSpan" id="kobo.777.3">You may now begin working with Terraform. </span><span class="koboSpan" id="kobo.777.4">Try running "terraform plan" to see
any changes that are required for your infrastructure. </span><span class="koboSpan" id="kobo.777.5">All Terraform commands
should now work.
</span><span class="koboSpan" id="kobo.777.6">...</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.778.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.779.1">Make sure that you are inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.780.1">~/pentest_lab</span></strong><span class="koboSpan" id="kobo.781.1"> directory before running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.782.1">terraform init</span></strong><span class="koboSpan" id="kobo.783.1"> command (and the other </span><strong class="source-inline"><span class="koboSpan" id="kobo.784.1">terraform</span></strong><span class="koboSpan" id="kobo.785.1"> commands in the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.786.1">of steps).</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.787.1">Before running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.788.1">terraform plan</span></strong><span class="koboSpan" id="kobo.789.1"> command, let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.790.1">terraform fmt</span></strong><span class="koboSpan" id="kobo.791.1"> to format our </span><span class="No-Break"><span class="koboSpan" id="kobo.792.1">Terraform code:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.793.1">terraform fmt</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.794.1">Here, we are using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.795.1">terraform fmt</span></strong><span class="koboSpan" id="kobo.796.1"> command to ensure a consistent coding style across all Terraform configuration files. </span><span class="koboSpan" id="kobo.796.2">This command will scan the Terraform configuration files and adjust the indentation, spacing, and line breaks </span><a id="_idIndexMarker410"/><span class="koboSpan" id="kobo.797.1">automatically to match the official Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.798.1">style guide.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.799.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.800.1">While this step is optional, it is highly recommended to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">terraform fmt</span></strong><span class="koboSpan" id="kobo.802.1"> command as part of your development workflow to maintain a clean and consistent </span><span class="No-Break"><span class="koboSpan" id="kobo.803.1">coding style.</span></span></p>
<ol>
<li value="12"><span class="koboSpan" id="kobo.804.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.805.1">terraform plan</span></strong><span class="koboSpan" id="kobo.806.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.807.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.808.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.809.1">This should return the </span><span class="No-Break"><span class="koboSpan" id="kobo.810.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.811.1">No changes. </span><span class="koboSpan" id="kobo.811.2">Your infrastructure matches the configuration.
</span><span class="koboSpan" id="kobo.811.3">Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed.</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.812.1">This command should complete without any errors. </span><span class="koboSpan" id="kobo.812.2">Otherwise, make sure to review and fix any issues </span><span class="No-Break"><span class="koboSpan" id="kobo.813.1">before proceeding.</span></span></p></li> <li><span class="koboSpan" id="kobo.814.1">Next, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.815.1">terraform apply</span></strong><span class="koboSpan" id="kobo.816.1"> command to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.817.1">the changes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.818.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.819.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.820.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.821.1">Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed.
</span><span class="koboSpan" id="kobo.821.2">Apply complete! </span><span class="koboSpan" id="kobo.821.3">Resources: 0 added, 0 changed, 0 destroyed.</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.822.1">Given that we</span><a id="_idIndexMarker411"/><span class="koboSpan" id="kobo.823.1"> have not yet defined and configured any cloud resource in our configuration code, this is the result that we’re expecting! </span><span class="koboSpan" id="kobo.823.2">That said, if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.824.1">terraform apply</span></strong><span class="koboSpan" id="kobo.825.1"> command runs without any errors, we are ready to proceed to the </span><span class="No-Break"><span class="koboSpan" id="kobo.826.1">next section.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.827.1">With our project structure and skeleton ready, we can now proceed with setting up the isolated VPC </span><span class="No-Break"><span class="koboSpan" id="kobo.828.1">network environment.</span></span></p>
<h1 id="_idParaDest-76"><a id="_idTextAnchor075"/><span class="koboSpan" id="kobo.829.1">Preparing the isolated network</span></h1>
<p><span class="koboSpan" id="kobo.830.1">Having a solid understanding of the compute and networking services in GCP is essential for designing and implementing secure network environments where penetration testing lab resources are deployed. </span><span class="koboSpan" id="kobo.830.2">That said, before we dive deep into the secure network design, let’s quickly go through some of the resources, concepts, features, and components we will work with in this chapter, </span><span class="No-Break"><span class="koboSpan" id="kobo.831.1">as follows:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.832.1">VPC</span></strong><span class="koboSpan" id="kobo.833.1">—A </span><a id="_idIndexMarker412"/><span class="koboSpan" id="kobo.834.1">VPC is a virtual network within a cloud computing environment that allows us to securely separate and manage resources. </span><span class="koboSpan" id="kobo.834.2">With VPCs, we can design and customize our own custom network architectures to meet specific requirements as well as enable secure communication between the resources deployed within the VPC. </span><span class="koboSpan" id="kobo.834.3">Inside a VPC, we can have </span><strong class="bold"><span class="koboSpan" id="kobo.835.1">subnetworks</span></strong><span class="koboSpan" id="kobo.836.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.837.1">subnets</span></strong><span class="koboSpan" id="kobo.838.1">) that </span><a id="_idIndexMarker413"/><span class="koboSpan" id="kobo.839.1">allow for further segmentation and isolation of resources within the larger VPC network. </span><span class="koboSpan" id="kobo.839.2">Subnets</span><a id="_idIndexMarker414"/><span class="koboSpan" id="kobo.840.1"> enable us to group resources together based on different considerations </span><span class="No-Break"><span class="koboSpan" id="kobo.841.1">and </span></span><span class="No-Break"><a id="_idIndexMarker415"/></span><span class="No-Break"><span class="koboSpan" id="kobo.842.1">requirements.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.843.1">Have a look at the </span><span class="No-Break"><span class="koboSpan" id="kobo.844.1">following diagram:</span></span></p></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer078">
<span class="koboSpan" id="kobo.845.1"><img alt="" src="image/B19755_04_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.846.1">Figure 4.13 – Simplified network diagram</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.847.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.848.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.849.1">.13</span></em><span class="koboSpan" id="kobo.850.1">, we have a </span><em class="italic"><span class="koboSpan" id="kobo.851.1">simplified</span></em><span class="koboSpan" id="kobo.852.1"> network diagram with two VPC networks. </span><span class="koboSpan" id="kobo.852.2">Each of these VPCs has two subnets. </span><span class="koboSpan" id="kobo.852.3">Inside these subnets, we can have various resources such as </span><a id="_idIndexMarker416"/><span class="koboSpan" id="kobo.853.1">VMs and other cloud resources. </span><span class="koboSpan" id="kobo.853.2">If this is your first time dealing with these concepts, you can think of a VPC network as a country and subnets as cities within a country. </span><span class="koboSpan" id="kobo.853.3">Similar to how a country establishes its own rules and borders, a VPC network creates a controlled environment (inside a cloud account) to securely manage resources. </span><span class="koboSpan" id="kobo.853.4">Just as cities within a country have their own distinct characteristics, subnets within a VPC network act as isolated zones that segregate various types of resources inside the larger </span><span class="No-Break"><span class="koboSpan" id="kobo.854.1">VPC network.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.855.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.856.1">It is important to note that we didn’t include projects or zones, along with other typical network components, in our simplified network diagram to focus instead on the key elements of networks that are relevant to </span><span class="No-Break"><span class="koboSpan" id="kobo.857.1">our discussion.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.858.1">Firewall rules</span></strong><span class="koboSpan" id="kobo.859.1">—Firewall rules</span><a id="_idIndexMarker417"/><span class="koboSpan" id="kobo.860.1"> are security rules that dictate how traffic is allowed or denied within a network. </span><span class="koboSpan" id="kobo.860.2">By setting up firewall rules, we can define the allowed (or blocked) communication paths and prevent unauthorized access and potential threats from reaching resources inside the network. </span><span class="koboSpan" id="kobo.860.3">Similar to how traffic police maintain order on city streets, firewall rules regulate the flow of data and help establish secure communication between various components in our </span><span class="No-Break"><span class="koboSpan" id="kobo.861.1">cloud infrastructure.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.862.1">VPC peering</span></strong><span class="koboSpan" id="kobo.863.1">—VPC peering</span><a id="_idIndexMarker418"/><span class="koboSpan" id="kobo.864.1"> is a networking capability that enables secure and private communication between two VPC networks as if they were part of the </span><span class="No-Break"><span class="koboSpan" id="kobo.865.1">same network.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.866.1">Now, have a look at the </span><span class="No-Break"><span class="koboSpan" id="kobo.867.1">following diagram:</span></span></p></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer079">
<span class="koboSpan" id="kobo.868.1"><img alt="" src="image/B19755_04_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.869.1">Figure 4.14 – Simplified network diagram</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.870.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.871.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.872.1">.14</span></em><span class="koboSpan" id="kobo.873.1">, we have a simplified network diagram with two VPC networks connected through VPC peering. </span><span class="koboSpan" id="kobo.873.2">With VPC peering, traffic from resources deployed in the subnet of the first </span><a id="_idIndexMarker419"/><span class="koboSpan" id="kobo.874.1">VPC network would be able to reach resources deployed in the subnet of the second VPC network (and vice versa) as long as the necessary firewall rules have been </span><span class="No-Break"><span class="koboSpan" id="kobo.875.1">configured correctly.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.876.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.877.1">When using VPC peering to connect VPC networks, it is important to note that IP address ranges used in peered VPC networks must not overlap to prevent routing conflicts. </span><span class="koboSpan" id="kobo.877.2">For instance, if VPC A has an IP address range of </span><strong class="source-inline"><span class="koboSpan" id="kobo.878.1">10.0.0.0/16</span></strong><span class="koboSpan" id="kobo.879.1"> and VPC B has an IP address range of </span><strong class="source-inline"><span class="koboSpan" id="kobo.880.1">192.168.0.0/16</span></strong><span class="koboSpan" id="kobo.881.1">, then we should have a successful VPC peering connection since these ranges do not overlap. </span><span class="koboSpan" id="kobo.881.2">However, if both VPC A and VPC B have IP address ranges of </span><strong class="source-inline"><span class="koboSpan" id="kobo.882.1">10.0.0.0/16</span></strong><span class="koboSpan" id="kobo.883.1">, then there would be an overlap that would result in routing conflicts and prevent the establishment of a VPC peering connection. </span><span class="koboSpan" id="kobo.883.2">In addition to this, VPC peering connections in GCP are unidirectional since each peering connection must be configured separately in each VPC network. </span><span class="koboSpan" id="kobo.883.3">This allows traffic to flow from one VPC network to another, but not in the reverse direction unless a reciprocal peering connection is established. </span><span class="koboSpan" id="kobo.883.4">Finally, VPC peering is non-transitive—meaning that peering connections do not extend to other VPC networks beyond immediate peers. </span><span class="koboSpan" id="kobo.883.5">If connectivity is required between multiple VPC networks, separate peering connections need to </span><span class="No-Break"><span class="koboSpan" id="kobo.884.1">be established.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.885.1">VM instance</span></strong><span class="koboSpan" id="kobo.886.1">—A VM instance</span><a id="_idIndexMarker420"/><span class="koboSpan" id="kobo.887.1"> refers to a virtualized computer system that runs within a cloud environment that enables users to deploy and run applications and services in a virtualized environment. </span><span class="koboSpan" id="kobo.887.2">A VM instance generally includes an operating system along with allocated computing resources such as CPU and memory, as well as </span><span class="No-Break"><span class="koboSpan" id="kobo.888.1">storage capacity.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.889.1">Private IP address</span></strong><span class="koboSpan" id="kobo.890.1">—A private IP address</span><a id="_idIndexMarker421"/><span class="koboSpan" id="kobo.891.1"> is an IP address assigned to a resource in a VPC that is used for internal communication between resources within the VPC. </span><span class="koboSpan" id="kobo.891.2">It’s important to note that the private IP address of a resource would fall within the range of available addresses designated for the specific subnet where the resource </span><span class="No-Break"><span class="koboSpan" id="kobo.892.1">is launched.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.893.1">Public IP address</span></strong><span class="koboSpan" id="kobo.894.1">—A public IP address</span><a id="_idIndexMarker422"/><span class="koboSpan" id="kobo.895.1"> is an IP address assigned to a resource in a VPC that allows resources to be reachable from outside the VPC network. </span><span class="koboSpan" id="kobo.895.2">If a resource does not have a public IP address, it means that the resource is only accessible within the private network of the VPC and cannot be reached directly from the </span><span class="No-Break"><span class="koboSpan" id="kobo.896.1">public internet.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.897.1">Serial console</span></strong><span class="koboSpan" id="kobo.898.1">—The serial console</span><a id="_idIndexMarker423"/><span class="koboSpan" id="kobo.899.1"> is a capability (or feature) that provides direct access to the CLI of a VM instance. </span><span class="koboSpan" id="kobo.899.2">It allows us to troubleshoot and configure the operating system of the VM instance even when the VM’s network connectivity is unreliable </span><span class="No-Break"><span class="koboSpan" id="kobo.900.1">or unavailable.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.901.1">There are multiple ways to</span><a id="_idIndexMarker424"/><span class="koboSpan" id="kobo.902.1"> establish a secure network environment setup in GCP that restricts traffic from external hosts from reaching cloud resources deployed inside the network environment. </span><span class="koboSpan" id="kobo.902.2">By configuring strict firewall rules, implementing network segmentation, and leveraging relevant VPC features and configurations, we can prevent unauthorized external access to the internal </span><span class="No-Break"><span class="koboSpan" id="kobo.903.1">network environment.</span></span></p>
<p><span class="koboSpan" id="kobo.904.1">In this chapter, we will focus on one of the various solutions that satisfy the following constraints </span><span class="No-Break"><span class="koboSpan" id="kobo.905.1">and requirements:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.906.1">Attacker resources (for example, a Kali Linux VM instance) should be deployed and grouped within a dedicated VPC network. </span><span class="koboSpan" id="kobo.906.2">Similarly, target resources (for example, vulnerable-by-design applications and resources) should be deployed and grouped within a separate </span><span class="No-Break"><span class="koboSpan" id="kobo.907.1">VPC network.</span></span></li>
<li><span class="koboSpan" id="kobo.908.1">Traffic originating from attacker resources should reach the target resources without issues even if these resources are deployed in a </span><span class="No-Break"><span class="koboSpan" id="kobo.909.1">different VPC.</span></span></li>
<li><span class="koboSpan" id="kobo.910.1">Serial console access should be enabled to allow direct access to both the attacker and target </span><span class="No-Break"><span class="koboSpan" id="kobo.911.1">VM resources.</span></span></li>
<li><span class="koboSpan" id="kobo.912.1">Since we will configure the attacker VM instance to establish SSH connections and SSH tunnels with your machine, we will restrict port </span><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">22</span></strong><span class="koboSpan" id="kobo.914.1"> of the attacker VM instance to only allow access from your local machine. </span><span class="koboSpan" id="kobo.914.2">Similarly, since we will configure the attacker VM instance with browser-based access to its desktop environment, we will restrict port </span><strong class="source-inline"><span class="koboSpan" id="kobo.915.1">8081</span></strong><span class="koboSpan" id="kobo.916.1"> of the attacker VM instance to only allow access from your </span><span class="No-Break"><span class="koboSpan" id="kobo.917.1">local machine.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.918.1">Given these constraints and requirements, what should our network environment look like? </span><span class="koboSpan" id="kobo.918.2">The following diagram gives us </span><span class="No-Break"><span class="koboSpan" id="kobo.919.1">an overview:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer080">
<span class="koboSpan" id="kobo.920.1"><img alt="" src="image/B19755_04_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.921.1">Figure 4.15 – High-level architecture diagram of our penetration testing lab environment</span></p>
<p><span class="koboSpan" id="kobo.922.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.923.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.924.1">.15</span></em><span class="koboSpan" id="kobo.925.1">, we have a</span><a id="_idIndexMarker425"/><span class="koboSpan" id="kobo.926.1"> simplified network diagram with two VPC networks connected through VPC peering. </span><span class="koboSpan" id="kobo.926.2">Here, traffic from the attacker VM instance deployed in </span><strong class="bold"><span class="koboSpan" id="kobo.927.1">VPC 02</span></strong><span class="koboSpan" id="kobo.928.1"> would be able to reach the target VM instance deployed in </span><strong class="bold"><span class="koboSpan" id="kobo.929.1">VPC 01</span></strong><span class="koboSpan" id="kobo.930.1"> (and vice versa). </span><span class="koboSpan" id="kobo.930.2">With the correct project configuration, we should be able to use the serial console to connect to the attacker and target VM instances. </span><span class="koboSpan" id="kobo.930.3">The firewall rules configured should allow our local machines to access the attacker VM instance via port </span><strong class="source-inline"><span class="koboSpan" id="kobo.931.1">22</span></strong><span class="koboSpan" id="kobo.932.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.933.1">port </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.934.1">8081</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.935.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.936.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.937.1">It is worth mentioning that the architecture we discussed is just one of the potential solutions. </span><span class="koboSpan" id="kobo.937.2">That said, several alternative approaches can meet the requirements and </span><span class="No-Break"><span class="koboSpan" id="kobo.938.1">specified constraints.</span></span></p>
<p><span class="koboSpan" id="kobo.939.1">In addition to blocking external inbound traffic, the VPC networks in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.940.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.941.1">.15</span></em><span class="koboSpan" id="kobo.942.1"> may be configured to block outbound traffic to resources outside of the peered networks as well. </span><span class="koboSpan" id="kobo.942.2">While this is possible, it prevents the VM instances and other resources within the VPC networks from accessing resources outside of the peered networks. </span><span class="koboSpan" id="kobo.942.3">This means that these resources won’t be able to access external repositories for downloading updates and packages, which could impact the setup process. </span><span class="koboSpan" id="kobo.942.4">In this chapter, we will configure the VPC networks to allow outbound traffic (that is, the instances inside the peered VPCs should be able to access resources outside the overall network). </span><span class="koboSpan" id="kobo.942.5">However, after you have completed the chapter, feel free to explore the alternative approach of blocking outbound traffic for a more restricted </span><span class="No-Break"><span class="koboSpan" id="kobo.943.1">network environment.</span></span></p>
<p><span class="koboSpan" id="kobo.944.1">With these points in mind, let’s </span><a id="_idIndexMarker426"/><span class="koboSpan" id="kobo.945.1">proceed with preparing the network environment, </span><span class="No-Break"><span class="koboSpan" id="kobo.946.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.947.1">In the Cloud Shell terminal (right after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.948.1">$</span></strong><span class="koboSpan" id="kobo.949.1"> sign), run the following commands (one line at a time) to navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.950.1">~/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.951.1">pentest_lab/secure_network</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.952.1"> directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.953.1">cd ~/pentest_lab</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.954.1">cd secure_network</span></strong></pre></li> <li><span class="koboSpan" id="kobo.955.1">Next, run the following commands to create the files we will need in our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.956.1">secure_network</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.957.1"> module:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.958.1">touch main.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.959.1">touch variables.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.960.1">touch outputs.tf</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.961.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.962.1">Make sure not to get confused since we have a few files with the same filename in different directories! </span><span class="koboSpan" id="kobo.962.2">While we have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.963.1">main.tf</span></strong><span class="koboSpan" id="kobo.964.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.965.1">variables.tf</span></strong><span class="koboSpan" id="kobo.966.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.967.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.968.1"> files inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.969.1">~/pentest_lab/secure_network</span></strong><span class="koboSpan" id="kobo.970.1"> directory, we also have files with the same name in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.971.1">~/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.972.1">pentest_lab</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.973.1"> directory.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.974.1">Using the editor, add the following block of code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.975.1">secure_network/variables.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.976.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.977.1">
variable "my_ip" {
    type = string
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.978.1">Make sure to save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.979.1">secure_network/variables.tf</span></strong><span class="koboSpan" id="kobo.980.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.981.1">before proceeding.</span></span></p></li> <li><span class="koboSpan" id="kobo.982.1">Next, open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.983.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.984.1"> file in the editor. </span><span class="koboSpan" id="kobo.984.2">In the next set of steps, we will be adding blocks of code here to define and configure multiple network resources. </span><span class="koboSpan" id="kobo.984.3">Let’s start by adding the following block of code, which will allow us later to use </span><a id="_idIndexMarker427"/><span class="koboSpan" id="kobo.985.1">serial connect to access our VM instances from </span><span class="No-Break"><span class="koboSpan" id="kobo.986.1">the browser:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.987.1">
resource "google_compute_project_metadata" "default" {
  metadata = {
    "</span><strong class="bold"><span class="koboSpan" id="kobo.988.1">serial-port-enable</span></strong><span class="koboSpan" id="kobo.989.1">" = "TRUE"
  }
}</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.990.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.991.1">There are a variety of ways to connect to running VM instances. </span><span class="koboSpan" id="kobo.991.2">In this chapter, we’ll use </span><strong class="bold"><span class="koboSpan" id="kobo.992.1">serial connect</span></strong><span class="koboSpan" id="kobo.993.1"> since</span><a id="_idIndexMarker428"/><span class="koboSpan" id="kobo.994.1"> it offers a convenient way to access the VM instances we launched from the browser. </span><span class="koboSpan" id="kobo.994.2">Feel free to check the following link for more </span><span class="No-Break"><span class="koboSpan" id="kobo.995.1">information: </span></span><a href="https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console"><span class="No-Break"><span class="koboSpan" id="kobo.996.1">https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.997.1">.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.998.1">In the same file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.999.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.1000.1">), add the following block of code to define </span><strong class="source-inline"><span class="koboSpan" id="kobo.1001.1">google_compute_network</span></strong><span class="koboSpan" id="kobo.1002.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1003.1">google_compute_subnetwork</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1004.1"> resources:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1005.1">
resource "google_compute_network" "</span><strong class="bold"><span class="koboSpan" id="kobo.1006.1">vpc_01</span></strong><span class="koboSpan" id="kobo.1007.1">" {
  name = "vpc-01"
  auto_create_subnetworks = "false"
}
resource "google_compute_subnetwork" "</span><strong class="bold"><span class="koboSpan" id="kobo.1008.1">subnet_01</span></strong><span class="koboSpan" id="kobo.1009.1">" {
  name          = "subnet-01"
  ip_cidr_range = "10.1.0.0/20"
  region        = "us-central1"
  network       = google_compute_network.vpc_01.name
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1010.1">Here, we define a </span><a id="_idIndexMarker429"/><span class="koboSpan" id="kobo.1011.1">VPC network with a single subnet </span><a id="_idIndexMarker430"/><span class="koboSpan" id="kobo.1012.1">with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1013.1">10.1.0.0/20</span></strong> <strong class="bold"><span class="koboSpan" id="kobo.1014.1">Classless Inter-Domain Routing</span></strong><span class="koboSpan" id="kobo.1015.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1016.1">CIDR</span></strong><span class="koboSpan" id="kobo.1017.1">) range. </span><span class="koboSpan" id="kobo.1017.2">Since </span><strong class="source-inline"><span class="koboSpan" id="kobo.1018.1">auto_create_subnetworks</span></strong><span class="koboSpan" id="kobo.1019.1"> is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1020.1">false</span></strong><span class="koboSpan" id="kobo.1021.1">, no other subnets will be created (other than the subnet we </span><span class="No-Break"><span class="koboSpan" id="kobo.1022.1">just defined).</span></span></p></li> <li><span class="koboSpan" id="kobo.1023.1">In the same file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1024.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.1025.1">), define </span><strong class="source-inline"><span class="koboSpan" id="kobo.1026.1">vpc_02</span></strong><span class="koboSpan" id="kobo.1027.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1028.1">subnet_02</span></strong><span class="koboSpan" id="kobo.1029.1"> resources </span><span class="No-Break"><span class="koboSpan" id="kobo.1030.1">as well:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1031.1">
resource "google_compute_network" "</span><strong class="bold"><span class="koboSpan" id="kobo.1032.1">vpc_02</span></strong><span class="koboSpan" id="kobo.1033.1">" {
  name = "vpc-02"
  auto_create_subnetworks = "false"
}
resource "google_compute_subnetwork" "</span><strong class="bold"><span class="koboSpan" id="kobo.1034.1">subnet_02</span></strong><span class="koboSpan" id="kobo.1035.1">" {
  name          = "subnet-02"
  ip_cidr_range = "10.2.0.0/20"
  region        = "us-central1"
  network       = google_compute_network.vpc_02.name
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1036.1">We will launch the attacker VM instance in these network resources later in </span><span class="No-Break"><span class="koboSpan" id="kobo.1037.1">this chapter.</span></span></p></li> <li><span class="koboSpan" id="kobo.1038.1">In the same file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1039.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.1040.1">), let’s define two </span><strong class="source-inline"><span class="koboSpan" id="kobo.1041.1">net_01</span></strong><span class="koboSpan" id="kobo.1042.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1043.1">net_02</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1044.1">local values:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1045.1">
locals {
  </span><strong class="bold"><span class="koboSpan" id="kobo.1046.1">net_01</span></strong><span class="koboSpan" id="kobo.1047.1"> = google_compute_network.vpc_01.self_link
  </span><strong class="bold"><span class="koboSpan" id="kobo.1048.1">net_02</span></strong><span class="koboSpan" id="kobo.1049.1"> = google_compute_network.vpc_02.self_link
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1050.1">We’ll use these local values when defining the other networking resources in the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.1051.1">of steps.</span></span></p></li> <li><span class="koboSpan" id="kobo.1052.1">In the same</span><a id="_idIndexMarker431"/><span class="koboSpan" id="kobo.1053.1"> file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1054.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.1055.1">), let’s define two </span><strong class="source-inline"><span class="koboSpan" id="kobo.1056.1">google_compute_network_peering</span></strong><span class="koboSpan" id="kobo.1057.1"> resources using the following blocks of code—one from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1058.1">vpc-01</span></strong><span class="koboSpan" id="kobo.1059.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1060.1">vpc-02</span></strong><span class="koboSpan" id="kobo.1061.1"> and another from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1062.1">vpc-02</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1063.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1064.1">vpc-01</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1065.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1066.1">
resource "google_compute_network_peering" "</span><strong class="bold"><span class="koboSpan" id="kobo.1067.1">peer_01_to_02</span></strong><span class="koboSpan" id="kobo.1068.1">" {
  name         = "peer-01-to-02"
  network      = local.net_01
  peer_network = local.net_02
}
resource "google_compute_network_peering" "</span><strong class="bold"><span class="koboSpan" id="kobo.1069.1">peer_02_to_01</span></strong><span class="koboSpan" id="kobo.1070.1">" {
  name         = "peer-02-to-01"
  network      = local.net_02
  peer_network = local.net_01
}</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1071.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1072.1">In order for VPC Network Peering to work properly, the CIDR blocks of the VPCs involved should </span><em class="italic"><span class="koboSpan" id="kobo.1073.1">NOT</span></em><span class="koboSpan" id="kobo.1074.1"> overlap. </span><span class="koboSpan" id="kobo.1074.2">In our case, our setup should work just fine since the CIDR blocks of </span><strong class="bold"><span class="koboSpan" id="kobo.1075.1">VPC 01</span></strong><span class="koboSpan" id="kobo.1076.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1077.1">10.1.0.0/20</span></strong><span class="koboSpan" id="kobo.1078.1">-</span><strong class="source-inline"><span class="koboSpan" id="kobo.1079.1">10.1.0.0</span></strong><span class="koboSpan" id="kobo.1080.1">-</span><strong class="source-inline"><span class="koboSpan" id="kobo.1081.1">10.1.15.255</span></strong><span class="koboSpan" id="kobo.1082.1">) and </span><strong class="bold"><span class="koboSpan" id="kobo.1083.1">VPC 02</span></strong><span class="koboSpan" id="kobo.1084.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1085.1">10.2.0.0/20</span></strong><span class="koboSpan" id="kobo.1086.1">-</span><strong class="source-inline"><span class="koboSpan" id="kobo.1087.1">10.2.0.0</span></strong><span class="koboSpan" id="kobo.1088.1">-</span><strong class="source-inline"><span class="koboSpan" id="kobo.1089.1">10.2.15.255</span></strong><span class="koboSpan" id="kobo.1090.1">) do not overlap. </span><span class="koboSpan" id="kobo.1090.2">Feel free to use an online subnet calculator to </span><span class="No-Break"><span class="koboSpan" id="kobo.1091.1">verify this.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.1092.1">In the same</span><a id="_idIndexMarker432"/><span class="koboSpan" id="kobo.1093.1"> file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1094.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.1095.1">), let’s define </span><strong class="source-inline"><span class="koboSpan" id="kobo.1096.1">allow-all-from-vpc2</span></strong><span class="koboSpan" id="kobo.1097.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1098.1">allow-all-from-vpc-1</span></strong><span class="koboSpan" id="kobo.1099.1"> firewalls using the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.1100.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1101.1">
resource "google_compute_firewall" "</span><strong class="bold"><span class="koboSpan" id="kobo.1102.1">allow-all-from-vpc2</span></strong><span class="koboSpan" id="kobo.1103.1">" {
  name    = "allow-all-from-vpc-2"
  network = local.net_01
  allow {
    protocol = "all"
  }
  source_ranges = ["10.2.0.0/20"]
  priority = 10000
}
resource "google_compute_firewall" "</span><strong class="bold"><span class="koboSpan" id="kobo.1104.1">allow-all-from-vpc1</span></strong><span class="koboSpan" id="kobo.1105.1">" {
  name    = "allow-all-from-vpc-1"
  network = local.net_02
  allow {
    protocol = "all"
  }
  source_ranges = ["10.1.0.0/20"]
  priority = 20000
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1106.1">These blocks will (1) allow traffic from resources deployed in </span><strong class="bold"><span class="koboSpan" id="kobo.1107.1">VPC 02</span></strong><span class="koboSpan" id="kobo.1108.1"> to reach resources </span><a id="_idIndexMarker433"/><span class="koboSpan" id="kobo.1109.1">deployed in </span><strong class="bold"><span class="koboSpan" id="kobo.1110.1">VPC 01</span></strong><span class="koboSpan" id="kobo.1111.1"> (that is, from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1112.1">10.2.0.0/20</span></strong><span class="koboSpan" id="kobo.1113.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1114.1">10.1.0.0/20</span></strong><span class="koboSpan" id="kobo.1115.1">) and (2) allow traffic from resources deployed in </span><strong class="bold"><span class="koboSpan" id="kobo.1116.1">VPC 01</span></strong><span class="koboSpan" id="kobo.1117.1"> to reach resources deployed in </span><strong class="bold"><span class="koboSpan" id="kobo.1118.1">VPC 02</span></strong><span class="koboSpan" id="kobo.1119.1"> (that is, from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1120.1">10.1.0.0/20</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1121.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1122.1">10.2.0.0/20</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1123.1">).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1124.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1125.1">Priority numbers in GCP firewall rules determine the order in which rules are evaluated. </span><span class="koboSpan" id="kobo.1125.2">The </span><em class="italic"><span class="koboSpan" id="kobo.1126.1">lower</span></em><span class="koboSpan" id="kobo.1127.1"> the priority number, the </span><em class="italic"><span class="koboSpan" id="kobo.1128.1">higher</span></em><span class="koboSpan" id="kobo.1129.1"> the priority of the rule. </span><span class="koboSpan" id="kobo.1129.2">GCP evaluates firewall rules in ascending order based on priority numbers until a matching rule is found, at which point the evaluation stops. </span><span class="koboSpan" id="kobo.1129.3">That said, it is important to assign unique and appropriately sequenced priority numbers to ensure that the desired firewall rules are applied correctly and in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1130.1">intended order.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1131.1">In the same file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1132.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.1133.1">), let’s define </span><strong class="source-inline"><span class="koboSpan" id="kobo.1134.1">allow-ssh-from-my-ip</span></strong><span class="koboSpan" id="kobo.1135.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1136.1">allow-desktop-access-from-my-ip</span></strong><span class="koboSpan" id="kobo.1137.1"> firewalls using the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.1138.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1139.1">
resource "google_compute_firewall" "</span><strong class="bold"><span class="koboSpan" id="kobo.1140.1">allow-ssh-from-my-ip</span></strong><span class="koboSpan" id="kobo.1141.1">" {
  name    = "allow-ssh-from-my-ip"
  network = local.net_02
  allow {
    protocol = "tcp"
    ports    = ["</span><strong class="bold"><span class="koboSpan" id="kobo.1142.1">22</span></strong><span class="koboSpan" id="kobo.1143.1">"]
  }
  source_ranges = ["${var.my_ip}/32"]
  priority = 30000
}
resource "google_compute_firewall" "</span><strong class="bold"><span class="koboSpan" id="kobo.1144.1">allow-desktop-access-from-my-ip</span></strong><span class="koboSpan" id="kobo.1145.1">" {
  name    = "allow-desktop-access-from-my-ip"
  network = local.net_02
  allow {
    protocol = "tcp"
    ports    = ["</span><strong class="bold"><span class="koboSpan" id="kobo.1146.1">8081</span></strong><span class="koboSpan" id="kobo.1147.1">"]
  }
  source_ranges = ["${var.my_ip}/32"]
  priority = 40000
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1148.1">These firewall</span><a id="_idIndexMarker434"/><span class="koboSpan" id="kobo.1149.1"> rules will allow your local machine to access resources launched inside </span><strong class="bold"><span class="koboSpan" id="kobo.1150.1">VPC 02</span></strong><span class="koboSpan" id="kobo.1151.1"> (via ports </span><strong class="source-inline"><span class="koboSpan" id="kobo.1152.1">22</span></strong><span class="koboSpan" id="kobo.1153.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1154.1">8081</span></strong><span class="koboSpan" id="kobo.1155.1">) once the entire penetration lab environment has been </span><span class="No-Break"><span class="koboSpan" id="kobo.1156.1">set up.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1157.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1158.1">Make sure to save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1159.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.1160.1"> file (</span><strong class="bold"><span class="koboSpan" id="kobo.1161.1">File</span></strong><span class="koboSpan" id="kobo.1162.1"> menu &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1163.1">Save</span></strong><span class="koboSpan" id="kobo.1164.1">) before running the terminal commands in the succeeding set </span><span class="No-Break"><span class="koboSpan" id="kobo.1165.1">of steps.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.1166.1">Now, let’s open </span><strong class="source-inline"><span class="koboSpan" id="kobo.1167.1">secure_network/outputs.tf</span></strong><span class="koboSpan" id="kobo.1168.1"> in the editor. </span><span class="koboSpan" id="kobo.1168.2">Add the following blocks of code to define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1169.1">subnet_01</span></strong><span class="koboSpan" id="kobo.1170.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1171.1">subnet_02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1172.1"> outputs:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1173.1">
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1174.1">subnet_01</span></strong><span class="koboSpan" id="kobo.1175.1">" {
  value = google_compute_subnetwork.subnet_01.id
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1176.1">subnet_02</span></strong><span class="koboSpan" id="kobo.1177.1">" {
  value = google_compute_subnetwork.subnet_02.id
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1178.1">Make sure to save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1179.1">secure_network/outputs.tf</span></strong><span class="koboSpan" id="kobo.1180.1"> file as well before proceeding to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1181.1">next step.</span></span></p></li> <li><span class="koboSpan" id="kobo.1182.1">Navigate to</span><a id="_idIndexMarker435"/><span class="koboSpan" id="kobo.1183.1"> our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1184.1">pentest_lab</span></strong><span class="koboSpan" id="kobo.1185.1"> project directory, </span><span class="No-Break"><span class="koboSpan" id="kobo.1186.1">like so:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1187.1">cd ~/pentest_lab</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1188.1">Let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1189.1">terraform init</span></strong><span class="koboSpan" id="kobo.1190.1"> command to reinitialize the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.1191.1">working directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1192.1">terraform init</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1193.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1194.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1195.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1196.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1197.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1198.1">This should give us a </span><strong class="bold"><span class="koboSpan" id="kobo.1199.1">Missing required argument — The argument “my_ip” is required, but no definition was found</span></strong><span class="koboSpan" id="kobo.1200.1"> error message since we have not provided any value for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1201.1">my_ip</span></strong><span class="koboSpan" id="kobo.1202.1"> argument while declaring the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1203.1">secure_network</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1204.1"> module.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1205.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1206.1">If you’re wondering why this issue has suddenly occurred, it’s important to recall that we defined the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1207.1">my_ip</span></strong><span class="koboSpan" id="kobo.1208.1"> variable in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1209.1">secure_network/variables.tf</span></strong><span class="koboSpan" id="kobo.1210.1"> file in an </span><span class="No-Break"><span class="koboSpan" id="kobo.1211.1">earlier step.</span></span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.1212.1">To resolve the issue encountered in the previous step, we need to provide a value for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1213.1">my_ip</span></strong><span class="koboSpan" id="kobo.1214.1"> argument when declaring the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1215.1">secure_network</span></strong><span class="koboSpan" id="kobo.1216.1"> module (similar to what </span><a id="_idIndexMarker436"/><span class="koboSpan" id="kobo.1217.1">we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1218.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1219.1">.16</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1220.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer081">
<span class="koboSpan" id="kobo.1221.1"><img alt="" src="image/B19755_04_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1222.1">Figure 4.16 – Passing the my_ip variable value to the my_ip input variable of the secure_network module</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1223.1">Using </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1224.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1225.1">.16</span></em><span class="koboSpan" id="kobo.1226.1"> as a reference, we will resolve the issue by passing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1227.1">my_ip</span></strong><span class="koboSpan" id="kobo.1228.1"> variable value (of the root module) to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1229.1">my_ip</span></strong><span class="koboSpan" id="kobo.1230.1"> input variable of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1231.1">secure_network</span></strong><span class="koboSpan" id="kobo.1232.1"> module. </span><span class="koboSpan" id="kobo.1232.2">Since we had the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1233.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.1234.1"> file prepared in an earlier step, the default variable values for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1235.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.1236.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1237.1">my_ip</span></strong><span class="koboSpan" id="kobo.1238.1"> will be loaded from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1239.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.1240.1"> file when we run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1241.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1242.1"> command in a </span><span class="No-Break"><span class="koboSpan" id="kobo.1243.1">later step.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1244.1">Now that we</span><a id="_idIndexMarker437"/><span class="koboSpan" id="kobo.1245.1"> have a better idea of how to resolve the issue, let’s locate the following block of code in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1246.1">main.tf</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1247.1">file (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1248.1">~/pentest_lab/main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1249.1">):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1250.1">
module "secure_network" {
  source = "./secure_network"
}</span></pre>
<p class="list-inset"><span class="koboSpan" id="kobo.1251.1">Update it with the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.1252.1">of code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1253.1">
module "secure_network" {
  source = "./secure_network"
  
  </span><strong class="bold"><span class="koboSpan" id="kobo.1254.1">my_ip = var.my_ip</span></strong><span class="koboSpan" id="kobo.1255.1">
}</span></pre>
<p class="list-inset"><span class="koboSpan" id="kobo.1256.1">Here, we are passing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1257.1">my_ip</span></strong><span class="koboSpan" id="kobo.1258.1"> variable value to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1259.1">my_ip</span></strong><span class="koboSpan" id="kobo.1260.1"> input variable of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1261.1">secure_network</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1262.1"> module.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1263.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1264.1">Make sure to save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1265.1">main.tf</span></strong><span class="koboSpan" id="kobo.1266.1"> file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1267.1">~/pentest_lab/main.tf</span></strong><span class="koboSpan" id="kobo.1268.1">) before proceeding to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1269.1">next step.</span></span></p>
<ol>
<li value="16"><span class="koboSpan" id="kobo.1270.1">In the Cloud Shell terminal (right after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1271.1">$</span></strong><span class="koboSpan" id="kobo.1272.1"> sign), let’s run the following command to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1273.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1274.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1275.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.1276.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1277.1">...
</span><span class="koboSpan" id="kobo.1277.2">Plan: 11 to add, 0 to change, 0 to destroy.
</span><span class="koboSpan" id="kobo.1277.3">...</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1278.1">We should be able to proceed without encountering an error </span><span class="No-Break"><span class="koboSpan" id="kobo.1279.1">this time.</span></span></p></li> <li><span class="koboSpan" id="kobo.1280.1">Next, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1281.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1282.1"> command to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.1283.1">the changes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1284.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1285.1">Running the command should return the </span><span class="No-Break"><span class="koboSpan" id="kobo.1286.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1287.1">...
</span><span class="koboSpan" id="kobo.1287.2">Apply complete! </span><span class="koboSpan" id="kobo.1287.3">Resources: 11 added, 0 changed, 0 destroyed.</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1288.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1289.1">Wait for a few minutes for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1290.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1291.1"> command </span><span class="No-Break"><span class="koboSpan" id="kobo.1292.1">to complete.</span></span></p>
<ol>
<li value="18"><span class="koboSpan" id="kobo.1293.1">Now, let’s check</span><a id="_idIndexMarker438"/><span class="koboSpan" id="kobo.1294.1"> the resources created by Terraform using the console. </span><span class="koboSpan" id="kobo.1294.2">Navigate to the list of existing VPC networks by typing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1295.1">vpc networks</span></strong><span class="koboSpan" id="kobo.1296.1"> in the search bar and then selecting </span><strong class="bold"><span class="koboSpan" id="kobo.1297.1">VPC networks</span></strong><span class="koboSpan" id="kobo.1298.1"> from the </span><span class="No-Break"><span class="koboSpan" id="kobo.1299.1">search results:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer082">
<span class="koboSpan" id="kobo.1300.1"><img alt="" src="image/B19755_04_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1301.1">Figure 4.17 – List of VPC networks</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1302.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1303.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1304.1">.17</span></em><span class="koboSpan" id="kobo.1305.1">, we can see that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1306.1">vpc-01</span></strong><span class="koboSpan" id="kobo.1307.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1308.1">vpc-02</span></strong><span class="koboSpan" id="kobo.1309.1"> VPC networks have been created by Terraform successfully. </span><span class="koboSpan" id="kobo.1309.2">Here, we can also see that both </span><strong class="source-inline"><span class="koboSpan" id="kobo.1310.1">vpc-01</span></strong><span class="koboSpan" id="kobo.1311.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1312.1">vpc-02</span></strong><span class="koboSpan" id="kobo.1313.1"> have a single subnet each (indicated by the count under the </span><strong class="bold"><span class="koboSpan" id="kobo.1314.1">Subnets</span></strong><span class="koboSpan" id="kobo.1315.1"> column). </span><span class="koboSpan" id="kobo.1315.2">Feel free to click the </span><strong class="bold"><span class="koboSpan" id="kobo.1316.1">REFRESH</span></strong><span class="koboSpan" id="kobo.1317.1"> button in case the list does not reflect the new VPCs we </span><span class="No-Break"><span class="koboSpan" id="kobo.1318.1">just created.</span></span></p></li>
</ol>
<ol>
<li value="19"><span class="koboSpan" id="kobo.1319.1">Let’s check the </span><a id="_idIndexMarker439"/><span class="koboSpan" id="kobo.1320.1">VPC network where we’ll host the target VM instance. </span><span class="koboSpan" id="kobo.1320.2">Click </span><strong class="source-inline"><span class="koboSpan" id="kobo.1321.1">vpc-01</span></strong><span class="koboSpan" id="kobo.1322.1"> from the list of VPC networks to navigate to the VPC network details page of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1323.1">said VPC:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer083">
<span class="koboSpan" id="kobo.1324.1"><img alt="" src="image/B19755_04_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1325.1">Figure 4.18 – VPC network details</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1326.1">We should see that we only have a single subnet inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.1327.1">vpc-01</span></strong><span class="koboSpan" id="kobo.1328.1">, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1329.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1330.1">.18</span></em><span class="koboSpan" id="kobo.1331.1">. </span><span class="koboSpan" id="kobo.1331.2">You may also check the resources under the </span><strong class="bold"><span class="koboSpan" id="kobo.1332.1">FIREWALLS</span></strong><span class="koboSpan" id="kobo.1333.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.1334.1">VPC NETWORK PEERING</span></strong><span class="koboSpan" id="kobo.1335.1"> tabs to verify that these resources have been created and </span><span class="No-Break"><span class="koboSpan" id="kobo.1336.1">configured correctly.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1337.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1338.1">You may navigate back to the list of VPC networks and check </span><strong class="source-inline"><span class="koboSpan" id="kobo.1339.1">vpc-02</span></strong><span class="koboSpan" id="kobo.1340.1"> along with the other resources created using the Google Cloud console </span><span class="No-Break"><span class="koboSpan" id="kobo.1341.1">as well.</span></span></p>
<p><em class="italic"><span class="koboSpan" id="kobo.1342.1">Wasn’t that easy?</span></em><span class="koboSpan" id="kobo.1343.1"> Without further ado, let’s move on to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1344.1">next section.</span></span></p>
<h1 id="_idParaDest-77"><a id="_idTextAnchor076"/><span class="koboSpan" id="kobo.1345.1">Setting up the target VM instance</span></h1>
<p><span class="koboSpan" id="kobo.1346.1">With our isolated network</span><a id="_idIndexMarker440"/><span class="koboSpan" id="kobo.1347.1"> environment ready, we can now proceed with setting up the target VM instance. </span><span class="koboSpan" id="kobo.1347.2">In this section, we will set up the target VM instance in the subnet of </span><strong class="bold"><span class="koboSpan" id="kobo.1348.1">VPC 01</span></strong><span class="koboSpan" id="kobo.1349.1">, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1350.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1351.1">.19</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1352.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer084">
<span class="koboSpan" id="kobo.1353.1"><img alt="" src="image/B19755_04_19.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1354.1">Figure 4.19 – Setting up the target VM instance in the subnet of VPC 01</span></p>
<p><span class="koboSpan" id="kobo.1355.1">Inside the target</span><a id="_idIndexMarker441"/><span class="koboSpan" id="kobo.1356.1"> VM instance, we will be running an intentionally vulnerable application</span><a id="_idIndexMarker442"/><span class="koboSpan" id="kobo.1357.1"> called </span><strong class="bold"><span class="koboSpan" id="kobo.1358.1">OWASP Juice Shop</span></strong><span class="koboSpan" id="kobo.1359.1">. </span><span class="koboSpan" id="kobo.1359.2">OWASP Juice Shop was designed, developed, and prepared by the </span><strong class="bold"><span class="koboSpan" id="kobo.1360.1">Open Web Application Security Project</span></strong><span class="koboSpan" id="kobo.1361.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1362.1">OWASP</span></strong><span class="koboSpan" id="kobo.1363.1">) to help developers, security engineers, and </span><a id="_idIndexMarker443"/><span class="koboSpan" id="kobo.1364.1">penetration testers enhance their understanding of secure coding practices and vulnerability identification, along with various mitigation strategies. </span><span class="koboSpan" id="kobo.1364.2">To simplify the setup and installation of the OWASP Juice Shop application in our VM instance, we will utilize the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1365.1">bkimminich/juice-shop</span></strong><span class="koboSpan" id="kobo.1366.1"> container image. </span><span class="koboSpan" id="kobo.1366.2">This container image will allow us to run the vulnerable-by-design application inside </span><span class="No-Break"><span class="koboSpan" id="kobo.1367.1">a container.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1368.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1369.1">If you are wondering what </span><strong class="bold"><span class="koboSpan" id="kobo.1370.1">containers</span></strong><span class="koboSpan" id="kobo.1371.1"> are, they are simply lightweight and isolated runtime environments that provide a </span><a id="_idIndexMarker444"/><span class="koboSpan" id="kobo.1372.1">consistent and portable way to run applications across various computing environments. </span><span class="koboSpan" id="kobo.1372.2">On the other hand, container images (such as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1373.1">bkimminich/juice-shop</span></strong><span class="koboSpan" id="kobo.1374.1"> container image) are templates that contain the necessary files and configurations to create and run containers. </span><span class="koboSpan" id="kobo.1374.2">They include the application code, along with all the prerequisites required to execute an application within a </span><span class="No-Break"><span class="koboSpan" id="kobo.1375.1">containerized environment.</span></span></p>
<p><span class="koboSpan" id="kobo.1376.1">Containers </span><a id="_idIndexMarker445"/><span class="koboSpan" id="kobo.1377.1">allow </span><a id="_idIndexMarker446"/><span class="koboSpan" id="kobo.1378.1">different vulnerable-by-design applications to coexist inside the VM instance without interfering with each other. </span><span class="koboSpan" id="kobo.1378.2">That said, while we are planning to have only one container running inside the target VM instance, it is worth mentioning that running multiple intentionally vulnerable applications inside containers on the same VM instance is possible </span><span class="No-Break"><span class="koboSpan" id="kobo.1379.1">as well.</span></span></p>
<p><span class="koboSpan" id="kobo.1380.1">This section is divided into the </span><span class="No-Break"><span class="koboSpan" id="kobo.1381.1">following subparts:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.1382.1">Part 1 of 2 – Preparing the target VM instance </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1383.1">using Terraform</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1384.1">Part 2 of 2 – Using the serial console to access the target </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1385.1">VM instance</span></em></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1386.1">Without further ado, </span><span class="No-Break"><span class="koboSpan" id="kobo.1387.1">let’s begin!</span></span></p>
<h2 id="_idParaDest-78"><a id="_idTextAnchor077"/><span class="koboSpan" id="kobo.1388.1">Part 1 of 2 – Preparing the target VM instance using Terraform</span></h2>
<p><span class="koboSpan" id="kobo.1389.1">Follow</span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.1390.1"> the </span><span class="No-Break"><span class="koboSpan" id="kobo.1391.1">next steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1392.1">Navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1393.1">~/pentest_lab/target_vm</span></strong><span class="koboSpan" id="kobo.1394.1"> directory by running the following in the Cloud </span><span class="No-Break"><span class="koboSpan" id="kobo.1395.1">Shell Terminal</span></span><span class="No-Break"><span class="koboSpan" id="kobo.1396.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1397.1">cd ~/pentest_lab</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1398.1">cd target_vm</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1399.1">Run the following commands to create the files we’ll need in our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1400.1">target_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1401.1"> module:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1402.1">touch main.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1403.1">touch variables.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1404.1">touch outputs.tf</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1405.1">Open a new browser tab and navigate to this book’s official GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.1406.1">repository: </span></span><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/"><span class="No-Break"><span class="koboSpan" id="kobo.1407.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1408.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1409.1">Locate the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1410.1">target_boot_script.tpl</span></strong><span class="koboSpan" id="kobo.1411.1"> template file inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1412.1">ch04/pentest_lab/target_vm</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1413.1">directory (</span></span><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/tree/main/ch04/pentest_lab/target_vm/target_boot_script.tpl"><span class="No-Break"><span class="koboSpan" id="kobo.1414.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/tree/main/ch04/pentest_lab/target_vm/target_boot_script.tpl</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1415.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer085">
<span class="koboSpan" id="kobo.1416.1"><img alt="" src="image/B19755_04_20.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1417.1">Figure 4.20 – Copy Link Address option</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1418.1">Right-click on the </span><strong class="bold"><span class="koboSpan" id="kobo.1419.1">Raw</span></strong><span class="koboSpan" id="kobo.1420.1"> button and select </span><strong class="bold"><span class="koboSpan" id="kobo.1421.1">Copy Link Address</span></strong><span class="koboSpan" id="kobo.1422.1"> from the list of options in the context menu (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1423.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1424.1">.20</span></em><span class="koboSpan" id="kobo.1425.1">). </span><span class="koboSpan" id="kobo.1425.2">This will copy the link address of the file to the clipboard of your </span><span class="No-Break"><span class="koboSpan" id="kobo.1426.1">local machine.</span></span></p></li>
</ol>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1427.1">Download</span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.1428.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1429.1">target_boot_script.tpl</span></strong><span class="koboSpan" id="kobo.1430.1"> template file using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1431.1">wget</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1432.1"> command:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1433.1">
wget -O target_boot_script.tpl </span><strong class="bold"><span class="koboSpan" id="kobo.1434.1">&lt;DOWNLOAD LINK&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1435.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1436.1">&lt;DOWNLOAD LINK&gt;</span></strong><span class="koboSpan" id="kobo.1437.1"> with the link copied earlier (it should be in your clipboard after selecting </span><strong class="bold"><span class="koboSpan" id="kobo.1438.1">Copy Link Address</span></strong><span class="koboSpan" id="kobo.1439.1"> from the context </span><span class="No-Break"><span class="koboSpan" id="kobo.1440.1">menu options).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1441.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1442.1">You may also use this link instead for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1443.1">&lt;DOWNLOAD </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1444.1">LINK&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1445.1"> value:</span></span></p>
<p class="callout"><a href="https://raw.githubusercontent.com/PacktPublishing/Building-Penetration-Testing-Labs-in-the-Cloud/main/ch04/pentest_lab/target_vm/target_boot_script.tpl"><span class="No-Break"><span class="koboSpan" id="kobo.1446.1">https://raw.githubusercontent.com/PacktPublishing/Building-Penetration-Testing-Labs-in-the-Cloud/main/ch04/pentest_lab/target_vm/target_boot_script.tpl</span></span></a></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1447.1">Let’s quickly </span><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.1448.1">check the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1449.1">target_boot_script.tpl</span></strong><span class="koboSpan" id="kobo.1450.1"> file we downloaded using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1451.1">cat</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1452.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1453.1">cat target_boot_script.tpl</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1454.1">Spend a few minutes reading the code inside the file. </span><span class="koboSpan" id="kobo.1454.2">You’ll see that the script is divided into three parts, </span><span class="No-Break"><span class="koboSpan" id="kobo.1455.1">as follows:</span></span></p><ul><li><strong class="bold"><span class="koboSpan" id="kobo.1456.1">SET UP USER</span></strong><span class="koboSpan" id="kobo.1457.1">—Running the script creates a new user on the system, sets a password for that user, and then grants the new user </span><strong class="source-inline"><span class="koboSpan" id="kobo.1458.1">sudo</span></strong><span class="koboSpan" id="kobo.1459.1"> privileges (without requiring </span><span class="No-Break"><span class="koboSpan" id="kobo.1460.1">a password)</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1461.1">INSTALL DOCKER</span></strong><span class="koboSpan" id="kobo.1462.1">—Here, we run a few commands for installing Docker on the system where the script </span><span class="No-Break"><span class="koboSpan" id="kobo.1463.1">will run</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1464.1">SET UP OWASP JUICE SHOP</span></strong><span class="koboSpan" id="kobo.1465.1">—This portion of the script focuses on running the OWASP Juice Shop application in a Docker container and making it accessible on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.1466.1">80</span></strong><span class="koboSpan" id="kobo.1467.1"> of the host machine where the script </span><span class="No-Break"><span class="koboSpan" id="kobo.1468.1">will run</span></span></li></ul></li> <li><span class="koboSpan" id="kobo.1469.1">Now, let’s open a new browser tab and locate the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1470.1">wait_for_boot.tpl</span></strong><span class="koboSpan" id="kobo.1471.1"> template file inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1472.1">ch04/pentest_lab/target_vm</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1473.1">directory (</span></span><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/tree/main/ch04/pentest_lab/target_vm/wait_for_boot.tpl"><span class="No-Break"><span class="koboSpan" id="kobo.1474.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/tree/main/ch04/pentest_lab/target_vm/wait_for_boot.tpl</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1475.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer086">
<span class="koboSpan" id="kobo.1476.1"><img alt="" src="image/B19755_04_21.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1477.1">Figure 4.21 – Copy Link Address option</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1478.1">Right-click on the </span><strong class="bold"><span class="koboSpan" id="kobo.1479.1">Raw</span></strong><span class="koboSpan" id="kobo.1480.1"> button and select </span><strong class="bold"><span class="koboSpan" id="kobo.1481.1">Copy Link Address</span></strong><span class="koboSpan" id="kobo.1482.1"> from the list of options in the context menu (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1483.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1484.1">.21</span></em><span class="koboSpan" id="kobo.1485.1">). </span><span class="koboSpan" id="kobo.1485.2">This will copy the link address of the file to the clipboard of your </span><span class="No-Break"><span class="koboSpan" id="kobo.1486.1">local machine.</span></span></p></li>
</ol>
<ol>
<li value="8"><span class="koboSpan" id="kobo.1487.1">Download</span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.1488.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1489.1">wait_for_boot.tpl</span></strong><span class="koboSpan" id="kobo.1490.1"> template file using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1491.1">wget</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1492.1"> command:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1493.1">
wget -O wait_for_boot.tpl </span><strong class="bold"><span class="koboSpan" id="kobo.1494.1">&lt;DOWNLOAD LINK&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1495.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1496.1">&lt;DOWNLOAD LINK&gt;</span></strong><span class="koboSpan" id="kobo.1497.1"> with the link copied earlier (it should be in your clipboard after selecting </span><strong class="bold"><span class="koboSpan" id="kobo.1498.1">Copy Link Address</span></strong><span class="koboSpan" id="kobo.1499.1"> from the context </span><span class="No-Break"><span class="koboSpan" id="kobo.1500.1">menu options).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1501.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1502.1">You may also use this link instead for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1503.1">&lt;DOWNLOAD </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1504.1">LINK&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1505.1"> value:</span></span></p>
<p class="callout"><a href="https://raw.githubusercontent.com/PacktPublishing/Building-Penetration-Testing-Labs-in-the-Cloud/main/ch04/pentest_lab/target_vm/wait_for_boot.tpl"><span class="No-Break"><span class="koboSpan" id="kobo.1506.1">https://raw.githubusercontent.com/PacktPublishing/Building-Penetration-Testing-Labs-in-the-Cloud/main/ch04/pentest_lab/target_vm/wait_for_boot.tpl</span></span></a></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.1507.1">Let’s quickly check the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1508.1">wait_for_boot.tpl</span></strong><span class="koboSpan" id="kobo.1509.1"> file we downloaded using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1510.1">cat</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1511.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1512.1">cat wait_for_boot.tpl</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1513.1">Spend a minute or two reading the code inside the file. </span><span class="koboSpan" id="kobo.1513.2">You’ll see that the script simply waits for the target boot script (based on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1514.1">target_boot_script.tpl</span></strong><span class="koboSpan" id="kobo.1515.1"> template script file) to finish running. </span><span class="koboSpan" id="kobo.1515.2">The script loops for a certain number of retry attempts and checks if the target boot script has executed the following line </span><span class="No-Break"><span class="koboSpan" id="kobo.1516.1">of code:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1517.1">echo "SCRIPT: COMPLETE"</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1518.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1519.1">Make sure that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1520.1">target_boot_script.tpl</span></strong><span class="koboSpan" id="kobo.1521.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1522.1">wait_for_boot.tpl</span></strong><span class="koboSpan" id="kobo.1523.1"> template files are inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1524.1">pentest_lab/target_vm</span></strong><span class="koboSpan" id="kobo.1525.1"> directory </span><span class="No-Break"><span class="koboSpan" id="kobo.1526.1">before proceeding.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1527.1">Now, let’s </span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.1528.1">open </span><strong class="source-inline"><span class="koboSpan" id="kobo.1529.1">target_vm/variables.tf</span></strong><span class="koboSpan" id="kobo.1530.1"> in the editor and add the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.1531.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1532.1">
variable "subnet_01" {
    type = string
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1533.1">Here, we’ll define a single variable that will be used when configuring in which subnet the VM instance will </span><span class="No-Break"><span class="koboSpan" id="kobo.1534.1">be launched.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1535.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1536.1">Make sure to save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1537.1">target_vm/variables.tf</span></strong><span class="koboSpan" id="kobo.1538.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1539.1">before proceeding.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.1540.1">Now, let’s open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1541.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1542.1"> file in the editor. </span><span class="koboSpan" id="kobo.1542.2">We will add several blocks of code in the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.1543.1">of steps.</span></span></li>
<li><span class="koboSpan" id="kobo.1544.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1545.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1546.1"> file, let’s define a resource called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1547.1">random_password</span></strong><span class="koboSpan" id="kobo.1548.1"> that generates a random string of length </span><strong class="source-inline"><span class="koboSpan" id="kobo.1549.1">12</span></strong><span class="koboSpan" id="kobo.1550.1"> with </span><span class="No-Break"><span class="koboSpan" id="kobo.1551.1">special characters:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1552.1">
resource "random_string" "</span><strong class="bold"><span class="koboSpan" id="kobo.1553.1">random_password</span></strong><span class="koboSpan" id="kobo.1554.1">" {
  length           = 12
  special          = true
  override_special = "!#$%&amp;"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1555.1">Here, we provide our own list of special characters to be used when generating the random password value. </span><span class="koboSpan" id="kobo.1555.2">If you are wondering where we’ll use this generated password, we will use it when accessing the target VM instance (via the serial console) in the succeeding set </span><span class="No-Break"><span class="koboSpan" id="kobo.1556.1">of steps.</span></span></p></li> <li><span class="koboSpan" id="kobo.1557.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1558.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1559.1"> file, let’s define a few local variables that we will use when configuring our VM</span><a id="_idIndexMarker452"/><span class="koboSpan" id="kobo.1560.1"> instance (before defining our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1561.1">google_compute_instance</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1562.1"> resource):</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1563.1">
locals {
    vm_username = "testuser"
    vm_password = random_string.random_password.result
}
locals {
  script = templatefile("${path.module}/</span><strong class="bold"><span class="koboSpan" id="kobo.1564.1">target_boot_script.tpl</span></strong><span class="koboSpan" id="kobo.1565.1">", {
    vm_username = local.vm_username
    vm_password = local.vm_password
  })
  subnet_01 = var.subnet_01
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1566.1">Here, we define </span><strong class="source-inline"><span class="koboSpan" id="kobo.1567.1">vm_username</span></strong><span class="koboSpan" id="kobo.1568.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1569.1">vm_password</span></strong><span class="koboSpan" id="kobo.1570.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1571.1">script</span></strong><span class="koboSpan" id="kobo.1572.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1573.1">subnet_01</span></strong><span class="koboSpan" id="kobo.1574.1"> local variables. </span><span class="koboSpan" id="kobo.1574.2">When defining the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1575.1">script</span></strong><span class="koboSpan" id="kobo.1576.1"> local variable, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1577.1">templatefile()</span></strong><span class="koboSpan" id="kobo.1578.1"> function to render the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1579.1">target_boot_script.tpl</span></strong><span class="koboSpan" id="kobo.1580.1"> template file by passing in the values of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1581.1">vm_username</span></strong><span class="koboSpan" id="kobo.1582.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1583.1">vm_password</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1584.1">as variables.</span></span></p></li> <li><span class="koboSpan" id="kobo.1585.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1586.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1587.1"> file, let’s define our first </span><strong class="source-inline"><span class="koboSpan" id="kobo.1588.1">google_compute_instance</span></strong><span class="koboSpan" id="kobo.1589.1"> resource</span><a id="_idIndexMarker453"/><span class="koboSpan" id="kobo.1590.1"> using the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.1591.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1592.1">
resource "google_compute_instance" "target_vm" {
  name         = "vm-target"
  machine_type = "f1-micro"
  zone         = "us-central1-c"
  boot_disk {
    initialize_params {
      image = "debian-cloud/debian-11"
    }
  }
  metadata_startup_script = local.script
  network_interface {
    subnetwork = local.subnet_01
    access_config {}
  }
}
locals {
  max_retries = 20
  retry_delay = 30
}</span></pre></li> <li><span class="koboSpan" id="kobo.1593.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1594.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1595.1"> file, let’s </span><a id="_idIndexMarker454"/><span class="koboSpan" id="kobo.1596.1">also define </span><strong class="source-inline"><span class="koboSpan" id="kobo.1597.1">wait_for_startup_script</span></strong><span class="koboSpan" id="kobo.1598.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1599.1">null_resource</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1600.1"> resources:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1601.1">
resource "null_resource" "wait_for_startup_script" {
  depends_on = [google_compute_instance.target_vm]
  provisioner "local-exec" {
    interpreter = ["bash", "-c"]
    command = templatefile("${path.module}/</span><strong class="bold"><span class="koboSpan" id="kobo.1602.1">wait_for_boot.tpl</span></strong><span class="koboSpan" id="kobo.1603.1">", {
        max_retries    = local.max_retries
        target_vm_name = google_compute_instance.target_vm.name
        target_vm_zone = google_compute_instance.target_vm.zone
        retry_delay    = local.retry_delay
    })
  }
  provisioner "local-exec" {
    when    = destroy
    command = "true"
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1604.1">If you are wondering what this is for, this code block simply runs a script (coded inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1605.1">wait_for_boot.tpl</span></strong><span class="koboSpan" id="kobo.1606.1"> template file) inside the VM instance and waits for the entire boot</span><a id="_idIndexMarker455"/><span class="koboSpan" id="kobo.1607.1"> script (coded inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1608.1">target_boot_script.tpl</span></strong><span class="koboSpan" id="kobo.1609.1"> template file) </span><span class="No-Break"><span class="koboSpan" id="kobo.1610.1">to complete.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1611.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1612.1">Without this block, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1613.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1614.1"> command would finish prematurely, even if the target VM instance’s boot process had not finished. </span><span class="koboSpan" id="kobo.1614.2">This would mean that the OWASP Juice Shop application may not be available and accessible yet by the time the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1615.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1616.1"> command </span><span class="No-Break"><span class="koboSpan" id="kobo.1617.1">has completed!</span></span></p>
<ol>
<li value="16"><span class="koboSpan" id="kobo.1618.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1619.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1620.1"> file, let’s define the following local values </span><span class="No-Break"><span class="koboSpan" id="kobo.1621.1">as well:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1622.1">
locals {
    target_vm = google_compute_instance.target_vm
    target_vm_ni = local.target_vm.network_interface.0
    target_vm_private_ip = local.target_vm_ni.network_ip
    target_vm_ac = local.target_vm_ni.access_config.0
    target_vm_public_ip = local.target_vm_ac.nat_ip
}</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1623.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1624.1">Make sure to save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1625.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1626.1"> file before proceeding with the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.1627.1">of steps.</span></span></p>
<ol>
<li value="17"><span class="koboSpan" id="kobo.1628.1">Now, open</span><a id="_idIndexMarker456"/><span class="koboSpan" id="kobo.1629.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1630.1">target_vm/outputs.tf</span></strong><span class="koboSpan" id="kobo.1631.1"> file in the editor. </span><span class="koboSpan" id="kobo.1631.2">Add the following blocks of code to define the outputs of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1632.1">target_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1633.1"> module:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1634.1">
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1635.1">target_vm_username</span></strong><span class="koboSpan" id="kobo.1636.1">" {
  value = local.vm_username
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1637.1">target_vm_password</span></strong><span class="koboSpan" id="kobo.1638.1">" {
  value = local.vm_password
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1639.1">target_vm_private_ip</span></strong><span class="koboSpan" id="kobo.1640.1">" {
  value = local.target_vm_private_ip
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1641.1">target_vm_public_ip</span></strong><span class="koboSpan" id="kobo.1642.1">" {
  value = local.target_vm_public_ip
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1643.1">Make sure to save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1644.1">target_vm/outputs.tf</span></strong><span class="koboSpan" id="kobo.1645.1"> file before proceeding with the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.1646.1">of steps.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1647.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1648.1">We will use these output values in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1649.1">~/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1650.1">pentest_lab/outputs.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1651.1"> file.</span></span></p>
<ol>
<li value="18"><span class="koboSpan" id="kobo.1652.1">In the Cloud Shell terminal (right after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1653.1">$</span></strong><span class="koboSpan" id="kobo.1654.1"> sign), navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1655.1">pentest_lab</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1656.1">project directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1657.1">cd ~/pentest_lab</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1658.1">Let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1659.1">terraform init</span></strong><span class="koboSpan" id="kobo.1660.1"> command to reinitialize the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.1661.1">working directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1662.1">terraform init</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1663.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1664.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1665.1"> to </span><a id="_idIndexMarker457"/><span class="koboSpan" id="kobo.1666.1">preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1667.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1668.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1669.1">This should give us a </span><strong class="bold"><span class="koboSpan" id="kobo.1670.1">Missing required argument — The argument “subnet_01” is required, but no definition was found</span></strong><span class="koboSpan" id="kobo.1671.1"> error message since we have not provided any values for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1672.1">subnet_01</span></strong><span class="koboSpan" id="kobo.1673.1"> argument while declaring the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1674.1">target_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1675.1"> module.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1676.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1677.1">If you are wondering why we suddenly encountered this issue, it’s important to recall that we defined the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1678.1">subnet_01</span></strong><span class="koboSpan" id="kobo.1679.1"> variable in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1680.1">target_vm/variables.tf</span></strong><span class="koboSpan" id="kobo.1681.1"> file in an earlier step. </span><span class="koboSpan" id="kobo.1681.2">We will have this resolved in the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.1682.1">of steps!</span></span></p>
<ol>
<li value="21"><span class="koboSpan" id="kobo.1683.1">To resolve the issue encountered in the previous step, we need to ensure that we provide a value for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1684.1">subnet_01</span></strong><span class="koboSpan" id="kobo.1685.1"> argument when declaring the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1686.1">target_vm</span></strong><span class="koboSpan" id="kobo.1687.1"> module (similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1688.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1689.1">.22</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1690.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer087">
<span class="koboSpan" id="kobo.1691.1"><img alt="" src="image/B19755_04_22.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1692.1">Figure 4.22 – Providing a value for the subnet_01 argument when declaring the target_vm module</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1693.1">Using </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1694.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1695.1">.22</span></em><span class="koboSpan" id="kobo.1696.1"> as a</span><a id="_idIndexMarker458"/><span class="koboSpan" id="kobo.1697.1"> reference, we will resolve the issue by passing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1698.1">subnet_01</span></strong><span class="koboSpan" id="kobo.1699.1"> output value from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1700.1">secure_network</span></strong><span class="koboSpan" id="kobo.1701.1"> module to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1702.1">subnet_01</span></strong><span class="koboSpan" id="kobo.1703.1"> input variable of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1704.1">target_vm</span></strong><span class="koboSpan" id="kobo.1705.1"> module. </span><span class="koboSpan" id="kobo.1705.2">Now that we have a better idea of how we’ll resolve the issue, let’s locate the following block of code in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1706.1">main.tf</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1707.1">file (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1708.1">~/pentest_lab/main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1709.1">):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1710.1">
module "target_vm" {
  source = "./target_vm"
}</span></pre>
<p class="list-inset"><span class="koboSpan" id="kobo.1711.1">Update it with the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.1712.1">of code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1713.1">
module "target_vm" {
  source = "./target_vm"
  
  </span><strong class="bold"><span class="koboSpan" id="kobo.1714.1">subnet_01 = module.secure_network.subnet_01</span></strong><span class="koboSpan" id="kobo.1715.1">
}</span></pre>
<p class="list-inset"><span class="koboSpan" id="kobo.1716.1">Here, we are passing the output value from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1717.1">secure_network</span></strong><span class="koboSpan" id="kobo.1718.1"> module (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1719.1">module.secure_network.subnet_01</span></strong><span class="koboSpan" id="kobo.1720.1">) to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1721.1">subnet_01</span></strong><span class="koboSpan" id="kobo.1722.1"> input variable of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1723.1">target_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1724.1"> module.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1725.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1726.1">Make sure to save the changes made to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1727.1">main.tf</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1728.1">file (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1729.1">~/pentest_lab/main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1730.1">).</span></span></p>
<ol>
<li value="22"><span class="koboSpan" id="kobo.1731.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1732.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1733.1"> to</span><a id="_idIndexMarker459"/><span class="koboSpan" id="kobo.1734.1"> preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1735.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1736.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1737.1">This should give us the </span><span class="No-Break"><span class="koboSpan" id="kobo.1738.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1739.1">...
</span><span class="koboSpan" id="kobo.1739.2">Plan: 3 to add, 0 to change, 0 to destroy.</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1740.1">We should be able to proceed without encountering an error </span><span class="No-Break"><span class="koboSpan" id="kobo.1741.1">this time.</span></span></p></li> <li><span class="koboSpan" id="kobo.1742.1">Next, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1743.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1744.1"> command to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.1745.1">the changes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1746.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1747.1">Running the command should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.1748.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1749.1">...
</span><span class="koboSpan" id="kobo.1749.2">Apply complete! </span><span class="koboSpan" id="kobo.1749.3">Resources: 3 added, 0 changed, 0 destroyed.</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1750.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1751.1">Wait for a minute or two for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1752.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1753.1"> command </span><span class="No-Break"><span class="koboSpan" id="kobo.1754.1">to complete.</span></span></p>
<ol>
<li value="24"><span class="koboSpan" id="kobo.1755.1">In order for us to see the output values, let’s open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1756.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.1757.1"> file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1758.1">~/pentest_lab/outputs.tf</span></strong><span class="koboSpan" id="kobo.1759.1">) in the editor and add the following blocks </span><span class="No-Break"><span class="koboSpan" id="kobo.1760.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1761.1">
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1762.1">target_vm_username</span></strong><span class="koboSpan" id="kobo.1763.1">" {
  value = module.target_vm.target_vm_username
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1764.1">target_vm_password</span></strong><span class="koboSpan" id="kobo.1765.1">" {
  value = module.target_vm.target_vm_password
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1766.1">target_vm_private_ip</span></strong><span class="koboSpan" id="kobo.1767.1">" {
  value = module.target_vm.target_vm_private_ip
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1768.1">target_vm_public_ip</span></strong><span class="koboSpan" id="kobo.1769.1">" {
  value = module.target_vm.target_vm_public_ip
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1770.1">This will utilize the </span><a id="_idIndexMarker460"/><span class="koboSpan" id="kobo.1771.1">outputs from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1772.1">target_vm</span></strong><span class="koboSpan" id="kobo.1773.1"> module in the root module’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1774.1">outputs.tf</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1775.1">file (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1776.1">~/pentest_lab/outputs.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1777.1">).</span></span></p></li> <li><span class="koboSpan" id="kobo.1778.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1779.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1780.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1781.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1782.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1783.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.1784.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1785.1">Changes to Outputs:
  + target_vm_password   = "..."
</span><span class="koboSpan" id="kobo.1785.2">  + target_vm_private_ip = "..."
</span><span class="koboSpan" id="kobo.1785.3">  + target_vm_public_ip  = "..."
</span><span class="koboSpan" id="kobo.1785.4">  + target_vm_username   = "testuser"</span></pre></li> <li><span class="koboSpan" id="kobo.1786.1">Next, let’s use </span><a id="_idIndexMarker461"/><span class="koboSpan" id="kobo.1787.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1788.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1789.1"> command to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.1790.1">the changes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1791.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1792.1">This should give us the </span><span class="No-Break"><span class="koboSpan" id="kobo.1793.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1794.1">Apply complete! </span><span class="koboSpan" id="kobo.1794.2">Resources: 0 added, 0 changed, 0 destroyed.
</span><span class="koboSpan" id="kobo.1794.3">Outputs:
target_vm_password = "..."
</span><span class="koboSpan" id="kobo.1794.4">target_vm_private_ip = "..."
</span><span class="koboSpan" id="kobo.1794.5">target_vm_public_ip = "..."
</span><span class="koboSpan" id="kobo.1794.6">target_vm_username = "testuser"</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1795.1">Here, we can see the output values after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1796.1">terraform apply -auto-approve</span></strong><span class="koboSpan" id="kobo.1797.1"> command since we defined the outputs in the root module (that is, the code stored inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.1798.1">~/pentest_lab</span></strong><span class="koboSpan" id="kobo.1799.1">) in an </span><span class="No-Break"><span class="koboSpan" id="kobo.1800.1">earlier step.</span></span></p></li> <li><span class="koboSpan" id="kobo.1801.1">Store and save the </span><a id="_idIndexMarker462"/><span class="koboSpan" id="kobo.1802.1">output values for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1803.1">target_vm_username</span></strong><span class="koboSpan" id="kobo.1804.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1805.1">target_vm_password</span></strong><span class="koboSpan" id="kobo.1806.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1807.1">target_vm_private_ip</span></strong><span class="koboSpan" id="kobo.1808.1"> in a text editor as we will use these in the succeeding steps in </span><span class="No-Break"><span class="koboSpan" id="kobo.1809.1">this chapter.</span></span></li>
</ol>
<h2 id="_idParaDest-79"><a id="_idTextAnchor078"/><span class="koboSpan" id="kobo.1810.1">Part 2 of 2 – Using the serial console to access the target VM instance</span></h2>
<p><span class="koboSpan" id="kobo.1811.1">Follow </span><a id="_idIndexMarker463"/><span class="koboSpan" id="kobo.1812.1">the </span><a id="_idIndexMarker464"/><span class="No-Break"><span class="koboSpan" id="kobo.1813.1">next steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1814.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.1815.1">VM instances</span></strong><span class="koboSpan" id="kobo.1816.1"> page by typing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1817.1">compute engine</span></strong><span class="koboSpan" id="kobo.1818.1"> in the search box and selecting </span><strong class="bold"><span class="koboSpan" id="kobo.1819.1">Compute Engine</span></strong><span class="koboSpan" id="kobo.1820.1"> from the search results (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1821.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1822.1">.23</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1823.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer088">
<span class="koboSpan" id="kobo.1824.1"><img alt="" src="image/B19755_04_23.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1825.1">Figure 4.23 – Navigating to the VM instances page</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1826.1">On </span><a id="_idIndexMarker465"/><span class="koboSpan" id="kobo.1827.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.1828.1">VM instances</span></strong><span class="koboSpan" id="kobo.1829.1"> page, we’ll </span><a id="_idIndexMarker466"/><span class="koboSpan" id="kobo.1830.1">find a list of VM instances in our </span><span class="No-Break"><span class="koboSpan" id="kobo.1831.1">GCP account.</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1832.1">Click the link (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1833.1">vm-target</span></strong><span class="koboSpan" id="kobo.1834.1">) under the </span><strong class="bold"><span class="koboSpan" id="kobo.1835.1">Name</span></strong><span class="koboSpan" id="kobo.1836.1"> column to navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.1837.1">Instance details</span></strong><span class="koboSpan" id="kobo.1838.1"> page of our target VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1839.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1840.1">vm-target</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1841.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.1842.1">It’s time we accessed the serial console! </span><span class="koboSpan" id="kobo.1842.2">In case you are wondering what it is, the </span><strong class="bold"><span class="koboSpan" id="kobo.1843.1">serial console</span></strong><span class="koboSpan" id="kobo.1844.1"> serves as a troubleshooting tool that allows users to conveniently access the serial port of a VM instance directly in GCP. </span><span class="koboSpan" id="kobo.1844.2">It enables users to interact with the VM’s console output, access the boot process, and diagnose issues even when SSH or other network-based connections are unavailable (or misconfigured). </span><span class="koboSpan" id="kobo.1844.3">With this in mind, let’s click on the </span><strong class="bold"><span class="koboSpan" id="kobo.1845.1">CONNECT TO SERIAL CONSOLE</span></strong><span class="koboSpan" id="kobo.1846.1"> button. </span><span class="koboSpan" id="kobo.1846.2">This will open a pop-up window similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1847.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1848.1">.24</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1849.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer089">
<span class="koboSpan" id="kobo.1850.1"><img alt="" src="image/B19755_04_24.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1851.1">Figure 4.24 – Serial console popup</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1852.1">Once </span><a id="_idIndexMarker467"/><span class="koboSpan" id="kobo.1853.1">you see a blank page</span><a id="_idIndexMarker468"/><span class="koboSpan" id="kobo.1854.1"> inside the pop-up window, click inside the blank page and then press the </span><em class="italic"><span class="koboSpan" id="kobo.1855.1">Enter</span></em><span class="koboSpan" id="kobo.1856.1"> key. </span><span class="koboSpan" id="kobo.1856.2">Use the output values for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1857.1">target_vm_username</span></strong><span class="koboSpan" id="kobo.1858.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1859.1">testuser</span></strong><span class="koboSpan" id="kobo.1860.1">) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1861.1">target_vm_password</span></strong><span class="koboSpan" id="kobo.1862.1"> (generated password) to </span><span class="No-Break"><span class="koboSpan" id="kobo.1863.1">log in.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1864.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1865.1">Feel free to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1866.1">terraform show</span></strong><span class="koboSpan" id="kobo.1867.1"> command in the Cloud Shell terminal to retrieve the output values for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1868.1">target_vm_username</span></strong><span class="koboSpan" id="kobo.1869.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1870.1">target_vm_password</span></strong><span class="koboSpan" id="kobo.1871.1">. </span><span class="koboSpan" id="kobo.1871.2">Make sure that you are inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1872.1">~/pentest_lab</span></strong><span class="koboSpan" id="kobo.1873.1"> directory before running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1874.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1875.1">show</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1876.1"> command.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1877.1">Use the following command to check if the OWASP Juice Shop container is running inside the target </span><span class="No-Break"><span class="koboSpan" id="kobo.1878.1">VM instance:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1879.1">sudo docker ps</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1880.1">If prompted for the password, simply use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1881.1">target_vm_password</span></strong><span class="koboSpan" id="kobo.1882.1"> output value to proceed with </span><span class="No-Break"><span class="koboSpan" id="kobo.1883.1">the command.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.1884.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1885.1">sudo docker ps</span></strong><span class="koboSpan" id="kobo.1886.1"> command should return a single running container using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1887.1">bkimminich/juice-shop</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1888.1">container image:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer090">
<span class="koboSpan" id="kobo.1889.1"><img alt="" src="image/B19755_04_25.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1890.1">Figure 4.25 – Confirming that the OWASP Juice shop container is already running</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1891.1">Accessing port </span><strong class="source-inline"><span class="koboSpan" id="kobo.1892.1">80</span></strong><span class="koboSpan" id="kobo.1893.1"> of the VM instance would allow you to interact with the container running the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1894.1">bkimminich/juice-shop</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1895.1"> image.</span></span></p></li>
</ol>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1896.1">Run the</span><a id="_idIndexMarker469"/><span class="koboSpan" id="kobo.1897.1"> following command to</span><a id="_idIndexMarker470"/><span class="koboSpan" id="kobo.1898.1"> send a sample request to the local server and check whether a website is running on </span><span class="No-Break"><span class="koboSpan" id="kobo.1899.1">port </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1900.1">80</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1901.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1902.1">curl localhost:80</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1903.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.1904.1">following output:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer091">
<span class="koboSpan" id="kobo.1905.1"><img alt="" src="image/B19755_04_26.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1906.1">Figure 4.26 – Result after using the curl command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1907.1">Looks like we have confirmed that we have a website running on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.1908.1">80</span></strong><span class="koboSpan" id="kobo.1909.1"> of the VM instance (mapped to a web application inside the </span><span class="No-Break"><span class="koboSpan" id="kobo.1910.1">running container).</span></span></p></li>
</ol>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1911.1">Now </span><a id="_idIndexMarker471"/><span class="koboSpan" id="kobo.1912.1">that we have a better </span><a id="_idIndexMarker472"/><span class="koboSpan" id="kobo.1913.1">idea of what’s running inside the target VM instance, we can close the serial console (</span><strong class="bold"><span class="koboSpan" id="kobo.1914.1">SSH </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1915.1">in-browser</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1916.1">) popup.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.1917.1">At this stage, you might be excited about exploring and accessing the OWASP Juice Shop application already! </span><span class="koboSpan" id="kobo.1917.2">Given that we’ve intentionally configured the network environment to only allow resources in </span><strong class="bold"><span class="koboSpan" id="kobo.1918.1">VPC 02</span></strong><span class="koboSpan" id="kobo.1919.1"> to access </span><strong class="bold"><span class="koboSpan" id="kobo.1920.1">VPC 01</span></strong><span class="koboSpan" id="kobo.1921.1"> (where the target VM instance is launched), we will have to set up our attacker VM instance in </span><strong class="bold"><span class="koboSpan" id="kobo.1922.1">VPC 02</span></strong><span class="koboSpan" id="kobo.1923.1"> first before we can access the vulnerable-by-design application, along with performing a penetration testing simulation inside the </span><span class="No-Break"><span class="koboSpan" id="kobo.1924.1">network environment.</span></span></p>
<h1 id="_idParaDest-80"><a id="_idTextAnchor079"/><span class="koboSpan" id="kobo.1925.1">Importing the Kali Linux Generic Cloud Image</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.1926.1">Kali Linux</span></strong><span class="koboSpan" id="kobo.1927.1"> is a </span><a id="_idIndexMarker473"/><span class="koboSpan" id="kobo.1928.1">specialized operating system designed specifically for advanced penetration testing and ethical hacking activities. </span><span class="koboSpan" id="kobo.1928.2">With its wide range of security tools, Kali Linux enables cybersecurity professionals and enthusiasts to perform penetration tests, digital forensics investigations, and vulnerability assessments. </span><span class="koboSpan" id="kobo.1928.3">If you have not used Kali Linux before, think of it as an upgraded version of a specific operating system where powerful security tools are pre-installed, turning it into a specialized arsenal for cybersecurity professionals. </span><span class="koboSpan" id="kobo.1928.4">It’s like transforming a regular car into a heavily armored tank with an array of </span><span class="No-Break"><span class="koboSpan" id="kobo.1929.1">advanced weapons!</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1930.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1931.1">As a specialized operating system with advanced hacking tools, Kali Linux has the potential to cause harm or engage in malicious activities if used improperly. </span><span class="koboSpan" id="kobo.1931.2">While it is generally safe to use Kali Linux inside your own penetration testing lab environments, always make sure that you have proper authorization when using it for conducting security assessments and penetration testing exercises. </span><span class="koboSpan" id="kobo.1931.3">This ensures that you stay within legal and ethical boundaries and avoid any unauthorized activities that may lead to legal consequences or harm the integrity of systems. </span><span class="koboSpan" id="kobo.1931.4">Remember to obtain explicit permission from the owner of the systems or networks you are testing and adhere to any applicable laws, regulations, </span><span class="No-Break"><span class="koboSpan" id="kobo.1932.1">or guidelines.</span></span></p>
<p><span class="koboSpan" id="kobo.1933.1">Given that Kali Linux is not available as a preconfigured image in </span><strong class="bold"><span class="koboSpan" id="kobo.1934.1">Google Cloud Marketplace</span></strong><span class="koboSpan" id="kobo.1935.1">, we </span><a id="_idIndexMarker474"/><span class="koboSpan" id="kobo.1936.1">need to follow a specific set of steps to import the Generic Cloud Image before launching a Kali Linux VM. </span><em class="italic"><span class="koboSpan" id="kobo.1937.1">Generic what??</span></em><span class="koboSpan" id="kobo.1938.1"> The </span><strong class="bold"><span class="koboSpan" id="kobo.1939.1">Generic Cloud Image</span></strong><span class="koboSpan" id="kobo.1940.1"> of </span><a id="_idIndexMarker475"/><span class="koboSpan" id="kobo.1941.1">Kali Linux is simply a preconfigured and optimized image for deployment on various cloud platforms (including GCP). </span><span class="koboSpan" id="kobo.1941.2">You can think of the image as a DNA template that can be used to prepare clones of Kali Linux instances on different cloud platforms. </span><span class="koboSpan" id="kobo.1941.3">It serves as a foundational blueprint, containing all the essential configurations and software required for penetration testing and </span><span class="No-Break"><span class="koboSpan" id="kobo.1942.1">security assessments.</span></span></p>
<p><span class="koboSpan" id="kobo.1943.1">Now that we </span><a id="_idIndexMarker476"/><span class="koboSpan" id="kobo.1944.1">have a better understanding of what Kali Linux is and what the Generic Cloud Image is used for, let’s proceed with importing the said image to our Google GCP project, </span><span class="No-Break"><span class="koboSpan" id="kobo.1945.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1946.1">Open a </span><a id="_idIndexMarker477"/><span class="koboSpan" id="kobo.1947.1">new browser tab and navigate to </span><a href="https://www.kali.org/get-kali/#kali-cloud"><span class="koboSpan" id="kobo.1948.1">https://www.kali.org/get-kali/#kali-cloud</span></a><span class="koboSpan" id="kobo.1949.1">. </span><span class="koboSpan" id="kobo.1949.2">Locate and right-click on the </span><strong class="bold"><span class="koboSpan" id="kobo.1950.1">Generic  Cloud Image</span></strong><span class="koboSpan" id="kobo.1951.1"> download box to open the </span><span class="No-Break"><span class="koboSpan" id="kobo.1952.1">context menu:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer092">
<span class="koboSpan" id="kobo.1953.1"><img alt="" src="image/B19755_04_27.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1954.1">Figure 4.27 – Copying the link address of the Generic Cloud Image</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1955.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.1956.1">Copy Link Address</span></strong><span class="koboSpan" id="kobo.1957.1"> from the list of options in the context menu similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1958.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1959.1">.27</span></em><span class="koboSpan" id="kobo.1960.1">. </span><span class="koboSpan" id="kobo.1960.2">This should copy the following download link to our local </span><span class="No-Break"><span class="koboSpan" id="kobo.1961.1">machine’s clipboard:</span></span></p>
<pre class="source-code">
<a href="https://kali.download/cloud-images/kali-2023.1/kali-linux-2023.1-cloud-genericcloud-amd64.tar.xz"><span class="koboSpan" id="kobo.1962.1">https://kali.download/cloud-images/kali-2023.1/kali-linux-2023.1-cloud-genericcloud-amd64.tar.xz</span></a></pre> <p class="list-inset"><span class="koboSpan" id="kobo.1963.1">Note that this download link may change as new versions of the image are </span><span class="No-Break"><span class="koboSpan" id="kobo.1964.1">made available.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1965.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1966.1">Store and save this download link in a text editor as we will use this in the succeeding steps in this chapter. </span><span class="koboSpan" id="kobo.1966.2">In case you are unable to copy the link address, you may find the Generic Cloud Image files </span><span class="No-Break"><span class="koboSpan" id="kobo.1967.1">here: </span></span><a href="https://kali.download/cloud-images/kali-2023.1/"><span class="No-Break"><span class="koboSpan" id="kobo.1968.1">https://kali.download/cloud-images/kali-2023.1/</span></span></a></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1969.1">Navigate</span><a id="_idIndexMarker478"/><span class="koboSpan" id="kobo.1970.1"> back to our Google Cloud console browser tab. </span><span class="koboSpan" id="kobo.1970.2">In the Cloud Shell terminal (after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1971.1">$</span></strong><span class="koboSpan" id="kobo.1972.1"> sign), run the following commands to create a directory named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1973.1">kali-image</span></strong><span class="koboSpan" id="kobo.1974.1"> (and navigate to the created directory </span><span class="No-Break"><span class="koboSpan" id="kobo.1975.1">as well):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1976.1">cd ~</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1977.1">mkdir kali-image &amp;&amp; cd kali-image</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1978.1">Download the latest version of the </span><strong class="bold"><span class="koboSpan" id="kobo.1979.1">Generic Cloud Image</span></strong><span class="koboSpan" id="kobo.1980.1"> using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1981.1">wget</span></strong><span class="koboSpan" id="kobo.1982.1"> by running the following commands in the Cloud </span><span class="No-Break"><span class="koboSpan" id="kobo.1983.1">Shell terminal:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1984.1">IMAGE_SOURCE=</span></strong><a href="https://kali.download/cloud-images/kali-2023.1/kali-linux-2023.1-cloud-genericcloud-amd64.tar.xz"><strong class="bold"><span class="koboSpan" id="kobo.1985.1">https://kali.download/cloud-images/kali-2023.1/kali-linux-2023.1-cloud-genericcloud-amd64.tar.xz</span></strong></a>
<strong class="bold"><span class="koboSpan" id="kobo.1986.1">wget -O kl_image.tar.xz $IMAGE_SOURCE</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1987.1">This should download the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1988.1">kl_image.tar.xz</span></strong><span class="koboSpan" id="kobo.1989.1"> file inside our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1990.1">kali-image</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1991.1"> directory.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1992.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1993.1">Feel free to update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1994.1">IMAGE_SOURCE</span></strong><span class="koboSpan" id="kobo.1995.1"> variable value with the download link you copied to the text editor in an </span><span class="No-Break"><span class="koboSpan" id="kobo.1996.1">earlier step.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1997.1">Create a compatible </span><strong class="source-inline"><span class="koboSpan" id="kobo.1998.1">.tar.gz</span></strong><span class="koboSpan" id="kobo.1999.1"> file for storing the Kali Linux Generic Cloud Image by running the following lines (one line at </span><span class="No-Break"><span class="koboSpan" id="kobo.2000.1">a time):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2001.1">tar -xf kl_image.tar.xz</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2002.1">rm kl_image.tar.xz</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2003.1">tar --format=oldgnu -Sczf kl_image.tar.gz disk.raw</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2004.1">rm disk.raw</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2005.1">Here, we are able to prepare a compressed tarball file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.2006.1">kl_image.tar.gz</span></strong><span class="koboSpan" id="kobo.2007.1"> containing the contents of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2008.1">disk.raw</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2009.1"> file.</span></span></p></li> <li><span class="koboSpan" id="kobo.2010.1">Create a new </span><strong class="bold"><span class="koboSpan" id="kobo.2011.1">Google Cloud Storage</span></strong><span class="koboSpan" id="kobo.2012.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.2013.1">GCS</span></strong><span class="koboSpan" id="kobo.2014.1">) bucket</span><a id="_idIndexMarker479"/><span class="koboSpan" id="kobo.2015.1"> using</span><a id="_idIndexMarker480"/><span class="koboSpan" id="kobo.2016.1"> the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2017.1">gsutil</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2018.1"> command:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2019.1">
BUCKET_NAME=</span><strong class="bold"><span class="koboSpan" id="kobo.2020.1">&lt;BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.2021.1">
gsutil mb gs://$BUCKET_NAME</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2022.1">Make </span><a id="_idIndexMarker481"/><span class="koboSpan" id="kobo.2023.1">sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2024.1">&lt;BUCKET NAME&gt;</span></strong><span class="koboSpan" id="kobo.2025.1"> with a globally unique bucket name (for a bucket that is yet to be created). </span><span class="koboSpan" id="kobo.2025.2">Feel free to check the following link on some considerations when naming Cloud Storage </span><span class="No-Break"><span class="koboSpan" id="kobo.2026.1">buckets: </span></span><a href="https://cloud.google.com/storage/docs/buckets"><span class="No-Break"><span class="koboSpan" id="kobo.2027.1">https://cloud.google.com/storage/docs/buckets</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2028.1">.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2029.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2030.1">If this is your first time using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2031.1">gsutil</span></strong><span class="koboSpan" id="kobo.2032.1"> command-line utility, it is a command-line tool provided by GCP for interacting with GCS. </span><span class="koboSpan" id="kobo.2032.2">To grant permission for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2033.1">gsutil</span></strong><span class="koboSpan" id="kobo.2034.1"> command, we need to proceed by clicking on the </span><strong class="bold"><span class="koboSpan" id="kobo.2035.1">AUTHORIZE</span></strong><span class="koboSpan" id="kobo.2036.1"> button in the </span><strong class="bold"><span class="koboSpan" id="kobo.2037.1">Authorize Cloud Shell</span></strong><span class="koboSpan" id="kobo.2038.1"> pop-up window. </span><span class="koboSpan" id="kobo.2038.2">This will allow the necessary permissions for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2039.1">gsutil</span></strong><span class="koboSpan" id="kobo.2040.1"> command to be </span><span class="No-Break"><span class="koboSpan" id="kobo.2041.1">executed successfully.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.2042.1">Upload the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2043.1">.tar.gz</span></strong><span class="koboSpan" id="kobo.2044.1"> file to an existing GCS bucket using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2045.1">gsutil</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2046.1"> utility:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2047.1">gsutil cp kl_image.tar.gz \</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2048.1">gs://$BUCKET_NAME/kl_image.tar.gz</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2049.1">You may navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.2050.1">Cloud Storage Buckets</span></strong><span class="koboSpan" id="kobo.2051.1"> page using the user interface (Cloud console) and check if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2052.1">.tar.gz</span></strong><span class="koboSpan" id="kobo.2053.1"> file has been uploaded to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2054.1">bucket successfully.</span></span></p></li> <li><span class="koboSpan" id="kobo.2055.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2056.1">gcloud compute images create</span></strong><span class="koboSpan" id="kobo.2057.1"> command to create an image from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2058.1">.tar.gz</span></strong><span class="koboSpan" id="kobo.2059.1"> file uploaded to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2060.1">GCS bucket:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2061.1">
IMAGE_NAME=</span><strong class="bold"><span class="koboSpan" id="kobo.2062.1">kali-linux-2023-000</span></strong><span class="koboSpan" id="kobo.2063.1">
gcloud compute images create $IMAGE_NAME \
    --source-uri gs://$BUCKET_NAME/kl_image.tar.gz \
    --family kali-linux</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2064.1">Feel free to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2065.1">kali-linux-2023-000</span></strong><span class="koboSpan" id="kobo.2066.1"> with a different </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2067.1">IMAGE_NAME</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2068.1"> value.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2069.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2070.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2071.1">gcloud</span></strong><span class="koboSpan" id="kobo.2072.1"> CLI</span><a id="_idIndexMarker482"/><span class="koboSpan" id="kobo.2073.1"> is a unified command-line utility provided by GCP that allows users to access and manage various Google Cloud resources from the terminal. </span><span class="koboSpan" id="kobo.2073.2">With this command-line utility, we can perform tasks such as provisioning and managing VMs, configuring networking, deploying applications, managing storage resources, and accessing service APIs. </span><span class="koboSpan" id="kobo.2073.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2074.1">gsutil</span></strong><span class="koboSpan" id="kobo.2075.1"> tool, on the other hand, facilitates various tasks, including uploading, downloading, copying, and managing data within Cloud Storage buckets. </span><span class="koboSpan" id="kobo.2075.2">It is worth noting that </span><strong class="source-inline"><span class="koboSpan" id="kobo.2076.1">gcloud</span></strong><span class="koboSpan" id="kobo.2077.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2078.1">gsutil</span></strong><span class="koboSpan" id="kobo.2079.1"> have different functionalities, and it is important not to mistake one for </span><span class="No-Break"><span class="koboSpan" id="kobo.2080.1">the other.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.2081.1">Run the </span><a id="_idIndexMarker483"/><span class="koboSpan" id="kobo.2082.1">following command to verify that we were able to successfully create </span><span class="No-Break"><span class="koboSpan" id="kobo.2083.1">the image:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2084.1">gcloud compute images list --no-standard-images</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2085.1">This should return the </span><span class="No-Break"><span class="koboSpan" id="kobo.2086.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2087.1">NAME: kali-linux-2023-000
PROJECT: ...
</span><span class="koboSpan" id="kobo.2087.2">FAMILY: kali-linux
DEPRECATED:
STATUS: READY</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2088.1">Here, we</span><a id="_idIndexMarker484"/><span class="koboSpan" id="kobo.2089.1"> have a filtered list of custom images that have been created or imported into </span><span class="No-Break"><span class="koboSpan" id="kobo.2090.1">our account.</span></span></p></li> </ol>
<p><em class="italic"><span class="koboSpan" id="kobo.2091.1">Now that we have the image imported to Google Cloud, what’s next?</span></em><span class="koboSpan" id="kobo.2092.1"> From this image, we should be able to launch a VM instance that will serve as the attacker instance in our penetration testing </span><span class="No-Break"><span class="koboSpan" id="kobo.2093.1">lab environment.</span></span></p>
<h1 id="_idParaDest-81"><a id="_idTextAnchor080"/><span class="koboSpan" id="kobo.2094.1">Manually setting up the attacker VM instance</span></h1>
<p><span class="koboSpan" id="kobo.2095.1">With </span><a id="_idIndexMarker485"/><span class="koboSpan" id="kobo.2096.1">our custom image and the VPC network setup ready, setting up our Kali Linux attacker machine on GCP should be straightforward. </span><span class="koboSpan" id="kobo.2096.2">However, before proceeding with the hands-on portion of this section, let’s quickly discuss how our attacker VM machine will be configured </span><span class="No-Break"><span class="koboSpan" id="kobo.2097.1">and deployed.</span></span></p>
<p><span class="koboSpan" id="kobo.2098.1">To start with, we will be deploying the Kali Linux attacker machine in </span><strong class="bold"><span class="koboSpan" id="kobo.2099.1">VPC 02</span></strong><span class="koboSpan" id="kobo.2100.1">, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2101.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2102.1">.28</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2103.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer093">
<span class="koboSpan" id="kobo.2104.1"><img alt="" src="image/B19755_04_28.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2105.1">Figure 4.28 – Setting up the attacker VM instance in the subnet of VPC 02</span></p>
<p><span class="koboSpan" id="kobo.2106.1">Traffic from our attacker machine should be able to reach resources deployed in </span><strong class="bold"><span class="koboSpan" id="kobo.2107.1">VPC 01</span></strong><span class="koboSpan" id="kobo.2108.1"> since </span><strong class="bold"><span class="koboSpan" id="kobo.2109.1">VPC 02</span></strong><span class="koboSpan" id="kobo.2110.1"> is peered with </span><strong class="bold"><span class="koboSpan" id="kobo.2111.1">VPC 01</span></strong><span class="koboSpan" id="kobo.2112.1"> and the configured firewall rules allow traffic from each of these VPC networks to reach the resources deployed in </span><span class="No-Break"><span class="koboSpan" id="kobo.2113.1">these networks.</span></span></p>
<p><span class="koboSpan" id="kobo.2114.1">In addition to this, we will set up the following in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2115.1">attacker VM:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.2116.1">TigerVNC</span></strong><span class="koboSpan" id="kobo.2117.1">—A </span><a id="_idIndexMarker486"/><span class="koboSpan" id="kobo.2118.1">high-performance cross-platform implementation of </span><strong class="bold"><span class="koboSpan" id="kobo.2119.1">Virtual Network Computing</span></strong><span class="koboSpan" id="kobo.2120.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.2121.1">VNC</span></strong><span class="koboSpan" id="kobo.2122.1">) that</span><a id="_idIndexMarker487"/><span class="koboSpan" id="kobo.2123.1"> enables users to remotely access and interact with graphical applications on </span><span class="No-Break"><span class="koboSpan" id="kobo.2124.1">remote machines</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.2125.1">noVNC</span></strong><span class="koboSpan" id="kobo.2126.1">—A </span><a id="_idIndexMarker488"/><span class="koboSpan" id="kobo.2127.1">web-based implementation of VNC that allows users to access and control a remote desktop environment through a </span><span class="No-Break"><span class="koboSpan" id="kobo.2128.1">web browser</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2129.1">These will </span><a id="_idIndexMarker489"/><span class="koboSpan" id="kobo.2130.1">allow us to interact with the desktop environment of the attacker machine remotely from the browser (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2131.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2132.1">.29</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2133.1">):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer094">
<span class="koboSpan" id="kobo.2134.1"><img alt="" src="image/B19755_04_29.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2135.1">Figure 4.29 – Accessing the target instance from a browser running in the attacker instance</span></p>
<p><span class="koboSpan" id="kobo.2136.1">It’s important to distinguish between the two browsers shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2137.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2138.1">.29</span></em><span class="koboSpan" id="kobo.2139.1">. </span><span class="koboSpan" id="kobo.2139.2">The first browser, which will run on our local machine, displays the desktop environment of our Kali Linux VM instance. </span><span class="koboSpan" id="kobo.2139.3">Within this environment, we will launch the Firefox browser to access </span><a id="_idIndexMarker490"/><span class="koboSpan" id="kobo.2140.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.2141.1">OWASP Juice Shop</span></strong><span class="koboSpan" id="kobo.2142.1"> web application running in the target </span><span class="No-Break"><span class="koboSpan" id="kobo.2143.1">VM instance.</span></span></p>
<p><span class="koboSpan" id="kobo.2144.1">That said, we’ll divide this section into three parts, </span><span class="No-Break"><span class="koboSpan" id="kobo.2145.1">as follows:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.2146.1">Part 1 of 3 – Manually launching the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2147.1">attacker instance</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2148.1">Part 2 of 3 – Enabling browser access to our Kali </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2149.1">Linux server</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2150.1">Part 3 of 3 – Validating </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2151.1">our setup</span></em></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2152.1">With these points in mind, </span><span class="No-Break"><span class="koboSpan" id="kobo.2153.1">let’s begin!</span></span></p>
<h2 id="_idParaDest-82"><a id="_idTextAnchor081"/><span class="koboSpan" id="kobo.2154.1">Part 1 of 3 – Manually launching the attacker instance</span></h2>
<p><span class="koboSpan" id="kobo.2155.1">Follow</span><a id="_idIndexMarker491"/><span class="koboSpan" id="kobo.2156.1"> the </span><span class="No-Break"><span class="koboSpan" id="kobo.2157.1">next steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2158.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.2159.1">VM instances</span></strong><span class="koboSpan" id="kobo.2160.1"> page by typing </span><strong class="source-inline"><span class="koboSpan" id="kobo.2161.1">compute engine</span></strong><span class="koboSpan" id="kobo.2162.1"> in the search box and selecting </span><strong class="bold"><span class="koboSpan" id="kobo.2163.1">Compute Engine</span></strong><span class="koboSpan" id="kobo.2164.1"> from the </span><span class="No-Break"><span class="koboSpan" id="kobo.2165.1">search results.</span></span></li>
<li><span class="koboSpan" id="kobo.2166.1">Take note of the </span><strong class="bold"><span class="koboSpan" id="kobo.2167.1">Zone</span></strong><span class="koboSpan" id="kobo.2168.1"> value for </span><strong class="source-inline"><span class="koboSpan" id="kobo.2169.1">vm-target</span></strong><span class="koboSpan" id="kobo.2170.1"> (that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2171.1">us-central1-c</span></strong><span class="koboSpan" id="kobo.2172.1">) as we will use the same zone when creating the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2173.1">kali-00</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2174.1">VM instance.</span></span></li>
<li><span class="koboSpan" id="kobo.2175.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2176.1">CREATE INSTANCE</span></strong><span class="koboSpan" id="kobo.2177.1"> button. </span><span class="koboSpan" id="kobo.2177.2">Specify the following configuration values when creating the </span><span class="No-Break"><span class="koboSpan" id="kobo.2178.1">new instance:</span></span><ul><li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2179.1">Name</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2180.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2181.1">kali-00</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.2182.1">Region</span></strong><span class="koboSpan" id="kobo.2183.1">: </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2184.1">us-central1 (Iowa)</span></strong></span></li><li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2185.1">Zone</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2186.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2187.1">us-central1-c</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.2188.1">Machine </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2189.1">type</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2190.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2191.1">e2-medium</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.2192.1">Boot disk</span></strong><span class="koboSpan" id="kobo.2193.1">: Locate and click the </span><strong class="bold"><span class="koboSpan" id="kobo.2194.1">CHANGE</span></strong><span class="koboSpan" id="kobo.2195.1"> button. </span><span class="koboSpan" id="kobo.2195.2">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.2196.1">CUSTOM IMAGES</span></strong><span class="koboSpan" id="kobo.2197.1"> tab and select the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2198.1">kali-linux-2023-000</span></strong><span class="koboSpan" id="kobo.2199.1"> image from the list of drop-down options, similar to what is shown in </span><em class="italic"><span class="koboSpan" id="kobo.2200.1">Figure 4.30</span></em><span class="koboSpan" id="kobo.2201.1">. </span><span class="koboSpan" id="kobo.2201.2">For the </span><strong class="bold"><span class="koboSpan" id="kobo.2202.1">Size (GB)</span></strong><span class="koboSpan" id="kobo.2203.1"> field, specify a value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2204.1">50</span></strong><span class="koboSpan" id="kobo.2205.1">. </span><span class="koboSpan" id="kobo.2205.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2206.1">SELECT</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2207.1">button afterward:</span></span></li></ul>
<div>
<div class="IMG---Figure" id="_idContainer095">
<span class="koboSpan" id="kobo.2208.1"><img alt="" src="image/B19755_04_30.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2209.1">Figure 4.30 – Configuring the boot disk</span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.2210.1">Advanced options</span></strong><span class="koboSpan" id="kobo.2211.1"> (expand) &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.2212.1">Networking</span></strong><span class="koboSpan" id="kobo.2213.1"> (expand) &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.2214.1">Network interfaces</span></strong><span class="koboSpan" id="kobo.2215.1">: Change </span><strong class="source-inline"><span class="koboSpan" id="kobo.2216.1">default</span></strong><span class="koboSpan" id="kobo.2217.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2218.1">vpc-02</span></strong><span class="koboSpan" id="kobo.2219.1"> under </span><strong class="bold"><span class="koboSpan" id="kobo.2220.1">Edit </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2221.1">network interface</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2222.1">.</span></span></li>
</ul></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.2223.1">Scroll down to</span><a id="_idIndexMarker492"/><span class="koboSpan" id="kobo.2224.1"> the bottom of the page and then click the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2225.1">CREATE</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2226.1"> button.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2227.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2228.1">Wait for a minute or two for this step to complete. </span><span class="koboSpan" id="kobo.2228.2">Feel free to grab a cup of coffee or tea </span><span class="No-Break"><span class="koboSpan" id="kobo.2229.1">while waiting!</span></span></p>
<h2 id="_idParaDest-83"><a id="_idTextAnchor082"/><span class="koboSpan" id="kobo.2230.1">Part 2 of 3 – Enabling browser access to our Kali Linux server</span></h2>
<p><span class="koboSpan" id="kobo.2231.1">Follow </span><a id="_idIndexMarker493"/><span class="koboSpan" id="kobo.2232.1">the</span><a id="_idIndexMarker494"/> <span class="No-Break"><span class="koboSpan" id="kobo.2233.1">next steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2234.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.2235.1">VM instances</span></strong><span class="koboSpan" id="kobo.2236.1"> page where we can find a list of running instances. </span><span class="koboSpan" id="kobo.2236.2">Click the link (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2237.1">kali-00</span></strong><span class="koboSpan" id="kobo.2238.1">) under the </span><strong class="bold"><span class="koboSpan" id="kobo.2239.1">Name</span></strong><span class="koboSpan" id="kobo.2240.1"> column to navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.2241.1">Instance details</span></strong><span class="koboSpan" id="kobo.2242.1"> page of our Kali Linux VM </span><span class="No-Break"><span class="koboSpan" id="kobo.2243.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2244.1">kali-00</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2245.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.2246.1">Let’s access the serial console by clicking on the </span><strong class="bold"><span class="koboSpan" id="kobo.2247.1">CONNECT TO SERIAL CONSOLE</span></strong><span class="koboSpan" id="kobo.2248.1"> button. </span><span class="koboSpan" id="kobo.2248.2">A pop-up window </span><span class="No-Break"><span class="koboSpan" id="kobo.2249.1">will open.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2250.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2251.1">The serial console allows users to conveniently access the serial port of a VM instance directly in GCP. </span><span class="koboSpan" id="kobo.2251.2">If the serial console is unresponsive, feel free to reboot or restart the VM instance, as this can often resolve the issue and restore functionality for troubleshooting and diagnostics. </span><span class="koboSpan" id="kobo.2251.3">You may also run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2252.1">clear</span></strong><span class="koboSpan" id="kobo.2253.1"> command in case you need to clear the contents of the </span><span class="No-Break"><span class="koboSpan" id="kobo.2254.1">terminal screen.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2255.1">Once you see a blank page inside the pop-up window, click inside the blank page and then press the </span><em class="italic"><span class="koboSpan" id="kobo.2256.1">Enter</span></em><span class="koboSpan" id="kobo.2257.1"> key. </span><span class="koboSpan" id="kobo.2257.2">You should see a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2258.1">root@kali:~#</span></strong><span class="koboSpan" id="kobo.2259.1"> prompt where you can run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2260.1">bash</span></strong><span class="koboSpan" id="kobo.2261.1"> commands as the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2262.1">root</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2263.1"> user.</span></span></li>
<li><span class="koboSpan" id="kobo.2264.1">Now, let’s run the following block of code (after </span><strong class="source-inline"><span class="koboSpan" id="kobo.2265.1">root@kali:~#</span></strong><span class="koboSpan" id="kobo.2266.1">) to set up access to our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2267.1">kali</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2268.1"> user:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2269.1">NEW_USER="kali"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2270.1">if ! </span><span class="koboSpan" id="kobo.2270.2">id -u $NEW_USER &gt; /dev/null 2&gt;&amp;1; then</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2271.1">    adduser --disabled-password --gecos "" $NEW_USER</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2272.1">fi</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2273.1">mkdir -p /home/$NEW_USER/.ssh</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2274.1">chown $NEW_USER:$NEW_USER /home/$NEW_USER/.ssh</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2275.1">chmod 700 /home/$NEW_USER/.ssh</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2276.1">Here, we first check if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2277.1">kali</span></strong><span class="koboSpan" id="kobo.2278.1"> user exists and create it if it doesn’t exist. </span><span class="koboSpan" id="kobo.2278.2">It then sets up the SSH directory for the user, ensuring proper ownership </span><span class="No-Break"><span class="koboSpan" id="kobo.2279.1">and permissions.</span></span></p></li> <li><span class="koboSpan" id="kobo.2280.1">Run the following commands (one line at a time) to write the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2281.1">$SSH_KEY</span></strong><span class="koboSpan" id="kobo.2282.1"> variable to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2283.1">authorized_keys</span></strong><span class="koboSpan" id="kobo.2284.1"> file located in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2285.1">.ssh</span></strong><span class="koboSpan" id="kobo.2286.1"> directory of the user’s home directory. </span><span class="koboSpan" id="kobo.2286.2">After that, use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2287.1">cat</span></strong><span class="koboSpan" id="kobo.2288.1"> command to display the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2289.1">authorized_keys</span></strong><span class="koboSpan" id="kobo.2290.1"> file to check if the changes have been </span><span class="No-Break"><span class="koboSpan" id="kobo.2291.1">applied correctly:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2292.1">
SSH_KEY="</span><strong class="bold"><span class="koboSpan" id="kobo.2293.1">&lt;SSH PUBLIC KEY VALUE&gt;</span></strong><span class="koboSpan" id="kobo.2294.1">"
echo $SSH_KEY &gt; /home/$NEW_USER/.ssh/authorized_keys
cat /home/$NEW_USER/.ssh/authorized_keys</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2295.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2296.1">&lt;SSH PUBLIC KEY VALUE&gt;</span></strong><span class="koboSpan" id="kobo.2297.1"> with the output of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2298.1">cat kali-ssh.pub</span></strong><span class="koboSpan" id="kobo.2299.1"> command we ran in a </span><span class="No-Break"><span class="koboSpan" id="kobo.2300.1">previous step.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2301.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2302.1">The value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2303.1">$SSH_KEY</span></strong><span class="koboSpan" id="kobo.2304.1"> variable should follow a format resembling </span><strong class="source-inline"><span class="koboSpan" id="kobo.2305.1">ssh-rsa ... </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2306.1">kali</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2307.1">.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.2308.1">Next, let’s </span><a id="_idIndexMarker495"/><span class="koboSpan" id="kobo.2309.1">run the following commands (one line at a time) to </span><a id="_idIndexMarker496"/><span class="koboSpan" id="kobo.2310.1">change the ownership of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2311.1">authorized_keys</span></strong><span class="koboSpan" id="kobo.2312.1"> file to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2313.1">$NEW_USER</span></strong><span class="koboSpan" id="kobo.2314.1"> user, set the file permissions to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2315.1">600</span></strong><span class="koboSpan" id="kobo.2316.1"> for restricted access, and then restart the </span><span class="No-Break"><span class="koboSpan" id="kobo.2317.1">SSH service:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2318.1">chown $NEW_USER:$NEW_USER /home/$NEW_USER/.ssh/authorized_keys</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2319.1">chmod 600 /home/$NEW_USER/.ssh/authorized_keys</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2320.1">systemctl restart ssh</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2321.1">Run the</span><a id="_idIndexMarker497"/><span class="koboSpan" id="kobo.2322.1"> following commands</span><a id="_idIndexMarker498"/><span class="koboSpan" id="kobo.2323.1"> to (1) add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2324.1">$NEW_USER</span></strong><span class="koboSpan" id="kobo.2325.1"> user to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2326.1">sudo</span></strong><span class="koboSpan" id="kobo.2327.1"> group, (2) grant the user passwordless sudo privileges by creating a configuration file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2328.1">/etc/sudoers.d/</span></strong><span class="koboSpan" id="kobo.2329.1"> directory, and (3) set appropriate permissions for the </span><span class="No-Break"><span class="koboSpan" id="kobo.2330.1">configuration file:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2331.1">usermod -aG sudo $NEW_USER</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2332.1">echo '$NEW_USER ALL=(ALL) NOPASSWD: ALL' &gt; /etc/sudoers.d/$NEW_USER-nopasswd</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2333.1">chmod 440 /etc/sudoers.d/$NEW_USER-nopasswd</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2334.1">Now, let’s switch to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2335.1">kali</span></strong><span class="koboSpan" id="kobo.2336.1"> user account and then navigate to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2337.1">home folder:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2338.1">su kali</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2339.1">cd ~</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2340.1">Let’s update the package lists and then install the default set of packages for Kali Linux using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2341.1">following commands:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2342.1">sudo DEBIAN_FRONTEND=noninteractive dpkg --configure -a</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2343.1">sudo apt update</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2344.1">sudo apt install -y dbus-x11</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2345.1">sudo DEBIAN_FRONTEND=noninteractive apt install -y kali-linux-default</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2346.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2347.1">This step may take 15-20 minutes to complete. </span><span class="koboSpan" id="kobo.2347.2">Feel free to grab a cup of coffee or tea while waiting! </span><span class="koboSpan" id="kobo.2347.3">In case you’re looking for a script that automates </span><em class="italic"><span class="koboSpan" id="kobo.2348.1">most</span></em><span class="koboSpan" id="kobo.2349.1"> of the work done in this section, you may check the following link: </span><a href="https://bit.ly/kali-desktop-setup"><span class="koboSpan" id="kobo.2350.1">https://bit.ly/kali-desktop-setup</span></a><span class="koboSpan" id="kobo.2351.1">. </span><span class="koboSpan" id="kobo.2351.2">In this chapter, we have set up the attacker VM instance manually so that we have a better understanding and appreciation of what’s happening behind the scenes while running the installation commands. </span><span class="koboSpan" id="kobo.2351.3">In the next chapter, we will use an automated script to set up the attacker VM instance to speed things up </span><span class="No-Break"><span class="koboSpan" id="kobo.2352.1">a bit.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.2353.1">Next, download </span><a id="_idIndexMarker499"/><span class="koboSpan" id="kobo.2354.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2355.1">xfce4.sh</span></strong><span class="koboSpan" id="kobo.2356.1"> script, make</span><a id="_idIndexMarker500"/><span class="koboSpan" id="kobo.2357.1"> it executable using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2358.1">chmod</span></strong><span class="koboSpan" id="kobo.2359.1"> command, and then execute it using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2360.1">following commands:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2361.1">cd ~</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2362.1">wget </span></strong><a href="https://gitlab.com/kalilinux/recipes/kali-scripts/-/raw/main/xfce4.sh"><strong class="bold"><span class="koboSpan" id="kobo.2363.1">https://gitlab.com/kalilinux/recipes/kali-scripts/-/raw/main/xfce4.sh</span></strong></a>
<strong class="bold"><span class="koboSpan" id="kobo.2364.1">chmod +x xfce4.sh</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2365.1">sudo DEBIAN_FRONTEND=noninteractive ./xfce4.sh</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2366.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2367.1">This step may take around 10 minutes to complete. </span><span class="koboSpan" id="kobo.2367.2">Feel free to grab a cup of coffee or tea </span><span class="No-Break"><span class="koboSpan" id="kobo.2368.1">while waiting!</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.2369.1">Now, let’s enable and start the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2370.1">xrdp</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2371.1"> service:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2372.1">sudo systemctl enable xrdp --now</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2373.1">Let’s also set the password for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2374.1">kali</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2375.1"> user:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2376.1">echo kali:kali | sudo chpasswd</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2377.1">Next, let’s install </span><strong class="bold"><span class="koboSpan" id="kobo.2378.1">TigerVNC</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2379.1">and </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2380.1">noVNC</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2381.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2382.1">sudo apt install -y tigervnc-standalone-server</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2383.1">VNCPASS=kali123</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2384.1">printf "$VNCPASS\n$VNCPASS\n\n" | vncpasswd</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2385.1">sudo DEBIAN_FRONTEND=noninteractive apt install -y novnc</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2386.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2387.1">This step may take a minute or two to complete. </span><span class="koboSpan" id="kobo.2387.2">Feel free to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2388.1">clear</span></strong><span class="koboSpan" id="kobo.2389.1"> command to clear the screen (after the previous block of commands has </span><span class="No-Break"><span class="koboSpan" id="kobo.2390.1">finished running).</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.2391.1">Run </span><a id="_idIndexMarker501"/><span class="koboSpan" id="kobo.2392.1">the following commands</span><a id="_idIndexMarker502"/><span class="koboSpan" id="kobo.2393.1"> to check if the VNC server and the noVNC proxy have been </span><span class="No-Break"><span class="koboSpan" id="kobo.2394.1">installed successfully:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2395.1">which vncserver</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2396.1">/usr/share/novnc/utils/novnc_proxy --help</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2397.1">Let’s run the following command to edit</span><a id="_idIndexMarker503"/><span class="koboSpan" id="kobo.2398.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.2399.1">cron table</span></strong><span class="koboSpan" id="kobo.2400.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.2401.1">crontab</span></strong><span class="koboSpan" id="kobo.2402.1">) for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2403.1">kali</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2404.1"> user:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2405.1">EDITOR=vim crontab -e -u kali</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2406.1">Here, we specified that we want to</span><a id="_idIndexMarker504"/><span class="koboSpan" id="kobo.2407.1"> use </span><strong class="bold"><span class="koboSpan" id="kobo.2408.1">Vim</span></strong><span class="koboSpan" id="kobo.2409.1"> to edit the </span><span class="No-Break"><span class="koboSpan" id="kobo.2410.1">crontab configuration.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2411.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2412.1">In case you are wondering what the </span><strong class="bold"><span class="koboSpan" id="kobo.2413.1">crontab</span></strong><span class="koboSpan" id="kobo.2414.1"> is used for, it is simply a time-based job scheduler often used by users when performing administrative and scheduled (often repetitive) tasks. </span><span class="koboSpan" id="kobo.2414.2">Each user on the system can have their own crontab file containing a list of scheduled tasks. </span><span class="koboSpan" id="kobo.2414.3">Users can create, edit, and manage their crontab files using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2415.1">crontab</span></strong><span class="koboSpan" id="kobo.2416.1"> command, which provides options to view, modify, or </span><span class="No-Break"><span class="koboSpan" id="kobo.2417.1">remove entries.</span></span></p>
<ol>
<li value="16"><span class="koboSpan" id="kobo.2418.1">Press </span><em class="italic"><span class="koboSpan" id="kobo.2419.1">Shift</span></em><span class="koboSpan" id="kobo.2420.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.2421.1">g</span></em><span class="koboSpan" id="kobo.2422.1"> to jump to the last line of the file. </span><span class="koboSpan" id="kobo.2422.2">Press </span><em class="italic"><span class="koboSpan" id="kobo.2423.1">o</span></em><span class="koboSpan" id="kobo.2424.1"> (lowercase letter “o”) to open a new line below the current line and enter </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2425.1">insert mode</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2426.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2427.1">Add the following two entries to the end of </span><span class="No-Break"><span class="koboSpan" id="kobo.2428.1">the file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2429.1">
@reboot sleep 60 &amp;&amp; /usr/bin/</span><strong class="bold"><span class="koboSpan" id="kobo.2430.1">vncserver</span></strong><span class="koboSpan" id="kobo.2431.1">
@reboot sleep 60 &amp;&amp; /usr/share/novnc/utils/</span><strong class="bold"><span class="koboSpan" id="kobo.2432.1">novnc_proxy</span></strong><span class="koboSpan" id="kobo.2433.1"> --listen 0.0.0.0:8081 --vnc localhost:5901 &gt;/dev/null 2&gt;&amp;1 &amp;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2434.1">By </span><a id="_idIndexMarker505"/><span class="koboSpan" id="kobo.2435.1">including these crontab entries</span><a id="_idIndexMarker506"/><span class="koboSpan" id="kobo.2436.1"> prefixed with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2437.1">@reboot</span></strong><span class="koboSpan" id="kobo.2438.1">, the VNC server and the noVNC proxy will automatically start upon each system reboot. </span><span class="koboSpan" id="kobo.2438.2">This will (1) ensure persistent access to the graphical desktop environment and (2) enable remote connections via the web-based noVNC client. </span><span class="koboSpan" id="kobo.2438.3">Here, you can see that we’ve configured </span><strong class="source-inline"><span class="koboSpan" id="kobo.2439.1">vncserver</span></strong><span class="koboSpan" id="kobo.2440.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2441.1">novnc_proxy</span></strong><span class="koboSpan" id="kobo.2442.1"> to run after 60 seconds to wait for the system processes to be ready before these </span><span class="No-Break"><span class="koboSpan" id="kobo.2443.1">are run.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2444.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2445.1">Keep in mind that there are other alternative methods available for running the VNC server and the noVNC proxy during system boot. </span><span class="koboSpan" id="kobo.2445.2">These include using </span><strong class="source-inline"><span class="koboSpan" id="kobo.2446.1">init</span></strong><span class="koboSpan" id="kobo.2447.1"> scripts, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2448.1">systemd</span></strong><span class="koboSpan" id="kobo.2449.1"> units, or startup configuration files, depending on the specific operating system and </span><span class="No-Break"><span class="koboSpan" id="kobo.2450.1">configuration preferences.</span></span></p>
<ol>
<li value="18"><span class="koboSpan" id="kobo.2451.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.2452.1">Esc</span></em><span class="koboSpan" id="kobo.2453.1"> key to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.2454.1">normal mode</span></strong><span class="koboSpan" id="kobo.2455.1">. </span><span class="koboSpan" id="kobo.2455.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.2456.1">:wq!</span></strong><span class="koboSpan" id="kobo.2457.1">. </span><span class="koboSpan" id="kobo.2457.2">Press </span><em class="italic"><span class="koboSpan" id="kobo.2458.1">Enter</span></em><span class="koboSpan" id="kobo.2459.1"> afterward. </span><span class="koboSpan" id="kobo.2459.2">This will save the changes to the crontab configuration and then exit Vim as well. </span><span class="koboSpan" id="kobo.2459.3">Feel free to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2460.1">crontab -l</span></strong><span class="koboSpan" id="kobo.2461.1"> to verify that the scheduled tasks and commands have been correctly configured in the cron job scheduler of the </span><span class="No-Break"><span class="koboSpan" id="kobo.2462.1">VM instance.</span></span></li>
<li><span class="koboSpan" id="kobo.2463.1">Close the serial console </span><span class="No-Break"><span class="koboSpan" id="kobo.2464.1">pop-up window.</span></span></li>
<li><span class="koboSpan" id="kobo.2465.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.2466.1">VM details</span></strong><span class="koboSpan" id="kobo.2467.1"> page, locate and click the </span><strong class="bold"><span class="koboSpan" id="kobo.2468.1">RESET</span></strong><span class="koboSpan" id="kobo.2469.1"> button to restart the instance. </span><span class="koboSpan" id="kobo.2469.2">Wait </span><a id="_idIndexMarker507"/><span class="koboSpan" id="kobo.2470.1">for about 3-5 minutes for the</span><a id="_idIndexMarker508"/><span class="koboSpan" id="kobo.2471.1"> instance </span><span class="No-Break"><span class="koboSpan" id="kobo.2472.1">to reboot.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2473.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2474.1">We can safely close the Cloud Shell editor for now, as we won’t lose any files or progress (closing the editor does not delete or remove any files). </span><span class="koboSpan" id="kobo.2474.2">We can open it again later when we need to edit files or run </span><span class="No-Break"><span class="koboSpan" id="kobo.2475.1">terminal commands.</span></span></p>
<h2 id="_idParaDest-84"><a id="_idTextAnchor083"/><span class="koboSpan" id="kobo.2476.1">Part 3 of 3 – Validating our setup</span></h2>
<p><span class="koboSpan" id="kobo.2477.1">Before automating our</span><a id="_idIndexMarker509"/><span class="koboSpan" id="kobo.2478.1"> current setup, we first need to validate that the VM instance we manually set up and configured is working. </span><span class="koboSpan" id="kobo.2478.2">To do so, proceed </span><span class="No-Break"><span class="koboSpan" id="kobo.2479.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2480.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.2481.1">Instance details</span></strong><span class="koboSpan" id="kobo.2482.1"> page of our Kali Linux VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2483.1">kali-00</span></strong><span class="koboSpan" id="kobo.2484.1">), scroll down and locate the </span><strong class="bold"><span class="koboSpan" id="kobo.2485.1">External IP address</span></strong><span class="koboSpan" id="kobo.2486.1"> value (under </span><strong class="bold"><span class="koboSpan" id="kobo.2487.1">Network interfaces</span></strong><span class="koboSpan" id="kobo.2488.1">) and copy it to </span><span class="No-Break"><span class="koboSpan" id="kobo.2489.1">your clipboard.</span></span></li>
<li><span class="koboSpan" id="kobo.2490.1">Open a new browser tab and access the web-based noVNC client using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2491.1">following URL:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2492.1">
http://</span><strong class="bold"><span class="koboSpan" id="kobo.2493.1">&lt;ATTACKER VM PUBLIC IP ADDRESS&gt;</span></strong><span class="koboSpan" id="kobo.2494.1">:8081/vnc.html</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2495.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2496.1">&lt;ATTACKER VM PUBLIC IP ADDRESS&gt;</span></strong><span class="koboSpan" id="kobo.2497.1"> with the </span><strong class="bold"><span class="koboSpan" id="kobo.2498.1">External IP address</span></strong><span class="koboSpan" id="kobo.2499.1"> value copied to the clipboard in an </span><span class="No-Break"><span class="koboSpan" id="kobo.2500.1">earlier step.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.2501.1">This should open a welcome screen with a </span><strong class="bold"><span class="koboSpan" id="kobo.2502.1">Connect</span></strong><span class="koboSpan" id="kobo.2503.1"> button, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2504.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2505.1">.31</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2506.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer096">
<span class="koboSpan" id="kobo.2507.1"><img alt="" src="image/B19755_04_31.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2508.1">Figure 4.31 – noVNC welcome screen</span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2509.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2510.1">If you find yourself unable to access the welcome screen, it is possible that your IP address might have changed already. </span><span class="koboSpan" id="kobo.2510.2">Simply open the Cloud Shell editor and update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2511.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.2512.1"> file. </span><span class="koboSpan" id="kobo.2512.2">Once the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2513.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.2514.1"> file has been updated with the new IP address of your local machine, run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2515.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2516.1"> command again to update the firewall rule to whitelist your new </span><span class="No-Break"><span class="koboSpan" id="kobo.2517.1">IP address.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2518.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2519.1">Connect</span></strong><span class="koboSpan" id="kobo.2520.1"> button</span><a id="_idIndexMarker510"/><span class="koboSpan" id="kobo.2521.1"> and then use the password </span><strong class="source-inline"><span class="koboSpan" id="kobo.2522.1">kali123</span></strong><span class="koboSpan" id="kobo.2523.1"> (or use the password you specified in an earlier step) to access the desktop environment, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2524.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2525.1">.32</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2526.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer097">
<span class="koboSpan" id="kobo.2527.1"><img alt="" src="image/B19755_04_32.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2528.1">Figure 4.32 – Accessing the Kali Linux desktop/GUI environment in the browser</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2529.1">Once we’re</span><a id="_idIndexMarker511"/><span class="koboSpan" id="kobo.2530.1"> able to access the desktop environment, we should be able to perform various tasks and access the wide range of tools and utilities available in Kali Linux (similar to how we would use it on our </span><span class="No-Break"><span class="koboSpan" id="kobo.2531.1">local machine).</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2532.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2533.1">In case you encounter a </span><strong class="bold"><span class="koboSpan" id="kobo.2534.1">Failed to connect to server</span></strong><span class="koboSpan" id="kobo.2535.1"> error, wait for about 2-3 minutes before trying to access the desktop/GUI </span><span class="No-Break"><span class="koboSpan" id="kobo.2536.1">environment again.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.2537.1">Open the Firefox browser by clicking on the </span><strong class="bold"><span class="koboSpan" id="kobo.2538.1">Firefox</span></strong><span class="koboSpan" id="kobo.2539.1"> icon located at the upper-left corner of the desktop environment. </span><span class="koboSpan" id="kobo.2539.2">Navigate to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2540.1">http://&lt;PRIVATE IP OF TARGET VM&gt;</span></strong><span class="koboSpan" id="kobo.2541.1"> to open the OWASP Juice Shop vulnerable </span><span class="No-Break"><span class="koboSpan" id="kobo.2542.1">web application:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer098">
<span class="koboSpan" id="kobo.2543.1"><img alt="" src="image/B19755_04_33.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2544.1">Figure 4.33 – Accessing the target instance from a browser running in the attacker instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2545.1">Please </span><a id="_idIndexMarker512"/><span class="koboSpan" id="kobo.2546.1">remember to use the private IP address of the target VM instance instead of the public IP address, as our </span><strong class="bold"><span class="koboSpan" id="kobo.2547.1">VPC 01</span></strong><span class="koboSpan" id="kobo.2548.1"> network has been specifically configured to allow traffic only from resources within </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2549.1">VPC 02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2550.1">.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2551.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2552.1">Now that we have verified that our setup is working correctly, we can close the browser tab used to access the Kali Linux desktop environment. </span><span class="koboSpan" id="kobo.2552.2">We’ll resume the exploration of the OWASP Juice Shop application in the </span><em class="italic"><span class="koboSpan" id="kobo.2553.1">Simulating penetration testing in the isolated network environment</span></em><span class="koboSpan" id="kobo.2554.1"> section of </span><span class="No-Break"><span class="koboSpan" id="kobo.2555.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.2556.1">It is important to note that we can also access the desktop environment of the attacker instance from our local machine using</span><a id="_idIndexMarker513"/><span class="koboSpan" id="kobo.2557.1"> an </span><strong class="bold"><span class="koboSpan" id="kobo.2558.1">SSH tunnel</span></strong><span class="koboSpan" id="kobo.2559.1">. </span><em class="italic"><span class="koboSpan" id="kobo.2560.1">Remember the private key file we generated earlier in this chapter?</span></em><span class="koboSpan" id="kobo.2561.1"> Once we’ve downloaded this key file to our local machine, we simply need to (1) open a new terminal tab in our local machine, (2) navigate to the directory containing the private key file, and (3) run the following command to create an SSH tunnel between our local machine and the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.2562.1">VM instance:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2563.1">ssh -L 8081:localhost:8081 -N -i &lt;INSERT KEY NAME&gt; &lt;USER&gt;@&lt;ATTACKER VM IP&gt;</span></strong></pre> <p><span class="koboSpan" id="kobo.2564.1">Once the SSH tunnel has been set up, we can access the same desktop environment through </span><strong class="source-inline"><span class="koboSpan" id="kobo.2565.1">http://localhost:8081/vnc.html</span></strong><span class="koboSpan" id="kobo.2566.1"> (instead of using the public IP address of the attacker VM instance). </span><span class="koboSpan" id="kobo.2566.2">If you are wondering what an SSH tunnel is, it is simply a secure encrypted </span><a id="_idIndexMarker514"/><span class="koboSpan" id="kobo.2567.1">connection used to access services and applications </span><a id="_idIndexMarker515"/><span class="koboSpan" id="kobo.2568.1">running inside a remote server. </span><span class="koboSpan" id="kobo.2568.2">SSH tunnels leverage the encryption and authentication capabilities of SSH to secure data transmitted over the tunnel. </span><span class="koboSpan" id="kobo.2568.3">With an SSH tunnel, we can securely access the desktop environment of the attack </span><span class="No-Break"><span class="koboSpan" id="kobo.2569.1">VM instance.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.2570.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2571.1">We’ll leave this to you as an exercise. </span><span class="koboSpan" id="kobo.2571.2">In addition to this, feel free to check </span><a href="https://github.com/novnc/noVNC/wiki/Advanced-usage"><span class="koboSpan" id="kobo.2572.1">https://github.com/novnc/noVNC/wiki/Advanced-usage</span></a><span class="koboSpan" id="kobo.2573.1"> in case you want to further upgrade </span><span class="No-Break"><span class="koboSpan" id="kobo.2574.1">our setup.</span></span></p>
<h1 id="_idParaDest-85"><a id="_idTextAnchor084"/><span class="koboSpan" id="kobo.2575.1">Leveraging Terraform to automatically set up the attacker VM instance</span></h1>
<p><span class="koboSpan" id="kobo.2576.1">The </span><a id="_idIndexMarker516"/><span class="koboSpan" id="kobo.2577.1">previous section primarily focused on setting up the attacker VM instance manually. </span><span class="koboSpan" id="kobo.2577.2">This was necessary because we will utilize this VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2578.1">kali-00</span></strong><span class="koboSpan" id="kobo.2579.1">) as a reference to create a </span><strong class="bold"><span class="koboSpan" id="kobo.2580.1">golden image</span></strong><span class="koboSpan" id="kobo.2581.1">. </span><span class="koboSpan" id="kobo.2581.2">By creating a </span><a id="_idIndexMarker517"/><span class="koboSpan" id="kobo.2582.1">golden image, we can capture the desired configuration and settings of the VM instance, making it easier to replicate and deploy similar instances with the same specifications in </span><span class="No-Break"><span class="koboSpan" id="kobo.2583.1">the future.</span></span></p>
<p><span class="koboSpan" id="kobo.2584.1">Note that another approach when automating the process of setting up VM instances involves the usage of IaC tools such as Ansible to set up </span><em class="italic"><span class="koboSpan" id="kobo.2585.1">what’s inside the VM instance</span></em><span class="koboSpan" id="kobo.2586.1"> (in addition to the usage of Terraform for setting up, configuring, and managing the cloud resources). </span><span class="koboSpan" id="kobo.2586.2">When preparing VM instances, it is important that we have a good understanding of the distinct advantages and differences of each approach. </span><span class="koboSpan" id="kobo.2586.3">Golden images are well suited to scenarios where a predefined and static environment is required since they can capture the desired configuration, settings, and software of a fully configured VM instance. </span><span class="koboSpan" id="kobo.2586.4">By using golden images as templates, new instances can be quickly created with the exact same specifications—ensuring consistency along with reducing the time and effort required for manual configuration. </span><span class="koboSpan" id="kobo.2586.5">On the other hand, using IaC tools such as Ansible (in addition to Terraform) allows for dynamic configuration changes, making them suitable for environments that require frequent updates and</span><a id="_idIndexMarker518"/> <span class="No-Break"><span class="koboSpan" id="kobo.2587.1">configuration changes.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.2588.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2589.1">That said, the most suitable approach really depends on the specific needs of the environment and the level of customization required, along with the desired level of automation and flexibility in managing </span><span class="No-Break"><span class="koboSpan" id="kobo.2590.1">VM instances.</span></span></p>
<p><span class="koboSpan" id="kobo.2591.1">We’ll divide this section into three parts, </span><span class="No-Break"><span class="koboSpan" id="kobo.2592.1">as follows:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.2593.1">Part 1 of 3 – Creating a </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2594.1">golden image</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2595.1">Part 2 of 3 – Using Terraform to prepare the attacker </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2596.1">VM instance</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2597.1">Part 3 of 3 – Accessing the Kali Linux </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2598.1">desktop environment</span></em></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2599.1">With these points in mind, let’s proceed with automating the process of setting up our attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.2600.1">VM instance!</span></span></p>
<h2 id="_idParaDest-86"><a id="_idTextAnchor085"/><span class="koboSpan" id="kobo.2601.1">Part 1 of 3 – Creating a golden image</span></h2>
<p><span class="koboSpan" id="kobo.2602.1">Follow the</span><a id="_idIndexMarker519"/> <span class="No-Break"><span class="koboSpan" id="kobo.2603.1">next steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2604.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.2605.1">VM instances</span></strong><span class="koboSpan" id="kobo.2606.1"> page by typing </span><strong class="source-inline"><span class="koboSpan" id="kobo.2607.1">compute engine</span></strong><span class="koboSpan" id="kobo.2608.1"> in the search box and selecting </span><strong class="bold"><span class="koboSpan" id="kobo.2609.1">Compute Engine</span></strong><span class="koboSpan" id="kobo.2610.1"> from the search results. </span><span class="koboSpan" id="kobo.2610.2">Here, we’ll find a list of VM instances in our </span><span class="No-Break"><span class="koboSpan" id="kobo.2611.1">GCP account.</span></span></li>
<li><span class="koboSpan" id="kobo.2612.1">Click the link (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2613.1">kali-00</span></strong><span class="koboSpan" id="kobo.2614.1">) under the </span><strong class="bold"><span class="koboSpan" id="kobo.2615.1">Name</span></strong><span class="koboSpan" id="kobo.2616.1"> column to navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.2617.1">Instance details</span></strong><span class="koboSpan" id="kobo.2618.1"> page of our attacker VM </span><span class="No-Break"><span class="koboSpan" id="kobo.2619.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2620.1">kali-00</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2621.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.2622.1">Turn off the instance by clicking </span><strong class="bold"><span class="koboSpan" id="kobo.2623.1">STOP</span></strong><span class="koboSpan" id="kobo.2624.1">. </span><span class="koboSpan" id="kobo.2624.2">Confirm the action by clicking </span><strong class="bold"><span class="koboSpan" id="kobo.2625.1">STOP</span></strong><span class="koboSpan" id="kobo.2626.1"> in the </span><strong class="bold"><span class="koboSpan" id="kobo.2627.1">Stop kali-00</span></strong><span class="koboSpan" id="kobo.2628.1"> popup </span><span class="No-Break"><span class="koboSpan" id="kobo.2629.1">that appears.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2630.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2631.1">Take note that it may take around 3-5 minutes for the VM instance to stop. </span><span class="koboSpan" id="kobo.2631.2">Please wait for the VM instance to stop before proceeding to the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.2632.1">of steps.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.2633.1">Next, click </span><strong class="bold"><span class="koboSpan" id="kobo.2634.1">CREATE </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2635.1">MACHINE IMAGE</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2636.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2637.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.2638.1">Create a machine image</span></strong><span class="koboSpan" id="kobo.2639.1"> page, specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.2640.1">kali-golden-image</span></strong><span class="koboSpan" id="kobo.2641.1"> for the </span><strong class="bold"><span class="koboSpan" id="kobo.2642.1">Name</span></strong><span class="koboSpan" id="kobo.2643.1"> value and then click the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2644.1">CREATE</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2645.1"> button.</span></span></li>
<li><span class="koboSpan" id="kobo.2646.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.2647.1">Machine images</span></strong><span class="koboSpan" id="kobo.2648.1"> page, wait</span><a id="_idIndexMarker520"/><span class="koboSpan" id="kobo.2649.1"> for a few minutes for the status of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2650.1">kali-golden-image</span></strong><span class="koboSpan" id="kobo.2651.1"> image to </span><span class="No-Break"><span class="koboSpan" id="kobo.2652.1">be </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2653.1">Ready</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2654.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2655.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2656.1">You may click the </span><strong class="bold"><span class="koboSpan" id="kobo.2657.1">REFRESH</span></strong><span class="koboSpan" id="kobo.2658.1"> button to update the status and check if the image is ready </span><span class="No-Break"><span class="koboSpan" id="kobo.2659.1">for use.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.2660.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.2661.1">Machine image details</span></strong><span class="koboSpan" id="kobo.2662.1"> page. </span><span class="koboSpan" id="kobo.2662.2">Scroll down to the bottom of the page and click the </span><strong class="bold"><span class="koboSpan" id="kobo.2663.1">REST</span></strong><span class="koboSpan" id="kobo.2664.1"> link (from </span><strong class="bold"><span class="koboSpan" id="kobo.2665.1">Equivalent REST or </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2666.1">command line</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2667.1">).</span></span><p class="list-inset"><span class="koboSpan" id="kobo.2668.1">Locate and copy the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2669.1">selfLink</span></strong><span class="koboSpan" id="kobo.2670.1"> value, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2671.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2672.1">.34</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2673.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer099">
<span class="koboSpan" id="kobo.2674.1"><img alt="" src="image/B19755_04_34.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2675.1">Figure 4.34 – Locating the selfLink value of the machine image</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2676.1">Store this value in a</span><a id="_idIndexMarker521"/><span class="koboSpan" id="kobo.2677.1"> text editor on your local machine. </span><span class="koboSpan" id="kobo.2677.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2678.1">selfLink</span></strong><span class="koboSpan" id="kobo.2679.1"> value should have a format similar to </span><span class="No-Break"><span class="koboSpan" id="kobo.2680.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.2681.1">
projects/</span><strong class="bold"><span class="koboSpan" id="kobo.2682.1">&lt;PROJECT ID&gt;</span></strong><span class="koboSpan" id="kobo.2683.1">/global/machineImages/kali-golden-image</span></pre> <p class="list-inset"><span class="koboSpan" id="kobo.2684.1">Keep in mind that you’ll get a different </span><strong class="source-inline"><span class="koboSpan" id="kobo.2685.1">&lt;PROJECT ID&gt;</span></strong><span class="koboSpan" id="kobo.2686.1"> value (so do not copy and paste exactly what’s in </span><span class="No-Break"><span class="koboSpan" id="kobo.2687.1">the screenshot).</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2688.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2689.1">Note that further upgrades can still be implemented on top of the image we prepared in the previous set of steps. </span><span class="koboSpan" id="kobo.2689.2">In the meantime, this should do the trick </span><span class="No-Break"><span class="koboSpan" id="kobo.2690.1">for now.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.2691.1">Navigate back to the </span><strong class="bold"><span class="koboSpan" id="kobo.2692.1">VM instances</span></strong><span class="koboSpan" id="kobo.2693.1"> page. </span><span class="koboSpan" id="kobo.2693.2">Click the link (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2694.1">kali-00</span></strong><span class="koboSpan" id="kobo.2695.1">) under the </span><strong class="bold"><span class="koboSpan" id="kobo.2696.1">Name</span></strong><span class="koboSpan" id="kobo.2697.1"> column to navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.2698.1">Instance details</span></strong><span class="koboSpan" id="kobo.2699.1"> page of our attacker VM </span><span class="No-Break"><span class="koboSpan" id="kobo.2700.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2701.1">kali-00</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2702.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.2703.1">Delete the Kali</span><a id="_idIndexMarker522"/><span class="koboSpan" id="kobo.2704.1"> Linux instance (named </span><strong class="source-inline"><span class="koboSpan" id="kobo.2705.1">kali-00</span></strong><span class="koboSpan" id="kobo.2706.1">) we created manually using the </span><strong class="bold"><span class="koboSpan" id="kobo.2707.1">DELETE</span></strong><span class="koboSpan" id="kobo.2708.1"> button in the </span><strong class="bold"><span class="koboSpan" id="kobo.2709.1">VM instances</span></strong><span class="koboSpan" id="kobo.2710.1"> page. </span><span class="koboSpan" id="kobo.2710.2">Confirm the deletion by clicking </span><strong class="bold"><span class="koboSpan" id="kobo.2711.1">DELETE</span></strong><span class="koboSpan" id="kobo.2712.1"> in the </span><strong class="bold"><span class="koboSpan" id="kobo.2713.1">Delete </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2714.1">kali-00</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2715.1"> popup.</span></span></li>
</ol>
<h2 id="_idParaDest-87"><a id="_idTextAnchor086"/><span class="koboSpan" id="kobo.2716.1">Part 2 of 3 – Using Terraform to prepare the attacker VM instance</span></h2>
<p><span class="koboSpan" id="kobo.2717.1">Follow</span><a id="_idIndexMarker523"/><span class="koboSpan" id="kobo.2718.1"> the </span><a id="_idIndexMarker524"/><span class="No-Break"><span class="koboSpan" id="kobo.2719.1">next steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2720.1">Open the Cloud Shell terminal. </span><span class="koboSpan" id="kobo.2720.2">In case you closed it while working on an earlier step, simply click the </span><strong class="bold"><span class="koboSpan" id="kobo.2721.1">Activate Cloud Shell</span></strong><span class="koboSpan" id="kobo.2722.1"> button on the upper right-hand corner of the page (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2723.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2724.1">.35</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2725.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer100">
<span class="koboSpan" id="kobo.2726.1"><img alt="" src="image/B19755_04_35.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2727.1">Figure 4.35 – Activating Cloud Shell</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2728.1">This should open a terminal where we can run </span><span class="No-Break"><span class="koboSpan" id="kobo.2729.1">command-line commands.</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.2730.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2731.1">Open Editor</span></strong><span class="koboSpan" id="kobo.2732.1"> button located at the upper right-hand corner of the Cloud Shell Terminal pane. </span><span class="koboSpan" id="kobo.2732.2">If you can’t see the terminal, open the </span><strong class="bold"><span class="koboSpan" id="kobo.2733.1">Terminal</span></strong><span class="koboSpan" id="kobo.2734.1"> menu of the Cloud Shell editor and then select </span><strong class="bold"><span class="koboSpan" id="kobo.2735.1">New Terminal</span></strong><span class="koboSpan" id="kobo.2736.1"> from the list </span><span class="No-Break"><span class="koboSpan" id="kobo.2737.1">of options.</span></span></li>
<li><span class="koboSpan" id="kobo.2738.1">In the Cloud Shell terminal (after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2739.1">$</span></strong><span class="koboSpan" id="kobo.2740.1"> sign), navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2741.1">~/pentest_lab/attacker_vm</span></strong><span class="koboSpan" id="kobo.2742.1"> directory by running the following commands (one line at </span><span class="No-Break"><span class="koboSpan" id="kobo.2743.1">a time):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2744.1">cd ~/pentest_lab</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2745.1">cd attacker_vm</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2746.1">Run the following commands (one line at a time) to create the files we’ll need in our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2747.1">attacker_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2748.1"> module:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2749.1">touch main.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2750.1">touch variables.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2751.1">touch outputs.tf</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2752.1">Here, we are </span><a id="_idIndexMarker525"/><span class="koboSpan" id="kobo.2753.1">creating three </span><a id="_idIndexMarker526"/><span class="koboSpan" id="kobo.2754.1">empty files inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2755.1">~/pentest_lab/attacker_vm</span></strong><span class="koboSpan" id="kobo.2756.1"> directory—(1) a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2757.1">main.tf</span></strong><span class="koboSpan" id="kobo.2758.1"> file for defining the main configuration and resources, (2) a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2759.1">variables.tf</span></strong><span class="koboSpan" id="kobo.2760.1"> file for declaring and managing variables used in the configuration, and (3) an </span><strong class="source-inline"><span class="koboSpan" id="kobo.2761.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.2762.1"> file for specifying outputs or values that will be exposed after applying </span><span class="No-Break"><span class="koboSpan" id="kobo.2763.1">the configuration.</span></span></p></li> <li><span class="koboSpan" id="kobo.2764.1">Next, open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2765.1">attacker_vm/variables.tf</span></strong><span class="koboSpan" id="kobo.2766.1"> file in the editor and add the following blocks of code to define </span><strong class="source-inline"><span class="koboSpan" id="kobo.2767.1">subnet_02</span></strong><span class="koboSpan" id="kobo.2768.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2769.1">kali_machine_image</span></strong><span class="koboSpan" id="kobo.2770.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2771.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2772.1"> variables for our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2773.1">attacker_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2774.1"> module:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2775.1">
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.2776.1">subnet_02</span></strong><span class="koboSpan" id="kobo.2777.1">" {
    type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.2778.1">kali_machine_image</span></strong><span class="koboSpan" id="kobo.2779.1">" {
    type = string
    default = "</span><strong class="bold"><span class="koboSpan" id="kobo.2780.1">&lt;INSERT IMAGE&gt;</span></strong><span class="koboSpan" id="kobo.2781.1">"
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.2782.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2783.1">" {
    type = string
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2784.1">Make </span><a id="_idIndexMarker527"/><span class="koboSpan" id="kobo.2785.1">sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2786.1">&lt;INSERT IMAGE&gt;</span></strong><span class="koboSpan" id="kobo.2787.1"> with </span><a id="_idIndexMarker528"/><span class="koboSpan" id="kobo.2788.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2789.1">selfLink</span></strong><span class="koboSpan" id="kobo.2790.1"> value of the machine image from the </span><span class="No-Break"><span class="koboSpan" id="kobo.2791.1">previous section.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2792.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2793.1">Do not forget to save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2794.1">attacker_vm/variables.tf</span></strong><span class="koboSpan" id="kobo.2795.1"> file before proceeding to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2796.1">next step.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.2797.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2798.1">attacker_vm/main.tf</span></strong><span class="koboSpan" id="kobo.2799.1"> file in the editor and add the following blocks of code to define and configure the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.2800.1">VM instance:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2801.1">
locals {
  </span><strong class="bold"><span class="koboSpan" id="kobo.2802.1">subnet_02</span></strong><span class="koboSpan" id="kobo.2803.1"> = var.subnet_02
}
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.2804.1">google_compute_instance_from_machine_image</span></strong><span class="koboSpan" id="kobo.2805.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.2806.1">kali_vm</span></strong><span class="koboSpan" id="kobo.2807.1">" {
  provider = google-beta
  name     = "vm-kali"
  machine_type = "e2-medium"
  zone         = "us-central1-c"
  </span><strong class="bold"><span class="koboSpan" id="kobo.2808.1">source_machine_image = var.kali_machine_image</span></strong><span class="koboSpan" id="kobo.2809.1">
  metadata = {
    ssh-keys = "kali:${</span><strong class="bold"><span class="koboSpan" id="kobo.2810.1">var.my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2811.1">}"
  }
  network_interface {
    subnetwork = </span><strong class="bold"><span class="koboSpan" id="kobo.2812.1">local.subnet_02</span></strong><span class="koboSpan" id="kobo.2813.1">
    access_config {}
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2814.1">Here, we’re using </span><strong class="source-inline"><span class="koboSpan" id="kobo.2815.1">google_compute_instance_from_machine_image</span></strong><span class="koboSpan" id="kobo.2816.1"> instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2817.1">google_compute_instance</span></strong><span class="koboSpan" id="kobo.2818.1"> when defining the attacker VM resource since we </span><a id="_idIndexMarker529"/><span class="koboSpan" id="kobo.2819.1">want to create the </span><a id="_idIndexMarker530"/><span class="koboSpan" id="kobo.2820.1">VM instance from a pre-existing machine image. </span><span class="koboSpan" id="kobo.2820.2">This allows us to quickly provision an instance with the desired configuration and software setup, such as using a Kali Linux image for the attacker VM. </span><span class="koboSpan" id="kobo.2820.3">When typing these blocks of code, make sure that </span><strong class="source-inline"><span class="koboSpan" id="kobo.2821.1">{</span></strong><span class="koboSpan" id="kobo.2822.1"> is after </span><strong class="source-inline"><span class="koboSpan" id="kobo.2823.1">"kali_vm"</span></strong><span class="koboSpan" id="kobo.2824.1"> (same line instead of </span><span class="No-Break"><span class="koboSpan" id="kobo.2825.1">next line).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2826.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2827.1">Do not forget to save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2828.1">attacker_vm/main.tf</span></strong><span class="koboSpan" id="kobo.2829.1"> file before proceeding to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2830.1">next step.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.2831.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2832.1">attacker_vm/outputs.tf</span></strong><span class="koboSpan" id="kobo.2833.1"> file in the editor and add the following lines of code to define the following outputs: (1) </span><strong class="source-inline"><span class="koboSpan" id="kobo.2834.1">attacker_vm_public_ip</span></strong><span class="koboSpan" id="kobo.2835.1">—public IP address value of the attacker VM instance, (2) </span><strong class="source-inline"><span class="koboSpan" id="kobo.2836.1">attacker_vm_access</span></strong><span class="koboSpan" id="kobo.2837.1">—URL used to access the desktop environment from </span><span class="No-Break"><span class="koboSpan" id="kobo.2838.1">the browser:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2839.1">
locals {
  kali_public_ip = google_compute_instance_from_machine_image.kali_vm.network_interface.0.access_config.0.nat_ip
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.2840.1">attacker_vm_public_ip</span></strong><span class="koboSpan" id="kobo.2841.1">" {
  value = local.kali_public_ip
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.2842.1">attacker_vm_access</span></strong><span class="koboSpan" id="kobo.2843.1">" {
  value = "http://${local.kali_public_ip}:8081/vnc.html"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2844.1">Make sure </span><a id="_idIndexMarker531"/><span class="koboSpan" id="kobo.2845.1">to save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2846.1">attacker_vm/outputs.tf</span></strong><span class="koboSpan" id="kobo.2847.1"> file </span><a id="_idIndexMarker532"/><span class="koboSpan" id="kobo.2848.1">before proceeding to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2849.1">next step.</span></span></p></li> <li><span class="koboSpan" id="kobo.2850.1">Navigate back to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2851.1">~/pentest_lab</span></strong><span class="koboSpan" id="kobo.2852.1"> project folder by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.2853.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2854.1">cd ~/pentest_lab</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2855.1">Let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2856.1">terraform init</span></strong><span class="koboSpan" id="kobo.2857.1"> command to reinitialize the Terraform working directory (since there are changes to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2858.1">attacker_vm</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2859.1">module code):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2860.1">terraform init</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2861.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2862.1">terraform plan</span></strong><span class="koboSpan" id="kobo.2863.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.2864.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2865.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2866.1">This should give us </span><strong class="bold"><span class="koboSpan" id="kobo.2867.1">Missing required argument — The argument “subnet_02” is required, but no definition was found</span></strong><span class="koboSpan" id="kobo.2868.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.2869.1">Missing required argument — The argument “my_public_ssh_key ” is required, but no definition was found</span></strong><span class="koboSpan" id="kobo.2870.1"> error messages since we have not provided any values for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2871.1">subnet_02</span></strong><span class="koboSpan" id="kobo.2872.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2873.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2874.1"> arguments while declaring the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2875.1">attacker_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2876.1"> module.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2877.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2878.1">If you’re wondering why this issue has suddenly occurred, it’s important to recall that we defined </span><strong class="source-inline"><span class="koboSpan" id="kobo.2879.1">subnet_02</span></strong><span class="koboSpan" id="kobo.2880.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2881.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2882.1"> variables in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2883.1">attacker_vm/variables.tf</span></strong><span class="koboSpan" id="kobo.2884.1"> file in an </span><span class="No-Break"><span class="koboSpan" id="kobo.2885.1">earlier step.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.2886.1">To resolve</span><a id="_idIndexMarker533"/><span class="koboSpan" id="kobo.2887.1"> the issue encountered in the</span><a id="_idIndexMarker534"/><span class="koboSpan" id="kobo.2888.1"> previous step, we need to ensure that we provide a value for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2889.1">subnet_02</span></strong><span class="koboSpan" id="kobo.2890.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2891.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2892.1"> arguments when declaring the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2893.1">attacker_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2894.1"> module.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.2895.1">Using </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2896.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2897.1">.36</span></em><span class="koboSpan" id="kobo.2898.1"> as a reference, we will resolve the issue by passing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2899.1">subnet_02</span></strong><span class="koboSpan" id="kobo.2900.1"> output value from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2901.1">secure_network</span></strong><span class="koboSpan" id="kobo.2902.1"> module to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2903.1">subnet_02</span></strong><span class="koboSpan" id="kobo.2904.1"> input variable of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2905.1">attacker_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2906.1"> module:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer101">
<span class="koboSpan" id="kobo.2907.1"><img alt="" src="image/B19755_04_36.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2908.1">Figure 4.36 – Providing a value for the subnet_02 and my_public_ssh_key arguments when declaring the attacker_vm module</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2909.1">At the same</span><a id="_idIndexMarker535"/><span class="koboSpan" id="kobo.2910.1"> time, we will pass </span><a id="_idIndexMarker536"/><span class="koboSpan" id="kobo.2911.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2912.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2913.1"> variable value to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2914.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2915.1"> input variable of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2916.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.2917.1"> module. </span><span class="koboSpan" id="kobo.2917.2">Now that we have a better idea of how we’ll solve the issue, let’s locate the following block of code in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.2918.1">main.tf</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2919.1">file (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2920.1">~/pentest_lab/main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2921.1">):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.2922.1">
module "attacker_vm" {
  source = "./attacker_vm"
}</span></pre>
<p class="list-inset"><span class="koboSpan" id="kobo.2923.1">Let’s replace this with the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.2924.1">of code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.2925.1">
module "attacker_vm" {
  source = "./attacker_vm"
  
  </span><strong class="bold"><span class="koboSpan" id="kobo.2926.1">subnet_02 = module.secure_network.subnet_02</span></strong><span class="koboSpan" id="kobo.2927.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.2928.1">my_public_ssh_key = var.my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2929.1">
}</span></pre>
<p class="list-inset"><span class="koboSpan" id="kobo.2930.1">Here, we are passing the output value from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2931.1">secure_network</span></strong><span class="koboSpan" id="kobo.2932.1"> module (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2933.1">module.secure_network.subnet_02</span></strong><span class="koboSpan" id="kobo.2934.1">) to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2935.1">subnet_02</span></strong><span class="koboSpan" id="kobo.2936.1"> input variable of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2937.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.2938.1"> module. </span><span class="koboSpan" id="kobo.2938.2">In addition to this, we are passing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2939.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2940.1"> variable value to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2941.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2942.1"> input variable of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2943.1">attacker_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2944.1"> module.</span></span></p></li>
</ol>
<ol>
<li value="12"><span class="koboSpan" id="kobo.2945.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2946.1">terraform plan</span></strong><span class="koboSpan" id="kobo.2947.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.2948.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2949.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2950.1">This time, we should not encounter a </span><strong class="bold"><span class="koboSpan" id="kobo.2951.1">Missing required argument</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2952.1">error message.</span></span></p></li> <li><span class="koboSpan" id="kobo.2953.1">Next, let’s </span><a id="_idIndexMarker537"/><span class="koboSpan" id="kobo.2954.1">use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2955.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2956.1"> command</span><a id="_idIndexMarker538"/><span class="koboSpan" id="kobo.2957.1"> to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.2958.1">the changes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2959.1">terraform apply -auto-approve</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2960.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2961.1">Wait for a minute or two for this step to complete. </span><span class="koboSpan" id="kobo.2961.2">Feel free to grab a cup of coffee or tea </span><span class="No-Break"><span class="koboSpan" id="kobo.2962.1">while waiting!</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.2963.1">Since we want to display the public IP address of the attacker VM instance along with the Kali Linux desktop environment access URL as output, we will reference and utilize the outputs from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2964.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.2965.1"> module (as well as the outputs from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2966.1">target_vm</span></strong><span class="koboSpan" id="kobo.2967.1"> module) in the root module </span><strong class="source-inline"><span class="koboSpan" id="kobo.2968.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.2969.1"> file (similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2970.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2971.1">.37</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2972.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer102">
<span class="koboSpan" id="kobo.2973.1"><img alt="" src="image/B19755_04_37.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2974.1">Figure 4.37 – Utilizing the outputs from the attacker_vm and target_vm modules</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2975.1">Using </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2976.1">Figure 4</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2977.1">.37</span></em><span class="koboSpan" id="kobo.2978.1"> as a </span><a id="_idIndexMarker539"/><span class="koboSpan" id="kobo.2979.1">reference, we </span><a id="_idIndexMarker540"/><span class="koboSpan" id="kobo.2980.1">will update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2981.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.2982.1"> file with the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.2983.1">of code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.2984.1">
output "</span><strong class="bold"><span class="koboSpan" id="kobo.2985.1">target_vm_username</span></strong><span class="koboSpan" id="kobo.2986.1">" {
  value = module.target_vm.target_vm_username
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.2987.1">target_vm_password</span></strong><span class="koboSpan" id="kobo.2988.1">" {
  value = module.target_vm.target_vm_password
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.2989.1">target_vm_private_ip</span></strong><span class="koboSpan" id="kobo.2990.1">" {
  value = module.target_vm.target_vm_private_ip
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.2991.1">target_vm_public_ip</span></strong><span class="koboSpan" id="kobo.2992.1">" {
  value = module.target_vm.target_vm_public_ip
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.2993.1">attacker_vm_public_ip</span></strong><span class="koboSpan" id="kobo.2994.1">" {
  value = module.attacker_vm.attacker_vm_public_ip
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.2995.1">attacker_vm_access</span></strong><span class="koboSpan" id="kobo.2996.1">" {
  value = module.attacker_vm.attacker_vm_access
}</span></pre>
<p class="list-inset"><span class="koboSpan" id="kobo.2997.1">Here, we’re </span><a id="_idIndexMarker541"/><span class="koboSpan" id="kobo.2998.1">defining the following </span><a id="_idIndexMarker542"/><span class="koboSpan" id="kobo.2999.1">outputs: (1) </span><strong class="source-inline"><span class="koboSpan" id="kobo.3000.1">target_vm_username</span></strong><span class="koboSpan" id="kobo.3001.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3002.1">target_vm_password</span></strong><span class="koboSpan" id="kobo.3003.1">—username and password used to access the target VM instance using the serial console, (2) </span><strong class="source-inline"><span class="koboSpan" id="kobo.3004.1">target_vm_public_ip</span></strong><span class="koboSpan" id="kobo.3005.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3006.1">target_vm_private_ip</span></strong><span class="koboSpan" id="kobo.3007.1">—public and private IP address values of the target VM instance, (3) </span><strong class="source-inline"><span class="koboSpan" id="kobo.3008.1">attacker_vm_public_ip</span></strong><span class="koboSpan" id="kobo.3009.1">—public IP address value of the attacker VM instance, (4) </span><strong class="source-inline"><span class="koboSpan" id="kobo.3010.1">attacker_vm_access</span></strong><span class="koboSpan" id="kobo.3011.1">—URL used to access the desktop environment from </span><span class="No-Break"><span class="koboSpan" id="kobo.3012.1">the browser.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3013.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3014.1">Make sure not to duplicate the output blocks defined in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3015.1">outputs.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3016.1"> file.</span></span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.3017.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.3018.1">terraform plan</span></strong><span class="koboSpan" id="kobo.3019.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.3020.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.3021.1">terraform plan</span></strong></pre></li> <li><span class="koboSpan" id="kobo.3022.1">Next, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3023.1">terraform apply</span></strong><span class="koboSpan" id="kobo.3024.1"> command to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.3025.1">the changes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.3026.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.3027.1">Wait for a </span><a id="_idIndexMarker543"/><span class="koboSpan" id="kobo.3028.1">minute or two for this</span><a id="_idIndexMarker544"/><span class="koboSpan" id="kobo.3029.1"> step to complete. </span><span class="koboSpan" id="kobo.3029.2">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.3030.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.3031.1">Outputs:
attacker_vm_access = "..."
</span><strong class="bold"><span class="koboSpan" id="kobo.3032.1">attacker_vm_public_ip</span></strong><span class="koboSpan" id="kobo.3033.1"> = "..."
</span><span class="koboSpan" id="kobo.3033.2">target_vm_password = "..."
</span><span class="koboSpan" id="kobo.3033.3">target_vm_private_ip = "..."
</span><span class="koboSpan" id="kobo.3033.4">target_vm_public_ip = "..."
</span><span class="koboSpan" id="kobo.3033.5">target_vm_username = "testuser"</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3034.1">Store and save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3035.1">attacker_vm_public_ip</span></strong><span class="koboSpan" id="kobo.3036.1"> output value in a text editor as we will use this in the succeeding steps in </span><span class="No-Break"><span class="koboSpan" id="kobo.3037.1">this chapter.</span></span></p></li> </ol>
<h2 id="_idParaDest-88"><a id="_idTextAnchor087"/><span class="koboSpan" id="kobo.3038.1">Part 3 of 3 – Accessing the Kali Linux desktop environment</span></h2>
<p><span class="koboSpan" id="kobo.3039.1">Follow </span><a id="_idIndexMarker545"/><span class="koboSpan" id="kobo.3040.1">the </span><span class="No-Break"><span class="koboSpan" id="kobo.3041.1">next steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.3042.1">At this point, we should have the following set </span><span class="No-Break"><span class="koboSpan" id="kobo.3043.1">up already:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer103">
<span class="koboSpan" id="kobo.3044.1"><img alt="" src="image/B19755_04_38.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3045.1">Figure 4.38 – Current setup deployed and configured in GCP</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.3046.1">Here, we</span><a id="_idIndexMarker546"/><span class="koboSpan" id="kobo.3047.1"> have the IP address of our local machine whitelisted to access the attacker VM instance in </span><strong class="bold"><span class="koboSpan" id="kobo.3048.1">VPC 02</span></strong><span class="koboSpan" id="kobo.3049.1"> via ports </span><strong class="source-inline"><span class="koboSpan" id="kobo.3050.1">22</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.3051.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3052.1">8081</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3053.1">.</span></span></p></li></ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3054.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3055.1">While we can further upgrade this setup to include additional security mechanisms (such as establishing a VPN connection), this should do the trick </span><span class="No-Break"><span class="koboSpan" id="kobo.3056.1">for now.</span></span></p>
<ol><li style="list-style-type:none"><p class="list-inset"><span class="koboSpan" id="kobo.3057.1">Now, let’s open a new browser tab and access the desktop environment using the </span><span class="No-Break"><span class="koboSpan" id="kobo.3058.1">following URL:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.3059.1">
http://</span><strong class="bold"><span class="koboSpan" id="kobo.3060.1">&lt;ATTACKER VM PUBLIC IP ADDRESS&gt;</span></strong><span class="koboSpan" id="kobo.3061.1">:8081/vnc.html</span></pre> <p class="list-inset"><span class="koboSpan" id="kobo.3062.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.3063.1">&lt;ATTACKER VM PUBLIC IP ADDRESS&gt;</span></strong><span class="koboSpan" id="kobo.3064.1"> with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3065.1">attacker_vm_public_ip</span></strong><span class="koboSpan" id="kobo.3066.1"> output value after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3067.1">terraform apply</span></strong><span class="koboSpan" id="kobo.3068.1"> command in an </span><span class="No-Break"><span class="koboSpan" id="kobo.3069.1">earlier step.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.3070.1">This should open a welcome screen with a </span><strong class="bold"><span class="koboSpan" id="kobo.3071.1">Connect</span></strong><span class="koboSpan" id="kobo.3072.1"> button, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3073.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3074.1">.39</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3075.1">:</span></span></p></li></ol>
<div>
<div class="IMG---Figure" id="_idContainer104">
<span class="koboSpan" id="kobo.3076.1"><img alt="" src="image/B19755_04_39.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3077.1">Figure 4.39 – noVNC welcome screen</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.3078.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3079.1">If you find yourself unable to access the welcome screen, it is possible that your IP address might have changed already. </span><span class="koboSpan" id="kobo.3079.2">Simply update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3080.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.3081.1"> file, then run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3082.1">terraform apply</span></strong><span class="koboSpan" id="kobo.3083.1"> command again to update the firewall rule to whitelist your new </span><span class="No-Break"><span class="koboSpan" id="kobo.3084.1">IP address.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.3085.1">Click </span><a id="_idIndexMarker547"/><span class="koboSpan" id="kobo.3086.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.3087.1">Connect</span></strong><span class="koboSpan" id="kobo.3088.1"> button and then use the password </span><strong class="source-inline"><span class="koboSpan" id="kobo.3089.1">kali123</span></strong><span class="koboSpan" id="kobo.3090.1"> (or use the password you specified in an earlier step) to access the desktop environment, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3091.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3092.1">.40</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3093.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer105">
<span class="koboSpan" id="kobo.3094.1"><img alt="" src="image/B19755_04_32.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3095.1">Figure 4.40 – Accessing the Kali Linux desktop/GUI environment in the browser</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.3096.1">Once we’re </span><a id="_idIndexMarker548"/><span class="koboSpan" id="kobo.3097.1">able to access the desktop environment, we should be able to perform various tasks and access the wide range of tools and utilities available in Kali Linux (similar to how we would use it on our </span><span class="No-Break"><span class="koboSpan" id="kobo.3098.1">local machine).</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3099.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3100.1">Note that you may use the </span><strong class="bold"><span class="koboSpan" id="kobo.3101.1">Connectivity Tests</span></strong><span class="koboSpan" id="kobo.3102.1"> diagnostic tool</span><a id="_idIndexMarker549"/><span class="koboSpan" id="kobo.3103.1"> to validate network connectivity. </span><span class="koboSpan" id="kobo.3103.2">For more information, feel free to check the following </span><span class="No-Break"><span class="koboSpan" id="kobo.3104.1">link: </span></span><a href="https://cloud.google.com/network-intelligence-center/docs/connectivity-tests/how-to/running-connectivity-tests"><span class="No-Break"><span class="koboSpan" id="kobo.3105.1">https://cloud.google.com/network-intelligence-center/docs/connectivity-tests/how-to/running-connectivity-tests</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3106.1">.</span></span></p>
<h1 id="_idParaDest-89"><a id="_idTextAnchor088"/><span class="koboSpan" id="kobo.3107.1">Simulating penetration testing in an isolated network environment</span></h1>
<p><span class="koboSpan" id="kobo.3108.1">Given</span><a id="_idIndexMarker550"/><span class="koboSpan" id="kobo.3109.1"> that our lab </span><a id="_idIndexMarker551"/><span class="koboSpan" id="kobo.3110.1">environment in GCP has been set up, we can now proceed with having a penetration testing simulation to verify that everything has been configured correctly. </span><span class="koboSpan" id="kobo.3110.2">Of course, we will work with a simplified penetration testing process, as our primary goal is to assess whether the penetration testing lab environment has been set up and </span><span class="No-Break"><span class="koboSpan" id="kobo.3111.1">configured correctly:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer106">
<span class="koboSpan" id="kobo.3112.1"><img alt="" src="image/B19755_04_41.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3113.1">Figure 4.41 – Penetration testing simulation</span></p>
<p><span class="koboSpan" id="kobo.3114.1">Our</span><a id="_idIndexMarker552"/><span class="koboSpan" id="kobo.3115.1"> simulation will start with a</span><a id="_idIndexMarker553"/><span class="koboSpan" id="kobo.3116.1"> port scan to check the open ports of the target VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.3117.1">vm-target</span></strong><span class="koboSpan" id="kobo.3118.1">). </span><span class="koboSpan" id="kobo.3118.2">After identifying that port </span><strong class="source-inline"><span class="koboSpan" id="kobo.3119.1">80</span></strong><span class="koboSpan" id="kobo.3120.1"> is open, we will use a web browser to navigate through the pages and explore the functionality of the vulnerable web application (running inside a container) accessible on the said port. </span><span class="koboSpan" id="kobo.3120.2">We’ll end the simulation right after we have used an SQL Injection attack to gain administrator access and successfully signed in using an </span><span class="No-Break"><span class="koboSpan" id="kobo.3121.1">administrator’s account.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.3122.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3123.1">It is unethical and illegal to attack cloud resources owned by another user or company. </span><span class="koboSpan" id="kobo.3123.2">Before proceeding, make sure to read the </span><em class="italic"><span class="koboSpan" id="kobo.3124.1">Examining considerations when building penetration testing lab environments in the cloud</span></em><span class="koboSpan" id="kobo.3125.1"> section of </span><span class="No-Break"><em class="italic"><a href="B19755_01.xhtml"><span class="koboSpan" id="kobo.3126.1">Chapter 1</span></a></em></span><span class="koboSpan" id="kobo.3127.1">, </span><em class="italic"><span class="koboSpan" id="kobo.3128.1">Getting Started with Penetration Testing Labs in the Cloud</span></em><span class="koboSpan" id="kobo.3129.1">, since we will be simulating the attack process to validate if misconfigurations and vulnerabilities present in applications and services running in the target VM instance </span><span class="No-Break"><span class="koboSpan" id="kobo.3130.1">are exploitable.</span></span></p>
<p><span class="koboSpan" id="kobo.3131.1">That said, let’s </span><a id="_idIndexMarker554"/><span class="koboSpan" id="kobo.3132.1">start the penetration</span><a id="_idIndexMarker555"/><span class="koboSpan" id="kobo.3133.1"> testing simulation. </span><span class="koboSpan" id="kobo.3133.2">Proceed </span><span class="No-Break"><span class="koboSpan" id="kobo.3134.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.3135.1">Continuing where we left off in the previous section, let’s access the Terminal application by selecting the </span><strong class="bold"><span class="koboSpan" id="kobo.3136.1">Terminal</span></strong><span class="koboSpan" id="kobo.3137.1"> icon located in the upper-left corner of the Kali Linux </span><span class="No-Break"><span class="koboSpan" id="kobo.3138.1">desktop interface.</span></span></li>
<li><span class="koboSpan" id="kobo.3139.1">In the terminal window, run the following command (after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3140.1">$</span></strong><span class="koboSpan" id="kobo.3141.1"> sign) to store the private IP address value of the target VM instance in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3142.1">TARGET_IP</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3143.1"> variable:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3144.1">
TARGET_IP=</span><strong class="bold"><span class="koboSpan" id="kobo.3145.1">&lt;PRIVATE IP ADDRESS OF TARGET VM&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.3146.1">Make sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.3147.1">&lt;PRIVATE IP ADDRESS OF TARGET VM&gt;</span></strong><span class="koboSpan" id="kobo.3148.1"> with the private IP address of the target VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.3149.1">vm-target</span></strong><span class="koboSpan" id="kobo.3150.1">). </span><span class="koboSpan" id="kobo.3150.2">Using a private IP ensures that the request stays within the intended network environment. </span><span class="koboSpan" id="kobo.3150.3">In addition to this, we won’t be able to access the target VM instance using its public IP address. </span><span class="koboSpan" id="kobo.3150.4">That’s because the network environment is not configured to allow outside traffic to reach </span><strong class="bold"><span class="koboSpan" id="kobo.3151.1">VPC 01</span></strong><span class="koboSpan" id="kobo.3152.1"> where the target VM instance is launched, even if the network traffic came from another cloud resource running inside </span><strong class="bold"><span class="koboSpan" id="kobo.3153.1">VPC 01</span></strong><span class="koboSpan" id="kobo.3154.1"> and </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.3155.1">VPC 02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3156.1">.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3157.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3158.1">Since the CIDR range of the subnet where the target VM instance is launched is </span><strong class="source-inline"><span class="koboSpan" id="kobo.3159.1">10.1.0.0/20</span></strong><span class="koboSpan" id="kobo.3160.1">, the target IP address of the VM instance should fall within the range of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3161.1">10.1.0.0</span></strong><span class="koboSpan" id="kobo.3162.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.3163.1">10.1.15.255</span></strong><span class="koboSpan" id="kobo.3164.1"> (excluding the reserved IP addresses). </span><span class="koboSpan" id="kobo.3164.2">For more information, feel free to check the following </span><span class="No-Break"><span class="koboSpan" id="kobo.3165.1">link: </span></span><a href="https://cloud.google.com/vpc/docs/subnets"><span class="No-Break"><span class="koboSpan" id="kobo.3166.1">https://cloud.google.com/vpc/docs/subnets</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3167.1">.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.3168.1">Now, let’s use </span><strong class="source-inline"><span class="koboSpan" id="kobo.3169.1">nmap</span></strong><span class="koboSpan" id="kobo.3170.1"> to scan the top </span><strong class="source-inline"><span class="koboSpan" id="kobo.3171.1">1000</span></strong><span class="koboSpan" id="kobo.3172.1"> ports of the target </span><span class="No-Break"><span class="koboSpan" id="kobo.3173.1">VM instance:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.3174.1">nmap --top-ports 1000 $TARGET_IP</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.3175.1">This should provide information about the open ports and the corresponding services running on the target VM instance. </span><span class="koboSpan" id="kobo.3175.2">It allows us to identify which ports are accessible and potentially vulnerable to attacks, such as SSH (port </span><strong class="source-inline"><span class="koboSpan" id="kobo.3176.1">22</span></strong><span class="koboSpan" id="kobo.3177.1">) and HTTP (port </span><strong class="source-inline"><span class="koboSpan" id="kobo.3178.1">80</span></strong><span class="koboSpan" id="kobo.3179.1">), similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3180.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3181.1">.42</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3182.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer107">
<span class="koboSpan" id="kobo.3183.1"><img alt="" src="image/B19755_04_42.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3184.1">Figure 4.42 – Results of the nmap scan</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.3185.1">Depending</span><a id="_idIndexMarker556"/><span class="koboSpan" id="kobo.3186.1"> on the</span><a id="_idIndexMarker557"/><span class="koboSpan" id="kobo.3187.1"> results of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3188.1">nmap</span></strong><span class="koboSpan" id="kobo.3189.1"> scan, further steps can be performed to evaluate the open ports and services running on the target VM instance. </span><span class="koboSpan" id="kobo.3189.2">However, for now, we will skip these steps and proceed with the other aspects of the penetration </span><span class="No-Break"><span class="koboSpan" id="kobo.3190.1">testing process.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3191.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3192.1">If you’re wondering </span><a id="_idIndexMarker558"/><span class="koboSpan" id="kobo.3193.1">what </span><strong class="source-inline"><span class="koboSpan" id="kobo.3194.1">nmap</span></strong><span class="koboSpan" id="kobo.3195.1"> is, it is a popular open source network scanning tool designed to discover hosts and services on a computer network by sending packets and analyzing the responses. </span><span class="koboSpan" id="kobo.3195.2">With </span><strong class="source-inline"><span class="koboSpan" id="kobo.3196.1">nmap</span></strong><span class="koboSpan" id="kobo.3197.1">, we can perform</span><a id="_idIndexMarker559"/><span class="koboSpan" id="kobo.3198.1"> tasks such as </span><strong class="bold"><span class="koboSpan" id="kobo.3199.1">host discovery</span></strong><span class="koboSpan" id="kobo.3200.1"> (to identify active hosts within a network), </span><strong class="bold"><span class="koboSpan" id="kobo.3201.1">port scanning</span></strong><span class="koboSpan" id="kobo.3202.1"> (for</span><a id="_idIndexMarker560"/><span class="koboSpan" id="kobo.3203.1"> identifying potential entry points or services running on specific ports), </span><strong class="bold"><span class="koboSpan" id="kobo.3204.1">OS detection</span></strong><span class="koboSpan" id="kobo.3205.1"> (to</span><a id="_idIndexMarker561"/><span class="koboSpan" id="kobo.3206.1"> gather information about the operating system running on a target host), and </span><strong class="bold"><span class="koboSpan" id="kobo.3207.1">service enumeration</span></strong><span class="koboSpan" id="kobo.3208.1"> (to </span><a id="_idIndexMarker562"/><span class="koboSpan" id="kobo.3209.1">gather details about specific services running on open ports). </span><span class="koboSpan" id="kobo.3209.2">In addition</span><a id="_idIndexMarker563"/><span class="koboSpan" id="kobo.3210.1"> to these, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3211.1">nmap</span></strong><span class="koboSpan" id="kobo.3212.1"> provides </span><a id="_idIndexMarker564"/><span class="koboSpan" id="kobo.3213.1">other advanced features and</span><a id="_idIndexMarker565"/><span class="koboSpan" id="kobo.3214.1"> capabilities such as </span><strong class="bold"><span class="koboSpan" id="kobo.3215.1">script scanning</span></strong><span class="koboSpan" id="kobo.3216.1"> (to automate specific tasks), </span><strong class="bold"><span class="koboSpan" id="kobo.3217.1">version detection</span></strong><span class="koboSpan" id="kobo.3218.1"> (to identify specific software versions running on target systems), </span><strong class="bold"><span class="koboSpan" id="kobo.3219.1">stealth scanning</span></strong><span class="koboSpan" id="kobo.3220.1"> (to evade </span><a id="_idIndexMarker566"/><span class="koboSpan" id="kobo.3221.1">detection), and </span><strong class="bold"><span class="koboSpan" id="kobo.3222.1">timing and performance tuning</span></strong><span class="koboSpan" id="kobo.3223.1"> (to optimize scan speed and accuracy). </span><em class="italic"><span class="koboSpan" id="kobo.3224.1">Powerful, right?</span></em><span class="koboSpan" id="kobo.3225.1"> When</span><a id="_idIndexMarker567"/><span class="koboSpan" id="kobo.3226.1"> using </span><strong class="source-inline"><span class="koboSpan" id="kobo.3227.1">nmap</span></strong><span class="koboSpan" id="kobo.3228.1"> in conjunction with other penetration testing tools, it is important to exercise extreme caution as it can generate significant network traffic and potentially trigger security alerts or disrupt network operations if not used responsibly. </span><span class="koboSpan" id="kobo.3228.2">It is advisable to follow ethical hacking practices, obtain necessary permissions, and employ proper filtering mechanisms to minimize any unintended consequences while performing comprehensive </span><span class="No-Break"><span class="koboSpan" id="kobo.3229.1">security assessments.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.3230.1">You</span><a id="_idIndexMarker568"/><span class="koboSpan" id="kobo.3231.1"> can now close</span><a id="_idIndexMarker569"/><span class="koboSpan" id="kobo.3232.1"> the </span><span class="No-Break"><span class="koboSpan" id="kobo.3233.1">terminal window.</span></span></li>
<li><span class="koboSpan" id="kobo.3234.1">Now, let’s check what’s running on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.3235.1">80</span></strong><span class="koboSpan" id="kobo.3236.1"> of the target VM instance. </span><span class="koboSpan" id="kobo.3236.2">Launch the </span><strong class="bold"><span class="koboSpan" id="kobo.3237.1">Firefox</span></strong><span class="koboSpan" id="kobo.3238.1"> browser by selecting the </span><strong class="bold"><span class="koboSpan" id="kobo.3239.1">Firefox</span></strong><span class="koboSpan" id="kobo.3240.1"> icon located in the top-left corner of the desktop interface. </span><span class="koboSpan" id="kobo.3240.2">Navigate to the </span><span class="No-Break"><span class="koboSpan" id="kobo.3241.1">following URL:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3242.1">
http://</span><strong class="bold"><span class="koboSpan" id="kobo.3243.1">&lt;PRIVATE IP ADDRESS OF TARGET VM&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.3244.1">This should open the OWASP Juice Shop vulnerable-by-design web application, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3245.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3246.1">.43</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3247.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer108">
<span class="koboSpan" id="kobo.3248.1"><img alt="" src="image/B19755_04_43.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3249.1">Figure 4.43 – Accessing the target instance from a browser running in the attacker instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.3250.1">Here, we </span><a id="_idIndexMarker570"/><span class="koboSpan" id="kobo.3251.1">have the OWASP</span><a id="_idIndexMarker571"/><span class="koboSpan" id="kobo.3252.1"> Juice Shop—a vulnerable-by-design application with various challenges and vulnerabilities meant to help security practitioners and engineers understand and learn about common </span><span class="No-Break"><span class="koboSpan" id="kobo.3253.1">security flaws.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3254.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3255.1">Please remember to use the private IP address of the target VM instance (instead of the public IP address), as our </span><strong class="bold"><span class="koboSpan" id="kobo.3256.1">VPC 01</span></strong><span class="koboSpan" id="kobo.3257.1"> network has been specifically configured to allow traffic only from resources within </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.3258.1">VPC 02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3259.1">.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.3260.1">For the next few minutes, explore the functionality and content of the OWASP Juice Shop application by navigating through the different pages and features. </span><span class="koboSpan" id="kobo.3260.2">Feel free to interact with the forms, buttons, and links within the application to understand their behavior </span><span class="No-Break"><span class="koboSpan" id="kobo.3261.1">and purpose.</span></span></li>
<li><span class="koboSpan" id="kobo.3262.1">Now, let’s </span><a id="_idIndexMarker572"/><span class="koboSpan" id="kobo.3263.1">navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.3264.1">Login</span></strong><span class="koboSpan" id="kobo.3265.1"> page by opening the </span><strong class="bold"><span class="koboSpan" id="kobo.3266.1">Account</span></strong><span class="koboSpan" id="kobo.3267.1"> menu located in the upper-left corner </span><a id="_idIndexMarker573"/><span class="koboSpan" id="kobo.3268.1">of the page and then clicking </span><strong class="bold"><span class="koboSpan" id="kobo.3269.1">Login</span></strong><span class="koboSpan" id="kobo.3270.1">. </span><span class="koboSpan" id="kobo.3270.2">This will redirect us to the </span><strong class="bold"><span class="koboSpan" id="kobo.3271.1">Login</span></strong><span class="koboSpan" id="kobo.3272.1"> page, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3273.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3274.1">.44</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3275.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer109">
<span class="koboSpan" id="kobo.3276.1"><img alt="" src="image/B19755_04_44.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3277.1">Figure 4.44 – OWASP Juice Shop Login page</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.3278.1">Here, we</span><a id="_idIndexMarker574"/><span class="koboSpan" id="kobo.3279.1"> have a login </span><a id="_idIndexMarker575"/><span class="koboSpan" id="kobo.3280.1">form allowing us to specify an email address value and a password value. </span><span class="koboSpan" id="kobo.3280.2">By analyzing the login process and attempting various techniques, we should be able to identify and exploit any vulnerabilities present in the </span><span class="No-Break"><span class="koboSpan" id="kobo.3281.1">login functionality.</span></span></p></li>
</ol>
<ol>
<li value="8"><span class="koboSpan" id="kobo.3282.1">Let’s try performing an SQL Injection attack! </span><span class="koboSpan" id="kobo.3282.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.3283.1">' or 1=1--</span></strong><span class="koboSpan" id="kobo.3284.1"> in the </span><strong class="bold"><span class="koboSpan" id="kobo.3285.1">Email</span></strong><span class="koboSpan" id="kobo.3286.1"> field. </span><span class="koboSpan" id="kobo.3286.2">After that, type </span><strong class="source-inline"><span class="koboSpan" id="kobo.3287.1">123</span></strong><span class="koboSpan" id="kobo.3288.1"> (or any combination of characters) in the </span><strong class="bold"><span class="koboSpan" id="kobo.3289.1">Password</span></strong><span class="koboSpan" id="kobo.3290.1"> field. </span><span class="koboSpan" id="kobo.3290.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.3291.1">Log in</span></strong><span class="koboSpan" id="kobo.3292.1"> button afterward. </span><span class="koboSpan" id="kobo.3292.2">This should give us a success notification similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3293.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3294.1">.45</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3295.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer110">
<span class="koboSpan" id="kobo.3296.1"><img alt="" src="image/B19755_04_45.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3297.1">Figure 4.45 – Successfully solving a challenge using an SQL Injection attack</span></p>
<p class="list-inset"><em class="italic"><span class="koboSpan" id="kobo.3298.1">Looks like we were able to successfully sign in with the administrator’s user account!</span></em> <em class="italic"><span class="koboSpan" id="kobo.3299.1">What just happened?</span></em><span class="koboSpan" id="kobo.3300.1"> Here, our SQL Injection attack allowed us to authenticate </span><a id="_idIndexMarker576"/><span class="koboSpan" id="kobo.3301.1">using the</span><a id="_idIndexMarker577"/><span class="koboSpan" id="kobo.3302.1"> first record in the table containing the registered application users (or accounts). </span><span class="koboSpan" id="kobo.3302.2">Luckily for us, this record happened to be an administrator account (</span><strong class="source-inline"><span class="koboSpan" id="kobo.3303.1">admin@juice-sh.op</span></strong><span class="koboSpan" id="kobo.3304.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.3305.1">as well!</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.3306.1">If you are wondering what</span><a id="_idIndexMarker578"/><span class="koboSpan" id="kobo.3307.1"> an </span><strong class="bold"><span class="koboSpan" id="kobo.3308.1">SQL Injection attack</span></strong><span class="koboSpan" id="kobo.3309.1"> is, it is a technique where an attacker exploits vulnerabilities in an application’s input fields to inject malicious SQL statements. </span><span class="koboSpan" id="kobo.3309.2">In this specific case, by entering </span><strong class="source-inline"><span class="koboSpan" id="kobo.3310.1">' or 1=1--</span></strong><span class="koboSpan" id="kobo.3311.1"> in the </span><strong class="bold"><span class="koboSpan" id="kobo.3312.1">Email</span></strong><span class="koboSpan" id="kobo.3313.1"> field, the updated SQL query executed by the application’s backend might look </span><span class="No-Break"><span class="koboSpan" id="kobo.3314.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.3315.1">
SELECT * FROM users WHERE email = '</span><strong class="bold"><span class="koboSpan" id="kobo.3316.1">' or 1=1--</span></strong><span class="koboSpan" id="kobo.3317.1">' AND password = '123';</span></pre> <p class="list-inset"><span class="koboSpan" id="kobo.3318.1">The injected </span><a id="_idIndexMarker579"/><span class="koboSpan" id="kobo.3319.1">portion causes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3320.1">WHERE</span></strong><span class="koboSpan" id="kobo.3321.1"> condition to always evaluate to </span><strong class="source-inline"><span class="koboSpan" id="kobo.3322.1">true</span></strong><span class="koboSpan" id="kobo.3323.1">—bypassing the</span><a id="_idIndexMarker580"/><span class="koboSpan" id="kobo.3324.1"> need for a valid email address and password. </span><span class="koboSpan" id="kobo.3324.2">This allowed us to log in without having to provide legitimate credentials. </span><strong class="source-inline"><span class="koboSpan" id="kobo.3325.1">--</span></strong><span class="koboSpan" id="kobo.3326.1"> at the end is used to comment out the remainder of the original query to ensure that the injected code does not cause any </span><span class="No-Break"><span class="koboSpan" id="kobo.3327.1">syntax errors.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3328.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3329.1">We have intentionally skipped some steps as we’ve used a simplified penetration testing process validating our lab configuration and setup. </span><span class="koboSpan" id="kobo.3329.2">That said, real-world penetration testing involves a more comprehensive and structured approach that includes various techniques, tools, and methodologies to thoroughly assess the security of an application or </span><span class="No-Break"><span class="koboSpan" id="kobo.3330.1">a system.</span></span></p>
<p><span class="koboSpan" id="kobo.3331.1">While our relatively simple SQL Injection example demonstrates a common attack technique, it’s important to note that various other attacks and techniques can be performed in our penetration testing lab environment. </span><span class="koboSpan" id="kobo.3331.2">Feel free to explore and experiment further with the OWASP Juice Shop application before cleaning up the lab environment we prepared in </span><span class="No-Break"><span class="koboSpan" id="kobo.3332.1">this chapter.</span></span></p>
<h1 id="_idParaDest-90"><a id="_idTextAnchor089"/><span class="koboSpan" id="kobo.3333.1">Cleaning up</span></h1>
<p><span class="koboSpan" id="kobo.3334.1">Cleaning up the cloud resources</span><a id="_idIndexMarker581"/><span class="koboSpan" id="kobo.3335.1"> we created or deployed is a crucial step when working with vulnerable cloud applications and environments. </span><span class="koboSpan" id="kobo.3335.2">If we don’t clean up and delete the resources we created right away, we might end up paying for unused cloud resources. </span><span class="koboSpan" id="kobo.3335.3">In addition to this, these cloud resources may end up being attacked by malicious users as well. </span><span class="koboSpan" id="kobo.3335.4">At a </span><em class="italic"><span class="koboSpan" id="kobo.3336.1">minimum</span></em><span class="koboSpan" id="kobo.3337.1">, we will be paying for the time the following resources </span><span class="No-Break"><span class="koboSpan" id="kobo.3338.1">are running:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.3339.1">1 x </span><strong class="source-inline"><span class="koboSpan" id="kobo.3340.1">e2-medium</span></strong><span class="koboSpan" id="kobo.3341.1"> VM instance for the </span><span class="No-Break"><span class="koboSpan" id="kobo.3342.1">attacker machine</span></span></li>
<li><span class="koboSpan" id="kobo.3343.1">1 x </span><strong class="source-inline"><span class="koboSpan" id="kobo.3344.1">f1-micro</span></strong><span class="koboSpan" id="kobo.3345.1"> VM instance for the </span><span class="No-Break"><span class="koboSpan" id="kobo.3346.1">target machine</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.3347.1">Please be aware that there are</span><a id="_idIndexMarker582"/><span class="koboSpan" id="kobo.3348.1"> other costs we have to take into account as well—including data transfer fees, storage costs for persistent data used by instances, potential charges for other services utilized in the account, and any applicable taxes or fees associated with </span><span class="No-Break"><span class="koboSpan" id="kobo.3349.1">using resources.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.3350.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3351.1">Since the overall cost when running these resources depends on several parameters, it is best to refer to the pricing documentation page provided by the cloud platform, found here: </span><a href="https://cloud.google.com/compute/vm-instance-pricing"><span class="koboSpan" id="kobo.3352.1">https://cloud.google.com/compute/vm-instance-pricing</span></a><span class="koboSpan" id="kobo.3353.1">. </span><span class="koboSpan" id="kobo.3353.2">You can also utilize the </span><strong class="bold"><span class="koboSpan" id="kobo.3354.1">Google Cloud Pricing Calculator</span></strong><span class="koboSpan" id="kobo.3355.1"> to </span><a id="_idIndexMarker583"/><span class="koboSpan" id="kobo.3356.1">estimate the cost of deploying resources on GCP. </span><span class="koboSpan" id="kobo.3356.2">You can access the Google Cloud Pricing Calculator using the following </span><span class="No-Break"><span class="koboSpan" id="kobo.3357.1">link: </span></span><a href="https://cloud.google.com/products/calculator"><span class="No-Break"><span class="koboSpan" id="kobo.3358.1">https://cloud.google.com/products/calculator</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3359.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.3360.1">That said, let’s proceed with deleting the resources we created in this chapter, </span><span class="No-Break"><span class="koboSpan" id="kobo.3361.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.3362.1">Close the browser tab we used to access the Kali Linux </span><span class="No-Break"><span class="koboSpan" id="kobo.3363.1">desktop environment.</span></span></li>
<li><span class="koboSpan" id="kobo.3364.1">In the Cloud Shell terminal, navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3365.1">~/pentest_lab</span></strong><span class="koboSpan" id="kobo.3366.1"> directory and then use </span><strong class="source-inline"><span class="koboSpan" id="kobo.3367.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.3368.1"> to clean up the resources we </span><span class="No-Break"><span class="koboSpan" id="kobo.3369.1">created earlier:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.3370.1">cd ~/pentest_lab</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.3371.1">terraform destroy -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.3372.1">Feel free to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3373.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.3374.1"> command again in case there are some resources that fail to delete. </span><span class="koboSpan" id="kobo.3374.2">Alternatively, you may delete resources manually using the user interface if all </span><span class="No-Break"><span class="koboSpan" id="kobo.3375.1">else fails.</span></span></p></li> <li><span class="koboSpan" id="kobo.3376.1">Verify that the resources have been destroyed successfully using the </span><span class="No-Break"><span class="koboSpan" id="kobo.3377.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.3378.1">terraform show</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.3379.1">This should</span><a id="_idIndexMarker584"/><span class="koboSpan" id="kobo.3380.1"> return an empty response since all resources should have been </span><span class="No-Break"><span class="koboSpan" id="kobo.3381.1">deleted successfully.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3382.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3383.1">Feel free to perform a full audit of your account using the Google Cloud console. </span><span class="koboSpan" id="kobo.3383.2">This will help ensure that all resources have been properly deleted, minimize the risk of unintended costs, and address any potential </span><span class="No-Break"><span class="koboSpan" id="kobo.3384.1">security concerns.</span></span></p>
<p><span class="koboSpan" id="kobo.3385.1">That’s pretty much it! </span><span class="koboSpan" id="kobo.3385.2">At this point, we should have a good idea of how to prepare penetration testing lab environments </span><span class="No-Break"><span class="koboSpan" id="kobo.3386.1">on GCP.</span></span></p>
<h1 id="_idParaDest-91"><a id="_idTextAnchor090"/><span class="koboSpan" id="kobo.3387.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.3388.1">In this chapter, we were able to successfully build a penetration testing lab in GCP. </span><span class="koboSpan" id="kobo.3388.2">We started by preparing the prerequisites, along with defining the project structure of the Terraform code for automating the lab environment. </span><span class="koboSpan" id="kobo.3388.3">We then set up an isolated network for securing the lab environment resources from external attacks. </span><span class="koboSpan" id="kobo.3388.4">Inside this isolated network, we launched a target VM instance running the OWASP Juice Shop application (inside a container). </span><span class="koboSpan" id="kobo.3388.5">After that, we imported the Kali Linux Generic Cloud Image into our Google Cloud account. </span><span class="koboSpan" id="kobo.3388.6">Using the imported image, we proceeded with the setup of the attacker VM instance inside the network environment. </span><span class="koboSpan" id="kobo.3388.7">After completing the lab environment, we performed a simplified penetration testing simulation to verify that our lab had been (</span><span class="No-Break"><span class="koboSpan" id="kobo.3389.1">mis)configured correctly.</span></span></p>
<p><span class="koboSpan" id="kobo.3390.1">In the upcoming chapter, our focus will shift toward setting up a penetration testing lab in Microsoft Azure. </span><span class="koboSpan" id="kobo.3390.2">We will set up a lab environment where we can practice container breakout techniques for gaining authorized access to the host system (where the container is running). </span><span class="koboSpan" id="kobo.3390.3">Our lab setup will also highlight how managed identities can be misused to access other resources in the cloud environment. </span><span class="koboSpan" id="kobo.3390.4">If you are excited to learn how to build penetration testing labs in Azure, then the next chapter is </span><span class="No-Break"><span class="koboSpan" id="kobo.3391.1">for you!</span></span></p>
<h1 id="_idParaDest-92"><a id="_idTextAnchor091"/><span class="koboSpan" id="kobo.3392.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.3393.1">For additional information on the topics covered in this chapter, you may find the following </span><span class="No-Break"><span class="koboSpan" id="kobo.3394.1">resources helpful:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.3395.1">Google Cloud – Guide to Cloud Billing Resource Organization &amp; Access </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3396.1">Management</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3397.1"> (</span></span><a href="https://cloud.google.com/billing/docs/onboarding-checklist"><span class="No-Break"><span class="koboSpan" id="kobo.3398.1">https://cloud.google.com/billing/docs/onboarding-checklist</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3399.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3400.1">Integrate Azure services with virtual networks for network </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3401.1">isolation</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3402.1"> (</span></span><a href="https://learn.microsoft.com/en-us/azure/virtual-network/vnet-integration-for-azure-services"><span class="No-Break"><span class="koboSpan" id="kobo.3403.1">https://learn.microsoft.com/en-us/azure/virtual-network/vnet-integration-for-azure-services</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3404.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3405.1">Google Cloud – Best practices and reference architectures for VPC </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3406.1">design</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3407.1"> (</span></span><a href="https://cloud.google.com/architecture/best-practices-vpc-design"><span class="No-Break"><span class="koboSpan" id="kobo.3408.1">https://cloud.google.com/architecture/best-practices-vpc-design</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3409.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3410.1">Kali Linux – </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3411.1">Cloud</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3412.1"> (</span></span><a href="https://www.kali.org/docs/cloud/"><span class="No-Break"><span class="koboSpan" id="kobo.3413.1">https://www.kali.org/docs/cloud/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3414.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3415.1">Kali Linux – What is Kali </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3416.1">Linux?</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3417.1"> (</span></span><a href="https://www.kali.org/docs/introduction/what-is-kali-linux/"><span class="No-Break"><span class="koboSpan" id="kobo.3418.1">https://www.kali.org/docs/introduction/what-is-kali-linux/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3419.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3420.1">Google Cloud – Manually import boot </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3421.1">disks</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3422.1"> (</span></span><a href="https://cloud.google.com/compute/docs/import/import-existing-image"><span class="No-Break"><span class="koboSpan" id="kobo.3423.1">https://cloud.google.com/compute/docs/import/import-existing-image</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3424.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3425.1">OWASP Juice Shop: Probably the most modern and sophisticated insecure web </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3426.1">application</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3427.1"> (</span></span><a href="https://github.com/juice-shop/juice-shop"><span class="No-Break"><span class="koboSpan" id="kobo.3428.1">https://github.com/juice-shop/juice-shop</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3429.1">)</span></span></li>
</ul>
</div>
</body></html>