<html><head></head><body>
<div id="_idContainer156">
<h1 class="chapter-number" id="_idParaDest-93"><a id="_idTextAnchor092"/><span class="koboSpan" id="kobo.1.1">5</span></h1>
<h1 id="_idParaDest-94"><a id="_idTextAnchor093"/><span class="koboSpan" id="kobo.2.1">Setting Up Isolated Penetration Testing Lab Environments on Azure</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In the previous chapter, we successfully built and automated a relatively simple penetration testing lab inside an isolated network environment in </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">Google Cloud Platform</span></strong><span class="koboSpan" id="kobo.5.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.6.1">GCP</span></strong><span class="koboSpan" id="kobo.7.1">). </span><span class="koboSpan" id="kobo.7.2">We primarily focused on one of the most important aspects when building lab environments in the cloud – protecting the vulnerable lab resources from the </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">outside world.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">In this chapter, we will take things a step further and build a more intricate lab environment using various services in </span><strong class="bold"><span class="koboSpan" id="kobo.10.1">Microsoft Azure</span></strong><span class="koboSpan" id="kobo.11.1">. </span><span class="koboSpan" id="kobo.11.2">Our lab setup in this chapter will help us practice </span><strong class="bold"><span class="koboSpan" id="kobo.12.1">container breakout</span></strong><span class="koboSpan" id="kobo.13.1"> techniques, which involve escaping from a Docker container environment to gain unauthorized access to the host system. </span><span class="koboSpan" id="kobo.13.2">With containers being a fundamental component in modern deployments, understanding their security vulnerabilities is critical for ensuring the security of cloud-based applications. </span><span class="koboSpan" id="kobo.13.3">In addition to this, we will look at how </span><strong class="bold"><span class="koboSpan" id="kobo.14.1">managed identities</span></strong><span class="koboSpan" id="kobo.15.1"> in Azure can be abused to gain unauthorized access to other cloud resources. </span><span class="koboSpan" id="kobo.15.2">While managed identities are effective for preventing credential exposure, they introduce a new problem as these set up other attack paths that can be abused by an attacker (or someone assuming the role of </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">an attacker).</span></span></p>
<p><span class="koboSpan" id="kobo.17.1">After setting up the lab environment, we will validate if our vulnerable-by-design lab environment has been (mis)configured correctly by performing a simplified penetration testing simulation using various tools, such as </span><strong class="bold"><span class="koboSpan" id="kobo.18.1">Nmap</span></strong><span class="koboSpan" id="kobo.19.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.20.1">Metasploit</span></strong><span class="koboSpan" id="kobo.21.1">. </span><span class="koboSpan" id="kobo.21.2">In our simulation, we will go through a sequence of steps showing how multiple vulnerabilities and misconfigurations can be exploited to gain unauthorized access to cloud resources containing sensitive credentials </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">and information.</span></span></p>
<p><span class="koboSpan" id="kobo.23.1">We will cover the following topics in </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.25.1">Preparing the necessary components </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">and prerequisites</span></span></li>
<li><span class="koboSpan" id="kobo.27.1">Defining the </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">project’s structure</span></span></li>
<li><span class="koboSpan" id="kobo.29.1">Preparing the </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">isolated network</span></span></li>
<li><span class="koboSpan" id="kobo.31.1">Setting up the </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">target resources</span></span></li>
<li><span class="koboSpan" id="kobo.33.1">Manually setting up the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">VM instance</span></span></li>
<li><span class="koboSpan" id="kobo.35.1">Leveraging Terraform to automatically set up the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">VM instance</span></span></li>
<li><span class="koboSpan" id="kobo.37.1">Simulating penetration testing in the isolated </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">network environment</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.39.1">Cleaning up</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.40.1">We have an exciting chapter ahead of us as we will learn various techniques, from building penetration testing lab environments in Azure to using security tools for validating misconfigurations and vulnerabilities in our </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">lab setup.</span></span></p>
<p><span class="koboSpan" id="kobo.42.1">Without further ado, </span><span class="No-Break"><span class="koboSpan" id="kobo.43.1">let’s begin!</span></span></p>
<h1 id="_idParaDest-95"><a id="_idTextAnchor094"/><span class="koboSpan" id="kobo.44.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.45.1">Before we start, we must have the </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">following ready:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.47.1">A </span><strong class="bold"><span class="koboSpan" id="kobo.48.1">Microsoft </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.49.1">Azure</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.50.1"> account</span></span></li>
<li><span class="koboSpan" id="kobo.51.1">Any text editor (such as Notepad++, Visual Studio Code, or Sublime Text) where we can temporarily store specific values (for example, our local machine’s IP address) used in the hands-on solutions in </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">this chapter</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.53.1">You may proceed with the next steps once these </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">are ready.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.55.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.56.1">Similar to AWS and GCP, Azure is a mature cloud platform that offers a wide range of services that allow us to build penetration testing environments in the cloud. </span><span class="koboSpan" id="kobo.56.2">We’ll find various options for configuring virtual machines, databases, and other cloud resources for building vulnerable-by-design lab environments in Azure. </span><span class="koboSpan" id="kobo.56.3">The costs associated with running these resources can vary, so make sure you read the available documentation, along with the FAQs, to have a solid understanding of what is free (and what is not free) when creating resources. </span><span class="koboSpan" id="kobo.56.4">In addition to this, make sure you </span><em class="italic"><span class="koboSpan" id="kobo.57.1">don’t</span></em><span class="koboSpan" id="kobo.58.1"> use any existing account with production (or staging) environment resources for the hands-on exercises and solutions in this book. </span><span class="koboSpan" id="kobo.58.2">It is strongly recommended that you create a </span><em class="italic"><span class="koboSpan" id="kobo.59.1">new</span></em><span class="koboSpan" id="kobo.60.1"> Azure account specifically for launching intentionally vulnerable resources. </span><span class="koboSpan" id="kobo.60.2">This will ensure that your production (or staging) environment resources remain separate </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">and secure.</span></span></p>
<p><span class="koboSpan" id="kobo.62.1">The source code and other files used for each chapter are available in this book’s GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">repository: </span></span><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud"><span class="No-Break"><span class="koboSpan" id="kobo.64.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.65.1">.</span></span></p>
<h1 id="_idParaDest-96"><a id="_idTextAnchor095"/><span class="koboSpan" id="kobo.66.1">Preparing the necessary components and prerequisites</span></h1>
<p><span class="koboSpan" id="kobo.67.1">In this section, we will be setting up a few key components and prerequisites before we proceed with preparing the Terraform code in the next section. </span><span class="koboSpan" id="kobo.67.2">We will start by manually creating a resource group for storing some of the resources later in this chapter. </span><span class="koboSpan" id="kobo.67.3">In addition to this, we will generate the SSH keys that will be used to access the attacker’s </span><strong class="bold"><span class="koboSpan" id="kobo.68.1">virtual machine</span></strong><span class="koboSpan" id="kobo.69.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.70.1">VM</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.71.1">) instance.</span></span></p>
<p><span class="koboSpan" id="kobo.72.1">Before we proceed with the hands-on portion of this section, let’s familiarize ourselves first with a few key services and terminologies relevant to </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">this section:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.74.1">Resource group</span></strong><span class="koboSpan" id="kobo.75.1">: A logical container </span><a id="_idIndexMarker585"/><span class="koboSpan" id="kobo.76.1">for grouping multiple </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">resources together</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.78.1">Golden image</span></strong><span class="koboSpan" id="kobo.79.1">: A custom VM image</span><a id="_idIndexMarker586"/><span class="koboSpan" id="kobo.80.1"> containing all applications, along with the configuration settings designed to serve as a standardized template for provisioning multiple instances with identical software </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">and configuration</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.82.1">Cloud Shell</span></strong><span class="koboSpan" id="kobo.83.1">: A browser-based</span><a id="_idIndexMarker587"/><span class="koboSpan" id="kobo.84.1"> interactive command-line environment that enables users to access and manage resources directly through a </span><span class="No-Break"><span class="koboSpan" id="kobo.85.1">web browser</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.86.1">SSH keys</span></strong><span class="koboSpan" id="kobo.87.1">: These are pairs of </span><a id="_idIndexMarker588"/><span class="koboSpan" id="kobo.88.1">cryptographic keys (that is, a </span><strong class="bold"><span class="koboSpan" id="kobo.89.1">private key</span></strong><span class="koboSpan" id="kobo.90.1"> and its</span><a id="_idIndexMarker589"/><span class="koboSpan" id="kobo.91.1"> corresponding </span><strong class="bold"><span class="koboSpan" id="kobo.92.1">public key</span></strong><span class="koboSpan" id="kobo.93.1">) that are used for secure authentication and communication </span><a id="_idIndexMarker590"/><span class="koboSpan" id="kobo.94.1">between systems over </span><span class="No-Break"><span class="koboSpan" id="kobo.95.1">a network</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.96.1">That said, this section is divided into the </span><span class="No-Break"><span class="koboSpan" id="kobo.97.1">following subparts:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.98.1">Part 1 of 2 – Manually creating a </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.99.1">resource group</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.100.1">Part 2 of 2 – Generating SSH keys to access the attacker </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.101.1">VM instance</span></em></span></li>
</ul>
<p><span class="koboSpan" id="kobo.102.1">With these in mind, </span><span class="No-Break"><span class="koboSpan" id="kobo.103.1">let’s proceed.</span></span></p>
<h2 id="_idParaDest-97"><a id="_idTextAnchor096"/><span class="koboSpan" id="kobo.104.1">Part 1 of 2 – Manually creating a resource group</span></h2>
<p><span class="koboSpan" id="kobo.105.1">Let’s start by creating a</span><a id="_idIndexMarker591"/> <span class="No-Break"><span class="koboSpan" id="kobo.106.1">resource group:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.107.1">In the search bar, type </span><strong class="source-inline"><span class="koboSpan" id="kobo.108.1">resource groups</span></strong><span class="koboSpan" id="kobo.109.1"> and then select </span><strong class="bold"><span class="koboSpan" id="kobo.110.1">Resource groups</span></strong><span class="koboSpan" id="kobo.111.1"> from the search results (</span><span class="No-Break"><span class="koboSpan" id="kobo.112.1">under </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.113.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.115.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.116.1">+ Create</span></strong><span class="koboSpan" id="kobo.117.1"> button located on </span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">the toolbar.</span></span></li>
<li><span class="koboSpan" id="kobo.119.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.120.1">Create a resource group</span></strong><span class="koboSpan" id="kobo.121.1"> form (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.122.1">Figure 5</span></em></span><em class="italic"><span class="koboSpan" id="kobo.123.1">.1</span></em><span class="koboSpan" id="kobo.124.1">), specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.125.1">image-resource-group</span></strong><span class="koboSpan" id="kobo.126.1"> for the </span><strong class="bold"><span class="koboSpan" id="kobo.127.1">Resource group</span></strong><span class="koboSpan" id="kobo.128.1"> input </span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">field value:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer112">
<span class="koboSpan" id="kobo.130.1"><img alt="" src="image/B19755_05_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.131.1">Figure 5.1 – Create a resource group</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.132.1">We will use this resource group later when we create an image for our VM instance. </span><span class="koboSpan" id="kobo.132.2">If you are wondering how many resource groups we will have in this chapter, we will have exactly three resource groups – the manually created resource group (</span><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">image-resource-group</span></strong><span class="koboSpan" id="kobo.134.1">), along with two other resource groups we will automatically create using Terraform (</span><strong class="source-inline"><span class="koboSpan" id="kobo.135.1">resource-group-01</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.136.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.137.1">resource-group-02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">).</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.139.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.140.1">Make sure that </span><strong class="bold"><span class="koboSpan" id="kobo.141.1">Region</span></strong><span class="koboSpan" id="kobo.142.1"> is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">(US) East US</span></strong><span class="koboSpan" id="kobo.144.1"> as we will use the same region when creating the other resources in </span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">this chapter.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.146.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.147.1">Review + </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.148.1">create</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.149.1"> button.</span></span></li>
<li><span class="koboSpan" id="kobo.150.1">Finally, click </span><strong class="bold"><span class="koboSpan" id="kobo.151.1">Create</span></strong><span class="koboSpan" id="kobo.152.1"> to finish</span><a id="_idIndexMarker592"/><span class="koboSpan" id="kobo.153.1"> creating the new </span><span class="No-Break"><span class="koboSpan" id="kobo.154.1">resource group.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.155.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.156.1">The resource group we just created will be used to contain the golden image we will prepare later in this chapter. </span><em class="italic"><span class="koboSpan" id="kobo.157.1">Why do we need to create a separate resource group for the golden image?</span></em><span class="koboSpan" id="kobo.158.1"> As we will see later, having the golden image in a separate resource group will allow us to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">terraform apply</span></strong><span class="koboSpan" id="kobo.160.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.162.1"> commands without issues and blockers. </span><span class="koboSpan" id="kobo.162.2">If the golden image is inside one of the automatically created resource groups, we will be forced to delete the golden image for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.164.1"> command to succeed and complete while we’re cleaning up and deleting the resources. </span><span class="koboSpan" id="kobo.164.2">We won’t be able to delete the automatically created resource group using </span><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.166.1"> if it contains additional resources not managed by Terraform (unless we also delete those resources manually before retrying the </span><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">destroy</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.169.1"> command).</span></span></p>
<h2 id="_idParaDest-98"><a id="_idTextAnchor097"/><span class="koboSpan" id="kobo.170.1">Part 2 of 2 – Generating SSH keys to access the attacker VM instance</span></h2>
<p><span class="koboSpan" id="kobo.171.1">Now, let’s proceed with</span><a id="_idIndexMarker593"/><span class="koboSpan" id="kobo.172.1"> generating the SSH keys for </span><a id="_idIndexMarker594"/><span class="koboSpan" id="kobo.173.1">accessing the attacker VM instance later in </span><span class="No-Break"><span class="koboSpan" id="kobo.174.1">this chapter:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.175.1">Open the </span><strong class="bold"><span class="koboSpan" id="kobo.176.1">Cloud Shell</span></strong><span class="koboSpan" id="kobo.177.1"> editor by clicking the button highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.178.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.179.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.180.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer113">
<span class="koboSpan" id="kobo.181.1"><img alt="" src="image/B19755_05_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.182.1">Figure 5.2 – Opening Cloud Shell</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.183.1">When prompted to select </span><strong class="bold"><span class="koboSpan" id="kobo.184.1">Bash</span></strong><span class="koboSpan" id="kobo.185.1"> or </span><strong class="bold"><span class="koboSpan" id="kobo.186.1">PowerShell</span></strong><span class="koboSpan" id="kobo.187.1">, choose </span><strong class="bold"><span class="koboSpan" id="kobo.188.1">Bash</span></strong><span class="koboSpan" id="kobo.189.1">. </span><span class="koboSpan" id="kobo.189.2">This will open a terminal where we can run bash commands (after the </span><strong class="bold"><span class="koboSpan" id="kobo.190.1">$</span></strong><span class="koboSpan" id="kobo.191.1"> sign). </span><span class="koboSpan" id="kobo.191.2">Similar to Google Cloud Shell, which</span><a id="_idIndexMarker595"/><span class="koboSpan" id="kobo.192.1"> we used in the previous chapter, Azure Cloud Shell provides a convenient way to manage resources using a </span><a id="_idIndexMarker596"/><span class="koboSpan" id="kobo.193.1">ready-to-use terminal </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">and editor.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.195.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.196.1">Since Azure Cloud Shell requires a file share to persist files, we need to create a storage account in case we see the </span><strong class="bold"><span class="koboSpan" id="kobo.197.1">You have no storage mounted</span></strong><span class="koboSpan" id="kobo.198.1"> message. </span><span class="koboSpan" id="kobo.198.2">Refer to the following link on how to persist files and create a new storage account for Azure Cloud </span><span class="No-Break"><span class="koboSpan" id="kobo.199.1">Shell: </span></span><a href="https://learn.microsoft.com/en-us/azure/cloud-shell/persisting-shell-storage"><span class="No-Break"><span class="koboSpan" id="kobo.200.1">https://learn.microsoft.com/en-us/azure/cloud-shell/persisting-shell-storage</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.201.1">.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.202.1">In the Terminal (right after the </span><strong class="bold"><span class="koboSpan" id="kobo.203.1">$</span></strong><span class="koboSpan" id="kobo.204.1"> sign), run the following commands to create a new directory (named </span><strong class="source-inline"><span class="koboSpan" id="kobo.205.1">kali_keys</span></strong><span class="koboSpan" id="kobo.206.1">) and navigate </span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">to it:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.208.1">cd ~</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.209.1">mkdir kali_keys &amp;&amp; cd kali_keys</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.210.1">We will store the generated keys inside </span><span class="No-Break"><span class="koboSpan" id="kobo.211.1">this directory.</span></span></p></li> <li><span class="koboSpan" id="kobo.212.1">Generate a new SSH key pair and save the generated key files in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">kali_keys</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.214.1"> directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.215.1">ssh-keygen -t rsa -C kali -f ./kali-ssh</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.216.1">When asked for a passphrase, just press </span><em class="italic"><span class="koboSpan" id="kobo.217.1">Enter</span></em><span class="koboSpan" id="kobo.218.1">. </span><span class="koboSpan" id="kobo.218.2">This will generate two files — </span><strong class="source-inline"><span class="koboSpan" id="kobo.219.1">kali-ssh</span></strong><span class="koboSpan" id="kobo.220.1"> (the private key) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">kali-ssh.pub</span></strong><span class="koboSpan" id="kobo.222.1"> (the </span><span class="No-Break"><span class="koboSpan" id="kobo.223.1">public key).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.224.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.225.1">In SSH key-based authentication, the private key is kept secret, often stored on the client side (for example, in our local machine), while the corresponding public key is used for authentication, typically stored on the server we are trying </span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">to access.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.227.1">Print the public key </span><a id="_idIndexMarker597"/><span class="koboSpan" id="kobo.228.1">value using</span><a id="_idIndexMarker598"/><span class="koboSpan" id="kobo.229.1"> the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">cat</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.231.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.232.1">cat kali-ssh.pub</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.233.1">Store this value in a text editor in your local machine – we will use this later when configuring the Kali Linux VM instance in the succeeding sections of </span><span class="No-Break"><span class="koboSpan" id="kobo.234.1">this chapter.</span></span></p></li> <li><span class="koboSpan" id="kobo.235.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.236.1">Upload</span></strong><span class="koboSpan" id="kobo.237.1">/</span><strong class="bold"><span class="koboSpan" id="kobo.238.1">Download files</span></strong><span class="koboSpan" id="kobo.239.1"> button, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.240.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.241.1">.3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.242.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer114">
<span class="koboSpan" id="kobo.243.1"><img alt="" src="image/B19755_05_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.244.1">Figure 5.3 – Downloading the private key we generated</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.245.1">Select the </span><strong class="bold"><span class="koboSpan" id="kobo.246.1">Download</span></strong><span class="koboSpan" id="kobo.247.1"> option from the list of options available. </span><span class="koboSpan" id="kobo.247.2">When you see the </span><strong class="bold"><span class="koboSpan" id="kobo.248.1">Download a file </span></strong><span class="koboSpan" id="kobo.249.1">popup window, type </span><strong class="source-inline"><span class="koboSpan" id="kobo.250.1">/kali_keys/kali-ssh</span></strong><span class="koboSpan" id="kobo.251.1"> in the input field highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.252.1">Figure 5</span></em></span><em class="italic"><span class="koboSpan" id="kobo.253.1">.3</span></em><span class="koboSpan" id="kobo.254.1"> and </span><a id="_idIndexMarker599"/><span class="koboSpan" id="kobo.255.1">then </span><span class="No-Break"><span class="koboSpan" id="kobo.256.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.257.1">Download</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.259.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.260.1">Given that the key (</span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">kali-ssh</span></strong><span class="koboSpan" id="kobo.262.1">) has the same name as the key we downloaded in the previous chapter, make sure you don’t mix up the keys (in your local machine) to avoid confusion. </span><span class="koboSpan" id="kobo.262.2">You may rename the downloaded key from </span><span class="No-Break"><em class="italic"><a href="B19755_04.xhtml"><span class="koboSpan" id="kobo.263.1">Chapter 4</span></a></em></span><span class="koboSpan" id="kobo.264.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">kali-ssh-gcp</span></strong><span class="koboSpan" id="kobo.266.1"> instead before proceeding to the </span><span class="No-Break"><span class="koboSpan" id="kobo.267.1">next step.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.268.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.269.1">Click here to download your file</span></strong><span class="koboSpan" id="kobo.270.1"> link to proceed with the actual </span><span class="No-Break"><span class="koboSpan" id="kobo.271.1">download operation.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.272.1">With the prerequisites ready, we can </span><a id="_idIndexMarker600"/><span class="koboSpan" id="kobo.273.1">now proceed with setting up the </span><span class="No-Break"><span class="koboSpan" id="kobo.274.1">project’s structure.</span></span></p>
<h1 id="_idParaDest-99"><a id="_idTextAnchor098"/><span class="koboSpan" id="kobo.275.1">Defining the project’s structure</span></h1>
<p><span class="koboSpan" id="kobo.276.1">In this chapter, we </span><a id="_idIndexMarker601"/><span class="koboSpan" id="kobo.277.1">will use a Terraform project structure similar to what we had in </span><span class="No-Break"><em class="italic"><a href="B19755_04.xhtml"><span class="koboSpan" id="kobo.278.1">Chapter 4</span></a></em></span><span class="koboSpan" id="kobo.279.1">, </span><em class="italic"><span class="koboSpan" id="kobo.280.1">Setting Up Isolated Penetration Testing Lab Environments on GCP</span></em><span class="koboSpan" id="kobo.281.1">. </span><span class="koboSpan" id="kobo.281.2">While there are similarities between the lab environments in the previous chapter and this one, the lab environment in this chapter will have a few additional components to give it a bit </span><span class="No-Break"><span class="koboSpan" id="kobo.282.1">more complexity:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer115">
<span class="koboSpan" id="kobo.283.1"><img alt="" src="image/B19755_05_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.284.1">Figure 5.4 – What our lab setup looks like (without the network environment)</span></p>
<p><span class="koboSpan" id="kobo.285.1">One of the major components of the lab environment in this chapter will be a secure secrets store (Azure Key Vault) where we will store one of the flags. </span><span class="koboSpan" id="kobo.285.2">We will also make it possible for lab users (assuming the role of an attacker) to break out of a running container and gain unauthorized access to the host system inside the VM instance. </span><span class="koboSpan" id="kobo.285.3">Once access to the host</span><a id="_idIndexMarker602"/><span class="koboSpan" id="kobo.286.1"> system has been obtained, a system-assigned managed identity will allow access to the Azure Key Vault secrets from within the </span><span class="No-Break"><span class="koboSpan" id="kobo.287.1">VM instance.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.288.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.289.1">Do not worry if the terms used in this section seem unfamiliar as we will discuss and define these concepts, terminologies, and services in the </span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">next section!</span></span></p>
<p><span class="koboSpan" id="kobo.291.1">For now, we will focus on what these lab </span><a id="_idIndexMarker603"/><span class="koboSpan" id="kobo.292.1">environments have in common – a </span><strong class="bold"><span class="koboSpan" id="kobo.293.1">network peering</span></strong><span class="koboSpan" id="kobo.294.1"> setup bridging an attacker network and a target network (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.295.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.296.1">.5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.297.1">):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer116">
<span class="koboSpan" id="kobo.298.1"><img alt="" src="image/B19755_05_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.299.1">Figure 5.5 – Network peering setup connecting two networks</span></p>
<p><span class="koboSpan" id="kobo.300.1">Given that we will set up a more complex lab environment in this chapter, we must plan where we</span><a id="_idIndexMarker604"/><span class="koboSpan" id="kobo.301.1"> will configure the additional resources without having to drastically change how the resources are grouped. </span><span class="koboSpan" id="kobo.301.2">That said, our Terraform project structure will have the following modules in </span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">this chapter:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">secure_network</span></strong><span class="koboSpan" id="kobo.304.1">: The module that will contain the code for creating and configuring the network resources for this </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">lab environment</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.306.1">target_vm</span></strong><span class="koboSpan" id="kobo.307.1">: The module for creating and configuring the target VM instance, along with other target resources (including the Azure Key Vault resource where we will store a </span><span class="No-Break"><span class="koboSpan" id="kobo.308.1">secret flag)</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.310.1">: The module containing the code for setting up the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.311.1">VM instance</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.312.1">While this approach is not perfect, this should do the trick for now as our primary goal in this chapter is to introduce new vulnerable and misconfigured components that may be present in modern </span><span class="No-Break"><span class="koboSpan" id="kobo.313.1">cloud environments.</span></span></p>
<p><span class="koboSpan" id="kobo.314.1">That said, let’s proceed with setting up the initial project files </span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">and directories:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.316.1">Continuing where we left off in the previous section, let’s open the Cloud Shell editor by clicking the button highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.317.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.318.1">.6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer117">
<span class="koboSpan" id="kobo.320.1"><img alt="" src="image/B19755_05_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.321.1">Figure 5.6 – Opening the Cloud Shell editor</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.322.1">Feel free to </span><a id="_idIndexMarker605"/><span class="koboSpan" id="kobo.323.1">maximize the Cloud Shell window by clicking the maximize icon located at the top-left corner of </span><span class="No-Break"><span class="koboSpan" id="kobo.324.1">the editor.</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.325.1">In the Terminal (right after the </span><strong class="bold"><span class="koboSpan" id="kobo.326.1">$</span></strong><span class="koboSpan" id="kobo.327.1"> sign), run the following commands to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">pentest_lab</span></strong><span class="koboSpan" id="kobo.329.1"> project directory (and navigate to the new directory </span><span class="No-Break"><span class="koboSpan" id="kobo.330.1">as well):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.331.1">cd ~</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.332.1">mkdir -p pentest_lab &amp;&amp; cd pentest_lab</span></strong></pre></li> <li><span class="koboSpan" id="kobo.333.1">Inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">pentest_lab</span></strong><span class="koboSpan" id="kobo.335.1"> directory, let’s also create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">secure_network</span></strong><span class="koboSpan" id="kobo.337.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">target_vm</span></strong><span class="koboSpan" id="kobo.339.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.340.1">attacker_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.341.1"> directories:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.342.1">mkdir -p secure_network</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.343.1">mkdir -p target_vm</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.344.1">mkdir -p attacker_vm</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.345.1">We’ll store the corresponding module files in these </span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">directories later.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.347.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.348.1">While it is a common practice to have a separate directory named </span><strong class="source-inline"><span class="koboSpan" id="kobo.349.1">modules</span></strong><span class="koboSpan" id="kobo.350.1"> for storing individual module directories such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">secure_network</span></strong><span class="koboSpan" id="kobo.352.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">target_vm</span></strong><span class="koboSpan" id="kobo.354.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.356.1">, our current project and folder structure should suffice </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">for now.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.358.1">Let’s create the</span><a id="_idIndexMarker606"/><span class="koboSpan" id="kobo.359.1"> files we’ll have in the root folder of </span><span class="No-Break"><span class="koboSpan" id="kobo.360.1">our project:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.361.1">touch main.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.362.1">touch variables.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.363.1">touch outputs.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.364.1">touch terraform.tfvars</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.365.1">touch versions.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.366.1">touch provider.tf</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.367.1">Note that at this point, these files are still empty. </span><span class="koboSpan" id="kobo.367.2">We will populate them with the necessary configurations as we </span><span class="No-Break"><span class="koboSpan" id="kobo.368.1">go along.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.369.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.370.1">Feel free to click the refresh button in the editor if the new files and directories do not </span><span class="No-Break"><span class="koboSpan" id="kobo.371.1">appear automatically.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.372.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">provider.tf</span></strong><span class="koboSpan" id="kobo.374.1"> file in the editor and add the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.375.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.376.1">
provider "</span><strong class="bold"><span class="koboSpan" id="kobo.377.1">azurerm</span></strong><span class="koboSpan" id="kobo.378.1">" {
  features {}
}</span></pre></li> <li><span class="koboSpan" id="kobo.379.1">Next, let’s open </span><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">versions.tf</span></strong><span class="koboSpan" id="kobo.381.1"> in the editor. </span><span class="koboSpan" id="kobo.381.2">Let’s add the following block of code to specify the required version constraints for the </span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">providers used:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.383.1">terraform</span></strong><span class="koboSpan" id="kobo.384.1"> {
  required_version = "&gt;=0.12"
  </span><strong class="bold"><span class="koboSpan" id="kobo.385.1">required_providers</span></strong><span class="koboSpan" id="kobo.386.1"> {
    azurerm = {
      source  = "</span><strong class="bold"><span class="koboSpan" id="kobo.387.1">hashicorp/azurerm</span></strong><span class="koboSpan" id="kobo.388.1">"
      version = "~&gt;2.0"
    }
    random = {
      source  = "</span><strong class="bold"><span class="koboSpan" id="kobo.389.1">hashicorp/random</span></strong><span class="koboSpan" id="kobo.390.1">"
      version = "~&gt;3.0"
    }
  }
}</span></pre></li> <li><span class="koboSpan" id="kobo.391.1">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">variables.tf</span></strong><span class="koboSpan" id="kobo.393.1"> in the </span><a id="_idIndexMarker607"/><span class="koboSpan" id="kobo.394.1">editor and add the following blocks </span><span class="No-Break"><span class="koboSpan" id="kobo.395.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.396.1">
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.397.1">my_ip</span></strong><span class="koboSpan" id="kobo.398.1">" {
  type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.399.1">kali_image_id</span></strong><span class="koboSpan" id="kobo.400.1">" {
  type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.401.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.402.1">" {
  type = string
}</span></pre></li> <li><span class="koboSpan" id="kobo.403.1">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.404.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.405.1"> in the editor and add the following lines </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.407.1">
my_ip = "</span><strong class="bold"><span class="koboSpan" id="kobo.408.1">&lt;INSERT IP ADDRESS&gt;</span></strong><span class="koboSpan" id="kobo.409.1">"
kali_image_id = "&lt;INSERT KALI IMAGE ID&gt;"
my_public_ssh_key = "</span><strong class="bold"><span class="koboSpan" id="kobo.410.1">&lt;INSERT PUBLIC SSH KEY&gt;</span></strong><span class="koboSpan" id="kobo.411.1">"</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.412.1">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.413.1">&lt;INSERT IP ADDRESS&gt;</span></strong><span class="koboSpan" id="kobo.414.1"> with the IP address of your local machine and </span><strong class="source-inline"><span class="koboSpan" id="kobo.415.1">&lt;INSERT PUBLIC SSH KEY&gt;</span></strong><span class="koboSpan" id="kobo.416.1"> with the string value of the public SSH key (which we printed </span><a id="_idIndexMarker608"/><span class="koboSpan" id="kobo.417.1">using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">cat</span></strong><span class="koboSpan" id="kobo.419.1"> command previously). </span><span class="koboSpan" id="kobo.419.2">Since we have not created the golden image of the attacker VM instance yet, leave the </span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">kali_image_id</span></strong><span class="koboSpan" id="kobo.421.1"> placeholder value (that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.422.1">&lt;INSERT KALI IMAGE ID&gt;</span></strong><span class="koboSpan" id="kobo.423.1">) as is </span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">for now.</span></span></p></li> <li><span class="koboSpan" id="kobo.425.1">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">main.tf</span></strong><span class="koboSpan" id="kobo.427.1"> in the editor and add the following blocks of code to define the modules that will be used for </span><span class="No-Break"><span class="koboSpan" id="kobo.428.1">this project:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.429.1">
module "</span><strong class="bold"><span class="koboSpan" id="kobo.430.1">secure_network</span></strong><span class="koboSpan" id="kobo.431.1">" {
  source = "./secure_network"
}
module "</span><strong class="bold"><span class="koboSpan" id="kobo.432.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.433.1">" {
  source = "./attacker_vm"
}
module "</span><strong class="bold"><span class="koboSpan" id="kobo.434.1">target_vm</span></strong><span class="koboSpan" id="kobo.435.1">" {
  source = "./target_vm"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.436.1">Here, we are adding module blocks to </span><strong class="source-inline"><span class="koboSpan" id="kobo.437.1">main.tf</span></strong><span class="koboSpan" id="kobo.438.1"> to include the </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">secure_network</span></strong><span class="koboSpan" id="kobo.440.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.442.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">target_vm</span></strong><span class="koboSpan" id="kobo.444.1"> modules from their respective source directories. </span><span class="koboSpan" id="kobo.444.2">Make sure you save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">main.tf</span></strong><span class="koboSpan" id="kobo.446.1"> file before proceeding to the </span><a id="_idIndexMarker609"/><span class="No-Break"><span class="koboSpan" id="kobo.447.1">next step.</span></span></p></li> <li><span class="koboSpan" id="kobo.448.1">Let’s create an empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.449.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.450.1"> file using the </span><span class="No-Break"><span class="koboSpan" id="kobo.451.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.452.1">touch secure_network/main.tf</span></strong></pre></li> <li><span class="koboSpan" id="kobo.453.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.454.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.455.1"> file in the editor and add the following blocks of code for the resource groups that will be used for the </span><span class="No-Break"><span class="koboSpan" id="kobo.456.1">lab environment:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.457.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.458.1">azurerm_resource_group</span></strong><span class="koboSpan" id="kobo.459.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.460.1">rg_01</span></strong><span class="koboSpan" id="kobo.461.1">" {
  location = "eastus"
  name     = "</span><strong class="bold"><span class="koboSpan" id="kobo.462.1">resource-group-01</span></strong><span class="koboSpan" id="kobo.463.1">"
}
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.464.1">azurerm_resource_group</span></strong><span class="koboSpan" id="kobo.465.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.466.1">rg_02</span></strong><span class="koboSpan" id="kobo.467.1">" {
  location = "eastus"
  name     = "</span><strong class="bold"><span class="koboSpan" id="kobo.468.1">resource-group-02</span></strong><span class="koboSpan" id="kobo.469.1">"
}</span></pre></li> <li><span class="koboSpan" id="kobo.470.1">In our Cloud Shell terminal (after the </span><strong class="bold"><span class="koboSpan" id="kobo.471.1">$</span></strong><span class="koboSpan" id="kobo.472.1"> sign), run the following command to initialize the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.473.1">working directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.474.1">terraform init</span></strong></pre></li> <li><span class="koboSpan" id="kobo.475.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.476.1">terraform plan</span></strong><span class="koboSpan" id="kobo.477.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.478.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.479.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.480.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.481.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.482.1">...
</span><span class="koboSpan" id="kobo.482.2">Plan: 2 to add, 0 to change, 0 to destroy.
</span><span class="koboSpan" id="kobo.482.3">...</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.483.1">The command should complete without </span><span class="No-Break"><span class="koboSpan" id="kobo.484.1">any errors.</span></span></p></li> <li><span class="koboSpan" id="kobo.485.1">Next, let’s use</span><a id="_idIndexMarker610"/><span class="koboSpan" id="kobo.486.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">terraform apply</span></strong><span class="koboSpan" id="kobo.488.1"> command to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">the changes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.490.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.491.1">This should give us the </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.493.1">...
</span><span class="koboSpan" id="kobo.493.2">Apply complete! </span><span class="koboSpan" id="kobo.493.3">Resources: 2 added, 0 changed, 0 destroyed.
</span><span class="koboSpan" id="kobo.493.4">...</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.494.1">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">terraform apply</span></strong><span class="koboSpan" id="kobo.496.1"> command runs without any errors, we are ready to proceed to the next section. </span><span class="koboSpan" id="kobo.496.2">Otherwise, feel free to check and fix any existing code issues in your </span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">Terraform configuration.</span></span></p></li> <li><span class="koboSpan" id="kobo.498.1">Verify that the resources have been created successfully using the </span><span class="No-Break"><span class="koboSpan" id="kobo.499.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.500.1">terraform show</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.501.1">This should return the two resource groups that we created in the </span><span class="No-Break"><span class="koboSpan" id="kobo.502.1">previous step.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.503.1">With our project structure and skeleton ready, we </span><a id="_idIndexMarker611"/><span class="koboSpan" id="kobo.504.1">can now proceed with setting up the isolated </span><strong class="bold"><span class="koboSpan" id="kobo.505.1">virtual network</span></strong><span class="koboSpan" id="kobo.506.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.507.1">VNet</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">) environment.</span></span></p>
<h1 id="_idParaDest-100"><a id="_idTextAnchor099"/><span class="koboSpan" id="kobo.509.1">Preparing the isolated network</span></h1>
<p><span class="koboSpan" id="kobo.510.1">In this section, we will focus </span><a id="_idIndexMarker612"/><span class="koboSpan" id="kobo.511.1">on setting up the isolated network environment that will contain the resources for our penetration testing lab. </span><span class="koboSpan" id="kobo.511.2">We will establish a secure network environment setup in Microsoft Azure that restricts traffic from external hosts from reaching the cloud resources deployed inside the </span><span class="No-Break"><span class="koboSpan" id="kobo.512.1">network environment:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer118">
<span class="koboSpan" id="kobo.513.1"><img alt="" src="image/B19755_05_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.514.1">Figure 5.7 – Isolated network environment</span></p>
<p><span class="koboSpan" id="kobo.515.1">Of course, the resources</span><a id="_idIndexMarker613"/><span class="koboSpan" id="kobo.516.1"> deployed inside should be able to communicate with each other even if they are deployed in different VNets. </span><span class="koboSpan" id="kobo.516.2">We will accomplish this by setting up a </span><strong class="bold"><span class="koboSpan" id="kobo.517.1">VNet peering connection</span></strong><span class="koboSpan" id="kobo.518.1"> to</span><a id="_idIndexMarker614"/><span class="koboSpan" id="kobo.519.1"> bridge two virtual networks, similar to how a VPC peering connection bridges two Google Cloud VPCs, as we saw in the </span><span class="No-Break"><span class="koboSpan" id="kobo.520.1">previous chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.521.1">Before we proceed with preparing the isolated network environment, let’s quickly go through some of the Azure concepts, features, and terminologies relevant to </span><span class="No-Break"><span class="koboSpan" id="kobo.522.1">this chapter:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.523.1">Subscription</span></strong><span class="koboSpan" id="kobo.524.1">: A logical unit that</span><a id="_idIndexMarker615"/><span class="koboSpan" id="kobo.525.1"> serves as a billing and management boundary that enables the organization and governance of Azure resources, access controls, and </span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">usage reporting.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.527.1">Tenant</span></strong><span class="koboSpan" id="kobo.528.1">: This represents an</span><a id="_idIndexMarker616"/><span class="koboSpan" id="kobo.529.1"> organization or identity in Azure. </span><span class="koboSpan" id="kobo.529.2">Each Azure subscription is associated with a </span><a id="_idIndexMarker617"/><span class="koboSpan" id="kobo.530.1">specific tenant, and multiple subscriptions can be associated with the </span><span class="No-Break"><span class="koboSpan" id="kobo.531.1">same tenant.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.532.1">VNet</span></strong><span class="koboSpan" id="kobo.533.1">: A network that provides a private network environment for resources to </span><a id="_idIndexMarker618"/><span class="koboSpan" id="kobo.534.1">communicate securely within Azure (similar to the VPC networks in GCP </span><span class="No-Break"><span class="koboSpan" id="kobo.535.1">and AWS).</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.536.1">VNet peering</span></strong><span class="koboSpan" id="kobo.537.1">: Connects</span><a id="_idIndexMarker619"/><span class="koboSpan" id="kobo.538.1"> VNets, enabling traffic between </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">these networks.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.540.1">Resource group</span></strong><span class="koboSpan" id="kobo.541.1">: A logical container that helps organize and manage related resources within an </span><span class="No-Break"><span class="koboSpan" id="kobo.542.1">Azure </span></span><span class="No-Break"><a id="_idIndexMarker620"/></span><span class="No-Break"><span class="koboSpan" id="kobo.543.1">subscription.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.544.1">Network interface card</span></strong><span class="koboSpan" id="kobo.545.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.546.1">NIC</span></strong><span class="koboSpan" id="kobo.547.1">): A networking component in Azure that enables communication with other resources by acting as the interface between a VM and the underlying network</span><a id="_idIndexMarker621"/><span class="koboSpan" id="kobo.548.1"> infrastructure. </span><span class="koboSpan" id="kobo.548.2">NICs provide properties and configurations related to IP addresses, network security groups, and </span><span class="No-Break"><span class="koboSpan" id="kobo.549.1">network routing.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.550.1">Application security group</span></strong><span class="koboSpan" id="kobo.551.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.552.1">ASG</span></strong><span class="koboSpan" id="kobo.553.1">): A construct in Azure that allows you to group and manage network security policies </span><a id="_idIndexMarker622"/><span class="koboSpan" id="kobo.554.1">based on application requirements. </span><span class="koboSpan" id="kobo.554.2">ASGs provide a way to define network security rules and associate them with specific applications or services within a </span><span class="No-Break"><span class="koboSpan" id="kobo.555.1">virtual network.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.556.1">Network security group</span></strong><span class="koboSpan" id="kobo.557.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.558.1">NSG</span></strong><span class="koboSpan" id="kobo.559.1">): A networking security construct that acts as a virtual firewall for controlling </span><a id="_idIndexMarker623"/><span class="koboSpan" id="kobo.560.1">inbound and outbound traffic to resources. </span><span class="koboSpan" id="kobo.560.2">NSGs allow for the creation of rules that define network security</span><a id="_idIndexMarker624"/><span class="koboSpan" id="kobo.561.1"> policies, including </span><strong class="bold"><span class="koboSpan" id="kobo.562.1">access control lists</span></strong><span class="koboSpan" id="kobo.563.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.564.1">ACLs</span></strong><span class="koboSpan" id="kobo.565.1">), filtering, and port forwarding. </span><span class="koboSpan" id="kobo.565.2">By associating NSGs with subnets or network interfaces, administrators and engineers can enforce fine-grained network traffic controls and implement </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">security measures.</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.567.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.568.1">NSGs focus on network-level security controls, allowing engineers to define rules based on IP addresses, ports, and protocols. </span><span class="koboSpan" id="kobo.568.2">On the other hand, ASGs provide a higher level of abstraction by allowing engineers to group resources based on their application context to enable more application-centric </span><span class="No-Break"><span class="koboSpan" id="kobo.569.1">security policies.</span></span></p>
<p><span class="koboSpan" id="kobo.570.1">Now that we have a better idea of the</span><a id="_idIndexMarker625"/><span class="koboSpan" id="kobo.571.1"> Microsoft Azure concepts and terminologies we will work with in this chapter, let’s proceed with preparing the </span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">network environment:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.573.1">Continuing where we left off in the previous section, let’s locate the following block of code in our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.574.1">main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.575.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.576.1">
module "secure_network" {
  source = "./secure_network"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.577.1">Let’s replace it with the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.578.1">of code:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.579.1">module "secure_network" {
  source = "./secure_network"
  </span><strong class="bold"><span class="koboSpan" id="kobo.580.1">my_ip = var.my_ip</span></strong><span class="koboSpan" id="kobo.581.1">
}</span></pre></li> <li><span class="koboSpan" id="kobo.582.1">Let’s create an empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.583.1">secure_network/variables.tf</span></strong><span class="koboSpan" id="kobo.584.1"> file using the </span><span class="No-Break"><span class="koboSpan" id="kobo.585.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.586.1">touch secure_network/variables.tf</span></strong></pre></li> <li><span class="koboSpan" id="kobo.587.1">Next, open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.588.1">secure_network/variables.tf</span></strong><span class="koboSpan" id="kobo.589.1"> file in the editor and add the following block of code to define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.590.1">my_ip</span></strong><span class="koboSpan" id="kobo.591.1"> variable for our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.592.1">secure_network</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.593.1"> module:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.594.1">
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.595.1">my_ip</span></strong><span class="koboSpan" id="kobo.596.1">" {
  type = string
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.597.1">Make sure you save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.598.1">secure_network/variables.tf</span></strong><span class="koboSpan" id="kobo.599.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.600.1">before proceeding.</span></span></p></li> <li><span class="koboSpan" id="kobo.601.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.602.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.603.1"> file, we will define and configure the first VNet, along with a single </span><a id="_idIndexMarker626"/><span class="koboSpan" id="kobo.604.1">subnet </span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">inside it:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.606.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.607.1">azurerm_virtual_network</span></strong><span class="koboSpan" id="kobo.608.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.609.1">vnet_01</span></strong><span class="koboSpan" id="kobo.610.1">" {
  name                = "vnet-01"
  address_space       = ["10.0.0.0/16"]
  location            = (azurerm_resource_group
                          .rg_01.location)
  resource_group_name = (azurerm_resource_group
                          .rg_01.name)
}
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.611.1">azurerm_subnet</span></strong><span class="koboSpan" id="kobo.612.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.613.1">subnet_01</span></strong><span class="koboSpan" id="kobo.614.1">" {
  name                 = "subnet-01"
  resource_group_name  = (azurerm_resource_group
                          .rg_01.name)
  virtual_network_name = (azurerm_virtual_network
                          .vnet_01.name)
  address_prefixes     = ["10.0.1.0/24"]
}</span></pre></li> <li><span class="koboSpan" id="kobo.615.1">Let’s define the corresponding ASG and NSG </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">as well:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.617.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.618.1">azurerm_application_security_group</span></strong><span class="koboSpan" id="kobo.619.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.620.1">asg_01</span></strong><span class="koboSpan" id="kobo.621.1">" {
  name                = "asg-01"
  location            = (azurerm_resource_group
                          .rg_01.location)
  resource_group_name = (azurerm_resource_group
                          .rg_01.name)
}
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.622.1">azurerm_network_security_group</span></strong><span class="koboSpan" id="kobo.623.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.624.1">nsg_01</span></strong><span class="koboSpan" id="kobo.625.1">" {
  name                = "nsg-01"
  location            = (azurerm_resource_group
                          .rg_01.location)
  resource_group_name = (azurerm_resource_group
                          .rg_01.name)
}</span></pre></li> <li><span class="koboSpan" id="kobo.626.1">Next, let’s define and </span><a id="_idIndexMarker627"/><span class="koboSpan" id="kobo.627.1">configure a second VNet, along with a single subnet </span><span class="No-Break"><span class="koboSpan" id="kobo.628.1">inside it:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.629.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.630.1">azurerm_virtual_network</span></strong><span class="koboSpan" id="kobo.631.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.632.1">vnet_02</span></strong><span class="koboSpan" id="kobo.633.1">" {
  name                = "vnet-02"
  address_space       = ["192.168.0.0/16"]
  location            = (azurerm_resource_group
                          .rg_02.location)
  resource_group_name = (azurerm_resource_group
                          .rg_02.name)
}
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.634.1">azurerm_subnet</span></strong><span class="koboSpan" id="kobo.635.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.636.1">subnet_02</span></strong><span class="koboSpan" id="kobo.637.1">" {
  name                 = "subnet-02"
  resource_group_name  = (azurerm_resource_group
                          .rg_02.name)
  virtual_network_name = (azurerm_virtual_network
                          .vnet_02.name)
  address_prefixes     = ["192.168.1.0/24"]
}</span></pre></li> <li><span class="koboSpan" id="kobo.638.1">Next, let’s define the ASG</span><a id="_idIndexMarker628"/><span class="koboSpan" id="kobo.639.1"> and NSG for the VNet where the attacker VM instance will </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">be deployed:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.641.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.642.1">azurerm_application_security_group</span></strong><span class="koboSpan" id="kobo.643.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.644.1">asg_02</span></strong><span class="koboSpan" id="kobo.645.1">" {
  name                = "asg-02"
  location            = (azurerm_resource_group
                          .rg_02.location)
  resource_group_name = (azurerm_resource_group
                          .rg_02.name)
}
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.646.1">azurerm_network_security_group</span></strong><span class="koboSpan" id="kobo.647.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.648.1">nsg_02</span></strong><span class="koboSpan" id="kobo.649.1">" {
  name                = "nsg-02"
  location            = (azurerm_resource_group
                          .rg_02.location)
  resource_group_name = (azurerm_resource_group
                          .rg_02.name)
}</span></pre></li> <li><span class="koboSpan" id="kobo.650.1">Let’s define the peering connections using the following blocks </span><span class="No-Break"><span class="koboSpan" id="kobo.651.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.652.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.653.1">azurerm_virtual_network_peering</span></strong><span class="koboSpan" id="kobo.654.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.655.1">peer_1_to_2</span></strong><span class="koboSpan" id="kobo.656.1">" {
  name                      = "peer1to2"
  resource_group_name       = (azurerm_resource_group
                                .rg_01.name)
  virtual_network_name      = (azurerm_virtual_network
                                .vnet_01.name)
  remote_virtual_network_id = (azurerm_virtual_network
                                .vnet_02.id)
}
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.657.1">azurerm_virtual_network_peering</span></strong><span class="koboSpan" id="kobo.658.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.659.1">peer_2_to_1</span></strong><span class="koboSpan" id="kobo.660.1">" {
  name                      = "peer2to1"
  resource_group_name       = (azurerm_resource_group
                                .rg_02.name)
  virtual_network_name      = (azurerm_virtual_network
                                .vnet_02.name)
  remote_virtual_network_id = (azurerm_virtual_network
                                .vnet_01.id)
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.661.1">With this VNet peering</span><a id="_idIndexMarker629"/><span class="koboSpan" id="kobo.662.1"> configuration, traffic from the resources deployed in the subnet of the first VNet, </span><strong class="source-inline"><span class="koboSpan" id="kobo.663.1">vnet-01</span></strong><span class="koboSpan" id="kobo.664.1">, will be able to reach the resources deployed in the subnet of the second VNet, </span><strong class="source-inline"><span class="koboSpan" id="kobo.665.1">vnet-02</span></strong><span class="koboSpan" id="kobo.666.1"> (and vice versa), so long as the necessary firewall rules have been defined and configured correctly </span><span class="No-Break"><span class="koboSpan" id="kobo.667.1">as well.</span></span></p></li> <li><span class="koboSpan" id="kobo.668.1">For our local machine to </span><a id="_idIndexMarker630"/><span class="koboSpan" id="kobo.669.1">access the resources inside the second VNet via port </span><strong class="source-inline"><span class="koboSpan" id="kobo.670.1">8081</span></strong><span class="koboSpan" id="kobo.671.1">, we will need to define a network security rule </span><span class="No-Break"><span class="koboSpan" id="kobo.672.1">as well:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.673.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.674.1">azurerm_network_security_rule</span></strong><span class="koboSpan" id="kobo.675.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.676.1">desktop-access</span></strong><span class="koboSpan" id="kobo.677.1">" {
  name                        = "Desktop-Access"
  priority                    = 900
  direction                   = "Inbound"
  access                      = "Allow"
  protocol                    = "*"
  source_port_range           = "*"
  destination_port_range      = "8081"
  </span><strong class="bold"><span class="koboSpan" id="kobo.678.1">source_address_prefix</span></strong><span class="koboSpan" id="kobo.679.1">       = </span><strong class="bold"><span class="koboSpan" id="kobo.680.1">"${var.my_ip}/32"</span></strong><span class="koboSpan" id="kobo.681.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.682.1">destination_address_prefix</span></strong><span class="koboSpan" id="kobo.683.1">  = (
    </span><strong class="bold"><span class="koboSpan" id="kobo.684.1">azurerm_subnet.subnet_02.address_prefix</span></strong><span class="koboSpan" id="kobo.685.1">
  )
  resource_group_name         = (
    azurerm_resource_group.rg_02.name
  )
  network_security_group_name = (
    azurerm_network_security_group.nsg_02.name
  )
}</span></pre></li> <li><span class="koboSpan" id="kobo.686.1">In addition to this, let’s create a network security rule to allow our local machine to access the resources in</span><a id="_idIndexMarker631"/><span class="koboSpan" id="kobo.687.1"> the second VNet via </span><span class="No-Break"><span class="koboSpan" id="kobo.688.1">port </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">22</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.690.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.691.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.692.1">azurerm_network_security_rule</span></strong><span class="koboSpan" id="kobo.693.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.694.1">ssh-access</span></strong><span class="koboSpan" id="kobo.695.1">" {
  name                        = "</span><strong class="bold"><span class="koboSpan" id="kobo.696.1">SSH-Access</span></strong><span class="koboSpan" id="kobo.697.1">"
  priority                    = 1000
  direction                   = "Inbound"
  access                      = "Allow"
  protocol                    = "*"
  source_port_range           = "*"
  destination_port_range      = "22"
  </span><strong class="bold"><span class="koboSpan" id="kobo.698.1">source_address_prefix</span></strong><span class="koboSpan" id="kobo.699.1">       = </span><strong class="bold"><span class="koboSpan" id="kobo.700.1">"${var.my_ip}/32"</span></strong><span class="koboSpan" id="kobo.701.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.702.1">destination_address_prefix</span></strong><span class="koboSpan" id="kobo.703.1">  = (
    </span><strong class="bold"><span class="koboSpan" id="kobo.704.1">azurerm_subnet.subnet_02.address_prefix</span></strong><span class="koboSpan" id="kobo.705.1">
  )
  resource_group_name         = (
    azurerm_resource_group.rg_02.name
  )
  network_security_group_name = (
    azurerm_network_security_group.nsg_02.name
  )
}</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.706.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.707.1">Make sure you save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.708.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.709.1"> file before proceeding to the next set of steps. </span><span class="koboSpan" id="kobo.709.2">You can find a copy of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.710.1">secure_network/main.tf</span></strong><span class="koboSpan" id="kobo.711.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.712.1">here: </span></span><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/blob/main/ch05/pentest_lab/secure_network/main.tf"><span class="No-Break"><span class="koboSpan" id="kobo.713.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/blob/main/ch05/pentest_lab/secure_network/main.tf</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.714.1">.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.715.1">Let’s create an empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.716.1">secure_network/outputs.tf</span></strong><span class="koboSpan" id="kobo.717.1"> file using the </span><span class="No-Break"><span class="koboSpan" id="kobo.718.1">following</span></span><span class="No-Break"><a id="_idIndexMarker632"/></span><span class="No-Break"><span class="koboSpan" id="kobo.719.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.720.1">touch secure_network/outputs.tf</span></strong></pre></li> <li><span class="koboSpan" id="kobo.721.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.722.1">secure_network/outputs.tf</span></strong><span class="koboSpan" id="kobo.723.1"> file in the editor and add the following lines of code to define the </span><span class="No-Break"><span class="koboSpan" id="kobo.724.1">following outputs:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.725.1">
output "</span><strong class="bold"><span class="koboSpan" id="kobo.726.1">asg_01</span></strong><span class="koboSpan" id="kobo.727.1">" {
  value = azurerm_application_security_group.asg_01.id
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.728.1">nsg_01</span></strong><span class="koboSpan" id="kobo.729.1">" {
  value = azurerm_network_security_group.nsg_01.id
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.730.1">rg_01_location</span></strong><span class="koboSpan" id="kobo.731.1">" {
  value = azurerm_resource_group.rg_01.location
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.732.1">rg_01_name</span></strong><span class="koboSpan" id="kobo.733.1">" {
  value = azurerm_resource_group.rg_01.name
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.734.1">subnet_01</span></strong><span class="koboSpan" id="kobo.735.1">" {
  value = azurerm_subnet.subnet_01.id
}</span></pre></li> <li><span class="koboSpan" id="kobo.736.1">Add the following outputs</span><a id="_idIndexMarker633"/><span class="koboSpan" id="kobo.737.1"> right after the last defined output block </span><span class="No-Break"><span class="koboSpan" id="kobo.738.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.739.1">secure_network/outputs.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.740.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.741.1">
output "</span><strong class="bold"><span class="koboSpan" id="kobo.742.1">asg_02</span></strong><span class="koboSpan" id="kobo.743.1">" {
  value = azurerm_application_security_group.asg_02.id
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.744.1">nsg_02</span></strong><span class="koboSpan" id="kobo.745.1">" {
  value = azurerm_network_security_group.nsg_02.id
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.746.1">rg_02_location</span></strong><span class="koboSpan" id="kobo.747.1">" {
  value = azurerm_resource_group.rg_02.location
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.748.1">rg_02_name</span></strong><span class="koboSpan" id="kobo.749.1">" {
  value = azurerm_resource_group.rg_02.name
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.750.1">subnet_02</span></strong><span class="koboSpan" id="kobo.751.1">" {
  value = azurerm_subnet.subnet_02.id
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.752.1">Make sure you save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.753.1">secure_network/outputs.tf</span></strong><span class="koboSpan" id="kobo.754.1"> file before proceeding to the </span><span class="No-Break"><span class="koboSpan" id="kobo.755.1">next step.</span></span></p></li> <li><span class="koboSpan" id="kobo.756.1">Navigate back to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.757.1">~/pentest_lab</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.758.1">project folder:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.759.1">cd ~/pentest_lab</span></strong></pre></li> <li><span class="koboSpan" id="kobo.760.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.761.1">terraform plan</span></strong><span class="koboSpan" id="kobo.762.1"> to</span><a id="_idIndexMarker634"/><span class="koboSpan" id="kobo.763.1"> preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.764.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.765.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.766.1">This should give us the </span><span class="No-Break"><span class="koboSpan" id="kobo.767.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.768.1">...
</span><span class="koboSpan" id="kobo.768.2">Plan: 12 to add, 0 to change, 0 to destroy.
</span><span class="koboSpan" id="kobo.768.3">...</span></pre></li> <li><span class="koboSpan" id="kobo.769.1">Finally, let’s use </span><strong class="source-inline"><span class="koboSpan" id="kobo.770.1">terraform apply</span></strong><span class="koboSpan" id="kobo.771.1"> to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.772.1">the changes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.773.1">terraform apply -auto-approve</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.774.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.775.1">Running this command may yield a few deprecation warnings. </span><span class="koboSpan" id="kobo.775.2">This should be okay, so long as we can successfully run the command </span><span class="No-Break"><span class="koboSpan" id="kobo.776.1">without errors.</span></span></p>
<p><span class="koboSpan" id="kobo.777.1">At this point, the network environment is ready! </span><span class="koboSpan" id="kobo.777.2">In the next section, we’ll proceed with setting up the </span><span class="No-Break"><span class="koboSpan" id="kobo.778.1">target resources.</span></span></p>
<h1 id="_idParaDest-101"><a id="_idTextAnchor100"/><span class="koboSpan" id="kobo.779.1">Setting up the target resources</span></h1>
<p><span class="koboSpan" id="kobo.780.1">With our isolated network </span><a id="_idIndexMarker635"/><span class="koboSpan" id="kobo.781.1">environment ready, we can now proceed with setting up the target VM instance, along with a few additional resources such as the Azure Key Vault (containing an additional flag secret) and a vulnerable container running inside the VM instance with </span><span class="No-Break"><span class="koboSpan" id="kobo.782.1">elevated privileges:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer119">
<span class="koboSpan" id="kobo.783.1"><img alt="" src="image/B19755_05_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.784.1">Figure 5.8 – The target resources we will set up in this section</span></p>
<p><span class="koboSpan" id="kobo.785.1">In this section, we will set up the target VM instance inside VNet 01, similar to how we set up the</span><a id="_idIndexMarker636"/><span class="koboSpan" id="kobo.786.1"> target VM instance in the previous chapter. </span><span class="koboSpan" id="kobo.786.2">One major difference we will have in this chapter is that we will run the </span><strong class="bold"><span class="koboSpan" id="kobo.787.1">Metasploitable 2</span></strong><span class="koboSpan" id="kobo.788.1"> container</span><a id="_idIndexMarker637"/><span class="koboSpan" id="kobo.789.1"> instead of the </span><strong class="bold"><span class="koboSpan" id="kobo.790.1">OWASP Juice Shop</span></strong><span class="koboSpan" id="kobo.791.1"> container. </span><span class="koboSpan" id="kobo.791.2">Like OWASP Juice Shop, Metasploitable</span><a id="_idIndexMarker638"/><span class="koboSpan" id="kobo.792.1"> 2 intentionally includes a variety of insecure configurations and vulnerable software packages. </span><span class="koboSpan" id="kobo.792.2">While Metasploitable 2 was primarily designed and distributed as a vulnerable VM, it is possible to configure and run it as a container. </span><span class="koboSpan" id="kobo.792.3">We will run this vulnerable container with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.793.1">--privileged</span></strong><span class="koboSpan" id="kobo.794.1"> flag, which will allow us to break out of the container during the penetration testing simulation toward the end of </span><span class="No-Break"><span class="koboSpan" id="kobo.795.1">this chapter.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.796.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.797.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.798.1">--privileged</span></strong><span class="koboSpan" id="kobo.799.1"> flag in Docker grants a container elevated privileges within the host system. </span><span class="koboSpan" id="kobo.799.2">It introduces a potential security risk that allows attackers to break out of a container and gain root-level access to the host (from inside the container). </span><span class="koboSpan" id="kobo.799.3">While we won’t dive deep into the details of how container breakouts work, we will provide a quick demonstration of how this is performed during the simulation session toward the end of </span><span class="No-Break"><span class="koboSpan" id="kobo.800.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.801.1">In addition to this, we will configure the target VM instance so that it has a system-assigned managed identity. </span><span class="koboSpan" id="kobo.801.2">This will enable us to access the Azure Key Vault secrets from within the instance without having to (explicitly) specify credentials when using the Azure CLI. </span><span class="koboSpan" id="kobo.801.3">If you are </span><a id="_idIndexMarker639"/><span class="koboSpan" id="kobo.802.1">wondering what </span><strong class="bold"><span class="koboSpan" id="kobo.803.1">Azure Key Vault</span></strong><span class="koboSpan" id="kobo.804.1"> is, it is a cloud-based service in Microsoft Azure that allows users, developers, and engineers to securely store and manage cryptographic keys, secrets, and certificates in a centralized repository. </span><span class="koboSpan" id="kobo.804.2">Understanding how Azure Key Vault works is essential from a penetration testing standpoint since </span><a id="_idIndexMarker640"/><span class="koboSpan" id="kobo.805.1">testers will need to assess the security controls in place and identify potential vulnerabilities and misconfigurations when using </span><span class="No-Break"><span class="koboSpan" id="kobo.806.1">this service.</span></span></p>
<p><span class="koboSpan" id="kobo.807.1">That said, this section is divided into the </span><span class="No-Break"><span class="koboSpan" id="kobo.808.1">following subparts:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.809.1">Part 1 of 2 – Preparing the target resources </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.810.1">using Terraform</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.811.1">Part 2 of 2 – Verifying our target VM </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.812.1">instance setup</span></em></span></li>
</ul>
<h2 id="_idParaDest-102"><a id="_idTextAnchor101"/><span class="koboSpan" id="kobo.813.1">Part 1 of 2 – Preparing the target resources using Terraform</span></h2>
<p><span class="koboSpan" id="kobo.814.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.815.1">these</span></span><span class="No-Break"><a id="_idIndexMarker641"/></span><span class="No-Break"><span class="koboSpan" id="kobo.816.1"> steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.817.1">Let’s create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.818.1">main.tf</span></strong><span class="koboSpan" id="kobo.819.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.820.1">variables.tf</span></strong><span class="koboSpan" id="kobo.821.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.822.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.823.1"> files inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.824.1">target_vm</span></strong><span class="koboSpan" id="kobo.825.1"> directory</span><a id="_idIndexMarker642"/><span class="koboSpan" id="kobo.826.1"> using the </span><span class="No-Break"><span class="koboSpan" id="kobo.827.1">following </span></span><span class="No-Break"><span class="koboSpan" id="kobo.828.1">commands</span></span><span class="No-Break"><span class="koboSpan" id="kobo.829.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.830.1">touch target_vm/main.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.831.1">touch target_vm/variables.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.832.1">touch target_vm/outputs.tf</span></strong></pre></li> <li><span class="koboSpan" id="kobo.833.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.834.1">wget</span></strong><span class="koboSpan" id="kobo.835.1"> command to download the </span><strong class="source-inline"><span class="koboSpan" id="kobo.836.1">boot-script.sh</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.837.1">script file:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.838.1">DOWNLOAD_URL=</span></strong><a href="https://raw.githubusercontent.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/main/ch05/pentest_lab/target_vm/boot-script.sh"><strong class="bold"><span class="koboSpan" id="kobo.839.1">https://raw.githubusercontent.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/main/ch05/pentest_lab/target_vm/boot-script.sh</span></strong></a>
<strong class="bold"><span class="koboSpan" id="kobo.840.1">wget -O target_vm/boot-script.sh $DOWNLOAD_URL</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.841.1">Make sure that </span><a id="_idIndexMarker643"/><span class="koboSpan" id="kobo.842.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.843.1">DOWNLOAD_URL</span></strong><span class="koboSpan" id="kobo.844.1"> variable value is correct and properly pointing to the boot-script.sh file. </span><span class="koboSpan" id="kobo.844.2">If you are wondering what’s </span><a id="_idIndexMarker644"/><span class="koboSpan" id="kobo.845.1">inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.846.1">boot-script.sh</span></strong><span class="koboSpan" id="kobo.847.1">, here’s a quick screenshot of what’s inside the </span><span class="No-Break"><span class="koboSpan" id="kobo.848.1">script file.</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer120">
<span class="koboSpan" id="kobo.849.1"><img alt="" src="image/B19755_05_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.850.1">Figure 5.9 – boot-script.sh</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.851.1">When executed, the following script file will (1) create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.852.1">flag1.txt</span></strong><span class="koboSpan" id="kobo.853.1"> file for the first flag, (2) install Docker inside the VM instance, (3) pull the </span><strong class="bold"><span class="koboSpan" id="kobo.854.1">Metasploitable 2</span></strong><span class="koboSpan" id="kobo.855.1"> container image, (4) run the vulnerable container with elevated privileges, along with mapping specific container ports to the VM instance ports, (5) install the </span><strong class="bold"><span class="koboSpan" id="kobo.856.1">Azure CLI</span></strong><span class="koboSpan" id="kobo.857.1"> inside the VM instance, and (6) set up the second flag as a secret inside Azure </span><span class="No-Break"><span class="koboSpan" id="kobo.858.1">Key Vault.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.859.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.860.1">If you are wondering what a </span><strong class="bold"><span class="koboSpan" id="kobo.861.1">flag</span></strong><span class="koboSpan" id="kobo.862.1"> is, it serves as an essential marker of successful exploitation and progress in a penetration testing</span><a id="_idIndexMarker645"/><span class="koboSpan" id="kobo.863.1"> lab environment. </span><span class="koboSpan" id="kobo.863.2">Flags may represent sensitive data or credentials that an attacker (or someone assuming the role of an attacker) aims to acquire during a real-world compromise. </span><span class="koboSpan" id="kobo.863.3">So, we can think of a penetration testing lab environment as a maze with flags that act as valuable treasures waiting to be discovered at different points along </span><span class="No-Break"><span class="koboSpan" id="kobo.864.1">the way.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.865.1">Next, define the</span><a id="_idIndexMarker646"/><span class="koboSpan" id="kobo.866.1"> following variables</span><a id="_idIndexMarker647"/> <span class="No-Break"><span class="koboSpan" id="kobo.867.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.868.1">target_vm/variables.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.869.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.870.1">
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.871.1">asg</span></strong><span class="koboSpan" id="kobo.872.1">" {
  type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.873.1">nsg</span></strong><span class="koboSpan" id="kobo.874.1">" {
  type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.875.1">rg_location</span></strong><span class="koboSpan" id="kobo.876.1">" {
  type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.877.1">rg_name</span></strong><span class="koboSpan" id="kobo.878.1">" {
  type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.879.1">subnet</span></strong><span class="koboSpan" id="kobo.880.1">" {
  type = string
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.881.1">These variables will be used later when we define the resources under the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.882.1">target_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.883.1"> module.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.884.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.885.1">Make sure you save the changes you’ve made to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.886.1">target_vm/variables.tf</span></strong><span class="koboSpan" id="kobo.887.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.888.1">before proceeding.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.889.1">Now, let’s open </span><strong class="source-inline"><span class="koboSpan" id="kobo.890.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.891.1"> in the editor. </span><span class="koboSpan" id="kobo.891.2">Keep this file open – we will define various</span><a id="_idIndexMarker648"/><span class="koboSpan" id="kobo.892.1"> resources inside this file in</span><a id="_idIndexMarker649"/><span class="koboSpan" id="kobo.893.1"> the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.894.1">of steps.</span></span></li>
<li><span class="koboSpan" id="kobo.895.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.896.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.897.1"> file, add the following blocks of code for the credentials that will be used to access the target </span><span class="No-Break"><span class="koboSpan" id="kobo.898.1">VM instance:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.899.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.900.1">random_string</span></strong><span class="koboSpan" id="kobo.901.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.902.1">random_password</span></strong><span class="koboSpan" id="kobo.903.1">" {
  length           = 12
  special          = true
  override_special = "!#$%&amp;"
  min_lower        = 2
  min_special      = 2
  min_upper        = 2
}
locals {
    </span><strong class="bold"><span class="koboSpan" id="kobo.904.1">vm_username</span></strong><span class="koboSpan" id="kobo.905.1"> = "testuser"
    </span><strong class="bold"><span class="koboSpan" id="kobo.906.1">vm_password</span></strong><span class="koboSpan" id="kobo.907.1"> = random_string.random_password.result
}</span></pre></li> <li><span class="koboSpan" id="kobo.908.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.909.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.910.1"> file, let’s also define the public IP address and network interface</span><a id="_idIndexMarker650"/><span class="koboSpan" id="kobo.911.1"> resources for the target </span><span class="No-Break"><span class="koboSpan" id="kobo.912.1">VM instance:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.913.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.914.1">azurerm_public_ip</span></strong><span class="koboSpan" id="kobo.915.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.916.1">public_ip_target</span></strong><span class="koboSpan" id="kobo.917.1">" {
  name                = "public-ip-target"
  location            = var.rg_location
  resource_group_name = var.rg_name
  allocation_method   = "Dynamic"
}
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.918.1">azurerm_network_interface</span></strong><span class="koboSpan" id="kobo.919.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.920.1">nic_target</span></strong><span class="koboSpan" id="kobo.921.1">" {
  name                = "nic-target"
  location            = var.rg_location
  resource_group_name = var.rg_name
  ip_configuration {
    name          = "nic_configuration_target"
    subnet_id                     = var.subnet
    private_ip_address_allocation = "Dynamic"
    public_ip_address_id          = (
      azurerm_public_ip.public_ip_target.id
    )
  }
}</span></pre></li> <li><span class="koboSpan" id="kobo.922.1">We will need to define</span><a id="_idIndexMarker651"/><span class="koboSpan" id="kobo.923.1"> the associations in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.924.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.925.1"> file as well using the following blocks </span><span class="No-Break"><span class="koboSpan" id="kobo.926.1">of </span></span><span class="No-Break"><a id="_idIndexMarker652"/></span><span class="No-Break"><span class="koboSpan" id="kobo.927.1">code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.928.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.929.1">azurerm_network_interface_security_group_association</span></strong><span class="koboSpan" id="kobo.930.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.931.1">nsg_assoc_target</span></strong><span class="koboSpan" id="kobo.932.1">" {
  network_interface_id      = (
    azurerm_network_interface.nic_target.id
  )
  network_security_group_id = var.nsg
}
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.933.1">azurerm_network_interface_application_security_group_association</span></strong><span class="koboSpan" id="kobo.934.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.935.1">asg_assoc_target</span></strong><span class="koboSpan" id="kobo.936.1">" {
  network_interface_id          = (
    azurerm_network_interface.nic_target.id
  )
  application_security_group_id = var.asg
}</span></pre></li> <li><span class="koboSpan" id="kobo.937.1">With all the prerequisites </span><a id="_idIndexMarker653"/><span class="koboSpan" id="kobo.938.1">ready, let’s add the following block of code to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.939.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.940.1"> file to define and configure the target </span><span class="No-Break"><span class="koboSpan" id="kobo.941.1">VM instance:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.942.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.943.1">azurerm_linux_virtual_machine</span></strong><span class="koboSpan" id="kobo.944.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.945.1">vm_target</span></strong><span class="koboSpan" id="kobo.946.1">" {
  name                  = "</span><strong class="bold"><span class="koboSpan" id="kobo.947.1">vm-target</span></strong><span class="koboSpan" id="kobo.948.1">"
  location              = var.rg_location
  resource_group_name   = var.rg_name
  size                  = "Standard_D2s_v3"
  network_interface_ids = (
    [azurerm_network_interface.nic_target.id]
  )
  </span><strong class="bold"><span class="koboSpan" id="kobo.949.1">os_disk</span></strong><span class="koboSpan" id="kobo.950.1"> {
    name                 = "os-disk-target"
    caching              = "ReadWrite"
    storage_account_type = "Standard_LRS"
  }
  </span><strong class="bold"><span class="koboSpan" id="kobo.951.1">source_image_reference</span></strong><span class="koboSpan" id="kobo.952.1"> {
    publisher = "Canonical"
    offer     = "0001-com-ubuntu-server-jammy"
    sku       = "22_04-lts-gen2"
    version   = "latest"
  }
  computer_name                   = "vm-target"
  admin_username                  = local.vm_username
  admin_password                  = local.vm_password
  disable_password_authentication = false
  boot_diagnostics {
    storage_account_uri = null
  }
  identity {
    type = "SystemAssigned"
  }
  </span><strong class="bold"><span class="koboSpan" id="kobo.953.1">custom_data</span></strong><span class="koboSpan" id="kobo.954.1"> = (
    base64encode(
      templatefile(
        "</span><strong class="bold"><span class="koboSpan" id="kobo.955.1">${path.module}/boot-script.sh</span></strong><span class="koboSpan" id="kobo.956.1">",
        {}
      )
    )
  )
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.957.1">Can you see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.958.1">identity</span></strong><span class="koboSpan" id="kobo.959.1"> block, where </span><strong class="source-inline"><span class="koboSpan" id="kobo.960.1">type = "SystemAssigned"</span></strong><span class="koboSpan" id="kobo.961.1">? </span><span class="koboSpan" id="kobo.961.2">This VM instance will be configured (in the next set of steps) with a system-assigned </span><a id="_idIndexMarker654"/><span class="koboSpan" id="kobo.962.1">managed identity that will be used</span><a id="_idIndexMarker655"/><span class="koboSpan" id="kobo.963.1"> to authenticate and authorize this resource when we’re interacting with other Azure services or resources, such as Azure </span><span class="No-Break"><span class="koboSpan" id="kobo.964.1">Key Vault.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.965.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.966.1">What does this mean for penetration testers? </span><span class="koboSpan" id="kobo.966.2">This means that if we’re able to compromise the VM instance, then we may be able to access other services and resources (such as Azure Key Vault) from within the VM instance without having to specify or </span><span class="No-Break"><span class="koboSpan" id="kobo.967.1">provide credentials.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.968.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.969.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.970.1"> file, let’s define and configure the Azure Key Vault resource. </span><span class="koboSpan" id="kobo.970.2">Make sure you update the</span><a id="_idIndexMarker656"/><span class="koboSpan" id="kobo.971.1"> Key Vault </span><strong class="source-inline"><span class="koboSpan" id="kobo.972.1">name</span></strong><span class="koboSpan" id="kobo.973.1"> value from </span><strong class="source-inline"><span class="koboSpan" id="kobo.974.1">rg-01-key-vault</span></strong><span class="koboSpan" id="kobo.975.1"> to any </span><a id="_idIndexMarker657"/><span class="koboSpan" id="kobo.976.1">unused </span><span class="No-Break"><span class="koboSpan" id="kobo.977.1">vault name:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.978.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.979.1">azurerm_key_vault</span></strong><span class="koboSpan" id="kobo.980.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.981.1">key_vault</span></strong><span class="koboSpan" id="kobo.982.1">" {
  name                        = "</span><strong class="bold"><span class="koboSpan" id="kobo.983.1">rg-01-key-vault</span></strong><span class="koboSpan" id="kobo.984.1">"
  location                    = var.rg_location
  resource_group_name         = var.rg_name
  sku_name                    = "standard"
  tenant_id                   = (
    data.azurerm_client_config.current.tenant_id
  )
  soft_delete_retention_days  = 7
  purge_protection_enabled    = false
  </span><strong class="bold"><span class="koboSpan" id="kobo.985.1">access_policy</span></strong><span class="koboSpan" id="kobo.986.1"> {
    tenant_id = (
      data.azurerm_client_config
          .current.tenant_id
    )
    object_id = (
      azurerm_linux_virtual_machine
        .vm_target
        .identity[0]
        .principal_id
    )
    </span><strong class="bold"><span class="koboSpan" id="kobo.987.1">secret_permissions</span></strong><span class="koboSpan" id="kobo.988.1"> = [
      "Get",
      "Set",
      "List"
    ]
  }
  </span><strong class="bold"><span class="koboSpan" id="kobo.989.1">access_policy</span></strong><span class="koboSpan" id="kobo.990.1"> {
    tenant_id = (
      data.azurerm_client_config
          .current.tenant_id
    )
    object_id = (
      azurerm_user_assigned_identity
          .managed_identity
          .principal_id
    )
    </span><strong class="bold"><span class="koboSpan" id="kobo.991.1">secret_permissions</span></strong><span class="koboSpan" id="kobo.992.1"> = [
      "Get",
      "Set",
      "List"
    ]
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.993.1">Here, the first access policy grants permissions to a principal associated with an Azure Linux VM. </span><span class="koboSpan" id="kobo.993.2">The </span><a id="_idIndexMarker658"/><span class="koboSpan" id="kobo.994.1">specified secret permissions allow the principal to perform operations such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.995.1">Get</span></strong><span class="koboSpan" id="kobo.996.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.997.1">Set</span></strong><span class="koboSpan" id="kobo.998.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.999.1">List</span></strong><span class="koboSpan" id="kobo.1000.1"> on secrets stored in the key vault. </span><span class="koboSpan" id="kobo.1000.2">On the other hand, the</span><a id="_idIndexMarker659"/><span class="koboSpan" id="kobo.1001.1"> second access policy grants permissions to a user-assigned managed identity. </span><span class="koboSpan" id="kobo.1001.2">Similar to the first access policy, the specified secret permissions of the second access policy allow the principal to perform operations such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1002.1">Get</span></strong><span class="koboSpan" id="kobo.1003.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1004.1">Set</span></strong><span class="koboSpan" id="kobo.1005.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1006.1">List</span></strong><span class="koboSpan" id="kobo.1007.1"> on secrets stored in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1008.1">key vault.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1009.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1010.1">Make sure you update the Key Vault </span><strong class="source-inline"><span class="koboSpan" id="kobo.1011.1">name</span></strong><span class="koboSpan" id="kobo.1012.1"> value from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1013.1">rg-01-key-vault</span></strong><span class="koboSpan" id="kobo.1014.1"> to any unused vault name as you’ll encounter the following error (since vault names are globally unique) once you run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1015.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1016.1"> command in a later step: </span><strong class="bold"><span class="koboSpan" id="kobo.1017.1">VaultAlreadyExists — The vault name ‘rg-01-key-vault’ is already in use. </span><span class="koboSpan" id="kobo.1017.2">Vault names are globally unique so it is possible that the name is </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1018.1">already taken.</span></strong></span></p>
<p class="callout"><span class="koboSpan" id="kobo.1019.1">Feel free to add random characters to the Key Vault </span><strong class="source-inline"><span class="koboSpan" id="kobo.1020.1">name</span></strong><span class="koboSpan" id="kobo.1021.1"> value to help ensure that your vault name is globally unique. </span><span class="koboSpan" id="kobo.1021.2">A good example would be </span><strong class="source-inline"><span class="koboSpan" id="kobo.1022.1">rg-01-key-vault-a1b2c3d4</span></strong><span class="koboSpan" id="kobo.1023.1">. </span><span class="koboSpan" id="kobo.1023.2">Of course, try something else as other readers of this book may use the same vault name! </span><span class="koboSpan" id="kobo.1023.3">Finally, we have to update the key vault name specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1024.1">target_vm/boot-script.sh</span></strong><span class="koboSpan" id="kobo.1025.1"> file as well. </span><span class="koboSpan" id="kobo.1025.2">You should find the following line at the end of the script: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1026.1">az keyvault secret set --vault-name rg-01-key-vault --name "flag2" --value "FLAG # </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1027.1">2!"</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1028.1">.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1029.1">Let’s define the </span><a id="_idIndexMarker660"/><span class="koboSpan" id="kobo.1030.1">managed identity in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1031.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1032.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1033.1">as well:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1034.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.1035.1">azurerm_user_assigned_identity</span></strong><span class="koboSpan" id="kobo.1036.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.1037.1">managed_identity</span></strong><span class="koboSpan" id="kobo.1038.1">" {
  name                = "managed-identity"
  location            = var.rg_location
  resource_group_name = var.rg_name
}</span></pre></li> <li><span class="koboSpan" id="kobo.1039.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1040.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1041.1"> file, define the following data blocks. </span><span class="koboSpan" id="kobo.1041.2">These will be used when we </span><a id="_idIndexMarker661"/><span class="koboSpan" id="kobo.1042.1">set up the permissions and </span><span class="No-Break"><span class="koboSpan" id="kobo.1043.1">role assignments:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1044.1">
data "</span><strong class="bold"><span class="koboSpan" id="kobo.1045.1">azurerm_client_config</span></strong><span class="koboSpan" id="kobo.1046.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.1047.1">current</span></strong><span class="koboSpan" id="kobo.1048.1">" {}
data "</span><strong class="bold"><span class="koboSpan" id="kobo.1049.1">azurerm_subscription</span></strong><span class="koboSpan" id="kobo.1050.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.1051.1">current</span></strong><span class="koboSpan" id="kobo.1052.1">" {}</span></pre></li> <li><span class="koboSpan" id="kobo.1053.1">Next, define the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1054.1">role assignment:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1055.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.1056.1">azurerm_role_assignment</span></strong><span class="koboSpan" id="kobo.1057.1">" "role_assignment_01" {
  </span><strong class="bold"><span class="koboSpan" id="kobo.1058.1">scope</span></strong><span class="koboSpan" id="kobo.1059.1">                = (
    "/subscriptions/${(
      data.azurerm_subscription
          .current
          .subscription_id
     )}/resourceGroups/${var.rg_name}"
  )
  </span><strong class="bold"><span class="koboSpan" id="kobo.1060.1">role_definition_name</span></strong><span class="koboSpan" id="kobo.1061.1"> = "Contributor"
  </span><strong class="bold"><span class="koboSpan" id="kobo.1062.1">principal_id</span></strong><span class="koboSpan" id="kobo.1063.1">         = (
    azurerm_user_assigned_identity
      .managed_identity
      .principal_id
  )
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1064.1">This role assignment grants the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1065.1">Contributor</span></strong><span class="koboSpan" id="kobo.1066.1"> role to a user-assigned managed identity within</span><a id="_idIndexMarker662"/><span class="koboSpan" id="kobo.1067.1"> the specified resource group (in this case, it would be </span><strong class="source-inline"><span class="koboSpan" id="kobo.1068.1">resource-group-01</span></strong><span class="koboSpan" id="kobo.1069.1">). </span><span class="koboSpan" id="kobo.1069.2">Assigning the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1070.1">Contributor</span></strong><span class="koboSpan" id="kobo.1071.1"> role means that the managed identity will have the necessary permissions to manage resources within the specified</span><a id="_idIndexMarker663"/><span class="koboSpan" id="kobo.1072.1"> resource group, such as creating, modifying, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1073.1">deleting resources.</span></span></p></li> <li><span class="koboSpan" id="kobo.1074.1">Let’s define the following role assignment </span><span class="No-Break"><span class="koboSpan" id="kobo.1075.1">as well:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1076.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.1077.1">azurerm_role_assignment</span></strong><span class="koboSpan" id="kobo.1078.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.1079.1">role_assignment_02</span></strong><span class="koboSpan" id="kobo.1080.1">" {
  </span><strong class="bold"><span class="koboSpan" id="kobo.1081.1">scope</span></strong><span class="koboSpan" id="kobo.1082.1">                = (
    "/subscriptions/${(
      data.azurerm_subscription
          .current
          .subscription_id
    )}/resourceGroups/${var.rg_name}"
  )
  </span><strong class="bold"><span class="koboSpan" id="kobo.1083.1">role_definition_name</span></strong><span class="koboSpan" id="kobo.1084.1"> = "Contributor"
  </span><strong class="bold"><span class="koboSpan" id="kobo.1085.1">principal_id</span></strong><span class="koboSpan" id="kobo.1086.1">         = (
    azurerm_linux_virtual_machine
      .vm_target
      .identity[0]
      .principal_id
    )
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1087.1">This role assignment grants the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1088.1">Contributor</span></strong><span class="koboSpan" id="kobo.1089.1"> role to the principal associated with an Azure Linux</span><a id="_idIndexMarker664"/><span class="koboSpan" id="kobo.1090.1"> VM within the specified resource group (in this case, it would be </span><strong class="source-inline"><span class="koboSpan" id="kobo.1091.1">resource-group-01</span></strong><span class="koboSpan" id="kobo.1092.1">). </span><span class="koboSpan" id="kobo.1092.2">This means the principal will have the necessary permissions</span><a id="_idIndexMarker665"/><span class="koboSpan" id="kobo.1093.1"> to manage resources within the specified resource group, such as creating, modifying, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1094.1">deleting resources.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1095.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1096.1">Make sure you save the changes you’ve made to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1097.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1098.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1099.1">before proceeding.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.1100.1">With the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1101.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1102.1"> file ready, let’s open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1103.1">target_vm/outputs.tf</span></strong><span class="koboSpan" id="kobo.1104.1"> file in the editor. </span><span class="koboSpan" id="kobo.1104.2">Add the following blocks of code to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1105.1">target_vm/outputs.tf</span></strong><span class="koboSpan" id="kobo.1106.1"> to define the outputs of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1107.1">target_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1108.1"> module:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1109.1">
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1110.1">vm_target_private_ip</span></strong><span class="koboSpan" id="kobo.1111.1">" {
  value = (azurerm_linux_virtual_machine
            .vm_target
            .private_ip_address)
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1112.1">vm_target_public_ip</span></strong><span class="koboSpan" id="kobo.1113.1">" {
  value = (azurerm_linux_virtual_machine
            .vm_target
            .public_ip_address)
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1114.1">vm_username</span></strong><span class="koboSpan" id="kobo.1115.1">" {
  value = local.vm_username
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1116.1">vm_password</span></strong><span class="koboSpan" id="kobo.1117.1">" {
  value = local.vm_password
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1118.1">Make sure you save the changes you’ve made to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1119.1">target_vm/outputs.tf</span></strong><span class="koboSpan" id="kobo.1120.1"> file</span><a id="_idIndexMarker666"/> <span class="No-Break"><span class="koboSpan" id="kobo.1121.1">before proceeding.</span></span></p></li> <li><span class="koboSpan" id="kobo.1122.1">Now, let’s update </span><strong class="source-inline"><span class="koboSpan" id="kobo.1123.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.1124.1"> (inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1125.1">pentest_lab</span></strong><span class="koboSpan" id="kobo.1126.1"> directory) with the following</span><a id="_idIndexMarker667"/><span class="koboSpan" id="kobo.1127.1"> block </span><span class="No-Break"><span class="koboSpan" id="kobo.1128.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1129.1">
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1130.1">vm_target_private_ip</span></strong><span class="koboSpan" id="kobo.1131.1">" {
  value = module.target_vm.vm_target_private_ip
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1132.1">vm_target_public_ip</span></strong><span class="koboSpan" id="kobo.1133.1">" {
  value = module.target_vm.vm_target_public_ip
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1134.1">vm_target_username</span></strong><span class="koboSpan" id="kobo.1135.1">" {
  value = module.target_vm.vm_username
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.1136.1">vm_target_password</span></strong><span class="koboSpan" id="kobo.1137.1">" {
  value = module.target_vm.vm_password
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1138.1">Make sure you save the changes you’ve made to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1139.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.1140.1"> file (in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1141.1">~/pentest_lab</span></strong><span class="koboSpan" id="kobo.1142.1"> directory) </span><span class="No-Break"><span class="koboSpan" id="kobo.1143.1">before proceeding.</span></span></p></li> <li><span class="koboSpan" id="kobo.1144.1">Let’s update the key vault </span><strong class="source-inline"><span class="koboSpan" id="kobo.1145.1">name</span></strong><span class="koboSpan" id="kobo.1146.1"> value specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1147.1">target_vm/boot-script.sh</span></strong><span class="koboSpan" id="kobo.1148.1"> file. </span><span class="koboSpan" id="kobo.1148.2">You</span><a id="_idIndexMarker668"/><span class="koboSpan" id="kobo.1149.1"> should find the following line at the end of </span><span class="No-Break"><span class="koboSpan" id="kobo.1150.1">the script:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1151.1">
az keyvault secret set --vault-name </span><strong class="bold"><span class="koboSpan" id="kobo.1152.1">rg-01-key-vault</span></strong><span class="koboSpan" id="kobo.1153.1"> --name "flag2" --value "FLAG # 2!"</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1154.1">Make sure you</span><a id="_idIndexMarker669"/><span class="koboSpan" id="kobo.1155.1"> replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1156.1">rg-01-key-vault</span></strong><span class="koboSpan" id="kobo.1157.1"> with the vault name you configured for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1158.1">azure_rm_key_vault.key_vault</span></strong><span class="koboSpan" id="kobo.1159.1"> resource defined </span><span class="No-Break"><span class="koboSpan" id="kobo.1160.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1161.1">target_vm/main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1162.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.1163.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1164.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1165.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1166.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1167.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1168.1">Upon running the command, we should encounter multiple </span><strong class="bold"><span class="koboSpan" id="kobo.1169.1">Missing required </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1170.1">argument</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1171.1"> errors.</span></span></p></li> <li><span class="koboSpan" id="kobo.1172.1">Let’s locate the following block of code in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1173.1">main.tf</span></strong><span class="koboSpan" id="kobo.1174.1"> file (inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1175.1">pentest_lab</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1176.1"> directory):</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1177.1">
module "target_vm" {
  source = "./target_vm"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1178.1">Update it with the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.1179.1">of code:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1180.1">module "target_vm" {
  source = "./target_vm"
  </span><strong class="bold"><span class="koboSpan" id="kobo.1181.1">rg_location = module.secure_network.rg_01_location</span></strong><span class="koboSpan" id="kobo.1182.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.1183.1">rg_name = module.secure_network.rg_01_name</span></strong><span class="koboSpan" id="kobo.1184.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.1185.1">subnet = module.secure_network.subnet_01</span></strong><span class="koboSpan" id="kobo.1186.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.1187.1">asg = module.secure_network.asg_01</span></strong><span class="koboSpan" id="kobo.1188.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.1189.1">nsg = module.secure_network.nsg_01</span></strong><span class="koboSpan" id="kobo.1190.1">
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1191.1">Make sure you </span><a id="_idIndexMarker670"/><span class="koboSpan" id="kobo.1192.1">save the file </span><span class="No-Break"><span class="koboSpan" id="kobo.1193.1">before proceeding.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1194.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1195.1">It is important to note that compared to how the target VM instance was prepared in </span><span class="No-Break"><em class="italic"><a href="B19755_04.xhtml"><span class="koboSpan" id="kobo.1196.1">Chapter 4</span></a></em></span><span class="koboSpan" id="kobo.1197.1">, there is no waiting mechanism in this chapter’s implementation. </span><span class="koboSpan" id="kobo.1197.2">Feel free to utilize the same technique from the previous chapter and upgrade the </span><span class="No-Break"><span class="koboSpan" id="kobo.1198.1">current implementation.</span></span></p>
<ol>
<li value="19"><span class="koboSpan" id="kobo.1199.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1200.1">terraform plan</span></strong><span class="koboSpan" id="kobo.1201.1"> to preview </span><a id="_idIndexMarker671"/><span class="koboSpan" id="kobo.1202.1">the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.1203.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1204.1">terraform plan</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1205.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1206.1">Running this command may yield a few deprecation warnings. </span><span class="koboSpan" id="kobo.1206.2">This should be okay, so long as we can successfully run the command </span><span class="No-Break"><span class="koboSpan" id="kobo.1207.1">without errors.</span></span></p>
<ol>
<li value="20"><span class="koboSpan" id="kobo.1208.1">Next, let’s use</span><a id="_idIndexMarker672"/><span class="koboSpan" id="kobo.1209.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1210.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1211.1"> command to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.1212.1">the changes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1213.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1214.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.1215.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1216.1">vm_target_password = "..."
</span><span class="koboSpan" id="kobo.1216.2">vm_target_private_ip = "..."
</span><span class="koboSpan" id="kobo.1216.3">vm_target_public_ip = "..."
</span><span class="koboSpan" id="kobo.1216.4">vm_target_username = "testuser"</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1217.1">Make sure you copy the output values into a text editor on your local machine as we will use these</span><a id="_idIndexMarker673"/><span class="koboSpan" id="kobo.1218.1"> values in the succeeding sections in </span><span class="No-Break"><span class="koboSpan" id="kobo.1219.1">this chapter.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1220.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1221.1">Make sure you update the Key Vault </span><strong class="source-inline"><span class="koboSpan" id="kobo.1222.1">name</span></strong><span class="koboSpan" id="kobo.1223.1"> value (defined in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1224.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1225.1">) to any unused vault name in case you encounter an error message similar to </span><strong class="bold"><span class="koboSpan" id="kobo.1226.1">VaultAlreadyExists — The vault name ‘rg-01-key-vault’ is already in use. </span><span class="koboSpan" id="kobo.1226.2">Vault names are globally unique so it is possible that the name is already taken</span></strong><span class="koboSpan" id="kobo.1227.1">. </span><span class="koboSpan" id="kobo.1227.2">Feel free to add random characters to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1228.1">name</span></strong><span class="koboSpan" id="kobo.1229.1"> value to help ensure that your vault name is globally unique (for </span><span class="No-Break"><span class="koboSpan" id="kobo.1230.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1231.1">rg-01-key-vault-a1b2c3d4</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1232.1">).</span></span></p>
<h2 id="_idParaDest-103"><a id="_idTextAnchor102"/><span class="koboSpan" id="kobo.1233.1">Part 2 of 2 – Verifying our target VM instance setup</span></h2>
<p><span class="koboSpan" id="kobo.1234.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1235.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1236.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.1237.1">Overview</span></strong><span class="koboSpan" id="kobo.1238.1"> blade </span><a id="_idIndexMarker674"/><span class="koboSpan" id="kobo.1239.1">of the target </span><a id="_idIndexMarker675"/><span class="koboSpan" id="kobo.1240.1">VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1241.1">vm-target</span></strong><span class="koboSpan" id="kobo.1242.1">) by (1) typing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1243.1">vm-target</span></strong><span class="koboSpan" id="kobo.1244.1"> in the search bar and then (2) selecting </span><strong class="bold"><span class="koboSpan" id="kobo.1245.1">vm-target — Virtual machine</span></strong><span class="koboSpan" id="kobo.1246.1"> from the list of search results. </span><span class="koboSpan" id="kobo.1246.2">Locate and select </span><strong class="bold"><span class="koboSpan" id="kobo.1247.1">Serial console</span></strong><span class="koboSpan" id="kobo.1248.1"> under the </span><strong class="bold"><span class="koboSpan" id="kobo.1249.1">Help</span></strong><span class="koboSpan" id="kobo.1250.1"> section of the resource menu in the left pane to open a serial </span><span class="No-Break"><span class="koboSpan" id="kobo.1251.1">console pane.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1252.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1253.1">You may simply close Cloud Shell and refresh the page (or open the page in a new browser tab) if you are having issues loading the serial </span><span class="No-Break"><span class="koboSpan" id="kobo.1254.1">console Terminal.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1255.1">Press </span><em class="italic"><span class="koboSpan" id="kobo.1256.1">Enter</span></em><span class="koboSpan" id="kobo.1257.1"> to load the </span><strong class="bold"><span class="koboSpan" id="kobo.1258.1">vm-target login</span></strong><span class="koboSpan" id="kobo.1259.1"> prompt. </span><span class="koboSpan" id="kobo.1259.2">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1260.1">vm_target_username</span></strong><span class="koboSpan" id="kobo.1261.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1262.1">testuser</span></strong><span class="koboSpan" id="kobo.1263.1">) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1264.1">vm_target_password</span></strong><span class="koboSpan" id="kobo.1265.1"> (</span><em class="italic"><span class="koboSpan" id="kobo.1266.1">randomly generated</span></em><span class="koboSpan" id="kobo.1267.1">) output values </span><a id="_idIndexMarker676"/><span class="koboSpan" id="kobo.1268.1">to authenticate and </span><a id="_idIndexMarker677"/><span class="koboSpan" id="kobo.1269.1">log in using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1270.1">serial console.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1271.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1272.1">Feel free to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1273.1">terraform show</span></strong><span class="koboSpan" id="kobo.1274.1"> command in the Cloud Shell Terminal (inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1275.1">~/pentest_lab</span></strong><span class="koboSpan" id="kobo.1276.1"> directory) if you were not able to copy the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1277.1">vm_target_username</span></strong><span class="koboSpan" id="kobo.1278.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1279.1">testuser</span></strong><span class="koboSpan" id="kobo.1280.1">) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1281.1">vm_target_password</span></strong><span class="koboSpan" id="kobo.1282.1"> output values to the text editor on your </span><span class="No-Break"><span class="koboSpan" id="kobo.1283.1">local machine.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1284.1">Let’s start by checking if the Metasploitable 2 container is running (by executing the following command after the </span><strong class="bold"><span class="koboSpan" id="kobo.1285.1">$</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1286.1">sign):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1287.1">sudo docker ps</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1288.1">Feel free to wait and try running the same command after a few minutes in case the vulnerable container does not appear after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1289.1">sudo docker </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1290.1">ps</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1291.1"> command.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1292.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1293.1">If you are having issues setting up and configuring the target VM instance, simply open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1294.1">/var/log/</span></strong><span class="koboSpan" id="kobo.1295.1"> directory and troubleshoot using the logs generated by the installation and boot scripts. </span><span class="koboSpan" id="kobo.1295.2">For example, you may run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1296.1">cat /var/log/syslog | grep STEP</span></strong><span class="koboSpan" id="kobo.1297.1"> to check which steps from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1298.1">boot-script.sh</span></strong><span class="koboSpan" id="kobo.1299.1"> script file have already been executed inside the target </span><span class="No-Break"><span class="koboSpan" id="kobo.1300.1">VM instance.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1301.1">In addition to this, check</span><a id="_idIndexMarker678"/><span class="koboSpan" id="kobo.1302.1"> if we can </span><a id="_idIndexMarker679"/><span class="koboSpan" id="kobo.1303.1">authenticate using the system-assigned </span><span class="No-Break"><span class="koboSpan" id="kobo.1304.1">managed identity:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1305.1">az login --identity</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1306.1">This should return </span><span class="No-Break"><span class="koboSpan" id="kobo.1307.1">the following:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1308.1">[
  {
    "environmentName": "AzureCloud",
    "homeTenantId": "...",
    "id": "...",
    "isDefault": true,
    "managedByTenants": [],
    "name": "Azure subscription 1",
    "state": "Enabled",
    "tenantId": "...",
    "user": {
      "assignedIdentityInfo": "MSI",
      "name": "systemAssignedIdentity",
      "type": "servicePrincipal"
    }
  }
]</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1309.1">This means that we should be able to authenticate and perform specific actions in Azure without (explicitly) </span><span class="No-Break"><span class="koboSpan" id="kobo.1310.1">requiring credentials</span></span></p></li> <li><span class="koboSpan" id="kobo.1311.1">Let’s also verify if we’re able to list </span><span class="No-Break"><span class="koboSpan" id="kobo.1312.1">the vaults:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1313.1">az keyvault list</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1314.1">This should return a </span><a id="_idIndexMarker680"/><span class="koboSpan" id="kobo.1315.1">nested JSON structure </span><a id="_idIndexMarker681"/><span class="koboSpan" id="kobo.1316.1">similar to what we </span><span class="No-Break"><span class="koboSpan" id="kobo.1317.1">have here:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1318.1">[
  {
    "id": "...",
    "location": "eastus",
    "name": "rg-01-key-vault",
    "resourceGroup": "resource-group-01",
    "tags": {},
    "type": "Microsoft.KeyVault/vaults"
  }
]</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1319.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1320.1">Note that you’ll get a different vault name value depending on how you configured the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1321.1">azurerm_key_vault.keyvault</span></strong><span class="koboSpan" id="kobo.1322.1"> resource in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1323.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1324.1"> Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.1325.1">configuration file.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1326.1">Finally, let’s run the following command to list all the secrets stored </span><span class="No-Break"><span class="koboSpan" id="kobo.1327.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1328.1">rg-01-key-vault</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1329.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1330.1">az keyvault secret list --vault-name rg-01-key-vault</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1331.1">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1332.1">rg-01-key-vault</span></strong><span class="koboSpan" id="kobo.1333.1"> with the actual key vault name that you retrieved after running the command from the previous step. </span><span class="koboSpan" id="kobo.1333.2">Running the command should return a list with a single nested JSON value corresponding to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1334.1">flag2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1335.1"> secret.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1336.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1337.1">If the previous command returned an empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.1338.1">[]</span></strong><span class="koboSpan" id="kobo.1339.1"> value, make sure that the vault names specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1340.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.1341.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1342.1">target_vm/boot-script.sh</span></strong><span class="koboSpan" id="kobo.1343.1"> files are the same. </span><span class="koboSpan" id="kobo.1343.2">After updating the files, feel free to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1344.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1345.1"> command again to apply the changes you’ve made to these files and rebuild the target VM instance, which will run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1346.1">boot-script.sh</span></strong><span class="koboSpan" id="kobo.1347.1"> again. </span><span class="koboSpan" id="kobo.1347.2">To help you troubleshoot and resolve issues, you may delete the resources (using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1348.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.1349.1">) and then create the resources again (using </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1350.1">terraform apply</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1351.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.1352.1">At this stage, you might</span><a id="_idIndexMarker682"/><span class="koboSpan" id="kobo.1353.1"> be excited to explore and attack the target resources already! </span><span class="koboSpan" id="kobo.1353.2">Given that we have intentionally configured the network environment to only allow resources in </span><em class="italic"><span class="koboSpan" id="kobo.1354.1">VNet 02</span></em><span class="koboSpan" id="kobo.1355.1"> to access </span><em class="italic"><span class="koboSpan" id="kobo.1356.1">VNet 01</span></em><span class="koboSpan" id="kobo.1357.1"> (where the target VM </span><a id="_idIndexMarker683"/><span class="koboSpan" id="kobo.1358.1">instance is launched), we will have to set up our attacker VM instance in </span><em class="italic"><span class="koboSpan" id="kobo.1359.1">VNet 02</span></em><span class="koboSpan" id="kobo.1360.1"> first before we can access the vulnerable-by-design application, along with performing a penetration testing simulation inside the </span><span class="No-Break"><span class="koboSpan" id="kobo.1361.1">network environment.</span></span></p>
<h1 id="_idParaDest-104"><a id="_idTextAnchor103"/><span class="koboSpan" id="kobo.1362.1">Manually setting up the attacker VM instance</span></h1>
<p><span class="koboSpan" id="kobo.1363.1">With our peered network </span><a id="_idIndexMarker684"/><span class="koboSpan" id="kobo.1364.1">environment setup ready (with the target resources running inside it), we can now proceed with setting up our Kali Linux attacker. </span><span class="koboSpan" id="kobo.1364.2">In the previous chapter, we took a step-by-step approach to setting up and configuring the attacker VM instance. </span><span class="koboSpan" id="kobo.1364.3">In this chapter, we will optimize things a bit and make use of a couple of scripts to further speed up the </span><span class="No-Break"><span class="koboSpan" id="kobo.1365.1">installation process.</span></span></p>
<p><span class="koboSpan" id="kobo.1366.1">That said, we will divide this section into </span><span class="No-Break"><span class="koboSpan" id="kobo.1367.1">two parts:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.1368.1">Part 1 of 2 – Manually launching and configuring the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1369.1">attacker instance</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1370.1">Part 2 of 2 – Verifying that our setup </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1371.1">is working</span></em></span></li>
</ul>
<h2 id="_idParaDest-105"><a id="_idTextAnchor104"/><span class="koboSpan" id="kobo.1372.1">Part 1 of 2 – Manually launching and setting up the attacker instance</span></h2>
<p><span class="koboSpan" id="kobo.1373.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1374.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1375.1">In the search </span><a id="_idIndexMarker685"/><span class="koboSpan" id="kobo.1376.1">bar, type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1377.1">virtual machines</span></strong><span class="koboSpan" id="kobo.1378.1"> and </span><a id="_idIndexMarker686"/><span class="No-Break"><span class="koboSpan" id="kobo.1379.1">press </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1380.1">Enter</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1381.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer121">
<span class="koboSpan" id="kobo.1382.1"><img alt="" src="image/B19755_05_010.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1383.1">Figure 5.10 – Navigating to the Virtual machines page</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1384.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.1385.1">Virtual machines</span></strong><span class="koboSpan" id="kobo.1386.1"> from the list of available options to navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.1387.1">Virtual </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1388.1">machines</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1389.1"> page.</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1390.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.1391.1">Virtual machines</span></strong><span class="koboSpan" id="kobo.1392.1"> page, click</span><a id="_idIndexMarker687"/><span class="koboSpan" id="kobo.1393.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.1394.1">Create</span></strong><span class="koboSpan" id="kobo.1395.1"> button. </span><span class="koboSpan" id="kobo.1395.2">Choose </span><strong class="bold"><span class="koboSpan" id="kobo.1396.1">Azure virtual machine</span></strong><span class="koboSpan" id="kobo.1397.1"> from the list of options from the </span><span class="No-Break"><span class="koboSpan" id="kobo.1398.1">drop-down menu.</span></span></li>
<li><span class="koboSpan" id="kobo.1399.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.1400.1">Create a virtual machine</span></strong><span class="koboSpan" id="kobo.1401.1"> page, specify the following configuration values under the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1402.1">Basics</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1403.1"> tab:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.1404.1">Project details</span></strong><span class="koboSpan" id="kobo.1405.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1406.1">Subscription</span></strong><span class="koboSpan" id="kobo.1407.1">: Use </span><span class="No-Break"><span class="koboSpan" id="kobo.1408.1">existing subscription</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1409.1">Project details</span></strong><span class="koboSpan" id="kobo.1410.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1411.1">Resource </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1412.1">group</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1413.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1414.1">resource-group-02</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1415.1">Instance details</span></strong><span class="koboSpan" id="kobo.1416.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1417.1">Virtual machine </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1418.1">name</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1419.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1420.1">kali-00</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1421.1">Instance details</span></strong><span class="koboSpan" id="kobo.1422.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1423.1">Region</span></strong><span class="koboSpan" id="kobo.1424.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1425.1">(US) </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1426.1">East US</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1427.1">Instance details</span></strong><span class="koboSpan" id="kobo.1428.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1429.1">Security </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1430.1">type</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1431.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1432.1">Standard</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1433.1">Instance details</span></strong><span class="koboSpan" id="kobo.1434.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1435.1">Image</span></strong><span class="koboSpan" id="kobo.1436.1">: Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1437.1">See all </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1438.1">images</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1439.1"> link</span></span></li></ul></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1440.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1441.1">Clicking </span><strong class="bold"><span class="koboSpan" id="kobo.1442.1">See all images</span></strong><span class="koboSpan" id="kobo.1443.1"> will redirect you to the </span><strong class="bold"><span class="koboSpan" id="kobo.1444.1">Select an </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1445.1">image</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1446.1"> page.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1447.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.1448.1">Select an image</span></strong><span class="koboSpan" id="kobo.1449.1"> page, type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1450.1">kali</span></strong><span class="koboSpan" id="kobo.1451.1"> in the search </span><a id="_idIndexMarker688"/><span class="koboSpan" id="kobo.1452.1">box and then </span><span class="No-Break"><span class="koboSpan" id="kobo.1453.1">press </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1454.1">Enter</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1455.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer122">
<span class="koboSpan" id="kobo.1456.1"><img alt="" src="image/B19755_05_011.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1457.1">Figure 5.11 – Selecting the Kali Linux image</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1458.1">Choose </span><strong class="bold"><span class="koboSpan" id="kobo.1459.1">Kali Linux — The Most Advanced Penetration Testing Distribution. </span><span class="koboSpan" id="kobo.1459.2">Ever.</span></strong><span class="koboSpan" id="kobo.1460.1"> by clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.1461.1">Select</span></strong><span class="koboSpan" id="kobo.1462.1"> button, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1463.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1464.1">.11</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1465.1">.</span></span></p></li>
</ol>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1466.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.1467.1">Kali 2022.3 – x64 Gen 2</span></strong><span class="koboSpan" id="kobo.1468.1"> (or if there </span><a id="_idIndexMarker689"/><span class="koboSpan" id="kobo.1469.1">are other newer versions, choose the first one from the list of options). </span><span class="koboSpan" id="kobo.1469.2">This should redirect you back to the </span><strong class="bold"><span class="koboSpan" id="kobo.1470.1">Create a virtual </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1471.1">machine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1472.1"> page.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1473.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1474.1">If you are having issues selecting the Kali Linux image and making it reflect in the drop-down menu as the selected image (even if the </span><strong class="bold"><span class="koboSpan" id="kobo.1475.1">Security type</span></strong><span class="koboSpan" id="kobo.1476.1"> configuration is already set to </span><strong class="bold"><span class="koboSpan" id="kobo.1477.1">Standard</span></strong><span class="koboSpan" id="kobo.1478.1">), simply refresh the page and then try again. </span><span class="koboSpan" id="kobo.1478.2">Note that you will need to input the VM configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.1479.1">settings again.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1480.1">Continuing where we left off on the </span><strong class="bold"><span class="koboSpan" id="kobo.1481.1">Create a virtual machine</span></strong><span class="koboSpan" id="kobo.1482.1"> page, specify the following configuration</span><a id="_idIndexMarker690"/><span class="koboSpan" id="kobo.1483.1"> values under the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1484.1">Basics</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1485.1"> tab:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.1486.1">Administrator account</span></strong><span class="koboSpan" id="kobo.1487.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1488.1">Authentication </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1489.1">type</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1490.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1491.1">Password</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1492.1">Administrator account</span></strong><span class="koboSpan" id="kobo.1493.1"> &gt; </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1494.1">Username</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1495.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1496.1">kali_admin</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1497.1">Administrator account</span></strong><span class="koboSpan" id="kobo.1498.1"> &gt; </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1499.1">Password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1500.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1501.1">KaliLinux1234!!!</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1502.1">Administrator account</span></strong><span class="koboSpan" id="kobo.1503.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1504.1">Confirm </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1505.1">password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1506.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1507.1">KaliLinux1234!!!</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1508.1">Inbound port rules</span></strong><span class="koboSpan" id="kobo.1509.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1510.1">Public inbound </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1511.1">ports</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1512.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1513.1">None</span></strong></span></li></ul><p class="list-inset"><span class="koboSpan" id="kobo.1514.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1515.1">Next : Disks &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1516.1">button afterward.</span></span></p></li>
<li><span class="koboSpan" id="kobo.1517.1">Accept the default configuration</span><a id="_idIndexMarker691"/><span class="koboSpan" id="kobo.1518.1"> under the </span><strong class="bold"><span class="koboSpan" id="kobo.1519.1">Disks</span></strong><span class="koboSpan" id="kobo.1520.1"> tab and click </span><strong class="bold"><span class="koboSpan" id="kobo.1521.1">Next : </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1522.1">Networking &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1523.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1524.1">Under the </span><strong class="bold"><span class="koboSpan" id="kobo.1525.1">Networking</span></strong><span class="koboSpan" id="kobo.1526.1"> tab, make sure that the following configuration values </span><span class="No-Break"><span class="koboSpan" id="kobo.1527.1">are set:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.1528.1">Virtual </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1529.1">network</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1530.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1531.1">vnet-02</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1532.1">Subnet</span></strong><span class="koboSpan" id="kobo.1533.1">: </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1534.1">subnet-02 (192.168.1.0/24)</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1535.1">NIC network security </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1536.1">group</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1537.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1538.1">Advanced</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1539.1">Configure network security </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1540.1">group</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1541.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1542.1">nsg-02</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1543.1">Delete public IP and NIC when VM </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1544.1">is deleted</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1545.1">:</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1546.1">(checked)</span></strong></span></li></ul></li>
<li><span class="koboSpan" id="kobo.1547.1">Now, continue clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.1548.1">Next</span></strong><span class="koboSpan" id="kobo.1549.1"> button until you reach the </span><span class="No-Break"><span class="koboSpan" id="kobo.1550.1">last tab.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1551.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1552.1">Simply accept the default settings under </span><strong class="bold"><span class="koboSpan" id="kobo.1553.1">Disks</span></strong><span class="koboSpan" id="kobo.1554.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1555.1">Networking</span></strong><span class="koboSpan" id="kobo.1556.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1557.1">Management</span></strong><span class="koboSpan" id="kobo.1558.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1559.1">Monitoring</span></strong><span class="koboSpan" id="kobo.1560.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1561.1">Advanced</span></strong><span class="koboSpan" id="kobo.1562.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1563.1">Tags</span></strong><span class="koboSpan" id="kobo.1564.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.1565.1">Review + </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1566.1">create</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1567.1">.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1568.1">Once you reach the </span><strong class="bold"><span class="koboSpan" id="kobo.1569.1">Review + create</span></strong><span class="koboSpan" id="kobo.1570.1"> tab, click the </span><strong class="bold"><span class="koboSpan" id="kobo.1571.1">Create</span></strong><span class="koboSpan" id="kobo.1572.1"> button after reviewing the </span><span class="No-Break"><span class="koboSpan" id="kobo.1573.1">configuration details.</span></span></li>
<li><span class="koboSpan" id="kobo.1574.1">Wait until you see the </span><strong class="bold"><span class="koboSpan" id="kobo.1575.1">Your deployment is complete</span></strong><span class="koboSpan" id="kobo.1576.1"> message. </span><span class="koboSpan" id="kobo.1576.2">Scroll down and click the </span><strong class="bold"><span class="koboSpan" id="kobo.1577.1">Go to resource</span></strong><span class="koboSpan" id="kobo.1578.1"> button. </span><span class="koboSpan" id="kobo.1578.2">This should redirect you to the </span><strong class="bold"><span class="koboSpan" id="kobo.1579.1">Overview</span></strong><span class="koboSpan" id="kobo.1580.1"> blade of the VM we just </span><span class="No-Break"><span class="koboSpan" id="kobo.1581.1">created (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1582.1">kali-00</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1583.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.1584.1">Locate and select </span><strong class="bold"><span class="koboSpan" id="kobo.1585.1">Serial console</span></strong><span class="koboSpan" id="kobo.1586.1"> under the </span><strong class="bold"><span class="koboSpan" id="kobo.1587.1">Help</span></strong><span class="koboSpan" id="kobo.1588.1"> section of the resource menu in the left pane to open a</span><a id="_idIndexMarker692"/><span class="koboSpan" id="kobo.1589.1"> serial </span><span class="No-Break"><span class="koboSpan" id="kobo.1590.1">console pane.</span></span></li>
<li><span class="koboSpan" id="kobo.1591.1">Once the serial console has loaded, press </span><em class="italic"><span class="koboSpan" id="kobo.1592.1">Enter</span></em><span class="koboSpan" id="kobo.1593.1"> to continue to the </span><strong class="bold"><span class="koboSpan" id="kobo.1594.1">kali login:</span></strong><span class="koboSpan" id="kobo.1595.1"> prompt. </span><span class="koboSpan" id="kobo.1595.2">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1596.1">kali_admin</span></strong><span class="koboSpan" id="kobo.1597.1"> for the username and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1598.1">KaliLinux1234!!!</span></strong><span class="koboSpan" id="kobo.1599.1"> for the password </span><span class="No-Break"><span class="koboSpan" id="kobo.1600.1">to</span></span><span class="No-Break"><a id="_idIndexMarker693"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1601.1"> proceed.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1602.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1603.1">If you see a bunch of question mark characters before the prompt (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1604.1">?????????????????????????kali_admin@kali:~$</span></strong><span class="koboSpan" id="kobo.1605.1">), simply ignore these </span><span class="No-Break"><span class="koboSpan" id="kobo.1606.1">extra characters.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.1607.1">Download the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1608.1">kali_setup.sh</span></strong><span class="koboSpan" id="kobo.1609.1"> script by running the following commands (after the </span><strong class="bold"><span class="koboSpan" id="kobo.1610.1">$</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1611.1">sign):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1612.1">SCRIPT_URL=</span></strong><a href="https://bit.ly/kali-desktop-setup"><strong class="bold"><span class="koboSpan" id="kobo.1613.1">https://bit.ly/kali-desktop-setup</span></strong></a>
<strong class="bold"><span class="koboSpan" id="kobo.1614.1">wget -O kali_setup.sh $SCRIPT_URL</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1615.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1616.1">Note that the shortened link provided simply points to the complete script, which can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.1617.1">at </span></span><a href="https://gist.githubusercontent.com/joshualat/e01be82543c238d7f0a13f4c33f22802/raw/8b6af622f340cdce14f13260a4ca16678f1dbb50/kali_setup.sh"><span class="No-Break"><span class="koboSpan" id="kobo.1618.1">https://gist.githubusercontent.com/joshualat/e01be82543c238d7f0a13f4c33f22802/raw/8b6af622f340cdce14f13260a4ca16678f1dbb50/kali_setup.sh</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1619.1">.</span></span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.1620.1">Let’s check the installation script </span><span class="No-Break"><span class="koboSpan" id="kobo.1621.1">inside </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1622.1">kali_setup.sh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1623.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1624.1">cat kali_setup.sh</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1625.1">This should display the contents of the script, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1626.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1627.1">.12</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1628.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer123">
<span class="koboSpan" id="kobo.1629.1"><img alt="" src="image/B19755_05_012.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1630.1">Figure 5.12 – kali_setup.sh</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1631.1">In case you have forgotten</span><a id="_idIndexMarker694"/><span class="koboSpan" id="kobo.1632.1"> already, this is the same </span><a id="_idIndexMarker695"/><span class="koboSpan" id="kobo.1633.1">set of commands we used in </span><span class="No-Break"><em class="italic"><a href="B19755_04.xhtml"><span class="koboSpan" id="kobo.1634.1">Chapter 4</span></a></em></span><span class="koboSpan" id="kobo.1635.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1636.1">Setting Up Isolated Penetration Testing Lab Environments </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1637.1">on GCP</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1638.1">.</span></span></p></li>
</ol>
<ol>
<li value="16"><span class="koboSpan" id="kobo.1639.1">Let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1640.1">chmod</span></strong><span class="koboSpan" id="kobo.1641.1"> command to make the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1642.1">kali_setup.sh</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1643.1">file executable:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1644.1">chmod +x kali_setup.sh</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1645.1">Download the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1646.1">setup_cron_job.sh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1647.1"> script:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1648.1">SCRIPT_2_URL=</span></strong><a href="https://bit.ly/setup-cron"><strong class="bold"><span class="koboSpan" id="kobo.1649.1">https://bit.ly/setup-cron</span></strong></a>
<strong class="bold"><span class="koboSpan" id="kobo.1650.1">wget -O setup_cron_job.sh $SCRIPT_2_URL</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1651.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1652.1">Note that the shortened link provided simply points to the complete script, which can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.1653.1">at </span></span><a href="https://gist.githubusercontent.com/joshualat/e01be82543c238d7f0a13f4c33f22802/raw/8b6af622f340cdce14f13260a4ca16678f1dbb50/setup_cron_job.sh"><span class="No-Break"><span class="koboSpan" id="kobo.1654.1">https://gist.githubusercontent.com/joshualat/e01be82543c238d7f0a13f4c33f22802/raw/8b6af622f340cdce14f13260a4ca16678f1dbb50/setup_cron_job.sh</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1655.1">.</span></span></p>
<ol>
<li value="18"><span class="koboSpan" id="kobo.1656.1">Let’s check what’s inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1657.1">setup_cron_job.sh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1658.1"> script:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1659.1">cat setup_cron_job.sh</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1660.1">This should display the </span><a id="_idIndexMarker696"/><span class="koboSpan" id="kobo.1661.1">contents of the script, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1662.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1663.1">.13</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1664.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer124">
<span class="koboSpan" id="kobo.1665.1"><img alt="" src="image/B19755_05_013.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1666.1">Figure 5.13 – setup_cron_job.sh</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1667.1">This will configure the</span><a id="_idIndexMarker697"/><span class="koboSpan" id="kobo.1668.1"> VNC server and the noVNC proxy to automatically start upon each </span><span class="No-Break"><span class="koboSpan" id="kobo.1669.1">system reboot.</span></span></p></li>
</ol>
<ol>
<li value="19"><span class="koboSpan" id="kobo.1670.1">Next, let’s make </span><strong class="source-inline"><span class="koboSpan" id="kobo.1671.1">setup_cron_job.sh</span></strong><span class="koboSpan" id="kobo.1672.1"> executable using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1673.1">chmod</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1674.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1675.1">chmod +x setup_cron_job.sh</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1676.1">With everything ready, let’s run the </span><span class="No-Break"><span class="koboSpan" id="kobo.1677.1">first script:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1678.1">sudo ./kali_setup.sh</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1679.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1680.1">This step may take 20-30 minutes to complete. </span><span class="koboSpan" id="kobo.1680.2">Feel free to grab a cup of coffee or tea while waiting. </span><span class="koboSpan" id="kobo.1680.3">Given that it takes a while for the script to finish, you might as well grab a snack and eat that </span><span class="No-Break"><span class="koboSpan" id="kobo.1681.1">as well!</span></span></p>
<ol>
<li value="21"><span class="koboSpan" id="kobo.1682.1">Let’s quickly clear our screen before running the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.1683.1">of commands:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1684.1">clear</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1685.1">Now, let’s run the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1686.1">setup_cron_job.sh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1687.1"> script:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1688.1">sudo ./setup_cron_job.sh</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1689.1">Let’s check if we were able to successfully update the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1690.1">crontab</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1691.1"> configuration:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1692.1">sudo crontab -l</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1693.1">This should yield the</span><a id="_idIndexMarker698"/> <span class="No-Break"><span class="koboSpan" id="kobo.1694.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1695.1">@reboot sleep 60 &amp;&amp; /usr/bin/</span><strong class="bold"><span class="koboSpan" id="kobo.1696.1">vncserver</span></strong><span class="koboSpan" id="kobo.1697.1">
@reboot sleep 60 &amp;&amp; /usr/share/novnc/utils/</span><strong class="bold"><span class="koboSpan" id="kobo.1698.1">novnc_proxy</span></strong><span class="koboSpan" id="kobo.1699.1"> --listen 0.0.0.0:8081 --vnc localhost:5901 &gt;/dev/null 2&gt;&amp;1 &amp;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1700.1">Here, you can see that we’ve configured </span><strong class="source-inline"><span class="koboSpan" id="kobo.1701.1">vncserver</span></strong><span class="koboSpan" id="kobo.1702.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1703.1">novnc_proxy</span></strong><span class="koboSpan" id="kobo.1704.1"> to run after 60 seconds to</span><a id="_idIndexMarker699"/><span class="koboSpan" id="kobo.1705.1"> ensure that the system processes are ready before these </span><span class="No-Break"><span class="koboSpan" id="kobo.1706.1">are run.</span></span></p></li> <li><span class="koboSpan" id="kobo.1707.1">Restart the VM instance using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1708.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1709.1">sudo reboot</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1710.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1711.1">Wait for about 3-5 minutes for the attacker VM instance </span><span class="No-Break"><span class="koboSpan" id="kobo.1712.1">to restart.</span></span></p>
<h2 id="_idParaDest-106"><a id="_idTextAnchor105"/><span class="koboSpan" id="kobo.1713.1">Part 2 of 2 – Verifying that our setup is working</span></h2>
<p><span class="koboSpan" id="kobo.1714.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1715.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1716.1">Once the serial </span><a id="_idIndexMarker700"/><span class="koboSpan" id="kobo.1717.1">console has loaded, press </span><em class="italic"><span class="koboSpan" id="kobo.1718.1">Enter</span></em><span class="koboSpan" id="kobo.1719.1"> to continue to the </span><strong class="bold"><span class="koboSpan" id="kobo.1720.1">kali login:</span></strong><span class="koboSpan" id="kobo.1721.1"> prompt. </span><span class="koboSpan" id="kobo.1721.2">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1722.1">kali_admin</span></strong><span class="koboSpan" id="kobo.1723.1"> for the username and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1724.1">KaliLinux1234!!!</span></strong><span class="koboSpan" id="kobo.1725.1"> for the password </span><span class="No-Break"><span class="koboSpan" id="kobo.1726.1">to proceed.</span></span></li>
<li><span class="koboSpan" id="kobo.1727.1">Let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1728.1">ps</span></strong><span class="koboSpan" id="kobo.1729.1"> command to quickly check if everything has been set up </span><span class="No-Break"><span class="koboSpan" id="kobo.1730.1">as planned:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1731.1">ps -ef | grep vnc</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1732.1">Verify that you see the following running after using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1733.1">ps -ef | grep </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1734.1">vnc</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1735.1"> command:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1736.1">... </span><span class="koboSpan" id="kobo.1736.2">bash /usr/share/novnc/utils/</span><strong class="bold"><span class="koboSpan" id="kobo.1737.1">novnc_proxy</span></strong><span class="koboSpan" id="kobo.1738.1"> --listen 0.0.0.0:</span><strong class="bold"><span class="koboSpan" id="kobo.1739.1">8081</span></strong><span class="koboSpan" id="kobo.1740.1"> --vnc localhost:</span><strong class="bold"><span class="koboSpan" id="kobo.1741.1">5901</span></strong><span class="koboSpan" id="kobo.1742.1">
... </span><span class="koboSpan" id="kobo.1742.2">/usr/bin/perl /usr/bin/</span><strong class="bold"><span class="koboSpan" id="kobo.1743.1">vncserver</span></strong><span class="koboSpan" id="kobo.1744.1">
... </span><span class="koboSpan" id="kobo.1744.2">/usr/bin/python3 /usr/bin/</span><strong class="bold"><span class="koboSpan" id="kobo.1745.1">websockify</span></strong><span class="koboSpan" id="kobo.1746.1"> --web /usr/share/novnc/utils/../ 0.0.0.0:</span><strong class="bold"><span class="koboSpan" id="kobo.1747.1">8081</span></strong><span class="koboSpan" id="kobo.1748.1"> localhost:</span><strong class="bold"><span class="koboSpan" id="kobo.1749.1">5901</span></strong><span class="koboSpan" id="kobo.1750.1">
...</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1751.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1752.1">You may need to wait for an extra minute for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1753.1">ps -ef | grep vnc</span></strong><span class="koboSpan" id="kobo.1754.1"> to yield </span><span class="No-Break"><span class="koboSpan" id="kobo.1755.1">this output.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1756.1">Using the resource</span><a id="_idIndexMarker701"/><span class="koboSpan" id="kobo.1757.1"> menu in the left pane, navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.1758.1">Overview</span></strong><span class="koboSpan" id="kobo.1759.1"> blade of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1760.1">VM instance:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer125">
<span class="koboSpan" id="kobo.1761.1"><img alt="" src="image/B19755_05_014.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1762.1">Figure 5.14 – Retrieving the Public IP address value of the target VM instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1763.1">Copy the </span><strong class="bold"><span class="koboSpan" id="kobo.1764.1">Public IP address</span></strong><span class="koboSpan" id="kobo.1765.1"> value (to the clipboard), as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1766.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1767.1">.14</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1768.1">.</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1769.1">Open a new browser tab and access the web-based noVNC client using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1770.1">http://&lt;ATTACKER VM PUBLIC IP ADDRESS&gt;:8081/vnc.html</span></strong><span class="koboSpan" id="kobo.1771.1"> URL. </span><span class="koboSpan" id="kobo.1771.2">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1772.1">&lt;ATTACKER VM PUBLIC IP ADDRESS&gt;</span></strong><span class="koboSpan" id="kobo.1773.1"> with the </span><strong class="bold"><span class="koboSpan" id="kobo.1774.1">Public IP address</span></strong><span class="koboSpan" id="kobo.1775.1"> value you copied to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1776.1">clipboard previously:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer126">
<span class="koboSpan" id="kobo.1777.1"><img alt="" src="image/B19755_05_015.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1778.1">Figure 5.15 – noVNC welcome screen</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1779.1">This should open a</span><a id="_idIndexMarker702"/><span class="koboSpan" id="kobo.1780.1"> welcome screen with a </span><strong class="bold"><span class="koboSpan" id="kobo.1781.1">Connect</span></strong><span class="koboSpan" id="kobo.1782.1"> button, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1783.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1784.1">.15</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1785.1">.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1786.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1787.1">If you find yourself unable to access the welcome screen, your IP address might have changed already. </span><span class="koboSpan" id="kobo.1787.2">Simply open the Cloud Shell editor and update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1788.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.1789.1"> file. </span><span class="koboSpan" id="kobo.1789.2">Once the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1790.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.1791.1"> file has been updated with the new IP address of your local machine, run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1792.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1793.1"> command again to update the firewall rule to whitelist your new </span><span class="No-Break"><span class="koboSpan" id="kobo.1794.1">IP address.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1795.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1796.1">Connect</span></strong><span class="koboSpan" id="kobo.1797.1"> button and then use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1798.1">kali123</span></strong><span class="koboSpan" id="kobo.1799.1"> password (or the password you </span><a id="_idIndexMarker703"/><span class="koboSpan" id="kobo.1800.1">specified previously) to access the desktop environment, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1801.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1802.1">.16</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1803.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer127">
<span class="koboSpan" id="kobo.1804.1"><img alt="" src="image/B19755_05_016.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1805.1">Figure 5.16 – Accessing the Kali Linux desktop/GUI environment in the browser</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1806.1">Once we can access the desktop environment, we can proceed with creating the golden image based on the current VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1807.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1808.1">kali-00</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1809.1">).</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1810.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1811.1">Feel free to close the browser tab (Kali Linux desktop/GUI environment) before proceeding with the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.1812.1">of steps.</span></span></p>
<p><span class="koboSpan" id="kobo.1813.1">Compared to setting up a Kali Linux machine in GCP, setting up a similar VM instance in Microsoft Azure requires fewer steps as we no longer need to import the Kali Linux Generic Cloud Image. </span><span class="koboSpan" id="kobo.1813.2">Of course, this chapter builds on top of the previous chapter and makes use of automated scripts to further reduce the number of steps when setting up the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.1814.1">machine manually.</span></span></p>
<h1 id="_idParaDest-107"><a id="_idTextAnchor106"/><span class="koboSpan" id="kobo.1815.1">Leveraging Terraform to automatically set up the attacker VM instance</span></h1>
<p><span class="koboSpan" id="kobo.1816.1">The previous section primarily focused on setting up the attacker VM instance using pre-built scripts. </span><span class="koboSpan" id="kobo.1816.2">This was necessary</span><a id="_idIndexMarker704"/><span class="koboSpan" id="kobo.1817.1"> because we will utilize this VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1818.1">kali-00</span></strong><span class="koboSpan" id="kobo.1819.1">) as a reference to create a golden image. </span><span class="koboSpan" id="kobo.1819.2">This golden image will be used in the Terraform configuration file to automatically set up the attacker </span><a id="_idIndexMarker705"/><span class="koboSpan" id="kobo.1820.1">VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1821.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1822.1">vm-kali</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1823.1">).</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1824.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1825.1">What will happen to the original VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1826.1">kali-00</span></strong><span class="koboSpan" id="kobo.1827.1">) we created? </span><span class="koboSpan" id="kobo.1827.2">After using it to create the golden image, it becomes </span><em class="italic"><span class="koboSpan" id="kobo.1828.1">generalized</span></em><span class="koboSpan" id="kobo.1829.1"> and cannot be started again. </span><span class="koboSpan" id="kobo.1829.2">That said, once the golden image has been successfully created, we will delete the original VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1830.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1831.1">kali-00</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1832.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.1833.1">This section is divided into the </span><span class="No-Break"><span class="koboSpan" id="kobo.1834.1">following subparts:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.1835.1">Part 1 of 3 – Creating the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1836.1">golden image</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1837.1">Part 2 of 3 – Deleting the manually </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1838.1">created resources</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1839.1">Part 3 of 3 – Preparing the Terraform </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1840.1">configuration files</span></em></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1841.1">Without further ado, </span><span class="No-Break"><span class="koboSpan" id="kobo.1842.1">let’s begin!</span></span></p>
<h2 id="_idParaDest-108"><a id="_idTextAnchor107"/><span class="koboSpan" id="kobo.1843.1">Part 1 of 3 – Creating the golden image</span></h2>
<p><span class="koboSpan" id="kobo.1844.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1845.1">these </span></span><span class="No-Break"><a id="_idIndexMarker706"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1846.1">steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1847.1">Navigate to the</span><a id="_idIndexMarker707"/><span class="koboSpan" id="kobo.1848.1"> VM instance’ </span><strong class="bold"><span class="koboSpan" id="kobo.1849.1">Overview</span></strong><span class="koboSpan" id="kobo.1850.1"> blade of our Kali Linux (</span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1851.1">kali-00</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1852.1">) instance.</span></span></li>
<li><span class="koboSpan" id="kobo.1853.1">Locate and click the </span><strong class="bold"><span class="koboSpan" id="kobo.1854.1">Capture</span></strong><span class="koboSpan" id="kobo.1855.1"> button to be redirected to the </span><strong class="bold"><span class="koboSpan" id="kobo.1856.1">Create an </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1857.1">image</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1858.1"> page.</span></span></li>
<li><span class="koboSpan" id="kobo.1859.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.1860.1">Create an image</span></strong><span class="koboSpan" id="kobo.1861.1"> page, specify the following configuration values under the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1862.1">Basics</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1863.1"> tab:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.1864.1">Project details</span></strong><span class="koboSpan" id="kobo.1865.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1866.1">Subscription</span></strong><span class="koboSpan" id="kobo.1867.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1868.1">Resource </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1869.1">group</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1870.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1871.1">image-resource-group</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1872.1">.</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1873.1">Gallery details</span></strong><span class="koboSpan" id="kobo.1874.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1875.1">Target Azure compute gallery</span></strong><span class="koboSpan" id="kobo.1876.1">: Click </span><strong class="bold"><span class="koboSpan" id="kobo.1877.1">Create new</span></strong><span class="koboSpan" id="kobo.1878.1">. </span><span class="koboSpan" id="kobo.1878.2">Specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.1879.1">kali_gallery</span></strong><span class="koboSpan" id="kobo.1880.1"> in the text field before clicking the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1881.1">OK</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1882.1"> button.</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1883.1">Target VM image definition</span></strong><span class="koboSpan" id="kobo.1884.1">: Click </span><strong class="bold"><span class="koboSpan" id="kobo.1885.1">Create new</span></strong><span class="koboSpan" id="kobo.1886.1">. </span><span class="koboSpan" id="kobo.1886.2">Specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.1887.1">golden-image</span></strong><span class="koboSpan" id="kobo.1888.1"> in the </span><strong class="bold"><span class="koboSpan" id="kobo.1889.1">VM image definition name</span></strong><span class="koboSpan" id="kobo.1890.1"> field. </span><span class="koboSpan" id="kobo.1890.2">Leave everything else as is and then click the </span><strong class="bold"><span class="koboSpan" id="kobo.1891.1">OK</span></strong><span class="koboSpan" id="kobo.1892.1"> button</span><a id="_idIndexMarker708"/><span class="koboSpan" id="kobo.1893.1"> to proceed with creating the new VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1894.1">image definition.</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.1895.1">Version details</span></strong><span class="koboSpan" id="kobo.1896.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1897.1">Version </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1898.1">number</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1899.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1900.1">1.0.0</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1901.1">.</span></span></li></ul><p class="list-inset"><span class="koboSpan" id="kobo.1902.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1903.1">Next : Tags &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1904.1">button </span></span><span class="No-Break"><a id="_idIndexMarker709"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1905.1">afterward.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1906.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1907.1">Make sure you take note of the </span><strong class="bold"><span class="koboSpan" id="kobo.1908.1">Publisher</span></strong><span class="koboSpan" id="kobo.1909.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1910.1">Offer</span></strong><span class="koboSpan" id="kobo.1911.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.1912.1">SKU</span></strong><span class="koboSpan" id="kobo.1913.1"> configuration values (</span><strong class="bold"><span class="koboSpan" id="kobo.1914.1">Publisher</span></strong><span class="koboSpan" id="kobo.1915.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1916.1">kali-linux</span></strong><span class="koboSpan" id="kobo.1917.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1918.1">Offer</span></strong><span class="koboSpan" id="kobo.1919.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1920.1">kali</span></strong><span class="koboSpan" id="kobo.1921.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1922.1">SKU</span></strong><span class="koboSpan" id="kobo.1923.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1924.1">kali</span></strong><span class="koboSpan" id="kobo.1925.1">) while creating the VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1926.1">image definition.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1927.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.1928.1">Tags</span></strong><span class="koboSpan" id="kobo.1929.1"> tab, simply locate and click </span><strong class="bold"><span class="koboSpan" id="kobo.1930.1">Next: Review + </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1931.1">create &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1932.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1933.1">Review the configuration settings and then click the </span><strong class="bold"><span class="koboSpan" id="kobo.1934.1">Create</span></strong><span class="koboSpan" id="kobo.1935.1"> button. </span><span class="koboSpan" id="kobo.1935.2">This will stop the running VM instance and redirect you to the </span><strong class="bold"><span class="koboSpan" id="kobo.1936.1">Deployment</span></strong><span class="koboSpan" id="kobo.1937.1"> page (where you’ll see the </span><strong class="bold"><span class="koboSpan" id="kobo.1938.1">Deployment is in </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1939.1">progress</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1940.1"> message).</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1941.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1942.1">This step may take around 10-15 minutes to complete. </span><span class="koboSpan" id="kobo.1942.2">Feel free to grab a cup of coffee or tea </span><span class="No-Break"><span class="koboSpan" id="kobo.1943.1">while waiting!</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1944.1">Once you see the </span><strong class="bold"><span class="koboSpan" id="kobo.1945.1">Your deployment is complete</span></strong><span class="koboSpan" id="kobo.1946.1"> success message, click the </span><strong class="bold"><span class="koboSpan" id="kobo.1947.1">Go to resource</span></strong><span class="koboSpan" id="kobo.1948.1"> button to</span><a id="_idIndexMarker710"/><span class="koboSpan" id="kobo.1949.1"> navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.1950.1">Overview</span></strong><span class="koboSpan" id="kobo.1951.1"> blade of the resource we </span><span class="No-Break"><span class="koboSpan" id="kobo.1952.1">just created.</span></span></li>
<li><span class="koboSpan" id="kobo.1953.1">Locate and click the </span><strong class="bold"><span class="koboSpan" id="kobo.1954.1">JSON View</span></strong><span class="koboSpan" id="kobo.1955.1"> link</span><a id="_idIndexMarker711"/><span class="koboSpan" id="kobo.1956.1"> located at the top-left corner of the page (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1957.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1958.1">.17</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1959.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer128">
<span class="koboSpan" id="kobo.1960.1"><img alt="" src="image/B19755_05_017.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1961.1">Figure 5.17 – Locating the JSON View link</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1962.1">Clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.1963.1">JSON View</span></strong><span class="koboSpan" id="kobo.1964.1"> link will open the </span><strong class="bold"><span class="koboSpan" id="kobo.1965.1">Resource JSON</span></strong><span class="koboSpan" id="kobo.1966.1"> pane. </span><span class="koboSpan" id="kobo.1966.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1967.1">Copy to clipboard</span></strong><span class="koboSpan" id="kobo.1968.1"> button and then store this </span><strong class="bold"><span class="koboSpan" id="kobo.1969.1">id</span></strong><span class="koboSpan" id="kobo.1970.1"> value in a text editor on your local machine. </span><span class="koboSpan" id="kobo.1970.2">Note that the </span><strong class="bold"><span class="koboSpan" id="kobo.1971.1">id</span></strong><span class="koboSpan" id="kobo.1972.1"> value should have a format similar to </span><span class="No-Break"><span class="koboSpan" id="kobo.1973.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1974.1">
/subscriptions/.../resourcegroups/image-resource-group/providers/Microsoft.Compute/galleries/kali_gallery/images/golden-image/versions/1.0.0</span></pre> <p><span class="koboSpan" id="kobo.1975.1">We will use this value later when we prepare the Terraform configuration files for automating the creation of our Kali </span><span class="No-Break"><span class="koboSpan" id="kobo.1976.1">Linux server.</span></span></p>
<h2 id="_idParaDest-109"><a id="_idTextAnchor108"/><span class="koboSpan" id="kobo.1977.1">Part 2 of 3 – Deleting the manually created resources</span></h2>
<p><span class="koboSpan" id="kobo.1978.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1979.1">these steps:</span></span></p></li>
</ol>
<ol>
<li><span class="koboSpan" id="kobo.1980.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.1981.1">Overview</span></strong><span class="koboSpan" id="kobo.1982.1"> blade of the Kali Linux (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1983.1">kali-00</span></strong><span class="koboSpan" id="kobo.1984.1">) VM instance by (1) typing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1985.1">kali-00</span></strong><span class="koboSpan" id="kobo.1986.1"> in the search bar and then (2) selecting </span><strong class="bold"><span class="koboSpan" id="kobo.1987.1">kali-00 — Virtual machine</span></strong><span class="koboSpan" id="kobo.1988.1"> from the list of </span><a id="_idIndexMarker712"/><span class="No-Break"><span class="koboSpan" id="kobo.1989.1">search results.</span></span></li>
<li><span class="koboSpan" id="kobo.1990.1">Now, let’s delete the instance. </span><span class="koboSpan" id="kobo.1990.2">In the resource menu in the left pane, locate and click </span><strong class="bold"><span class="koboSpan" id="kobo.1991.1">Overview</span></strong><span class="koboSpan" id="kobo.1992.1">. </span><span class="koboSpan" id="kobo.1992.2">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1993.1">Overview</span></strong><span class="koboSpan" id="kobo.1994.1"> blade, click the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1995.1">Delete</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1996.1"> button.</span></span></li>
<li><span class="koboSpan" id="kobo.1997.1">Under the list of associated resources, make sure you have all three checkboxes checked (</span><strong class="bold"><span class="koboSpan" id="kobo.1998.1">OS disk</span></strong><span class="koboSpan" id="kobo.1999.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.2000.1">Network interfaces</span></strong><span class="koboSpan" id="kobo.2001.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.2002.1">Public IP addresses</span></strong><span class="koboSpan" id="kobo.2003.1">) under the </span><strong class="bold"><span class="koboSpan" id="kobo.2004.1">Delete with VM</span></strong><span class="koboSpan" id="kobo.2005.1"> column </span><span class="No-Break"><span class="koboSpan" id="kobo.2006.1">when possible.</span></span></li>
<li><span class="koboSpan" id="kobo.2007.1">Check the </span><strong class="bold"><span class="koboSpan" id="kobo.2008.1">I have read and understand that this virtual machine as well as any selected associated resources listed above will be deleted</span></strong><span class="koboSpan" id="kobo.2009.1"> checkbox </span><span class="No-Break"><span class="koboSpan" id="kobo.2010.1">as well.</span></span></li>
<li><span class="koboSpan" id="kobo.2011.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2012.1">Delete</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2013.1">button afterward.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2014.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2015.1">After a minute or two, you should see a success message stating that the resource(s) have been </span><span class="No-Break"><span class="koboSpan" id="kobo.2016.1">deleted successfully.</span></span></p>
<h2 id="_idParaDest-110"><a id="_idTextAnchor109"/><span class="koboSpan" id="kobo.2017.1">Part 3 of 3 – Preparing the Terraform configuration files</span></h2>
<p><span class="koboSpan" id="kobo.2018.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.2019.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2020.1">It’s time to</span><a id="_idIndexMarker713"/><span class="koboSpan" id="kobo.2021.1"> code again! </span><span class="koboSpan" id="kobo.2021.2">Make</span><a id="_idIndexMarker714"/><span class="koboSpan" id="kobo.2022.1"> sure that the Cloud Shell editor is activated </span><span class="No-Break"><span class="koboSpan" id="kobo.2023.1">and maximized.</span></span></li>
<li><span class="koboSpan" id="kobo.2024.1">Before we run any of the </span><a id="_idIndexMarker715"/><span class="koboSpan" id="kobo.2025.1">succeeding commands, let’s make sure that we are inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2026.1">pentest_lab</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2027.1"> directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2028.1">cd ~/pentest_lab</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2029.1">Let’s create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2030.1">main.tf</span></strong><span class="koboSpan" id="kobo.2031.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2032.1">variables.tf</span></strong><span class="koboSpan" id="kobo.2033.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2034.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.2035.1"> files inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2036.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.2037.1"> directory using </span><a id="_idIndexMarker716"/><span class="koboSpan" id="kobo.2038.1">the </span><span class="No-Break"><span class="koboSpan" id="kobo.2039.1">following </span></span><span class="No-Break"><span class="koboSpan" id="kobo.2040.1">commands</span></span><span class="No-Break"><span class="koboSpan" id="kobo.2041.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2042.1">touch attacker_vm/main.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2043.1">touch attacker_vm/variables.tf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2044.1">touch attacker_vm/outputs.tf</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2045.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2046.1">When you encounter issues using Cloud Shell, feel free to restart using the </span><strong class="bold"><span class="koboSpan" id="kobo.2047.1">Restart Cloud Shell</span></strong><span class="koboSpan" id="kobo.2048.1"> button. </span><span class="koboSpan" id="kobo.2048.2">Make sure you </span><a id="_idIndexMarker717"/><span class="koboSpan" id="kobo.2049.1">navigate back to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2050.1">~/pentest_lab</span></strong><span class="koboSpan" id="kobo.2051.1"> directory after restarting Cloud Shell. </span><span class="koboSpan" id="kobo.2051.2">If that does not work, you may sign out and sign in of your Azure account to help you troubleshoot and resolve various types </span><span class="No-Break"><span class="koboSpan" id="kobo.2052.1">of issues.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.2053.1">Next, open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2054.1">attacker_vm/variables.tf</span></strong><span class="koboSpan" id="kobo.2055.1"> file in the editor and add the following blocks of code to define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2056.1">source_image_id</span></strong><span class="koboSpan" id="kobo.2057.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2058.1">asg</span></strong><span class="koboSpan" id="kobo.2059.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2060.1">nsg</span></strong><span class="koboSpan" id="kobo.2061.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2062.1">rg_location</span></strong><span class="koboSpan" id="kobo.2063.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2064.1">rg_name</span></strong><span class="koboSpan" id="kobo.2065.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2066.1">subnet</span></strong><span class="koboSpan" id="kobo.2067.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2068.1">my_public_ssh_key</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2069.1"> variables:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2070.1">
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.2071.1">source_image_id</span></strong><span class="koboSpan" id="kobo.2072.1">" {
  type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.2073.1">asg</span></strong><span class="koboSpan" id="kobo.2074.1">" {
  type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.2075.1">nsg</span></strong><span class="koboSpan" id="kobo.2076.1">" {
  type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.2077.1">rg_location</span></strong><span class="koboSpan" id="kobo.2078.1">" {
  type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.2079.1">rg_name</span></strong><span class="koboSpan" id="kobo.2080.1">" {
  type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.2081.1">subnet</span></strong><span class="koboSpan" id="kobo.2082.1">" {
  type = string
}
variable "</span><strong class="bold"><span class="koboSpan" id="kobo.2083.1">my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2084.1">" {
  type = string
}</span></pre></li> <li><span class="koboSpan" id="kobo.2085.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2086.1">attacker_vm/main.tf</span></strong><span class="koboSpan" id="kobo.2087.1"> file in the editor and add the following blocks of code to </span><a id="_idIndexMarker718"/><span class="koboSpan" id="kobo.2088.1">define the public IP </span><a id="_idIndexMarker719"/><span class="koboSpan" id="kobo.2089.1">address and network interface resources for the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.2090.1">VM instance:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2091.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.2092.1">azurerm_public_ip</span></strong><span class="koboSpan" id="kobo.2093.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.2094.1">public_ip_attacker</span></strong><span class="koboSpan" id="kobo.2095.1">" {
  name                = "public-ip-attacker"
  location            = var.rg_location
  resource_group_name = var.rg_name
  allocation_method   = "Dynamic"
}
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.2096.1">azurerm_network_interface</span></strong><span class="koboSpan" id="kobo.2097.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.2098.1">nic_attacker</span></strong><span class="koboSpan" id="kobo.2099.1">" {
  name                = "</span><strong class="bold"><span class="koboSpan" id="kobo.2100.1">nic-attacker</span></strong><span class="koboSpan" id="kobo.2101.1">"
  location            = var.rg_location
  resource_group_name = var.rg_name
  </span><strong class="bold"><span class="koboSpan" id="kobo.2102.1">ip_configuration</span></strong><span class="koboSpan" id="kobo.2103.1"> {
    name                          = (
      "</span><strong class="bold"><span class="koboSpan" id="kobo.2104.1">nic_configuration_attacker</span></strong><span class="koboSpan" id="kobo.2105.1">"
    )
    subnet_id                     = var.subnet
    private_ip_address_allocation = "Dynamic"
    </span><strong class="bold"><span class="koboSpan" id="kobo.2106.1">public_ip_address_id</span></strong><span class="koboSpan" id="kobo.2107.1">          = (
      azurerm_public_ip.public_ip_attacker.id
    )
  }
}</span></pre></li> <li><span class="koboSpan" id="kobo.2108.1">Next, let’s </span><a id="_idIndexMarker720"/><span class="koboSpan" id="kobo.2109.1">define the following</span><a id="_idIndexMarker721"/><span class="koboSpan" id="kobo.2110.1"> block of code to establish an association between the network interface of the attacker VM instance and the </span><span class="No-Break"><span class="koboSpan" id="kobo.2111.1">specified NSG:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2112.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.2113.1">azurerm_network_interface_security_group_association</span></strong><span class="koboSpan" id="kobo.2114.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.2115.1">nsg_assoc_attacker</span></strong><span class="koboSpan" id="kobo.2116.1">" {
  </span><strong class="bold"><span class="koboSpan" id="kobo.2117.1">network_interface_id</span></strong><span class="koboSpan" id="kobo.2118.1">      = (
    azurerm_network_interface
      .nic_attacker
      .id
  )
  </span><strong class="bold"><span class="koboSpan" id="kobo.2119.1">network_security_group_id</span></strong><span class="koboSpan" id="kobo.2120.1"> = var.nsg
}</span></pre></li> <li><span class="koboSpan" id="kobo.2121.1">Next, let’s define</span><a id="_idIndexMarker722"/><span class="koboSpan" id="kobo.2122.1"> the following block of code to establish an association between the network interface </span><a id="_idIndexMarker723"/><span class="koboSpan" id="kobo.2123.1">of the attacker VM instance and the </span><span class="No-Break"><span class="koboSpan" id="kobo.2124.1">specified ASG:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2125.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.2126.1">azurerm_network_interface_application_security_group_association</span></strong><span class="koboSpan" id="kobo.2127.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.2128.1">asg_assoc_3</span></strong><span class="koboSpan" id="kobo.2129.1">" {
  </span><strong class="bold"><span class="koboSpan" id="kobo.2130.1">network_interface_id</span></strong><span class="koboSpan" id="kobo.2131.1">          = (
    azurerm_network_interface
      .nic_attacker
      .id
  )
  </span><strong class="bold"><span class="koboSpan" id="kobo.2132.1">application_security_group_id</span></strong><span class="koboSpan" id="kobo.2133.1"> = var.asg
}</span></pre></li> <li><span class="koboSpan" id="kobo.2134.1">With everything ready, let’s define and configure the attacker VM instance, which will utilize the</span><a id="_idIndexMarker724"/><span class="koboSpan" id="kobo.2135.1"> golden image we </span><span class="No-Break"><span class="koboSpan" id="kobo.2136.1">prepared earlier:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2137.1">
resource "</span><strong class="bold"><span class="koboSpan" id="kobo.2138.1">azurerm_linux_virtual_machine</span></strong><span class="koboSpan" id="kobo.2139.1">" "</span><strong class="bold"><span class="koboSpan" id="kobo.2140.1">vm_kali</span></strong><span class="koboSpan" id="kobo.2141.1">" {
  name                  = "vm-kali"
  location              = var.rg_location
  resource_group_name   = var.rg_name
  size                  = "Standard_DS1_v2"
  network_interface_ids = [
    azurerm_network_interface.nic_attacker.id
  ]
  os_disk {
    name                 = "os-disk-kali"
    caching              = "ReadWrite"
    storage_account_type = "Standard_LRS"
  }
  </span><strong class="bold"><span class="koboSpan" id="kobo.2142.1">source_image_id = var.source_image_id</span></strong><span class="koboSpan" id="kobo.2143.1">
  plan {
    name = "kali"
    publisher = "kali-linux"
    product = "kali"
  }
  computer_name                   = "</span><strong class="bold"><span class="koboSpan" id="kobo.2144.1">vm-kali</span></strong><span class="koboSpan" id="kobo.2145.1">"
  </span><strong class="bold"><span class="koboSpan" id="kobo.2146.1">admin_ssh_key</span></strong><span class="koboSpan" id="kobo.2147.1"> {
    username   = "kali_admin"
    public_key = var.my_public_ssh_key
  }
  admin_username                  = "kali_admin"
  admin_password                  = "KaliLinux1234!!!"
</span><span class="koboSpan" id="kobo.2147.2">  disable_password_authentication = false
  boot_diagnostics {
    storage_account_uri = null
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2148.1">Here, we are allowing</span><a id="_idIndexMarker725"/><span class="koboSpan" id="kobo.2149.1"> the attacker VM instance to be accessed using an SSH key as well (in addition to being</span><a id="_idIndexMarker726"/><span class="koboSpan" id="kobo.2150.1"> accessed using a username </span><span class="No-Break"><span class="koboSpan" id="kobo.2151.1">and password).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2152.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2153.1">Make sure you save the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2154.1">attacker_vm/main.tf</span></strong><span class="koboSpan" id="kobo.2155.1"> file before proceeding to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2156.1">next step.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.2157.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2158.1">attacker_vm/outputs.tf</span></strong><span class="koboSpan" id="kobo.2159.1"> file in the editor and add the following lines of code to output the private and public IP addresses of the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.2160.1">VM instance:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2161.1">
output "</span><strong class="bold"><span class="koboSpan" id="kobo.2162.1">vm_kali_private_ip</span></strong><span class="koboSpan" id="kobo.2163.1">" {
  value = (azurerm_linux_virtual_machine
            .vm_kali
            .</span><strong class="bold"><span class="koboSpan" id="kobo.2164.1">private_ip_address</span></strong><span class="koboSpan" id="kobo.2165.1">)
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.2166.1">vm_kali_public_ip</span></strong><span class="koboSpan" id="kobo.2167.1">" {
  value = (azurerm_linux_virtual_machine
            .vm_kali
            .</span><strong class="bold"><span class="koboSpan" id="kobo.2168.1">public_ip_address</span></strong><span class="koboSpan" id="kobo.2169.1">)
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2170.1">This will allow the root</span><a id="_idIndexMarker727"/><span class="koboSpan" id="kobo.2171.1"> module to access these values, which are currently only accessible from</span><a id="_idIndexMarker728"/><span class="koboSpan" id="kobo.2172.1"> within the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2173.1">attacker_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2174.1"> module.</span></span></p></li> <li><span class="koboSpan" id="kobo.2175.1">Finally, let’s define the following outputs in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2176.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.2177.1"> file (inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2178.1">pentest_lab</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2179.1"> directory):</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2180.1">
output "</span><strong class="bold"><span class="koboSpan" id="kobo.2181.1">vm_kali_private_ip</span></strong><span class="koboSpan" id="kobo.2182.1">" {
  value = </span><strong class="bold"><span class="koboSpan" id="kobo.2183.1">module.attacker_vm.vm_kali_private_ip</span></strong><span class="koboSpan" id="kobo.2184.1">
}
output "</span><strong class="bold"><span class="koboSpan" id="kobo.2185.1">vm_kali_public_ip</span></strong><span class="koboSpan" id="kobo.2186.1">" {
  value = </span><strong class="bold"><span class="koboSpan" id="kobo.2187.1">module.attacker_vm.vm_kali_public_ip</span></strong><span class="koboSpan" id="kobo.2188.1">
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2189.1">Here, we are defining two outputs in the root module: </span><strong class="source-inline"><span class="koboSpan" id="kobo.2190.1">vm_kali_private_ip</span></strong><span class="koboSpan" id="kobo.2191.1">, which is the private IP address of the attacker VM instance from the list of outputs of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2192.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.2193.1"> module, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2194.1">vm_kali_public_ip</span></strong><span class="koboSpan" id="kobo.2195.1">, which is the public IP address of the attacker VM instance from the list of outputs of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2196.1">attacker_vm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2197.1"> module.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2198.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2199.1">Since the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2200.1">outputs.tf</span></strong><span class="koboSpan" id="kobo.2201.1"> file has defined output values already, make sure you append these blocks of code instead of replacing </span><span class="No-Break"><span class="koboSpan" id="kobo.2202.1">existing ones.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.2203.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2204.1">terraform plan</span></strong><span class="koboSpan" id="kobo.2205.1"> to</span><a id="_idIndexMarker729"/><span class="koboSpan" id="kobo.2206.1"> preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.2207.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2208.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2209.1">This should give us a</span><a id="_idIndexMarker730"/><span class="koboSpan" id="kobo.2210.1"> couple of missing required </span><span class="No-Break"><span class="koboSpan" id="kobo.2211.1">argument errors.</span></span></p></li> <li><span class="koboSpan" id="kobo.2212.1">To resolve these issues, let’s locate the following block of code in our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2213.1">main.tf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2214.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2215.1">
module "</span><strong class="bold"><span class="koboSpan" id="kobo.2216.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.2217.1">" {
  source = "./attacker_vm"
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2218.1">Let’s replace this with the following block </span><span class="No-Break"><span class="koboSpan" id="kobo.2219.1">of code:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2220.1">module "</span><strong class="bold"><span class="koboSpan" id="kobo.2221.1">attacker_vm</span></strong><span class="koboSpan" id="kobo.2222.1">" {
  source = "./attacker_vm"
  </span><strong class="bold"><span class="koboSpan" id="kobo.2223.1">my_public_ssh_key = var.my_public_ssh_key</span></strong><span class="koboSpan" id="kobo.2224.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.2225.1">source_image_id = var.kali_image_id</span></strong><span class="koboSpan" id="kobo.2226.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.2227.1">rg_location = module.secure_network.rg_02_location</span></strong><span class="koboSpan" id="kobo.2228.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.2229.1">rg_name = module.secure_network.rg_02_name</span></strong><span class="koboSpan" id="kobo.2230.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.2231.1">subnet = module.secure_network.subnet_02</span></strong><span class="koboSpan" id="kobo.2232.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.2233.1">asg = module.secure_network.asg_02</span></strong><span class="koboSpan" id="kobo.2234.1">
  </span><strong class="bold"><span class="koboSpan" id="kobo.2235.1">nsg = module.secure_network.nsg_02</span></strong><span class="koboSpan" id="kobo.2236.1">
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2237.1">Make sure you save the changes </span><a id="_idIndexMarker731"/><span class="koboSpan" id="kobo.2238.1">you’ve made to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2239.1">main.tf</span></strong><span class="koboSpan" id="kobo.2240.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.2241.1">before proceeding.</span></span></p></li> <li><span class="koboSpan" id="kobo.2242.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2243.1">terraform plan</span></strong><span class="koboSpan" id="kobo.2244.1"> to</span><a id="_idIndexMarker732"/><span class="koboSpan" id="kobo.2245.1"> preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.2246.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2247.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2248.1">We’ll encounter another issue, this time concerning the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2249.1">"&lt;INSERT KALI IMAGE ID&gt;"</span></strong><span class="koboSpan" id="kobo.2250.1"> string value we specified as a </span><span class="No-Break"><span class="koboSpan" id="kobo.2251.1">placeholder earlier.</span></span></p></li> <li><span class="koboSpan" id="kobo.2252.1">To fix this issue, let’s open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2253.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.2254.1"> file and update it with the ID of the golden image we </span><span class="No-Break"><span class="koboSpan" id="kobo.2255.1">created previously:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2256.1">
...
</span><span class="koboSpan" id="kobo.2256.2">kali_image_id = </span><strong class="bold"><span class="koboSpan" id="kobo.2257.1">"&lt;INSERT KALI IMAGE ID&gt;"</span></strong><span class="koboSpan" id="kobo.2258.1">
...</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2259.1">If you are wondering what this value looks like, the value for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2260.1">&lt;INSERT KALI IMAGE ID&gt;</span></strong><span class="koboSpan" id="kobo.2261.1"> placeholder should have a format similar to </span><span class="No-Break"><span class="koboSpan" id="kobo.2262.1">the following:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2263.1">/subscriptions/.../resourcegroups/image-resource-group/providers/Microsoft.Compute/galleries/kali_gallery/images/golden-image/versions/1.0.0</span></pre></li> <li><span class="koboSpan" id="kobo.2264.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2265.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2266.1">plan</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2267.1"> again:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2268.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2269.1">This command should complete without </span><a id="_idIndexMarker733"/><span class="koboSpan" id="kobo.2270.1">any errors </span><span class="No-Break"><span class="koboSpan" id="kobo.2271.1">this time.</span></span></p></li> <li><span class="koboSpan" id="kobo.2272.1">Next, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2273.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2274.1"> command to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.2275.1">the changes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2276.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2277.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.2278.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2279.1">...
</span><span class="koboSpan" id="kobo.2279.2">vm_kali_private_ip = "..."
</span><span class="koboSpan" id="kobo.2279.3">vm_kali_public_ip = "..."
</span><span class="koboSpan" id="kobo.2279.4">vm_target_password = "..."
</span><span class="koboSpan" id="kobo.2279.5">vm_target_private_ip = "..."
</span><span class="koboSpan" id="kobo.2279.6">vm_target_public_ip = "..."
</span><span class="koboSpan" id="kobo.2279.7">vm_target_username = "testuser"</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2280.1">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2281.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2282.1"> command runs without any errors, we are ready to proceed to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2283.1">next section!</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2284.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2285.1">Make sure you copy the output values into a text editor on your local machine as we will use these values in the succeeding sections in </span><span class="No-Break"><span class="koboSpan" id="kobo.2286.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.2287.1">Feel free to access the attacker </span><a id="_idIndexMarker734"/><span class="koboSpan" id="kobo.2288.1">VM instance using the SSH key (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2289.1">kali-ssh</span></strong><span class="koboSpan" id="kobo.2290.1">) you downloaded earlier in this chapter. </span><span class="koboSpan" id="kobo.2290.2">After updating the permissions of the SSH key file using </span><strong class="source-inline"><span class="koboSpan" id="kobo.2291.1">chmod 600 kali-ssh</span></strong><span class="koboSpan" id="kobo.2292.1">, you can run the following command to create the SSH tunnel between our local machine and the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.2293.1">VM instance:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2294.1">ssh -L 8081:localhost:8081 -N -i &lt;INSERT KEY NAME&gt; &lt;USER&gt;@&lt;ATTACKER VM IP&gt;</span></strong></pre> <p><span class="koboSpan" id="kobo.2295.1">Once the SSH tunnel has been set up, we can access the same desktop environment through http://localhost:8081/vnc.html (instead of using the public IP address of the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.2296.1">VM instance).</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.2297.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2298.1">It is important to note that the current implementation is not perfect and will need a few additional tweaks and upgrades before it can handle other scenarios such as VM instance restarts, along with container restarts. </span><span class="koboSpan" id="kobo.2298.2">Feel free to utilize and combine some of the techniques used in the previous chapter to further enhance what we have running in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2299.1">Azure environment.</span></span></p>
<p><span class="koboSpan" id="kobo.2300.1">Now that we have everything ready, we </span><a id="_idIndexMarker735"/><span class="koboSpan" id="kobo.2301.1">can proceed with simulating a penetration testing exercise inside our </span><span class="No-Break"><span class="koboSpan" id="kobo.2302.1">lab</span></span><span class="No-Break"><a id="_idIndexMarker736"/></span><span class="No-Break"><span class="koboSpan" id="kobo.2303.1"> environment.</span></span></p>
<h1 id="_idParaDest-111"><a id="_idTextAnchor110"/><span class="koboSpan" id="kobo.2304.1">Simulating penetration testing in the isolated network environment</span></h1>
<p><span class="koboSpan" id="kobo.2305.1">Given that our lab environment in </span><a id="_idIndexMarker737"/><span class="koboSpan" id="kobo.2306.1">Microsoft Azure has been set up successfully, we can now proceed with a simplified penetration testing</span><a id="_idIndexMarker738"/><span class="koboSpan" id="kobo.2307.1"> simulation to verify if everything has been (mis)configured correctly. </span><span class="koboSpan" id="kobo.2307.2">Compared to the previous chapter, our penetration testing simulation in this chapter will be a bit longer as we are dealing with a relatively more </span><span class="No-Break"><span class="koboSpan" id="kobo.2308.1">complex setup:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer129">
<span class="koboSpan" id="kobo.2309.1"><img alt="" src="image/B19755_05_018.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2310.1">Figure 5.18 – Penetration testing simulation</span></p>
<p><span class="koboSpan" id="kobo.2311.1">Our simulation starts by compromising a </span><strong class="bold"><span class="koboSpan" id="kobo.2312.1">Metasploitable 2</span></strong><span class="koboSpan" id="kobo.2313.1"> container running inside the VM instance. </span><span class="koboSpan" id="kobo.2313.2">Given that this running container has been configured with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2314.1">--privileged</span></strong><span class="koboSpan" id="kobo.2315.1"> flag enabled, we can escape the container environment using a container breakout technique and </span><a id="_idIndexMarker739"/><span class="koboSpan" id="kobo.2316.1">access the host system, where we’ll find the first flag. </span><span class="koboSpan" id="kobo.2316.2">We will then utilize the system-assigned</span><a id="_idIndexMarker740"/><span class="koboSpan" id="kobo.2317.1"> managed identity assigned to the VM instance to access Azure Key Vault, where we’ll find the </span><span class="No-Break"><span class="koboSpan" id="kobo.2318.1">second flag.</span></span></p>
<p><span class="koboSpan" id="kobo.2319.1">In our penetration testing simulation, we will use </span><strong class="bold"><span class="koboSpan" id="kobo.2320.1">Metasploit</span></strong><span class="koboSpan" id="kobo.2321.1"> – a widely recognized penetration testing framework used by security professionals. </span><span class="koboSpan" id="kobo.2321.2">We will use the interactive command-line interface of the </span><a id="_idIndexMarker741"/><span class="koboSpan" id="kobo.2322.1">Metasploit Framework called </span><strong class="bold"><span class="koboSpan" id="kobo.2323.1">msfconsole</span></strong><span class="koboSpan" id="kobo.2324.1">. </span><span class="koboSpan" id="kobo.2324.2">This command-line interface allows us to perform tasks such as searching for vulnerabilities, exploiting systems, conducting reconnaissance, managing sessions, and launching various security-related modules and exploits. </span><span class="koboSpan" id="kobo.2324.3">Using it generally involves the </span><span class="No-Break"><span class="koboSpan" id="kobo.2325.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2326.1">Running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2327.1">msfconsole</span></strong><span class="koboSpan" id="kobo.2328.1"> command in the Terminal to launch the </span><span class="No-Break"><span class="koboSpan" id="kobo.2329.1">interactive console.</span></span></li>
<li><span class="koboSpan" id="kobo.2330.1">Identifying and selecting a module (for example, an exploit module) from the comprehensive collection of modules available </span><span class="No-Break"><span class="koboSpan" id="kobo.2331.1">in Metasploit.</span></span></li>
<li><span class="koboSpan" id="kobo.2332.1">Configuring the module by adjusting its parameters </span><span class="No-Break"><span class="koboSpan" id="kobo.2333.1">and settings.</span></span></li>
<li><span class="koboSpan" id="kobo.2334.1">Running </span><span class="No-Break"><span class="koboSpan" id="kobo.2335.1">the module.</span></span></li>
<li><span class="koboSpan" id="kobo.2336.1">Exploring and using other modules for subsequent </span><span class="No-Break"><span class="koboSpan" id="kobo.2337.1">post-exploitation actions.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.2338.1">Note that this is a simplified way of describing how to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2339.1">msfconsole</span></strong><span class="koboSpan" id="kobo.2340.1"> as there are various advanced features, modules, and configurations available within the Metasploit Framework. </span><span class="koboSpan" id="kobo.2340.2">Depending on</span><a id="_idIndexMarker742"/><span class="koboSpan" id="kobo.2341.1"> the scenario, additional options such as auxiliary modules, post-exploitation techniques, scripting capabilities, and integration with external tools can be leveraged within </span><strong class="source-inline"><span class="koboSpan" id="kobo.2342.1">msfconsole</span></strong><span class="koboSpan" id="kobo.2343.1">. </span><span class="koboSpan" id="kobo.2343.2">If you have not used Metasploit before, don’t worry – the step-by-step guide in this section</span><a id="_idIndexMarker743"/><span class="koboSpan" id="kobo.2344.1"> will help you utilize this framework along with other tools and techniques to validate if our lab environment has been (</span><span class="No-Break"><span class="koboSpan" id="kobo.2345.1">mis)configured correctly.</span></span></p>
<p><span class="koboSpan" id="kobo.2346.1">We will divide this section into </span><span class="No-Break"><span class="koboSpan" id="kobo.2347.1">four subparts:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.2348.1">Part 1 of 4 – Scanning </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2349.1">with Nmap</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2350.1">Part 2 of 4 – Using the VNC login scanner module </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2351.1">of Metasploit</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2352.1">Part 3 of 4 – Breaking out of </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2353.1">the container</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2354.1">Part 4 of 4 – Locating </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2355.1">the flags</span></em></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.2356.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2357.1">It is unethical and illegal to attack cloud resources owned by another user or company. </span><span class="koboSpan" id="kobo.2357.2">Before proceeding, make sure you read the </span><em class="italic"><span class="koboSpan" id="kobo.2358.1">Examining the considerations when building penetration testing lab environments in the cloud</span></em><span class="koboSpan" id="kobo.2359.1"> section of </span><span class="No-Break"><em class="italic"><a href="B19755_01.xhtml"><span class="koboSpan" id="kobo.2360.1">Chapter 1</span></a></em></span><span class="koboSpan" id="kobo.2361.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2362.1">Getting Started with Penetration Testing Labs in the Cloud</span></em><span class="koboSpan" id="kobo.2363.1">, since we will be simulating the attack process to validate if misconfigurations and vulnerabilities present in the applications and services running in the target VM instance </span><span class="No-Break"><span class="koboSpan" id="kobo.2364.1">are exploitable.</span></span></p>
<p><span class="koboSpan" id="kobo.2365.1">With these in mind, we can now start the penetration </span><span class="No-Break"><span class="koboSpan" id="kobo.2366.1">testing simulation.</span></span></p>
<h2 id="_idParaDest-112"><a id="_idTextAnchor111"/><span class="koboSpan" id="kobo.2367.1">Part 1 of 4 – Scanning with Nmap</span></h2>
<p><span class="koboSpan" id="kobo.2368.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.2369.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2370.1">Let’s open a </span><a id="_idIndexMarker744"/><span class="koboSpan" id="kobo.2371.1">new browser tab and access the desktop environment using the</span><a id="_idIndexMarker745"/> <span class="No-Break"><span class="koboSpan" id="kobo.2372.1">following URL:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2373.1">
http://</span><strong class="bold"><span class="koboSpan" id="kobo.2374.1">&lt;ATTACKER VM PUBLIC IP ADDRESS&gt;</span></strong><span class="koboSpan" id="kobo.2375.1">:8081/vnc.html</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2376.1">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2377.1">&lt;ATTACKER VM PUBLIC IP ADDRESS&gt;</span></strong><span class="koboSpan" id="kobo.2378.1"> with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2379.1">vm_kali_public_ip</span></strong><span class="koboSpan" id="kobo.2380.1"> output value after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2381.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2382.1">apply</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2383.1"> command:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer130">
<span class="koboSpan" id="kobo.2384.1"><img alt="" src="image/B19755_05_019..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2385.1">Figure 5.19 – noVNC welcome screen</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2386.1">This should open a welcome screen with a </span><strong class="bold"><span class="koboSpan" id="kobo.2387.1">Connect</span></strong><span class="koboSpan" id="kobo.2388.1"> button, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2389.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2390.1">.19</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2391.1">.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2392.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2393.1">If you find yourself unable to access the welcome screen, your IP address might have changed already. </span><span class="koboSpan" id="kobo.2393.2">Simply update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2394.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.2395.1"> file and then run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2396.1">terraform apply</span></strong><span class="koboSpan" id="kobo.2397.1"> command again to update the firewall rule to whitelist your new </span><span class="No-Break"><span class="koboSpan" id="kobo.2398.1">IP address.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.2399.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2400.1">Connect</span></strong><span class="koboSpan" id="kobo.2401.1"> button </span><a id="_idIndexMarker746"/><span class="koboSpan" id="kobo.2402.1">and then use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2403.1">kali123</span></strong><span class="koboSpan" id="kobo.2404.1"> password (or the password</span><a id="_idIndexMarker747"/><span class="koboSpan" id="kobo.2405.1"> you specified previously in this chapter) to access the desktop environment, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2406.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2407.1">.20</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2408.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer131">
<span class="koboSpan" id="kobo.2409.1"><img alt="" src="image/B19755_05_020..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2410.1">Figure 5.20 – Accessing the Kali Linux desktop/GUI environment in the browser</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2411.1">Once we’re able to access the desktop environment, we should be able to perform various tasks and access the wide range of tools and utilities available in Kali Linux (similar to how we would use it on our </span><span class="No-Break"><span class="koboSpan" id="kobo.2412.1">local machine).</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2413.1">Open a Terminal window inside the Kali Linux instance by clicking the icon highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2414.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2415.1">.21</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2416.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer132">
<span class="koboSpan" id="kobo.2417.1"><img alt="" src="image/B19755_05_021..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2418.1">Figure 5.21 – Opening a Terminal window</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2419.1">This should open a Terminal </span><a id="_idIndexMarker748"/><span class="koboSpan" id="kobo.2420.1">window where we can run commands after the </span><strong class="bold"><span class="koboSpan" id="kobo.2421.1">$</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2422.1">sign.</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.2423.1">Set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2424.1">TARGET_IP</span></strong><span class="koboSpan" id="kobo.2425.1"> variable </span><a id="_idIndexMarker749"/><span class="koboSpan" id="kobo.2426.1">value to the private IP address of the </span><span class="No-Break"><span class="koboSpan" id="kobo.2427.1">target VM:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2428.1">
TARGET_IP=</span><strong class="bold"><span class="koboSpan" id="kobo.2429.1">&lt;PRIVATE IP ADDRESS OF TARGET VM&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2430.1">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2431.1">&lt;PRIVATE IP ADDRESS OF TARGET VM&gt;</span></strong><span class="koboSpan" id="kobo.2432.1"> with the private IP address of the target VM instance (for </span><span class="No-Break"><span class="koboSpan" id="kobo.2433.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2434.1">10.0.1.4</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2435.1">).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2436.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2437.1">Note that you might get a different private IP address for the target VM. </span><span class="koboSpan" id="kobo.2437.2">Feel free to check the Terraform output value (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2438.1">vm_target_private_ip</span></strong><span class="koboSpan" id="kobo.2439.1">) by running </span><strong class="source-inline"><span class="koboSpan" id="kobo.2440.1">terraform output</span></strong><span class="koboSpan" id="kobo.2441.1"> inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2442.1">~/pentest_lab</span></strong><span class="koboSpan" id="kobo.2443.1"> directory in the Cloud </span><span class="No-Break"><span class="koboSpan" id="kobo.2444.1">Shell Terminal.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.2445.1">Let’s start by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.2446.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2447.1">nmap --top-ports 1000 $TARGET_IP</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2448.1">This should yield a scan report similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2449.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2450.1">.22</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2451.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer133">
<span class="koboSpan" id="kobo.2452.1"><img alt="" src="image/B19755_05_022..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2453.1">Figure 5.22 – Result after running the nmap command again</span></p>
<p class="list-inset"><em class="italic"><span class="koboSpan" id="kobo.2454.1">What just happened?</span></em><span class="koboSpan" id="kobo.2455.1"> Here, we</span><a id="_idIndexMarker750"/><span class="koboSpan" id="kobo.2456.1"> used Nmap to check and scan the open ports on the target VM instance. </span><span class="koboSpan" id="kobo.2456.2">To</span><a id="_idIndexMarker751"/><span class="koboSpan" id="kobo.2457.1"> quickly check for open ports, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2458.1">--top-ports</span></strong><span class="koboSpan" id="kobo.2459.1"> option while running Nmap. </span><span class="koboSpan" id="kobo.2459.2">This allowed us to get (non-exhaustive) scan results within just a </span><span class="No-Break"><span class="koboSpan" id="kobo.2460.1">few seconds:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer134">
<span class="koboSpan" id="kobo.2461.1"><img alt="" src="image/B19755_05_023..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2462.1">Figure 5.23 – Using the Nmap scanner to scan the open ports</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2463.1">Since we mapped some of the container’s ports to the VM, we are effectively using Nmap to scan and </span><a id="_idIndexMarker752"/><span class="koboSpan" id="kobo.2464.1">examine the services running within the Metasploitable 2 container </span><span class="No-Break"><span class="koboSpan" id="kobo.2465.1">as </span></span><span class="No-Break"><a id="_idIndexMarker753"/></span><span class="No-Break"><span class="koboSpan" id="kobo.2466.1">well.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2467.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2468.1">Feel free to check the boot script we used to configure the target VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2469.1">vm-target</span></strong><span class="koboSpan" id="kobo.2470.1">) for more </span><span class="No-Break"><span class="koboSpan" id="kobo.2471.1">details: </span></span><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/blob/main/ch05/pentest_lab/target_vm/boot-script.sh"><span class="No-Break"><span class="koboSpan" id="kobo.2472.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/blob/main/ch05/pentest_lab/target_vm/boot-script.sh</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2473.1">.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.2474.1">Next, let’s run the same command but this time with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2475.1">-sV</span></strong><span class="koboSpan" id="kobo.2476.1"> (service version detection) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2477.1">-sV</span></strong><span class="koboSpan" id="kobo.2478.1"> (TCP SYN scan) </span><span class="No-Break"><span class="koboSpan" id="kobo.2479.1">flags enabled:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2480.1">nmap --top-ports 1000 -sV -sS $TARGET_IP</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2481.1">This should yield a scan report similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2482.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2483.1">.24</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2484.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer135">
<span class="koboSpan" id="kobo.2485.1"><img alt="" src="image/B19755_05_024..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2486.1">Figure 5.24 – Result after running the nmap command again</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2487.1">Here, we can see that </span><a id="_idIndexMarker754"/><span class="koboSpan" id="kobo.2488.1">with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2489.1">-sV</span></strong><span class="koboSpan" id="kobo.2490.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2491.1">-sS</span></strong><span class="koboSpan" id="kobo.2492.1"> flags enabled, we can determine the characteristics (such as the </span><a id="_idIndexMarker755"/><span class="koboSpan" id="kobo.2493.1">version or fingerprint) of the services running in each port of the target </span><span class="No-Break"><span class="koboSpan" id="kobo.2494.1">VM instance.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2495.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2496.1">This step may take around 4-10 minutes to complete. </span><span class="koboSpan" id="kobo.2496.2">Feel free to grab a cup of coffee or tea while </span><span class="No-Break"><span class="koboSpan" id="kobo.2497.1">you’re waiting!</span></span></p>
<h2 id="_idParaDest-113"><a id="_idTextAnchor112"/><span class="koboSpan" id="kobo.2498.1">Part 2 of 4 – Using the VNC login scanner module of Metasploit</span></h2>
<p><span class="koboSpan" id="kobo.2499.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.2500.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2501.1">In the previous set </span><a id="_idIndexMarker756"/><span class="koboSpan" id="kobo.2502.1">of steps, we used Nmap to identify the open ports </span><a id="_idIndexMarker757"/><span class="koboSpan" id="kobo.2503.1">along with the services running in each of these ports. </span><span class="koboSpan" id="kobo.2503.2">While there are several ports open, we will focus on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.2504.1">5900</span></strong><span class="koboSpan" id="kobo.2505.1"> and use the VNC login auxiliary scanner module of Metasploit to try and authenticate using different username and </span><span class="No-Break"><span class="koboSpan" id="kobo.2506.1">password combinations:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer136">
<span class="koboSpan" id="kobo.2507.1"><img alt="" src="image/B19755_05_025..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2508.1">Figure 5.25 – Using the VNC login auxiliary scanner to authenticate</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2509.1">Using the scanner, we will </span><a id="_idIndexMarker758"/><span class="koboSpan" id="kobo.2510.1">check if weak or default credentials are used to access the running VNC server process (application). </span><span class="koboSpan" id="kobo.2510.2">Now that we </span><a id="_idIndexMarker759"/><span class="koboSpan" id="kobo.2511.1">have a better understanding of how the VNC login auxiliary scanner works, let’s execute the </span><span class="No-Break"><span class="koboSpan" id="kobo.2512.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2513.1">msfconsole</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.2514.1">This will launch the Metasploit Framework console, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2515.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2516.1">.26</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2517.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer137">
<span class="koboSpan" id="kobo.2518.1"><img alt="" src="image/B19755_05_026..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2519.1">Figure 5.26 – Metasploit Framework console</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2520.1">Note that it may take a</span><a id="_idIndexMarker760"/><span class="koboSpan" id="kobo.2521.1"> minute or two for </span><strong class="source-inline"><span class="koboSpan" id="kobo.2522.1">msfconsole</span></strong><span class="koboSpan" id="kobo.2523.1"> to</span><a id="_idIndexMarker761"/> <span class="No-Break"><span class="koboSpan" id="kobo.2524.1">be ready.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2525.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2526.1">In case you are not aware, the Metasploit Framework is a framework written using the Ruby language! </span><span class="koboSpan" id="kobo.2526.2">Even if you have not used Ruby to write scripts or build applications before, you will be able to understand the code written using said language. </span><span class="koboSpan" id="kobo.2526.3">To see how the scanner works behind the scenes, feel free to check out the official Metasploit Framework GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.2527.1">repository: </span></span><a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/scanner/vnc/vnc_login.rb"><span class="No-Break"><span class="koboSpan" id="kobo.2528.1">https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/scanner/vnc/vnc_login.rb</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2529.1">.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.2530.1">Now, run the following </span><span class="No-Break"><span class="koboSpan" id="kobo.2531.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2532.1">msfconsole</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2533.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2534.1">search vnc login</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2535.1">This will search the module </span><a id="_idIndexMarker762"/><span class="koboSpan" id="kobo.2536.1">database and return a set </span><a id="_idIndexMarker763"/><span class="koboSpan" id="kobo.2537.1">of results, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2538.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2539.1">.27</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2540.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer138">
<span class="koboSpan" id="kobo.2541.1"><img alt="" src="image/B19755_05_027..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2542.1">Figure 5.27 – Results after executing the search vnc login command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2543.1">Since we are planning to scan and attempt to log in via VNC, we will choose the first one (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2544.1">auxiliary/scanner/vnc/vnc_login</span></strong><span class="koboSpan" id="kobo.2545.1">) in the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.2546.1">of steps.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2547.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2548.1">Here, you’ll notice that the module path (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2549.1">auxiliary/scanner/vnc/vnc_login</span></strong><span class="koboSpan" id="kobo.2550.1">) matches the file path (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2551.1">auxiliary/scanner/vnc/vnc_login.rb</span></strong><span class="koboSpan" id="kobo.2552.1">) where the Ruby code is stored inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2553.1">modules</span></strong><span class="koboSpan" id="kobo.2554.1"> directory (without the </span><em class="italic"><span class="koboSpan" id="kobo.2555.1">.rb</span></em><span class="koboSpan" id="kobo.2556.1"> file extension). </span><span class="koboSpan" id="kobo.2556.2">This means that if we need to check how a module has been implemented, we can simply locate the corresponding file inside the Metasploit Framework </span><span class="No-Break"><span class="koboSpan" id="kobo.2557.1">GitHub repository.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2558.1">Next, execute the following command to use the VNC login auxiliary </span><span class="No-Break"><span class="koboSpan" id="kobo.2559.1">scanner module:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2560.1">use auxiliary/scanner/vnc/vnc_login</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2561.1">Running this command will make the system ready to proceed with the module’s configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.2562.1">and execution.</span></span></p></li> <li><span class="koboSpan" id="kobo.2563.1">Now that we have selected the VNC login auxiliary scanner module, let’s run the following to configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2564.1">RHOST</span></strong><span class="koboSpan" id="kobo.2565.1"> (remote host) variable with the private IP address of the </span><span class="No-Break"><span class="koboSpan" id="kobo.2566.1">target VM:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2567.1">set RHOST &lt;PRIVATE IP ADDRESS OF TARGET VM&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2568.1">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2569.1">&lt;PRIVATE IP ADDRESS OF TARGET VM&gt;</span></strong><span class="koboSpan" id="kobo.2570.1"> with the private IP address </span><a id="_idIndexMarker764"/><span class="koboSpan" id="kobo.2571.1">of the target VM instance before running </span><span class="No-Break"><span class="koboSpan" id="kobo.2572.1">the command.</span></span></p></li> <li><span class="koboSpan" id="kobo.2573.1">Let’s quickly check the settings </span><a id="_idIndexMarker765"/><span class="koboSpan" id="kobo.2574.1">and options we have before running </span><span class="No-Break"><span class="koboSpan" id="kobo.2575.1">the scanner:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2576.1">show options</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2577.1">This should return a list of module options, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2578.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2579.1">.28</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2580.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer139">
<span class="koboSpan" id="kobo.2581.1"><img alt="" src="image/B19755_05_028..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2582.1">Figure 5.28 – Output after executing the show options command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2583.1">Here, we can see a description of each module option, along with which options are required. </span><span class="koboSpan" id="kobo.2583.2">As </span><a id="_idIndexMarker766"/><span class="koboSpan" id="kobo.2584.1">shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2585.1">Figure 5</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2586.1">.</span></em><em class="italic"><span class="koboSpan" id="kobo.2587.1">28</span></em><span class="koboSpan" id="kobo.2588.1">, all required </span><a id="_idIndexMarker767"/><span class="koboSpan" id="kobo.2589.1">options have been </span><span class="No-Break"><span class="koboSpan" id="kobo.2590.1">set accordingly.</span></span></p></li>
</ol>
<ol>
<li value="6"><span class="koboSpan" id="kobo.2591.1">With everything ready, let’s run </span><span class="No-Break"><span class="koboSpan" id="kobo.2592.1">the scanner:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2593.1">run</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2594.1">This should give us </span><span class="No-Break"><span class="koboSpan" id="kobo.2595.1">the following:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer140">
<span class="koboSpan" id="kobo.2596.1"><img alt="" src="image/B19755_05_029..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2597.1">Figure 5.29 – Output after executing the run command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2598.1">Here, we can see that we should be able to log in using </span><strong class="source-inline"><span class="koboSpan" id="kobo.2599.1">password</span></strong><span class="koboSpan" id="kobo.2600.1">. </span><span class="koboSpan" id="kobo.2600.2">Wow! </span><span class="koboSpan" id="kobo.2600.3">While this may seem a bit too easy, it is relatively common for users and administrators to overlook the importance of changing default or weak passwords, thus providing a convenient entry point for exploitation in a penetration </span><span class="No-Break"><span class="koboSpan" id="kobo.2601.1">testing exercise.</span></span></p></li>
</ol>
<ol>
<li value="7"><span class="koboSpan" id="kobo.2602.1">Now, let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.2603.1">exit </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2604.1">msfconsole</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2605.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2606.1">exit</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2607.1">Back in our Terminal console (with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2608.1">msfconsole</span></strong><span class="koboSpan" id="kobo.2609.1"> exited already), let’s run the following command to check if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2610.1">$TARGET_IP</span></strong><span class="koboSpan" id="kobo.2611.1"> variable value is </span><span class="No-Break"><span class="koboSpan" id="kobo.2612.1">still set:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2613.1">echo $TARGET_IP</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2614.1">If not, just set it to the private IP address of the target VM </span><span class="No-Break"><span class="koboSpan" id="kobo.2615.1">instance again.</span></span></p></li> <li><span class="koboSpan" id="kobo.2616.1">Let’s check if we’re able to log into the </span><span class="No-Break"><span class="koboSpan" id="kobo.2617.1">VNC server:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2618.1">vncviewer $TARGET_IP</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2619.1">After using </span><strong class="source-inline"><span class="koboSpan" id="kobo.2620.1">password</span></strong><span class="koboSpan" id="kobo.2621.1"> as the password, a window similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2622.1">Figure 5</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2623.1">.30</span></em> <span class="No-Break"><span class="koboSpan" id="kobo.2624.1">should open:</span></span></p><div class="IMG---Figure" id="_idContainer141"><span class="koboSpan" id="kobo.2625.1"><img alt="" src="image/B19755_05_030..jpg"/></span></div> <p class="IMG---Caption" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor113"/></p>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2626.1">Figure 5.30 – Using vncviewer to access the Metasploitable 2 container</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2627.1">Here, it is important to </span><a id="_idIndexMarker768"/><span class="koboSpan" id="kobo.2628.1">note that we are inside the Metasploitable 2 container </span><a id="_idIndexMarker769"/><span class="koboSpan" id="kobo.2629.1">running inside the VM instance. </span><em class="italic"><span class="koboSpan" id="kobo.2630.1">How do we know this?</span></em> <em class="italic"><span class="koboSpan" id="kobo.2631.1">Well, for one thing, we designed and built this penetration testing lab setup ourselves!</span></em><span class="koboSpan" id="kobo.2632.1"> Joking aside, we will confirm this in the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.2633.1">of steps.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2634.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2635.1">Note that, alternatively, we can run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2636.1">echo "password" | vncviewer $TARGET_IP -autopass</span></strong><span class="koboSpan" id="kobo.2637.1"> to accomplish the </span><span class="No-Break"><span class="koboSpan" id="kobo.2638.1">same thing.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.2639.1">Let’s run the following command in the Terminal window inside the </span><strong class="bold"><span class="koboSpan" id="kobo.2640.1">TightVNC: root’s X </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2641.1">desktop</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2642.1"> window:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2643.1">id</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2644.1">This should return </span><strong class="source-inline"><span class="koboSpan" id="kobo.2645.1">uid=0(root) </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2646.1">gid=0(root) groups=0(root)</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2647.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.2648.1">Next, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2649.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2650.1">lsb_release -a</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2651.1">We will see that we are</span><a id="_idIndexMarker770"/><span class="koboSpan" id="kobo.2652.1"> running this command inside an </span><strong class="bold"><span class="koboSpan" id="kobo.2653.1">Ubuntu 8.04</span></strong><span class="koboSpan" id="kobo.2654.1"> “environment,” similar to </span><a id="_idIndexMarker771"/><span class="koboSpan" id="kobo.2655.1">what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2656.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2657.1">.31</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2658.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer142">
<span class="koboSpan" id="kobo.2659.1"><img alt="" src="image/B19755_05_031..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2660.1">Figure 5.31 – Result after running lsb_release -a inside the container</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2661.1">This is the expected result given that we are inside a running Metasploitable 2 container inside the target </span><span class="No-Break"><span class="koboSpan" id="kobo.2662.1">VM instance.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2663.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2664.1">Note that this is just one of the ways to exploit </span><strong class="bold"><span class="koboSpan" id="kobo.2665.1">Metasploitable 2</span></strong><span class="koboSpan" id="kobo.2666.1">. </span><span class="koboSpan" id="kobo.2666.2">For more information, feel free to check </span><span class="No-Break"><span class="koboSpan" id="kobo.2667.1">out </span></span><a href="https://docs.rapid7.com/metasploit/metasploitable-2-exploitability-guide/"><span class="No-Break"><span class="koboSpan" id="kobo.2668.1">https://docs.rapid7.com/metasploit/metasploitable-2-exploitability-guide/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2669.1">.</span></span></p>
<h2 id="_idParaDest-114"><a id="_idTextAnchor114"/><span class="koboSpan" id="kobo.2670.1">Part 3 of 4 – Breaking out of the container</span></h2>
<p><span class="koboSpan" id="kobo.2671.1">At this point, we currently are</span><a id="_idIndexMarker772"/><span class="koboSpan" id="kobo.2672.1"> inside the running Metasploitable 2 container. </span><span class="koboSpan" id="kobo.2672.2">Now, let’s check if we can break out of </span><span class="No-Break"><span class="koboSpan" id="kobo.2673.1">the container!</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer143">
<span class="koboSpan" id="kobo.2674.1"><img alt="" src="image/B19755_05_032..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2675.1">Figure 5.32 – Breaking out of the container</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2676.1">Container breakout techniques involve exploiting vulnerabilities within a Docker environment to gain unauthorized access outside of the running container. </span><span class="koboSpan" id="kobo.2676.2">Techniques range from kernel vulnerabilities and shared namespaces to insecure container configurations. </span><span class="koboSpan" id="kobo.2676.3">In this part, we will run a sequence of commands to break out of a container running in </span><span class="No-Break"><span class="koboSpan" id="kobo.2677.1">privileged mode:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2678.1">Let’s start by quickly checking and listing all existing disk partitions using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2679.1">fdisk -</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2680.1">l</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2681.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2682.1">fdisk -l</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2683.1">This should display the disk partitions on the system, providing information about their sizes, types, and filesystems, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2684.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2685.1">.34</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2686.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer144">
<span class="koboSpan" id="kobo.2687.1"><img alt="" src="image/B19755_05_033..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2688.1">Figure 5.33 – Output after running the fdisk -l command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2689.1">Here, we can see that we can try mounting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2690.1">/dev/sda1</span></strong><span class="koboSpan" id="kobo.2691.1"> partition to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2692.1">/mnt</span></strong><span class="koboSpan" id="kobo.2693.1"> (which is what we will </span><a id="_idIndexMarker773"/><span class="koboSpan" id="kobo.2694.1">do in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2695.1">next step!).</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.2696.1">Next, let’s use the following command to mount the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2697.1">/dev/sda1</span></strong><span class="koboSpan" id="kobo.2698.1"> partition to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2699.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2700.1">mnt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2701.1"> directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2702.1">mount /dev/sda1 /mnt</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2703.1">Let’s navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2704.1">/mnt</span></strong><span class="koboSpan" id="kobo.2705.1"> directory and then perform </span><strong class="source-inline"><span class="koboSpan" id="kobo.2706.1">chroot</span></strong><span class="koboSpan" id="kobo.2707.1"> inside </span><span class="No-Break"><span class="koboSpan" id="kobo.2708.1">the directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2709.1">cd /mnt</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2710.1">chroot .</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2711.1">Here, we are using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2712.1">chroot</span></strong><span class="koboSpan" id="kobo.2713.1"> command to break out of </span><span class="No-Break"><span class="koboSpan" id="kobo.2714.1">the container.</span></span></p></li> <li><span class="koboSpan" id="kobo.2715.1">Use the following command to check the identity information of the </span><span class="No-Break"><span class="koboSpan" id="kobo.2716.1">current user:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2717.1">id</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2718.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.2719.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2720.1">uid=0(root) gid=0(root) groups=0(root)</span></pre></li> <li><span class="koboSpan" id="kobo.2721.1">Let’s check the specific distribution and version of the operating system using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2722.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2723.1">lsb_release -a</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2724.1">You will be surprised to </span><a id="_idIndexMarker774"/><span class="koboSpan" id="kobo.2725.1">see that we’re now getting </span><strong class="bold"><span class="koboSpan" id="kobo.2726.1">Ubuntu 22.02 LTS</span></strong><span class="koboSpan" id="kobo.2727.1"> instead of </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2728.1">Ubuntu 8.04</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2729.1">!</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer145">
<span class="koboSpan" id="kobo.2730.1"><img alt="" src="image/B19755_05_034..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2731.1">Figure 5.34 – Output after running the lsb_release -a command</span></p>
<p class="list-inset"><em class="italic"><span class="koboSpan" id="kobo.2732.1">This means that we were able to successfully break out of the container</span></em><span class="koboSpan" id="kobo.2733.1"> and we should be able to run certain commands as the root user of the </span><span class="No-Break"><span class="koboSpan" id="kobo.2734.1">VM instance!</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2735.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2736.1">Running a container with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2737.1">--privileged</span></strong><span class="koboSpan" id="kobo.2738.1"> flag grants the container unrestricted access to the host system’s resources. </span><span class="koboSpan" id="kobo.2738.2">Given that the isolation and security mechanisms and features are deactivated when this flag is enabled, an attacker (or someone playing the role of the attacker) can break out of the container using various container breakout techniques. </span><span class="koboSpan" id="kobo.2738.3">We won’t dive deep into the details of this topic, so feel free to check other resources </span><span class="No-Break"><span class="koboSpan" id="kobo.2739.1">available online.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.2740.1">Open a Firefox</span><a id="_idIndexMarker775"/><span class="koboSpan" id="kobo.2741.1"> browser (inside the Kali Linux desktop environment) and navigate to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2742.1">following URL:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2743.1">
bit.ly/create-ssh-user</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2744.1">This should open a page similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2745.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2746.1">.35</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2747.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer146">
<span class="koboSpan" id="kobo.2748.1"><img alt="" src="image/B19755_05_035..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2749.1">Figure 5.35 – Commands we will use in the next set of steps</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2750.1">Here, we have a reference for the commands we will use in the succeeding set of steps. </span><span class="koboSpan" id="kobo.2750.2">While this step is optional, having a cheat sheet or a reference will come in handy as we might accidentally miss a character or two when typing and running </span><span class="No-Break"><span class="koboSpan" id="kobo.2751.1">these commands!</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2752.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2753.1">This shortened link will open the following GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.2754.1">Gist: </span></span><a href="https://gist.githubusercontent.com/joshualat/bec319f607001e1ffd69d41d031a5526/raw/030e7efc13bddfb64fb50935fe0487054589dcdc/create_user.sh"><span class="No-Break"><span class="koboSpan" id="kobo.2755.1">https://gist.githubusercontent.com/joshualat/bec319f607001e1ffd69d41d031a5526/raw/030e7efc13bddfb64fb50935fe0487054589dcdc/create_user.sh</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2756.1">.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.2757.1">Now, navigate back to the Terminal inside the VNC viewer window (</span><strong class="bold"><span class="koboSpan" id="kobo.2758.1">TightVNC: root’s X desktop</span></strong><span class="koboSpan" id="kobo.2759.1">). </span><span class="koboSpan" id="kobo.2759.2">Let’s create a new user by running the following commands (one line at </span><span class="No-Break"><span class="koboSpan" id="kobo.2760.1">a time):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2761.1">NEW_USER=new_user</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2762.1">adduser --disabled-password --gecos "" $NEW_USER</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2763.1">echo "$NEW_USER ALL=(ALL) NOPASSWD:ALL" | tee -a /etc/sudoers &gt;/dev/null</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2764.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2765.1">Be careful when typing and running these commands! </span><span class="koboSpan" id="kobo.2765.2">Make sure you check the spelling and capitalization of the commands, flags, and arguments used. </span><span class="koboSpan" id="kobo.2765.3">Finally, be mindful of the spaces </span><span class="No-Break"><span class="koboSpan" id="kobo.2766.1">as well.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.2767.1">Next, let’s set up the </span><a id="_idIndexMarker776"/><span class="koboSpan" id="kobo.2768.1">necessary prerequisites for SSH access for the new user by running the following commands (one line at </span><span class="No-Break"><span class="koboSpan" id="kobo.2769.1">a time):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2770.1">mkdir -p /home/$NEW_USER/.ssh</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2771.1">chown $NEW_USER:$NEW_USER /home/$NEW_USER/.ssh</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2772.1">chmod 700 /home/$NEW_USER/.ssh</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2773.1">echo "$NEW_USER:password" | chpasswd</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2774.1">systemctl restart ssh</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2775.1">After running the last line from the preceding block of commands, we should receive a </span><strong class="bold"><span class="koboSpan" id="kobo.2776.1">System has not been booted with systemd as init system...</span></strong><span class="koboSpan" id="kobo.2777.1"> message, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2778.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2779.1">.36</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2780.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer147">
<span class="koboSpan" id="kobo.2781.1"><img alt="" src="image/B19755_05_036..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2782.1">Figure 5.36 – Creating a new SSH user</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2783.1">At this point, we should be able to access the VM instance directly via SSH using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2784.1">new_user</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2785.1"> user.</span></span></p></li>
</ol>
<ol>
<li value="9"><span class="koboSpan" id="kobo.2786.1">Close the VNC viewer (</span><strong class="bold"><span class="koboSpan" id="kobo.2787.1">TightVNC: root’s X desktop</span></strong><span class="koboSpan" id="kobo.2788.1">) window and close the Firefox browser window </span><span class="No-Break"><span class="koboSpan" id="kobo.2789.1">as well.</span></span></li>
<li><span class="koboSpan" id="kobo.2790.1">Back in our Terminal shell (where we previously ran </span><strong class="source-inline"><span class="koboSpan" id="kobo.2791.1">vncviewer $TARGET_IP</span></strong><span class="koboSpan" id="kobo.2792.1">), quickly check if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2793.1">$TARGET_IP</span></strong><span class="koboSpan" id="kobo.2794.1"> variable value is still set to the private IP address </span><a id="_idIndexMarker777"/><span class="koboSpan" id="kobo.2795.1">of the target </span><span class="No-Break"><span class="koboSpan" id="kobo.2796.1">VM instance:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2797.1">echo $TARGET_IP</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2798.1">This should yield an IP address value similar </span><span class="No-Break"><span class="koboSpan" id="kobo.2799.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2800.1">10.0.1.4</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2801.1">.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2802.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2803.1">If you encounter strange characters while typing in the Terminal, simply close the noVNC browser tab (where we can access the Kali Linux desktop environment). </span><span class="koboSpan" id="kobo.2803.2">After that, reopen it in a new browser tab and check if the issue has </span><span class="No-Break"><span class="koboSpan" id="kobo.2804.1">been resolved.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.2805.1">Let’s check if we were able to properly set up SSH access for a new user (similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2806.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2807.1">.37</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2808.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer148">
<span class="koboSpan" id="kobo.2809.1"><img alt="" src="image/B19755_05_037..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2810.1">Figure 5.37 – Accessing the target instance via SSH using the new_user account</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2811.1">Here, we will try</span><a id="_idIndexMarker778"/><span class="koboSpan" id="kobo.2812.1"> authenticating using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2813.1">new_user</span></strong><span class="koboSpan" id="kobo.2814.1"> account we created in the previous set </span><span class="No-Break"><span class="koboSpan" id="kobo.2815.1">of steps.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2816.1">Once you are ready, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2817.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2818.1">ssh new_user@$TARGET_IP</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.2819.1">When prompted for a password, use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2820.1">password</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2821.1">to proceed:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer149">
<span class="koboSpan" id="kobo.2822.1"><img alt="" src="image/B19755_05_038..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2823.1">Figure 5.38 – Accessing the target VM via SSH</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2824.1">If all the steps were performed correctly, we should be able to access the target VM instance via </span><a id="_idIndexMarker779"/><span class="koboSpan" id="kobo.2825.1">SSH, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2826.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2827.1">.38</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2828.1">.</span></span></p></li>
</ol>
<ol>
<li value="12"><span class="koboSpan" id="kobo.2829.1">Finally, let’s switch to the </span><strong class="bold"><span class="koboSpan" id="kobo.2830.1">root</span></strong><span class="koboSpan" id="kobo.2831.1"> user using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2832.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2833.1">sudo su</span></strong></pre><p class="list-inset"><em class="italic"><span class="koboSpan" id="kobo.2834.1">Wasn’t that fun?!</span></em><span class="koboSpan" id="kobo.2835.1"> Now, let’s proceed with searching for </span><span class="No-Break"><span class="koboSpan" id="kobo.2836.1">the flags!</span></span></p></li> </ol>
<h2 id="_idParaDest-115"><a id="_idTextAnchor115"/><span class="koboSpan" id="kobo.2837.1">Part 4 of 4 – Locating the flags</span></h2>
<p><span class="koboSpan" id="kobo.2838.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.2839.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2840.1">Let’s locate the first flag by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.2841.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2842.1">find / -type f -name "flag*"</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2843.1">This will search the entire filesystem for files with a filename starting with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2844.1">flag</span></strong><span class="koboSpan" id="kobo.2845.1">. </span><span class="koboSpan" id="kobo.2845.2">After a few minutes, we should </span><a id="_idIndexMarker780"/><span class="koboSpan" id="kobo.2846.1">get a list of results that includes a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2847.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2848.1">root/flag1.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2849.1"> file:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2850.1">...
</span><span class="koboSpan" id="kobo.2850.2">/root/flag1.txt
...</span></pre></li> <li><span class="koboSpan" id="kobo.2851.1">Now, let’s check the contents </span><span class="No-Break"><span class="koboSpan" id="kobo.2852.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2853.1">/root/flag1.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2854.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2855.1">cat /root/flag1.txt</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2856.1">This should give us </span><strong class="source-inline"><span class="koboSpan" id="kobo.2857.1">FLAG # 1!</span></strong><span class="koboSpan" id="kobo.2858.1">. </span><span class="koboSpan" id="kobo.2858.2">One down, one more </span><span class="No-Break"><span class="koboSpan" id="kobo.2859.1">to go!</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2860.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2861.1">When setting up penetration testing lab environments, feel free to use a cryptographic hash function or a random string generator to generate a unique value for </span><span class="No-Break"><span class="koboSpan" id="kobo.2862.1">the flags.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2863.1">Let’s check if the Azure CLI </span><span class="No-Break"><span class="koboSpan" id="kobo.2864.1">is installed:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2865.1">which az</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2866.1">This should return the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2867.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2868.1">usr/bin/az</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2869.1"> path.</span></span></p></li> <li><span class="koboSpan" id="kobo.2870.1">Now, check the version as well using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2871.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2872.1">az </span></strong><strong class="bold"><span class="koboSpan" id="kobo.2873.1">--</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2874.1">version</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2875.1">This should give us the version number of the tool (along with its dependencies), similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2876.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2877.1">.39</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2878.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer150">
<span class="koboSpan" id="kobo.2879.1"><img alt="" src="image/B19755_05_039..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2880.1">Figure 5.39 – Result after running the az --version command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2881.1">Here, we can see that version </span><strong class="source-inline"><span class="koboSpan" id="kobo.2882.1">2.49.0</span></strong><span class="koboSpan" id="kobo.2883.1"> is currently installed in the target VM instance. </span><a id="_idIndexMarker781"/><span class="koboSpan" id="kobo.2884.1">Now that we have verified that we can use the Azure CLI inside the VM instance, let’s try signing in using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2885.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2886.1">az login --identity</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.2887.1">Here, we use the system-assigned managed identity of the VM instance to authenticate without (explicitly) </span><span class="No-Break"><span class="koboSpan" id="kobo.2888.1">requiring credentials:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer151">
<span class="koboSpan" id="kobo.2889.1"><img alt="" src="image/B19755_05_040..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2890.1">Figure 5.40 – Result after running the az login --identity command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2891.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2892.1">Figure 5</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2893.1">.40</span></em><span class="koboSpan" id="kobo.2894.1">, we can see</span><a id="_idIndexMarker782"/><span class="koboSpan" id="kobo.2895.1"> that we have logged in using the system-assigned identity of the target </span><span class="No-Break"><span class="koboSpan" id="kobo.2896.1">VM instance.</span></span></p></li>
</ol>
<ol>
<li value="5"><span class="koboSpan" id="kobo.2897.1">Let’s check if we can list all Azure Key Vaults from the Terminal using the Azure CLI (inside the VM instance), similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2898.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2899.1">.41</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2900.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer152">
<span class="koboSpan" id="kobo.2901.1"><img alt="" src="image/B19755_05_041..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2902.1">Figure 5.41 – Accessing Azure Key Vault from the VM instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2903.1">There are a few things </span><a id="_idIndexMarker783"/><span class="koboSpan" id="kobo.2904.1">we can check using the Azure CLI but we will proceed with checking the Azure Key Vault resources since we are trying to validate whether the lab environment has been </span><span class="No-Break"><span class="koboSpan" id="kobo.2905.1">configured correctly.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2906.1">That said, let’s run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2907.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2908.1">az keyvault list</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.2909.1">This should return a nested structure, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2910.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2911.1">.42</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2912.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer153">
<span class="koboSpan" id="kobo.2913.1"><img alt="" src="image/B19755_05_042..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2914.1">Figure 5.42 – Result after running the az keyvault list command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2915.1">Wait a minute! </span><span class="koboSpan" id="kobo.2915.2">How were we able to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2916.1">az keyvault list</span></strong><span class="koboSpan" id="kobo.2917.1"> command? </span><span class="koboSpan" id="kobo.2917.2">It seems </span><a id="_idIndexMarker784"/><span class="koboSpan" id="kobo.2918.1">that the system-assigned identity of the target VM instance allows us to authenticate and interact with Azure Key Vault without the need for explicit authentication </span><a id="_idIndexMarker785"/><span class="koboSpan" id="kobo.2919.1">credentials </span><span class="No-Break"><span class="koboSpan" id="kobo.2920.1">or secrets!</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2921.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2922.1">Note that you’ll get a different vault name value depending on how you configured the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2923.1">azurerm_key_vault.keyvault</span></strong><span class="koboSpan" id="kobo.2924.1"> resource in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2925.1">target_vm/main.tf</span></strong><span class="koboSpan" id="kobo.2926.1"> Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.2927.1">configuration file.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.2928.1">Next, let’s run the following command to list all the secrets stored </span><span class="No-Break"><span class="koboSpan" id="kobo.2929.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2930.1">rg-01-key-vault</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2931.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2932.1">az keyvault secret list --vault-name rg-01-key-vault</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2933.1">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2934.1">rg-01-key-vault</span></strong><span class="koboSpan" id="kobo.2935.1"> with the actual key vault </span><strong class="source-inline"><span class="koboSpan" id="kobo.2936.1">name</span></strong><span class="koboSpan" id="kobo.2937.1"> value that you retrieved after running the command from the previous step. </span><span class="koboSpan" id="kobo.2937.2">This should return a nested structure, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2938.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2939.1">.43</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2940.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer154">
<span class="koboSpan" id="kobo.2941.1"><img alt="" src="image/B19755_05_043..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2942.1">Figure 5.43 – Result after running the az keyvault secret list command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2943.1">Here, we can see that we have one </span><a id="_idIndexMarker786"/><span class="koboSpan" id="kobo.2944.1">secret stored called </span><strong class="source-inline"><span class="koboSpan" id="kobo.2945.1">flag2</span></strong><span class="koboSpan" id="kobo.2946.1">. </span><em class="italic"><span class="koboSpan" id="kobo.2947.1">What is the value that’s been mapped to this secret?</span></em><span class="koboSpan" id="kobo.2948.1"> We’ll find out in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2949.1">next step!</span></span></p></li>
</ol>
<ol>
<li value="7"><span class="koboSpan" id="kobo.2950.1">Finally, let’s retrieve the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2951.1">flag2</span></strong><span class="koboSpan" id="kobo.2952.1"> secret. </span><span class="koboSpan" id="kobo.2952.2">Again, make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2953.1">rg-01-key-vault</span></strong><span class="koboSpan" id="kobo.2954.1"> with the actual Key Vault name you retrieved after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2955.1">az keyvault </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2956.1">list</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2957.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2958.1">az keyvault secret show --vault-name rg-01-key-vault --name "flag2"</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2959.1">This should return a nested JSON output, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2960.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2961.1">.44</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2962.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer155">
<span class="koboSpan" id="kobo.2963.1"><img alt="" src="image/B19755_05_044..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2964.1">Figure 5.44 – Result after running the az keyvault secret show command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2965.1">Here, we can see that </span><a id="_idIndexMarker787"/><span class="koboSpan" id="kobo.2966.1">the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2967.1">flag2</span></strong><span class="koboSpan" id="kobo.2968.1"> secret is </span><strong class="source-inline"><span class="koboSpan" id="kobo.2969.1">FLAG # </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2970.1">2!</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2971.1">.</span></span></p></li>
</ol>
<ol>
<li value="8"><span class="koboSpan" id="kobo.2972.1">Let’s run the same command, this time specifying </span><strong class="source-inline"><span class="koboSpan" id="kobo.2973.1">"value"</span></strong><span class="koboSpan" id="kobo.2974.1"> as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2975.1">--query</span></strong><span class="koboSpan" id="kobo.2976.1"> parameter value. </span><span class="koboSpan" id="kobo.2976.2">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.2977.1">rg-01-key-vault</span></strong><span class="koboSpan" id="kobo.2978.1"> with the Key Vault </span><strong class="source-inline"><span class="koboSpan" id="kobo.2979.1">name</span></strong><span class="koboSpan" id="kobo.2980.1"> value you retrieved after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2981.1">az keyvault </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2982.1">list</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2983.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2984.1">az keyvault secret show --vault-name rg-01-key-vault --name "flag2" --query "value"</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2985.1">Instead of a nested JSON output, we should get the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2986.1">FLAG # 2!</span></strong><span class="koboSpan" id="kobo.2987.1"> string value. </span><em class="italic"><span class="koboSpan" id="kobo.2988.1">Looks like we were able to successfully retrieve the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2989.1">second flag!</span></em></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2990.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2991.1">It is important to note that we are just scratching the surface of what we can do with Azure Key Vault. </span><span class="koboSpan" id="kobo.2991.2">For more information, feel free to check </span><span class="No-Break"><span class="koboSpan" id="kobo.2992.1">out </span></span><a href="https://learn.microsoft.com/en-us/azure/key-vault/general/manage-with-cli2"><span class="No-Break"><span class="koboSpan" id="kobo.2993.1">https://learn.microsoft.com/en-us/azure/key-vault/general/manage-with-cli2</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2994.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.2995.1">Right now, you are probably excited to try out other exploits and techniques! </span><span class="koboSpan" id="kobo.2995.2">Given that we have automated the setup process, we can simply run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2996.1">terraform destroy -auto-approve</span></strong><span class="koboSpan" id="kobo.2997.1"> to delete the</span><a id="_idIndexMarker788"/><span class="koboSpan" id="kobo.2998.1"> resources and then run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2999.1">terraform apply -auto-approve</span></strong><span class="koboSpan" id="kobo.3000.1"> again to rebuild the entire environment. </span><span class="koboSpan" id="kobo.3000.2">Note that it is also possible to rebuild only a specific component of the environment by running a (one-liner) command, similar to </span><span class="No-Break"><span class="koboSpan" id="kobo.3001.1">the following:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.3002.1">terraform apply -replace=module.target_vm.azurerm_linux_virtual_machine.vm_target -auto-approve</span></strong></pre> <p><span class="koboSpan" id="kobo.3003.1">Running this command will destroy and recreate the target VM instance, along with other resources related to or dependent on it. </span><span class="koboSpan" id="kobo.3003.2">Given that penetration testing activities may leave the infrastructure in an unstable or misconfigured state, rebuilding the infrastructure will return it to the </span><span class="No-Break"><span class="koboSpan" id="kobo.3004.1">desired state.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.3005.1">Note</span></p>
<p class="callout"><em class="italic"><span class="koboSpan" id="kobo.3006.1">For one thing, the </span></em><strong class="source-inline"><span class="koboSpan" id="kobo.3007.1">new_user</span></strong><em class="italic"><span class="koboSpan" id="kobo.3008.1"> user should not be there in the first place, right?</span></em><span class="koboSpan" id="kobo.3009.1"> That said, recreating the target VM instance (along with other resources in the environment) would revert the setup to an “</span><span class="No-Break"><span class="koboSpan" id="kobo.3010.1">untouched” state.</span></span></p>
<h1 id="_idParaDest-116"><a id="_idTextAnchor116"/><span class="koboSpan" id="kobo.3011.1">Cleaning up</span></h1>
<p><span class="koboSpan" id="kobo.3012.1">Cleaning up the </span><a id="_idIndexMarker789"/><span class="koboSpan" id="kobo.3013.1">cloud resources we created or deployed is a crucial step when working with vulnerable cloud applications and environments. </span><span class="koboSpan" id="kobo.3013.2">If we don’t clean up and delete the resources we created right away, we might end up paying for unused cloud resources. </span><span class="koboSpan" id="kobo.3013.3">In addition to this, these cloud resources may end up being attacked by malicious users. </span><span class="koboSpan" id="kobo.3013.4">At a </span><em class="italic"><span class="koboSpan" id="kobo.3014.1">minimum</span></em><span class="koboSpan" id="kobo.3015.1">, we will be paying for the time the following resources </span><span class="No-Break"><span class="koboSpan" id="kobo.3016.1">are running:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.3017.1">1 x </span><strong class="source-inline"><span class="koboSpan" id="kobo.3018.1">Standard_DS1_v2</span></strong><span class="koboSpan" id="kobo.3019.1"> Azure VM instance for the </span><span class="No-Break"><span class="koboSpan" id="kobo.3020.1">attacker machine</span></span></li>
<li><span class="koboSpan" id="kobo.3021.1">1 x </span><strong class="source-inline"><span class="koboSpan" id="kobo.3022.1">Standard_D2s_v3</span></strong><span class="koboSpan" id="kobo.3023.1"> Azure VM instance for the </span><span class="No-Break"><span class="koboSpan" id="kobo.3024.1">target machine</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.3025.1">Please be aware that there are other costs we have to take into account as well — including data transfer fees, storage costs for persistent data used by the instances, and potential charges for other Azure services utilized in the account, along with any applicable taxes or fees</span><a id="_idIndexMarker790"/><span class="koboSpan" id="kobo.3026.1"> associated with the usage of </span><span class="No-Break"><span class="koboSpan" id="kobo.3027.1">Azure resources.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.3028.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3029.1">Since the overall cost when running these resources depends on several parameters, it is best to refer to the pricing documentation page provided by the cloud platform: </span><a href="https://azure.microsoft.com/en-us/pricing/details/virtual-machines/"><span class="koboSpan" id="kobo.3030.1">https://azure.microsoft.com/en-us/pricing/details/virtual-machines/</span></a><span class="koboSpan" id="kobo.3031.1">. </span><span class="koboSpan" id="kobo.3031.2">Since we utilized Azure Key Vault in the lab environment, feel free to check out the following as well: </span><a href="https://azure.microsoft.com/en-us/pricing/details/key-vault/"><span class="koboSpan" id="kobo.3032.1">https://azure.microsoft.com/en-us/pricing/details/key-vault/</span></a><span class="koboSpan" id="kobo.3033.1">. </span><span class="koboSpan" id="kobo.3033.2">You can also utilize the </span><strong class="bold"><span class="koboSpan" id="kobo.3034.1">Azure Pricing Calculator</span></strong><span class="koboSpan" id="kobo.3035.1"> to estimate </span><a id="_idIndexMarker791"/><span class="koboSpan" id="kobo.3036.1">the cost of deploying resources on Azure. </span><span class="koboSpan" id="kobo.3036.2">You can access the Azure Pricing Calculator </span><span class="No-Break"><span class="koboSpan" id="kobo.3037.1">at </span></span><a href="https://azure.microsoft.com/en-us/pricing/calculator/"><span class="No-Break"><span class="koboSpan" id="kobo.3038.1">https://azure.microsoft.com/en-us/pricing/calculator/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3039.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.3040.1">That said, let’s proceed with deleting the resources we created in </span><span class="No-Break"><span class="koboSpan" id="kobo.3041.1">this chapter:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.3042.1">Close the browser tab we used to access the Kali Linux </span><span class="No-Break"><span class="koboSpan" id="kobo.3043.1">desktop environment.</span></span></li>
<li><span class="koboSpan" id="kobo.3044.1">In the Cloud Shell Terminal, navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3045.1">~/pentest_lab</span></strong><span class="koboSpan" id="kobo.3046.1"> directory and then use </span><strong class="source-inline"><span class="koboSpan" id="kobo.3047.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.3048.1"> to clean up the resources we </span><span class="No-Break"><span class="koboSpan" id="kobo.3049.1">created earlier:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.3050.1">cd ~/pentest_lab</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.3051.1">terraform destroy -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.3052.1">Feel free to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3053.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.3054.1"> command a few times in case some resources fail to delete (or take a bit of time to delete). </span><span class="koboSpan" id="kobo.3054.2">Alternatively, you may delete resources manually using the user interface if all </span><span class="No-Break"><span class="koboSpan" id="kobo.3055.1">else fails.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3056.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3057.1">This step may take 10-15 minutes </span><span class="No-Break"><span class="koboSpan" id="kobo.3058.1">to complete.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.3059.1">Verify that the resources have been destroyed successfully using the </span><span class="No-Break"><span class="koboSpan" id="kobo.3060.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.3061.1">terraform show</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.3062.1">This should return an empty response since all the resources should have been </span><span class="No-Break"><span class="koboSpan" id="kobo.3063.1">deleted successfully.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3064.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3065.1">Feel free to perform a full audit of your Microsoft Azure account. </span><span class="koboSpan" id="kobo.3065.2">This will help ensure that all resources have been properly deleted, minimize the risk of unintended costs, and address any potential </span><span class="No-Break"><span class="koboSpan" id="kobo.3066.1">security concerns.</span></span></p>
<p><span class="koboSpan" id="kobo.3067.1">That’s pretty much it! </span><span class="koboSpan" id="kobo.3067.2">At</span><a id="_idIndexMarker792"/><span class="koboSpan" id="kobo.3068.1"> this point, we should have a good idea of how to prepare penetration testing lab environments on Microsoft Azure. </span><span class="koboSpan" id="kobo.3068.2">The penetration testing simulation we performed in the previous section should validate that our lab environment has been (mis)configured properly </span><span class="No-Break"><span class="koboSpan" id="kobo.3069.1">as well.</span></span></p>
<h1 id="_idParaDest-117"><a id="_idTextAnchor117"/><span class="koboSpan" id="kobo.3070.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.3071.1">In this chapter, we focused on setting up a penetration testing lab environment in Microsoft Azure. </span><span class="koboSpan" id="kobo.3071.2">We prepared a vulnerable-by-design lab setup where we can practice container breakout techniques to gain unauthorized access to host systems. </span><span class="koboSpan" id="kobo.3071.3">Our lab environment also highlighted the potential misuse of managed identities in Azure as these inadvertently create other exploitable attack paths for attackers. </span><span class="koboSpan" id="kobo.3071.4">After setting everything up, we performed a penetration testing simulation to validate if our lab environment had been (</span><span class="No-Break"><span class="koboSpan" id="kobo.3072.1">mis)configured correctly.</span></span></p>
<p><span class="koboSpan" id="kobo.3073.1">In the next chapter, our focus will shift to preparing a penetration testing lab environment on AWS. </span><span class="koboSpan" id="kobo.3073.2">In addition to setting up an isolated network environment, we’ll focus on preparing a lab setup where we can practice pivoting techniques that can be used to access internal systems and networks using the initially compromised machine. </span><span class="koboSpan" id="kobo.3073.3">If you are excited to learn how to build a pivoting lab, then the next chapter is </span><span class="No-Break"><span class="koboSpan" id="kobo.3074.1">for you!</span></span></p>
<h1 id="_idParaDest-118"><a id="_idTextAnchor118"/><span class="koboSpan" id="kobo.3075.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.3076.1">For additional information on the topics covered in this chapter, you may find the following </span><span class="No-Break"><span class="koboSpan" id="kobo.3077.1">resources helpful:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.3078.1">Connecting from your application to resources without handling </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3079.1">credentials</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3080.1"> (</span></span><a href="https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview-for-developers?tabs=portal%2Cdotnet"><span class="No-Break"><span class="koboSpan" id="kobo.3081.1">https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview-for-developers?tabs=portal%2Cdotnet</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3082.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3083.1">How managed identities for Azure resources work with Azure virtual </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3084.1">machines</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3085.1"> (</span></span><a href="https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-managed-identities-work-vm"><span class="No-Break"><span class="koboSpan" id="kobo.3086.1">https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-managed-identities-work-vm</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3087.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3088.1">Authentication in Azure Key </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3089.1">Vault</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3090.1"> (</span></span><a href="https://learn.microsoft.com/en-us/azure/key-vault/general/authentication"><span class="No-Break"><span class="koboSpan" id="kobo.3091.1">https://learn.microsoft.com/en-us/azure/key-vault/general/authentication</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3092.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3093.1">Manage Key Vault using the Azure </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3094.1">CLI</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3095.1"> (</span></span><a href="https://learn.microsoft.com/en-us/azure/key-vault/general/manage-with-cli2"><span class="No-Break"><span class="koboSpan" id="kobo.3096.1">https://learn.microsoft.com/en-us/azure/key-vault/general/manage-with-cli2</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3097.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3098.1">Best practices for using Azure Key </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3099.1">Vault</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3100.1"> (</span></span><a href="https://learn.microsoft.com/en-us/azure/key-vault/general/best-practices"><span class="No-Break"><span class="koboSpan" id="kobo.3101.1">https://learn.microsoft.com/en-us/azure/key-vault/general/best-practices</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3102.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3103.1">Metasploitable 2 Exploitability </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3104.1">Guide</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3105.1"> (</span></span><a href="https://docs.rapid7.com/metasploit/metasploitable-2-exploitability-guide/"><span class="No-Break"><span class="koboSpan" id="kobo.3106.1">https://docs.rapid7.com/metasploit/metasploitable-2-exploitability-guide/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3107.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3108.1">What is Microsoft Cost Management and </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3109.1">Billing?</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3110.1"> (</span></span><a href="https://learn.microsoft.com/en-us/azure/cost-management-billing/cost-management-billing-overview"><span class="No-Break"><span class="koboSpan" id="kobo.3111.1">https://learn.microsoft.com/en-us/azure/cost-management-billing/cost-management-billing-overview</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3112.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3113.1">How to optimize your cloud investment with Cost </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3114.1">Management</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3115.1"> (</span></span><a href="https://learn.microsoft.com/en-us/azure/cost-management-billing/costs/cost-mgt-best-practices"><span class="No-Break"><span class="koboSpan" id="kobo.3116.1">https://learn.microsoft.com/en-us/azure/cost-management-billing/costs/cost-mgt-best-practices</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3117.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3118.1">YouTube Playlist – Azure Cost </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3119.1">Management</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3120.1"> (</span></span><a href="https://www.youtube.com/playlist?list=PLLasX02E8BPBJW49E5_sHgbgvztb4oz6D"><span class="No-Break"><span class="koboSpan" id="kobo.3121.1">https://www.youtube.com/playlist?list=PLLasX02E8BPBJW49E5_sHgbgvztb4oz6D</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3122.1">)</span></span></li>
</ul>
</div>
</body></html>