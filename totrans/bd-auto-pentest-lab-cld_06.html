<html><head></head><body>
<div id="_idContainer198">
<h1 class="chapter-number" id="_idParaDest-119"><a id="_idTextAnchor119"/><span class="koboSpan" id="kobo.1.1">6</span></h1>
<h1 id="_idParaDest-120"><a id="_idTextAnchor120"/><span class="koboSpan" id="kobo.2.1">Setting Up Isolated Penetration Testing Lab Environments on AWS</span></h1>
<p><span class="koboSpan" id="kobo.3.1">If you have worked on real-world projects and systems running in the cloud, you are probably aware that actual network environments generally involve more than a single cloud resource. </span><span class="koboSpan" id="kobo.3.2">To ensure that critical resources are not exposed and directly accessible from resources outside of the network environment, cloud resources are grouped and proper network configuration involving security groups, network access control lists, and routing rules is implemented as well. </span><span class="koboSpan" id="kobo.3.3">With a segmented network architecture, attackers may need to compromise a less secure system first and then use this compromised system to pivot to critical resources in internal networks. </span><span class="koboSpan" id="kobo.3.4">This technique, known as </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">pivoting</span></strong><span class="koboSpan" id="kobo.5.1">, involves </span><a id="_idIndexMarker793"/><span class="koboSpan" id="kobo.6.1">using the right set of tools along with the correct sequence of steps, which can be mastered through practice. </span><span class="koboSpan" id="kobo.6.2">If only we had a lab environment where we could try out various tools and techniques for pivoting! </span><span class="koboSpan" id="kobo.6.3">Well, I have some good news for you – we will be setting up a </span><strong class="bold"><span class="koboSpan" id="kobo.7.1">pivoting lab</span></strong><span class="koboSpan" id="kobo.8.1"> on AWS in </span><span class="No-Break"><span class="koboSpan" id="kobo.9.1">this chapter!</span></span></p>
<p><span class="koboSpan" id="kobo.10.1">In case you are wondering what a pivoting lab is, it is a type of penetration testing lab where the focus is on moving from one compromised system to another within a target network and leveraging the compromised systems (as stepping stones) to gain access to other systems and resources. </span><span class="koboSpan" id="kobo.10.2">After setting up the pivoting lab, we will then perform a penetration testing simulation to verify if the lab environment has been </span><span class="No-Break"><span class="koboSpan" id="kobo.11.1">configured correctly.</span></span></p>
<p><span class="koboSpan" id="kobo.12.1">That said, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.14.1">Leveraging Terraform to automatically set up the </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">lab environment</span></span></li>
<li><span class="koboSpan" id="kobo.16.1">Validating network connectivity </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">and security</span></span></li>
<li><span class="koboSpan" id="kobo.18.1">Setting up the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">VM instance</span></span></li>
<li><span class="koboSpan" id="kobo.20.1">Simulating penetration testing in the isolated </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">network environment</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.22.1">Cleaning up</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.23.1">Without further ado, </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">let’s begin!</span></span></p>
<h1 id="_idParaDest-121"><a id="_idTextAnchor121"/><span class="koboSpan" id="kobo.25.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.26.1">Before we start, we must have the </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">following ready:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.28.1">An </span><strong class="bold"><span class="koboSpan" id="kobo.29.1">Amazon Web </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.30.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.31.1"> account</span></span></li>
<li><span class="koboSpan" id="kobo.32.1">Any text editor (such as Notepad++, Visual Studio Code, or Sublime Text) where we can temporarily store specific values (for example, our local machine’s IP address) used in the hands-on solutions in </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">this chapter</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.34.1">You may proceed with the next steps once these </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">are ready.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.36.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.37.1">Make sure you read the available documentation, along with the FAQs, to have a solid understanding of what is free (and what is not free) when creating resources in AWS. </span><span class="koboSpan" id="kobo.37.2">In addition to this, make sure you </span><em class="italic"><span class="koboSpan" id="kobo.38.1">don’t</span></em><span class="koboSpan" id="kobo.39.1"> use any existing AWS account with production (or staging) environment resources for the hands-on exercises and solutions in this book. </span><span class="koboSpan" id="kobo.39.2">It is strongly recommended that you create a </span><em class="italic"><span class="koboSpan" id="kobo.40.1">new</span></em><span class="koboSpan" id="kobo.41.1"> AWS account specifically for launching intentionally vulnerable resources. </span><span class="koboSpan" id="kobo.41.2">This will ensure that your production (or staging) environment resources remain separate </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">and secure.</span></span></p>
<p><span class="koboSpan" id="kobo.43.1">The source code and other files used for each chapter are available in this book’s GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">repository: </span></span><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/"><span class="No-Break"><span class="koboSpan" id="kobo.45.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.46.1">.</span></span></p>
<h1 id="_idParaDest-122"><a id="_idTextAnchor122"/><span class="koboSpan" id="kobo.47.1">Leveraging Terraform to automatically set up the lab environment</span></h1>
<p><span class="koboSpan" id="kobo.48.1">In this </span><a id="_idIndexMarker794"/><span class="koboSpan" id="kobo.49.1">chapter, we will have a network </span><a id="_idIndexMarker795"/><span class="koboSpan" id="kobo.50.1">environment in AWS that mimics the peered network setup we prepared in </span><span class="No-Break"><em class="italic"><a href="B19755_04.xhtml"><span class="koboSpan" id="kobo.51.1">Chapter 4</span></a></em></span><span class="koboSpan" id="kobo.52.1">, </span><em class="italic"><span class="koboSpan" id="kobo.53.1">Setting Up Isolated Penetration Testing Lab Environments on GCP</span></em><span class="koboSpan" id="kobo.54.1">, and </span><span class="No-Break"><em class="italic"><a href="B19755_05.xhtml"><span class="koboSpan" id="kobo.55.1">Chapter 5</span></a></em></span><span class="koboSpan" id="kobo.56.1">, </span><em class="italic"><span class="koboSpan" id="kobo.57.1">Setting Up Isolated Penetration Testing Lab Environments on Azure</span></em><span class="koboSpan" id="kobo.58.1">. </span><span class="koboSpan" id="kobo.58.2">It is important to note that while the chapter titles are very similar, the design of the lab environments in these chapters has </span><span class="No-Break"><span class="koboSpan" id="kobo.59.1">significant differences.</span></span></p>
<p><span class="koboSpan" id="kobo.60.1">Like the </span><a id="_idIndexMarker796"/><span class="koboSpan" id="kobo.61.1">previous chapters, we will use Terraform to set up the lab environment using various types of resources and components in our </span><a id="_idIndexMarker797"/><span class="koboSpan" id="kobo.62.1">AWS account. </span><span class="koboSpan" id="kobo.62.2">We must familiarize ourselves with the key AWS concepts and services before proceeding with the hands-on portion of this chapter. </span><span class="koboSpan" id="kobo.62.3">Once we have a solid understanding of the relevant AWS concepts and services, it will be much easier to interpret and tweak the Terraform configuration code. </span><span class="koboSpan" id="kobo.62.4">In case you are not yet familiar with the concepts, services, and resource types specific to AWS, here’s a quick overview to </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">help you:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.64.1">Amazon Elastic Compute Cloud</span></strong><span class="koboSpan" id="kobo.65.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.66.1">Amazon EC2</span></strong><span class="koboSpan" id="kobo.67.1">): Amazon EC2 is a computing</span><a id="_idIndexMarker798"/><span class="koboSpan" id="kobo.68.1"> service that allows users to rent virtual servers (also known as instances or EC2 instances) where users can run, deploy, and manage various types of applications. </span><span class="koboSpan" id="kobo.68.2">You can think of an EC2 instance as your laptop running in the cloud. </span><span class="koboSpan" id="kobo.68.3">Just like your laptop, an EC2 instance provides a virtual computing environment where you can install and run your desired operating system, applications, and software. </span><span class="koboSpan" id="kobo.68.4">However, unlike a physical laptop machine, an EC2 instance can easily be scaled up or down based on your computing needs. </span><span class="koboSpan" id="kobo.68.5">In addition to this, EC2 instances can be accessed and managed remotely from anywhere with an internet connection. </span><span class="koboSpan" id="kobo.68.6">If you are wondering how these instances are accessed, the assigned public and private IP addresses are used to communicate and access an EC2 instance. </span><span class="koboSpan" id="kobo.68.7">The </span><strong class="bold"><span class="koboSpan" id="kobo.69.1">public IP address</span></strong><span class="koboSpan" id="kobo.70.1"> of the</span><a id="_idIndexMarker799"/><span class="koboSpan" id="kobo.71.1"> instance allows the instance to access resources on the internet and receive requests from external sources. </span><span class="koboSpan" id="kobo.71.2">On the other hand, the </span><strong class="bold"><span class="koboSpan" id="kobo.72.1">private IP address</span></strong><span class="koboSpan" id="kobo.73.1"> is</span><a id="_idIndexMarker800"/><span class="koboSpan" id="kobo.74.1"> used for communication between resources within the same </span><span class="No-Break"><span class="koboSpan" id="kobo.75.1">network environment.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.76.1">Security group</span></strong><span class="koboSpan" id="kobo.77.1">: A </span><a id="_idIndexMarker801"/><span class="koboSpan" id="kobo.78.1">security group acts as a virtual firewall for resources (such as EC2 instances) inside a network environment. </span><span class="koboSpan" id="kobo.78.2">Security group rules are used to define inbound and outbound traffic to and from the resources within the security group. </span><span class="koboSpan" id="kobo.78.3">For example, if all outbound traffic is denied by the security group of an EC2 instance, then we won’t be able to initiate external communication from within the EC2 instance. </span><span class="koboSpan" id="kobo.78.4">Similarly, if all inbound </span><a id="_idIndexMarker802"/><span class="koboSpan" id="kobo.79.1">traffic is denied by the security group of an EC2 instance, then the EC2 instance (protected by the security group) won’t be able to receive incoming connections or accept </span><span class="No-Break"><span class="koboSpan" id="kobo.80.1">incoming communication.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.81.1">Amazon Virtual Private Cloud</span></strong><span class="koboSpan" id="kobo.82.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.83.1">Amazon VPC</span></strong><span class="koboSpan" id="kobo.84.1">): Amazon VPC is a service that allows </span><a id="_idIndexMarker803"/><span class="koboSpan" id="kobo.85.1">users to create and define isolated virtual private network environments</span><a id="_idIndexMarker804"/><span class="koboSpan" id="kobo.86.1"> in the AWS cloud. </span><span class="koboSpan" id="kobo.86.2">In this network environment, users can launch various types of resources (including EC2 instances). </span><span class="koboSpan" id="kobo.86.3">VPCs can have one or more </span><strong class="bold"><span class="koboSpan" id="kobo.87.1">subnets</span></strong><span class="koboSpan" id="kobo.88.1"> (subnetworks). </span><span class="koboSpan" id="kobo.88.2">Subnets</span><a id="_idIndexMarker805"/><span class="koboSpan" id="kobo.89.1"> have smaller address ranges within the VPC and are smaller networks</span><a id="_idIndexMarker806"/><span class="koboSpan" id="kobo.90.1"> that are part of the larger VPC network. </span><span class="koboSpan" id="kobo.90.2">Depending on how the network is configured, a subnet can be a public subnet or a private subnet. </span><span class="koboSpan" id="kobo.90.3">A </span><strong class="bold"><span class="koboSpan" id="kobo.91.1">public subnet</span></strong><span class="koboSpan" id="kobo.92.1"> is configured</span><a id="_idIndexMarker807"/><span class="koboSpan" id="kobo.93.1"> to allow instances </span><a id="_idIndexMarker808"/><span class="koboSpan" id="kobo.94.1">within the subnet to communicate directly with the internet. </span><span class="koboSpan" id="kobo.94.2">On the other hand, resources (such as instances) within a </span><strong class="bold"><span class="koboSpan" id="kobo.95.1">private subnet</span></strong><span class="koboSpan" id="kobo.96.1"> cannot</span><a id="_idIndexMarker809"/><span class="koboSpan" id="kobo.97.1"> communicate directly with the internet and </span><a id="_idIndexMarker810"/><span class="koboSpan" id="kobo.98.1">resources do not have public IP addresses by default. </span><span class="koboSpan" id="kobo.98.2">The configuration of public and private subnets allows for the separation of resources based on security requirements and the need for direct </span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">internet access:</span></span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer157">
<span class="koboSpan" id="kobo.100.1"><img alt="" src="image/B19755_06_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.101.1">Figure 6.1 – Sample VPC setup</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.102.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.103.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.104.1">.1</span></em><span class="koboSpan" id="kobo.105.1">, we </span><a id="_idIndexMarker811"/><span class="koboSpan" id="kobo.106.1">have a sample VPC with a public subnet and a private subnet. </span><span class="koboSpan" id="kobo.106.2">Inside the public subnet, we have two EC2 instances, </span><strong class="bold"><span class="koboSpan" id="kobo.107.1">EC2 INSTANCE 01</span></strong><span class="koboSpan" id="kobo.108.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.109.1">EC2 INSTANCE 02</span></strong><span class="koboSpan" id="kobo.110.1">, that can communicate directly with the internet – with inbound and </span><a id="_idIndexMarker812"/><span class="koboSpan" id="kobo.111.1">outbound traffic routed through the associated </span><strong class="bold"><span class="koboSpan" id="kobo.112.1">INTERNET GATEWAY</span></strong><span class="koboSpan" id="kobo.113.1">. </span><span class="koboSpan" id="kobo.113.2">In the private subnet, we have a single EC2 instance (</span><strong class="bold"><span class="koboSpan" id="kobo.114.1">EC2 INSTANCE 03</span></strong><span class="koboSpan" id="kobo.115.1">). </span><span class="koboSpan" id="kobo.115.2">The instance in the private subnet will not have a public IP address by default and will have outbound internet access routed through a </span><strong class="bold"><span class="koboSpan" id="kobo.116.1">NAT GATEWAY</span></strong><span class="koboSpan" id="kobo.117.1"> resource in the public subnet. </span><span class="koboSpan" id="kobo.117.2">Since direct access from the internet to the resource(s) in the private subnet of the VPC is prevented, it is important to note that </span><strong class="bold"><span class="koboSpan" id="kobo.118.1">INSTANCE 03</span></strong><span class="koboSpan" id="kobo.119.1"> is not reachable from resources outside of the VPC. </span><span class="koboSpan" id="kobo.119.2">Finally, since instances within the same VPC can communicate with each other in a typical VPC configuration (regardless of whether they are in a public subnet or a private subnet), </span><strong class="bold"><span class="koboSpan" id="kobo.120.1">INSTANCE 03</span></strong><span class="koboSpan" id="kobo.121.1"> should be reachable from </span><strong class="bold"><span class="koboSpan" id="kobo.122.1">INSTANCE 01</span></strong><span class="koboSpan" id="kobo.123.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.124.1">INSTANCE 02</span></strong><span class="koboSpan" id="kobo.125.1">. </span><span class="koboSpan" id="kobo.125.2">Of course, this is under the assumption that the necessary network configuration, security groups, and routing settings are properly configured to allow the desired communication. </span><span class="koboSpan" id="kobo.125.3">What if </span><strong class="bold"><span class="koboSpan" id="kobo.126.1">INSTANCE 01</span></strong><span class="koboSpan" id="kobo.127.1"> and/or </span><strong class="bold"><span class="koboSpan" id="kobo.128.1">INSTANCE 02</span></strong><span class="koboSpan" id="kobo.129.1"> is/are compromised by an attacker? </span><span class="koboSpan" id="kobo.129.2">This would mean that the attacker can now attack </span><strong class="bold"><span class="koboSpan" id="kobo.130.1">INSTANCE 03</span></strong><span class="koboSpan" id="kobo.131.1"> through the compromised instance(s) in the public subnet (since </span><strong class="bold"><span class="koboSpan" id="kobo.132.1">INSTANCE 03</span></strong><span class="koboSpan" id="kobo.133.1"> is reachable from </span><strong class="bold"><span class="koboSpan" id="kobo.134.1">INSTANCE 01</span></strong><span class="koboSpan" id="kobo.135.1"> or </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.136.1">INSTANCE 02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">).</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.138.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.139.1">Server configuration, network design, and firewall configuration play an important role in shaping the options available for deploying shells and executing pivoting techniques during a penetration testing exercise. </span><span class="koboSpan" id="kobo.139.2">The effectiveness of these techniques depends on what is allowed by the network’s design. </span><span class="koboSpan" id="kobo.139.3">For example, restrictive firewall rules along with tightly configured network segmentation can limit the use of certain shells (making the exploitation process a bit </span><span class="No-Break"><span class="koboSpan" id="kobo.140.1">more challenging).</span></span></p>
<p><span class="koboSpan" id="kobo.141.1">At this</span><a id="_idIndexMarker813"/><span class="koboSpan" id="kobo.142.1"> point, we should</span><a id="_idIndexMarker814"/><span class="koboSpan" id="kobo.143.1"> have a better understanding of the relevant AWS concepts and services we will work with in this chapter. </span><span class="koboSpan" id="kobo.143.2">Now, let’s discuss what our lab environment would look like. </span><span class="koboSpan" id="kobo.143.3">The lab environment we will set up in this chapter will </span><a id="_idIndexMarker815"/><span class="koboSpan" id="kobo.144.1">have a </span><strong class="bold"><span class="koboSpan" id="kobo.145.1">VPC peering connection</span></strong><span class="koboSpan" id="kobo.146.1">, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.147.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.148.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.149.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer158">
<span class="koboSpan" id="kobo.150.1"><img alt="" src="image/B19755_06_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.151.1">Figure 6.2 – What our lab environment should look like</span></p>
<p><span class="koboSpan" id="kobo.152.1">The </span><a id="_idIndexMarker816"/><span class="koboSpan" id="kobo.153.1">VPC peering connection enables traffic to flow securely between the peered VPCs (using the private IP addresses of the resources deployed inside the VPCs). </span><span class="koboSpan" id="kobo.153.2">In the first VPC network, we will have two EC2 (VM) instances, which will serve as the target resources. </span><span class="koboSpan" id="kobo.153.3">In the second VPC network, we will have the attacker instance set up and ready. </span><span class="koboSpan" id="kobo.153.4">Out of the two target instances, only one of these instances should be directly reachable from the attacker instance. </span><span class="koboSpan" id="kobo.153.5">In addition to this, the traffic from the outside world (that is, outside of the peered network environment) should not reach the resources that have been deployed inside the network environment. </span><span class="koboSpan" id="kobo.153.6">This will help make sure that only </span><a id="_idIndexMarker817"/><span class="koboSpan" id="kobo.154.1">authorized users can access the resources that have been deployed in the lab environment. </span><span class="koboSpan" id="kobo.154.2">Given that the target VM instances are configured to be vulnerable, we can’t afford to have random attackers compromise our </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">lab environment.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.156.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.157.1">To keep things simple, the lab environment we will set up in this chapter will not have a private subnet. </span><span class="koboSpan" id="kobo.157.2">Both target EC2 instances will be deployed in a public subnet – removing the need for a NAT gateway (or a NAT instance) to help us reduce the overall cost of running the lab environment. </span><span class="koboSpan" id="kobo.157.3">Instead of a typical VPC network setup comprised of public and private subnets, we will only have public subnets, where network flow and connectivity are managed through customized security group rules. </span><span class="koboSpan" id="kobo.157.4">After completing this chapter, feel free to build more complex network architectures by introducing new public and private subnets, as well as new peered VPC networks containing resources which can not directly be accessed from the attacker VM instance. </span><span class="koboSpan" id="kobo.157.5">I will leave that to you as </span><span class="No-Break"><span class="koboSpan" id="kobo.158.1">an exercise!</span></span></p>
<p><span class="koboSpan" id="kobo.159.1">Now that we have a better idea of what our lab environment will look like, let’s proceed with using Terraform to set up our </span><span class="No-Break"><span class="koboSpan" id="kobo.160.1">lab environment:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.161.1">Navigate to the official GitHub repository of this book using the </span><span class="No-Break"><span class="koboSpan" id="kobo.162.1">following URL:</span></span><pre class="source-code">
<a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud"><span class="koboSpan" id="kobo.163.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud</span></a></pre><p class="list-inset"><span class="koboSpan" id="kobo.164.1">We should find multiple folders containing the corresponding files and source code for each of the chapters of </span><span class="No-Break"><span class="koboSpan" id="kobo.165.1">this book:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer159">
<span class="koboSpan" id="kobo.166.1"><img alt="" src="image/B19755_06_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.167.1">Figure 6.3 – Navigating to the ch06 directory</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.168.1">Navigate</span><a id="_idIndexMarker818"/><span class="koboSpan" id="kobo.169.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.170.1">ch06</span></strong><span class="koboSpan" id="kobo.171.1"> directory, as </span><a id="_idIndexMarker819"/><span class="koboSpan" id="kobo.172.1">highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.173.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.174.1">.3</span></em><span class="koboSpan" id="kobo.175.1">. </span><span class="koboSpan" id="kobo.175.2">Inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">ch06</span></strong><span class="koboSpan" id="kobo.177.1"> directory, we should find a </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">pentest_lab.zip</span></strong><span class="koboSpan" id="kobo.179.1"> file. </span><span class="koboSpan" id="kobo.179.2">Click the </span><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">pentest_lab.zip</span></strong><span class="koboSpan" id="kobo.181.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">link afterward.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.183.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.184.1">If you are wondering what is inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.185.1">pentest_lab.zip</span></strong><span class="koboSpan" id="kobo.186.1"> file, it contains the Terraform code for setting up the </span><em class="italic"><span class="koboSpan" id="kobo.187.1">entire</span></em><span class="koboSpan" id="kobo.188.1"> lab environment for this chapter. </span><span class="koboSpan" id="kobo.188.2">In this chapter, we will simply download the code and run </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">terraform apply</span></strong><span class="koboSpan" id="kobo.190.1"> to set up the infrastructure. </span><span class="koboSpan" id="kobo.190.2">This will allow us to focus more on the other aspects when we start building and testing the pivoting </span><span class="No-Break"><span class="koboSpan" id="kobo.191.1">lab environment.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.192.1">Next, right-click on the </span><strong class="bold"><span class="koboSpan" id="kobo.193.1">Download</span></strong><span class="koboSpan" id="kobo.194.1"> or </span><strong class="bold"><span class="koboSpan" id="kobo.195.1">Raw</span></strong><span class="koboSpan" id="kobo.196.1"> button, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.197.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.198.1">.4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.199.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer160">
<span class="koboSpan" id="kobo.200.1"><img alt="" src="image/B19755_06_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.201.1">Figure 6.4 – Copying the link address of the pentest_lab.zip file</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.202.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.203.1">Copy Link Address</span></strong><span class="koboSpan" id="kobo.204.1"> from the list of options available in the context menu. </span><span class="koboSpan" id="kobo.204.2">Store the string value in a text editor on your </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">local machine.</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.206.1">Now, let’s open</span><a id="_idIndexMarker820"/><span class="koboSpan" id="kobo.207.1"> a new browser tab and </span><a id="_idIndexMarker821"/><span class="koboSpan" id="kobo.208.1">navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.209.1">AWS Management Console</span></strong><span class="koboSpan" id="kobo.210.1"> using the following link: </span><a href="https://aws.amazon.com/console/"><span class="koboSpan" id="kobo.211.1">https://aws.amazon.com/console/</span></a><span class="koboSpan" id="kobo.212.1">. </span><span class="koboSpan" id="kobo.212.2">Make sure you sign in to your AWS account before proceeding with the </span><span class="No-Break"><span class="koboSpan" id="kobo.213.1">next steps.</span></span></li>
<li><span class="koboSpan" id="kobo.214.1">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.215.1">shell</span></strong><span class="koboSpan" id="kobo.216.1"> in the</span><a id="_idIndexMarker822"/><span class="koboSpan" id="kobo.217.1"> search bar and then select </span><strong class="bold"><span class="koboSpan" id="kobo.218.1">CloudShell</span></strong><span class="koboSpan" id="kobo.219.1"> from the list of results (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.220.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.221.1">.5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer161">
<span class="koboSpan" id="kobo.223.1"><img alt="" src="image/B19755_06_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.224.1">Figure 6.5 – Navigating to the CloudShell console</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.225.1">Alternatively, you</span><a id="_idIndexMarker823"/><span class="koboSpan" id="kobo.226.1"> may simply </span><a id="_idIndexMarker824"/><span class="koboSpan" id="kobo.227.1">locate and click the </span><strong class="bold"><span class="koboSpan" id="kobo.228.1">CloudShell</span></strong><span class="koboSpan" id="kobo.229.1"> button located at the top-left corner of the AWS Management Console (near the region selection </span><span class="No-Break"><span class="koboSpan" id="kobo.230.1">drop-down menu).</span></span></p></li>
</ol>
<ol>
<li value="5"><span class="koboSpan" id="kobo.231.1">Locate and click the </span><strong class="bold"><span class="koboSpan" id="kobo.232.1">Open in new browser tab</span></strong><span class="koboSpan" id="kobo.233.1"> button, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.234.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.235.1">.6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer162">
<span class="koboSpan" id="kobo.237.1"><img alt="" src="image/B19755_06_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.238.1">Figure 6.6 – Opening CloudShell in a new browser tab</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.239.1">This will open a CloudShell environment within a new browser tab. </span><span class="koboSpan" id="kobo.239.2">When you see the </span><strong class="bold"><span class="koboSpan" id="kobo.240.1">Welcome to AWS CloudShell</span></strong><span class="koboSpan" id="kobo.241.1"> pop-up window, simply click the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.242.1">Close</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.243.1"> button.</span></span></p></li>
</ol>
<ol>
<li value="6"><span class="koboSpan" id="kobo.244.1">In the</span><a id="_idIndexMarker825"/><span class="koboSpan" id="kobo.245.1"> Terminal of our CloudShell environment (right after the </span><strong class="bold"><span class="koboSpan" id="kobo.246.1">$</span></strong><span class="koboSpan" id="kobo.247.1"> sign), run the following commands to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.248.1">pentest_lab</span></strong><span class="koboSpan" id="kobo.249.1"> project directory and navigate to the new directory </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">as well:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.251.1">mkdir -p pentest_lab</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.252.1">cd pentest_lab</span></strong></pre></li> <li><span class="koboSpan" id="kobo.253.1">Next, download the </span><strong class="source-inline"><span class="koboSpan" id="kobo.254.1">pentest_lab.zip</span></strong><span class="koboSpan" id="kobo.255.1"> file from this book’s GitHub repository</span><a id="_idIndexMarker826"/><span class="koboSpan" id="kobo.256.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">pentest_lab</span></strong><span class="koboSpan" id="kobo.258.1"> directory inside the CloudShell environment using the </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">following commands:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.260.1">DOWNLOAD_URL=</span></strong><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/raw/main/ch06/pentest_lab.zip"><strong class="bold"><span class="koboSpan" id="kobo.261.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/raw/main/ch06/pentest_lab.zip</span></strong></a>
<strong class="bold"><span class="koboSpan" id="kobo.262.1">wget -O pentest_lab.zip $DOWNLOAD_URL</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.263.1">Feel free to set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">$DOWNLOAD_URL</span></strong><span class="koboSpan" id="kobo.265.1"> variable value with the download link you copied to the editor on your local machine. </span><span class="koboSpan" id="kobo.265.2">Make sure that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.266.1">$DOWNLOAD_URL</span></strong><span class="koboSpan" id="kobo.267.1"> variable value is correct and properly pointing to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">pentest_lab.zip</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.269.1"> file.</span></span></p></li> <li><span class="koboSpan" id="kobo.270.1">At this point, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">pentestlab.zip</span></strong><span class="koboSpan" id="kobo.272.1"> file should have been downloaded from the GitHub repository to our CloudShell environment (inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">pentest_lab</span></strong><span class="koboSpan" id="kobo.274.1"> directory). </span><span class="koboSpan" id="kobo.274.2">Now, it’s time to open it! </span><span class="koboSpan" id="kobo.274.3">Extract the Terraform configuration files using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">unzip</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.276.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.277.1">unzip pentest_lab.zip</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.278.1">This should extract several </span><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">.tf</span></strong><span class="koboSpan" id="kobo.280.1"> files for setting up the entire lab environment for </span><span class="No-Break"><span class="koboSpan" id="kobo.281.1">this chapter.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.282.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.283.1">Feel free to check the content of each file using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">cat</span></strong><span class="koboSpan" id="kobo.285.1"> or </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">less</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.287.1"> command.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.288.1">Delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.289.1">pentest_lab.zip</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.290.1">file afterward:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.291.1">rm pentest_lab.zip</span></strong></pre></li> <li><span class="koboSpan" id="kobo.292.1">With the configuration files ready, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">terraform init</span></strong><span class="koboSpan" id="kobo.294.1"> command to initialize the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.295.1">working directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.296.1">terraform init</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.297.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.298.1">If you encounter a </span><strong class="bold"><span class="koboSpan" id="kobo.299.1">no space left on device</span></strong><span class="koboSpan" id="kobo.300.1"> error while running Terraform, feel free to run </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">du -h --max-depth=1 ~</span></strong><span class="koboSpan" id="kobo.302.1"> to see which directory inside your CloudShell environment is taking up a bit of space. </span><span class="koboSpan" id="kobo.302.2">Once you have identified the directory, feel free to perform the necessary cleanup steps before proceeding to the next set of steps in this chapter. </span><span class="koboSpan" id="kobo.302.3">Make sure that you have a backup of the files and directories you are planning to delete before the actual </span><span class="No-Break"><span class="koboSpan" id="kobo.303.1">deletion steps.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.304.1">Let’s run </span><strong class="source-inline"><span class="koboSpan" id="kobo.305.1">terraform plan</span></strong><span class="koboSpan" id="kobo.306.1"> to preview the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.307.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.308.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.309.1">This</span><a id="_idIndexMarker827"/><span class="koboSpan" id="kobo.310.1"> command should complete without </span><span class="No-Break"><span class="koboSpan" id="kobo.311.1">any errors.</span></span></p></li> <li><span class="koboSpan" id="kobo.312.1">Next, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">terraform apply</span></strong><span class="koboSpan" id="kobo.314.1"> command to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">the changes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.316.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.317.1">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.318.1">terraform apply</span></strong><span class="koboSpan" id="kobo.319.1"> command runs without any errors, we are ready to proceed to </span><a id="_idIndexMarker828"/><span class="koboSpan" id="kobo.320.1">the next section. </span><span class="koboSpan" id="kobo.320.2">If you encounter issues (for example, the </span><strong class="bold"><span class="koboSpan" id="kobo.321.1">Unable to modify EC2 VPC Peering Connection Options</span></strong><span class="koboSpan" id="kobo.322.1"> error), simply run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">terraform apply -auto-approve</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.324.1">command again:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer163">
<span class="koboSpan" id="kobo.325.1"><img alt="" src="image/B19755_06_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.326.1">Figure 6.7 – Results after running the terraform apply command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.327.1">In addition to the network environment, running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">terraform apply</span></strong><span class="koboSpan" id="kobo.329.1"> command will also create three EC2 instances – a </span><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">t2.micro</span></strong><span class="koboSpan" id="kobo.331.1"> target instance labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.332.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.333.1">, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">t2.micro</span></strong><span class="koboSpan" id="kobo.335.1"> target instance labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.337.1">, and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">t3.medium</span></strong><span class="koboSpan" id="kobo.339.1"> attacker instance labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.340.1">vm-kali</span></strong><span class="koboSpan" id="kobo.341.1">. </span><span class="koboSpan" id="kobo.341.2">Each of these instances will have its corresponding public and private IP addresses, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.342.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.343.1">.7</span></em><span class="koboSpan" id="kobo.344.1">. </span><span class="koboSpan" id="kobo.344.2">Make sure you copy the output values (that is, the public and</span><a id="_idIndexMarker829"/><span class="koboSpan" id="kobo.345.1"> private IP addresses under </span><strong class="bold"><span class="koboSpan" id="kobo.346.1">Outputs</span></strong><span class="koboSpan" id="kobo.347.1">) to the text editor on your local machine. </span><span class="koboSpan" id="kobo.347.2">Note that you will get a different set of IP addresses after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.349.1">apply</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.350.1"> command.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.351.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.352.1">Feel free to review the configuration of the resources that were deployed using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">terraform show</span></strong><span class="koboSpan" id="kobo.354.1"> command. </span><span class="koboSpan" id="kobo.354.2">Note that if we were to include a private subnet and launch another target VM instance inside it, then we would need a few more resources defined in our Terraform code (such as a NAT gateway in the public subnet) that would increase the cost of running this </span><span class="No-Break"><span class="koboSpan" id="kobo.355.1">lab environment.</span></span></p>
<p><span class="koboSpan" id="kobo.356.1">Before proceeding</span><a id="_idIndexMarker830"/><span class="koboSpan" id="kobo.357.1"> to the next section, let’s quickly check what we have so far. </span><span class="koboSpan" id="kobo.357.2">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.358.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.359.1">.8</span></em><span class="koboSpan" id="kobo.360.1">, we can see that after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.361.1">terraform apply</span></strong><span class="koboSpan" id="kobo.362.1"> command, we should have two target instances (</span><strong class="source-inline"><span class="koboSpan" id="kobo.363.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.364.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.365.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.366.1">) in the first VPC network (</span><strong class="source-inline"><span class="koboSpan" id="kobo.367.1">Target VPC</span></strong><span class="koboSpan" id="kobo.368.1">) and one attacker instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.369.1">vm-kali</span></strong><span class="koboSpan" id="kobo.370.1">) in the second VPC network (</span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.371.1">Attacker VPC</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.372.1">):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer164">
<span class="koboSpan" id="kobo.373.1"><img alt="" src="image/B19755_06_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.374.1">Figure 6.8 – What we have at the moment</span></p>
<p><span class="koboSpan" id="kobo.375.1">The two VPC networks are connected through a peering connection, which allows traffic from the attacker</span><a id="_idIndexMarker831"/><span class="koboSpan" id="kobo.376.1"> instance to reach the </span><a id="_idIndexMarker832"/><span class="koboSpan" id="kobo.377.1">target instances. </span><span class="koboSpan" id="kobo.377.2">Of course, as we will see later, additional layers of security (such as the security group used by the second target instance) will prevent traffic from the attacker instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">vm-kali</span></strong><span class="koboSpan" id="kobo.379.1">) from directly reaching the second target </span><span class="No-Break"><span class="koboSpan" id="kobo.380.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.381.1">target-vm-02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">).</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.383.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.384.1">There are other networking components and resources we can configure in AWS to manage the network</span><a id="_idIndexMarker833"/><span class="koboSpan" id="kobo.385.1"> flow</span><a id="_idIndexMarker834"/><span class="koboSpan" id="kobo.386.1"> and connectivity inside the lab environment. </span><span class="koboSpan" id="kobo.386.2">These include </span><strong class="bold"><span class="koboSpan" id="kobo.387.1">network ACLs</span></strong><span class="koboSpan" id="kobo.388.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.389.1">load balancers</span></strong><span class="koboSpan" id="kobo.390.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.391.1">route table configuration</span></strong><span class="koboSpan" id="kobo.392.1">, along </span><a id="_idIndexMarker835"/><span class="koboSpan" id="kobo.393.1">with various types of </span><strong class="bold"><span class="koboSpan" id="kobo.394.1">firewalls</span></strong><span class="koboSpan" id="kobo.395.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.396.1">gateways</span></strong><span class="koboSpan" id="kobo.397.1">. </span><span class="koboSpan" id="kobo.397.2">We </span><a id="_idIndexMarker836"/><span class="koboSpan" id="kobo.398.1">will </span><a id="_idIndexMarker837"/><span class="koboSpan" id="kobo.399.1">not discuss these in detail in this book so feel free to check out the </span><em class="italic"><span class="koboSpan" id="kobo.400.1">Further reading</span></em><span class="koboSpan" id="kobo.401.1"> section for more information about </span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">these topics.</span></span></p>
<h1 id="_idParaDest-123"><a id="_idTextAnchor123"/><span class="koboSpan" id="kobo.403.1">Validating network connectivity and security</span></h1>
<p><span class="koboSpan" id="kobo.404.1">When</span><a id="_idIndexMarker838"/><span class="koboSpan" id="kobo.405.1"> building a pivoting lab, we must test and validate the network connectivity of the environment. </span><span class="koboSpan" id="kobo.405.2">This will help ensure that the network configuration, necessary routes, and firewall rules have been set up to facilitate the movement of traffic between different segments and systems in </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">the network.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.407.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.408.1">Even if we use automation tools to build the lab infrastructure, it is still possible to encounter network </span><span class="No-Break"><span class="koboSpan" id="kobo.409.1">connectivity issues.</span></span></p>
<p><span class="koboSpan" id="kobo.410.1">There are a variety of ways to validate network connectivity and security. </span><span class="koboSpan" id="kobo.410.2">In this section, we will test and validate network connectivity the </span><em class="italic"><span class="koboSpan" id="kobo.411.1">manual way</span></em><span class="koboSpan" id="kobo.412.1"> and the </span><em class="italic"><span class="koboSpan" id="kobo.413.1">automated way</span></em><span class="koboSpan" id="kobo.414.1">. </span><span class="koboSpan" id="kobo.414.2">That said, this section is divided into the </span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">following subparts:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.416.1">Part 1 of 3 – Authorizing the use of the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.417.1">serial console</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.418.1">Part 2 of 3 – Manually verifying network connectivity with </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.419.1">ping tests</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.420.1">Part 3 of 3 – Using the Reachability Analyzer to validate </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.421.1">network connectivity</span></em></span></li>
</ul>
<p><span class="koboSpan" id="kobo.422.1">Without further ado, </span><span class="No-Break"><span class="koboSpan" id="kobo.423.1">let’s begin.</span></span></p>
<h2 id="_idParaDest-124"><a id="_idTextAnchor124"/><span class="koboSpan" id="kobo.424.1">Part 1 of 3 – Authorizing the use of the serial console</span></h2>
<p><span class="koboSpan" id="kobo.425.1">There are </span><a id="_idIndexMarker839"/><span class="koboSpan" id="kobo.426.1">different ways to</span><a id="_idIndexMarker840"/><span class="koboSpan" id="kobo.427.1"> access an </span><a id="_idIndexMarker841"/><span class="koboSpan" id="kobo.428.1">EC2 instance. </span><span class="koboSpan" id="kobo.428.2">One of the options would be to use the </span><strong class="bold"><span class="koboSpan" id="kobo.429.1">EC2 serial console</span></strong><span class="koboSpan" id="kobo.430.1">, which helps us access EC2 instances and troubleshoot various issues (for example, boot and network configuration issues). </span><span class="koboSpan" id="kobo.430.2">Before we can access EC2 instances through the EC2 serial console, we need to enable </span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">it first:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.432.1">Navigate to the EC2 console by typing </span><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">ec2 instances</span></strong><span class="koboSpan" id="kobo.434.1"> in the search bar and then selecting </span><strong class="bold"><span class="koboSpan" id="kobo.435.1">Instances</span></strong><span class="koboSpan" id="kobo.436.1"> from the list of results (</span><span class="No-Break"><span class="koboSpan" id="kobo.437.1">under </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.438.1">Features</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.439.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.440.1">Toggle the checkbox </span><em class="italic"><span class="koboSpan" id="kobo.441.1">on</span></em><span class="koboSpan" id="kobo.442.1"> (that is, mark it with a check) to select </span><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">vm-kali</span></strong><span class="koboSpan" id="kobo.444.1"> and then click the </span><strong class="bold"><span class="koboSpan" id="kobo.445.1">Connect</span></strong><span class="koboSpan" id="kobo.446.1"> button. </span><span class="koboSpan" id="kobo.446.2">This will redirect you to the </span><strong class="bold"><span class="koboSpan" id="kobo.447.1">Connect to </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.448.1">instance</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.449.1"> page.</span></span></li>
<li><span class="koboSpan" id="kobo.450.1">In the</span><a id="_idIndexMarker842"/><span class="koboSpan" id="kobo.451.1"> last tab (</span><strong class="bold"><span class="koboSpan" id="kobo.452.1">EC2 serial console</span></strong><span class="koboSpan" id="kobo.453.1">), if you have not authorized the use of the EC2 serial </span><a id="_idIndexMarker843"/><span class="koboSpan" id="kobo.454.1">console in your account, simply click the </span><strong class="bold"><span class="koboSpan" id="kobo.455.1">Manage access</span></strong><span class="koboSpan" id="kobo.456.1"> button, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.457.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.458.1">.9</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.459.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer165">
<span class="koboSpan" id="kobo.460.1"><img alt="" src="image/B19755_06_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.461.1">Figure 6.9 – Account not yet authorized to use the EC2 serial console</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.462.1">After clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.463.1">Manage access</span></strong><span class="koboSpan" id="kobo.464.1"> button, simply toggle the </span><strong class="bold"><span class="koboSpan" id="kobo.465.1">Allow</span></strong><span class="koboSpan" id="kobo.466.1"> checkbox </span><em class="italic"><span class="koboSpan" id="kobo.467.1">on</span></em><span class="koboSpan" id="kobo.468.1"> (that is, mark it with a check) and then click the </span><strong class="bold"><span class="koboSpan" id="kobo.469.1">Update</span></strong><span class="koboSpan" id="kobo.470.1"> button to authorize the use of the EC2 serial console in your </span><span class="No-Break"><span class="koboSpan" id="kobo.471.1">AWS account.</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.472.1">Navigate back to the list of EC2 instances (using the sidebar). </span><span class="koboSpan" id="kobo.472.2">Toggle the checkbox </span><em class="italic"><span class="koboSpan" id="kobo.473.1">on</span></em><span class="koboSpan" id="kobo.474.1"> to select </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">vm-kali</span></strong><span class="koboSpan" id="kobo.476.1"> and then click the </span><strong class="bold"><span class="koboSpan" id="kobo.477.1">Connect</span></strong><span class="koboSpan" id="kobo.478.1"> button. </span><span class="koboSpan" id="kobo.478.2">This will redirect you to the </span><strong class="bold"><span class="koboSpan" id="kobo.479.1">Connect to </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.480.1">instance</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.481.1"> page.</span></span></li>
<li><span class="koboSpan" id="kobo.482.1">In the last tab (</span><strong class="bold"><span class="koboSpan" id="kobo.483.1">EC2 serial console</span></strong><span class="koboSpan" id="kobo.484.1">), click the </span><strong class="bold"><span class="koboSpan" id="kobo.485.1">Connect</span></strong><span class="koboSpan" id="kobo.486.1"> button to access the instance via the </span><strong class="bold"><span class="koboSpan" id="kobo.487.1">EC2 </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.488.1">serial console</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.490.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.491.1">Inside the serial console, if you are seeing a blank black screen, simply press the </span><em class="italic"><span class="koboSpan" id="kobo.492.1">Enter</span></em><span class="koboSpan" id="kobo.493.1"> key to see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.494.1">root@kali:~#</span></strong><span class="koboSpan" id="kobo.495.1"> command prompt. </span><span class="koboSpan" id="kobo.495.2">If you are having issues accessing the attacker VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.496.1">vm-kali</span></strong><span class="koboSpan" id="kobo.497.1">), feel free to reboot the EC2 instance and then try accessing it again via the EC2 </span><span class="No-Break"><span class="koboSpan" id="kobo.498.1">serial console.</span></span></p>
<h2 id="_idParaDest-125"><a id="_idTextAnchor125"/><span class="koboSpan" id="kobo.499.1">Part 2 of 3 – Manually verifying network connectivity with ping tests</span></h2>
<p><span class="koboSpan" id="kobo.500.1">Using</span><a id="_idIndexMarker844"/><span class="koboSpan" id="kobo.501.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">ping</span></strong><span class="koboSpan" id="kobo.503.1"> command, we will quickly test the network connectivity between the different</span><a id="_idIndexMarker845"/><span class="koboSpan" id="kobo.504.1"> resources that have been deployed inside our </span><span class="No-Break"><span class="koboSpan" id="kobo.505.1">lab network:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.506.1">Continuing where we left off in the previous part, let’s check if we can ping the first target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.507.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.508.1">, from the attacker VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.509.1">vm-kali</span></strong><span class="koboSpan" id="kobo.510.1">, using its private IP address (similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.511.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.512.1">.10</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.513.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer166">
<span class="koboSpan" id="kobo.514.1"><img alt="" src="image/B19755_06_010.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.515.1">Figure 6.10 – Pinging the first target instance from the attacker instance (diagram)</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.516.1">Here, we are expecting the first target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.518.1">, to be reachable from the attacker VM </span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">instance, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.520.1">vm-kali</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.521.1">.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.522.1">With this in mind, let’s run the following command (in the EC2 </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">serial console):</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.524.1">ping &lt;TARGET VM 01 PRIVATE IP&gt;</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.525.1">Make </span><a id="_idIndexMarker846"/><span class="koboSpan" id="kobo.526.1">sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">&lt;TARGET VM 01 PRIVATE IP&gt;</span></strong><span class="koboSpan" id="kobo.528.1"> with the private IP address of the first target VM instance (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">vm_target_private_ip</span></strong><span class="koboSpan" id="kobo.530.1"> output value after running </span><strong class="source-inline"><span class="koboSpan" id="kobo.531.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.532.1">apply</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.533.1"> previously):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer167">
<span class="koboSpan" id="kobo.534.1"><img alt="" src="image/B19755_06_011.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.535.1">Figure 6.11 – Pinging the first target instance from the attacker instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.536.1">As </span><a id="_idIndexMarker847"/><span class="koboSpan" id="kobo.537.1">shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.538.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.539.1">.11</span></em><span class="koboSpan" id="kobo.540.1">, we can ping the first target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.542.1">, from the attacker VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">vm-kali</span></strong><span class="koboSpan" id="kobo.544.1">, using its private </span><span class="No-Break"><span class="koboSpan" id="kobo.545.1">IP address.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.546.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.547.1">Feel free to use </span><em class="italic"><span class="koboSpan" id="kobo.548.1">Ctrl</span></em><span class="koboSpan" id="kobo.549.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.550.1">C</span></em><span class="koboSpan" id="kobo.551.1"> to stop the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.552.1">ping</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.553.1"> command.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.554.1">Now, let’s check if we can ping the second target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.555.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.556.1">, from the attacker VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.557.1">vm-kali</span></strong><span class="koboSpan" id="kobo.558.1">, using its private IP address (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.559.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.560.1">.12</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.561.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer168">
<span class="koboSpan" id="kobo.562.1"><img alt="" src="image/B19755_06_012.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.563.1">Figure 6.12 – Pinging the second target instance from the attacker instance (diagram)</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.564.1">Here, we </span><a id="_idIndexMarker848"/><span class="koboSpan" id="kobo.565.1">are expecting </span><a id="_idIndexMarker849"/><span class="koboSpan" id="kobo.566.1">the second target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.568.1">, to </span><em class="italic"><span class="koboSpan" id="kobo.569.1">not</span></em><span class="koboSpan" id="kobo.570.1"> be reachable from the attacker VM </span><span class="No-Break"><span class="koboSpan" id="kobo.571.1">instance, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">vm-kali</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.573.1">.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.574.1">That said, let’s run the </span><span class="No-Break"><span class="koboSpan" id="kobo.575.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.576.1">ping &lt;TARGET VM 02 PRIVATE IP&gt;</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.577.1">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.578.1">&lt;TARGET VM 02 PRIVATE IP&gt;</span></strong><span class="koboSpan" id="kobo.579.1"> with the private IP address of the second target </span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">VM instance:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer169">
<span class="koboSpan" id="kobo.581.1"><img alt="" src="image/B19755_06_013.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.582.1">Figure 6.13 – Pinging the second target instance from the attacker instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.583.1">As shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.584.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.585.1">.13</span></em><span class="koboSpan" id="kobo.586.1">, we are not able to ping the second target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.588.1">, from the attacker VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">vm-kali</span></strong><span class="koboSpan" id="kobo.590.1">, using its private </span><span class="No-Break"><span class="koboSpan" id="kobo.591.1">IP address.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.592.1">Note</span></p></li>
</ol>
<p class="callout"><span class="koboSpan" id="kobo.593.1">Why is that? </span><span class="koboSpan" id="kobo.593.2">That’s because we configured the security group used by </span><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.595.1"> to only be accessible from the resources using the security group used by </span><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.597.1">. </span><span class="koboSpan" id="kobo.597.2">In other words, we can only access the second target VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.598.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.599.1">) from the first target VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.600.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.601.1">). </span><span class="koboSpan" id="kobo.601.2">Note that there are various ways we can prevent the attacker VM traffic from reaching the second target VM instance. </span><span class="koboSpan" id="kobo.601.3">Another possible approach would be to introduce a private subnet in VPC 01, and then launch the second target VM instance in the private subnet. </span><span class="koboSpan" id="kobo.601.4">In addition to this, we could also create a new VPC, set up VPC peering between the new VPC and VPC 01, and then launch the second target VM instance in the </span><span class="No-Break"><span class="koboSpan" id="kobo.602.1">new VPC.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.603.1">Navigate </span><a id="_idIndexMarker850"/><span class="koboSpan" id="kobo.604.1">back to the list of </span><a id="_idIndexMarker851"/><span class="koboSpan" id="kobo.605.1">EC2 instances. </span><span class="koboSpan" id="kobo.605.2">Toggle the checkbox </span><em class="italic"><span class="koboSpan" id="kobo.606.1">on</span></em><span class="koboSpan" id="kobo.607.1"> to select </span><strong class="source-inline"><span class="koboSpan" id="kobo.608.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.609.1"> and then click the </span><strong class="bold"><span class="koboSpan" id="kobo.610.1">Connect</span></strong><span class="koboSpan" id="kobo.611.1"> button. </span><span class="koboSpan" id="kobo.611.2">This will redirect you to the </span><strong class="bold"><span class="koboSpan" id="kobo.612.1">Connect to </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.613.1">instance</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.614.1"> page.</span></span></li>
<li><span class="koboSpan" id="kobo.615.1">In the first tab (</span><strong class="bold"><span class="koboSpan" id="kobo.616.1">EC2 Instance Connect</span></strong><span class="koboSpan" id="kobo.617.1">), locate and click the </span><strong class="bold"><span class="koboSpan" id="kobo.618.1">Connect</span></strong><span class="koboSpan" id="kobo.619.1"> button to access the</span><a id="_idIndexMarker852"/><span class="koboSpan" id="kobo.620.1"> instance via </span><strong class="bold"><span class="koboSpan" id="kobo.621.1">EC2 </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.622.1">Instance Connect</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.624.1">Now, let’s check if we can ping the second target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.625.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.626.1">, from the first target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.627.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.628.1">, using its private IP address (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.629.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.630.1">.14</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.631.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer170">
<span class="koboSpan" id="kobo.632.1"><img alt="" src="image/B19755_06_014.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.633.1">Figure 6.14 – Pinging the second target instance from the first target instance (diagram)</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.634.1">Here, we</span><a id="_idIndexMarker853"/><span class="koboSpan" id="kobo.635.1"> are expecting</span><a id="_idIndexMarker854"/><span class="koboSpan" id="kobo.636.1"> the second target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.637.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.638.1">, to be reachable from the first target </span><span class="No-Break"><span class="koboSpan" id="kobo.639.1">instance, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.640.1">target-vm-01</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.641.1">.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.642.1">That said, let’s run the </span><span class="No-Break"><span class="koboSpan" id="kobo.643.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.644.1">ping &lt;TARGET VM 02 PRIVATE IP&gt;</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.645.1">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.646.1">&lt;TARGET VM 02 PRIVATE IP&gt;</span></strong><span class="koboSpan" id="kobo.647.1"> with the private IP address of the second target </span><span class="No-Break"><span class="koboSpan" id="kobo.648.1">VM instance:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer171">
<span class="koboSpan" id="kobo.649.1"><img alt="" src="image/B19755_06_015.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.650.1">Figure 6.15 — Pinging the second target instance from the first target instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.651.1">As shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.652.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.653.1">.15</span></em><span class="koboSpan" id="kobo.654.1">, we can ping the second target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.655.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.656.1">, from</span><a id="_idIndexMarker855"/><span class="koboSpan" id="kobo.657.1"> the</span><a id="_idIndexMarker856"/><span class="koboSpan" id="kobo.658.1"> first target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.659.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.660.1">, using its private </span><span class="No-Break"><span class="koboSpan" id="kobo.661.1">IP address.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.662.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.663.1">Optionally, we can try to ping the second target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.664.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.665.1">, from the first target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.666.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.667.1">, using its public IP address. </span><span class="koboSpan" id="kobo.667.2">Since the VM instances are not reachable from outside the network environment, we should not be able to ping the second target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.668.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.669.1">, using its public </span><span class="No-Break"><span class="koboSpan" id="kobo.670.1">IP address.</span></span></p>
<h2 id="_idParaDest-126"><a id="_idTextAnchor126"/><span class="koboSpan" id="kobo.671.1">Part 3 of 3 – Using the Reachability Analyzer to validate network connectivity</span></h2>
<p><span class="koboSpan" id="kobo.672.1">In addition to the</span><a id="_idIndexMarker857"/><span class="koboSpan" id="kobo.673.1"> initial</span><a id="_idIndexMarker858"/><span class="koboSpan" id="kobo.674.1"> network connectivity tests we have just performed, we will also use the </span><strong class="bold"><span class="koboSpan" id="kobo.675.1">VPC Reachability Analyzer</span></strong><span class="koboSpan" id="kobo.676.1"> – a</span><a id="_idIndexMarker859"/><span class="koboSpan" id="kobo.677.1"> network diagnostics tool provided by AWS – to help us detect and troubleshoot network misconfigurations that could lead to connectivity issues. </span><span class="koboSpan" id="kobo.677.2">As we will see in the succeeding set of steps, using it </span><span class="No-Break"><span class="koboSpan" id="kobo.678.1">is straightforward:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.679.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.680.1">VPC Reachability Analyzer</span></strong><span class="koboSpan" id="kobo.681.1"> console by typing </span><strong class="source-inline"><span class="koboSpan" id="kobo.682.1">vpc reachability analyzer</span></strong><span class="koboSpan" id="kobo.683.1"> in the search bar and then selecting </span><strong class="bold"><span class="koboSpan" id="kobo.684.1">VPC Reachability Analyzer</span></strong><span class="koboSpan" id="kobo.685.1"> from the list of results (</span><span class="No-Break"><span class="koboSpan" id="kobo.686.1">under </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.687.1">Features</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.688.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.689.1">Click</span><a id="_idIndexMarker860"/><span class="koboSpan" id="kobo.690.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.691.1">Create and analyze </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.692.1">path</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.693.1"> button.</span></span></li>
<li><span class="koboSpan" id="kobo.694.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.695.1">Reachability Analyzer &gt; Create and analyze path</span></strong><span class="koboSpan" id="kobo.696.1"> page, specify the following form </span><span class="No-Break"><span class="koboSpan" id="kobo.697.1">field values:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.698.1">Path configuration</span></strong><span class="koboSpan" id="kobo.699.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.700.1">Name </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.701.1">tag</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.702.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.703.1">attacker-to-target-01</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.704.1">Path Source</span></strong><span class="koboSpan" id="kobo.705.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.706.1">Source </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.707.1">type</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.708.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.709.1">Instances</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.710.1">Path Source</span></strong><span class="koboSpan" id="kobo.711.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.712.1">Source</span></strong><span class="koboSpan" id="kobo.713.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.714.1">Select </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.715.1">vm-kali</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.716.1">Path destination</span></strong><span class="koboSpan" id="kobo.717.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.718.1">Destination </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.719.1">type</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.720.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.721.1">Instances</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.722.1">Path destination</span></strong><span class="koboSpan" id="kobo.723.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.724.1">Destination</span></strong><span class="koboSpan" id="kobo.725.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.726.1">Select </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.727.1">target-vm-01</span></strong></span></li><li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.728.1">Protocol</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.729.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.730.1">TCP</span></strong></span></li></ul></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.731.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.732.1">Make sure you verify and check the instance IDs of the resources involved in the reachability check. </span><span class="koboSpan" id="kobo.732.2">Feel free to open another browser tab and navigate to the EC2 console to quickly check the instance IDs of the resources involved in </span><span class="No-Break"><span class="koboSpan" id="kobo.733.1">the analysis.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.734.1">Click</span><a id="_idIndexMarker861"/><span class="koboSpan" id="kobo.735.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.736.1">Create and analyze path</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.737.1">button afterward.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.738.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.739.1">Wait for about 2-3 minutes for the analysis to complete. </span><span class="koboSpan" id="kobo.739.2">Feel free to grab a cup of coffee or tea while waiting! </span><span class="koboSpan" id="kobo.739.3">You may click the refresh button in case the user interface is not </span><span class="No-Break"><span class="koboSpan" id="kobo.740.1">updating automatically.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.741.1">Once the analysis has finished, we should see that </span><strong class="bold"><span class="koboSpan" id="kobo.742.1">Reachability status</span></strong><span class="koboSpan" id="kobo.743.1"> is set </span><span class="No-Break"><span class="koboSpan" id="kobo.744.1">to </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.745.1">Reachable</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.746.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.747.1">Toggle </span><em class="italic"><span class="koboSpan" id="kobo.748.1">on</span></em><span class="koboSpan" id="kobo.749.1"> the checkbox of the analysis we ran to view the diagram under </span><strong class="bold"><span class="koboSpan" id="kobo.750.1">Analysis explorer</span></strong><span class="koboSpan" id="kobo.751.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.752.1">Path details</span></strong><span class="koboSpan" id="kobo.753.1">, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.754.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.755.1">.16</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.756.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer172">
<span class="koboSpan" id="kobo.757.1"><img alt="" src="image/B19755_06_016.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.758.1">Figure 6.16 – Analysis explorer &gt; Path details</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.759.1">Using</span><a id="_idIndexMarker862"/><span class="koboSpan" id="kobo.760.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.761.1">Analysis explorer</span></strong><span class="koboSpan" id="kobo.762.1">, we </span><a id="_idIndexMarker863"/><span class="koboSpan" id="kobo.763.1">should be</span><a id="_idIndexMarker864"/><span class="koboSpan" id="kobo.764.1"> able to analyze and evaluate the network reachability and connectivity between different resources within</span><a id="_idIndexMarker865"/><span class="koboSpan" id="kobo.765.1"> the VPC environment in AWS. </span><span class="koboSpan" id="kobo.765.2">Here, we can see that the first target VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.767.1">, is reachable from the attacker instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">vm-kali</span></strong><span class="koboSpan" id="kobo.769.1">, as well as the network traffic passed through the VPC network peering connection. </span><span class="koboSpan" id="kobo.769.2">If you have time, you may use the VPC Reachability Analyzer to verify that we can’t ping the second target VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.770.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.771.1">) from the attacker VM </span><span class="No-Break"><span class="koboSpan" id="kobo.772.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.773.1">vm-kali</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.774.1">).</span></span></p></li>
</ol>
<p><span class="koboSpan" id="kobo.775.1">In addition to using the solutions discussed in this section, note that there are several other ways to test network connectivity inside the lab network environment. </span><span class="koboSpan" id="kobo.775.2">Feel free to experiment with other tools </span><a id="_idIndexMarker866"/><span class="koboSpan" id="kobo.776.1">such as </span><strong class="bold"><span class="koboSpan" id="kobo.777.1">telnet</span></strong><span class="koboSpan" id="kobo.778.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.779.1">nmap</span></strong><span class="koboSpan" id="kobo.780.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.781.1">traceroute</span></strong><span class="koboSpan" id="kobo.782.1"> when</span><a id="_idIndexMarker867"/><span class="koboSpan" id="kobo.783.1"> troubleshooting </span><a id="_idIndexMarker868"/><span class="No-Break"><span class="koboSpan" id="kobo.784.1">network connectivity.</span></span></p>
<p><span class="koboSpan" id="kobo.785.1">At this point, we </span><a id="_idIndexMarker869"/><span class="koboSpan" id="kobo.786.1">should </span><a id="_idIndexMarker870"/><span class="koboSpan" id="kobo.787.1">have a better idea of how the network is set up and configured. </span><span class="koboSpan" id="kobo.787.2">In the next section, we will proceed with setting up and configuring the attacker VM instance to prepare it for the penetration testing simulation at the end of </span><span class="No-Break"><span class="koboSpan" id="kobo.788.1">this chapter.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.789.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.790.1">If you are planning to take a break for more than an hour, it might be a good idea to clean up and delete the lab environment first (refer to the </span><em class="italic"><span class="koboSpan" id="kobo.791.1">Cleaning up</span></em><span class="koboSpan" id="kobo.792.1"> section at the end of this chapter) and then bring it back up when you can continue working on the succeeding sections of this chapter. </span><span class="koboSpan" id="kobo.792.2">This will help you avoid paying for the time several unused cloud resources are running. </span><span class="koboSpan" id="kobo.792.3">While the IP addresses of the resources in the lab environment may change (after bringing the lab environment back up), the overall network and security configuration of the lab environment should more or less be </span><span class="No-Break"><span class="koboSpan" id="kobo.793.1">the same.</span></span></p>
<h1 id="_idParaDest-127"><a id="_idTextAnchor127"/><span class="koboSpan" id="kobo.794.1">Setting up the attacker VM instance</span></h1>
<p><span class="koboSpan" id="kobo.795.1">In this </span><a id="_idIndexMarker871"/><span class="koboSpan" id="kobo.796.1">section, we will be setting up our attacker EC2 instance. </span><span class="koboSpan" id="kobo.796.2">Compared to </span><span class="No-Break"><em class="italic"><a href="B19755_04.xhtml"><span class="koboSpan" id="kobo.797.1">Chapter 4</span></a></em></span><span class="koboSpan" id="kobo.798.1">, </span><em class="italic"><span class="koboSpan" id="kobo.799.1">Setting Up Isolated Penetration Testing Lab Environments on GCP</span></em><span class="koboSpan" id="kobo.800.1">, and </span><span class="No-Break"><em class="italic"><a href="B19755_05.xhtml"><span class="koboSpan" id="kobo.801.1">Chapter 5</span></a></em></span><span class="koboSpan" id="kobo.802.1">, </span><em class="italic"><span class="koboSpan" id="kobo.803.1">Setting Up Isolated Penetration Testing Lab Environments on Azure</span></em><span class="koboSpan" id="kobo.804.1">, our attacker instance setup in this chapter will be much simpler as we will only work with </span><span class="No-Break"><span class="koboSpan" id="kobo.805.1">a Terminal.</span></span></p>
<p><span class="koboSpan" id="kobo.806.1">That being said, let’s proceed with setting up the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.807.1">VM instance:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.808.1">Navigate to the list of EC2 instances (using the sidebar). </span><span class="koboSpan" id="kobo.808.2">Toggle the checkbox </span><em class="italic"><span class="koboSpan" id="kobo.809.1">on</span></em><span class="koboSpan" id="kobo.810.1"> to select </span><strong class="source-inline"><span class="koboSpan" id="kobo.811.1">vm-kali</span></strong><span class="koboSpan" id="kobo.812.1"> and then click the </span><strong class="bold"><span class="koboSpan" id="kobo.813.1">Connect</span></strong><span class="koboSpan" id="kobo.814.1"> button. </span><span class="koboSpan" id="kobo.814.2">This will redirect you to the </span><strong class="bold"><span class="koboSpan" id="kobo.815.1">Connect to </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.816.1">instance</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.817.1"> page.</span></span></li>
<li><span class="koboSpan" id="kobo.818.1">In the last tab (</span><strong class="bold"><span class="koboSpan" id="kobo.819.1">EC2 serial console</span></strong><span class="koboSpan" id="kobo.820.1">), click the </span><strong class="bold"><span class="koboSpan" id="kobo.821.1">Connect</span></strong><span class="koboSpan" id="kobo.822.1"> button to access the instance via the </span><strong class="bold"><span class="koboSpan" id="kobo.823.1">EC2 </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.824.1">serial console</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.825.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.826.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.827.1">Inside the serial console, if you are seeing a blank black screen, simply press the </span><em class="italic"><span class="koboSpan" id="kobo.828.1">Enter</span></em><span class="koboSpan" id="kobo.829.1"> key to see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.830.1">root@kali:~#</span></strong><span class="koboSpan" id="kobo.831.1"> command prompt. </span><span class="koboSpan" id="kobo.831.2">If you are having issues accessing the attacker VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.832.1">vm-kali</span></strong><span class="koboSpan" id="kobo.833.1">, feel free to reboot the EC2 instance and then try accessing it again via the EC2 serial console. </span><span class="koboSpan" id="kobo.833.2">In addition to this, make sure that there are no other open sessions to the instance that could potentially interfere with the serial </span><span class="No-Break"><span class="koboSpan" id="kobo.834.1">console connection.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.835.1">Since we</span><a id="_idIndexMarker872"/><span class="koboSpan" id="kobo.836.1"> will be using Metasploit later, we’ll need to verify if we can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.837.1">msfconsole</span></strong><span class="koboSpan" id="kobo.838.1"> inside the attacker VM instance. </span><span class="koboSpan" id="kobo.838.2">That said, let’s run the </span><span class="No-Break"><span class="koboSpan" id="kobo.839.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.840.1">which msfconsole</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.841.1">Running this command will return </span><strong class="source-inline"><span class="koboSpan" id="kobo.842.1">msfconsole not found</span></strong><span class="koboSpan" id="kobo.843.1">. </span><span class="koboSpan" id="kobo.843.2">Looks like we need to do some essential installation and setup </span><span class="No-Break"><span class="koboSpan" id="kobo.844.1">work first!</span></span></p></li> <li><span class="koboSpan" id="kobo.845.1">Now, let’s update the package lists and then install the default set of packages for Kali Linux using the </span><span class="No-Break"><span class="koboSpan" id="kobo.846.1">following commands:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.847.1">sudo DEBIAN_FRONTEND=noninteractive dpkg --configure -a</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.848.1">sudo apt update</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.849.1">sudo DEBIAN_FRONTEND=noninteractive apt install -y kali-linux-default</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.850.1">Feel free to tweak the installation and setup commands as needed (just in case!). </span><span class="koboSpan" id="kobo.850.2">If these commands worked just fine, then we can proceed with the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.851.1">of steps.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.852.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.853.1">This step may take 20-30 minutes to complete. </span><span class="koboSpan" id="kobo.853.2">Feel free to check the following link while waiting: </span><a href="https://www.kali.org/docs/general-use/metapackages/"><span class="koboSpan" id="kobo.854.1">https://www.kali.org/docs/general-use/metapackages/</span></a><span class="koboSpan" id="kobo.855.1">. </span><span class="koboSpan" id="kobo.855.2">Once installation has finished, feel free to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.856.1">clear</span></strong><span class="koboSpan" id="kobo.857.1"> command to clear </span><span class="No-Break"><span class="koboSpan" id="kobo.858.1">the screen.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.859.1">Let’s run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.860.1">which msfconsole</span></strong><span class="koboSpan" id="kobo.861.1"> command again to verify if we can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.862.1">msfconsole</span></strong><span class="koboSpan" id="kobo.863.1"> inside the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.864.1">VM instance:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.865.1">which msfconsole</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.866.1">This should return </span><strong class="source-inline"><span class="koboSpan" id="kobo.867.1">/usr/bin/msfconsole</span></strong><span class="koboSpan" id="kobo.868.1">. </span><span class="koboSpan" id="kobo.868.2">Looks like we’re ready </span><span class="No-Break"><span class="koboSpan" id="kobo.869.1">for showtime!</span></span></p></li> <li><span class="koboSpan" id="kobo.870.1">Now, let’s</span><a id="_idIndexMarker873"/><span class="koboSpan" id="kobo.871.1"> prepare the </span><strong class="source-inline"><span class="koboSpan" id="kobo.872.1">username.txt</span></strong><span class="koboSpan" id="kobo.873.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.874.1">passwords.txt</span></strong><span class="koboSpan" id="kobo.875.1"> files we will use to perform a sample SSH brute-force attack. </span><span class="koboSpan" id="kobo.875.2">Let’s start by creating two blank files using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.876.1">touch</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.877.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.878.1">cd /root</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.879.1">touch usernames.txt</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.880.1">touch passwords.txt</span></strong></pre></li> <li><span class="koboSpan" id="kobo.881.1">Run the following command to open the empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.882.1">/root/usernames.txt</span></strong><span class="koboSpan" id="kobo.883.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.884.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.885.1">vim usernames.txt</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.886.1">Feel free to type </span><strong class="source-inline"><span class="koboSpan" id="kobo.887.1">:set nu</span></strong><span class="koboSpan" id="kobo.888.1"> and then press the </span><em class="italic"><span class="koboSpan" id="kobo.889.1">Enter</span></em><span class="koboSpan" id="kobo.890.1"> key to show the line numbers inside </span><span class="No-Break"><span class="koboSpan" id="kobo.891.1">the editor.</span></span></p></li> <li><span class="koboSpan" id="kobo.892.1">Next, press the </span><em class="italic"><span class="koboSpan" id="kobo.893.1">i</span></em><span class="koboSpan" id="kobo.894.1"> key to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.895.1">insert mode</span></strong><span class="koboSpan" id="kobo.896.1"> so that we can edit </span><span class="No-Break"><span class="koboSpan" id="kobo.897.1">the file.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.898.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.899.1">In case you have forgotten already, </span><strong class="bold"><span class="koboSpan" id="kobo.900.1">insert mode</span></strong><span class="koboSpan" id="kobo.901.1"> in Vim </span><a id="_idIndexMarker874"/><span class="koboSpan" id="kobo.902.1">allows us to type and make changes as we would in a regular text editor. </span><span class="koboSpan" id="kobo.902.2">In this mode, we can freely add, delete, or modify characters without affecting the </span><span class="No-Break"><span class="koboSpan" id="kobo.903.1">surrounding text.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.904.1">Type or paste the following block of code into our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.905.1">usernames.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.906.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.907.1">
admin
root
ubuntu
adminuser
adminuser2</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.908.1">Here, we </span><a id="_idIndexMarker875"/><span class="koboSpan" id="kobo.909.1">have an intentionally simplified list of usernames to speed up the simulation process. </span><span class="koboSpan" id="kobo.909.2">In real penetration testing activities, we would use a more extensive list of usernames. </span><span class="koboSpan" id="kobo.909.3">This would include commonly used usernames, default usernames specific to certain systems or applications, and, potentially, </span><span class="No-Break"><span class="koboSpan" id="kobo.910.1">custom usernames.</span></span></p></li> <li><span class="koboSpan" id="kobo.911.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.912.1">Esc</span></em><span class="koboSpan" id="kobo.913.1"> key to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.914.1">normal mode</span></strong><span class="koboSpan" id="kobo.915.1">. </span><span class="koboSpan" id="kobo.915.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.916.1">:wq!</span></strong><span class="koboSpan" id="kobo.917.1">. </span><span class="koboSpan" id="kobo.917.2">Press </span><em class="italic"><span class="koboSpan" id="kobo.918.1">Enter</span></em><span class="koboSpan" id="kobo.919.1"> afterward. </span><span class="koboSpan" id="kobo.919.2">This will save the changes you’ve made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.920.1">usernames.txt</span></strong><span class="koboSpan" id="kobo.921.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.922.1">as well.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.923.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.924.1">To refresh your memory, </span><strong class="bold"><span class="koboSpan" id="kobo.925.1">normal mode</span></strong><span class="koboSpan" id="kobo.926.1"> in </span><a id="_idIndexMarker876"/><span class="koboSpan" id="kobo.927.1">Vim allows us to navigate through the text, execute commands, and perform various operations on the file. </span><span class="koboSpan" id="kobo.927.2">In this mode, specific keystrokes (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.928.1">:wq!</span></strong><span class="koboSpan" id="kobo.929.1">) can be used to move the cursor, search for text, copy and paste, and perform editing actions such as deleting, replacing, and undoing changes. </span><span class="koboSpan" id="kobo.929.2">For instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.930.1">w</span></strong><span class="koboSpan" id="kobo.931.1"> represents the </span><em class="italic"><span class="koboSpan" id="kobo.932.1">write</span></em><span class="koboSpan" id="kobo.933.1"> command (which saves changes to the file), and </span><strong class="source-inline"><span class="koboSpan" id="kobo.934.1">q</span></strong><span class="koboSpan" id="kobo.935.1"> represents the </span><em class="italic"><span class="koboSpan" id="kobo.936.1">quit</span></em><span class="koboSpan" id="kobo.937.1"> command (which exits the editor). </span><span class="koboSpan" id="kobo.937.2">Finally, the exclamation point, </span><strong class="source-inline"><span class="koboSpan" id="kobo.938.1">!</span></strong><span class="koboSpan" id="kobo.939.1">, is simply an optional modifier that forces the command to execute, even if there are unsaved changes along with </span><span class="No-Break"><span class="koboSpan" id="kobo.940.1">other warnings.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.941.1">Run the following command to open the empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.942.1">/root/passwords.txt</span></strong><span class="koboSpan" id="kobo.943.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.944.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.945.1">vim passwords.txt</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.946.1">Feel free to type </span><strong class="source-inline"><span class="koboSpan" id="kobo.947.1">:set nu</span></strong><span class="koboSpan" id="kobo.948.1"> and then press the </span><em class="italic"><span class="koboSpan" id="kobo.949.1">Enter</span></em><span class="koboSpan" id="kobo.950.1"> key to show the line numbers inside </span><span class="No-Break"><span class="koboSpan" id="kobo.951.1">the editor.</span></span></p></li> <li><span class="koboSpan" id="kobo.952.1">Next, press the </span><em class="italic"><span class="koboSpan" id="kobo.953.1">i</span></em><span class="koboSpan" id="kobo.954.1"> key to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.955.1">insert mode</span></strong><span class="koboSpan" id="kobo.956.1"> so that we can edit </span><span class="No-Break"><span class="koboSpan" id="kobo.957.1">the file.</span></span></li>
<li><span class="koboSpan" id="kobo.958.1">Type or paste the following block of code into our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.959.1">passwords.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.960.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.961.1">
password
123456
12345678
pass123</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.962.1">Here, we have an intentionally simplified list of passwords to speed up the simulation </span><span class="No-Break"><span class="koboSpan" id="kobo.963.1">process later.</span></span></p></li> <li><span class="koboSpan" id="kobo.964.1">Press</span><a id="_idIndexMarker877"/><span class="koboSpan" id="kobo.965.1"> the </span><em class="italic"><span class="koboSpan" id="kobo.966.1">Esc</span></em><span class="koboSpan" id="kobo.967.1"> key to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.968.1">normal mode</span></strong><span class="koboSpan" id="kobo.969.1">. </span><span class="koboSpan" id="kobo.969.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.970.1">:wq!</span></strong><span class="koboSpan" id="kobo.971.1">. </span><span class="koboSpan" id="kobo.971.2">Press </span><em class="italic"><span class="koboSpan" id="kobo.972.1">Enter</span></em><span class="koboSpan" id="kobo.973.1"> afterward. </span><span class="koboSpan" id="kobo.973.2">This will save the changes you’ve made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.974.1">passwords.txt</span></strong><span class="koboSpan" id="kobo.975.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.976.1">as well.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.977.1">Now that we have everything ready, we can proceed with performing a penetration testing simulation inside our </span><span class="No-Break"><span class="koboSpan" id="kobo.978.1">lab environment!</span></span></p>
<h1 id="_idParaDest-128"><a id="_idTextAnchor128"/><span class="koboSpan" id="kobo.979.1">Simulating penetration testing in the isolated network environment</span></h1>
<p><span class="koboSpan" id="kobo.980.1">Given that </span><a id="_idIndexMarker878"/><span class="koboSpan" id="kobo.981.1">our lab environment in AWS has been set up successfully, we can now proceed with having a penetration </span><a id="_idIndexMarker879"/><span class="koboSpan" id="kobo.982.1">testing simulation to verify that everything has been configured correctly. </span><span class="koboSpan" id="kobo.982.2">Of course, we will work with a simplified penetration testing process as our primary goal is to assess if the lab environment has been set up and </span><span class="No-Break"><span class="koboSpan" id="kobo.983.1">configured properly.</span></span></p>
<p><span class="koboSpan" id="kobo.984.1">Before we start the simulation, let’s quickly discuss the relevant concepts, terminologies, and tools we need to know for </span><span class="No-Break"><span class="koboSpan" id="kobo.985.1">this section:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.986.1">Network pivoting</span></strong><span class="koboSpan" id="kobo.987.1">: Network pivoting </span><a id="_idIndexMarker880"/><span class="koboSpan" id="kobo.988.1">refers to the technique of using a compromised system as a gateway to access other interconnected systems or segments within a network. </span><span class="koboSpan" id="kobo.988.2">Using various network pivoting techniques and tools, an attacker can extend their reach, navigate through internal resources, and potentially </span><span class="No-Break"><span class="koboSpan" id="kobo.989.1">escalate privileges.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.990.1">Lateral movement</span></strong><span class="koboSpan" id="kobo.991.1">: Lateral movement</span><a id="_idIndexMarker881"/><span class="koboSpan" id="kobo.992.1"> refers to the act of an attacker moving horizontally across systems within the same network (or domain) after gaining initial access. </span><span class="koboSpan" id="kobo.992.2">It involves exploiting vulnerabilities, leveraging credentials, and using various techniques to access and compromise additional systems within the </span><span class="No-Break"><span class="koboSpan" id="kobo.993.1">same environment.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.994.1">Meterpreter</span></strong><span class="koboSpan" id="kobo.995.1">: Meterpreter </span><a id="_idIndexMarker882"/><span class="koboSpan" id="kobo.996.1">is an advanced payload within the Metasploit Framework that provides an extensive range of capabilities, including interactive command execution, privilege escalation, and network pivoting. </span><span class="koboSpan" id="kobo.996.2">Leveraging a Meterpreter session provides the attacker with an interactive shell that helps with various information gathering and advanced post-exploitation tasks for ethical hacking requirements. </span><span class="koboSpan" id="kobo.996.3">We can think of a Meterpreter session as an advanced SSH shell with several additional powerful capabilities specifically designed for penetration testing and </span><span class="No-Break"><span class="koboSpan" id="kobo.997.1">security research.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.998.1">Metasploit post/multi/manage/autoroute module</span></strong><span class="koboSpan" id="kobo.999.1">: The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1000.1">post/multi/manage/autoroute</span></strong><span class="koboSpan" id="kobo.1001.1"> module is a </span><a id="_idIndexMarker883"/><span class="koboSpan" id="kobo.1002.1">specialized module within the Metasploit Framework that helps establish network routes from compromised systems to other target subnets. </span><span class="koboSpan" id="kobo.1002.2">This module is particularly useful for lateral movement and network pivoting during </span><span class="No-Break"><span class="koboSpan" id="kobo.1003.1">post-exploitation activities.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1004.1">As we delve </span><a id="_idIndexMarker884"/><span class="koboSpan" id="kobo.1005.1">deeper into </span><a id="_idIndexMarker885"/><span class="koboSpan" id="kobo.1006.1">cybersecurity, we will encounter other advanced methods and techniques for network pivoting and lateral movement. </span><span class="koboSpan" id="kobo.1006.2">There’s more to learn, but these should do the trick </span><span class="No-Break"><span class="koboSpan" id="kobo.1007.1">for now!</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1008.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1009.1">It is unethical and illegal to attack cloud resources owned by another user or company. </span><span class="koboSpan" id="kobo.1009.2">Before proceeding, make sure you read the </span><em class="italic"><span class="koboSpan" id="kobo.1010.1">Examining the considerations when building penetration testing lab environments in the cloud</span></em><span class="koboSpan" id="kobo.1011.1"> section of </span><span class="No-Break"><em class="italic"><a href="B19755_01.xhtml"><span class="koboSpan" id="kobo.1012.1">Chapter 1</span></a></em></span><span class="koboSpan" id="kobo.1013.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1014.1">Getting Started with Penetration Testing Labs in the Cloud</span></em><span class="koboSpan" id="kobo.1015.1">, since we will be simulating the attack process to validate if misconfigurations and vulnerabilities present in the applications and services running in the target VM instance </span><span class="No-Break"><span class="koboSpan" id="kobo.1016.1">are exploitable.</span></span></p>
<p><span class="koboSpan" id="kobo.1017.1">That said, this section is divided into the </span><span class="No-Break"><span class="koboSpan" id="kobo.1018.1">following subparts:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.1019.1">Part 1 of 3 – Obtaining the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1020.1">first flag</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1021.1">Part 2 of 3 – Pivoting to attack </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1022.1">other resources</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1023.1">Part 3 of 3 – Using the Reachability Analyzer to validate </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1024.1">network connectivity</span></em></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1025.1">With these aspects in mind, we can now start the penetration </span><span class="No-Break"><span class="koboSpan" id="kobo.1026.1">testing simulation.</span></span></p>
<h2 id="_idParaDest-129"><a id="_idTextAnchor129"/><span class="koboSpan" id="kobo.1027.1">Part 1 of 3 – Obtaining the first flag</span></h2>
<p><span class="koboSpan" id="kobo.1028.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1029.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1030.1">Continuing </span><a id="_idIndexMarker886"/><span class="koboSpan" id="kobo.1031.1">where we left off in the previous section, let’s check and scan the open ports on the first target EC2 </span><span class="No-Break"><span class="koboSpan" id="kobo.1032.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1033.1">target-vm-01</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1034.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer173">
<span class="koboSpan" id="kobo.1035.1"><img alt="" src="image/B19755_06_017.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1036.1">Figure 6.17 – Scanning the first target instance with Nmap</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1037.1">Similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1038.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1039.1">.17</span></em><span class="koboSpan" id="kobo.1040.1">, we’ll initiate the Nmap scan from the attacker instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1041.1">vm-kali</span></strong><span class="koboSpan" id="kobo.1042.1">), which is deployed in another VPC. </span><span class="koboSpan" id="kobo.1042.2">Make sure that you can access and run commands inside the</span><a id="_idIndexMarker887"/><span class="koboSpan" id="kobo.1043.1"> attacker instance via the </span><strong class="bold"><span class="koboSpan" id="kobo.1044.1">EC2 </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1045.1">serial console</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1046.1">.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1047.1">Once you are ready to perform the scan, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.1048.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1049.1">nmap --top-ports 1000 &lt;TARGET VM 01 PRIVATE IP&gt;</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.1050.1">Make </span><a id="_idIndexMarker888"/><span class="koboSpan" id="kobo.1051.1">sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1052.1">&lt;TARGET VM 01 PRIVATE IP&gt;</span></strong><span class="koboSpan" id="kobo.1053.1"> with the private IP address of the first target VM instance. </span><span class="koboSpan" id="kobo.1053.2">If you are wondering where you can get this value, it’s probably in the text editor on your local machine (after you copied the output values to the text editor after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1054.1">terraform apply</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1055.1">command earlier):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer174">
<span class="koboSpan" id="kobo.1056.1"><img alt="" src="image/B19755_06_018.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1057.1">Figure 6.18 – Result after running the nmap command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1058.1">After a few seconds, we should see the results that are returned after running this command. </span><span class="koboSpan" id="kobo.1058.2">We should see that port </span><strong class="source-inline"><span class="koboSpan" id="kobo.1059.1">22</span></strong><span class="koboSpan" id="kobo.1060.1"> is open, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1061.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1062.1">.18</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1063.1">!</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1064.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1065.1">You might have noticed that the private IP address of the first target machine we used in our example (in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1066.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1067.1">.18</span></em><span class="koboSpan" id="kobo.1068.1">) has changed! </span><span class="koboSpan" id="kobo.1068.2">Behind the scenes, the lab environment used in this chapter was destroyed and rebuilt (a couple of times) to manage the cost of running the lab during long periods of inactivity. </span><span class="koboSpan" id="kobo.1068.3">That said, the private IP address of an EC2 instance should remain the same unless the instance has been deleted and then recreated. </span><span class="koboSpan" id="kobo.1068.4">On your end, make sure you use the actual private IP address values of your EC2 instances as you will most likely get a different IP address value after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1069.1">terraform apply</span></strong><span class="koboSpan" id="kobo.1070.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1071.1">terraform </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1072.1">show</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1073.1"> commands.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1074.1">Now, execute</span><a id="_idIndexMarker889"/><span class="koboSpan" id="kobo.1075.1"> the following command to launch the Metasploit </span><span class="No-Break"><span class="koboSpan" id="kobo.1076.1">Framework console:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1077.1">msfconsole</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1078.1">This will launch the Metasploit Framework console, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1079.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1080.1">.19</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1081.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer175">
<span class="koboSpan" id="kobo.1082.1"><img alt="" src="image/B19755_06_019.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1083.1">Figure 6.19 – The Metasploit Framework console</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1084.1">Note that you might get a different loading screen (or loading text) after </span><span class="No-Break"><span class="koboSpan" id="kobo.1085.1">running </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1086.1">msfconsole</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1087.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1088.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1089.1">It may take a minute or two for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1090.1">msfconsole</span></strong><span class="koboSpan" id="kobo.1091.1"> to </span><span class="No-Break"><span class="koboSpan" id="kobo.1092.1">be ready.</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1093.1">Run the following command to search for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1094.1">auxiliary/scanner/ssh/ssh_login</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1095.1"> module:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1096.1">search ssh_login</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1097.1">This should </span><a id="_idIndexMarker890"/><span class="koboSpan" id="kobo.1098.1">yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.1099.1">following results:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer176">
<span class="koboSpan" id="kobo.1100.1"><img alt="" src="image/B19755_06_020.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1101.1">Figure 6.20 – Results after running search ssh_login</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1102.1">Here, we have two matching modules – </span><strong class="bold"><span class="koboSpan" id="kobo.1103.1">SSH Login Check Scanner</span></strong><span class="koboSpan" id="kobo.1104.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1105.1">auxiliary/scanner/ssh/ssh_login</span></strong><span class="koboSpan" id="kobo.1106.1">) and </span><strong class="bold"><span class="koboSpan" id="kobo.1107.1">SSH Public Key Login </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1108.1">Scanner</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1109.1"> (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1110.1">auxiliary/scanner/ssh/ssh_login_pubkey</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1111.1">).</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1112.1">Now, run the following command to select and use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1113.1">auxiliary/scanner/ssh/ssh_login</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1114.1"> module:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1115.1">use auxiliary/scanner/ssh/ssh_login</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1116.1">After running the command, our prompt should change to </span><strong class="bold"><span class="koboSpan" id="kobo.1117.1">auxiliary(scanner/ssh/ssh_login) &gt;</span></strong><span class="koboSpan" id="kobo.1118.1">, indicating that we have successfully selected the auxiliary SSH login scanner module. </span><span class="koboSpan" id="kobo.1118.2">From here, we can configure the module options and execute the scanner to check if we can gain access to the target system using different username and </span><span class="No-Break"><span class="koboSpan" id="kobo.1119.1">password combinations.</span></span></p></li> <li><span class="koboSpan" id="kobo.1120.1">Let’s quickly check the settings and options we have using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1121.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1122.1">show options</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1123.1">This should return a list of module options, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1124.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1125.1">.21</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1126.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer177">
<span class="koboSpan" id="kobo.1127.1"><img alt="" src="image/B19755_06_021.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1128.1">Figure 6.21 – Output after executing the show options command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1129.1">Out of</span><a id="_idIndexMarker891"/><span class="koboSpan" id="kobo.1130.1"> these options, we will set the following values: </span><strong class="bold"><span class="koboSpan" id="kobo.1131.1">USER_FILE</span></strong><span class="koboSpan" id="kobo.1132.1"> (not shown in the screenshot) for the filename where the usernames are stored, </span><strong class="bold"><span class="koboSpan" id="kobo.1133.1">PASS_FILE</span></strong><span class="koboSpan" id="kobo.1134.1"> for the filename where the passwords are stored, </span><strong class="bold"><span class="koboSpan" id="kobo.1135.1">RHOSTS</span></strong><span class="koboSpan" id="kobo.1136.1"> (not shown in the screenshot) for the target resource(s) to be scanned by the SSH login scanner module, </span><strong class="bold"><span class="koboSpan" id="kobo.1137.1">THREADS</span></strong><span class="koboSpan" id="kobo.1138.1"> (not shown in the screenshot) for the number of threads, and </span><strong class="bold"><span class="koboSpan" id="kobo.1139.1">VERBOSE</span></strong><span class="koboSpan" id="kobo.1140.1"> (not shown in the screenshot) for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1141.1">verbosity level.</span></span></p></li>
</ol>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1142.1">Run the following commands (one command at a time) to configure </span><span class="No-Break"><span class="koboSpan" id="kobo.1143.1">our scanner:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1144.1">set USER_FILE /root/usernames.txt</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1145.1">set PASS_FILE /root/passwords.txt</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1146.1">set RHOSTS &lt;TARGET VM 01 PRIVATE IP&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1147.1">set THREADS 1</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1148.1">set VERBOSE true</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1149.1">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1150.1">&lt;TARGET VM 01 PRIVATE IP&gt;</span></strong><span class="koboSpan" id="kobo.1151.1"> with the private IP address of the first target EC2 </span><span class="No-Break"><span class="koboSpan" id="kobo.1152.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1153.1">target-vm-01</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1154.1">).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1155.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1156.1">Be careful when specifying the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1157.1">RHOSTS</span></strong><span class="koboSpan" id="kobo.1158.1"> configuration value as we do not want to accidentally attack a random resource outside of our </span><span class="No-Break"><span class="koboSpan" id="kobo.1159.1">lab environment.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1160.1">With </span><a id="_idIndexMarker892"/><span class="koboSpan" id="kobo.1161.1">everything ready, let’s proceed with running the SSH </span><span class="No-Break"><span class="koboSpan" id="kobo.1162.1">login scanner:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer178">
<span class="koboSpan" id="kobo.1163.1"><img alt="" src="image/B19755_06_022.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1164.1">Figure 6.22 – Scanning the first target instance with the SSH login scanner</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1165.1">Like the Nmap scan we performed previously, we will scan the first target EC2 instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1166.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.1167.1">) using the SSH login scanner from the attacker instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1168.1">vm-kali</span></strong><span class="koboSpan" id="kobo.1169.1">), similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1170.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1171.1">.22</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1172.1">.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1173.1">Once you are ready to perform the scan, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.1174.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1175.1">run</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.1176.1">This will yield the following set </span><span class="No-Break"><span class="koboSpan" id="kobo.1177.1">of logs:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer179">
<span class="koboSpan" id="kobo.1178.1"><img alt="" src="image/B19755_06_023.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1179.1">Figure 6.23 – Logs after running the SSH login scanner</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1180.1">After </span><a id="_idIndexMarker893"/><span class="koboSpan" id="kobo.1181.1">several failed attempts, we can see that we were able to successfully authenticate using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1182.1">adminuser</span></strong><span class="koboSpan" id="kobo.1183.1"> as the username and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1184.1">password</span></strong><span class="koboSpan" id="kobo.1185.1"> as </span><span class="No-Break"><span class="koboSpan" id="kobo.1186.1">the password!</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1187.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1188.1">This step may take a few minutes to complete. </span><span class="koboSpan" id="kobo.1188.2">Feel free to grab a cup of coffee or tea </span><span class="No-Break"><span class="koboSpan" id="kobo.1189.1">while waiting!</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.1190.1">List the existing sessions by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.1191.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1192.1">sessions</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1193.1">This should return a single active session, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1194.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1195.1">.24</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1196.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer180">
<span class="koboSpan" id="kobo.1197.1"><img alt="" src="image/B19755_06_024.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1198.1">Figure 6.24 – List of sessions</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1199.1">Here, we </span><a id="_idIndexMarker894"/><span class="koboSpan" id="kobo.1200.1">have the </span><strong class="bold"><span class="koboSpan" id="kobo.1201.1">Connection</span></strong><span class="koboSpan" id="kobo.1202.1"> column, which shows us a few additional details about the active session (that is, the attacker instance is connected to the first </span><span class="No-Break"><span class="koboSpan" id="kobo.1203.1">target instance).</span></span></p></li>
</ol>
<ol>
<li value="9"><span class="koboSpan" id="kobo.1204.1">Run the following command to interact with the first session (ID = </span><span class="No-Break"><span class="koboSpan" id="kobo.1205.1">1):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1206.1">sessions -i 1</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1207.1">This will allow you to interact with the session (to the first VM instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1208.1">vm-target-01</span></strong><span class="koboSpan" id="kobo.1209.1">) and execute commands </span><span class="No-Break"><span class="koboSpan" id="kobo.1210.1">within it.</span></span></p></li> <li><span class="koboSpan" id="kobo.1211.1">Once you are inside the session, run the following command to check the username of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1212.1">current user:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1213.1">whoami</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1214.1">This should return the </span><span class="No-Break"><span class="koboSpan" id="kobo.1215.1">following output:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer181">
<span class="koboSpan" id="kobo.1216.1"><img alt="" src="image/B19755_06_025.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1217.1">Figure 6.25 – Result after using the whoami command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1218.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1219.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1220.1">.25</span></em><span class="koboSpan" id="kobo.1221.1">, we can see that running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1222.1">whoami</span></strong><span class="koboSpan" id="kobo.1223.1"> command yields </span><strong class="source-inline"><span class="koboSpan" id="kobo.1224.1">adminuser</span></strong><span class="koboSpan" id="kobo.1225.1"> as output, indicating that we are currently logged in as the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1226.1">adminuser</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1227.1"> user.</span></span></p></li>
</ol>
<ol>
<li value="11"><span class="koboSpan" id="kobo.1228.1">Elevate</span><a id="_idIndexMarker895"/><span class="koboSpan" id="kobo.1229.1"> privileges to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1230.1">root</span></strong><span class="koboSpan" id="kobo.1231.1"> by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.1232.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1233.1">sudo su</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1234.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1235.1">Wasn’t that a bit too easy? </span><span class="koboSpan" id="kobo.1235.2">Looks</span><a id="_idIndexMarker896"/><span class="koboSpan" id="kobo.1236.1"> like </span><strong class="bold"><span class="koboSpan" id="kobo.1237.1">passwordless sudo</span></strong><span class="koboSpan" id="kobo.1238.1"> allowed us to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1239.1">su</span></strong><span class="koboSpan" id="kobo.1240.1"> (switch/substitute user) command to switch to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1241.1">root</span></strong><span class="koboSpan" id="kobo.1242.1"> account without requiring the root user’s password. </span><span class="koboSpan" id="kobo.1242.2">Passwordless sudo is more common than you might think as system administrators and engineers often leverage it to streamline automated tasks and ensure </span><span class="No-Break"><span class="koboSpan" id="kobo.1243.1">operational convenience.</span></span></p>
<ol>
<li value="12"><span class="koboSpan" id="kobo.1244.1">Run the following command to check the username of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1245.1">current user:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1246.1">whoami</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1247.1">This should give us the </span><span class="No-Break"><span class="koboSpan" id="kobo.1248.1">following output:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer182">
<span class="koboSpan" id="kobo.1249.1"><img alt="" src="image/B19755_06_026.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1250.1">Figure 6.26 – Result after using the whoami command after sudo su</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1251.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1252.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1253.1">.26</span></em><span class="koboSpan" id="kobo.1254.1">, we can see that running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1255.1">whoami</span></strong><span class="koboSpan" id="kobo.1256.1"> command (after </span><strong class="source-inline"><span class="koboSpan" id="kobo.1257.1">sudo su</span></strong><span class="koboSpan" id="kobo.1258.1">) yields the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1259.1">root</span></strong><span class="koboSpan" id="kobo.1260.1"> as the output, indicating that we are currently logged in as the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1261.1">root</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1262.1"> user.</span></span></p></li>
</ol>
<ol>
<li value="13"><span class="koboSpan" id="kobo.1263.1">Now that we have root access, let’s locate the first flag by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.1264.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1265.1">find / -type f -name "flag*"</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1266.1">This will search the entire filesystem for files starting with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1267.1">flag</span></strong><span class="koboSpan" id="kobo.1268.1">. </span><span class="koboSpan" id="kobo.1268.2">After a few minutes, we should get a list of results that includes a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1269.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1270.1">root/flag.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1271.1"> file:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1272.1">...
</span><span class="koboSpan" id="kobo.1272.2">/root/flag.txt
...</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1273.1">Looks like we found the </span><span class="No-Break"><span class="koboSpan" id="kobo.1274.1">flag file!</span></span></p></li> <li><span class="koboSpan" id="kobo.1275.1">Now, let’s</span><a id="_idIndexMarker897"/><span class="koboSpan" id="kobo.1276.1"> check the contents </span><span class="No-Break"><span class="koboSpan" id="kobo.1277.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1278.1">/root/flag.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1279.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1280.1">cat /root/flag.txt</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1281.1">This should give us </span><strong class="source-inline"><span class="koboSpan" id="kobo.1282.1">FLAG # 1!</span></strong><span class="koboSpan" id="kobo.1283.1">. </span><span class="No-Break"><span class="koboSpan" id="kobo.1284.1">Good job!</span></span></p></li> <li><span class="koboSpan" id="kobo.1285.1">Next, press </span><em class="italic"><span class="koboSpan" id="kobo.1286.1">Ctrl</span></em><span class="koboSpan" id="kobo.1287.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.1288.1">Z</span></em><span class="koboSpan" id="kobo.1289.1"> to run the session in background mode. </span><span class="koboSpan" id="kobo.1289.2">When prompted with </span><strong class="bold"><span class="koboSpan" id="kobo.1290.1">Background session 1? </span><span class="koboSpan" id="kobo.1290.2">[y/N]</span></strong><span class="koboSpan" id="kobo.1291.1">, enter </span><strong class="source-inline"><span class="koboSpan" id="kobo.1292.1">y</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1293.1">to proceed.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1294.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1295.1">Note that it should be </span><em class="italic"><span class="koboSpan" id="kobo.1296.1">Ctrl</span></em><span class="koboSpan" id="kobo.1297.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.1298.1">Z</span></em><span class="koboSpan" id="kobo.1299.1"> (background session) and </span><em class="italic"><span class="koboSpan" id="kobo.1300.1">not</span></em> <em class="italic"><span class="koboSpan" id="kobo.1301.1">Ctrl</span></em><span class="koboSpan" id="kobo.1302.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.1303.1">C</span></em><span class="koboSpan" id="kobo.1304.1"> (</span><span class="No-Break"><span class="koboSpan" id="kobo.1305.1">abort session).</span></span></p>
<h2 id="_idParaDest-130"><a id="_idTextAnchor130"/><span class="koboSpan" id="kobo.1306.1">Part 2 of 3 – Pivoting to attack other resources</span></h2>
<p><span class="koboSpan" id="kobo.1307.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1308.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1309.1">Let’s list </span><a id="_idIndexMarker898"/><span class="koboSpan" id="kobo.1310.1">the existing sessions by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.1311.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1312.1">sessions</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1313.1">Running this command should return a single session connecting the attacker instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1314.1">vm-kali</span></strong><span class="koboSpan" id="kobo.1315.1">) and the first target </span><span class="No-Break"><span class="koboSpan" id="kobo.1316.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1317.1">target-vm-01</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1318.1">):</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer183">
<span class="koboSpan" id="kobo.1319.1"><img alt="" src="image/B19755_06_027.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1320.1">Figure 6.27 – A session connecting the attacker instance and the first target instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1321.1">At this</span><a id="_idIndexMarker899"/><span class="koboSpan" id="kobo.1322.1"> point, we have one session connecting the attacker instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1323.1">vm-kali</span></strong><span class="koboSpan" id="kobo.1324.1">) with the first target instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1325.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.1326.1">), similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1327.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1328.1">.27</span></em><span class="koboSpan" id="kobo.1329.1">. </span><span class="koboSpan" id="kobo.1329.2">In this context, a </span><strong class="bold"><span class="koboSpan" id="kobo.1330.1">session</span></strong><span class="koboSpan" id="kobo.1331.1"> refers </span><a id="_idIndexMarker900"/><span class="koboSpan" id="kobo.1332.1">to an active and interactive connection between the attacker’s machine (where Metasploit is running) and a compromised target system. </span><span class="koboSpan" id="kobo.1332.2">When a successful exploit or payload is delivered to a vulnerable target, it can establish a session, granting the attacker various levels of control and access to the compromised system. </span><span class="koboSpan" id="kobo.1332.3">In our case, after running the SSH Login Scanner on the first target instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1333.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.1334.1">) previously, a session was established automatically between the attacker instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1335.1">vm-kali</span></strong><span class="koboSpan" id="kobo.1336.1">) and the first target </span><span class="No-Break"><span class="koboSpan" id="kobo.1337.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1338.1">target-vm-01</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1339.1">).</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1340.1">Next, run the following commands (one command at a time) to use the first session to prepare an upgraded </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1341.1">meterpreter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1342.1"> session:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1343.1">sessions -u 1</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1344.1">sessions -i 2</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1345.1">This should open a second session, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1346.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1347.1">.28</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1348.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer184">
<span class="koboSpan" id="kobo.1349.1"><img alt="" src="image/B19755_06_028.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1350.1">Figure 6.28 – Opening an upgraded session</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1351.1">Since we </span><a id="_idIndexMarker901"/><span class="koboSpan" id="kobo.1352.1">executed </span><strong class="source-inline"><span class="koboSpan" id="kobo.1353.1">sessions -i 2</span></strong><span class="koboSpan" id="kobo.1354.1">, we will be able to use and interact with the upgraded session (known as a Meterpreter session) and execute additional commands within it. </span><span class="koboSpan" id="kobo.1354.2">Compared to a “normal” shell, the </span><a id="_idIndexMarker902"/><span class="koboSpan" id="kobo.1355.1">Metasploit </span><strong class="bold"><span class="koboSpan" id="kobo.1356.1">Meterpreter</span></strong><span class="koboSpan" id="kobo.1357.1"> session offers a wider range of capabilities and features, including filesystem access, privilege escalation, process manipulation, pivoting, and more. </span><span class="koboSpan" id="kobo.1357.2">These enhancements over a normal shell allow for advanced post-exploitation activities such as lateral movement within the network, persistence on the compromised system, data exfiltration, and comprehensive reconnaissance. </span><span class="koboSpan" id="kobo.1357.3">With Meterpreter, penetration testers and ethical hackers have a more powerful toolset at their disposal that enables them to perform more thorough assessments and simulate real-world </span><span class="No-Break"><span class="koboSpan" id="kobo.1358.1">attack scenarios:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer185">
<span class="koboSpan" id="kobo.1359.1"><img alt="" src="image/B19755_06_029.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1360.1">Figure 6.29 – Two sessions connecting the attacker instance and the first target instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1361.1">Now, we have </span><a id="_idIndexMarker903"/><span class="koboSpan" id="kobo.1362.1">two sessions connecting the attacker instance and the first target instance (with one of the sessions being a </span><span class="No-Break"><span class="koboSpan" id="kobo.1363.1">Meterpreter session).</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1364.1">Let’s check the network configuration using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1365.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1366.1">ipconfig</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1367.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.1368.1">following output:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer186">
<span class="koboSpan" id="kobo.1369.1"><img alt="" src="image/B19755_06_030.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1370.1">Figure 6.30 – Results after running ipconfig</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1371.1">Given the</span><a id="_idIndexMarker904"/><span class="koboSpan" id="kobo.1372.1"> following configuration, we should be able to derive the </span><strong class="bold"><span class="koboSpan" id="kobo.1373.1">SUBNET</span></strong><span class="koboSpan" id="kobo.1374.1"> value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1375.1">10.0.1.0</span></strong><span class="koboSpan" id="kobo.1376.1"> (which we’ll use later when we configure the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1377.1">autoroute</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1378.1"> module).</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1379.1">Next, press </span><em class="italic"><span class="koboSpan" id="kobo.1380.1">Ctrl</span></em><span class="koboSpan" id="kobo.1381.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.1382.1">Z</span></em><span class="koboSpan" id="kobo.1383.1"> to run the session in background mode. </span><span class="koboSpan" id="kobo.1383.2">When prompted with </span><strong class="bold"><span class="koboSpan" id="kobo.1384.1">Background session 2? </span><span class="koboSpan" id="kobo.1384.2">[y/N]</span></strong><span class="koboSpan" id="kobo.1385.1">, enter </span><strong class="source-inline"><span class="koboSpan" id="kobo.1386.1">y</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1387.1">to proceed.</span></span></li>
<li><span class="koboSpan" id="kobo.1388.1">Run the following commands to search for, select, and use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1389.1">autoroute</span></strong><span class="koboSpan" id="kobo.1390.1"> module (one command at </span><span class="No-Break"><span class="koboSpan" id="kobo.1391.1">a time):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1392.1">search autoroute</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1393.1">use post/multi/manage/autoroute</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1394.1">Let’s quickly check the settings and options we have using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1395.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1396.1">show options</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1397.1">This should return a list of module options, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1398.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1399.1">.31</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1400.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer187">
<span class="koboSpan" id="kobo.1401.1"><img alt="" src="image/B19755_06_031.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1402.1">Figure 6.31 – Output after executing the show options command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1403.1">We will </span><a id="_idIndexMarker905"/><span class="koboSpan" id="kobo.1404.1">specify the configuration values for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1405.1">SESSION</span></strong><span class="koboSpan" id="kobo.1406.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1407.1">SUBNET</span></strong><span class="koboSpan" id="kobo.1408.1"> module </span><span class="No-Break"><span class="koboSpan" id="kobo.1409.1">options shortly.</span></span></p></li>
</ol>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1410.1">Configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1411.1">SESSION</span></strong><span class="koboSpan" id="kobo.1412.1"> setting and set it </span><span class="No-Break"><span class="koboSpan" id="kobo.1413.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1414.1">2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1415.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1416.1">set SESSION 2</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1417.1">Configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1418.1">SUBNET</span></strong><span class="koboSpan" id="kobo.1419.1"> setting and set it </span><span class="No-Break"><span class="koboSpan" id="kobo.1420.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1421.1">10.0.1.0/24</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1422.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1423.1">set SUBNET 10.0.1.0/24</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1424.1">Let’s quickly check the settings and options we have using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1425.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1426.1">show options</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1427.1">This should return a list of module options, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1428.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1429.1">.32</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1430.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer188">
<span class="koboSpan" id="kobo.1431.1"><img alt="" src="image/B19755_06_032.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1432.1">Figure 6.32 – Output after executing the show options command</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1433.1">Looks like</span><a id="_idIndexMarker906"/><span class="koboSpan" id="kobo.1434.1"> our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1435.1">post/multi/manage/autoroute</span></strong><span class="koboSpan" id="kobo.1436.1"> module configuration is ready </span><span class="No-Break"><span class="koboSpan" id="kobo.1437.1">to go!</span></span></p></li>
</ol>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1438.1">Now, let’s execute the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1439.1">autoroute</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1440.1"> module:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1441.1">run</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1442.1">This should yield the following set </span><span class="No-Break"><span class="koboSpan" id="kobo.1443.1">of logs:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer189">
<span class="koboSpan" id="kobo.1444.1"><img alt="" src="image/B19755_06_033.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1445.1">Figure 6.33 – Logs after running the autoroute module</span></p>
<p><span class="koboSpan" id="kobo.1446.1">Now that we have executed the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1447.1">autoroute</span></strong><span class="koboSpan" id="kobo.1448.1"> module, we should be able to pivot and reach other resources or networks that are accessible from the first target VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1449.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1450.1">target-vm-01</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1451.1">).</span></span></p>
<h2 id="_idParaDest-131"><a id="_idTextAnchor131"/><span class="koboSpan" id="kobo.1452.1">Part 3 of 3 – Obtaining the second flag</span></h2>
<p><span class="koboSpan" id="kobo.1453.1">Follow</span><a id="_idIndexMarker907"/> <span class="No-Break"><span class="koboSpan" id="kobo.1454.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1455.1">Run the following command to select and use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1456.1">auxiliary/scanner/portscan/tcp</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1457.1"> module:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1458.1">use auxiliary/scanner/portscan/tcp</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1459.1">This time, we will be scanning the second target instance for open ports, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1460.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1461.1">.34</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1462.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer190">
<span class="koboSpan" id="kobo.1463.1"><img alt="" src="image/B19755_06_034.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1464.1">Figure 6.34 – Using the TCP port scanner on the second target instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1465.1">Even if the attacker instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1466.1">vm-kali</span></strong><span class="koboSpan" id="kobo.1467.1">) does not have direct access to the second target EC2 instance, we should be able to run the TCP port scanner on the second target EC2 instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1468.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.1469.1">) </span><em class="italic"><span class="koboSpan" id="kobo.1470.1">through</span></em><span class="koboSpan" id="kobo.1471.1"> the first target EC2 instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1472.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.1473.1">). </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1474.1">Amazing, right?</span></em></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1475.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1476.1">Remember that only the traffic from the first target instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1477.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.1478.1">) is allowed by the security group of the second target instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1479.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.1480.1">). </span><span class="koboSpan" id="kobo.1480.2">This means that we won’t be able to </span><em class="italic"><span class="koboSpan" id="kobo.1481.1">directly</span></em><span class="koboSpan" id="kobo.1482.1"> scan the second target instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1483.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.1484.1">) from the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.1485.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1486.1">vm-kali</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1487.1">).</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1488.1">Configure</span><a id="_idIndexMarker908"/><span class="koboSpan" id="kobo.1489.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1490.1">RHOSTS</span></strong><span class="koboSpan" id="kobo.1491.1"> setting and set it to the private IP address of the second target VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1492.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1493.1">target-vm-02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1494.1">):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1495.1">set RHOSTS &lt;TARGET VM 02 PRIVATE IP&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1496.1">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1497.1">&lt;TARGET VM 02 PRIVATE IP&gt;</span></strong><span class="koboSpan" id="kobo.1498.1"> with the private IP address of the second target VM instance. </span><span class="koboSpan" id="kobo.1498.2">If you are wondering where you can get this value, it’s </span><em class="italic"><span class="koboSpan" id="kobo.1499.1">probably</span></em><span class="koboSpan" id="kobo.1500.1"> in the text editor on your local machine (after you copied the output values to the text editor after running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1501.1">terraform apply</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1502.1">command earlier).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1503.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1504.1">Be careful when specifying the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1505.1">RHOSTS</span></strong><span class="koboSpan" id="kobo.1506.1"> configuration value as we do not want to accidentally attack a random resource outside of our </span><span class="No-Break"><span class="koboSpan" id="kobo.1507.1">lab environment.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1508.1">Now, let’s use the following command to proceed with </span><span class="No-Break"><span class="koboSpan" id="kobo.1509.1">the scan:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1510.1">run</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1511.1">This should yield a set of logs, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1512.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1513.1">.35</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1514.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer191">
<span class="koboSpan" id="kobo.1515.1"><img alt="" src="image/B19755_06_035.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1516.1">Figure 6.35 – Results after running the scanner</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1517.1">After running the scanner, we can see that port </span><strong class="source-inline"><span class="koboSpan" id="kobo.1518.1">22</span></strong><span class="koboSpan" id="kobo.1519.1"> of the second target VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1520.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.1521.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.1522.1">is open.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1523.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1524.1">This step may take around 3-5 minutes </span><span class="No-Break"><span class="koboSpan" id="kobo.1525.1">to complete.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1526.1">Run the following command using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1527.1">auxiliary/scanner/ssh/ssh_login</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1528.1"> module:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1529.1">use auxiliary/scanner/ssh/ssh_login</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1530.1">Configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1531.1">RHOSTS</span></strong><span class="koboSpan" id="kobo.1532.1"> setting and set it to the private IP address of the second target VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1533.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1534.1">target-vm-02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1535.1">):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1536.1">set RHOSTS &lt;TARGET VM 02 PRIVATE IP&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1537.1">Make sure </span><a id="_idIndexMarker909"/><span class="koboSpan" id="kobo.1538.1">you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1539.1">&lt;TARGET VM 02 PRIVATE IP&gt;</span></strong><span class="koboSpan" id="kobo.1540.1"> with the private IP address of the second target VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1541.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1542.1">target-vm-02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1543.1">).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1544.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1545.1">Be careful when specifying the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1546.1">RHOSTS</span></strong><span class="koboSpan" id="kobo.1547.1"> configuration value as we do not want to accidentally attack a random resource outside of our </span><span class="No-Break"><span class="koboSpan" id="kobo.1548.1">lab environment.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1549.1">Next, let’s verify if we’ve set all the relevant options and </span><span class="No-Break"><span class="koboSpan" id="kobo.1550.1">configuration settings:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1551.1">show options</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1552.1">This should return a list of module options, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1553.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1554.1">.36</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1555.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer192">
<span class="koboSpan" id="kobo.1556.1"><img alt="" src="image/B19755_06_036.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1557.1">Figure 6.36 – show options</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1558.1">Given that</span><a id="_idIndexMarker910"/><span class="koboSpan" id="kobo.1559.1"> we have just set and updated the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1560.1">RHOSTS</span></strong><span class="koboSpan" id="kobo.1561.1"> value to the private IP address of the second VM instance, all relevant configuration settings have been set already (since we are reusing most of the previous configurations that we set when we first used </span><span class="No-Break"><span class="koboSpan" id="kobo.1562.1">the module).</span></span></p></li>
</ol>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1563.1">Now, let’s proceed with running the SSH login scanner on the second target EC2 </span><span class="No-Break"><span class="koboSpan" id="kobo.1564.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1565.1">target-vm-02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1566.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer193">
<span class="koboSpan" id="kobo.1567.1"><img alt="" src="image/B19755_06_037.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1568.1">Figure 6.37 – Using the SSH login scanner on the second target instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1569.1">Even if the</span><a id="_idIndexMarker911"/><span class="koboSpan" id="kobo.1570.1"> attacker instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1571.1">vm-kali</span></strong><span class="koboSpan" id="kobo.1572.1">) does not have direct access to the second target EC2 instance, we should be able to run the SSH login scanner on the second target EC2 instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1573.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.1574.1">) </span><em class="italic"><span class="koboSpan" id="kobo.1575.1">through</span></em><span class="koboSpan" id="kobo.1576.1"> the first target EC2 </span><span class="No-Break"><span class="koboSpan" id="kobo.1577.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1578.1">target-vm-01</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1579.1">).</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1580.1">Once you are ready to perform the scan, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.1581.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1582.1">run</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.1583.1">This will yield the following set </span><span class="No-Break"><span class="koboSpan" id="kobo.1584.1">of logs:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer194">
<span class="koboSpan" id="kobo.1585.1"><img alt="" src="image/B19755_06_038.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1586.1">Figure 6.38 – Logs after running the SSH login scanner on the second target instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1587.1">After trying</span><a id="_idIndexMarker912"/><span class="koboSpan" id="kobo.1588.1"> several username and password combinations, we can see that we were able to successfully authenticate using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1589.1">adminuser2</span></strong><span class="koboSpan" id="kobo.1590.1"> as the username and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1591.1">password</span></strong><span class="koboSpan" id="kobo.1592.1"> as </span><span class="No-Break"><span class="koboSpan" id="kobo.1593.1">the password!</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1594.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1595.1">This step may take around 3-5 minutes </span><span class="No-Break"><span class="koboSpan" id="kobo.1596.1">to complete.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.1597.1">List the existing sessions by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.1598.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1599.1">sessions</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1600.1">This should return three active sessions, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1601.1">Figure 6</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1602.1">.39</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1603.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer195">
<span class="koboSpan" id="kobo.1604.1"><img alt="" src="image/B19755_06_039.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1605.1">Figure 6.39 – List of active sessions</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1606.1">Here, we can see </span><a id="_idIndexMarker913"/><span class="koboSpan" id="kobo.1607.1">that we have a third active session, which allows us to access (and control) the second target </span><span class="No-Break"><span class="koboSpan" id="kobo.1608.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1609.1">vm-target-02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1610.1">):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer196">
<span class="koboSpan" id="kobo.1611.1"><img alt="" src="image/B19755_06_040.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1612.1">Figure 6.40 – A new session that accesses the second target instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1613.1">At this point, we have two sessions connecting the attacker instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1614.1">vm-kali</span></strong><span class="koboSpan" id="kobo.1615.1">) with the first target instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1616.1">target-vm-01</span></strong><span class="koboSpan" id="kobo.1617.1">) and one session connecting the first target instance with the second target </span><span class="No-Break"><span class="koboSpan" id="kobo.1618.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1619.1">target-vm-02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1620.1">).</span></span></p></li>
</ol>
<ol>
<li value="9"><span class="koboSpan" id="kobo.1621.1">Now, let’s access the second target instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1622.1">target-vm-02</span></strong><span class="koboSpan" id="kobo.1623.1">) using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1624.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1625.1">sessions -i 3</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1626.1">This will allow</span><a id="_idIndexMarker914"/><span class="koboSpan" id="kobo.1627.1"> us to interact with the session and </span><span class="No-Break"><span class="koboSpan" id="kobo.1628.1">execute commands.</span></span></p></li> <li><span class="koboSpan" id="kobo.1629.1">Run the following command to check the username of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1630.1">current user:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1631.1">whoami</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1632.1">This should yield </span><strong class="source-inline"><span class="koboSpan" id="kobo.1633.1">adminuser2</span></strong><span class="koboSpan" id="kobo.1634.1"> as the output, indicating that we are currently logged in as the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1635.1">adminuser2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1636.1"> user.</span></span></p></li> <li><span class="koboSpan" id="kobo.1637.1">Elevate privileges to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1638.1">root</span></strong><span class="koboSpan" id="kobo.1639.1"> by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.1640.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1641.1">sudo su</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1642.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1643.1">Looks like passwordless sudo has been configured for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1644.1">adminuser2</span></strong><span class="koboSpan" id="kobo.1645.1">! </span><span class="koboSpan" id="kobo.1645.2">If you are wondering how this was configured, simply locate and check the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1646.1">user_data</span></strong><span class="koboSpan" id="kobo.1647.1"> attribute of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1648.1">aws_instance</span></strong><span class="koboSpan" id="kobo.1649.1"> resource blocks in our Terraform configuration code (</span><span class="No-Break"><span class="koboSpan" id="kobo.1650.1">in CloudShell).</span></span></p>
<ol>
<li value="12"><span class="koboSpan" id="kobo.1651.1">Run the following command to check the username of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1652.1">current user:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1653.1">whoami</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1654.1">This should give us the </span><span class="No-Break"><span class="koboSpan" id="kobo.1655.1">following output:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer197">
<span class="koboSpan" id="kobo.1656.1"><img alt="" src="image/B19755_06_041.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1657.1">Figure 6.41 – Result after running the whoami command after sudo su</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1658.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1659.1">Figure 6</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1660.1">.41</span></em><span class="koboSpan" id="kobo.1661.1">, we can see that running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1662.1">whoami</span></strong><span class="koboSpan" id="kobo.1663.1"> command (after </span><strong class="source-inline"><span class="koboSpan" id="kobo.1664.1">sudo su</span></strong><span class="koboSpan" id="kobo.1665.1">) yields </span><strong class="source-inline"><span class="koboSpan" id="kobo.1666.1">root</span></strong><span class="koboSpan" id="kobo.1667.1"> as the output, indicating that we are currently logged in as the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1668.1">root</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1669.1"> user.</span></span></p></li>
</ol>
<ol>
<li value="13"><span class="koboSpan" id="kobo.1670.1">Let’s locate </span><a id="_idIndexMarker915"/><span class="koboSpan" id="kobo.1671.1">the second flag by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.1672.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1673.1">find / -type f -name "flag*"</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1674.1">This will search the entire filesystem for files starting with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1675.1">flag</span></strong><span class="koboSpan" id="kobo.1676.1">. </span><span class="koboSpan" id="kobo.1676.2">After a few minutes, we should get a list of results that includes a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1677.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1678.1">root/flag.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1679.1"> file:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1680.1">...
</span><span class="koboSpan" id="kobo.1680.2">/root/flag.txt
...</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1681.1">Looks like we found the </span><span class="No-Break"><span class="koboSpan" id="kobo.1682.1">flag file!</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1683.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1684.1">This step may take around 2-4 minutes </span><span class="No-Break"><span class="koboSpan" id="kobo.1685.1">to complete.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.1686.1">Now, let’s check the contents </span><span class="No-Break"><span class="koboSpan" id="kobo.1687.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1688.1">/root/flag.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1689.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1690.1">cat /root/flag.txt</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1691.1">This should give us </span><strong class="source-inline"><span class="koboSpan" id="kobo.1692.1">FLAG # </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1693.1">2!</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1694.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.1695.1">Next, press </span><em class="italic"><span class="koboSpan" id="kobo.1696.1">Ctrl</span></em><span class="koboSpan" id="kobo.1697.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.1698.1">Z</span></em><span class="koboSpan" id="kobo.1699.1"> to run the session in background mode. </span><span class="koboSpan" id="kobo.1699.2">When prompted with </span><strong class="bold"><span class="koboSpan" id="kobo.1700.1">Background session 3? </span><span class="koboSpan" id="kobo.1700.2">[y/N]</span></strong><span class="koboSpan" id="kobo.1701.1">, enter </span><strong class="source-inline"><span class="koboSpan" id="kobo.1702.1">y</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1703.1">to proceed.</span></span></li>
<li><span class="koboSpan" id="kobo.1704.1">Finally, let’s exit </span><strong class="source-inline"><span class="koboSpan" id="kobo.1705.1">msfconsole</span></strong><span class="koboSpan" id="kobo.1706.1"> using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1707.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1708.1">exit -y</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1709.1">That’s pretty much it! </span><span class="koboSpan" id="kobo.1709.2">At this point, we have completed the penetration </span><span class="No-Break"><span class="koboSpan" id="kobo.1710.1">testing simulation.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.1711.1">Right now, you </span><a id="_idIndexMarker916"/><span class="koboSpan" id="kobo.1712.1">are probably excited to try out other pivoting techniques! </span><span class="koboSpan" id="kobo.1712.2">Given that we have automated the setup process, we can simply run the following command to rebuild the </span><span class="No-Break"><span class="koboSpan" id="kobo.1713.1">target environment:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1714.1">terraform apply -replace=&lt;RESOURCE ADDRESS&gt; -auto-approve</span></strong></pre> <p><span class="koboSpan" id="kobo.1715.1">Running this command will destroy and recreate the resources identified by </span><strong class="source-inline"><span class="koboSpan" id="kobo.1716.1">&lt;RESOURCE ADDRESS&gt;</span></strong><span class="koboSpan" id="kobo.1717.1">, along with other resources related to or dependent on it. </span><span class="koboSpan" id="kobo.1717.2">Given that penetration testing activities may leave the infrastructure in an unstable or misconfigured state, rebuilding the infrastructure will return it to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1718.1">desired state.</span></span></p>
<h1 id="_idParaDest-132"><a id="_idTextAnchor132"/><span class="koboSpan" id="kobo.1719.1">Cleaning up</span></h1>
<p><span class="koboSpan" id="kobo.1720.1">Wait a minute... </span><span class="koboSpan" id="kobo.1720.2">we are</span><a id="_idIndexMarker917"/><span class="koboSpan" id="kobo.1721.1"> not done yet! </span><span class="koboSpan" id="kobo.1721.2">Cleaning up the cloud resources we created or deployed is a crucial step when working with penetration testing lab environments. </span><span class="koboSpan" id="kobo.1721.3">If we don’t clean up and delete the resources we created right away, we might end up paying for unused </span><span class="No-Break"><span class="koboSpan" id="kobo.1722.1">cloud resources.</span></span></p>
<p><span class="koboSpan" id="kobo.1723.1">At a minimum, we will be paying for the time the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1724.1">t3.medium</span></strong><span class="koboSpan" id="kobo.1725.1"> EC2 instance (for the attacker instance) and the two </span><strong class="source-inline"><span class="koboSpan" id="kobo.1726.1">t2.micro</span></strong><span class="koboSpan" id="kobo.1727.1"> EC2 instances (for the target instances) are running. </span><span class="koboSpan" id="kobo.1727.2">Note that there are other costs we should consider as well, including data transfer fees, storage costs for any persistent data used by the instances (such as EBS volumes attached to the EC2 instances), potential charges for additional AWS services utilized in the lab environment (for example, monitoring logs), and any applicable taxes or fees associated with </span><span class="No-Break"><span class="koboSpan" id="kobo.1728.1">AWS usage.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1729.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1730.1">Since the overall cost when running these resources depends on several parameters, it is best to refer to the pricing documentation page provided by the cloud platform: </span><a href="https://aws.amazon.com/ec2/pricing/on-demand/"><span class="koboSpan" id="kobo.1731.1">https://aws.amazon.com/ec2/pricing/on-demand/</span></a><span class="koboSpan" id="kobo.1732.1">. </span><span class="koboSpan" id="kobo.1732.2">You may also use the </span><strong class="bold"><span class="koboSpan" id="kobo.1733.1">AWS Pricing Calculator</span></strong><span class="koboSpan" id="kobo.1734.1"> to </span><a id="_idIndexMarker918"/><span class="koboSpan" id="kobo.1735.1">help you estimate the cost of running resources on AWS. </span><span class="koboSpan" id="kobo.1735.2">You can access the AWS Pricing Calculator </span><span class="No-Break"><span class="koboSpan" id="kobo.1736.1">here: </span></span><a href="https://calculator.aws/"><span class="No-Break"><span class="koboSpan" id="kobo.1737.1">https://calculator.aws/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1738.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1739.1">That being said, let’s </span><a id="_idIndexMarker919"/><span class="koboSpan" id="kobo.1740.1">proceed with deleting the resources we created in </span><span class="No-Break"><span class="koboSpan" id="kobo.1741.1">this chapter:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1742.1">In the AWS CloudShell Terminal, navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1743.1">~/pentest_lab</span></strong><span class="koboSpan" id="kobo.1744.1"> directory and then use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1745.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.1746.1"> to clean up the resources we </span><span class="No-Break"><span class="koboSpan" id="kobo.1747.1">created earlier:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1748.1">cd ~/pentest_lab</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1749.1">terraform destroy -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1750.1">Feel free to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1751.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.1752.1"> command a few times in case some resources fail to delete (or take a bit of time to delete). </span><span class="koboSpan" id="kobo.1752.2">Alternatively, you may delete resources manually using the user interface if all </span><span class="No-Break"><span class="koboSpan" id="kobo.1753.1">else fails.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1754.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1755.1">This step may take 10-15 minutes to complete. </span><span class="koboSpan" id="kobo.1755.2">Feel free to grab a snack </span><span class="No-Break"><span class="koboSpan" id="kobo.1756.1">while waiting!</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1757.1">Verify that the resources have been destroyed successfully using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1758.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1759.1">terraform show</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1760.1">This should return an empty response since all the resources should have been </span><span class="No-Break"><span class="koboSpan" id="kobo.1761.1">deleted successfully.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1762.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1763.1">Make sure you leverage </span><a id="_idIndexMarker920"/><span class="koboSpan" id="kobo.1764.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.1765.1">AWS Billing Dashboard</span></strong><span class="koboSpan" id="kobo.1766.1"> to conduct a comprehensive audit of your AWS account. </span><span class="koboSpan" id="kobo.1766.2">It offers features such as </span><strong class="bold"><span class="koboSpan" id="kobo.1767.1">Cost Explorer</span></strong><span class="koboSpan" id="kobo.1768.1"> for</span><a id="_idIndexMarker921"/><span class="koboSpan" id="kobo.1769.1"> visualizing spending patterns, detailed billing reports for service breakdowns, and budgeting tools with alerts to help users proactively manage expenses. </span><span class="koboSpan" id="kobo.1769.2">Using the different features of the AWS Billing Dashboard will help ensure that all resources have been properly deleted and minimize the risk of </span><span class="No-Break"><span class="koboSpan" id="kobo.1770.1">unintended costs.</span></span></p>
<p><span class="koboSpan" id="kobo.1771.1">That’s pretty much it! </span><span class="koboSpan" id="kobo.1771.2">At</span><a id="_idIndexMarker922"/><span class="koboSpan" id="kobo.1772.1"> this point, we should have a good idea of how to prepare penetration testing lab environments on AWS. </span><span class="koboSpan" id="kobo.1772.2">Feel free to tweak the Terraform configuration code and evolve the current lab environment setup so that you have more target resources and subnets (along with a more complex network </span><span class="No-Break"><span class="koboSpan" id="kobo.1773.1">configuration setup).</span></span></p>
<h1 id="_idParaDest-133"><a id="_idTextAnchor133"/><span class="koboSpan" id="kobo.1774.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1775.1">In this chapter, we discussed how to set up a pivoting lab on AWS where we can practice pivoting techniques. </span><span class="koboSpan" id="kobo.1775.2">We started by using Terraform to automatically build a simple environment with an attacker instance, along with two target instances. </span><span class="koboSpan" id="kobo.1775.3">We then tested the network connectivity and security of the lab to validate the network configuration specified in the Terraform code. </span><span class="koboSpan" id="kobo.1775.4">Lastly, we performed a penetration testing simulation to verify if the lab environment had been set </span><span class="No-Break"><span class="koboSpan" id="kobo.1776.1">up properly.</span></span></p>
<p><span class="koboSpan" id="kobo.1777.1">Now that we’ve finished this chapter, we will shift our focus to preparing an IAM privilege escalation lab environment in the next chapter. </span><span class="koboSpan" id="kobo.1777.2">If you are wondering how an IAM privilege escalation lab is (mis)configured, then the next chapter is </span><span class="No-Break"><span class="koboSpan" id="kobo.1778.1">for you!</span></span></p>
<h1 id="_idParaDest-134"><a id="_idTextAnchor134"/><span class="koboSpan" id="kobo.1779.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.1780.1">For additional information on the topics covered in this chapter, you may find the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1781.1">resources helpful:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.1782.1">Amazon Virtual Private Cloud – What is VPC </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1783.1">peering?</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1784.1"> (</span></span><a href="https://docs.aws.amazon.com/vpc/latest/peering/what-is-vpc-peering.html"><span class="No-Break"><span class="koboSpan" id="kobo.1785.1">https://docs.aws.amazon.com/vpc/latest/peering/what-is-vpc-peering.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1786.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1787.1">Amazon Virtual Private Cloud – What is Network Access </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1788.1">Analyzer?</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1789.1"> (</span></span><a href="https://docs.aws.amazon.com/vpc/latest/network-access-analyzer/what-is-network-access-analyzer.html"><span class="No-Break"><span class="koboSpan" id="kobo.1790.1">https://docs.aws.amazon.com/vpc/latest/network-access-analyzer/what-is-network-access-analyzer.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1791.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1792.1">New – VPC Reachability </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1793.1">Analyzer</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1794.1"> (</span></span><a href="https://aws.amazon.com/blogs/aws/new-vpc-insights-analyzes-reachability-and-visibility-in-vpcs/"><span class="No-Break"><span class="koboSpan" id="kobo.1795.1">https://aws.amazon.com/blogs/aws/new-vpc-insights-analyzes-reachability-and-visibility-in-vpcs/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1796.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1797.1">AWS Architecture Blog – Reduce Cost and Increase Security with Amazon VPC </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1798.1">Endpoints</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1799.1"> (</span></span><a href="https://aws.amazon.com/blogs/architecture/reduce-cost-and-increase-security-with-amazon-vpc-endpoints/"><span class="No-Break"><span class="koboSpan" id="kobo.1800.1">https://aws.amazon.com/blogs/architecture/reduce-cost-and-increase-security-with-amazon-vpc-endpoints/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1801.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1802.1">AWS Architecture Blog – One to Many: Evolving VPC </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1803.1">Design</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1804.1"> (</span></span><a href="https://aws.amazon.com/blogs/architecture/one-to-many-evolving-vpc-design/"><span class="No-Break"><span class="koboSpan" id="kobo.1805.1">https://aws.amazon.com/blogs/architecture/one-to-many-evolving-vpc-design/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1806.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1807.1">AWS re:Invent 2022 – Advanced VPC design and new Amazon VPC </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1808.1">capabilities</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1809.1"> (</span></span><a href="https://www.youtube.com/watch?v=cbUNbK8ZdA0"><span class="No-Break"><span class="koboSpan" id="kobo.1810.1">https://www.youtube.com/watch?v=cbUNbK8ZdA0</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1811.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1812.1">Upgrading shells to </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1813.1">Meterpreter</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1814.1"> (</span></span><a href="https://docs.metasploit.com/docs/pentesting/metasploit-guide-upgrading-shells-to-meterpreter.html"><span class="No-Break"><span class="koboSpan" id="kobo.1815.1">https://docs.metasploit.com/docs/pentesting/metasploit-guide-upgrading-shells-to-meterpreter.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1816.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1817.1">Pivoting in </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1818.1">Metasploit</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1819.1"> (</span></span><a href="https://docs.metasploit.com/docs/using-metasploit/intermediate/pivoting-in-metasploit.html"><span class="No-Break"><span class="koboSpan" id="kobo.1820.1">https://docs.metasploit.com/docs/using-metasploit/intermediate/pivoting-in-metasploit.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1821.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1822.1">Network </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1823.1">Segmentation</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1824.1"> (</span></span><a href="https://www.vmware.com/topics/glossary/content/network-segmentation.html"><span class="No-Break"><span class="koboSpan" id="kobo.1825.1">https://www.vmware.com/topics/glossary/content/network-segmentation.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1826.1">)</span></span></li>
</ul>
</div>


<div class="Content" id="_idContainer199">
<h1 id="_idParaDest-135" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor135"/><span class="koboSpan" id="kobo.1.1">Part 3:  Exploring Advanced Strategies and Best Practices in Lab Environment Design</span></h1>
<p><span class="koboSpan" id="kobo.2.1">In this part, you will explore the various strategies and best practices for building penetration testing lab environments in </span><span class="No-Break"><span class="koboSpan" id="kobo.3.1">the cloud.</span></span></p>
<p><span class="koboSpan" id="kobo.4.1">This part contains the </span><span class="No-Break"><span class="koboSpan" id="kobo.5.1">following chapters:</span></span></p>
<ul>
<li><em class="italic"><a href="B19755_07.xhtml"><span class="koboSpan" id="kobo.6.1">Chapter 7</span></a></em><span class="koboSpan" id="kobo.7.1">, </span><em class="italic"><span class="koboSpan" id="kobo.8.1">Setting Up</span></em><em class="italic"><span class="koboSpan" id="kobo.9.1"> an IAM Privilege Escalation Lab</span></em></li>
<li><em class="italic"><a href="B19755_08.xhtml"><span class="koboSpan" id="kobo.10.1">Chapter 8</span></a></em><span class="koboSpan" id="kobo.11.1">, </span><em class="italic"><span class="koboSpan" id="kobo.12.1">Designing and Building a Vulnerable Active Directory Lab</span></em></li>
<li><em class="italic"><a href="B19755_09.xhtml"><span class="koboSpan" id="kobo.13.1">Chapter 9</span></a></em><span class="koboSpan" id="kobo.14.1">, </span><em class="italic"><span class="koboSpan" id="kobo.15.1">Recommended Strategies and Best Practices</span></em></li>
</ul>
</div>
<div>
<div id="_idContainer200">
</div>
</div>
</body></html>