<html><head></head><body>
<div id="_idContainer339">
<h1 class="chapter-number" id="_idParaDest-164"><a id="_idTextAnchor164"/><span class="koboSpan" id="kobo.1.1">8</span></h1>
<h1 id="_idParaDest-165"><a id="_idTextAnchor165"/><span class="koboSpan" id="kobo.2.1">Designing and Building a Vulnerable Active Directory Lab</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Organizations around the world rely on </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">Active Directory</span></strong><span class="koboSpan" id="kobo.5.1"> to centralize the management of network </span><a id="_idIndexMarker1097"/><span class="koboSpan" id="kobo.6.1">resources and user accounts. </span><span class="koboSpan" id="kobo.6.2">Its widespread adoption and usage globally make it a common target for attackers seeking to compromise large-scale networks. </span><span class="koboSpan" id="kobo.6.3">In response to evolving attacks, setting up penetration testing lab environments that mimic real-world implementations can help organizations simulate various types of attacks and strengthen their security measures to keep their network resources and </span><span class="No-Break"><span class="koboSpan" id="kobo.7.1">data safe.</span></span></p>
<p><span class="koboSpan" id="kobo.8.1">In this chapter, we will set up and configure an Active Directory lab inside an isolated network environment in Microsoft Azure. </span><span class="koboSpan" id="kobo.8.2">In this lab setup, we will have various security misconfigurations along with deliberately weak configurations present in actual Active Directory implementations. </span><span class="koboSpan" id="kobo.8.3">Once the lab environment is ready, we will perform a penetration testing simulation to validate our lab </span><span class="No-Break"><span class="koboSpan" id="kobo.9.1">setup configuration.</span></span></p>
<p><span class="koboSpan" id="kobo.10.1">We will cover the following topics in </span><span class="No-Break"><span class="koboSpan" id="kobo.11.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.12.1">Preparing the necessary components </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1">and prerequisites</span></span></li>
<li><span class="koboSpan" id="kobo.14.1">Launching the target </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">VM instances</span></span></li>
<li><span class="koboSpan" id="kobo.16.1">Setting up and configuring the Active </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">Directory lab</span></span></li>
<li><span class="koboSpan" id="kobo.18.1">Simulating penetration testing in the </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">lab environment</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.20.1">Cleaning up</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.21.1">With these in mind, </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">let’s begin!</span></span></p>
<h1 id="_idParaDest-166"><a id="_idTextAnchor166"/><span class="koboSpan" id="kobo.23.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.24.1">Before we start, we must have the </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">following ready:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.26.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.27.1">Microsoft Azure</span></strong><span class="koboSpan" id="kobo.28.1"> account</span><a id="_idIndexMarker1098"/><span class="koboSpan" id="kobo.29.1"> we used in </span><span class="No-Break"><em class="italic"><a href="B19755_05.xhtml"><span class="koboSpan" id="kobo.30.1">Chapter 5</span></a></em></span><span class="koboSpan" id="kobo.31.1">, </span><em class="italic"><span class="koboSpan" id="kobo.32.1">Setting Up Isolated Penetration Testing Lab Environments </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.33.1">on Azure</span></em></span></li>
<li><span class="koboSpan" id="kobo.34.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.35.1">Microsoft Remote Desktop</span></strong><span class="koboSpan" id="kobo.36.1"> application</span><a id="_idIndexMarker1099"/><span class="koboSpan" id="kobo.37.1"> installed on your </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">local machine</span></span></li>
<li><span class="koboSpan" id="kobo.39.1">The golden image of the Kali Linux VM instance created in the </span><em class="italic"><span class="koboSpan" id="kobo.40.1">Leveraging Terraform to automatically set up the attacker VM instance</span></em><span class="koboSpan" id="kobo.41.1"> section of </span><span class="No-Break"><em class="italic"><a href="B19755_05.xhtml"><span class="koboSpan" id="kobo.42.1">Chapter 5</span></a></em></span><span class="koboSpan" id="kobo.43.1">, </span><em class="italic"><span class="koboSpan" id="kobo.44.1">Setting Up Isolated Penetration Testing Lab Environments </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.45.1">on Azure</span></em></span></li>
<li><span class="koboSpan" id="kobo.46.1">Any text editor (such as Notepad++, Visual Studio Code, or Sublime Text) where we can temporarily store specific values (for example, your local machine’s IP address) that will be used in the hands-on solutions in </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">this chapter</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.48.1">You may proceed with the next steps once these requirements </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">are</span></span><span class="No-Break"><span class="koboSpan" id="kobo.50.1"> ready.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.51.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.52.1">Make sure that you have worked on the hands-on solutions of </span><span class="No-Break"><em class="italic"><a href="B19755_05.xhtml"><span class="koboSpan" id="kobo.53.1">Chapter 5</span></a></em></span><span class="koboSpan" id="kobo.54.1"> before proceeding. </span><span class="koboSpan" id="kobo.54.2">This chapter assumes that we have already created the golden VM image of the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.55.1">VM instance.</span></span></p>
<p><span class="koboSpan" id="kobo.56.1">The source code and other files for each chapter are available in this book’s GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">repository: </span></span><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud"><span class="No-Break"><span class="koboSpan" id="kobo.58.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.59.1">.</span></span></p>
<h1 id="_idParaDest-167"><a id="_idTextAnchor167"/><span class="koboSpan" id="kobo.60.1">Preparing the necessary components and prerequisites</span></h1>
<p><span class="koboSpan" id="kobo.61.1">In this section, we will set up the isolated network environment where the target resources will be launched. </span><span class="koboSpan" id="kobo.61.2">This will ensure that vulnerable and misconfigured resources and services can only be accessed by trusted machines – our local machine and the </span><span class="No-Break"><span class="koboSpan" id="kobo.62.1">attacker’s machine:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer259">
<span class="koboSpan" id="kobo.63.1"><img alt="" src="image/B19755_08_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.64.1">Figure 8.1 — Preparing the prerequisites</span></p>
<p><span class="koboSpan" id="kobo.65.1">We will also generate the SSH keys (the public key and the private key) for accessing the attacker VM instance later in this chapter. </span><span class="koboSpan" id="kobo.65.2">As shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.66.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.67.1">.1</span></em><span class="koboSpan" id="kobo.68.1">, the private key will be stored inside your local machine while the public key will be stored inside the attacker VM instance. </span><span class="koboSpan" id="kobo.68.2">With this setup, the server (the attacker VM instance) can confirm the identity of the client (your local machine) using the private key. </span><span class="koboSpan" id="kobo.68.3">This will allow us to access the attacker VM instance via SSH and run commands remotely. </span><span class="koboSpan" id="kobo.68.4">In addition to this, we will make sure that the attacker VM instance is ready so that we can focus on setting up and validating the configuration of our vulnerable Active Directory lab in the succeeding sections of </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.70.1">That said, we’ll divide this section into </span><span class="No-Break"><span class="koboSpan" id="kobo.71.1">three parts:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.72.1">Part 1 of 3 – Generating SSH keys to access the attacker </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.73.1">VM instance</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.74.1">Part 2 of 3 – Setting up the lab network environment </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.75.1">with Terraform</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.76.1">Part 3 of 3 – Accessing the attacker </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.77.1">VM instance</span></em></span></li>
</ul>
<p><span class="koboSpan" id="kobo.78.1">Let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.79.1">get started.</span></span></p>
<h2 id="_idParaDest-168"><a id="_idTextAnchor168"/><span class="koboSpan" id="kobo.80.1">Part 1 of 3 – Generating SSH keys to access the attacker VM instance</span></h2>
<p><span class="koboSpan" id="kobo.81.1">Let’s start by generating the </span><a id="_idIndexMarker1100"/><span class="koboSpan" id="kobo.82.1">SSH keys for accessing the attacker VM instance later in </span><span class="No-Break"><span class="koboSpan" id="kobo.83.1">this chapter:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.84.1">Open the </span><strong class="bold"><span class="koboSpan" id="kobo.85.1">Cloud Shell</span></strong><span class="koboSpan" id="kobo.86.1"> editor by clicking the button highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.87.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.88.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.89.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer260">
<span class="koboSpan" id="kobo.90.1"><img alt="" src="image/B19755_08_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.91.1">Figure 8.2 – Opening Cloud Shell</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.92.1">This will open a terminal where we can run </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">bash commands.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.94.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.95.1">In rare cases where Cloud Shell fails to mount the Azure file share (that is, you received a warning stating </span><strong class="bold"><span class="koboSpan" id="kobo.96.1">Failed to mount the Azure file share. </span><span class="koboSpan" id="kobo.96.2">Your cloud drive won’t be available</span></strong><span class="koboSpan" id="kobo.97.1">), simply restart Cloud Shell (and check if that fixes </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">the issue).</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.99.1">In the Terminal (right after the </span><strong class="bold"><span class="koboSpan" id="kobo.100.1">$</span></strong><span class="koboSpan" id="kobo.101.1"> sign), run the following commands to create a new directory (named </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">kali_keys_ad</span></strong><span class="koboSpan" id="kobo.103.1">) and navigate </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">to it:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.105.1">cd ~</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.106.1">mkdir kali_keys_ad &amp;&amp; cd kali_keys_ad</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.107.1">We will store the generated keys inside </span><span class="No-Break"><span class="koboSpan" id="kobo.108.1">this directory.</span></span></p></li> <li><span class="koboSpan" id="kobo.109.1">Generate a </span><a id="_idIndexMarker1101"/><span class="koboSpan" id="kobo.110.1">new SSH key pair and save the generated key files in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">kali_keys_ad</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.112.1"> directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.113.1">ssh-keygen -t rsa -C kali -f ./kali-ad-lab-ssh</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.114.1">When asked for a passphrase, just press </span><em class="italic"><span class="koboSpan" id="kobo.115.1">Enter</span></em><span class="koboSpan" id="kobo.116.1">. </span><span class="koboSpan" id="kobo.116.2">This will generate two files – </span><strong class="source-inline"><span class="koboSpan" id="kobo.117.1">kali-ad-lab-ssh</span></strong><span class="koboSpan" id="kobo.118.1"> (the private key) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.119.1">kali-ad-lab-ssh.pub</span></strong><span class="koboSpan" id="kobo.120.1"> (the </span><span class="No-Break"><span class="koboSpan" id="kobo.121.1">public key).</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.122.1">Note</span></p>
<p class="callout"><em class="italic"><span class="koboSpan" id="kobo.123.1">How do these SSH key files work?</span></em><span class="koboSpan" id="kobo.124.1"> SSH key </span><a id="_idIndexMarker1102"/><span class="koboSpan" id="kobo.125.1">files consist of a </span><strong class="bold"><span class="koboSpan" id="kobo.126.1">private key</span></strong><span class="koboSpan" id="kobo.127.1"> (stored and kept on the client’s machine) and a</span><a id="_idIndexMarker1103"/><span class="koboSpan" id="kobo.128.1"> corresponding </span><strong class="bold"><span class="koboSpan" id="kobo.129.1">public key</span></strong><span class="koboSpan" id="kobo.130.1"> that’s uploaded to the remote server. </span><span class="koboSpan" id="kobo.130.2">During authentication, the client uses its private key to generate a digital signature, and the server verifies it using the corresponding public key. </span><span class="koboSpan" id="kobo.130.3">Here, the server can confirm the client’s identity based on their possession of the private key without having to transmit </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">sensitive credentials.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.132.1">Print the public key value using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">cat</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.134.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.135.1">cat kali-ad-lab-ssh.pub</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.136.1">Store this value in a text editor on your local machine as we will use this later in the succeeding sections of </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">this chapter.</span></span></p></li> <li><span class="koboSpan" id="kobo.138.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.139.1">Upload/Download files</span></strong><span class="koboSpan" id="kobo.140.1"> button, as highlighted in the top-left corner of </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.141.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.142.1">.3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer261">
<span class="koboSpan" id="kobo.144.1"><img alt="" src="image/B19755_08_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.145.1">Figure 8.3 — Downloading the private key we generated</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.146.1">Select </span><a id="_idIndexMarker1104"/><span class="koboSpan" id="kobo.147.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.148.1">Download</span></strong><span class="koboSpan" id="kobo.149.1"> option from the list of options available. </span><span class="koboSpan" id="kobo.149.2">When you see the </span><strong class="bold"><span class="koboSpan" id="kobo.150.1">Download a file</span></strong><span class="koboSpan" id="kobo.151.1"> pop-up window, type </span><strong class="source-inline"><span class="koboSpan" id="kobo.152.1">/kali_keys_ad/kali-ad-lab-ssh</span></strong><span class="koboSpan" id="kobo.153.1"> in the input field highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.154.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.155.1">.3</span></em><span class="koboSpan" id="kobo.156.1"> and then </span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.158.1">Download</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">.</span></span></p></li>
</ol>
<ol>
<li value="6"><span class="koboSpan" id="kobo.160.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.161.1">Click here to download your file</span></strong><span class="koboSpan" id="kobo.162.1"> link to proceed with the actual download operation. </span><span class="koboSpan" id="kobo.162.2">This will download the </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">kali-ad-lab-ssh</span></strong><span class="koboSpan" id="kobo.164.1"> key file from the Cloud Shell </span><a id="_idIndexMarker1105"/><span class="koboSpan" id="kobo.165.1">environment to your </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">local machine.</span></span></li>
</ol>
<h2 id="_idParaDest-169"><a id="_idTextAnchor169"/><span class="koboSpan" id="kobo.167.1">Part 2 of 3 – Setting up the lab network environment with Terraform</span></h2>
<p><span class="koboSpan" id="kobo.168.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.169.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.170.1">In the </span><a id="_idIndexMarker1106"/><span class="koboSpan" id="kobo.171.1">Cloud Shell Terminal (right after the </span><strong class="bold"><span class="koboSpan" id="kobo.172.1">$</span></strong><span class="koboSpan" id="kobo.173.1"> sign), run the</span><a id="_idIndexMarker1107"/><span class="koboSpan" id="kobo.174.1"> following commands to create a new directory (named </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">ch8_environment</span></strong><span class="koboSpan" id="kobo.176.1">) and navigate </span><span class="No-Break"><span class="koboSpan" id="kobo.177.1">to it:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.178.1">cd ~</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.179.1">mkdir ch8_environment &amp;&amp; cd ch8_environment</span></strong></pre></li> <li><span class="koboSpan" id="kobo.180.1">Download </span><a id="_idIndexMarker1108"/><span class="koboSpan" id="kobo.181.1">the ZIP file containing</span><a id="_idIndexMarker1109"/><span class="koboSpan" id="kobo.182.1"> the Terraform configuration files for this chapter’s </span><span class="No-Break"><span class="koboSpan" id="kobo.183.1">lab environment:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.184.1">DOWNLOAD_URL=</span></strong><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/raw/main/ch08/ad_lab_environment.zip"><strong class="bold"><span class="koboSpan" id="kobo.185.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/raw/main/ch08/ad_lab_environment.zip</span></strong></a>
<strong class="bold"><span class="koboSpan" id="kobo.186.1">wget $DOWNLOAD_URL</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.187.1">This will download the </span><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">ad_lab_environment.zip</span></strong><span class="koboSpan" id="kobo.189.1"> file to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">ch8_environment</span></strong><span class="koboSpan" id="kobo.191.1"> directory. </span><span class="koboSpan" id="kobo.191.2">Make sure that the download link specified is correct (no spaces) and pointing to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.192.1">ad_lab_environment.zip</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.193.1"> file.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.194.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.195.1">You can find the ZIP file containing the Terraform configuration files in this book’s GitHub repository </span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">at </span></span><a href="https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/tree/main/ch08"><span class="No-Break"><span class="koboSpan" id="kobo.197.1">https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/tree/main/ch08</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.198.1">.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.199.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.200.1">unzip</span></strong><span class="koboSpan" id="kobo.201.1"> command to extract the contents of the ZIP file </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">you downloaded:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.203.1">unzip ad_lab_environment.zip</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.204.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">following logs:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.206.1">Archive:  ad_lab_environment.zip
   creating: attacker_vm/
  inflating: attacker_vm/outputs.tf
  inflating: attacker_vm/variables.tf
  inflating: attacker_vm/main.tf
  inflating: main.tf
  inflating: outputs.tf
 extracting: provider.tf
   creating: secure_network/
  inflating: secure_network/outputs.tf
 extracting: secure_network/variables.tf
  inflating: secure_network/main.tf
  inflating: terraform.tfvars
  inflating: variables.tf
  inflating: versions.tf</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.207.1">Here, we</span><a id="_idIndexMarker1110"/><span class="koboSpan" id="kobo.208.1"> can see the files that</span><a id="_idIndexMarker1111"/><span class="koboSpan" id="kobo.209.1"> were extracted from the ZIP file we </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">just downloaded.</span></span></p></li> <li><span class="koboSpan" id="kobo.211.1">Now that we have extracted the files from the ZIP file, we can delete the ZIP file </span><span class="No-Break"><span class="koboSpan" id="kobo.212.1">as well:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.213.1">rm ad_lab_environment.zip</span></strong></pre></li> <li><span class="koboSpan" id="kobo.214.1">Open the editor by clicking the button highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.215.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.216.1">.4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.217.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer262">
<span class="koboSpan" id="kobo.218.1"><img alt="" src="image/B19755_08_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.219.1">Figure 8.4 — Opening the Cloud Shell editor</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.220.1">This should open a file tree, along with an editor where we can modify the code of our </span><span class="No-Break"><span class="koboSpan" id="kobo.221.1">files directly.</span></span></p></li>
</ol>
<ol>
<li value="6"><span class="koboSpan" id="kobo.222.1">Open </span><a id="_idIndexMarker1112"/><span class="koboSpan" id="kobo.223.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.224.1">ch8_environment/terraform.tfvars</span></strong><span class="koboSpan" id="kobo.225.1"> file in the editor by clicking on the file from the </span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">file </span></span><span class="No-Break"><a id="_idIndexMarker1113"/></span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">tree:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.228.1">
my_ip = "</span><strong class="bold"><span class="koboSpan" id="kobo.229.1">&lt;IP ADDRESS&gt;</span></strong><span class="koboSpan" id="kobo.230.1">"
kali_image_id = "</span><strong class="bold"><span class="koboSpan" id="kobo.231.1">&lt;KALI IMAGE ID&gt;</span></strong><span class="koboSpan" id="kobo.232.1">"
my_public_ssh_key = "</span><strong class="bold"><span class="koboSpan" id="kobo.233.1">&lt;PUBLIC SSH KEY&gt;</span></strong><span class="koboSpan" id="kobo.234.1">"</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.235.1">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">&lt;IP ADDRESS&gt;</span></strong><span class="koboSpan" id="kobo.237.1"> with the IP address of your local machine and </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">&lt;PUBLIC SSH KEY&gt;</span></strong><span class="koboSpan" id="kobo.239.1"> with the string value of the public SSH key (which we printed using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">cat</span></strong><span class="koboSpan" id="kobo.241.1"> command earlier). </span><span class="koboSpan" id="kobo.241.2">Update </span><strong class="source-inline"><span class="koboSpan" id="kobo.242.1">&lt;KALI IMAGE ID&gt;</span></strong><span class="koboSpan" id="kobo.243.1"> with the resource ID of the golden image we created in </span><span class="No-Break"><em class="italic"><a href="B19755_05.xhtml"><span class="koboSpan" id="kobo.244.1">Chapter 5</span></a></em></span><span class="koboSpan" id="kobo.245.1">, </span><em class="italic"><span class="koboSpan" id="kobo.246.1">Setting Up Isolated Penetration Testing Lab Environments on Azure</span></em><span class="koboSpan" id="kobo.247.1">. </span><span class="koboSpan" id="kobo.247.2">If you are wondering what this value looks like, the value for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.248.1">"&lt;KALI IMAGE ID&gt;</span></strong><span class="koboSpan" id="kobo.249.1">” placeholder should have a format similar to </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">the following:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.251.1">/subscriptions/.../resourcegroups/image-resource-group/providers/Microsoft.Compute/galleries/kali_gallery/images/golden-image/versions/1.0.0</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.252.1">Make sure you save the changes you’ve made to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">ch8_environment/terraform.tfvars</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.254.1"> file.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.255.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.256.1">If you are looking for the value for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">&lt;KALI IMAGE ID&gt;</span></strong><span class="koboSpan" id="kobo.258.1"> placeholder, type </span><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">1.0.0</span></strong><span class="koboSpan" id="kobo.260.1"> in the search bar and select </span><strong class="bold"><span class="koboSpan" id="kobo.261.1">VM image version 1.0.0</span></strong><span class="koboSpan" id="kobo.262.1"> from the list of resources returned in the search results. </span><span class="koboSpan" id="kobo.262.2">On the details page (the </span><strong class="bold"><span class="koboSpan" id="kobo.263.1">Overview</span></strong><span class="koboSpan" id="kobo.264.1"> blade) of </span><strong class="bold"><span class="koboSpan" id="kobo.265.1">1.0.0 (gallery/kali_image/1.0.0) VM image version</span></strong><span class="koboSpan" id="kobo.266.1">, click the </span><strong class="bold"><span class="koboSpan" id="kobo.267.1">JSON View</span></strong><span class="koboSpan" id="kobo.268.1"> link and then copy the </span><strong class="bold"><span class="koboSpan" id="kobo.269.1">Resource ID</span></strong><span class="koboSpan" id="kobo.270.1"> value from the </span><strong class="bold"><span class="koboSpan" id="kobo.271.1">Resource </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.272.1">JSON</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.273.1"> page.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.274.1">Let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">terraform init</span></strong><span class="koboSpan" id="kobo.276.1"> command to initialize the Terraform </span><span class="No-Break"><span class="koboSpan" id="kobo.277.1">working directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.278.1">terraform init</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.279.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.280.1">Note that we are using Terraform version </span><strong class="source-inline"><span class="koboSpan" id="kobo.281.1">v1.3.X</span></strong><span class="koboSpan" id="kobo.282.1"> for the hands-on solutions in this chapter since this is the version that’s been configured in our Cloud Shell environment (as of this writing). </span><span class="koboSpan" id="kobo.282.2">If your Terraform version is higher, you may set up and use a lower version (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.283.1">v1.3.2</span></strong><span class="koboSpan" id="kobo.284.1">) in case you encounter issues running the </span><span class="No-Break"><span class="koboSpan" id="kobo.285.1">Terraform commands.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.286.1">Let’s </span><a id="_idIndexMarker1114"/><span class="koboSpan" id="kobo.287.1">run </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">terraform plan</span></strong><span class="koboSpan" id="kobo.289.1"> to preview</span><a id="_idIndexMarker1115"/><span class="koboSpan" id="kobo.290.1"> the changes to be performed </span><span class="No-Break"><span class="koboSpan" id="kobo.291.1">by Terraform:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.292.1">terraform plan</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.293.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.294.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.295.1">...
</span><span class="koboSpan" id="kobo.295.2">Plan: 20 to add, 0 to change, 0 to destroy.
</span><span class="koboSpan" id="kobo.295.3">...</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.296.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.297.1">Running this command may yield a few deprecation warnings. </span><span class="koboSpan" id="kobo.297.2">This should be okay, so long as we can successfully run the command </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">without errors.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.299.1">Next, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.300.1">terraform apply</span></strong><span class="koboSpan" id="kobo.301.1"> command to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">the changes:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.303.1">terraform apply -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.304.1">This should return the </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.306.1">...
</span><span class="koboSpan" id="kobo.306.2">Apply complete! </span><span class="koboSpan" id="kobo.306.3">Resources: 20 added, 0 changed, 0 destroyed.
</span><span class="koboSpan" id="kobo.306.4">Outputs:
vm_kali_private_ip = "..."
</span><span class="koboSpan" id="kobo.306.5">vm_kali_public_ip = "..."</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.307.1">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">terraform apply</span></strong><span class="koboSpan" id="kobo.309.1"> command runs without any errors, we should have the following </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">environment setup:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer263">
<span class="koboSpan" id="kobo.311.1"><img alt="" src="image/B19755_08_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.312.1">Figure 8.5 — VNet peering setup</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.313.1">Here, we</span><a id="_idIndexMarker1116"/><span class="koboSpan" id="kobo.314.1"> have a </span><strong class="bold"><span class="koboSpan" id="kobo.315.1">VNet peering</span></strong><span class="koboSpan" id="kobo.316.1"> setup</span><a id="_idIndexMarker1117"/><span class="koboSpan" id="kobo.317.1"> similar to what we </span><a id="_idIndexMarker1118"/><span class="koboSpan" id="kobo.318.1">configured in </span><span class="No-Break"><em class="italic"><a href="B19755_05.xhtml"><span class="koboSpan" id="kobo.319.1">Chapter 5</span></a></em></span><span class="koboSpan" id="kobo.320.1">, </span><em class="italic"><span class="koboSpan" id="kobo.321.1">Setting Up Isolated Penetration Testing Lab Environments on Azure</span></em><span class="koboSpan" id="kobo.322.1">. </span><span class="koboSpan" id="kobo.322.2">In addition to the network environment, we should also have the attacker VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">vm-kali</span></strong><span class="koboSpan" id="kobo.324.1">) set up </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">as well.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.326.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.327.1">This step may take around 10 to 15 minutes to complete. </span><span class="koboSpan" id="kobo.327.2">Feel free to grab a cup of coffee or tea while waiting! </span><span class="koboSpan" id="kobo.327.3">Note that it may take a few minutes for the attacker VM instance to be ready (after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">terraform apply</span></strong><span class="koboSpan" id="kobo.329.1"> command has </span><span class="No-Break"><span class="koboSpan" id="kobo.330.1">finished running).</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.331.1">Verify that</span><a id="_idIndexMarker1119"/><span class="koboSpan" id="kobo.332.1"> the resources have </span><a id="_idIndexMarker1120"/><span class="koboSpan" id="kobo.333.1">been created successfully using the </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.335.1">terraform show</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.336.1">This should return the resources that were created, along with the </span><span class="No-Break"><span class="koboSpan" id="kobo.337.1">following outputs:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.338.1">Outputs:
vm_kali_private_ip = "&lt;VM KALI PRIVATE IP&gt;"
vm_kali_public_ip = "</span><strong class="bold"><span class="koboSpan" id="kobo.339.1">&lt;VM KALI PUBLIC IP&gt;</span></strong><span class="koboSpan" id="kobo.340.1">"</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.341.1">Take note </span><a id="_idIndexMarker1121"/><span class="koboSpan" id="kobo.342.1">of the value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.343.1">&lt;VM KALI PUBLIC IP&gt;</span></strong><span class="koboSpan" id="kobo.344.1"> as </span><a id="_idIndexMarker1122"/><span class="koboSpan" id="kobo.345.1">we will use this value in the succeeding set </span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">of steps.</span></span></p></li> </ol>
<h2 id="_idParaDest-170"><a id="_idTextAnchor170"/><span class="koboSpan" id="kobo.347.1">Part 3 of 3 – Accessing the attacker VM instance</span></h2>
<p><span class="koboSpan" id="kobo.348.1">Now, let’s access the </span><a id="_idIndexMarker1123"/><span class="koboSpan" id="kobo.349.1">desktop environment of the attacker machine remotely from </span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">the browser:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.351.1">Open a new browser tab and access the web-based </span><strong class="bold"><span class="koboSpan" id="kobo.352.1">noVNC</span></strong><span class="koboSpan" id="kobo.353.1"> client</span><a id="_idIndexMarker1124"/><span class="koboSpan" id="kobo.354.1"> using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">http://&lt;VM KALI PUBLIC IP&gt;:8081/vnc.html</span></strong><span class="koboSpan" id="kobo.356.1"> URL. </span><span class="koboSpan" id="kobo.356.2">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.357.1">&lt;VM KALI PUBLIC IP&gt;</span></strong><span class="koboSpan" id="kobo.358.1"> with the </span><strong class="bold"><span class="koboSpan" id="kobo.359.1">Public IP address</span></strong><span class="koboSpan" id="kobo.360.1"> value you copied to the </span><span class="No-Break"><span class="koboSpan" id="kobo.361.1">clipboard earlier:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer264">
<span class="koboSpan" id="kobo.362.1"><img alt="" src="image/B19755_08_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.363.1">Figure 8.6 — noVNC welcome screen</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.364.1">This should </span><a id="_idIndexMarker1125"/><span class="koboSpan" id="kobo.365.1">open a welcome screen with a </span><strong class="bold"><span class="koboSpan" id="kobo.366.1">Connect</span></strong><span class="koboSpan" id="kobo.367.1"> button, similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.368.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.369.1">.6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.370.1">.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.371.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.372.1">If you find yourself unable to access the welcome screen, your IP address might have changed already. </span><span class="koboSpan" id="kobo.372.2">Simply open the Cloud Shell editor and update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.374.1"> file. </span><span class="koboSpan" id="kobo.374.2">Once the </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">terraform.tfvars</span></strong><span class="koboSpan" id="kobo.376.1"> file has been updated with the new IP address of your local machine, run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">terraform apply</span></strong><span class="koboSpan" id="kobo.378.1"> command again to update the firewall rule to whitelist your new </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">IP address.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.380.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.381.1">Connect</span></strong><span class="koboSpan" id="kobo.382.1"> button and then use </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">kali123</span></strong><span class="koboSpan" id="kobo.384.1"> as the password (or use the password you specified in </span><span class="No-Break"><em class="italic"><a href="B19755_05.xhtml"><span class="koboSpan" id="kobo.385.1">Chapter 5</span></a></em></span><span class="koboSpan" id="kobo.386.1"> when setting up the Kali Linux attacker machine) to access the </span><span class="No-Break"><span class="koboSpan" id="kobo.387.1">desktop environment:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer265">
<span class="koboSpan" id="kobo.388.1"><img alt="" src="image/B19755_04_32.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.389.1">Figure 8.7 — Accessing the Kali Linux desktop/GUI environment in the browser</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.390.1">We will use this</span><a id="_idIndexMarker1126"/><span class="koboSpan" id="kobo.391.1"> desktop/GUI environment in this chapter. </span><span class="koboSpan" id="kobo.391.2">Feel free to open the Terminal (inside the desktop environment of the attacker machine) and run </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">ifconfig</span></strong><span class="koboSpan" id="kobo.393.1"> to confirm that the Kali Linux VM instance has been launched in </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">vnet-02</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.395.1"> (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">192.168.0.0/16</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.397.1">).</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.398.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.399.1">Note that you may also access the attacker Kali Linux server directly from your local machine using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.400.1">ssh -i kali-ad-lab-ssh kali_admin@&lt;VM KALI PUBLIC IP&gt;</span></strong><span class="koboSpan" id="kobo.401.1"> command (that is, after running </span><strong class="source-inline"><span class="koboSpan" id="kobo.402.1">chmod </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.403.1">400 kali-ad-lab-ssh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.404.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.405.1">At this point, we have set up the isolated network environment and the attacker VM instance in just a few steps! </span><span class="koboSpan" id="kobo.405.2">Now, let’s proceed with launching the target </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">VM instances.</span></span></p>
<h1 id="_idParaDest-171"><a id="_idTextAnchor171"/><span class="koboSpan" id="kobo.407.1">Launching the target VM instances</span></h1>
<p><span class="koboSpan" id="kobo.408.1">In this section, we will</span><a id="_idIndexMarker1127"/><span class="koboSpan" id="kobo.409.1"> launch two Windows VM instances for the target resources inside the network environment. </span><span class="koboSpan" id="kobo.409.2">The first VM instance will </span><a id="_idIndexMarker1128"/><span class="koboSpan" id="kobo.410.1">serve as</span><a id="_idIndexMarker1129"/><span class="koboSpan" id="kobo.411.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.412.1">domain controller</span></strong><span class="koboSpan" id="kobo.413.1">, while the second VM instance will serve as the workstation machine that will be joined to </span><span class="No-Break"><span class="koboSpan" id="kobo.414.1">the domain:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer266">
<span class="koboSpan" id="kobo.415.1"><img alt="" src="image/B19755_08_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.416.1">Figure 8.8 — Launching the target VM instances</span></p>
<p><span class="koboSpan" id="kobo.417.1">If this is your first</span><a id="_idIndexMarker1130"/><span class="koboSpan" id="kobo.418.1"> time setting up Active Directory, then we can think </span><a id="_idIndexMarker1131"/><span class="koboSpan" id="kobo.419.1">of the </span><strong class="bold"><span class="koboSpan" id="kobo.420.1">domain controller</span></strong><span class="koboSpan" id="kobo.421.1"> as the </span><em class="italic"><span class="koboSpan" id="kobo.422.1">brain</span></em><span class="koboSpan" id="kobo.423.1"> of the network that oversees user authentication, resource management, and directory services. </span><span class="koboSpan" id="kobo.423.2">We can think of the workstation machine as one of the arms connected to the body, which interacts with the brain (domain controller) to access and utilize network resources and services. </span><span class="koboSpan" id="kobo.423.3">It is important to note that we can have multiple machines joined to the domain, each acting as a separate arm but still under the control and guidance of the domain controller. </span><span class="koboSpan" id="kobo.423.4">However, in this chapter, we’ll only set up one workstation machine joined to </span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">the domain.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.425.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.426.1">This section primarily focuses on launching the Windows VM instances inside our Microsoft Azure account. </span><span class="koboSpan" id="kobo.426.2">We have a dedicated section right after this on (mis)configuring the actual Active </span><span class="No-Break"><span class="koboSpan" id="kobo.427.1">Directory setup.</span></span></p>
<p><span class="koboSpan" id="kobo.428.1">We’ll divide this section into </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">three subparts:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.430.1">Part 1 of 3 – Launching the VM instance for the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.431.1">domain controller</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.432.1">Part 2 of 3 – Launching the VM instance for the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.433.1">workstation machine</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.434.1">Part 3 of 3 – Testing </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.435.1">network connectivity</span></em></span></li>
</ul>
<p><span class="koboSpan" id="kobo.436.1">Let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.437.1">get started.</span></span></p>
<h2 id="_idParaDest-172"><a id="_idTextAnchor172"/><span class="koboSpan" id="kobo.438.1">Part 1 of 3 – Launching the VM instance for the domain controller</span></h2>
<p><span class="koboSpan" id="kobo.439.1">Let’s start by</span><a id="_idIndexMarker1132"/><span class="koboSpan" id="kobo.440.1"> launching our first Windows </span><span class="No-Break"><span class="koboSpan" id="kobo.441.1">VM</span></span><span class="No-Break"><a id="_idIndexMarker1133"/></span><span class="No-Break"><span class="koboSpan" id="kobo.442.1"> instance:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.443.1">In the search bar, type </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">virtual machines</span></strong><span class="koboSpan" id="kobo.445.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.446.1">press </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.447.1">Enter</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.448.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer267">
<span class="koboSpan" id="kobo.449.1"><img alt="" src="image/B19755_08_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.450.1">Figure 8.9 — Navigating to the Virtual machines page</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.451.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.452.1">Virtual machines</span></strong><span class="koboSpan" id="kobo.453.1"> from the list of available options to navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.454.1">Virtual </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.455.1">machines</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.456.1"> page.</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.457.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.458.1">Virtual machines</span></strong><span class="koboSpan" id="kobo.459.1"> page, click the </span><strong class="bold"><span class="koboSpan" id="kobo.460.1">Create</span></strong><span class="koboSpan" id="kobo.461.1"> button. </span><span class="koboSpan" id="kobo.461.2">Choose </span><strong class="bold"><span class="koboSpan" id="kobo.462.1">Azure virtual machine</span></strong><span class="koboSpan" id="kobo.463.1"> from the list of options from the </span><span class="No-Break"><span class="koboSpan" id="kobo.464.1">drop-down menu.</span></span></li>
<li><span class="koboSpan" id="kobo.465.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.466.1">Create a virtual machine</span></strong><span class="koboSpan" id="kobo.467.1"> page, specify the following configuration values under the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.468.1">Basics</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.469.1"> tab:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.470.1">Project details</span></strong><span class="koboSpan" id="kobo.471.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.472.1">Subscription</span></strong><span class="koboSpan" id="kobo.473.1">: (Use </span><span class="No-Break"><span class="koboSpan" id="kobo.474.1">existing subscription)</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.475.1">Project details</span></strong><span class="koboSpan" id="kobo.476.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.477.1">Resource </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.478.1">group</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.480.1">resource-group-01</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.481.1">Instance details</span></strong><span class="koboSpan" id="kobo.482.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.483.1">Virtual machine </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.484.1">name</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.485.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">ad-domain-controller</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.487.1">Instance details</span></strong><span class="koboSpan" id="kobo.488.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.489.1">Region</span></strong><span class="koboSpan" id="kobo.490.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.491.1">(US) </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">East US</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.493.1">Instance details</span></strong><span class="koboSpan" id="kobo.494.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.495.1">Security </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.496.1">type</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.498.1">Standard</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.499.1">Instance details</span></strong><span class="koboSpan" id="kobo.500.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.501.1">Image</span></strong><span class="koboSpan" id="kobo.502.1">: Click the </span><strong class="bold"><span class="koboSpan" id="kobo.503.1">See all </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.504.1">images</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.505.1"> link</span></span></li></ul></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.506.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.507.1">Clicking </span><strong class="bold"><span class="koboSpan" id="kobo.508.1">See all images</span></strong><span class="koboSpan" id="kobo.509.1"> will redirect you to the </span><strong class="bold"><span class="koboSpan" id="kobo.510.1">Select an </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.511.1">image</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.512.1"> page.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.513.1">On</span><a id="_idIndexMarker1134"/><span class="koboSpan" id="kobo.514.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.515.1">Select an image</span></strong><span class="koboSpan" id="kobo.516.1"> page, type </span><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">windows</span></strong><span class="koboSpan" id="kobo.518.1"> in the</span><a id="_idIndexMarker1135"/><span class="koboSpan" id="kobo.519.1"> search box and then </span><span class="No-Break"><span class="koboSpan" id="kobo.520.1">press </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.521.1">Enter</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.522.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer268">
<span class="koboSpan" id="kobo.523.1"><img alt="" src="image/B19755_08_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.524.1">Figure 8.10 — Selecting the Windows Server image</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.525.1">Choose </span><strong class="bold"><span class="koboSpan" id="kobo.526.1">Windows Server</span></strong><span class="koboSpan" id="kobo.527.1"> by clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.528.1">Select</span></strong><span class="koboSpan" id="kobo.529.1"> button, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.530.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.531.1">.10</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.532.1">.</span></span></p></li>
</ol>
<ol>
<li value="5"><span class="koboSpan" id="kobo.533.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.534.1">Windows Server 2019 Datacenter – x64 Gen 2</span></strong><span class="koboSpan" id="kobo.535.1"> (or if there are other newer versions, choose the closest one from the list </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">of options):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer269">
<span class="koboSpan" id="kobo.537.1"><img alt="" src="image/B19755_08_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.538.1">Figure 8.11 — Selecting the image for the domain controller VM instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.539.1">This should</span><a id="_idIndexMarker1136"/><span class="koboSpan" id="kobo.540.1"> redirect you back to</span><a id="_idIndexMarker1137"/><span class="koboSpan" id="kobo.541.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.542.1">Create a virtual </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.543.1">machine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.544.1"> page.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.545.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.546.1">If you are having issues selecting the Windows Server image and making it appear in the drop-down menu as the selected image, simply refresh the page and then try again. </span><span class="koboSpan" id="kobo.546.2">Note that you will need to input the other VM configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.547.1">settings again.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.548.1">Continuing where we left off on the </span><strong class="bold"><span class="koboSpan" id="kobo.549.1">Create a virtual machine</span></strong><span class="koboSpan" id="kobo.550.1"> page, specify the following configuration values </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">as well:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.552.1">Project details</span></strong><span class="koboSpan" id="kobo.553.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.554.1">Size</span></strong><span class="koboSpan" id="kobo.555.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.556.1">Standard_B2ms – 2 vcpus, 8 </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.557.1">GiB memory</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.558.1">Administrator account</span></strong><span class="koboSpan" id="kobo.559.1"> &gt; </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.560.1">Username</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.561.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.562.1">admin_user</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.563.1">Administrator account</span></strong><span class="koboSpan" id="kobo.564.1"> &gt; </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.565.1">Password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">Windows1234!!!</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.568.1">Administrator account</span></strong><span class="koboSpan" id="kobo.569.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.570.1">Confirm </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.571.1">password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">Windows1234!!!</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.574.1">Inbound port rules</span></strong><span class="koboSpan" id="kobo.575.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.576.1">Public inbound </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.577.1">ports</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.578.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.579.1">None</span></strong></span></li></ul><p class="list-inset"><span class="koboSpan" id="kobo.580.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.581.1">Next : Disks &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.582.1">button after.</span></span></p><ul><li><span class="koboSpan" id="kobo.583.1">Accept the default configuration under the </span><strong class="bold"><span class="koboSpan" id="kobo.584.1">Disks</span></strong><span class="koboSpan" id="kobo.585.1"> tab and click </span><strong class="bold"><span class="koboSpan" id="kobo.586.1">Next : </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.587.1">Networking &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.588.1">.</span></span></li></ul></li>
<li><span class="koboSpan" id="kobo.589.1">Under </span><a id="_idIndexMarker1138"/><span class="koboSpan" id="kobo.590.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.591.1">Networking</span></strong><span class="koboSpan" id="kobo.592.1"> tab, make sure</span><a id="_idIndexMarker1139"/><span class="koboSpan" id="kobo.593.1"> that the following configuration values </span><span class="No-Break"><span class="koboSpan" id="kobo.594.1">are set:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.595.1">Virtual </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.596.1">network</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.597.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.598.1">vnet-01</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.599.1">Subnet</span></strong><span class="koboSpan" id="kobo.600.1">: </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.601.1">subnet-01 (10.0.1.0/24)</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.602.1">NIC network security </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.603.1">group</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.605.1">Advanced</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.606.1">Configure network security </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.607.1">group</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.608.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">nsg-01</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.610.1">Delete public IP and NIC when VM is </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.611.1">deleted</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.612.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.613.1">(checked)</span></strong></span></li></ul><p class="list-inset"><span class="koboSpan" id="kobo.614.1">Here, we are configuring our Windows VM instance to be launched inside the VNet (</span><strong class="source-inline"><span class="koboSpan" id="kobo.615.1">vnet-01</span></strong><span class="koboSpan" id="kobo.616.1">) we set up automatically using Terraform in the </span><span class="No-Break"><span class="koboSpan" id="kobo.617.1">previous section.</span></span></p></li>
<li><span class="koboSpan" id="kobo.618.1">Now, continue clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.619.1">Next</span></strong><span class="koboSpan" id="kobo.620.1"> button until you reach the </span><span class="No-Break"><span class="koboSpan" id="kobo.621.1">last tab.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.622.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.623.1">Simply accept the default settings under </span><strong class="bold"><span class="koboSpan" id="kobo.624.1">Disks</span></strong><span class="koboSpan" id="kobo.625.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.626.1">Networking</span></strong><span class="koboSpan" id="kobo.627.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.628.1">Management</span></strong><span class="koboSpan" id="kobo.629.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.630.1">Monitoring</span></strong><span class="koboSpan" id="kobo.631.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.632.1">Advanced</span></strong><span class="koboSpan" id="kobo.633.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.634.1">Tags</span></strong><span class="koboSpan" id="kobo.635.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.636.1">Review + </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.637.1">create</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.638.1">.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.639.1">Once you reach the </span><strong class="bold"><span class="koboSpan" id="kobo.640.1">Review + create</span></strong><span class="koboSpan" id="kobo.641.1"> tab, click the </span><strong class="bold"><span class="koboSpan" id="kobo.642.1">Create</span></strong><span class="koboSpan" id="kobo.643.1"> button after reviewing the </span><span class="No-Break"><span class="koboSpan" id="kobo.644.1">configuration details.</span></span></li>
<li><span class="koboSpan" id="kobo.645.1">Wait until you see the </span><strong class="bold"><span class="koboSpan" id="kobo.646.1">Your deployment is complete</span></strong><span class="koboSpan" id="kobo.647.1"> message. </span><span class="koboSpan" id="kobo.647.2">Scroll down and click the </span><strong class="bold"><span class="koboSpan" id="kobo.648.1">Go to resource</span></strong><span class="koboSpan" id="kobo.649.1"> button. </span><span class="koboSpan" id="kobo.649.2">This should redirect you to the </span><strong class="bold"><span class="koboSpan" id="kobo.650.1">Overview</span></strong><span class="koboSpan" id="kobo.651.1"> blade of the VM we just </span><span class="No-Break"><span class="koboSpan" id="kobo.652.1">created (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.653.1">ad-domain-controller</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.654.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.655.1">Locate</span><a id="_idIndexMarker1140"/><span class="koboSpan" id="kobo.656.1"> and select </span><strong class="bold"><span class="koboSpan" id="kobo.657.1">Connect</span></strong><span class="koboSpan" id="kobo.658.1"> under</span><a id="_idIndexMarker1141"/><span class="koboSpan" id="kobo.659.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.660.1">Settings</span></strong><span class="koboSpan" id="kobo.661.1"> section of the resource menu in the </span><span class="No-Break"><span class="koboSpan" id="kobo.662.1">left pane.</span></span></li>
<li><span class="koboSpan" id="kobo.663.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.664.1">Download RDP File</span></strong><span class="koboSpan" id="kobo.665.1">, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.666.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.667.1">.12</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.668.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer270">
<span class="koboSpan" id="kobo.669.1"><img alt="" src="image/B19755_08_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.670.1">Figure 8.12 — Download RDP File</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.671.1">This will download an RDP file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1">ad-domain-controller.rdp</span></strong><span class="koboSpan" id="kobo.673.1">) to your local machine. </span><span class="koboSpan" id="kobo.673.2">If you are seeing a newer version of the </span><strong class="bold"><span class="koboSpan" id="kobo.674.1">Connect</span></strong><span class="koboSpan" id="kobo.675.1"> page of the portal, simply click the </span><strong class="bold"><span class="koboSpan" id="kobo.676.1">Select</span></strong><span class="koboSpan" id="kobo.677.1"> button under </span><strong class="bold"><span class="koboSpan" id="kobo.678.1">Native RDP</span></strong><span class="koboSpan" id="kobo.679.1"> (under </span><strong class="bold"><span class="koboSpan" id="kobo.680.1">Most common</span></strong><span class="koboSpan" id="kobo.681.1">) before clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.682.1">Download RDP </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.683.1">File</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.684.1"> button.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.685.1">Note</span></p>
<p class="callout"><strong class="bold"><span class="koboSpan" id="kobo.686.1">Remote Desktop Protocol</span></strong><span class="koboSpan" id="kobo.687.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.688.1">RDP</span></strong><span class="koboSpan" id="kobo.689.1">) is a </span><a id="_idIndexMarker1142"/><span class="koboSpan" id="kobo.690.1">secure protocol (developed by Microsoft) that allows users to access and control a computer’s desktop interface over a network. </span><span class="koboSpan" id="kobo.690.2">With this, an RDP file is simply a configuration file that contains the necessary information to access a remote machine’s interface over a network. </span><span class="koboSpan" id="kobo.690.3">For more information about this topic, feel free to check </span><span class="No-Break"><span class="koboSpan" id="kobo.691.1">out </span></span><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/windows/connect-rdp"><span class="No-Break"><span class="koboSpan" id="kobo.692.1">https://learn.microsoft.com/en-us/azure/virtual-machines/windows/connect-rdp</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.693.1">.</span></span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.694.1">Open the RDP file using </span><a id="_idIndexMarker1143"/><span class="koboSpan" id="kobo.695.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.696.1">Microsoft Remote Desktop</span></strong><span class="koboSpan" id="kobo.697.1"> app. </span><span class="koboSpan" id="kobo.697.2">If the Microsoft Remote Desktop app has been installed already, we can simply double-click the RDP file stored inside our </span><strong class="bold"><span class="koboSpan" id="kobo.698.1">Downloads</span></strong><span class="koboSpan" id="kobo.699.1"> folder (or alternative) to connect to the Windows VM </span><span class="No-Break"><span class="koboSpan" id="kobo.700.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.701.1">ad-domain-controller</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.702.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.703.1">Simply </span><a id="_idIndexMarker1144"/><span class="koboSpan" id="kobo.704.1">use </span><strong class="source-inline"><span class="koboSpan" id="kobo.705.1">admin_user</span></strong><span class="koboSpan" id="kobo.706.1"> as the username</span><a id="_idIndexMarker1145"/><span class="koboSpan" id="kobo.707.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.708.1">Windows1234!!!</span></strong><span class="koboSpan" id="kobo.709.1"> as the password when you’re prompted for the credentials of the </span><span class="No-Break"><span class="koboSpan" id="kobo.710.1">user account:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer271">
<span class="koboSpan" id="kobo.711.1"><img alt="" src="image/B19755_08_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.712.1">Figure 8.13 — Enter Your User Account</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.713.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.714.1">Continue</span></strong><span class="koboSpan" id="kobo.715.1"> button when you see the </span><strong class="bold"><span class="koboSpan" id="kobo.716.1">You are connecting to the RDP </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.717.1">host...</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.718.1"> popup:</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.719.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.720.1">In rare cases where we encounter a black screen, simply restart the VM instance and then try connecting again. </span><span class="koboSpan" id="kobo.720.2">Otherwise, delete the VM instance, recreate it, and then </span><span class="No-Break"><span class="koboSpan" id="kobo.721.1">connect again.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer272">
<span class="koboSpan" id="kobo.722.1"><img alt="" src="image/B19755_08_14.jpg"/></span>
</div>
</div>
<ol><li style="list-style-type:none"><p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.723.1">Figure 8.14 — Server Manager open upon signing in</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.724.1">We </span><a id="_idIndexMarker1146"/><span class="koboSpan" id="kobo.725.1">should see </span><strong class="bold"><span class="koboSpan" id="kobo.726.1">Server Manager</span></strong><span class="koboSpan" id="kobo.727.1"> open</span><a id="_idIndexMarker1147"/><span class="koboSpan" id="kobo.728.1"> upon signing into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.729.1">admin_user</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.730.1">user account.</span></span></p>
</li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.731.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.732.1">If this is your first time using </span><strong class="bold"><span class="koboSpan" id="kobo.733.1">Server Manager</span></strong><span class="koboSpan" id="kobo.734.1">, you can think of it as a centralized interface where administrators</span><a id="_idIndexMarker1148"/><span class="koboSpan" id="kobo.735.1"> can perform various tasks and manage different aspects of a Windows Server environment. </span><span class="koboSpan" id="kobo.735.2">This includes configuring server roles and features, monitoring server performance, setting up and configuring Active Directory, </span><span class="No-Break"><span class="koboSpan" id="kobo.736.1">and more.</span></span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.737.1">Click the search button and type </span><strong class="source-inline"><span class="koboSpan" id="kobo.738.1">cmd</span></strong><span class="koboSpan" id="kobo.739.1"> in the search box, similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.740.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.741.1">.15</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.742.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer273">
<span class="koboSpan" id="kobo.743.1"><img alt="" src="image/B19755_08_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.744.1">Figure 8.15 — Opening the Command Prompt application</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.745.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.746.1">Command Prompt</span></strong><span class="koboSpan" id="kobo.747.1"> (under </span><strong class="bold"><span class="koboSpan" id="kobo.748.1">Best match</span></strong><span class="koboSpan" id="kobo.749.1">) to open the Command Prompt application. </span><span class="koboSpan" id="kobo.749.2">Here, we can run various commands to interact with the operating system</span><a id="_idIndexMarker1149"/><span class="koboSpan" id="kobo.750.1"> and perform tasks such as file and </span><a id="_idIndexMarker1150"/><span class="koboSpan" id="kobo.751.1">directory manipulation, system configuration, network diagnostics, </span><span class="No-Break"><span class="koboSpan" id="kobo.752.1">and more.</span></span></p></li>
</ol>
<ol>
<li value="16"><span class="koboSpan" id="kobo.753.1">Inside the Command Prompt, run </span><strong class="source-inline"><span class="koboSpan" id="kobo.754.1">ipconfig</span></strong><span class="koboSpan" id="kobo.755.1"> to retrieve the private IP address of the </span><span class="No-Break"><span class="koboSpan" id="kobo.756.1">VM instance:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer274">
<span class="koboSpan" id="kobo.757.1"><img alt="" src="image/B19755_08_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.758.1">Figure 8.16 — Results after running ipconfig</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.759.1">Here, we</span><a id="_idIndexMarker1151"/><span class="koboSpan" id="kobo.760.1"> can see that the private IP address of our first Windows VM instance (which will serve as the Active Directory</span><a id="_idIndexMarker1152"/><span class="koboSpan" id="kobo.761.1"> domain controller once we’ve configured it later in this chapter) is </span><strong class="source-inline"><span class="koboSpan" id="kobo.762.1">1.0.1.4</span></strong><span class="koboSpan" id="kobo.763.1">. </span><span class="koboSpan" id="kobo.763.2">Note that you might get a different private IP address value after </span><span class="No-Break"><span class="koboSpan" id="kobo.764.1">running </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.765.1">ipconfig</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.766.1">.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.767.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.768.1">In the succeeding set of steps in this chapter, we will assume that the private IP address of our domain controller machine is </span><strong class="source-inline"><span class="koboSpan" id="kobo.769.1">1.0.1.4</span></strong><span class="koboSpan" id="kobo.770.1">. </span><span class="koboSpan" id="kobo.770.2">Make sure you update the IP address value that’s used in the commands in case you get a different private IP address value after running </span><strong class="source-inline"><span class="koboSpan" id="kobo.771.1">ipconfig</span></strong><span class="koboSpan" id="kobo.772.1"> in the </span><span class="No-Break"><span class="koboSpan" id="kobo.773.1">previous step.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.774.1">At this point, we have a single Windows VM instance (in addition to the attacker VM instance) running inside our isolated network environment. </span><strong class="bold"><span class="koboSpan" id="kobo.775.1">Note that this Windows VM instance does not have Active Directory set up yet!</span></strong><span class="koboSpan" id="kobo.776.1"> That said, do not close the RDP session yet for this VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.777.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.778.1">) as we will set up and configure Active Directory in this instance in the next section. </span><span class="koboSpan" id="kobo.778.2">For </span><a id="_idIndexMarker1153"/><span class="koboSpan" id="kobo.779.1">now, you can minimize</span><a id="_idIndexMarker1154"/><span class="koboSpan" id="kobo.780.1"> the RDP session window and navigate back to the browser where we have the Azure </span><span class="No-Break"><span class="koboSpan" id="kobo.781.1">portal open.</span></span></p>
<h2 id="_idParaDest-173"><a id="_idTextAnchor173"/><span class="koboSpan" id="kobo.782.1">Part 2 of 3 – Launching the VM instance for the workstation machine</span></h2>
<p><span class="koboSpan" id="kobo.783.1">Now, let’s</span><a id="_idIndexMarker1155"/><span class="koboSpan" id="kobo.784.1"> launch a second Windows </span><a id="_idIndexMarker1156"/><span class="koboSpan" id="kobo.785.1">VM instance for the </span><span class="No-Break"><span class="koboSpan" id="kobo.786.1">workstation machine:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.787.1">Navigate back to the browser where we have the Azure portal open. </span><span class="koboSpan" id="kobo.787.2">In the search bar (of the Microsoft Azure portal), type </span><strong class="source-inline"><span class="koboSpan" id="kobo.788.1">virtual machines</span></strong><span class="koboSpan" id="kobo.789.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.790.1">press </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.791.1">Enter</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.792.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer275">
<span class="koboSpan" id="kobo.793.1"><img alt="" src="image/B19755_08_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.794.1">Figure 8.17 — Navigating to the Virtual machines page</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.795.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.796.1">Virtual machines</span></strong><span class="koboSpan" id="kobo.797.1"> from the list of available options to navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.798.1">Virtual machines</span></strong><span class="koboSpan" id="kobo.799.1"> page (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.800.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.801.1">.17</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.802.1">).</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.803.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.804.1">Virtual machines</span></strong><span class="koboSpan" id="kobo.805.1"> page, click the </span><strong class="bold"><span class="koboSpan" id="kobo.806.1">Create</span></strong><span class="koboSpan" id="kobo.807.1"> button. </span><span class="koboSpan" id="kobo.807.2">Choose </span><strong class="bold"><span class="koboSpan" id="kobo.808.1">Azure virtual machine</span></strong><span class="koboSpan" id="kobo.809.1"> from the list of options from the </span><span class="No-Break"><span class="koboSpan" id="kobo.810.1">drop-down menu.</span></span></li>
<li><span class="koboSpan" id="kobo.811.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.812.1">Create a virtual machine</span></strong><span class="koboSpan" id="kobo.813.1"> page, specify the following configuration values under the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.814.1">Basics</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.815.1"> tab:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.816.1">Project details</span></strong><span class="koboSpan" id="kobo.817.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.818.1">Subscription</span></strong><span class="koboSpan" id="kobo.819.1">: (Use </span><span class="No-Break"><span class="koboSpan" id="kobo.820.1">existing subscription)</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.821.1">Project details</span></strong><span class="koboSpan" id="kobo.822.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.823.1">Resource </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.824.1">group</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.825.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.826.1">resource-group-01</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.827.1">Instance details</span></strong><span class="koboSpan" id="kobo.828.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.829.1">Virtual machine </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.830.1">name</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.831.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.832.1">ad-workstation-machine</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.833.1">Instance details</span></strong><span class="koboSpan" id="kobo.834.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.835.1">Region</span></strong><span class="koboSpan" id="kobo.836.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.837.1">(US) </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.838.1">East US</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.839.1">Instance details</span></strong><span class="koboSpan" id="kobo.840.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.841.1">Security </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.842.1">type</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.843.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.844.1">Standard</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.845.1">Instance details</span></strong><span class="koboSpan" id="kobo.846.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.847.1">Image</span></strong><span class="koboSpan" id="kobo.848.1">: Click the </span><strong class="bold"><span class="koboSpan" id="kobo.849.1">See all </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.850.1">images</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.851.1"> link</span></span></li></ul></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.852.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.853.1">Clicking </span><strong class="bold"><span class="koboSpan" id="kobo.854.1">See all images</span></strong><span class="koboSpan" id="kobo.855.1"> will redirect you to the </span><strong class="bold"><span class="koboSpan" id="kobo.856.1">Select an </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.857.1">image</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.858.1"> page.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.859.1">On </span><a id="_idIndexMarker1157"/><span class="koboSpan" id="kobo.860.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.861.1">Select an image</span></strong><span class="koboSpan" id="kobo.862.1"> page, type </span><strong class="source-inline"><span class="koboSpan" id="kobo.863.1">windows</span></strong><span class="koboSpan" id="kobo.864.1"> in the </span><a id="_idIndexMarker1158"/><span class="koboSpan" id="kobo.865.1">search box and then </span><span class="No-Break"><span class="koboSpan" id="kobo.866.1">press </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.867.1">Enter</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.868.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer276">
<span class="koboSpan" id="kobo.869.1"><img alt="" src="image/B19755_08_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.870.1">Figure 8.18 — Selecting the Microsoft Windows 10 image</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.871.1">Choose </span><strong class="bold"><span class="koboSpan" id="kobo.872.1">Microsoft Windows 10</span></strong><span class="koboSpan" id="kobo.873.1"> by clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.874.1">Select</span></strong><span class="koboSpan" id="kobo.875.1"> button, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.876.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.877.1">.18</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.878.1">.</span></span></p></li>
</ol>
<ol>
<li value="5"><span class="koboSpan" id="kobo.879.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.880.1">Windows 10 Enterprise, version 22H2 – x64 Gen2</span></strong><span class="koboSpan" id="kobo.881.1"> (or if there are other newer </span><a id="_idIndexMarker1159"/><span class="koboSpan" id="kobo.882.1">versions, choose the closest </span><a id="_idIndexMarker1160"/><span class="koboSpan" id="kobo.883.1">one from the list </span><span class="No-Break"><span class="koboSpan" id="kobo.884.1">of options):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer277">
<span class="koboSpan" id="kobo.885.1"><img alt="" src="image/B19755_08_19.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.886.1">Figure 8.19 — Selecting the image for the workstation VM instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.887.1">This should redirect you back to the </span><strong class="bold"><span class="koboSpan" id="kobo.888.1">Create a virtual </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.889.1">machine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.890.1"> page.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.891.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.892.1">If you are having issues selecting the Windows Server image and making it reflect in the drop-down menu as the selected image, simply refresh the page and then try again. </span><span class="koboSpan" id="kobo.892.2">Note that you will need to input the VM configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.893.1">settings again.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.894.1">Continuing where we left off on the </span><strong class="bold"><span class="koboSpan" id="kobo.895.1">Create a virtual machine</span></strong><span class="koboSpan" id="kobo.896.1"> page, specify the following configuration values </span><span class="No-Break"><span class="koboSpan" id="kobo.897.1">as well:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.898.1">Project details</span></strong><span class="koboSpan" id="kobo.899.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.900.1">Size</span></strong><span class="koboSpan" id="kobo.901.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.902.1">Standard_B2ms – 2 vcpus, 8 </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.903.1">GiB memory</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.904.1">Administrator account</span></strong><span class="koboSpan" id="kobo.905.1"> &gt; </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.906.1">Username</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.907.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.908.1">workstation_user</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.909.1">Administrator account</span></strong><span class="koboSpan" id="kobo.910.1"> &gt; </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.911.1">Password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.912.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">Workstation1234!!!</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.914.1">Administrator account</span></strong><span class="koboSpan" id="kobo.915.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.916.1">Confirm </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.917.1">password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.918.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.919.1">Workstation1234!!!</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.920.1">Inbound port rules</span></strong><span class="koboSpan" id="kobo.921.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.922.1">Public inbound </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.923.1">ports</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.924.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.925.1">None</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.926.1">Licensing</span></strong><span class="koboSpan" id="kobo.927.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.928.1">I confirm I have an eligible Windows 10/11 license with multi-tenant hosting </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.929.1">rights</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.930.1">: (checked)</span></span></li></ul><p class="list-inset"><span class="koboSpan" id="kobo.931.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.932.1">Next : Disks &gt;</span></strong><span class="koboSpan" id="kobo.933.1"> button after you've added the </span><span class="No-Break"><span class="koboSpan" id="kobo.934.1">specified values</span></span><span class="No-Break"><span class="koboSpan" id="kobo.935.1">.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.936.1">Accept the default configuration under the </span><strong class="bold"><span class="koboSpan" id="kobo.937.1">Disks</span></strong><span class="koboSpan" id="kobo.938.1"> tab and click </span><strong class="bold"><span class="koboSpan" id="kobo.939.1">Next : </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.940.1">Networking &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.941.1">.</span></span></p></li>
<li><span class="koboSpan" id="kobo.942.1">Under the </span><strong class="bold"><span class="koboSpan" id="kobo.943.1">Networking</span></strong><span class="koboSpan" id="kobo.944.1"> tab, make</span><a id="_idIndexMarker1161"/><span class="koboSpan" id="kobo.945.1"> sure that the</span><a id="_idIndexMarker1162"/><span class="koboSpan" id="kobo.946.1"> following configuration values </span><span class="No-Break"><span class="koboSpan" id="kobo.947.1">are set:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.948.1">Virtual </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.949.1">network</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.950.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.951.1">vnet-01</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.952.1">Subnet</span></strong><span class="koboSpan" id="kobo.953.1">: </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.954.1">subnet-01 (10.0.1.0/24)</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.955.1">NIC network security </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.956.1">group</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.957.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.958.1">Advanced</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.959.1">Configure network security </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.960.1">group</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.961.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.962.1">nsg-01</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.963.1">Delete public IP and NIC when VM is </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.964.1">deleted</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.965.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.966.1">(checked)</span></strong></span></li></ul><p class="list-inset"><span class="koboSpan" id="kobo.967.1">Here, we are configuring our second Windows VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.968.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.969.1">) so that it’s deployed inside the same VNet (and subnet) as the first Windows VM instance. </span><span class="koboSpan" id="kobo.969.2">Note that these network resources already exist and were created automatically using Terraform in the </span><span class="No-Break"><span class="koboSpan" id="kobo.970.1">previous section.</span></span></p></li>
<li><span class="koboSpan" id="kobo.971.1">Now, continue clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.972.1">Next</span></strong><span class="koboSpan" id="kobo.973.1"> button until you reach the </span><span class="No-Break"><span class="koboSpan" id="kobo.974.1">last tab.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.975.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.976.1">Simply accept the default settings under </span><strong class="bold"><span class="koboSpan" id="kobo.977.1">Disks</span></strong><span class="koboSpan" id="kobo.978.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.979.1">Networking</span></strong><span class="koboSpan" id="kobo.980.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.981.1">Management</span></strong><span class="koboSpan" id="kobo.982.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.983.1">Monitoring</span></strong><span class="koboSpan" id="kobo.984.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.985.1">Advanced</span></strong><span class="koboSpan" id="kobo.986.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.987.1">Tags</span></strong><span class="koboSpan" id="kobo.988.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.989.1">Review + </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.990.1">create</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.991.1">.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.992.1">Once you reach the </span><strong class="bold"><span class="koboSpan" id="kobo.993.1">Review + create</span></strong><span class="koboSpan" id="kobo.994.1"> tab, click the </span><strong class="bold"><span class="koboSpan" id="kobo.995.1">Create</span></strong><span class="koboSpan" id="kobo.996.1"> button after reviewing the </span><span class="No-Break"><span class="koboSpan" id="kobo.997.1">configuration details.</span></span></li>
<li><span class="koboSpan" id="kobo.998.1">Wait until you see the </span><strong class="bold"><span class="koboSpan" id="kobo.999.1">Your deployment is complete</span></strong><span class="koboSpan" id="kobo.1000.1"> message. </span><span class="koboSpan" id="kobo.1000.2">Scroll down and click the </span><strong class="bold"><span class="koboSpan" id="kobo.1001.1">Go to resource</span></strong><span class="koboSpan" id="kobo.1002.1"> button. </span><span class="koboSpan" id="kobo.1002.2">This should redirect you to the </span><strong class="bold"><span class="koboSpan" id="kobo.1003.1">Overview</span></strong><span class="koboSpan" id="kobo.1004.1"> blade of the VM we just </span><span class="No-Break"><span class="koboSpan" id="kobo.1005.1">created (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1006.1">ad-workstation-machine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1007.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.1008.1">Locate </span><a id="_idIndexMarker1163"/><span class="koboSpan" id="kobo.1009.1">and select </span><strong class="bold"><span class="koboSpan" id="kobo.1010.1">Connect</span></strong><span class="koboSpan" id="kobo.1011.1"> under </span><a id="_idIndexMarker1164"/><span class="koboSpan" id="kobo.1012.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.1013.1">Settings</span></strong><span class="koboSpan" id="kobo.1014.1"> section of the resource menu in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1015.1">left pane.</span></span></li>
<li><span class="koboSpan" id="kobo.1016.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.1017.1">Download RDP File</span></strong><span class="koboSpan" id="kobo.1018.1">, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1019.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1020.1">.20</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1021.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer278">
<span class="koboSpan" id="kobo.1022.1"><img alt="" src="image/B19755_08_20.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1023.1">Figure 8.20 — Download RDP File</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1024.1">This will download an RDP file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1025.1">ad-workstation-machine.rdp</span></strong><span class="koboSpan" id="kobo.1026.1">) to your local machine. </span><span class="koboSpan" id="kobo.1026.2">If you are viewing a newer version of the </span><strong class="bold"><span class="koboSpan" id="kobo.1027.1">Connect</span></strong><span class="koboSpan" id="kobo.1028.1"> page of the portal, simply click the </span><strong class="bold"><span class="koboSpan" id="kobo.1029.1">Select</span></strong><span class="koboSpan" id="kobo.1030.1"> button under </span><strong class="bold"><span class="koboSpan" id="kobo.1031.1">Native RDP</span></strong><span class="koboSpan" id="kobo.1032.1"> (under </span><strong class="bold"><span class="koboSpan" id="kobo.1033.1">Most common</span></strong><span class="koboSpan" id="kobo.1034.1">) before clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.1035.1">Download RDP </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1036.1">File</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1037.1"> button.</span></span></p></li>
</ol>
<ol>
<li value="13"><span class="koboSpan" id="kobo.1038.1">Open the </span><a id="_idIndexMarker1165"/><span class="koboSpan" id="kobo.1039.1">RDP file using the </span><strong class="bold"><span class="koboSpan" id="kobo.1040.1">Microsoft Remote Desktop</span></strong><span class="koboSpan" id="kobo.1041.1"> app</span><a id="_idIndexMarker1166"/><span class="koboSpan" id="kobo.1042.1">. </span><span class="koboSpan" id="kobo.1042.2">Simply use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1043.1">workstation_user</span></strong><span class="koboSpan" id="kobo.1044.1"> as the username</span><a id="_idIndexMarker1167"/><span class="koboSpan" id="kobo.1045.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1046.1">Workstation1234!!!</span></strong><span class="koboSpan" id="kobo.1047.1"> as the password when prompted for </span><span class="No-Break"><span class="koboSpan" id="kobo.1048.1">the credentials:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer279">
<span class="koboSpan" id="kobo.1049.1"><img alt="" src="image/B19755_08_21.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1050.1">Figure 8.21 — Enter Your User Account</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1051.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1052.1">Continue</span></strong><span class="koboSpan" id="kobo.1053.1"> button when you see the </span><strong class="bold"><span class="koboSpan" id="kobo.1054.1">You are connecting to the RDP </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1055.1">host...</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1056.1"> popup.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1057.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1058.1">In rare cases where we encounter a black screen, simply restart the VM instance and then try connecting again. </span><span class="koboSpan" id="kobo.1058.2">Otherwise, delete the VM instance, recreate it, and then </span><span class="No-Break"><span class="koboSpan" id="kobo.1059.1">connect again.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.1060.1">On the </span><strong class="bold"><span class="koboSpan" id="kobo.1061.1">Choose privacy settings for your device</span></strong><span class="koboSpan" id="kobo.1062.1"> screen, </span><span class="No-Break"><span class="koboSpan" id="kobo.1063.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1064.1">Accept</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1065.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1066.1">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.1067.1">cmd</span></strong><span class="koboSpan" id="kobo.1068.1"> in the search bar (located in the lower left corner of the screen), similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1069.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1070.1">.22</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1071.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer280">
<span class="koboSpan" id="kobo.1072.1"><img alt="" src="image/B19755_08_22.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1073.1">Figure 8.22 — Opening the Command Prompt</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1074.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.1075.1">Command Prompt</span></strong><span class="koboSpan" id="kobo.1076.1"> (under </span><strong class="bold"><span class="koboSpan" id="kobo.1077.1">Best match</span></strong><span class="koboSpan" id="kobo.1078.1">) to open the Command </span><span class="No-Break"><span class="koboSpan" id="kobo.1079.1">Prompt application.</span></span></p></li>
</ol>
<ol>
<li value="16"><span class="koboSpan" id="kobo.1080.1">Run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1081.1">ipconfig</span></strong><span class="koboSpan" id="kobo.1082.1"> to</span><a id="_idIndexMarker1168"/><span class="koboSpan" id="kobo.1083.1"> check the private IP </span><a id="_idIndexMarker1169"/><span class="koboSpan" id="kobo.1084.1">address of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1085.1">VM instance:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer281">
<span class="koboSpan" id="kobo.1086.1"><img alt="" src="image/B19755_08_23.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1087.1">Figure 8.23 — Results after running ipconfig inside the workstation VM instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1088.1">This should return a</span><a id="_idIndexMarker1170"/><span class="koboSpan" id="kobo.1089.1"> set of configuration values</span><a id="_idIndexMarker1171"/><span class="koboSpan" id="kobo.1090.1"> similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1091.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1092.1">.23</span></em><span class="koboSpan" id="kobo.1093.1">. </span><span class="koboSpan" id="kobo.1093.2">Note that you might get a different IP address value for </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1094.1">IPv4 Address</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1095.1">.</span></span></p></li>
</ol>
<h2 id="_idParaDest-174"><a id="_idTextAnchor174"/><span class="koboSpan" id="kobo.1096.1">Part 3 of 3 – Testing network connectivity</span></h2>
<p><span class="koboSpan" id="kobo.1097.1">With the target VM</span><a id="_idIndexMarker1172"/><span class="koboSpan" id="kobo.1098.1"> instances launched, we need to verify if the target instances inside one VNet (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1099.1">vnet-01</span></strong><span class="koboSpan" id="kobo.1100.1">) can be reached from the attacker VM instance launched in another VNet (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1101.1">vnet-02</span></strong><span class="koboSpan" id="kobo.1102.1">) to test the VNet peering that we set up automatically using </span><span class="No-Break"><span class="koboSpan" id="kobo.1103.1">Terraform earlier:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer282">
<span class="koboSpan" id="kobo.1104.1"><img alt="" src="image/B19755_08_24.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1105.1">Figure 8.24 — Testing network connectivity</span></p>
<p><span class="koboSpan" id="kobo.1106.1">That said, let’s </span><a id="_idIndexMarker1173"/><span class="koboSpan" id="kobo.1107.1">quickly check if both Windows instances (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1108.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.1109.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1110.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.1111.1">) are reachable from the attacker VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1112.1">vm-kali</span></strong><span class="koboSpan" id="kobo.1113.1">) before we proceed with the succeeding set </span><span class="No-Break"><span class="koboSpan" id="kobo.1114.1">of steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1115.1">Navigate back to the browser tab you used to access the desktop/GUI environment of the attacker machine. </span><span class="koboSpan" id="kobo.1115.2">If you have closed the browser tab already, simply go to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1116.1">http://&lt;VM KALI PUBLIC IP&gt;:8081/vnc.html</span></strong><span class="koboSpan" id="kobo.1117.1"> in a new browser tab. </span><span class="koboSpan" id="kobo.1117.2">Make sure you replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.1118.1">&lt;VM KALI PUBLIC IP&gt;</span></strong><span class="koboSpan" id="kobo.1119.1"> with the </span><strong class="bold"><span class="koboSpan" id="kobo.1120.1">Public IP address</span></strong><span class="koboSpan" id="kobo.1121.1"> value of the Kali Linux </span><span class="No-Break"><span class="koboSpan" id="kobo.1122.1">VM instance.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1123.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1124.1">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1125.1">kali123</span></strong><span class="koboSpan" id="kobo.1126.1"> as the password (or the password you specified in </span><span class="No-Break"><em class="italic"><a href="B19755_05.xhtml"><span class="koboSpan" id="kobo.1127.1">Chapter 5</span></a></em></span><span class="koboSpan" id="kobo.1128.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1129.1">Setting Up Isolated Penetration Testing Lab Environments on Azure</span></em><span class="koboSpan" id="kobo.1130.1">, when setting up the Kali Linux attacker machine) to access the </span><span class="No-Break"><span class="koboSpan" id="kobo.1131.1">desktop environment.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1132.1">Open a Terminal window inside the Kali Linux instance by clicking the icon highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1133.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1134.1">.25</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1135.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer283">
<span class="koboSpan" id="kobo.1136.1"><img alt="" src="image/B19755_08_25.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1137.1">Figure 8.25 — Opening a Terminal window</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1138.1">This should open</span><a id="_idIndexMarker1174"/><span class="koboSpan" id="kobo.1139.1"> a Terminal window where we can run commands after the </span><strong class="bold"><span class="koboSpan" id="kobo.1140.1">$</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1141.1">sign.</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1142.1">Now, let’s run the following commands to scan the VM instance that will serve as the domain </span><span class="No-Break"><span class="koboSpan" id="kobo.1143.1">controller (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1144.1">ad-domain-controller</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1145.1">):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1146.1">IP=10.0.1.4</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1147.1">nmap --top-ports 1000 -Pn $IP</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1148.1">Make sure you update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1149.1">IP</span></strong><span class="koboSpan" id="kobo.1150.1"> variable value with the actual private IP address of the first target VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1151.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.1152.1">). </span><span class="koboSpan" id="kobo.1152.2">Running this command should give us the </span><span class="No-Break"><span class="koboSpan" id="kobo.1153.1">following results:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer284">
<span class="koboSpan" id="kobo.1154.1"><img alt="" src="image/B19755_08_26.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1155.1">Figure 8.26 — Initial scan on the domain controller VM instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1156.1">Here, we can see that network traffic from the attacker machine (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1157.1">vm-kali</span></strong><span class="koboSpan" id="kobo.1158.1">) can reach the domain controller VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1159.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1160.1">ad-domain-controller</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1161.1">).</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1162.1">Next, let’s </span><a id="_idIndexMarker1175"/><span class="koboSpan" id="kobo.1163.1">run the following commands to perform a scan of the second target VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1164.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.1165.1">). </span><span class="koboSpan" id="kobo.1165.2">This will serve as the workstation that will be joined to the domain controller later in </span><span class="No-Break"><span class="koboSpan" id="kobo.1166.1">this chapter:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1167.1">IP=10.0.1.5</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1168.1">nmap --top-ports 1000 -Pn $IP</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1169.1">Again, make sure you update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1170.1">IP</span></strong><span class="koboSpan" id="kobo.1171.1"> variable value with the actual private IP address of the second target VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1172.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.1173.1">). </span><span class="koboSpan" id="kobo.1173.2">This should give us the </span><span class="No-Break"><span class="koboSpan" id="kobo.1174.1">following results:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer285">
<span class="koboSpan" id="kobo.1175.1"><img alt="" src="image/B19755_08_27.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1176.1">Figure 8.27 — Initial scan on the workstation machine (ad-workstation-machine)</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1177.1">Here, we can see that network traffic from the attacker machine (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1178.1">vm-kali</span></strong><span class="koboSpan" id="kobo.1179.1">) can reach the second </span><a id="_idIndexMarker1176"/><span class="koboSpan" id="kobo.1180.1">Windows VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1181.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1182.1">ad-workstation-machine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1183.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.1184.1">At this point, we have our Windows VM instances ready. </span><strong class="bold"><span class="koboSpan" id="kobo.1185.1">Note that these Windows VM instances do not have Active Directory set up yet!</span></strong><span class="koboSpan" id="kobo.1186.1"> In the next section, we will complete our lab environment and set up and (mis)configure Active Directory inside these Windows </span><span class="No-Break"><span class="koboSpan" id="kobo.1187.1">VM instances.</span></span></p></li>
</ol>
<h1 id="_idParaDest-175"><a id="_idTextAnchor175"/><span class="koboSpan" id="kobo.1188.1">Setting up and configuring the Active Directory lab</span></h1>
<p><span class="koboSpan" id="kobo.1189.1">In this section, we will set up the Active Directory domain controller, along with the workstation machine (which will be joined to the domain). </span><span class="koboSpan" id="kobo.1189.2">Before we proceed with the hands-on portion of this section, let’s discuss some of the relevant concepts and </span><span class="No-Break"><span class="koboSpan" id="kobo.1190.1">terminologies first:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1191.1">Domain</span></strong><span class="koboSpan" id="kobo.1192.1">: This </span><a id="_idIndexMarker1177"/><span class="koboSpan" id="kobo.1193.1">represents a logical group of network resources. </span><span class="koboSpan" id="kobo.1193.2">We can think of a domain as a virtual city with its own unique identity and infrastructure. </span><span class="koboSpan" id="kobo.1193.3">Just as a city groups together various neighborhoods, a domain logically groups network </span><span class="No-Break"><span class="koboSpan" id="kobo.1194.1">resources together.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1195.1">Domain controller</span></strong><span class="koboSpan" id="kobo.1196.1">: This</span><a id="_idIndexMarker1178"/><span class="koboSpan" id="kobo.1197.1"> is a server that’s responsible for providing authentication and authorization services for domain users and computers. </span><span class="koboSpan" id="kobo.1197.2">We can think of a domain controller as the city’s main security office that ensures only authorized individuals can access different parts of </span><span class="No-Break"><span class="koboSpan" id="kobo.1198.1">the city.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1199.1">Forest</span></strong><span class="koboSpan" id="kobo.1200.1">: This </span><a id="_idIndexMarker1179"/><span class="koboSpan" id="kobo.1201.1">represents the highest hierarchical level in Active Directory and contains multiple domains (along with other resources). </span><span class="koboSpan" id="kobo.1201.2">We can think of a forest as a region containing multiple cities where each city (domain) operates independently, but they all belong to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1202.1">same forest.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1203.1">Organizational unit</span></strong><span class="koboSpan" id="kobo.1204.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1205.1">OU</span></strong><span class="koboSpan" id="kobo.1206.1">): This </span><a id="_idIndexMarker1180"/><span class="koboSpan" id="kobo.1207.1">is a container within a domain that can be used to contain users, computers, and other objects. </span><span class="koboSpan" id="kobo.1207.2">We can think of an OU as a district within a city. </span><span class="koboSpan" id="kobo.1207.3">It’s like a container that’s used to organize and manage resources, similar to how districts categorize buildings </span><span class="No-Break"><span class="koboSpan" id="kobo.1208.1">and services.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1209.1">Object</span></strong><span class="koboSpan" id="kobo.1210.1">: This represents</span><a id="_idIndexMarker1181"/><span class="koboSpan" id="kobo.1211.1"> a single element or resource part of the Active Directory network (including user accounts, groups, and shared folders). </span><span class="koboSpan" id="kobo.1211.2">We can think of objects as the individual elements that make up a city (such as houses, businesses, </span><span class="No-Break"><span class="koboSpan" id="kobo.1212.1">and parks).</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.1213.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1214.1">Note that there are other Active Directory concepts we can explore and discuss (which we did not include here). </span><span class="koboSpan" id="kobo.1214.2">However, this should do the trick for now as an introduction to the fundamental concepts and components when working with </span><span class="No-Break"><span class="koboSpan" id="kobo.1215.1">Active Directory.</span></span></p>
<p><span class="koboSpan" id="kobo.1216.1">With some of the key concepts defined, let’s define and describe Active Directory. </span><span class="koboSpan" id="kobo.1216.2">As we can see, </span><strong class="bold"><span class="koboSpan" id="kobo.1217.1">Active Directory</span></strong><span class="koboSpan" id="kobo.1218.1"> is</span><a id="_idIndexMarker1182"/><span class="koboSpan" id="kobo.1219.1"> simply a </span><em class="italic"><span class="koboSpan" id="kobo.1220.1">directory service</span></em><span class="koboSpan" id="kobo.1221.1"> that’s designed to manage network resources and user accounts. </span><span class="koboSpan" id="kobo.1221.2">Just as a city’s administration manages various neighborhoods and resources, Active Directory centrally manages network elements, user identities, and access controls within a </span><span class="No-Break"><span class="koboSpan" id="kobo.1222.1">digital ecosystem.</span></span></p>
<p><span class="koboSpan" id="kobo.1223.1">Now that we have a better understanding of the key concepts for this section, we can proceed with setting up and (mis)configuring Active Directory inside the two Windows VM instances we launched in the previous section. </span><span class="koboSpan" id="kobo.1223.2">Given that setting up the Active Directory lab requires a relatively long sequence of steps, we will divide this section into </span><span class="No-Break"><span class="koboSpan" id="kobo.1224.1">12 parts:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.1225.1">Part 1 of 12 – Installing Active Directory </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1226.1">Domain Services</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1227.1">Part 2 of 12 – Promoting the VM instance to become the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1228.1">domain controller</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1229.1">Part 3 of 12 – Setting up Active Directory </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1230.1">Certificate Services</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1231.1">Part 4 of 12 – Configuring Active Directory </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1232.1">Certificate Services</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1233.1">Part 5 of 12 – Updating the trusted hosts configuration and enabling </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1234.1">PowerShell Remoting</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1235.1">Part 6 of 12 – Setting up the flag inside the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1236.1">domain controller</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1237.1">Part 7 of 12 – Creating the John </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1238.1">Doe user</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1239.1">Part 8 of 12 – Creating the Jane </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1240.1">Doe user</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1241.1">Part 9 of 12 – Creating the Service </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1242.1">Account user</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1243.1">Part 10 of 12 – Setting up the SPN for the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1244.1">service account</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1245.1">Part 11 of 12 – Adding the Service Account user to the Remote Management </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1246.1">Users group</span></em></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.1247.1">Part 12 of 12 – Configuring the </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1248.1">workstation machine</span></em></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1249.1">Without further ado, </span><span class="No-Break"><span class="koboSpan" id="kobo.1250.1">let’s begin!</span></span></p>
<h2 id="_idParaDest-176"><a id="_idTextAnchor176"/><span class="koboSpan" id="kobo.1251.1">Part 1 of 1 – Installing Active Directory Domain Services</span></h2>
<p><em class="italic"><span class="koboSpan" id="kobo.1252.1">Remember the RDP session we minimized in a previous section?</span></em><span class="koboSpan" id="kobo.1253.1"> Let’s use that session again as we will be</span><a id="_idIndexMarker1183"/><span class="koboSpan" id="kobo.1254.1"> installing </span><strong class="bold"><span class="koboSpan" id="kobo.1255.1">Active Directory Domain Services</span></strong><span class="koboSpan" id="kobo.1256.1"> inside the first VM </span><span class="No-Break"><span class="koboSpan" id="kobo.1257.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1258.1">ad-domain-controller</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1259.1">):</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1260.1">Make sure that you have the RDP session to the first VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1261.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.1262.1">) open before proceeding to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1263.1">next step.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1264.1">Note</span></p>
<p class="callout"><strong class="bold"><span class="koboSpan" id="kobo.1265.1">Active Directory</span></strong><span class="koboSpan" id="kobo.1266.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.1267.1">Active Directory Domain Services</span></strong><span class="koboSpan" id="kobo.1268.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1269.1">AD DS</span></strong><span class="koboSpan" id="kobo.1270.1">) are terms that are sometimes used </span><a id="_idIndexMarker1184"/><span class="koboSpan" id="kobo.1271.1">interchangeably. </span><span class="koboSpan" id="kobo.1271.2">However, while AD DS specifically refers to the core directory service component of Active Directory, it’s important to note that Active Directory (as a whole) encompasses a broader range of services and components than just </span><span class="No-Break"><span class="koboSpan" id="kobo.1272.1">AD DS.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1273.1">Go to </span><strong class="bold"><span class="koboSpan" id="kobo.1274.1">Server Manager</span></strong><span class="koboSpan" id="kobo.1275.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1276.1">Dashboard</span></strong><span class="koboSpan" id="kobo.1277.1"> and click </span><strong class="bold"><span class="koboSpan" id="kobo.1278.1">Add roles </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1279.1">and features</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1280.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer286">
<span class="koboSpan" id="kobo.1281.1"><img alt="" src="image/B19755_08_28.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1282.1">Figure 8.28 — Add roles and features</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1283.1">You can </span><a id="_idIndexMarker1185"/><span class="koboSpan" id="kobo.1284.1">find the </span><strong class="bold"><span class="koboSpan" id="kobo.1285.1">Add roles and features</span></strong><span class="koboSpan" id="kobo.1286.1"> link under </span><strong class="bold"><span class="koboSpan" id="kobo.1287.1">Configure this local server</span></strong><span class="koboSpan" id="kobo.1288.1"> (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1289.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1290.1">.28</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1291.1">).</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1292.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1293.1">Before you begin</span></strong><span class="koboSpan" id="kobo.1294.1"> tab, click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1295.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1296.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1297.1">Under </span><strong class="bold"><span class="koboSpan" id="kobo.1298.1">Installation Type</span></strong><span class="koboSpan" id="kobo.1299.1">, make sure that the </span><strong class="bold"><span class="koboSpan" id="kobo.1300.1">Role-based or feature-based installation</span></strong><span class="koboSpan" id="kobo.1301.1"> option is selected. </span><span class="koboSpan" id="kobo.1301.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1302.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1303.1">button after.</span></span></li>
<li><span class="koboSpan" id="kobo.1304.1">Under </span><strong class="bold"><span class="koboSpan" id="kobo.1305.1">Server Selection</span></strong><span class="koboSpan" id="kobo.1306.1">, make sure that the </span><strong class="bold"><span class="koboSpan" id="kobo.1307.1">Select a server from the server pool</span></strong><span class="koboSpan" id="kobo.1308.1"> option is selected before clicking </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1309.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1310.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1311.1">Under </span><strong class="bold"><span class="koboSpan" id="kobo.1312.1">Server Roles</span></strong><span class="koboSpan" id="kobo.1313.1">, toggle </span><em class="italic"><span class="koboSpan" id="kobo.1314.1">on</span></em><span class="koboSpan" id="kobo.1315.1"> (check) the </span><strong class="bold"><span class="koboSpan" id="kobo.1316.1">Active Directory Domain </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1317.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1318.1"> checkbox:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer287">
<span class="koboSpan" id="kobo.1319.1"><img alt="" src="image/B19755_08_29.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1320.1">Figure 8.29 — Server Roles</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1321.1">Find the</span><a id="_idIndexMarker1186"/><span class="koboSpan" id="kobo.1322.1"> checkbox highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1323.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1324.1">.29</span></em><span class="koboSpan" id="kobo.1325.1">. </span><span class="koboSpan" id="kobo.1325.2">Make sure you click the correct checkbox (that is, the checkbox corresponding to the </span><strong class="bold"><span class="koboSpan" id="kobo.1326.1">Active Directory Domain Services</span></strong><span class="koboSpan" id="kobo.1327.1"> option) since there are multiple options whose names start with “</span><span class="No-Break"><span class="koboSpan" id="kobo.1328.1">Active Directory”.</span></span></p></li>
</ol>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1329.1">Checking the checkbox from the previous step should open the </span><strong class="bold"><span class="koboSpan" id="kobo.1330.1">Add Roles and Features Wizard</span></strong><span class="koboSpan" id="kobo.1331.1"> area (similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1332.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1333.1">.30</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1334.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer288">
<span class="koboSpan" id="kobo.1335.1"><img alt="" src="image/B19755_08_30.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1336.1">Figure 8.30 — Add Features</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1337.1">Click</span><a id="_idIndexMarker1187"/><span class="koboSpan" id="kobo.1338.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.1339.1">Add Features</span></strong><span class="koboSpan" id="kobo.1340.1"> button (highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1341.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1342.1">.30</span></em><span class="koboSpan" id="kobo.1343.1">) and then click </span><strong class="bold"><span class="koboSpan" id="kobo.1344.1">Next &gt;</span></strong><span class="koboSpan" id="kobo.1345.1"> after (in the </span><strong class="bold"><span class="koboSpan" id="kobo.1346.1">Server </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1347.1">Roles</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1348.1"> tab).</span></span></p></li>
</ol>
<ol>
<li value="8"><span class="koboSpan" id="kobo.1349.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1350.1">Features</span></strong><span class="koboSpan" id="kobo.1351.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.1352.1">AD DS</span></strong><span class="koboSpan" id="kobo.1353.1"> tabs, click </span><strong class="bold"><span class="koboSpan" id="kobo.1354.1">Next &gt;</span></strong><span class="koboSpan" id="kobo.1355.1"> (twice) </span><span class="No-Break"><span class="koboSpan" id="kobo.1356.1">to proceed.</span></span></li>
<li><span class="koboSpan" id="kobo.1357.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1358.1">Confirmation</span></strong><span class="koboSpan" id="kobo.1359.1"> tab, </span><span class="No-Break"><span class="koboSpan" id="kobo.1360.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1361.1">Install</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1362.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer289">
<span class="koboSpan" id="kobo.1363.1"><img alt="" src="image/B19755_08_31.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1364.1">Figure 8.31 — Confirm installation selections</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1365.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1366.1">Close</span></strong><span class="koboSpan" id="kobo.1367.1"> button </span><a id="_idIndexMarker1188"/><span class="koboSpan" id="kobo.1368.1">once the installation has finished. </span><em class="italic"><span class="koboSpan" id="kobo.1369.1">Wasn’t that easy?</span></em> <strong class="bold"><span class="koboSpan" id="kobo.1370.1">At this point, we should have AD DS installed already!</span></strong><span class="koboSpan" id="kobo.1371.1"> Of course, we are not done yet as we will be working on other configuration steps in the succeeding parts of </span><span class="No-Break"><span class="koboSpan" id="kobo.1372.1">this section.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1373.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1374.1">This step may take 10 to 15 minutes to complete. </span><span class="koboSpan" id="kobo.1374.2">Feel free to grab a cup of coffee or tea </span><span class="No-Break"><span class="koboSpan" id="kobo.1375.1">while waiting!</span></span></p>
<h2 id="_idParaDest-177"><a id="_idTextAnchor177"/><span class="koboSpan" id="kobo.1376.1">Part 2 of 12 – Promoting the VM instance to become the domain controller</span></h2>
<p><span class="koboSpan" id="kobo.1377.1">Now, it’s</span><a id="_idIndexMarker1189"/><span class="koboSpan" id="kobo.1378.1"> time to promote the machine (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1379.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.1380.1">) so that it becomes the </span><span class="No-Break"><span class="koboSpan" id="kobo.1381.1">domain controller:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1382.1">Click</span><a id="_idIndexMarker1190"/><span class="koboSpan" id="kobo.1383.1"> the flag button (highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1384.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1385.1">.32</span></em><span class="koboSpan" id="kobo.1386.1">) and then click </span><strong class="bold"><span class="koboSpan" id="kobo.1387.1">Promote this server to a </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1388.1">domain controller</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1389.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer290">
<span class="koboSpan" id="kobo.1390.1"><img alt="" src="image/B19755_08_32.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1391.1">Figure 8.32 — Promoting the machine to a domain controller</span></p>
<p class="list-inset"><em class="italic"><span class="koboSpan" id="kobo.1392.1">What does it mean to be a domain controller?</span></em><span class="koboSpan" id="kobo.1393.1"> Once a server is promoted to a domain controller, it will be responsible for managing user authentication, authorization, and resource management within </span><span class="No-Break"><span class="koboSpan" id="kobo.1394.1">the network.</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1395.1">Under </span><strong class="bold"><span class="koboSpan" id="kobo.1396.1">Deployment Configuration</span></strong><span class="koboSpan" id="kobo.1397.1">, select </span><strong class="bold"><span class="koboSpan" id="kobo.1398.1">Add a </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1399.1">new forest</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1400.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer291">
<span class="koboSpan" id="kobo.1401.1"><img alt="" src="image/B19755_08_33.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1402.1">Figure 8.33 — Deployment Configuration</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1403.1">For </span><a id="_idIndexMarker1191"/><span class="koboSpan" id="kobo.1404.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.1405.1">Root domain name</span></strong><span class="koboSpan" id="kobo.1406.1"> value, specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.1407.1">domain.local</span></strong><span class="koboSpan" id="kobo.1408.1"> (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1409.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1410.1">.33</span></em><span class="koboSpan" id="kobo.1411.1">). </span><span class="koboSpan" id="kobo.1411.2">Click </span><strong class="bold"><span class="koboSpan" id="kobo.1412.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1413.1">after.</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1414.1">Under </span><strong class="bold"><span class="koboSpan" id="kobo.1415.1">Domain Controller Options</span></strong><span class="koboSpan" id="kobo.1416.1">, use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1417.1">Restore1234!!!</span></strong><span class="koboSpan" id="kobo.1418.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.1419.1">the password:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer292">
<span class="koboSpan" id="kobo.1420.1"><img alt="" src="image/B19755_08_34.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1421.1">Figure 8.34 — Deployment Controller Options</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1422.1">Make </span><a id="_idIndexMarker1192"/><span class="koboSpan" id="kobo.1423.1">sure you specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.1424.1">Restore1234!!!</span></strong><span class="koboSpan" id="kobo.1425.1"> for both the </span><strong class="bold"><span class="koboSpan" id="kobo.1426.1">Password</span></strong><span class="koboSpan" id="kobo.1427.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.1428.1">Confirm password</span></strong><span class="koboSpan" id="kobo.1429.1"> fields (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1430.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1431.1">.34</span></em><span class="koboSpan" id="kobo.1432.1">). </span><span class="koboSpan" id="kobo.1432.2">Leave everything else as-is before clicking </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1433.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1434.1">.</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1435.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1436.1">DNS Options</span></strong><span class="koboSpan" id="kobo.1437.1"> tab, click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1438.1">Next </span></strong></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1439.1">&gt;.</span></strong></span></li>
<li><span class="koboSpan" id="kobo.1440.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1441.1">Additional Options</span></strong><span class="koboSpan" id="kobo.1442.1"> tab, verify that the auto-populated </span><strong class="bold"><span class="koboSpan" id="kobo.1443.1">The NetBIOS domain name</span></strong><span class="koboSpan" id="kobo.1444.1"> field value </span><span class="No-Break"><span class="koboSpan" id="kobo.1445.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1446.1">DOMAIN</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1447.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer293">
<span class="koboSpan" id="kobo.1448.1"><img alt="" src="image/B19755_08_35.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1449.1">Figure 8.35 — Additional Options</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1450.1">Click </span><a id="_idIndexMarker1193"/><span class="koboSpan" id="kobo.1451.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.1452.1">Next &gt;</span></strong><span class="koboSpan" id="kobo.1453.1"> button after (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1454.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1455.1">.35</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1456.1">).</span></span></p></li>
</ol>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1457.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1458.1">Paths</span></strong><span class="koboSpan" id="kobo.1459.1"> tab, leave everything as-is and click the </span><strong class="bold"><span class="koboSpan" id="kobo.1460.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1461.1">button.</span></span></li>
<li><span class="koboSpan" id="kobo.1462.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1463.1">Review Options</span></strong><span class="koboSpan" id="kobo.1464.1"> tab, click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1465.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1466.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1467.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1468.1">Prerequisites Check</span></strong><span class="koboSpan" id="kobo.1469.1"> tab, click the </span><strong class="bold"><span class="koboSpan" id="kobo.1470.1">Install</span></strong><span class="koboSpan" id="kobo.1471.1"> button (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1472.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1473.1">.36</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1474.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer294">
<span class="koboSpan" id="kobo.1475.1"><img alt="" src="image/B19755_08_36.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1476.1">Figure 8.36 — Prerequisites Check</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1477.1">This</span><a id="_idIndexMarker1194"/><span class="koboSpan" id="kobo.1478.1"> step may take around 5 to 10 minutes to complete. </span><span class="koboSpan" id="kobo.1478.2">This will automatically reboot the Windows VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1479.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.1480.1">) and you will lose the RDP connection a few seconds after getting the </span><strong class="bold"><span class="koboSpan" id="kobo.1481.1">You’re about to be signed out</span></strong><span class="koboSpan" id="kobo.1482.1"> notification pop-up window. </span><span class="koboSpan" id="kobo.1482.2">Wait for around 5 minutes before proceeding with the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.1483.1">of steps.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1484.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1485.1">Do not worry – we can connect to the first Windows VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1486.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.1487.1">) via RDP again after a few minutes. </span><span class="koboSpan" id="kobo.1487.2">This time, we should be able to sign in using the domain credentials (as we’ll see in the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.1488.1">of steps)!</span></span></p>
<h2 id="_idParaDest-178"><a id="_idTextAnchor178"/><span class="koboSpan" id="kobo.1489.1">Part 3 of 12 – Setting up Active Directory Certificate Services</span></h2>
<p><span class="koboSpan" id="kobo.1490.1">Now, we will be</span><a id="_idIndexMarker1195"/><span class="koboSpan" id="kobo.1491.1"> setting up </span><strong class="bold"><span class="koboSpan" id="kobo.1492.1">Active Directory Certificate Services</span></strong><span class="koboSpan" id="kobo.1493.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1494.1">AD CS</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1495.1">):</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1496.1">Connect</span><a id="_idIndexMarker1196"/><span class="koboSpan" id="kobo.1497.1"> to the first Windows VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1498.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.1499.1">) via RDP again. </span><span class="koboSpan" id="kobo.1499.2">Simply use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1500.1">domain\admin_user</span></strong><span class="koboSpan" id="kobo.1501.1"> as the username and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1502.1">Windows1234!!!</span></strong><span class="koboSpan" id="kobo.1503.1"> as </span><span class="No-Break"><span class="koboSpan" id="kobo.1504.1">the password:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer295">
<span class="koboSpan" id="kobo.1505.1"><img alt="" src="image/B19755_08_37.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1506.1">Figure 8.37 — Enter Your User Account</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1507.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1508.1">Continue</span></strong><span class="koboSpan" id="kobo.1509.1"> button when you see the </span><strong class="bold"><span class="koboSpan" id="kobo.1510.1">You are connecting to the RDP </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1511.1">host...</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1512.1"> popup.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1513.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1514.1">You may need to wait for around 5 minutes before you can sign in and proceed to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1515.1">next step.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1516.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.1517.1">Add roles </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1518.1">and features</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1519.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer296">
<span class="koboSpan" id="kobo.1520.1"><img alt="" src="image/B19755_08_38.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1521.1">Figure 8.38 — Add roles and features</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1522.1">You</span><a id="_idIndexMarker1197"/><span class="koboSpan" id="kobo.1523.1"> can find the </span><strong class="bold"><span class="koboSpan" id="kobo.1524.1">Add roles and features</span></strong><span class="koboSpan" id="kobo.1525.1"> link under </span><strong class="bold"><span class="koboSpan" id="kobo.1526.1">Configure this local server</span></strong><span class="koboSpan" id="kobo.1527.1"> (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1528.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1529.1">.38</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1530.1">).</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1531.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1532.1">Before You Begin</span></strong><span class="koboSpan" id="kobo.1533.1"> tab, click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1534.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1535.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1536.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1537.1">Installation Type</span></strong><span class="koboSpan" id="kobo.1538.1"> tab, make sure that the </span><strong class="bold"><span class="koboSpan" id="kobo.1539.1">Role-based or feature-based installation</span></strong><span class="koboSpan" id="kobo.1540.1"> option is selected before clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.1541.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1542.1">button.</span></span></li>
<li><span class="koboSpan" id="kobo.1543.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1544.1">Server Selection</span></strong><span class="koboSpan" id="kobo.1545.1"> tab, leave everything as-is and then click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1546.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1547.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1548.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1549.1">Server Roles</span></strong><span class="koboSpan" id="kobo.1550.1"> tab, locate the checkbox corresponding to </span><strong class="bold"><span class="koboSpan" id="kobo.1551.1">Active Directory </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1552.1">Certificate Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1553.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer297">
<span class="koboSpan" id="kobo.1554.1"><img alt="" src="image/B19755_08_39.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1555.1">Figure 8.39 — Active Directory Certificate Services</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1556.1">Select (and check) </span><strong class="bold"><span class="koboSpan" id="kobo.1557.1">Active Directory Certificate Services</span></strong><span class="koboSpan" id="kobo.1558.1">, as</span><a id="_idIndexMarker1198"/><span class="koboSpan" id="kobo.1559.1"> highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1560.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1561.1">.39</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1562.1">.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1563.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1564.1">AD CS is a specific</span><a id="_idIndexMarker1199"/><span class="koboSpan" id="kobo.1565.1"> component of Active Directory that focuses on providing a </span><strong class="bold"><span class="koboSpan" id="kobo.1566.1">public key infrastructure</span></strong><span class="koboSpan" id="kobo.1567.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1568.1">PKI</span></strong><span class="koboSpan" id="kobo.1569.1">) for issuing and managing digital</span><a id="_idIndexMarker1200"/><span class="koboSpan" id="kobo.1570.1"> certificates. </span><span class="koboSpan" id="kobo.1570.2">Similar to AD DS, AD CS plays a crucial role in enhancing security within a network environment by enabling encryption, authentication, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1571.1">secure communication.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.1572.1">Checking the checkbox from the previous step should open the </span><strong class="bold"><span class="koboSpan" id="kobo.1573.1">Add Roles and Features Wizard</span></strong><span class="koboSpan" id="kobo.1574.1"> area. </span><span class="koboSpan" id="kobo.1574.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1575.1">Add Features</span></strong><span class="koboSpan" id="kobo.1576.1"> button and then click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1577.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1578.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1579.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1580.1">Features</span></strong><span class="koboSpan" id="kobo.1581.1"> tab, click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1582.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1583.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1584.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1585.1">AD CS</span></strong><span class="koboSpan" id="kobo.1586.1"> tab, click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1587.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1588.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1589.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1590.1">AD CS &gt; Role Services</span></strong><span class="koboSpan" id="kobo.1591.1"> tab, ensure the </span><strong class="bold"><span class="koboSpan" id="kobo.1592.1">Certification Authority</span></strong><span class="koboSpan" id="kobo.1593.1"> checkbox is </span><a id="_idIndexMarker1201"/><span class="koboSpan" id="kobo.1594.1">toggled </span><em class="italic"><span class="koboSpan" id="kobo.1595.1">on</span></em><span class="koboSpan" id="kobo.1596.1"> (checked). </span><span class="koboSpan" id="kobo.1596.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1597.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1598.1">button after:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer298">
<span class="koboSpan" id="kobo.1599.1"><img alt="" src="image/B19755_08_40.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1600.1">Figure 8.40 — AD CS &gt; Role Services</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1601.1">Other than making sure that the </span><strong class="bold"><span class="koboSpan" id="kobo.1602.1">Certification Authority</span></strong><span class="koboSpan" id="kobo.1603.1"> checkbox is checked, we can leave everything </span><span class="No-Break"><span class="koboSpan" id="kobo.1604.1">else as-is.</span></span></p></li>
</ol>
<ol>
<li value="11"><span class="koboSpan" id="kobo.1605.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1606.1">Confirmation</span></strong><span class="koboSpan" id="kobo.1607.1"> tab, check the </span><strong class="bold"><span class="koboSpan" id="kobo.1608.1">Restart the destination server automatically if </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1609.1">required</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1610.1"> checkbox:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer299">
<span class="koboSpan" id="kobo.1611.1"><img alt="" src="image/B19755_08_41.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1612.1">Figure 8.41 — Confirm installation selections</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1613.1">A pop-up window similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1614.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1615.1">.41</span></em><span class="koboSpan" id="kobo.1616.1"> will appear. </span><span class="No-Break"><span class="koboSpan" id="kobo.1617.1">Select </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1618.1">Yes</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1619.1">.</span></span></p></li>
</ol>
<ol>
<li value="12"><span class="koboSpan" id="kobo.1620.1">Click </span><a id="_idIndexMarker1202"/><span class="koboSpan" id="kobo.1621.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.1622.1">Install</span></strong><span class="koboSpan" id="kobo.1623.1"> button after. </span><span class="koboSpan" id="kobo.1623.2">Once the installation is complete, which will be after around 5 minutes (</span><strong class="bold"><span class="koboSpan" id="kobo.1624.1">Configuration required. </span><span class="koboSpan" id="kobo.1624.2">Installation succeeded on ad-domain-contr.domain.local</span></strong><span class="koboSpan" id="kobo.1625.1">), </span><span class="No-Break"><span class="koboSpan" id="kobo.1626.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1627.1">Close</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1628.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1629.1">Note</span></p>
<p class="callout"><strong class="bold"><span class="koboSpan" id="kobo.1630.1">At this point, we should have AD CS installed</span></strong><span class="koboSpan" id="kobo.1631.1">. </span><span class="koboSpan" id="kobo.1631.2">Similar to AD DS, we will have to work on a few more steps to configure what we </span><span class="No-Break"><span class="koboSpan" id="kobo.1632.1">just installed.</span></span></p>
<h2 id="_idParaDest-179"><a id="_idTextAnchor179"/><span class="koboSpan" id="kobo.1633.1">Part 4 of 12 – Configuring Active Directory Certificate Services</span></h2>
<p><span class="koboSpan" id="kobo.1634.1">Now, let’s </span><a id="_idIndexMarker1203"/><span class="koboSpan" id="kobo.1635.1">configure </span><span class="No-Break"><span class="koboSpan" id="kobo.1636.1">AD CS:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1637.1">Click the flag (with a warning sign) and select </span><strong class="bold"><span class="koboSpan" id="kobo.1638.1">Configure Active Directory Certificate Services on the destination server</span></strong><span class="koboSpan" id="kobo.1639.1"> (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1640.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1641.1">.42</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1642.1">):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer300">
<span class="koboSpan" id="kobo.1643.1"><img alt="" src="image/B19755_08_42.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1644.1">Figure 8.42 — Configure Active Directory Certificate Services on the destination server</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1645.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1646.1">Credentials</span></strong><span class="koboSpan" id="kobo.1647.1"> tab, click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1648.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1649.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer301">
<span class="koboSpan" id="kobo.1650.1"><img alt="" src="image/B19755_08_43.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1651.1">Figure 8.43 — The Credentials tab</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1652.1">Since </span><a id="_idIndexMarker1204"/><span class="koboSpan" id="kobo.1653.1">we won’t be modifying the currently set configuration in this tab, we can leave everything </span><span class="No-Break"><span class="koboSpan" id="kobo.1654.1">else as-is.</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1655.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1656.1">Role Services</span></strong><span class="koboSpan" id="kobo.1657.1"> tab, check </span><strong class="bold"><span class="koboSpan" id="kobo.1658.1">Certification Authority</span></strong><span class="koboSpan" id="kobo.1659.1">. </span><span class="koboSpan" id="kobo.1659.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1660.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1661.1">button after:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer302">
<span class="koboSpan" id="kobo.1662.1"><img alt="" src="image/B19755_08_44.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1663.1">Figure 8.44 — Select Role Services to configure</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1664.1">Other </span><a id="_idIndexMarker1205"/><span class="koboSpan" id="kobo.1665.1">than checking the first checkbox (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1666.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1667.1">.44</span></em><span class="koboSpan" id="kobo.1668.1">), we can leave everything </span><span class="No-Break"><span class="koboSpan" id="kobo.1669.1">else as-is.</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1670.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1671.1">Setup Type</span></strong><span class="koboSpan" id="kobo.1672.1"> tab, ensure </span><strong class="bold"><span class="koboSpan" id="kobo.1673.1">Enterprise CA</span></strong><span class="koboSpan" id="kobo.1674.1"> is selected. </span><span class="koboSpan" id="kobo.1674.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1675.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1676.1">button after.</span></span></li>
<li><span class="koboSpan" id="kobo.1677.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1678.1">CA Type</span></strong><span class="koboSpan" id="kobo.1679.1"> tab, ensure </span><strong class="bold"><span class="koboSpan" id="kobo.1680.1">Root CA</span></strong><span class="koboSpan" id="kobo.1681.1"> is selected and then click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1682.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1683.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1684.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1685.1">Private Key</span></strong><span class="koboSpan" id="kobo.1686.1"> tab, ensure </span><strong class="bold"><span class="koboSpan" id="kobo.1687.1">Create a new private key</span></strong><span class="koboSpan" id="kobo.1688.1"> is selected and then click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1689.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1690.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1691.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1692.1">Cryptography</span></strong><span class="koboSpan" id="kobo.1693.1"> tab, leave everything else as-is and then click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1694.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1695.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1696.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1697.1">CA Name</span></strong><span class="koboSpan" id="kobo.1698.1"> tab, click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1699.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1700.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1701.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1702.1">Validity Period</span></strong><span class="koboSpan" id="kobo.1703.1"> tab, click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1704.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1705.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1706.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1707.1">Certificate Locations</span></strong><span class="koboSpan" id="kobo.1708.1"> tab, click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1709.1">Next &gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1710.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1711.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1712.1">Confirmation</span></strong><span class="koboSpan" id="kobo.1713.1"> tab, </span><span class="No-Break"><span class="koboSpan" id="kobo.1714.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1715.1">Configure</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1716.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1717.1">In</span><a id="_idIndexMarker1206"/><span class="koboSpan" id="kobo.1718.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.1719.1">Results</span></strong><span class="koboSpan" id="kobo.1720.1"> tab, </span><span class="No-Break"><span class="koboSpan" id="kobo.1721.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1722.1">Close</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1723.1">.</span></span></li>
</ol>
<h2 id="_idParaDest-180"><a id="_idTextAnchor180"/><span class="koboSpan" id="kobo.1724.1">Part 5 of 12 – Updating the trusted hosts configuration and enabling PowerShell Remoting</span></h2>
<p><span class="koboSpan" id="kobo.1725.1">Now that we</span><a id="_idIndexMarker1207"/><span class="koboSpan" id="kobo.1726.1"> have successfully configured AD CS, let’s quickly update the</span><a id="_idIndexMarker1208"/><span class="koboSpan" id="kobo.1727.1"> trusted hosts configuration and enable </span><span class="No-Break"><span class="koboSpan" id="kobo.1728.1">PowerShell Remoting:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1729.1">Let’s start by clicking the Windows icon (located in the lower left corner of </span><span class="No-Break"><span class="koboSpan" id="kobo.1730.1">the screen):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer303">
<span class="koboSpan" id="kobo.1731.1"><img alt="" src="image/B19755_08_45.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1732.1">Figure 8.45 — Opening Windows PowerShell</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1733.1">Locate and select </span><strong class="bold"><span class="koboSpan" id="kobo.1734.1">Windows PowerShell</span></strong><span class="koboSpan" id="kobo.1735.1">, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1736.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1737.1">.45</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1738.1">.</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="No-Break"><span class="koboSpan" id="kobo.1739.1">Run </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1740.1">Enable-PsRemoting</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1741.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1742.1">Enable-PsRemoting -force</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1743.1">Here, we</span><a id="_idIndexMarker1209"/><span class="koboSpan" id="kobo.1744.1"> are enabling </span><strong class="bold"><span class="koboSpan" id="kobo.1745.1">PowerShell Remoting</span></strong><span class="koboSpan" id="kobo.1746.1">, a feature </span><a id="_idIndexMarker1210"/><span class="koboSpan" id="kobo.1747.1">that allows remote access to execute PowerShell commands and scripts on </span><span class="No-Break"><span class="koboSpan" id="kobo.1748.1">a computer.</span></span></p></li> <li><span class="koboSpan" id="kobo.1749.1">Let’s run the following to verify that port </span><strong class="source-inline"><span class="koboSpan" id="kobo.1750.1">5985</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1751.1">is listening:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1752.1">netstat -noa | Select-String "Listen"</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1753.1">This should return the </span><span class="No-Break"><span class="koboSpan" id="kobo.1754.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1755.1">...
</span><span class="koboSpan" id="kobo.1755.2">TCP  0.0.0.0:5985    0.0.0.0    LISTENING ...
</span><span class="koboSpan" id="kobo.1755.3">...</span></pre></li> <li><span class="koboSpan" id="kobo.1756.1">Update the trusted hosts configuration by running </span><span class="No-Break"><span class="koboSpan" id="kobo.1757.1">the following:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1758.1">Set-Item WSMan:localhost\client\trustedhosts -Value *</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1759.1">When asked if you want to modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1760.1">TrustedHosts</span></strong><span class="koboSpan" id="kobo.1761.1"> list for the WinRM client, </span><span class="No-Break"><span class="koboSpan" id="kobo.1762.1">enter </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1763.1">Y</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1764.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.1765.1">Verify that the previous command worked by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.1766.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1767.1">Get-Item WSMan:\localhost\Client\TrustedHosts</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1768.1">This should confirm that the configuration value has been successfully updated </span><span class="No-Break"><span class="koboSpan" id="kobo.1769.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1770.1">*</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1771.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.1772.1">Run the following command to modify the firewall rule to allow incoming </span><span class="No-Break"><span class="koboSpan" id="kobo.1773.1">WinRM traffic:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1774.1">Set-NetFirewallRule -Name "WINRM-HTTP-In-TCP-PUBLIC" -RemoteAddress Any</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1775.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1776.1">At this point, we have updated the trusted hosts configuration to allow connections from any host (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1777.1">*</span></strong><span class="koboSpan" id="kobo.1778.1">). </span><span class="koboSpan" id="kobo.1778.2">In addition to this, we have modified the firewall rule to allow incoming WinRM (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1779.1">port </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1780.1">5985</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1781.1">) traffic.</span></span></p>
<h2 id="_idParaDest-181"><a id="_idTextAnchor181"/><span class="koboSpan" id="kobo.1782.1">Part 6 of 12 – Setting up the flag inside the domain controller</span></h2>
<p><span class="koboSpan" id="kobo.1783.1">Continuing where we</span><a id="_idIndexMarker1211"/><span class="koboSpan" id="kobo.1784.1"> left off in the previous part, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1785.1">these </span></span><span class="No-Break"><a id="_idIndexMarker1212"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1786.1">steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1787.1">Let’s navigate to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1788.1">C:\</span></strong><span class="koboSpan" id="kobo.1789.1"> by running the following commands in the terminal (one line at </span><span class="No-Break"><span class="koboSpan" id="kobo.1790.1">a time):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1791.1">cd ..</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1792.1">cd ..</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1793.1">dir</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1794.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1795.1">flag.txt</span></strong><span class="koboSpan" id="kobo.1796.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1797.1">inside </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1798.1">C:\</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1799.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1800.1">echo "FLAG!" </span><span class="koboSpan" id="kobo.1800.2">&gt; flag.txt</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1801.1">Restart the VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1802.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.1803.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.1804.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1805.1">Restart-Computer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1806.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1807.1">Restart-Computer</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1808.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1809.1">Wait for 3 to 5 minutes for the VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1810.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.1811.1">) to complete the restart operation. </span><span class="koboSpan" id="kobo.1811.2">Feel free to grab a cup of coffee or tea </span><span class="No-Break"><span class="koboSpan" id="kobo.1812.1">while waiting!</span></span></p>
<h2 id="_idParaDest-182"><a id="_idTextAnchor182"/><span class="koboSpan" id="kobo.1813.1">Part 7 of 12 – Creating the John Doe user</span></h2>
<p><span class="koboSpan" id="kobo.1814.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1815.1">these steps:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.1816.1">Connect to the first </span><a id="_idIndexMarker1213"/><span class="koboSpan" id="kobo.1817.1">VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1818.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.1819.1">) via RDP again. </span><span class="koboSpan" id="kobo.1819.2">Simply use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1820.1">domain\admin_user</span></strong><span class="koboSpan" id="kobo.1821.1"> as the username and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1822.1">Windows1234!!!</span></strong><span class="koboSpan" id="kobo.1823.1"> as </span><span class="No-Break"><span class="koboSpan" id="kobo.1824.1">the password:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer304">
<span class="koboSpan" id="kobo.1825.1"><img alt="" src="image/B19755_08_37.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1826.1">Figure 8.46 — Enter Your User Account</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1827.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1828.1">Continue</span></strong><span class="koboSpan" id="kobo.1829.1"> button</span><a id="_idIndexMarker1214"/><span class="koboSpan" id="kobo.1830.1"> when you see the </span><strong class="bold"><span class="koboSpan" id="kobo.1831.1">You are connecting to the RDP </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1832.1">host...</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1833.1"> popup.</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1834.1">Under </span><strong class="bold"><span class="koboSpan" id="kobo.1835.1">Server Manager</span></strong><span class="koboSpan" id="kobo.1836.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1837.1">Dashboard</span></strong><span class="koboSpan" id="kobo.1838.1">, click </span><strong class="bold"><span class="koboSpan" id="kobo.1839.1">Tools</span></strong><span class="koboSpan" id="kobo.1840.1"> (the top right-hand corner of the window) and then select </span><strong class="bold"><span class="koboSpan" id="kobo.1841.1">Active Directory Users and Computers</span></strong><span class="koboSpan" id="kobo.1842.1"> from the list of </span><span class="No-Break"><span class="koboSpan" id="kobo.1843.1">options available:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer305">
<span class="koboSpan" id="kobo.1844.1"><img alt="" src="image/B19755_08_47.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1845.1">Figure 8.47 — Active Directory Users and Computers</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1846.1">Make sure you</span><a id="_idIndexMarker1215"/><span class="koboSpan" id="kobo.1847.1"> select the correct option from the multiple options available (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1848.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1849.1">.47</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1850.1">).</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1851.1">In </span><strong class="bold"><span class="koboSpan" id="kobo.1852.1">Active Directory Users and Computers</span></strong><span class="koboSpan" id="kobo.1853.1">, expand </span><strong class="bold"><span class="koboSpan" id="kobo.1854.1">domain.local</span></strong><span class="koboSpan" id="kobo.1855.1"> (in the tree) and then right-click </span><span class="No-Break"><span class="koboSpan" id="kobo.1856.1">on </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1857.1">Users</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1858.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer306">
<span class="koboSpan" id="kobo.1859.1"><img alt="" src="image/B19755_08_48.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1860.1">Figure 8.48 — Users &gt; New &gt; User</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1861.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.1862.1">New</span></strong><span class="koboSpan" id="kobo.1863.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1864.1">User</span></strong><span class="koboSpan" id="kobo.1865.1"> from the context menu (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1866.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1867.1">.48</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1868.1">).</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1869.1">Using the </span><strong class="bold"><span class="koboSpan" id="kobo.1870.1">New Object - User</span></strong><span class="koboSpan" id="kobo.1871.1"> window, let’s create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1872.1">John Doe</span></strong><span class="koboSpan" id="kobo.1873.1"> (</span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1874.1">johndoe</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1875.1">) user:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer307">
<span class="koboSpan" id="kobo.1876.1"><img alt="" src="image/B19755_08_49.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1877.1">Figure 8.49 — Creating a new user (John Doe)</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1878.1">Here, we must </span><a id="_idIndexMarker1216"/><span class="koboSpan" id="kobo.1879.1">specify the following field values: </span><strong class="bold"><span class="koboSpan" id="kobo.1880.1">First name</span></strong><span class="koboSpan" id="kobo.1881.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.1882.1">John</span></strong><span class="koboSpan" id="kobo.1883.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1884.1">Last name</span></strong><span class="koboSpan" id="kobo.1885.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.1886.1">Doe</span></strong><span class="koboSpan" id="kobo.1887.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1888.1">Full name</span></strong><span class="koboSpan" id="kobo.1889.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.1890.1">John Doe</span></strong><span class="koboSpan" id="kobo.1891.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.1892.1">User logon name</span></strong><span class="koboSpan" id="kobo.1893.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.1894.1">johndoe</span></strong><span class="koboSpan" id="kobo.1895.1">. </span><span class="koboSpan" id="kobo.1895.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1896.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1897.1">button after.</span></span></p></li>
</ol>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1898.1">Now, let’s configure the password settings for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1899.1">John Doe</span></strong><span class="koboSpan" id="kobo.1900.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1901.1">johndoe</span></strong><span class="koboSpan" id="kobo.1902.1">) user. </span><span class="koboSpan" id="kobo.1902.2">Set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1903.1">Passw0rd</span></strong><span class="koboSpan" id="kobo.1904.1"> as the password (for both the </span><strong class="bold"><span class="koboSpan" id="kobo.1905.1">Password</span></strong><span class="koboSpan" id="kobo.1906.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.1907.1">Confirm </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1908.1">password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1909.1"> fields):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer308">
<span class="koboSpan" id="kobo.1910.1"><img alt="" src="image/B19755_08_50.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1911.1">Figure 8.50 — Setting a password</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1912.1">Uncheck </span><strong class="bold"><span class="koboSpan" id="kobo.1913.1">User must change password at next logon</span></strong><span class="koboSpan" id="kobo.1914.1"> and then check </span><strong class="bold"><span class="koboSpan" id="kobo.1915.1">Password never expires</span></strong><span class="koboSpan" id="kobo.1916.1">, similar </span><a id="_idIndexMarker1217"/><span class="koboSpan" id="kobo.1917.1">to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1918.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1919.1">.50</span></em><span class="koboSpan" id="kobo.1920.1">. </span><span class="koboSpan" id="kobo.1920.2">After that, click the </span><strong class="bold"><span class="koboSpan" id="kobo.1921.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1922.1">button.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1923.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1924.1">Here, we have specified </span><strong class="source-inline"><span class="koboSpan" id="kobo.1925.1">Passw0rd</span></strong><span class="koboSpan" id="kobo.1926.1"> as the password with a capital </span><strong class="source-inline"><span class="koboSpan" id="kobo.1927.1">P</span></strong><span class="koboSpan" id="kobo.1928.1"> and a zero (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1929.1">0</span></strong><span class="koboSpan" id="kobo.1930.1">) instead of a letter, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1931.1">o</span></strong><span class="koboSpan" id="kobo.1932.1">. </span><span class="koboSpan" id="kobo.1932.2">Note that these types of passwords are relatively common due to their simplicity and the false sense of security they provide. </span><span class="koboSpan" id="kobo.1932.3">Unfortunately, using minor variations of common words or phrases, such as replacing letters with numbers or using easily guessable patterns such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1933.1">P@ssw0rd</span></strong><span class="koboSpan" id="kobo.1934.1"> (with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1935.1">@</span></strong><span class="koboSpan" id="kobo.1936.1"> instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1937.1">a</span></strong><span class="koboSpan" id="kobo.1938.1">), does not significantly </span><span class="No-Break"><span class="koboSpan" id="kobo.1939.1">enhance security.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1940.1">Click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1941.1">Finish</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1942.1"> after.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1943.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1944.1">At this point, we should have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1945.1">John Doe</span></strong><span class="koboSpan" id="kobo.1946.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1947.1">johndoe</span></strong><span class="koboSpan" id="kobo.1948.1">) user created. </span><span class="koboSpan" id="kobo.1948.2">As you can see, it’s relatively straightforward to create new users since we have a user interface to assist us during the </span><span class="No-Break"><span class="koboSpan" id="kobo.1949.1">creation process.</span></span></p>
<h2 id="_idParaDest-183"><a id="_idTextAnchor183"/><span class="koboSpan" id="kobo.1950.1">Part 8 of 12 – Creating the Jane Doe user</span></h2>
<p><span class="koboSpan" id="kobo.1951.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1952.1">these steps:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.1953.1">Let’s create another</span><a id="_idIndexMarker1218"/><span class="koboSpan" id="kobo.1954.1"> user. </span><span class="koboSpan" id="kobo.1954.2">Right-click </span><span class="No-Break"><span class="koboSpan" id="kobo.1955.1">on </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1956.1">Users</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1957.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer309">
<span class="koboSpan" id="kobo.1958.1"><img alt="" src="image/B19755_08_51.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1959.1">Figure 8.51 — New &gt; User</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1960.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.1961.1">New</span></strong><span class="koboSpan" id="kobo.1962.1"> &gt; </span><strong class="bold"><span class="koboSpan" id="kobo.1963.1">User</span></strong><span class="koboSpan" id="kobo.1964.1"> from the list of options available in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1965.1">context menu.</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1966.1">This time, we will be creating the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1967.1">Jane Doe</span></strong><span class="koboSpan" id="kobo.1968.1"> (</span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1969.1">janedoe</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1970.1">) user:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer310">
<span class="koboSpan" id="kobo.1971.1"><img alt="" src="image/B19755_08_52.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1972.1">Figure 8.52 — Creating Jane Doe</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1973.1">Here, we must </span><a id="_idIndexMarker1219"/><span class="koboSpan" id="kobo.1974.1">specify the following field values: </span><strong class="bold"><span class="koboSpan" id="kobo.1975.1">First name</span></strong><span class="koboSpan" id="kobo.1976.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.1977.1">Jane</span></strong><span class="koboSpan" id="kobo.1978.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1979.1">Last name</span></strong><span class="koboSpan" id="kobo.1980.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.1981.1">Doe</span></strong><span class="koboSpan" id="kobo.1982.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1983.1">Full name</span></strong><span class="koboSpan" id="kobo.1984.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.1985.1">Jane Doe</span></strong><span class="koboSpan" id="kobo.1986.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.1987.1">User logon name</span></strong><span class="koboSpan" id="kobo.1988.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.1989.1">janedoe</span></strong><span class="koboSpan" id="kobo.1990.1">. </span><span class="koboSpan" id="kobo.1990.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1991.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1992.1">button after.</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1993.1">Now, let’s configure the password settings for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1994.1">Jane Doe</span></strong><span class="koboSpan" id="kobo.1995.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1996.1">janedoe</span></strong><span class="koboSpan" id="kobo.1997.1">) user. </span><span class="koboSpan" id="kobo.1997.2">Set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1998.1">Passw0rd</span></strong><span class="koboSpan" id="kobo.1999.1"> as the password (for both the </span><strong class="bold"><span class="koboSpan" id="kobo.2000.1">Password</span></strong><span class="koboSpan" id="kobo.2001.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.2002.1">Confirm </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2003.1">password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2004.1"> fields):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer311">
<span class="koboSpan" id="kobo.2005.1"><img alt="" src="image/B19755_08_53.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2006.1">Figure 8.53 — Configuring the password settings</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2007.1">Let’s also </span><a id="_idIndexMarker1220"/><span class="koboSpan" id="kobo.2008.1">uncheck </span><strong class="bold"><span class="koboSpan" id="kobo.2009.1">User must change password at next logon</span></strong><span class="koboSpan" id="kobo.2010.1">. </span><span class="koboSpan" id="kobo.2010.2">Check </span><strong class="bold"><span class="koboSpan" id="kobo.2011.1">User cannot change password</span></strong><span class="koboSpan" id="kobo.2012.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.2013.1">Password never expires</span></strong><span class="koboSpan" id="kobo.2014.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.2015.1">Account is disabled</span></strong><span class="koboSpan" id="kobo.2016.1"> (similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2017.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2018.1">.53</span></em><span class="koboSpan" id="kobo.2019.1">). </span><span class="koboSpan" id="kobo.2019.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2020.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2021.1">button after.</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="No-Break"><span class="koboSpan" id="kobo.2022.1">Click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2023.1">Finish</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2024.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2025.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2026.1">At this point, we should have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2027.1">Jane Doe</span></strong><span class="koboSpan" id="kobo.2028.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2029.1">janedoe</span></strong><span class="koboSpan" id="kobo.2030.1">) user created. </span><span class="koboSpan" id="kobo.2030.2">When building penetration testing lab environments, we must have “dummy” resources to make the lab setup mimic real-world environments. </span><span class="koboSpan" id="kobo.2030.3">That said, we have the option to create as many user entities </span><span class="No-Break"><span class="koboSpan" id="kobo.2031.1">as possible.</span></span></p>
<h2 id="_idParaDest-184"><a id="_idTextAnchor184"/><span class="koboSpan" id="kobo.2032.1">Part 9 of 12 – Creating the Service Account user</span></h2>
<p><span class="koboSpan" id="kobo.2033.1">Now, let’s</span><a id="_idIndexMarker1221"/><span class="koboSpan" id="kobo.2034.1"> create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2035.1">Service Account</span></strong><span class="koboSpan" id="kobo.2036.1"> user (with </span><span class="No-Break"><span class="koboSpan" id="kobo.2037.1">administrator-level permissions):</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2038.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.2039.1">Users</span></strong><span class="koboSpan" id="kobo.2040.1"> (from the tree) and then locate </span><strong class="bold"><span class="koboSpan" id="kobo.2041.1">admin_user</span></strong><span class="koboSpan" id="kobo.2042.1"> from the list </span><span class="No-Break"><span class="koboSpan" id="kobo.2043.1">of users:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer312">
<span class="koboSpan" id="kobo.2044.1"><img alt="" src="image/B19755_08_54.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2045.1">Figure 8.54 — Copying admin_user</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2046.1">Right-click</span><a id="_idIndexMarker1222"/><span class="koboSpan" id="kobo.2047.1"> on </span><strong class="bold"><span class="koboSpan" id="kobo.2048.1">admin_user</span></strong><span class="koboSpan" id="kobo.2049.1"> and then select </span><strong class="bold"><span class="koboSpan" id="kobo.2050.1">Copy...</span></strong><span class="koboSpan" id="kobo.2051.1"> (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2052.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2053.1">.54</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2054.1">).</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.2055.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.2056.1">Copy Object - User</span></strong><span class="koboSpan" id="kobo.2057.1"> window, specify the following field values to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2058.1">Service </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2059.1">Account</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2060.1"> user:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer313">
<span class="koboSpan" id="kobo.2061.1"><img alt="" src="image/B19755_08_55.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2062.1">Figure 8.55 — Creating a Service Account user</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2063.1">Here, we</span><a id="_idIndexMarker1223"/><span class="koboSpan" id="kobo.2064.1"> must specify the following field values: </span><strong class="bold"><span class="koboSpan" id="kobo.2065.1">First name</span></strong><span class="koboSpan" id="kobo.2066.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.2067.1">Service</span></strong><span class="koboSpan" id="kobo.2068.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.2069.1">Last name</span></strong><span class="koboSpan" id="kobo.2070.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.2071.1">Account</span></strong><span class="koboSpan" id="kobo.2072.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.2073.1">Full name</span></strong><span class="koboSpan" id="kobo.2074.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.2075.1">Service Account</span></strong><span class="koboSpan" id="kobo.2076.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.2077.1">User logon name</span></strong><span class="koboSpan" id="kobo.2078.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.2079.1">service_account</span></strong><span class="koboSpan" id="kobo.2080.1">. </span><span class="koboSpan" id="kobo.2080.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2081.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2082.1">button after.</span></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2083.1">Now, let’s configure the password settings for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2084.1">Service Account</span></strong><span class="koboSpan" id="kobo.2085.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2086.1">service_account</span></strong><span class="koboSpan" id="kobo.2087.1">) user. </span><span class="koboSpan" id="kobo.2087.2">Set </span><strong class="source-inline"><span class="koboSpan" id="kobo.2088.1">Passw0rd</span></strong><span class="koboSpan" id="kobo.2089.1"> as the password (for both the </span><strong class="bold"><span class="koboSpan" id="kobo.2090.1">Password</span></strong><span class="koboSpan" id="kobo.2091.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.2092.1">Confirm </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2093.1">password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2094.1"> fields):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer314">
<span class="koboSpan" id="kobo.2095.1"><img alt="" src="image/B19755_08_56.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2096.1">Figure 8.56 — Specifying the password for the Service Account user</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2097.1">Let’s also </span><a id="_idIndexMarker1224"/><span class="koboSpan" id="kobo.2098.1">make sure that </span><strong class="bold"><span class="koboSpan" id="kobo.2099.1">User must change password at next logon</span></strong><span class="koboSpan" id="kobo.2100.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.2101.1">User cannot change password</span></strong><span class="koboSpan" id="kobo.2102.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.2103.1">Password never expires</span></strong><span class="koboSpan" id="kobo.2104.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.2105.1">Account is disabled</span></strong><span class="koboSpan" id="kobo.2106.1"> are all unchecked (similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2107.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2108.1">.56</span></em><span class="koboSpan" id="kobo.2109.1">). </span><span class="koboSpan" id="kobo.2109.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2110.1">Next &gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2111.1">button after.</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="No-Break"><span class="koboSpan" id="kobo.2112.1">Click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2113.1">Finish</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2114.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2115.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2116.1">User accounts in Active Directory are meant for individual human users. </span><span class="koboSpan" id="kobo.2116.2">These accounts allow them to access resources and perform tasks within the network. </span><span class="koboSpan" id="kobo.2116.3">Service accounts, on the other hand, are used by applications and services to interact with resources without the need to rely on </span><span class="No-Break"><span class="koboSpan" id="kobo.2117.1">user credentials.</span></span></p>
<h2 id="_idParaDest-185"><a id="_idTextAnchor185"/><span class="koboSpan" id="kobo.2118.1">Part 10 of 12 – Setting up the SPN for the service account</span></h2>
<p><span class="koboSpan" id="kobo.2119.1">Wait – there’s more! </span><span class="koboSpan" id="kobo.2119.2">We’ll</span><a id="_idIndexMarker1225"/><span class="koboSpan" id="kobo.2120.1"> now configure the </span><strong class="bold"><span class="koboSpan" id="kobo.2121.1">Service Principal Name</span></strong><span class="koboSpan" id="kobo.2122.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.2123.1">SPN</span></strong><span class="koboSpan" id="kobo.2124.1">) for the service account we created in the previous step. </span><span class="koboSpan" id="kobo.2124.2">SPNs are identifiers that are used in Active Directory to associate services with service accounts and enable authentication for secure communication. </span><span class="koboSpan" id="kobo.2124.3">By using SPNs to map a service instance to a service sign-in account, client applications gain the ability to request service authentication for that account, even if the client itself doesn’t possess the </span><span class="No-Break"><span class="koboSpan" id="kobo.2125.1">account name:</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.2126.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2127.1">Later, in the </span><em class="italic"><span class="koboSpan" id="kobo.2128.1">Simulating penetration testing in the lab environment</span></em><span class="koboSpan" id="kobo.2129.1"> section of this chapter, we’ll see how the (mis)configurations involving the SPNs of service accounts allow an attacker to abuse the authentication protocol. </span><span class="koboSpan" id="kobo.2129.2">For more information about SPNs, feel free to check </span><span class="No-Break"><span class="koboSpan" id="kobo.2130.1">out </span></span><a href="https://learn.microsoft.com/en-us/windows/win32/ad/service-principal-names"><span class="No-Break"><span class="koboSpan" id="kobo.2131.1">https://learn.microsoft.com/en-us/windows/win32/ad/service-principal-names</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2132.1">.</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2133.1">When you are ready, open a </span><strong class="bold"><span class="koboSpan" id="kobo.2134.1">Windows </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2135.1">PowerShell</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2136.1"> window:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer315">
<span class="koboSpan" id="kobo.2137.1"><img alt="" src="image/B19755_08_57.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2138.1">Figure 8.57 — Opening Windows PowerShell</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2139.1">This will</span><a id="_idIndexMarker1226"/><span class="koboSpan" id="kobo.2140.1"> open a PowerShell window where we will set up the SPN for the service account (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2141.1">service_account</span></strong><span class="koboSpan" id="kobo.2142.1">) in the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.2143.1">of steps.</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.2144.1">Let’s get the hostname of the </span><span class="No-Break"><span class="koboSpan" id="kobo.2145.1">domain controller:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2146.1">hostname</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2147.1">This should </span><span class="No-Break"><span class="koboSpan" id="kobo.2148.1">return </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2149.1">ad-domain-contr</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2150.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.2151.1">Add the specified SPN </span><span class="No-Break"><span class="koboSpan" id="kobo.2152.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2153.1">domain\service_account</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2154.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2155.1">setspn -S ad-domain-contr/service_account.domain.local:5000 domain\service_account</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2156.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.2157.1">following output:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2158.1">...
</span><span class="koboSpan" id="kobo.2158.2">Updated object</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2159.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2160.1">Feel free to validate this using </span><strong class="source-inline"><span class="koboSpan" id="kobo.2161.1">setspn -T domain.local -</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2162.1">Q */*</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2163.1">.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.2164.1">Close the</span><a id="_idIndexMarker1227"/> <span class="No-Break"><span class="koboSpan" id="kobo.2165.1">PowerShell window.</span></span></li>
</ol>
<h2 id="_idParaDest-186"><a id="_idTextAnchor186"/><span class="koboSpan" id="kobo.2166.1">Part 11 of 12 – Adding the Service Account user to the Remote Management Users group</span></h2>
<p><span class="koboSpan" id="kobo.2167.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.2168.1">these steps:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.2169.1">Navigate</span><a id="_idIndexMarker1228"/><span class="koboSpan" id="kobo.2170.1"> back to the </span><strong class="bold"><span class="koboSpan" id="kobo.2171.1">Active Directory Users and Computers</span></strong><span class="koboSpan" id="kobo.2172.1"> window and locate the </span><strong class="bold"><span class="koboSpan" id="kobo.2173.1">Service Account</span></strong><span class="koboSpan" id="kobo.2174.1"> user </span><span class="No-Break"><span class="koboSpan" id="kobo.2175.1">inside </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2176.1">Users</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2177.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2178.1">Double-click </span><strong class="bold"><span class="koboSpan" id="kobo.2179.1">Service Account</span></strong><span class="koboSpan" id="kobo.2180.1"> to open </span><strong class="bold"><span class="koboSpan" id="kobo.2181.1">Service Account Properties</span></strong><span class="koboSpan" id="kobo.2182.1">. </span><span class="koboSpan" id="kobo.2182.2">Go to the </span><strong class="bold"><span class="koboSpan" id="kobo.2183.1">Member Of</span></strong><span class="koboSpan" id="kobo.2184.1"> tab (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2185.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2186.1">.58</span></em><span class="koboSpan" id="kobo.2187.1">). </span><span class="koboSpan" id="kobo.2187.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2188.1">Add</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2189.1">button after:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer316">
<span class="koboSpan" id="kobo.2190.1"><img alt="" src="image/B19755_08_58.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2191.1">Figure 8.58 — Service Account Properties</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2192.1">Here, you </span><a id="_idIndexMarker1229"/><span class="koboSpan" id="kobo.2193.1">can see that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2194.1">Service Account</span></strong><span class="koboSpan" id="kobo.2195.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2196.1">service_account</span></strong><span class="koboSpan" id="kobo.2197.1">) user is a member of various groups, including the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2198.1">Administrators</span></strong><span class="koboSpan" id="kobo.2199.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2200.1">Domain Admins</span></strong><span class="koboSpan" id="kobo.2201.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2202.1">Domain Users</span></strong><span class="koboSpan" id="kobo.2203.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2204.1">Enterprise Admins</span></strong><span class="koboSpan" id="kobo.2205.1"> groups (and </span><span class="No-Break"><span class="koboSpan" id="kobo.2206.1">more). </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2207.1">Yikes!</span></strong></span></p></li>
</ol>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2208.1">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.2209.1">Remote Management Users</span></strong><span class="koboSpan" id="kobo.2210.1"> and then click the </span><strong class="bold"><span class="koboSpan" id="kobo.2211.1">Check </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2212.1">Names</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2213.1"> button:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer317">
<span class="koboSpan" id="kobo.2214.1"><img alt="" src="image/B19755_08_59.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2215.1">Figure 8.59 — Remote Management Users</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2216.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2217.1">OK</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2218.1">button after.</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.2219.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.2220.1">Apply</span></strong><span class="koboSpan" id="kobo.2221.1"> and</span><a id="_idIndexMarker1230"/><span class="koboSpan" id="kobo.2222.1"> then click the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2223.1">OK</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2224.1"> button.</span></span></li>
</ol>
<h2 id="_idParaDest-187"><a id="_idTextAnchor187"/><span class="koboSpan" id="kobo.2225.1">Part 12 of 12 – Configuring the workstation machine</span></h2>
<p><span class="koboSpan" id="kobo.2226.1">We’re almost done! </span><span class="koboSpan" id="kobo.2226.2">In this last part, we’ll </span><a id="_idIndexMarker1231"/><span class="koboSpan" id="kobo.2227.1">configure the workstation machine and have it join the domain we created in the previous set </span><span class="No-Break"><span class="koboSpan" id="kobo.2228.1">of steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2229.1">Let’s access the second Windows VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2230.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.2231.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.2232.1">via RDP.</span></span></li>
<li><span class="koboSpan" id="kobo.2233.1">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.2234.1">settings</span></strong><span class="koboSpan" id="kobo.2235.1"> in the search bar (located at the lower left portion of the screen) and then select </span><strong class="bold"><span class="koboSpan" id="kobo.2236.1">Settings</span></strong><span class="koboSpan" id="kobo.2237.1"> from the list of search results. </span><span class="koboSpan" id="kobo.2237.2">Locate and select </span><strong class="bold"><span class="koboSpan" id="kobo.2238.1">Network &amp; Internet</span></strong><span class="koboSpan" id="kobo.2239.1"> from the list of options available under </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2240.1">Windows Settings</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2241.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2242.1">In the sidebar, </span><span class="No-Break"><span class="koboSpan" id="kobo.2243.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2244.1">Ethernet</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2245.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer318">
<span class="koboSpan" id="kobo.2246.1"><img alt="" src="image/B19755_08_60.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2247.1">Figure 8.60 — Ethernet</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2248.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.2249.1">Change adapter options</span></strong><span class="koboSpan" id="kobo.2250.1"> (under </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2251.1">Related settings</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2252.1">).</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.2253.1">Right-click </span><a id="_idIndexMarker1232"/><span class="koboSpan" id="kobo.2254.1">on </span><strong class="bold"><span class="koboSpan" id="kobo.2255.1">Ethernet</span></strong><span class="koboSpan" id="kobo.2256.1"> and then </span><span class="No-Break"><span class="koboSpan" id="kobo.2257.1">choose </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2258.1">Properties</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2259.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer319">
<span class="koboSpan" id="kobo.2260.1"><img alt="" src="image/B19755_08_61.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2261.1">Figure 8.61 — Opening the Ethernet Properties window</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2262.1">This will open the </span><strong class="bold"><span class="koboSpan" id="kobo.2263.1">Ethernet Properties</span></strong><span class="koboSpan" id="kobo.2264.1"> window. </span><span class="koboSpan" id="kobo.2264.2">In </span><a id="_idIndexMarker1233"/><span class="koboSpan" id="kobo.2265.1">this window, select </span><strong class="bold"><span class="koboSpan" id="kobo.2266.1">Internet Protocol Version 4 (TCP/IPv4)</span></strong><span class="koboSpan" id="kobo.2267.1"> and then </span><span class="No-Break"><span class="koboSpan" id="kobo.2268.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2269.1">Properties</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2270.1">.</span></span></p></li>
</ol>
<ol>
<li value="5"><span class="koboSpan" id="kobo.2271.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.2272.1">Use the following DNS server addresses:</span></strong><span class="koboSpan" id="kobo.2273.1"> (similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2274.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2275.1">.62</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2276.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer320">
<span class="koboSpan" id="kobo.2277.1"><img alt="" src="image/B19755_08_62.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2278.1">Figure 8.62 — Use the following DNS server addresses:</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2279.1">Specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.2280.1">10.0.1.4</span></strong><span class="koboSpan" id="kobo.2281.1"> for the </span><strong class="bold"><span class="koboSpan" id="kobo.2282.1">Preferred DNS server</span></strong><span class="koboSpan" id="kobo.2283.1"> value. </span><span class="koboSpan" id="kobo.2283.2">Note that we are using the private IP address of the domain controller as the DNS </span><span class="No-Break"><span class="koboSpan" id="kobo.2284.1">server address.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2285.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2286.1">Make sure you use the actual private IP address value of your domain controller instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2287.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.2288.1">) when setting the </span><strong class="bold"><span class="koboSpan" id="kobo.2289.1">Preferred DNS </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2290.1">server</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2291.1"> value.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.2292.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2293.1">OK</span></strong><span class="koboSpan" id="kobo.2294.1"> button and then </span><span class="No-Break"><span class="koboSpan" id="kobo.2295.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2296.1">Close</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2297.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2298.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2299.1">Note that the RDP Connection to the workstation (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2300.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.2301.1">) VM instance will be disconnected (without any warning </span><span class="No-Break"><span class="koboSpan" id="kobo.2302.1">or notification).</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.2303.1">Navigate to</span><a id="_idIndexMarker1234"/><span class="koboSpan" id="kobo.2304.1"> the VM instance details page (the </span><strong class="bold"><span class="koboSpan" id="kobo.2305.1">Overview</span></strong><span class="koboSpan" id="kobo.2306.1"> blade) of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2307.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.2308.1"> instance (in the Azure portal). </span><span class="koboSpan" id="kobo.2308.2">Locate and click the </span><strong class="bold"><span class="koboSpan" id="kobo.2309.1">Restart</span></strong><span class="koboSpan" id="kobo.2310.1"> button (highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2311.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2312.1">.63</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2313.1">):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer321">
<span class="koboSpan" id="kobo.2314.1"><img alt="" src="image/B19755_08_63.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2315.1">Figure 8.63 — Restarting the workstation VM instance</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2316.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2317.1">Yes</span></strong><span class="koboSpan" id="kobo.2318.1"> button when you’re asked to </span><span class="No-Break"><span class="koboSpan" id="kobo.2319.1">restart </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2320.1">ad-workstation-machine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2321.1">.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2322.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2323.1">Wait for 10 to 15 minutes for the VM instance to restart. </span><span class="koboSpan" id="kobo.2323.2">Feel free to grab a cup of coffee or tea while waiting! </span><span class="koboSpan" id="kobo.2323.3">You should see a notification message once the VM has been successfully restarted. </span><span class="koboSpan" id="kobo.2323.4">Wait for another 5 minutes before proceeding to the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.2324.1">of steps.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.2325.1">Connect to the workstation VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2326.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.2327.1">) again </span><span class="No-Break"><span class="koboSpan" id="kobo.2328.1">with RDP:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer322">
<span class="koboSpan" id="kobo.2329.1"><img alt="" src="image/B19755_08_21.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2330.1">Figure 8.64 — Enter Your User Account</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2331.1">Simply use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2332.1">workstation_user</span></strong><span class="koboSpan" id="kobo.2333.1"> as the username and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2334.1">Workstation1234!!!</span></strong><span class="koboSpan" id="kobo.2335.1"> as </span><span class="No-Break"><span class="koboSpan" id="kobo.2336.1">the password.</span></span></p></li>
</ol>
<ol>
<li value="9"><span class="koboSpan" id="kobo.2337.1">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.2338.1">Access work or school</span></strong><span class="koboSpan" id="kobo.2339.1"> in the</span><a id="_idIndexMarker1235"/> <span class="No-Break"><span class="koboSpan" id="kobo.2340.1">search box:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer323">
<span class="koboSpan" id="kobo.2341.1"><img alt="" src="image/B19755_08_65.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2342.1">Figure 8.65 — Access work or school</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2343.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.2344.1">Access work or school</span></strong><span class="koboSpan" id="kobo.2345.1"> from the search results (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2346.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2347.1">.65</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2348.1">).</span></span></p></li>
</ol>
<ol>
<li value="10"><span class="koboSpan" id="kobo.2349.1">Under </span><strong class="bold"><span class="koboSpan" id="kobo.2350.1">Access work or school</span></strong><span class="koboSpan" id="kobo.2351.1">, locate </span><a id="_idIndexMarker1236"/><span class="koboSpan" id="kobo.2352.1">and click the </span><strong class="bold"><span class="koboSpan" id="kobo.2353.1">Connect</span></strong><span class="koboSpan" id="kobo.2354.1"> button. </span><span class="koboSpan" id="kobo.2354.2">After that, click </span><strong class="bold"><span class="koboSpan" id="kobo.2355.1">Join this device to a local Active Directory domain</span></strong><span class="koboSpan" id="kobo.2356.1"> under </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2357.1">Alternate actions</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2358.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2359.1">Specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.2360.1">domain.local</span></strong><span class="koboSpan" id="kobo.2361.1"> under </span><strong class="bold"><span class="koboSpan" id="kobo.2362.1">Domain name</span></strong><span class="koboSpan" id="kobo.2363.1"> on the </span><strong class="bold"><span class="koboSpan" id="kobo.2364.1">Join a domain</span></strong><span class="koboSpan" id="kobo.2365.1"> screen. </span><span class="koboSpan" id="kobo.2365.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2366.1">Next</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2367.1">button after:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer324">
<span class="koboSpan" id="kobo.2368.1"><img alt="" src="image/B19755_08_66.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2369.1">Figure 8.66 — Join a domain</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2370.1">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2371.1">admin_user</span></strong><span class="koboSpan" id="kobo.2372.1"> as the username and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2373.1">Windows1234!!!</span></strong><span class="koboSpan" id="kobo.2374.1"> as the password when you’re prompted to enter a </span><span class="No-Break"><span class="koboSpan" id="kobo.2375.1">domain account.</span></span></p></li>
</ol>
<ol>
<li value="12"><span class="koboSpan" id="kobo.2376.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.2377.1">Add an account</span></strong><span class="koboSpan" id="kobo.2378.1"> window, </span><span class="No-Break"><span class="koboSpan" id="kobo.2379.1">select </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2380.1">Skip</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2381.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2382.1">Click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2383.1">Restart now</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2384.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2385.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2386.1">The RDP connection to the workstation VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2387.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.2388.1">) will </span><span class="No-Break"><span class="koboSpan" id="kobo.2389.1">be disconnected.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.2390.1">Back in the domain controller (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2391.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.2392.1">) RDP connection, verify if the </span><a id="_idIndexMarker1237"/><span class="koboSpan" id="kobo.2393.1">workstation VM instance shows up </span><span class="No-Break"><span class="koboSpan" id="kobo.2394.1">under </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2395.1">Computers</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2396.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer325">
<span class="koboSpan" id="kobo.2397.1"><img alt="" src="image/B19755_08_67.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2398.1">Figure 8.67 — The workstation VM instance (ad-workstation-machine) now shows up under Computers</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2399.1">Here, we can see that the workstation VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2400.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.2401.1">) is now showing up </span><span class="No-Break"><span class="koboSpan" id="kobo.2402.1">under </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2403.1">Computers</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2404.1">.</span></span></p></li>
</ol>
<ol>
<li value="15"><span class="koboSpan" id="kobo.2405.1">Close the RDP connection for </span><strong class="bold"><span class="koboSpan" id="kobo.2406.1">Domain Controller VM </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2407.1">instance</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2408.1"> (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2409.1">ad-domain-controller</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2410.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.2411.1">Connect to the workstation VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2412.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.2413.1">) again. </span><span class="koboSpan" id="kobo.2413.2">This time, use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2414.1">DOMAIN\admin_user</span></strong><span class="koboSpan" id="kobo.2415.1"> for the username and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2416.1">Windows1234!!!</span></strong><span class="koboSpan" id="kobo.2417.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.2418.1">the password.</span></span></li>
<li><span class="koboSpan" id="kobo.2419.1">Open </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2420.1">Computer Management</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2421.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer326">
<span class="koboSpan" id="kobo.2422.1"><img alt="" src="image/B19755_08_68.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2423.1">Figure 8.68 — Opening Computer Management</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2424.1">To open </span><strong class="bold"><span class="koboSpan" id="kobo.2425.1">Computer Management</span></strong><span class="koboSpan" id="kobo.2426.1">, simply type </span><strong class="source-inline"><span class="koboSpan" id="kobo.2427.1">Computer Management</span></strong><span class="koboSpan" id="kobo.2428.1"> in the search </span><a id="_idIndexMarker1238"/><span class="koboSpan" id="kobo.2429.1">box and then select </span><strong class="bold"><span class="koboSpan" id="kobo.2430.1">Computer Management</span></strong><span class="koboSpan" id="kobo.2431.1"> from the list of results (as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2432.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2433.1">.68</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2434.1">).</span></span></p></li>
</ol>
<ol>
<li value="18"><span class="koboSpan" id="kobo.2435.1">Expand </span><strong class="bold"><span class="koboSpan" id="kobo.2436.1">Local Users and Groups</span></strong><span class="koboSpan" id="kobo.2437.1"> (in </span><span class="No-Break"><span class="koboSpan" id="kobo.2438.1">the tree):</span></span>
<div>
<div class="IMG---Figure" id="_idContainer327">
<span class="koboSpan" id="kobo.2439.1"><img alt="" src="image/B19755_08_69.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2440.1">Figure 8.69 — Local Users and Groups</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2441.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.2442.1">Groups</span></strong><span class="koboSpan" id="kobo.2443.1">, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2444.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2445.1">.69</span></em><span class="koboSpan" id="kobo.2446.1">. </span><span class="koboSpan" id="kobo.2446.2">Double-click on </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2447.1">Administrators</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2448.1"> after.</span></span></p></li>
</ol>
<ol>
<li value="19"><span class="koboSpan" id="kobo.2449.1">Locate and </span><a id="_idIndexMarker1239"/><span class="koboSpan" id="kobo.2450.1">click the </span><strong class="bold"><span class="koboSpan" id="kobo.2451.1">Add</span></strong><span class="koboSpan" id="kobo.2452.1"> button in the </span><strong class="bold"><span class="koboSpan" id="kobo.2453.1">Administrators </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2454.1">Properties</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2455.1"> window.</span></span></li>
<li><span class="koboSpan" id="kobo.2456.1">Input </span><strong class="source-inline"><span class="koboSpan" id="kobo.2457.1">John Doe</span></strong><span class="koboSpan" id="kobo.2458.1"> in the text area highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2459.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2460.1">.70</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2461.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer328">
<span class="koboSpan" id="kobo.2462.1"><img alt="" src="image/B19755_08_70.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2463.1">Figure 8.70 — Adding John Doe to the Administrators group</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2464.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.2465.1">Check Names</span></strong><span class="koboSpan" id="kobo.2466.1">. </span><span class="koboSpan" id="kobo.2466.2">Click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2467.1">OK</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2468.1"> after.</span></span></p></li>
</ol>
<ol>
<li value="21"><span class="koboSpan" id="kobo.2469.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.2470.1">Apply</span></strong><span class="koboSpan" id="kobo.2471.1"> and then </span><span class="No-Break"><span class="koboSpan" id="kobo.2472.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2473.1">OK</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2474.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2475.1">Close the </span><a id="_idIndexMarker1240"/><span class="koboSpan" id="kobo.2476.1">RDP connection for the workstation VM </span><span class="No-Break"><span class="koboSpan" id="kobo.2477.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2478.1">ad-workstation-machine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2479.1">).</span></span></li>
</ol>
<p><strong class="bold"><span class="koboSpan" id="kobo.2480.1">At this point, our lab environment setup is complete!</span></strong><span class="koboSpan" id="kobo.2481.1"> With everything ready, let’s proceed to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2482.1">next section.</span></span></p>
<h1 id="_idParaDest-188"><a id="_idTextAnchor188"/><span class="koboSpan" id="kobo.2483.1">Simulating penetration testing in the lab environment</span></h1>
<p><span class="koboSpan" id="kobo.2484.1">Given that our lab </span><a id="_idIndexMarker1241"/><span class="koboSpan" id="kobo.2485.1">environment in Azure</span><a id="_idIndexMarker1242"/><span class="koboSpan" id="kobo.2486.1"> has been set up successfully, we can now focus on performing the penetration testing simulation to verify that everything has been configured correctly. </span><span class="koboSpan" id="kobo.2486.2">Similar to the previous chapters, we will work with a simplified penetration process since our primary goal is to assess if the penetration testing lab environment has been set up and (</span><span class="No-Break"><span class="koboSpan" id="kobo.2487.1">mis)configured correctly.</span></span></p>
<p><span class="koboSpan" id="kobo.2488.1">Our simulation will start with a port scan to check the open ports of one of the target Windows VM instances (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2489.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.2490.1">). </span><span class="koboSpan" id="kobo.2490.2">We will then </span><a id="_idIndexMarker1243"/><span class="koboSpan" id="kobo.2491.1">use </span><strong class="bold"><span class="koboSpan" id="kobo.2492.1">ldapsearch</span></strong><span class="koboSpan" id="kobo.2493.1"> to retrieve the domain name (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2494.1">domain.local</span></strong><span class="koboSpan" id="kobo.2495.1">) that’s used in our Active Directory setup. </span><span class="koboSpan" id="kobo.2495.2">Next, we will </span><a id="_idIndexMarker1244"/><span class="koboSpan" id="kobo.2496.1">use </span><strong class="bold"><span class="koboSpan" id="kobo.2497.1">Kerbrute</span></strong><span class="koboSpan" id="kobo.2498.1"> to enumerate valid usernames along with brute-forcing the password of one of the enumerated user accounts (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2499.1">johndoe</span></strong><span class="koboSpan" id="kobo.2500.1">). </span><span class="koboSpan" id="kobo.2500.2">Using the domain (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2501.1">domain.local</span></strong><span class="koboSpan" id="kobo.2502.1">) along with the credentials of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2503.1">johndoe</span></strong><span class="koboSpan" id="kobo.2504.1"> account, we will </span><a id="_idIndexMarker1245"/><span class="koboSpan" id="kobo.2505.1">use </span><strong class="bold"><span class="koboSpan" id="kobo.2506.1">Impacket</span></strong><span class="koboSpan" id="kobo.2507.1"> to obtain the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2508.1">service_account</span></strong><span class="koboSpan" id="kobo.2509.1"> account, along with its hash value. </span><span class="koboSpan" id="kobo.2509.2">We will then crack this hash value and retrieve the password</span><a id="_idIndexMarker1246"/><span class="koboSpan" id="kobo.2510.1"> using </span><strong class="bold"><span class="koboSpan" id="kobo.2511.1">John the Ripper</span></strong><span class="koboSpan" id="kobo.2512.1">. </span><span class="koboSpan" id="kobo.2512.2">With the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2513.1">service_acccount</span></strong><span class="koboSpan" id="kobo.2514.1"> account credentials, we will </span><a id="_idIndexMarker1247"/><span class="koboSpan" id="kobo.2515.1">use </span><strong class="bold"><span class="koboSpan" id="kobo.2516.1">evil-winrm</span></strong><span class="koboSpan" id="kobo.2517.1"> to gain remote access to the target machine (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2518.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.2519.1">). </span><span class="koboSpan" id="kobo.2519.2">Finally, we will retrieve the flag stored inside the target machine. </span><em class="italic"><span class="koboSpan" id="kobo.2520.1">Looks like we’ll be using several tools in </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2521.1">this section!</span></em></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.2522.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2523.1">It is unethical and illegal to attack cloud resources owned by another user or company. </span><span class="koboSpan" id="kobo.2523.2">Before proceeding, make sure you read the </span><em class="italic"><span class="koboSpan" id="kobo.2524.1">Examining the considerations when building penetration testing lab environments in the cloud</span></em><span class="koboSpan" id="kobo.2525.1"> section of </span><span class="No-Break"><em class="italic"><a href="B19755_01.xhtml"><span class="koboSpan" id="kobo.2526.1">Chapter 1</span></a></em></span><span class="koboSpan" id="kobo.2527.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2528.1">Getting Started with Penetration Testing Labs in the Cloud</span></em><span class="koboSpan" id="kobo.2529.1">, since we will be simulating the attack process to validate if misconfigurations and vulnerabilities present in the applications and services running in the target VM instance </span><span class="No-Break"><span class="koboSpan" id="kobo.2530.1">are exploitable.</span></span></p>
<p><span class="koboSpan" id="kobo.2531.1">With these</span><a id="_idIndexMarker1248"/><span class="koboSpan" id="kobo.2532.1"> aspects in mind, we can now start the</span><a id="_idIndexMarker1249"/><span class="koboSpan" id="kobo.2533.1"> penetration </span><span class="No-Break"><span class="koboSpan" id="kobo.2534.1">testing simulation:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2535.1">In the Kali Linux desktop/GUI environment (in the browser), run the following commands in the terminal to check and scan the open ports on the Active Directory domain controller instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2536.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.2537.1">). </span><span class="koboSpan" id="kobo.2537.2">Make sure you set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2538.1">IP</span></strong><span class="koboSpan" id="kobo.2539.1"> variable value with the private IP address of the domain controller before running </span><span class="No-Break"><span class="koboSpan" id="kobo.2540.1">this command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2541.1">IP=10.0.1.4</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2542.1">nmap --top-ports 1000 -Pn $IP</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2543.1">Here, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2544.1">--top-ports</span></strong><span class="koboSpan" id="kobo.2545.1"> option to specify the number of top ports that Nmap will scan. </span><span class="koboSpan" id="kobo.2545.2">This speeds up the scanning process by focusing on the most commonly used ports. </span><span class="koboSpan" id="kobo.2545.3">In addition to this, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2546.1">-Pn</span></strong><span class="koboSpan" id="kobo.2547.1"> option to disable host discovery and assume that the host </span><span class="No-Break"><span class="koboSpan" id="kobo.2548.1">is online.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.2549.1">Running this command should give us the </span><span class="No-Break"><span class="koboSpan" id="kobo.2550.1">following output:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer329">
<span class="koboSpan" id="kobo.2551.1"><img alt="" src="image/B19755_08_71.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2552.1">Figure 8.71 — Using nmap to scan the ports</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2553.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2554.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2555.1">.71</span></em><span class="koboSpan" id="kobo.2556.1">, we can see that more ports are open compared to when we last used Nmap </span><a id="_idIndexMarker1250"/><span class="koboSpan" id="kobo.2557.1">to scan the ports of the</span><a id="_idIndexMarker1251"/><span class="koboSpan" id="kobo.2558.1"> domain controller VM </span><span class="No-Break"><span class="koboSpan" id="kobo.2559.1">instance (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2560.1">ad-domain-controller</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2561.1">).</span></span></p></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.2562.1">This time, let’s try checking all the ports by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.2563.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2564.1">nmap -p- -Pn $IP -v</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2565.1">Similar to the previous command we ran, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2566.1">-Pn</span></strong><span class="koboSpan" id="kobo.2567.1"> option to disable host discovery. </span><span class="koboSpan" id="kobo.2567.2">Now, we have </span><strong class="source-inline"><span class="koboSpan" id="kobo.2568.1">-p-</span></strong><span class="koboSpan" id="kobo.2569.1">, indicating that we want to scan all 65,535 ports. </span><span class="koboSpan" id="kobo.2569.2">In addition to this, we also used </span><strong class="source-inline"><span class="koboSpan" id="kobo.2570.1">-v</span></strong><span class="koboSpan" id="kobo.2571.1"> to increase the verbosity level of the output. </span><span class="koboSpan" id="kobo.2571.2">After a few minutes, we should get the </span><span class="No-Break"><span class="koboSpan" id="kobo.2572.1">following result:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer330">
<span class="koboSpan" id="kobo.2573.1"><img alt="" src="image/B19755_08_72.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2574.1">Figure 8.72 — Using nmap to scan all the ports</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2575.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2576.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2577.1">.72</span></em><span class="koboSpan" id="kobo.2578.1">, we</span><a id="_idIndexMarker1252"/><span class="koboSpan" id="kobo.2579.1"> can see that port </span><strong class="source-inline"><span class="koboSpan" id="kobo.2580.1">5985</span></strong><span class="koboSpan" id="kobo.2581.1"> for the WinRM service is open. </span><span class="koboSpan" id="kobo.2581.2">This means that we may be able to use</span><a id="_idIndexMarker1253"/><span class="koboSpan" id="kobo.2582.1"> tools such as </span><strong class="bold"><span class="koboSpan" id="kobo.2583.1">evil-winrm</span></strong><span class="koboSpan" id="kobo.2584.1"> to </span><a id="_idIndexMarker1254"/><span class="koboSpan" id="kobo.2585.1">give us remote access with the right set </span><span class="No-Break"><span class="koboSpan" id="kobo.2586.1">of credentials!</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2587.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2588.1">If port </span><strong class="source-inline"><span class="koboSpan" id="kobo.2589.1">5985</span></strong><span class="koboSpan" id="kobo.2590.1"> is not open (and potentially in a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2591.1">filtered</span></strong><span class="koboSpan" id="kobo.2592.1"> state), make sure you run the following command in the </span><strong class="bold"><span class="koboSpan" id="kobo.2593.1">Administrator: Windows PowerShell</span></strong><span class="koboSpan" id="kobo.2594.1"> window of the first Windows VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2595.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.2596.1">): </span><strong class="source-inline"><span class="koboSpan" id="kobo.2597.1">Set-NetFirewallRule -Name "WINRM-HTTP-In-TCP-PUBLIC" -RemoteAddress Any</span></strong><span class="koboSpan" id="kobo.2598.1">. </span><span class="koboSpan" id="kobo.2598.2">Note that additional troubleshooting steps might be needed if this does not fix the </span><span class="No-Break"><span class="koboSpan" id="kobo.2599.1">connectivity issues.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2600.1">Now, let’s perform an LDAP search operation to retrieve the naming context(s) using </span><strong class="source-inline"><span class="koboSpan" id="kobo.2601.1">ldapsearch</span></strong><span class="koboSpan" id="kobo.2602.1">. </span><em class="italic"><span class="koboSpan" id="kobo.2603.1">What do we mean by retrieving the naming context?</span></em><span class="koboSpan" id="kobo.2604.1"> This essentially means that we are obtaining information about the structure and </span><a id="_idIndexMarker1255"/><span class="koboSpan" id="kobo.2605.1">organization of the LDAP </span><a id="_idIndexMarker1256"/><span class="koboSpan" id="kobo.2606.1">directory (such as the domains or directory partitions that exist </span><span class="No-Break"><span class="koboSpan" id="kobo.2607.1">within it).</span></span><p class="list-inset"><span class="koboSpan" id="kobo.2608.1">When you are ready, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2609.1">following command:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2610.1">ldapsearch -H ldap://$IP -x -s base namingcontexts</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2611.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.2612.1">following results:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer331">
<span class="koboSpan" id="kobo.2613.1"><img alt="" src="image/B19755_08_73.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2614.1">Figure 8.73 — Using ldapsearch</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2615.1">Running the preceding command allowed us to retrieve the domain name (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2616.1">domain.local</span></strong><span class="koboSpan" id="kobo.2617.1">) that we used in the Active Directory setup of our </span><span class="No-Break"><span class="koboSpan" id="kobo.2618.1">lab environment.</span></span></p></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.2619.1">Before installing Kerbrute, we need to </span><span class="No-Break"><span class="koboSpan" id="kobo.2620.1">install Golang:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2621.1">apt update</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2622.1">apt install golang -y</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2623.1">Feel free to verify that we were able to install Golang successfully by running </span><strong class="source-inline"><span class="koboSpan" id="kobo.2624.1">which go</span></strong><span class="koboSpan" id="kobo.2625.1">. </span><span class="koboSpan" id="kobo.2625.2">Running </span><strong class="source-inline"><span class="koboSpan" id="kobo.2626.1">which go</span></strong><span class="koboSpan" id="kobo.2627.1"> should </span><span class="No-Break"><span class="koboSpan" id="kobo.2628.1">return </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2629.1">/usr/bin/go</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2630.1">.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2631.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2632.1">This step may take around 5 minutes </span><span class="No-Break"><span class="koboSpan" id="kobo.2633.1">to complete.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.2634.1">Set up </span><strong class="bold"><span class="koboSpan" id="kobo.2635.1">Kerbrute</span></strong><span class="koboSpan" id="kobo.2636.1"> in </span><a id="_idIndexMarker1257"/><span class="koboSpan" id="kobo.2637.1">your</span><a id="_idIndexMarker1258"/><span class="koboSpan" id="kobo.2638.1"> Kali Linux</span><a id="_idIndexMarker1259"/><span class="koboSpan" id="kobo.2639.1"> attacker machine using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2640.1">following commands:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2641.1">git clone </span></strong><a href="https://github.com/ropnop/kerbrute.git"><strong class="bold"><span class="koboSpan" id="kobo.2642.1">https://github.com/ropnop/kerbrute.git</span></strong></a>
<strong class="bold"><span class="koboSpan" id="kobo.2643.1">cd kerbrute</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2644.1">make linux</span></strong></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2645.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2646.1">If you are wondering what Kerbrute is, it is a tool that’s used to assess Kerberos security by brute-forcing and enumerating valid </span><a id="_idIndexMarker1260"/><span class="koboSpan" id="kobo.2647.1">Active Directory accounts. </span><span class="koboSpan" id="kobo.2647.2">It is similar to the </span><strong class="bold"><span class="koboSpan" id="kobo.2648.1">VNC login auxiliary scanner</span></strong><span class="koboSpan" id="kobo.2649.1"> Metasploit module we used in </span><span class="No-Break"><em class="italic"><a href="B19755_05.xhtml"><span class="koboSpan" id="kobo.2650.1">Chapter 5</span></a></em></span><span class="koboSpan" id="kobo.2651.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2652.1">Setting Up Isolated Penetration Testing Lab Environments on Azure</span></em><span class="koboSpan" id="kobo.2653.1">. </span><span class="koboSpan" id="kobo.2653.2">This time, however, we have a tool designed specifically for the Kerberos authentication mechanism. </span><span class="koboSpan" id="kobo.2653.3">You can find the GitHub repository of Kerbrute </span><span class="No-Break"><span class="koboSpan" id="kobo.2654.1">here: </span></span><a href="https://github.com/ropnop/kerbrute"><span class="No-Break"><span class="koboSpan" id="kobo.2655.1">https://github.com/ropnop/kerbrute</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2656.1">.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.2657.1">Now, let’s run the following commands (one line at a time) to check if </span><strong class="source-inline"><span class="koboSpan" id="kobo.2658.1">kerbrute_linux_386</span></strong><span class="koboSpan" id="kobo.2659.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2660.1">kerbrute_linux_amd64</span></strong><span class="koboSpan" id="kobo.2661.1"> are inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2662.1">dist</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2663.1"> directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2664.1">cd dist</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2665.1">ls</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2666.1">Next, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2667.1">touch</span></strong><span class="koboSpan" id="kobo.2668.1"> command to create two empty files – </span><strong class="source-inline"><span class="koboSpan" id="kobo.2669.1">usernames.txt</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2670.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2671.1">passwords.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2672.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2673.1">touch usernames.txt passwords.txt</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2674.1">Run the</span><a id="_idIndexMarker1261"/><span class="koboSpan" id="kobo.2675.1"> following command to open the empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.2676.1">usernames.txt</span></strong><span class="koboSpan" id="kobo.2677.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.2678.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2679.1">vim usernames.txt</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2680.1">Press </span><strong class="source-inline"><span class="koboSpan" id="kobo.2681.1">i</span></strong><span class="koboSpan" id="kobo.2682.1"> to switch</span><a id="_idIndexMarker1262"/><span class="koboSpan" id="kobo.2683.1"> to </span><strong class="bold"><span class="koboSpan" id="kobo.2684.1">insert mode</span></strong><span class="koboSpan" id="kobo.2685.1"> so that we can edit the file. </span><span class="koboSpan" id="kobo.2685.2">Type or paste the following usernames (one username per line) into our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2686.1">usernames.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2687.1"> file:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2688.1">admin
admin_user
workstation_user
johndoe
janedoe</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2689.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.2690.1">Esc</span></em><span class="koboSpan" id="kobo.2691.1"> key to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.2692.1">normal mode</span></strong><span class="koboSpan" id="kobo.2693.1">. </span><span class="koboSpan" id="kobo.2693.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.2694.1">:wq!</span></strong><span class="koboSpan" id="kobo.2695.1">. </span><span class="koboSpan" id="kobo.2695.2">Press </span><em class="italic"><span class="koboSpan" id="kobo.2696.1">Enter</span></em><span class="koboSpan" id="kobo.2697.1"> after. </span><span class="koboSpan" id="kobo.2697.2">This will save the changes that were made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2698.1">usernames.txt</span></strong><span class="koboSpan" id="kobo.2699.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.2700.1">as well.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2701.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2702.1">In case you have forgotten already, </span><strong class="bold"><span class="koboSpan" id="kobo.2703.1">insert mode</span></strong><span class="koboSpan" id="kobo.2704.1"> in Vim allows us to type and make changes as we would in a regular text editor. </span><span class="koboSpan" id="kobo.2704.2">In this mode, we can freely add, delete, or modify characters without affecting the surrounding text. </span><span class="koboSpan" id="kobo.2704.3">On the other hand, </span><strong class="bold"><span class="koboSpan" id="kobo.2705.1">normal mode</span></strong><span class="koboSpan" id="kobo.2706.1"> allows us to navigate through the text, execute commands, and perform various operations on the file. </span><span class="koboSpan" id="kobo.2706.2">In this mode, specific keystrokes (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2707.1">:wq!</span></strong><span class="koboSpan" id="kobo.2708.1">) can be used to move the cursor, search for text, copy and paste, and perform editing actions such as deleting, replacing, and undoing changes. </span><span class="koboSpan" id="kobo.2708.2">For instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2709.1">w</span></strong><span class="koboSpan" id="kobo.2710.1"> represents the </span><em class="italic"><span class="koboSpan" id="kobo.2711.1">write</span></em><span class="koboSpan" id="kobo.2712.1"> command (which saves changes to the file), and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2713.1">q</span></strong><span class="koboSpan" id="kobo.2714.1"> represents the </span><em class="italic"><span class="koboSpan" id="kobo.2715.1">quit</span></em><span class="koboSpan" id="kobo.2716.1"> command (which exits the editor). </span><span class="koboSpan" id="kobo.2716.2">What’s the exclamation point (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2717.1">!</span></strong><span class="koboSpan" id="kobo.2718.1">) for? </span><span class="koboSpan" id="kobo.2718.2">The exclamation point, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2719.1">!</span></strong><span class="koboSpan" id="kobo.2720.1">, is simply an optional modifier that forces the command to execute, even if there are unsaved changes along with </span><span class="No-Break"><span class="koboSpan" id="kobo.2721.1">other warnings.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.2722.1">Similarly, let’s run the following command to open the empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.2723.1">passwords.txt</span></strong><span class="koboSpan" id="kobo.2724.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.2725.1">using Vim:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2726.1">vim passwords.txt</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2727.1">Next, press </span><strong class="source-inline"><span class="koboSpan" id="kobo.2728.1">i</span></strong><span class="koboSpan" id="kobo.2729.1"> to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.2730.1">insert mode</span></strong><span class="koboSpan" id="kobo.2731.1"> so that we can edit the file. </span><span class="koboSpan" id="kobo.2731.2">Type or paste the following</span><a id="_idIndexMarker1263"/><span class="koboSpan" id="kobo.2732.1"> passwords (one </span><a id="_idIndexMarker1264"/><span class="koboSpan" id="kobo.2733.1">password per line) into our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2734.1">passwords.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2735.1"> file:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2736.1">password
admin
Workstation1234!!!
</span><span class="koboSpan" id="kobo.2736.2">Windows1234!!!
</span><span class="koboSpan" id="kobo.2736.3">Passw0rd</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2737.1">Press the </span><em class="italic"><span class="koboSpan" id="kobo.2738.1">Esc</span></em><span class="koboSpan" id="kobo.2739.1"> key to switch to </span><strong class="bold"><span class="koboSpan" id="kobo.2740.1">normal mode</span></strong><span class="koboSpan" id="kobo.2741.1">. </span><span class="koboSpan" id="kobo.2741.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.2742.1">:wq!</span></strong><span class="koboSpan" id="kobo.2743.1">. </span><span class="koboSpan" id="kobo.2743.2">Press </span><em class="italic"><span class="koboSpan" id="kobo.2744.1">Enter</span></em><span class="koboSpan" id="kobo.2745.1"> after. </span><span class="koboSpan" id="kobo.2745.2">This will save the changes we’ve made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2746.1">passwords.txt</span></strong><span class="koboSpan" id="kobo.2747.1"> and then exit Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.2748.1">as well.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2749.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2750.1">We are intentionally using short lists of usernames and passwords to demonstrate how to use Kerbrute. </span><span class="koboSpan" id="kobo.2750.2">In real life, a much wider range of passwords needs to be prepared to maximize the chances of getting unauthorized access during a penetration testing activity </span><span class="No-Break"><span class="koboSpan" id="kobo.2751.1">or simulation.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.2752.1">With everything ready, let’s use Kerbrute to enumerate valid Active Directory users using the username list file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2753.1">usernames.txt</span></strong><span class="koboSpan" id="kobo.2754.1">) we </span><span class="No-Break"><span class="koboSpan" id="kobo.2755.1">prepared earlier:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2756.1">./kerbrute_linux_386 userenum usernames.txt -d domain --dc 10.0.1.4</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2757.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.2758.1">following output:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer332">
<span class="koboSpan" id="kobo.2759.1"><img alt="" src="image/B19755_08_74.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2760.1">Figure 8.74 — Using Kerbrute for enumerating valid Active Directory usernames</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2761.1">Here, we can </span><a id="_idIndexMarker1265"/><span class="koboSpan" id="kobo.2762.1">see that two valid </span><a id="_idIndexMarker1266"/><span class="koboSpan" id="kobo.2763.1">usernames were found using Kerbrute: </span><strong class="source-inline"><span class="koboSpan" id="kobo.2764.1">johndoe@domain</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2765.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2766.1">admin_user@domain</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2767.1">.</span></span></p></li>
</ol>
<ol>
<li value="11"><span class="koboSpan" id="kobo.2768.1">Now, let’s run the following command to brute force the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2769.1">johndoe</span></strong><span class="koboSpan" id="kobo.2770.1"> password using the password list file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2771.1">passwords.txt</span></strong><span class="koboSpan" id="kobo.2772.1">) we </span><span class="No-Break"><span class="koboSpan" id="kobo.2773.1">prepared earlier:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2774.1">./kerbrute_linux_386 bruteuser --dc 10.0.1.4 -d DOMAIN.local passwords.txt johndoe</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2775.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.2776.1">following output:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer333">
<span class="koboSpan" id="kobo.2777.1"><img alt="" src="image/B19755_08_75.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2778.1">Figure 8.75 — Using Kerbrute to brute force the password of the johndoe user account</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2779.1">Here, we can see that the password of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2780.1">johndoe</span></strong><span class="koboSpan" id="kobo.2781.1"> user account is </span><strong class="source-inline"><span class="koboSpan" id="kobo.2782.1">Passw0rd</span></strong><span class="koboSpan" id="kobo.2783.1">! </span><em class="italic"><span class="koboSpan" id="kobo.2784.1">What can we do with this password?</span></em><span class="koboSpan" id="kobo.2785.1"> We’ll look at this in the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.2786.1">of steps!</span></span></p></li>
</ol>
<ol>
<li value="12"><span class="koboSpan" id="kobo.2787.1">Let’s run the</span><a id="_idIndexMarker1267"/><span class="koboSpan" id="kobo.2788.1"> following command to</span><a id="_idIndexMarker1268"/><span class="koboSpan" id="kobo.2789.1"> request the SPN for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2790.1">DOMAIN.local/johndoe</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2791.1">user account:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2792.1">impacket-GetUserSPNs -dc-ip 10.0.1.4 DOMAIN.local/johndoe -request</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2793.1">Specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.2794.1">Passw0rd</span></strong><span class="koboSpan" id="kobo.2795.1"> when prompted for the password. </span><span class="koboSpan" id="kobo.2795.2">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.2796.1">following output:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer334">
<span class="koboSpan" id="kobo.2797.1"><img alt="" src="image/B19755_08_76.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2798.1">Figure 8.76 — KRB_TGS ticket</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2799.1">Here, we can see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2800.1">service_account</span></strong><span class="koboSpan" id="kobo.2801.1"> account and the password hash value (that is, the </span><strong class="bold"><span class="koboSpan" id="kobo.2802.1">KRB_TGS ticket</span></strong><span class="koboSpan" id="kobo.2803.1"> of the service account) under </span><strong class="bold"><span class="koboSpan" id="kobo.2804.1">CCache file is not found. </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2805.1">Skipping ...</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2806.1">.</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2807.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2808.1">We won’t dive deep into how the authentication protocol works in this book. </span><span class="koboSpan" id="kobo.2808.2">Feel free to check out </span><a href="https://learn.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos"><span class="koboSpan" id="kobo.2809.1">https://learn.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos</span></a><span class="koboSpan" id="kobo.2810.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.2811.1">more details.</span></span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.2812.1">Highlight </span><a id="_idIndexMarker1269"/><span class="koboSpan" id="kobo.2813.1">and copy the hash value, similar</span><a id="_idIndexMarker1270"/><span class="koboSpan" id="kobo.2814.1"> to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2815.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2816.1">.77</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2817.1">:</span></span>
<div>
<div class="IMG---Figure" id="_idContainer335">
<span class="koboSpan" id="kobo.2818.1"><img alt="" src="image/B19755_08_77.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2819.1">Figure 8.77 — Copying the hash value</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2820.1">Here, we right-click on the highlighted hash value and then select </span><strong class="bold"><span class="koboSpan" id="kobo.2821.1">Copy Selection</span></strong><span class="koboSpan" id="kobo.2822.1"> from the list of </span><span class="No-Break"><span class="koboSpan" id="kobo.2823.1">options available.</span></span></p></li>
</ol>
<ol>
<li value="14"><span class="koboSpan" id="kobo.2824.1">Now, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2825.1">touch</span></strong><span class="koboSpan" id="kobo.2826.1"> command to create an empty </span><em class="italic"><span class="koboSpan" id="kobo.2827.1">hash</span></em><span class="koboSpan" id="kobo.2828.1"> file. </span><span class="koboSpan" id="kobo.2828.2">Let’s open this file using Vim </span><span class="No-Break"><span class="koboSpan" id="kobo.2829.1">as well:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2830.1">touch hash</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2831.1">vim hash</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2832.1">Next, press </span><em class="italic"><span class="koboSpan" id="kobo.2833.1">i</span></em><span class="koboSpan" id="kobo.2834.1"> to switch to insert mode so that we can edit the file. </span><span class="koboSpan" id="kobo.2834.2">Paste the copied string value by right-clicking and choose </span><strong class="bold"><span class="koboSpan" id="kobo.2835.1">Paste Selection</span></strong><span class="koboSpan" id="kobo.2836.1"> from the list of options available. </span><span class="koboSpan" id="kobo.2836.2">Press the </span><em class="italic"><span class="koboSpan" id="kobo.2837.1">Esc</span></em><span class="koboSpan" id="kobo.2838.1"> key to switch to normal mode. </span><span class="koboSpan" id="kobo.2838.2">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.2839.1">:wq!</span></strong><span class="koboSpan" id="kobo.2840.1">. </span><span class="koboSpan" id="kobo.2840.2">Press </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2841.1">Enter</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2842.1"> after.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2843.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2844.1">Feel free to verify if the hash value has been copied to the file correctly by running </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2845.1">cat hash</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2846.1">.</span></span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.2847.1">With the </span><em class="italic"><span class="koboSpan" id="kobo.2848.1">hash</span></em><span class="koboSpan" id="kobo.2849.1"> file</span><a id="_idIndexMarker1271"/><span class="koboSpan" id="kobo.2850.1"> ready, we can now </span><a id="_idIndexMarker1272"/><span class="koboSpan" id="kobo.2851.1">use </span><strong class="bold"><span class="koboSpan" id="kobo.2852.1">John the Ripper</span></strong><span class="koboSpan" id="kobo.2853.1"> (a widely used password-cracking</span><a id="_idIndexMarker1273"/><span class="koboSpan" id="kobo.2854.1"> tool for detecting and uncovering weak passwords) to crack the TGS hash and retrieve the </span><span class="No-Break"><span class="koboSpan" id="kobo.2855.1">cracked password.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.2856.1">When you are ready, simply run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2857.1">following command:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2858.1">john --format=krb5tgs hash</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2859.1">This should yield logs similar to what we have in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2860.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2861.1">.78</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2862.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer336">
<span class="koboSpan" id="kobo.2863.1"><img alt="" src="image/B19755_08_78.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2864.1">Figure 8.78 — Using John the Ripper to crack the TGS hash</span></p>
<p class="list-inset"><strong class="bold"><span class="koboSpan" id="kobo.2865.1">Looks like we were able to successfully crack the password!</span></strong><span class="koboSpan" id="kobo.2866.1"> Feel free to run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2867.1">john --format=krb5tgs hash --show</span></strong><span class="koboSpan" id="kobo.2868.1"> to show the cracked </span><span class="No-Break"><span class="koboSpan" id="kobo.2869.1">password (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2870.1">Passw0rd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2871.1">).</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2872.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2873.1">Behind the scenes, John the Ripper employs multiple techniques (such as dictionary attacks and brute-force attacks) to iteratively guess potential passwords and hash them to compare them with the target </span><span class="No-Break"><span class="koboSpan" id="kobo.2874.1">hash value.</span></span></p>
<ol>
<li value="16"><span class="koboSpan" id="kobo.2875.1">Now that we know the password, let’s use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2876.1">evil-winrm</span></strong><span class="koboSpan" id="kobo.2877.1"> to gain remote access to the target machine. </span><span class="koboSpan" id="kobo.2877.2">Here, we’re using a tool for establishing a remote connection to the Active Directory domain controller instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2878.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.2879.1">) using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2880.1">cracked credentials.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.2881.1">When you are ready, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2882.1">following command:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2883.1">evil-winrm -u service_account -p 'Passw0rd' -i 10.0.1.4</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2884.1">Running this command should succeed and give us access similar to what is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2885.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2886.1">.79</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2887.1">:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer337">
<span class="koboSpan" id="kobo.2888.1"><img alt="" src="image/B19755_08_79.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2889.1">Figure 8.79 — Using evil-winrm to gain remote access</span></p>
<p class="list-inset"><strong class="bold"><span class="koboSpan" id="kobo.2890.1">Looks like we were able to successfully gain shell access!</span></strong><span class="koboSpan" id="kobo.2891.1"> Now that we have shell</span><a id="_idIndexMarker1274"/><span class="koboSpan" id="kobo.2892.1"> access, we can run </span><a id="_idIndexMarker1275"/><span class="koboSpan" id="kobo.2893.1">commands to locate the flag (which is what we’ll do in the next set </span><span class="No-Break"><span class="koboSpan" id="kobo.2894.1">of steps!)</span></span></p></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2895.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2896.1">Make sure that port </span><strong class="source-inline"><span class="koboSpan" id="kobo.2897.1">5985</span></strong><span class="koboSpan" id="kobo.2898.1"> of the first Windows VM instance (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2899.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.2900.1">) is </span><strong class="source-inline"><span class="koboSpan" id="kobo.2901.1">open</span></strong><span class="koboSpan" id="kobo.2902.1"> in case you encounter issues running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2903.1">evil-winrm</span></strong><span class="koboSpan" id="kobo.2904.1"> command. </span><span class="koboSpan" id="kobo.2904.2">Feel free to run </span><strong class="source-inline"><span class="koboSpan" id="kobo.2905.1">nmap -p5985 -Pn 10.0.1.4</span></strong><span class="koboSpan" id="kobo.2906.1"> to verify that the </span><strong class="bold"><span class="koboSpan" id="kobo.2907.1">STATE</span></strong><span class="koboSpan" id="kobo.2908.1"> value is </span><strong class="source-inline"><span class="koboSpan" id="kobo.2909.1">open</span></strong><span class="koboSpan" id="kobo.2910.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.2911.1">not </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2912.1">filtered</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2913.1">.</span></span></p>
<ol>
<li value="17"><span class="koboSpan" id="kobo.2914.1">Navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2915.1">C:\</span></strong><span class="koboSpan" id="kobo.2916.1"> directory and then list the files inside it using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2917.1">dir</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2918.1"> cmdlet:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2919.1">cd ../../..</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2920.1">dir</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2921.1">This should yield the </span><span class="No-Break"><span class="koboSpan" id="kobo.2922.1">following output:</span></span></p> <div>
<div class="IMG---Figure" id="_idContainer338">
<span class="koboSpan" id="kobo.2923.1"><img alt="" src="image/B19755_08_80.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2924.1">Figure 8.80 — Results after running dir cmdlet</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2925.1">Here, we can see that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.2926.1">flag.txt</span></strong><span class="koboSpan" id="kobo.2927.1"> file is </span><span class="No-Break"><span class="koboSpan" id="kobo.2928.1">inside </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2929.1">C:\</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2930.1">.</span></span></p></li>
</ol>
<ol>
<li value="18"><span class="koboSpan" id="kobo.2931.1">Finally, let’s </span><a id="_idIndexMarker1276"/><span class="koboSpan" id="kobo.2932.1">print the flag value </span><a id="_idIndexMarker1277"/><span class="koboSpan" id="kobo.2933.1">inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.2934.1">flag.txt</span></strong><span class="koboSpan" id="kobo.2935.1"> using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2936.1">cat</span></strong><span class="koboSpan" id="kobo.2937.1"> (</span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2938.1">Get-Content</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2939.1">) command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2940.1">cat flag.txt</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2941.1">This should yield </span><strong class="source-inline"><span class="koboSpan" id="kobo.2942.1">FLAG</span></strong><span class="koboSpan" id="kobo.2943.1"> as the value! </span><strong class="bold"><span class="koboSpan" id="kobo.2944.1">Congratulations on successfully retrieving </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2945.1">the flag!</span></strong></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.2946.1">Right now, you are probably excited to try out other exploits and techniques in our lab environment setup. </span><span class="koboSpan" id="kobo.2946.2">Feel free to modify the configuration of the target VM instances (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2947.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.2948.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2949.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.2950.1">) and then test if certain attacks or </span><span class="No-Break"><span class="koboSpan" id="kobo.2951.1">techniques work.</span></span></p>
<h1 id="_idParaDest-189"><a id="_idTextAnchor189"/><span class="koboSpan" id="kobo.2952.1">Cleaning up</span></h1>
<p><span class="koboSpan" id="kobo.2953.1">Cleaning up the cloud resources</span><a id="_idIndexMarker1278"/><span class="koboSpan" id="kobo.2954.1"> we created or deployed is a crucial step when working with vulnerable cloud applications and environments. </span><span class="koboSpan" id="kobo.2954.2">If we don’t clean up and delete the resources we created right away, we might end up paying for unused cloud resources. </span><span class="koboSpan" id="kobo.2954.3">At a </span><em class="italic"><span class="koboSpan" id="kobo.2955.1">minimum</span></em><span class="koboSpan" id="kobo.2956.1">, we will be paying for the time the following resources </span><span class="No-Break"><span class="koboSpan" id="kobo.2957.1">are running:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.2958.1">1 x </span><strong class="source-inline"><span class="koboSpan" id="kobo.2959.1">Standard_DS1_v2</span></strong><span class="koboSpan" id="kobo.2960.1"> Azure VM instance for the </span><span class="No-Break"><span class="koboSpan" id="kobo.2961.1">attacker machine</span></span></li>
<li><span class="koboSpan" id="kobo.2962.1">2 x </span><strong class="source-inline"><span class="koboSpan" id="kobo.2963.1">Standard_B2ms</span></strong><span class="koboSpan" id="kobo.2964.1"> Azure VM instances for the target machines (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2965.1">ad-domain-controller</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2966.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2967.1">ad-workstation-machine</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2968.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2969.1">Please be aware that there are other costs we have to take into account as well – including data transfer fees, storage costs for persistent data used by the instances, potential charges for</span><a id="_idIndexMarker1279"/><span class="koboSpan" id="kobo.2970.1"> other Azure services utilized in the account, along with any applicable taxes or fees associated to the usage of </span><span class="No-Break"><span class="koboSpan" id="kobo.2971.1">Azure resources.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.2972.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2973.1">Since the overall cost when running these resources depends on several parameters, it is best to refer to the pricing documentation page provided by the cloud platform: </span><a href="https://azure.microsoft.com/en-us/pricing/details/virtual-machines/windows/"><span class="koboSpan" id="kobo.2974.1">https://azure.microsoft.com/en-us/pricing/details/virtual-machines/windows/</span></a><span class="koboSpan" id="kobo.2975.1">. </span><span class="koboSpan" id="kobo.2975.2">You can also utilize the </span><strong class="bold"><span class="koboSpan" id="kobo.2976.1">Azure Pricing Calculator</span></strong><span class="koboSpan" id="kobo.2977.1"> to estimate the cost of deploying resources on Azure. </span><span class="koboSpan" id="kobo.2977.2">You can access the </span><a id="_idIndexMarker1280"/><span class="koboSpan" id="kobo.2978.1">Azure Pricing Calculator </span><span class="No-Break"><span class="koboSpan" id="kobo.2979.1">at </span></span><a href="https://azure.microsoft.com/en-us/pricing/calculator/"><span class="No-Break"><span class="koboSpan" id="kobo.2980.1">https://azure.microsoft.com/en-us/pricing/calculator/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2981.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.2982.1">That said, let’s proceed with deleting the resources we created in </span><span class="No-Break"><span class="koboSpan" id="kobo.2983.1">this chapter:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2984.1">Close all open </span><span class="No-Break"><span class="koboSpan" id="kobo.2985.1">RDP connections.</span></span></li>
<li><span class="koboSpan" id="kobo.2986.1">Manually turn off and delete the Windows VM instances (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2987.1">ad-domain-controller</span></strong><span class="koboSpan" id="kobo.2988.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2989.1">ad-workstation-machine</span></strong><span class="koboSpan" id="kobo.2990.1">), along with their associated resources that were created in this chapter, via the </span><span class="No-Break"><span class="koboSpan" id="kobo.2991.1">Azure portal.</span></span></li>
<li><span class="koboSpan" id="kobo.2992.1">In the Cloud Shell terminal, navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2993.1">~/ch8_environment</span></strong><span class="koboSpan" id="kobo.2994.1"> directory and then use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2995.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.2996.1"> to clean up the resources we </span><span class="No-Break"><span class="koboSpan" id="kobo.2997.1">created earlier:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2998.1">cd ~/ch8_environment</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2999.1">terraform destroy -auto-approve</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.3000.1">Feel free to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3001.1">terraform destroy</span></strong><span class="koboSpan" id="kobo.3002.1"> command a few times in case some resources fail to delete (or take a bit of time to delete). </span><span class="koboSpan" id="kobo.3002.2">If all else fails, you may delete resources manually using the user interface of the </span><span class="No-Break"><span class="koboSpan" id="kobo.3003.1">Azure portal.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3004.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3005.1">This step may take 10 to 15 minutes </span><span class="No-Break"><span class="koboSpan" id="kobo.3006.1">to complete.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.3007.1">Verify that the resources have been destroyed successfully using the </span><span class="No-Break"><span class="koboSpan" id="kobo.3008.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.3009.1">terraform show</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.3010.1">This should </span><a id="_idIndexMarker1281"/><span class="koboSpan" id="kobo.3011.1">return an empty response since all the resources should have been </span><span class="No-Break"><span class="koboSpan" id="kobo.3012.1">deleted successfully.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3013.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3014.1">Feel free to perform a full audit of your Microsoft Azure account. </span><span class="koboSpan" id="kobo.3014.2">This will help ensure that all resources have been properly deleted, minimize the risk of unintended costs, and address any potential </span><span class="No-Break"><span class="koboSpan" id="kobo.3015.1">security concerns.</span></span></p>
<p><span class="koboSpan" id="kobo.3016.1">That’s pretty much it! </span><span class="koboSpan" id="kobo.3016.2">At this point, we should have a good idea of how to prepare a vulnerable Active Directory lab environment on </span><span class="No-Break"><span class="koboSpan" id="kobo.3017.1">Microsoft Azure.</span></span></p>
<h1 id="_idParaDest-190"><a id="_idTextAnchor190"/><span class="koboSpan" id="kobo.3018.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.3019.1">In this chapter, we were able to successfully set up an Active Directory Lab inside an isolated network environment in Microsoft Azure. </span><span class="koboSpan" id="kobo.3019.2">We started by using Terraform to set up the isolated network environment so that we could secure the lab environment resources from external attacks. </span><span class="koboSpan" id="kobo.3019.3">Inside this isolated network environment, we then launched two Windows VM instances. </span><span class="koboSpan" id="kobo.3019.4">After that, we prepared and configured an Active Directory setup (using the VM instances we launched) with one domain controller and one workstation machine. </span><span class="koboSpan" id="kobo.3019.5">After completing the lab environment, we performed a penetration testing simulation to verify if our lab had been (</span><span class="No-Break"><span class="koboSpan" id="kobo.3020.1">mis)configured correctly.</span></span></p>
<p><span class="koboSpan" id="kobo.3021.1">In the next chapter, we will discuss the best practices and strategies when building and automating penetration testing labs in the cloud. </span><span class="koboSpan" id="kobo.3021.2">We will tackle specific techniques that will help us build on top of what we’ve learned in the chapters of </span><span class="No-Break"><span class="koboSpan" id="kobo.3022.1">this book.</span></span></p>
<h1 id="_idParaDest-191"><a id="_idTextAnchor191"/><span class="koboSpan" id="kobo.3023.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.3024.1">For additional information on the topics covered in this chapter, you may find the following </span><span class="No-Break"><span class="koboSpan" id="kobo.3025.1">resources helpful:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.3026.1">Active Directory Domain Services </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3027.1">Overview</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3028.1"> (</span></span><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview"><span class="No-Break"><span class="koboSpan" id="kobo.3029.1">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3030.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3031.1">What is Active Directory Certificate </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3032.1">Services?</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3033.1"> (</span></span><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-cs/active-directory-certificate-services-overview"><span class="No-Break"><span class="koboSpan" id="kobo.3034.1">https://learn.microsoft.com/en-us/windows-server/identity/ad-cs/active-directory-certificate-services-overview</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3035.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3036.1">Microsoft </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3037.1">Kerberos</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3038.1"> (</span></span><a href="https://learn.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos"><span class="No-Break"><span class="koboSpan" id="kobo.3039.1">https://learn.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3040.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3041.1">Using Windows Remote </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3042.1">Management</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.3043.1"> (</span></span><a href="https://learn.microsoft.com/en-us/windows/win32/winrm/using-windows-remote-management"><span class="No-Break"><span class="koboSpan" id="kobo.3044.1">https://learn.microsoft.com/en-us/windows/win32/winrm/using-windows-remote-management</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3045.1">)</span></span></li>
</ul>
</div>
</body></html>