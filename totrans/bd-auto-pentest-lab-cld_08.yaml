- en: '8'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '8'
- en: Designing and Building a Vulnerable Active Directory Lab
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 设计和构建一个易受攻击的 Active Directory 实验室
- en: Organizations around the world rely on **Active Directory** to centralize the
    management of network resources and user accounts. Its widespread adoption and
    usage globally make it a common target for attackers seeking to compromise large-scale
    networks. In response to evolving attacks, setting up penetration testing lab
    environments that mimic real-world implementations can help organizations simulate
    various types of attacks and strengthen their security measures to keep their
    network resources and data safe.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 全球各地的组织依赖**Active Directory**来集中管理网络资源和用户帐户。它在全球范围内的广泛应用，使其成为攻击者试图突破大规模网络的常见目标。为了应对不断演变的攻击，设置模拟现实世界实施的渗透测试实验室环境，可以帮助组织模拟各种攻击类型，强化其安全措施，以保护网络资源和数据的安全。
- en: In this chapter, we will set up and configure an Active Directory lab inside
    an isolated network environment in Microsoft Azure. In this lab setup, we will
    have various security misconfigurations along with deliberately weak configurations
    present in actual Active Directory implementations. Once the lab environment is
    ready, we will perform a penetration testing simulation to validate our lab setup
    configuration.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将在 Microsoft Azure 的隔离网络环境中设置和配置 Active Directory 实验室。在这个实验室设置中，我们将引入各种安全配置错误以及故意设置的弱配置，这些配置在实际的
    Active Directory 实施中是常见的。一旦实验室环境准备就绪，我们将进行渗透测试模拟，以验证我们的实验室配置设置。
- en: 'We will cover the following topics in this chapter:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将涵盖以下主题：
- en: Preparing the necessary components and prerequisites
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 准备必要的组件和前提条件
- en: Launching the target VM instances
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 启动目标虚拟机实例
- en: Setting up and configuring the Active Directory lab
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 设置和配置 Active Directory 实验室
- en: Simulating penetration testing in the lab environment
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在实验室环境中模拟渗透测试
- en: Cleaning up
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 清理工作
- en: With these in mind, let’s begin!
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 牢记这些，我们开始吧！
- en: Technical requirements
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'Before we start, we must have the following ready:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 在开始之前，我们必须准备以下内容：
- en: The **Microsoft Azure** account we used in *[Chapter 5](B19755_05.xhtml)*, *Setting
    Up Isolated Penetration Testing Lab Environments* *on Azure*
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们在*[第5章](B19755_05.xhtml)*《在 Azure 上设置隔离的渗透测试实验室环境》中使用的**Microsoft Azure**帐户
- en: The **Microsoft Remote Desktop** application installed on your local machine
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 安装在您本地计算机上的**Microsoft Remote Desktop**应用程序
- en: The golden image of the Kali Linux VM instance created in the *Leveraging Terraform
    to automatically set up the attacker VM instance* section of *[Chapter 5](B19755_05.xhtml)*,
    *Setting Up Isolated Penetration Testing Lab Environments* *on Azure*
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在*[第5章](B19755_05.xhtml)*《在 Azure 上设置隔离的渗透测试实验室环境》部分的*利用 Terraform 自动设置攻击者虚拟机实例*中创建的
    Kali Linux 虚拟机实例的黄金镜像
- en: Any text editor (such as Notepad++, Visual Studio Code, or Sublime Text) where
    we can temporarily store specific values (for example, your local machine’s IP
    address) that will be used in the hands-on solutions in this chapter
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 任意文本编辑器（如 Notepad++、Visual Studio Code 或 Sublime Text），用于临时存储将用于本章动手解决方案中的特定值（例如，本地计算机的
    IP 地址）
- en: You may proceed with the next steps once these requirements are ready.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦这些要求准备就绪，您可以继续进行后续步骤。
- en: Important note
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: Make sure that you have worked on the hands-on solutions of *[Chapter 5](B19755_05.xhtml)*
    before proceeding. This chapter assumes that we have already created the golden
    VM image of the attacker VM instance.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在继续之前，请确保您已完成*[第5章](B19755_05.xhtml)*中的动手操作。本章假设我们已经创建了攻击者虚拟机实例的黄金虚拟机镜像。
- en: 'The source code and other files for each chapter are available in this book’s
    GitHub repository: [https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud](https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud).'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 每章的源代码和其他文件可在本书的 GitHub 仓库中找到：[https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud](https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud)。
- en: Preparing the necessary components and prerequisites
  id: totrans-21
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备必要的组件和前提条件
- en: 'In this section, we will set up the isolated network environment where the
    target resources will be launched. This will ensure that vulnerable and misconfigured
    resources and services can only be accessed by trusted machines – our local machine
    and the attacker’s machine:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将设置隔离的网络环境，目标资源将在此启动。这将确保只有受信任的计算机（我们的本地计算机和攻击者的计算机）能够访问易受攻击和配置错误的资源及服务：
- en: '![](image/B19755_08_01.jpg)'
  id: totrans-23
  prefs: []
  type: TYPE_IMG
  zh: '![](image/B19755_08_01.jpg)'
- en: Figure 8.1 — Preparing the prerequisites
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8.1 — 准备先决条件
- en: We will also generate the SSH keys (the public key and the private key) for
    accessing the attacker VM instance later in this chapter. As shown in *Figure
    8**.1*, the private key will be stored inside your local machine while the public
    key will be stored inside the attacker VM instance. With this setup, the server
    (the attacker VM instance) can confirm the identity of the client (your local
    machine) using the private key. This will allow us to access the attacker VM instance
    via SSH and run commands remotely. In addition to this, we will make sure that
    the attacker VM instance is ready so that we can focus on setting up and validating
    the configuration of our vulnerable Active Directory lab in the succeeding sections
    of this chapter.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还将在本章稍后的部分中生成 SSH 密钥（公钥和私钥），用于访问攻击者 VM 实例。如 *图 8**.1* 所示，私钥将存储在本地机器中，而公钥将存储在攻击者
    VM 实例中。通过这种设置，服务器（攻击者 VM 实例）可以使用私钥来确认客户端（本地机器）的身份。这将使我们能够通过 SSH 访问攻击者 VM 实例并远程执行命令。此外，我们还将确保攻击者
    VM 实例已准备好，以便我们可以专注于在本章接下来的部分中设置和验证易受攻击的 Active Directory 实验室配置。
- en: 'That said, we’ll divide this section into three parts:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 也就是说，我们将把这一部分分为三个部分：
- en: '*Part 1 of 3 – Generating SSH keys to access the attacker* *VM instance*'
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*第 1 部分（共 3 部分）– 生成 SSH 密钥以访问攻击者* *VM 实例*'
- en: '*Part 2 of 3 – Setting up the lab network environment* *with Terraform*'
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*第 2 部分（共 3 部分）– 使用 Terraform 设置实验室网络环境*'
- en: '*Part 3 of 3 – Accessing the attacker* *VM instance*'
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*第 3 部分（共 3 部分）– 访问攻击者* *VM 实例*'
- en: Let’s get started.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们开始吧。
- en: Part 1 of 3 – Generating SSH keys to access the attacker VM instance
  id: totrans-31
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第 1 部分（共 3 部分）– 生成 SSH 密钥以访问攻击者 VM 实例
- en: 'Let’s start by generating the SSH keys for accessing the attacker VM instance
    later in this chapter:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们首先生成 SSH 密钥，以便稍后在本章中访问攻击者 VM 实例：
- en: Open the **Cloud Shell** editor by clicking the button highlighted in *Figure
    8**.2*:![](image/B19755_08_02.jpg)
  id: totrans-33
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过点击 *图 8**.2* 中的按钮来打开 **Cloud Shell** 编辑器：![](image/B19755_08_02.jpg)
- en: Figure 8.2 – Opening Cloud Shell
  id: totrans-34
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 8.2 – 打开 Cloud Shell
- en: This will open a terminal where we can run bash commands.
  id: totrans-35
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这将打开一个终端，我们可以在其中运行 bash 命令。
- en: Important note
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: In rare cases where Cloud Shell fails to mount the Azure file share (that is,
    you received a warning stating **Failed to mount the Azure file share. Your cloud
    drive won’t be available**), simply restart Cloud Shell (and check if that fixes
    the issue).
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 在少数情况下，如果 Cloud Shell 无法挂载 Azure 文件共享（即收到 **Failed to mount the Azure file share.
    Your cloud drive won’t be available** 的警告），只需重新启动 Cloud Shell（并检查是否能解决问题）。
- en: 'In the Terminal (right after the **$** sign), run the following commands to
    create a new directory (named **kali_keys_ad**) and navigate to it:'
  id: totrans-38
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在终端（**$** 符号后）中运行以下命令，创建一个新目录（命名为 **kali_keys_ad**）并导航到该目录：
- en: '[PRE0]'
  id: totrans-39
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: We will store the generated keys inside this directory.
  id: totrans-40
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 我们将在此目录中存储生成的密钥。
- en: 'Generate a new SSH key pair and save the generated key files in the **kali_keys_ad**
    directory:'
  id: totrans-41
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 生成一对新的 SSH 密钥并将生成的密钥文件保存在 **kali_keys_ad** 目录中：
- en: '[PRE1]'
  id: totrans-42
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: When asked for a passphrase, just press *Enter*. This will generate two files
    – **kali-ad-lab-ssh** (the private key) and **kali-ad-lab-ssh.pub** (the public
    key).
  id: totrans-43
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 当系统要求输入密码时，直接按 *Enter* 键。这将生成两个文件 —— **kali-ad-lab-ssh**（私钥）和 **kali-ad-lab-ssh.pub**（公钥）。
- en: Note
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: '*How do these SSH key files work?* SSH key files consist of a **private key**
    (stored and kept on the client’s machine) and a corresponding **public key** that’s
    uploaded to the remote server. During authentication, the client uses its private
    key to generate a digital signature, and the server verifies it using the corresponding
    public key. Here, the server can confirm the client’s identity based on their
    possession of the private key without having to transmit sensitive credentials.'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: '*这些 SSH 密钥文件是如何工作的？* SSH 密钥文件由 **私钥**（存储并保存在客户端机器上）和相应的 **公钥**（上传到远程服务器）组成。在身份验证过程中，客户端使用其私钥生成数字签名，服务器则使用相应的公钥进行验证。在此过程中，服务器可以根据客户端持有私钥的事实确认其身份，而无需传输敏感的凭证。'
- en: 'Print the public key value using the **cat** command:'
  id: totrans-46
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 **cat** 命令打印公钥值：
- en: '[PRE2]'
  id: totrans-47
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Store this value in a text editor on your local machine as we will use this
    later in the succeeding sections of this chapter.
  id: totrans-48
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 将此值保存在本地机器的文本编辑器中，因为我们将在本章后续部分中使用它。
- en: Click the **Upload/Download files** button, as highlighted in the top-left corner
    of *Figure 8**.3*:![](image/B19755_08_03.jpg)
  id: totrans-49
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击 **上传/下载文件** 按钮，如 *图 8**.3* 中左上角所示：![](image/B19755_08_03.jpg)
- en: Figure 8.3 — Downloading the private key we generated
  id: totrans-50
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 8.3 — 下载我们生成的私钥
- en: Select the **Download** option from the list of options available. When you
    see the **Download a file** pop-up window, type **/kali_keys_ad/kali-ad-lab-ssh**
    in the input field highlighted in *Figure 8**.3* and then click **Download**.
  id: totrans-51
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 从可用选项列表中选择 **Download** 选项。当你看到 **Download a file** 弹出窗口时，在 *图 8.3* 中突出显示的输入框中输入
    **/kali_keys_ad/kali-ad-lab-ssh**，然后点击 **Download**。
- en: Click the **Click here to download your file** link to proceed with the actual
    download operation. This will download the **kali-ad-lab-ssh** key file from the
    Cloud Shell environment to your local machine.
  id: totrans-52
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击 **Click here to download your file** 链接继续进行实际的下载操作。这将把 **kali-ad-lab-ssh**
    密钥文件从 Cloud Shell 环境下载到你的本地机器。
- en: Part 2 of 3 – Setting up the lab network environment with Terraform
  id: totrans-53
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第 2 部分，共 3 部分 — 使用 Terraform 设置实验室网络环境
- en: 'Follow these steps:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 按照以下步骤操作：
- en: 'In the Cloud Shell Terminal (right after the **$** sign), run the following
    commands to create a new directory (named **ch8_environment**) and navigate to
    it:'
  id: totrans-55
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 Cloud Shell 终端（**$** 符号后面）运行以下命令，创建一个新目录（名为 **ch8_environment**）并切换到该目录：
- en: '[PRE3]'
  id: totrans-56
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Download the ZIP file containing the Terraform configuration files for this
    chapter’s lab environment:'
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 下载包含本章实验环境 Terraform 配置文件的 ZIP 文件：
- en: '[PRE4]'
  id: totrans-58
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: This will download the **ad_lab_environment.zip** file to the **ch8_environment**
    directory. Make sure that the download link specified is correct (no spaces) and
    pointing to the **ad_lab_environment.zip** file.
  id: totrans-59
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这将把 **ad_lab_environment.zip** 文件下载到 **ch8_environment** 目录。请确保指定的下载链接正确（没有空格），并指向
    **ad_lab_environment.zip** 文件。
- en: Note
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: You can find the ZIP file containing the Terraform configuration files in this
    book’s GitHub repository at [https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/tree/main/ch08](https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/tree/main/ch08).
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在本书的 GitHub 仓库中找到包含 Terraform 配置文件的 ZIP 文件，链接地址为：[https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/tree/main/ch08](https://github.com/PacktPublishing/Building-and-Automating-Penetration-Testing-Labs-in-the-Cloud/tree/main/ch08)。
- en: 'Use the **unzip** command to extract the contents of the ZIP file you downloaded:'
  id: totrans-62
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 **unzip** 命令解压你下载的 ZIP 文件内容：
- en: '[PRE5]'
  id: totrans-63
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'This should yield the following logs:'
  id: totrans-64
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这应该会产生以下日志：
- en: '[PRE6]'
  id: totrans-65
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Here, we can see the files that were extracted from the ZIP file we just downloaded.
  id: totrans-66
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在这里，我们可以看到刚才从 ZIP 文件中提取出来的文件。
- en: 'Now that we have extracted the files from the ZIP file, we can delete the ZIP
    file as well:'
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 既然我们已经从 ZIP 文件中提取了文件，现在可以删除 ZIP 文件了：
- en: '[PRE7]'
  id: totrans-68
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Open the editor by clicking the button highlighted in *Figure 8**.4*:![](image/B19755_08_04.jpg)
  id: totrans-69
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过点击 *图 8.4* 中突出显示的按钮来打开编辑器：![](image/B19755_08_04.jpg)
- en: Figure 8.4 — Opening the Cloud Shell editor
  id: totrans-70
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 8.4 — 打开 Cloud Shell 编辑器
- en: This should open a file tree, along with an editor where we can modify the code
    of our files directly.
  id: totrans-71
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这应该会打开一个文件树，和一个编辑器，在这里我们可以直接修改文件的代码。
- en: 'Open the **ch8_environment/terraform.tfvars** file in the editor by clicking
    on the file from the file tree:'
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在编辑器中打开 **ch8_environment/terraform.tfvars** 文件，通过点击文件树中的该文件：
- en: '[PRE8]'
  id: totrans-73
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Make sure you replace **<IP ADDRESS>** with the IP address of your local machine
    and **<PUBLIC SSH KEY>** with the string value of the public SSH key (which we
    printed using the **cat** command earlier). Update **<KALI IMAGE ID>** with the
    resource ID of the golden image we created in *[Chapter 5](B19755_05.xhtml)*,
    *Setting Up Isolated Penetration Testing Lab Environments on Azure*. If you are
    wondering what this value looks like, the value for the **"<KALI IMAGE ID>**”
    placeholder should have a format similar to the following:'
  id: totrans-74
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 确保将 **<IP ADDRESS>** 替换为你本地机器的 IP 地址，将 **<PUBLIC SSH KEY>** 替换为公共 SSH 密钥的字符串值（之前我们使用
    **cat** 命令打印过）。更新 **<KALI IMAGE ID>** 为我们在 *[第 5 章](B19755_05.xhtml)* 中创建的黄金镜像的资源
    ID，*《在 Azure 上设置隔离的渗透测试实验室环境》*。如果你想知道这个值是什么样的，**"<KALI IMAGE ID>"** 占位符的值应该具有类似于以下格式：
- en: '[PRE9]'
  id: totrans-75
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Make sure you save the changes you’ve made to the **ch8_environment/terraform.tfvars**
    file.
  id: totrans-76
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 确保保存你对 **ch8_environment/terraform.tfvars** 文件所做的更改。
- en: Note
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: If you are looking for the value for the **<KALI IMAGE ID>** placeholder, type
    **1.0.0** in the search bar and select **VM image version 1.0.0** from the list
    of resources returned in the search results. On the details page (the **Overview**
    blade) of **1.0.0 (gallery/kali_image/1.0.0) VM image version**, click the **JSON
    View** link and then copy the **Resource ID** value from the **Resource** **JSON**
    page.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您正在寻找**<KALI IMAGE ID>**占位符的值，请在搜索栏中输入**1.0.0**，然后从搜索结果返回的资源列表中选择**VM image
    version 1.0.0**。在**1.0.0 (gallery/kali_image/1.0.0) VM image version**的详细信息页面（**概述**窗格）上，单击**JSON
    View**链接，然后从**资源** **JSON**页面复制**资源 ID**值。
- en: 'Let’s use the **terraform init** command to initialize the Terraform working
    directory:'
  id: totrans-79
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让我们使用**terraform init**命令初始化 Terraform 工作目录：
- en: '[PRE10]'
  id: totrans-80
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Note
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Note that we are using Terraform version **v1.3.X** for the hands-on solutions
    in this chapter since this is the version that’s been configured in our Cloud
    Shell environment (as of this writing). If your Terraform version is higher, you
    may set up and use a lower version (for example, **v1.3.2**) in case you encounter
    issues running the Terraform commands.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，本章中的实践解决方案使用 Terraform 版本**v1.3.X**，因为这是我们云 Shell 环境中配置的版本（截至目前为止）。如果您的
    Terraform 版本较高，您可以设置并使用较低版本（例如**v1.3.2**），以防在运行 Terraform 命令时遇到问题。
- en: 'Let’s run **terraform plan** to preview the changes to be performed by Terraform:'
  id: totrans-83
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让我们运行**terraform plan**来预览 Terraform 将执行的更改：
- en: '[PRE11]'
  id: totrans-84
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'This should yield the following output:'
  id: totrans-85
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这应该产生以下输出：
- en: '[PRE12]'
  id: totrans-86
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Note
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Running this command may yield a few deprecation warnings. This should be okay,
    so long as we can successfully run the command without errors.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 运行此命令可能会产生一些弃用警告。只要我们能够成功运行命令而没有错误，这应该是可以接受的。
- en: 'Next, let’s use the **terraform apply** command to implement the changes:'
  id: totrans-89
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 接下来，让我们使用**terraform apply**命令来实施更改：
- en: '[PRE13]'
  id: totrans-90
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'This should return the following output:'
  id: totrans-91
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这应该返回以下输出：
- en: '[PRE14]'
  id: totrans-92
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'If the **terraform apply** command runs without any errors, we should have
    the following environment setup:'
  id: totrans-93
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果**terraform apply**命令运行没有任何错误，我们应该有以下环境设置：
- en: '![](image/B19755_08_05.jpg)'
  id: totrans-94
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![](image/B19755_08_05.jpg)'
- en: Figure 8.5 — VNet peering setup
  id: totrans-95
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 8.5 — VNet peering 设置
- en: Here, we have a **VNet peering** setup similar to what we configured in *[Chapter
    5](B19755_05.xhtml)*, *Setting Up Isolated Penetration Testing Lab Environments
    on Azure*. In addition to the network environment, we should also have the attacker
    VM instance (**vm-kali**) set up as well.
  id: totrans-96
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在这里，我们有一个类似于我们在*[第 5 章](B19755_05.xhtml)*中配置的**VNet peering**设置，*在 Azure 上设置隔离的渗透测试实验室环境*。除了网络环境外，我们还应该设置好攻击者
    VM 实例（**vm-kali**）。
- en: Note
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: This step may take around 10 to 15 minutes to complete. Feel free to grab a
    cup of coffee or tea while waiting! Note that it may take a few minutes for the
    attacker VM instance to be ready (after the **terraform apply** command has finished
    running).
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 此步骤可能需要大约 10 到 15 分钟才能完成。在等待时随时喝杯咖啡或茶！请注意，在**terraform apply**命令运行完成后，攻击者 VM
    实例准备就绪可能需要几分钟时间。
- en: 'Verify that the resources have been created successfully using the following
    command:'
  id: totrans-99
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令验证资源是否已成功创建：
- en: '[PRE15]'
  id: totrans-100
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'This should return the resources that were created, along with the following
    outputs:'
  id: totrans-101
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这应该返回创建的资源，以及以下输出：
- en: '[PRE16]'
  id: totrans-102
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Take note of the value of **<VM KALI PUBLIC IP>** as we will use this value
    in the succeeding set of steps.
  id: totrans-103
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 请注意**<VM KALI PUBLIC IP>**的值，因为我们将在接下来的步骤中使用此值。
- en: Part 3 of 3 – Accessing the attacker VM instance
  id: totrans-104
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第 3 部分 3 – 访问攻击者 VM 实例
- en: 'Now, let’s access the desktop environment of the attacker machine remotely
    from the browser:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们从浏览器远程访问攻击者机器的桌面环境：
- en: Open a new browser tab and access the web-based **noVNC** client using the **http://<VM
    KALI PUBLIC IP>:8081/vnc.html** URL. Make sure you replace **<VM KALI PUBLIC IP>**
    with the **Public IP address** value you copied to the clipboard earlier:![](image/B19755_08_06.jpg)
  id: totrans-106
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开一个新的浏览器选项卡，并使用**http://<VM KALI PUBLIC IP>:8081/vnc.html** URL访问基于 Web 的**noVNC**客户端。确保将**<VM
    KALI PUBLIC IP>**替换为您之前复制到剪贴板的**公共 IP 地址**值：![](image/B19755_08_06.jpg)
- en: Figure 8.6 — noVNC welcome screen
  id: totrans-107
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 8.6 — noVNC 欢迎屏幕
- en: This should open a welcome screen with a **Connect** button, similar to what
    is shown in *Figure 8**.6*.
  id: totrans-108
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这应该打开一个带有**连接**按钮的欢迎屏幕，类似于*图 8**.6*中显示的内容。
- en: Important note
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: If you find yourself unable to access the welcome screen, your IP address might
    have changed already. Simply open the Cloud Shell editor and update the **terraform.tfvars**
    file. Once the **terraform.tfvars** file has been updated with the new IP address
    of your local machine, run the **terraform apply** command again to update the
    firewall rule to whitelist your new IP address.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
- en: Click the **Connect** button and then use **kali123** as the password (or use
    the password you specified in *[Chapter 5](B19755_05.xhtml)* when setting up the
    Kali Linux attacker machine) to access the desktop environment:![](image/B19755_04_32.jpg)
  id: totrans-111
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.7 — Accessing the Kali Linux desktop/GUI environment in the browser
  id: totrans-112
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: We will use this desktop/GUI environment in this chapter. Feel free to open
    the Terminal (inside the desktop environment of the attacker machine) and run
    **ifconfig** to confirm that the Kali Linux VM instance has been launched in **vnet-02**
    (**192.168.0.0/16**).
  id: totrans-113
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
- en: Note that you may also access the attacker Kali Linux server directly from your
    local machine using the **ssh -i kali-ad-lab-ssh kali_admin@<VM KALI PUBLIC IP>**
    command (that is, after running **chmod** **400 kali-ad-lab-ssh**).
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
- en: At this point, we have set up the isolated network environment and the attacker
    VM instance in just a few steps! Now, let’s proceed with launching the target
    VM instances.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
- en: Launching the target VM instances
  id: totrans-117
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this section, we will launch two Windows VM instances for the target resources
    inside the network environment. The first VM instance will serve as the **domain
    controller**, while the second VM instance will serve as the workstation machine
    that will be joined to the domain:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
- en: '![](image/B19755_08_08.jpg)'
  id: totrans-119
  prefs: []
  type: TYPE_IMG
- en: Figure 8.8 — Launching the target VM instances
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
- en: If this is your first time setting up Active Directory, then we can think of
    the **domain controller** as the *brain* of the network that oversees user authentication,
    resource management, and directory services. We can think of the workstation machine
    as one of the arms connected to the body, which interacts with the brain (domain
    controller) to access and utilize network resources and services. It is important
    to note that we can have multiple machines joined to the domain, each acting as
    a separate arm but still under the control and guidance of the domain controller.
    However, in this chapter, we’ll only set up one workstation machine joined to
    the domain.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: This section primarily focuses on launching the Windows VM instances inside
    our Microsoft Azure account. We have a dedicated section right after this on (mis)configuring
    the actual Active Directory setup.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
- en: 'We’ll divide this section into three subparts:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
- en: '*Part 1 of 3 – Launching the VM instance for the* *domain controller*'
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 2 of 3 – Launching the VM instance for the* *workstation machine*'
  id: totrans-126
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 3 of 3 – Testing* *network connectivity*'
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Let’s get started.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
- en: Part 1 of 3 – Launching the VM instance for the domain controller
  id: totrans-129
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Let’s start by launching our first Windows VM instance:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从启动第一个Windows虚拟机实例开始：
- en: In the search bar, type **virtual machines** and press *Enter*:![](image/B19755_08_09.jpg)
  id: totrans-131
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在搜索栏中输入**虚拟机**并按*Enter*键：![](image/B19755_08_09.jpg)
- en: Figure 8.9 — Navigating to the Virtual machines page
  id: totrans-132
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图8.9 — 导航到虚拟机页面
- en: Select **Virtual machines** from the list of available options to navigate to
    the **Virtual** **machines** page.
  id: totrans-133
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 从可用选项中选择**虚拟机**以导航到**虚拟** **机**页面。
- en: On the **Virtual machines** page, click the **Create** button. Choose **Azure
    virtual machine** from the list of options from the drop-down menu.
  id: totrans-134
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**虚拟机**页面，点击**创建**按钮。从下拉菜单中选择**Azure虚拟机**。
- en: 'On the **Create a virtual machine** page, specify the following configuration
    values under the **Basics** tab:'
  id: totrans-135
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**创建虚拟机**页面，指定**基础**选项卡下的以下配置值：
- en: '**Project details** > **Subscription**: (Use existing subscription)'
  id: totrans-136
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**项目详情** > **订阅**：（使用现有订阅）'
- en: '**Project details** > **Resource** **group**: **resource-group-01**'
  id: totrans-137
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**项目详情** > **资源** **组**：**resource-group-01**'
- en: '**Instance details** > **Virtual machine** **name**: **ad-domain-controller**'
  id: totrans-138
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**实例详情** > **虚拟机** **名称**：**ad-domain-controller**'
- en: '**Instance details** > **Region**: **(US)** **East US**'
  id: totrans-139
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**实例详情** > **区域**：**（美国）** **东部美国**'
- en: '**Instance details** > **Security** **type**: **Standard**'
  id: totrans-140
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**实例详情** > **安全** **类型**：**标准**'
- en: '**Instance details** > **Image**: Click the **See all** **images** link'
  id: totrans-141
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**实例详情** > **镜像**：点击**查看所有** **镜像**链接'
- en: Note
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 备注
- en: Clicking **See all images** will redirect you to the **Select an** **image**
    page.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 点击**查看所有镜像**将重定向您到**选择镜像**页面。
- en: On the **Select an image** page, type **windows** in the search box and then
    press *Enter*:![](image/B19755_08_10.jpg)
  id: totrans-144
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**选择镜像**页面，输入**windows**到搜索框中，然后按*Enter*键：![](image/B19755_08_10.jpg)
- en: Figure 8.10 — Selecting the Windows Server image
  id: totrans-145
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图8.10 — 选择Windows Server镜像
- en: Choose **Windows Server** by clicking the **Select** button, as highlighted
    in *Figure 8**.10*.
  id: totrans-146
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 点击**选择**按钮选择**Windows Server**，如*图8.10*所示。
- en: Select **Windows Server 2019 Datacenter – x64 Gen 2** (or if there are other
    newer versions, choose the closest one from the list of options):![](image/B19755_08_11.jpg)
  id: totrans-147
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择**Windows Server 2019 Datacenter – x64 Gen 2**（或者如果有其他更新版本，选择列表中最接近的一个）：![](image/B19755_08_11.jpg)
- en: Figure 8.11 — Selecting the image for the domain controller VM instance
  id: totrans-148
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图8.11 — 为域控制器虚拟机实例选择镜像
- en: This should redirect you back to the **Create a virtual** **machine** page.
  id: totrans-149
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这应该会将您重定向回**创建虚拟** **机**页面。
- en: Important note
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 重要说明
- en: If you are having issues selecting the Windows Server image and making it appear
    in the drop-down menu as the selected image, simply refresh the page and then
    try again. Note that you will need to input the other VM configuration settings
    again.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 如果在选择Windows Server镜像时遇到问题，并且它没有出现在下拉菜单中，简单地刷新页面，然后再试一次。请注意，您可能需要重新输入其他虚拟机配置设置。
- en: 'Continuing where we left off on the **Create a virtual machine** page, specify
    the following configuration values as well:'
  id: totrans-152
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**创建虚拟机**页面继续之前的步骤，指定以下配置值：
- en: '**Project details** > **Size**: **Standard_B2ms – 2 vcpus, 8** **GiB memory**'
  id: totrans-153
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**项目详情** > **大小**：**Standard_B2ms – 2 vcpus, 8** **GiB内存**'
- en: '**Administrator account** > **Username**: **admin_user**'
  id: totrans-154
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**管理员账户** > **用户名**：**admin_user**'
- en: '**Administrator account** > **Password**: **Windows1234!!!**'
  id: totrans-155
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**管理员账户** > **密码**：**Windows1234!!!**'
- en: '**Administrator account** > **Confirm** **password**: **Windows1234!!!**'
  id: totrans-156
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**管理员账户** > **确认** **密码**：**Windows1234!!!**'
- en: '**Inbound port rules** > **Public inbound** **ports**: **None**'
  id: totrans-157
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**入站端口规则** > **公共入站** **端口**：**无**'
- en: 'Click the **Next : Disks >** button after.'
  id: totrans-158
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '然后点击**下一步 : 磁盘 >**按钮。'
- en: Accept the default configuration under the **Disks** tab and click **Next :**
    **Networking >**.
  id: totrans-159
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 接受**磁盘**选项卡下的默认配置，然后点击**下一步 :** **网络 >**。
- en: 'Under the **Networking** tab, make sure that the following configuration values
    are set:'
  id: totrans-160
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**网络**选项卡下，确保设置以下配置值：
- en: '**Virtual** **network**: **vnet-01**'
  id: totrans-161
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**虚拟** **网络**：**vnet-01**'
- en: '**Subnet**: **subnet-01 (10.0.1.0/24)**'
  id: totrans-162
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**子网**：**subnet-01 (10.0.1.0/24)**'
- en: '**NIC network security** **group**: **Advanced**'
  id: totrans-163
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**NIC网络安全** **组**：**高级**'
- en: '**Configure network security** **group**: **nsg-01**'
  id: totrans-164
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**配置网络安全** **组**：**nsg-01**'
- en: '**Delete public IP and NIC when VM is** **deleted**: **(checked)**'
  id: totrans-165
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**删除公共IP和NIC当虚拟机** **被删除时**：**（已勾选）**'
- en: Here, we are configuring our Windows VM instance to be launched inside the VNet
    (**vnet-01**) we set up automatically using Terraform in the previous section.
  id: totrans-166
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在这里，我们正在配置我们的Windows虚拟机实例，使其在前一节中使用Terraform自动设置的VNet（**vnet-01**）内启动。
- en: Now, continue clicking the **Next** button until you reach the last tab.
  id: totrans-167
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，继续点击**Next**按钮，直到到达最后一个标签页。
- en: Note
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Simply accept the default settings under **Disks**, **Networking**, **Management**,
    **Monitoring**, **Advanced**, **Tags**, and **Review +** **create**.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 只需接受**Disks**、**Networking**、**Management**、**Monitoring**、**Advanced**、**Tags**和**Review
    +** **create**下的默认设置。
- en: Once you reach the **Review + create** tab, click the **Create** button after
    reviewing the configuration details.
  id: totrans-170
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 一旦进入**Review + create**标签页，审阅配置详情后，点击**Create**按钮。
- en: Wait until you see the **Your deployment is complete** message. Scroll down
    and click the **Go to resource** button. This should redirect you to the **Overview**
    blade of the VM we just created (**ad-domain-controller**).
  id: totrans-171
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 等待直到看到**Your deployment is complete**消息。向下滚动并点击**Go to resource**按钮。这将把你重定向到我们刚刚创建的
    VM（**ad-domain-controller**）的**Overview**页面。
- en: Locate and select **Connect** under the **Settings** section of the resource
    menu in the left pane.
  id: totrans-172
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在左侧面板的资源菜单中找到并选择**Connect**，位于**Settings**部分。
- en: Click **Download RDP File**, as highlighted in *Figure 8**.12*:![](image/B19755_08_12.jpg)
  id: totrans-173
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**Download RDP File**，如*图 8.12*所示：![](image/B19755_08_12.jpg)
- en: Figure 8.12 — Download RDP File
  id: totrans-174
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 8.12 — 下载 RDP 文件
- en: This will download an RDP file (**ad-domain-controller.rdp**) to your local
    machine. If you are seeing a newer version of the **Connect** page of the portal,
    simply click the **Select** button under **Native RDP** (under **Most common**)
    before clicking the **Download RDP** **File** button.
  id: totrans-175
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这将会下载一个 RDP 文件（**ad-domain-controller.rdp**）到本地机器。如果你看到门户网站的**Connect**页面是新版，只需点击**Native
    RDP**下的**Select**按钮（位于**Most common**下），然后再点击**Download RDP** **File**按钮。
- en: Note
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: '**Remote Desktop Protocol** (**RDP**) is a secure protocol (developed by Microsoft)
    that allows users to access and control a computer’s desktop interface over a
    network. With this, an RDP file is simply a configuration file that contains the
    necessary information to access a remote machine’s interface over a network. For
    more information about this topic, feel free to check out [https://learn.microsoft.com/en-us/azure/virtual-machines/windows/connect-rdp](https://learn.microsoft.com/en-us/azure/virtual-machines/windows/connect-rdp).'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: '**远程桌面协议**（**RDP**）是一种安全协议（由微软开发），允许用户通过网络访问和控制计算机的桌面界面。通过此协议，RDP 文件只是一个配置文件，其中包含访问远程机器界面所需的信息。如需更多信息，请访问[https://learn.microsoft.com/en-us/azure/virtual-machines/windows/connect-rdp](https://learn.microsoft.com/en-us/azure/virtual-machines/windows/connect-rdp)。'
- en: Open the RDP file using the **Microsoft Remote Desktop** app. If the Microsoft
    Remote Desktop app has been installed already, we can simply double-click the
    RDP file stored inside our **Downloads** folder (or alternative) to connect to
    the Windows VM instance (**ad-domain-controller**).
  id: totrans-178
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用**Microsoft Remote Desktop**应用打开 RDP 文件。如果已经安装了 Microsoft Remote Desktop 应用，我们可以直接双击存储在**Downloads**文件夹（或其他地方）的
    RDP 文件，连接到 Windows VM 实例（**ad-domain-controller**）。
- en: Simply use **admin_user** as the username and **Windows1234!!!** as the password
    when you’re prompted for the credentials of the user account:![](image/B19755_08_13.jpg)
  id: totrans-179
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 当系统提示输入用户账户凭证时，直接使用**admin_user**作为用户名，**Windows1234!!!**作为密码：![](image/B19755_08_13.jpg)
- en: Figure 8.13 — Enter Your User Account
  id: totrans-180
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 8.13 — 输入你的用户账户
- en: 'Click the **Continue** button when you see the **You are connecting to the
    RDP** **host...** popup:'
  id: totrans-181
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 当看到**You are connecting to the RDP** **host...**弹窗时，点击**Continue**按钮：
- en: Important note
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: In rare cases where we encounter a black screen, simply restart the VM instance
    and then try connecting again. Otherwise, delete the VM instance, recreate it,
    and then connect again.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 在极少数情况下，如果遇到黑屏，只需重启 VM 实例，再尝试连接。如果问题依然存在，可以删除该 VM 实例，重新创建，再进行连接。
- en: '![](image/B19755_08_14.jpg)'
  id: totrans-184
  prefs: []
  type: TYPE_IMG
  zh: '![](image/B19755_08_14.jpg)'
- en: Figure 8.14 — Server Manager open upon signing in
  id: totrans-185
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 图 8.14 — 登录后打开 Server Manager
- en: We should see **Server Manager** open upon signing into the **admin_user** user
    account.
  id: totrans-186
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 登录到**admin_user**用户账户后，我们应该看到**Server Manager**打开。
- en: Note
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: If this is your first time using **Server Manager**, you can think of it as
    a centralized interface where administrators can perform various tasks and manage
    different aspects of a Windows Server environment. This includes configuring server
    roles and features, monitoring server performance, setting up and configuring
    Active Directory, and more.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 如果这是你第一次使用**Server Manager**，你可以将其视为一个集中式界面，管理员可以在其中执行各种任务并管理 Windows Server
    环境的不同方面。这包括配置服务器角色和功能、监控服务器性能、设置和配置 Active Directory 等。
- en: Click the search button and type **cmd** in the search box, similar to what
    we have in *Figure 8**.15*:![](image/B19755_08_15.jpg)
  id: totrans-189
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 单击搜索按钮并在搜索框中键入**cmd**，类似于 *图8**.15* 所示:![](image/B19755_08_15.jpg)
- en: Figure 8.15 — Opening the Command Prompt application
  id: totrans-190
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图8.15 — 打开命令提示符应用程序
- en: Click **Command Prompt** (under **Best match**) to open the Command Prompt application.
    Here, we can run various commands to interact with the operating system and perform
    tasks such as file and directory manipulation, system configuration, network diagnostics,
    and more.
  id: totrans-191
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 单击**命令提示符**（在**最佳匹配**下）打开命令提示符应用程序。在这里，我们可以运行各种命令与操作系统交互，并执行文件和目录操作、系统配置、网络诊断等任务。
- en: Inside the Command Prompt, run **ipconfig** to retrieve the private IP address
    of the VM instance:![](image/B19755_08_16.jpg)
  id: totrans-192
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在命令提示符内运行**ipconfig**以检索虚拟机实例的私有IP地址:![](image/B19755_08_16.jpg)
- en: Figure 8.16 — Results after running ipconfig
  id: totrans-193
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图8.16 — 运行ipconfig后的结果
- en: Here, we can see that the private IP address of our first Windows VM instance
    (which will serve as the Active Directory domain controller once we’ve configured
    it later in this chapter) is **1.0.1.4**. Note that you might get a different
    private IP address value after running **ipconfig**.
  id: totrans-194
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在这里，我们可以看到我们第一个Windows虚拟机实例的私有IP地址（一旦我们稍后在本章中配置它后将作为活动目录域控制器），为**1.0.1.4**。请注意，您在运行**ipconfig**后可能会获得不同的私有IP地址值。
- en: Note
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: In the succeeding set of steps in this chapter, we will assume that the private
    IP address of our domain controller machine is **1.0.1.4**. Make sure you update
    the IP address value that’s used in the commands in case you get a different private
    IP address value after running **ipconfig** in the previous step.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章后续的一系列步骤中，我们将假定我们域控制器机器的私有IP地址为**1.0.1.4**。请确保在上一步中运行**ipconfig**后获得不同的私有IP地址值时更新使用的IP地址值，在命令中使用。
- en: At this point, we have a single Windows VM instance (in addition to the attacker
    VM instance) running inside our isolated network environment. **Note that this
    Windows VM instance does not have Active Directory set up yet!** That said, do
    not close the RDP session yet for this VM instance (**ad-domain-controller**)
    as we will set up and configure Active Directory in this instance in the next
    section. For now, you can minimize the RDP session window and navigate back to
    the browser where we have the Azure portal open.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 此时，在我们隔离的网络环境中有一个运行的单个Windows虚拟机实例（除了攻击者虚拟机实例）。 **请注意，此Windows虚拟机实例尚未设置活动目录！**
    因此，在接下来的部分中，请不要关闭此虚拟机实例（**ad-domain-controller**）的RDP会话，我们将在下一节中在此实例中设置和配置活动目录。暂时，您可以最小化RDP会话窗口，并导航回在其中打开Azure门户的浏览器。
- en: Part 2 of 3 – Launching the VM instance for the workstation machine
  id: totrans-198
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第2部分 – 启动工作站计算机的虚拟机实例
- en: 'Now, let’s launch a second Windows VM instance for the workstation machine:'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: '现在，让我们为工作站计算机启动第二个Windows虚拟机实例:'
- en: Navigate back to the browser where we have the Azure portal open. In the search
    bar (of the Microsoft Azure portal), type **virtual machines** and press *Enter*:![](image/B19755_08_09.jpg)
  id: totrans-200
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 返回在其中打开Azure门户的浏览器。在Microsoft Azure门户的搜索栏中，键入**虚拟机**并按 *Enter*:![](image/B19755_08_09.jpg)
- en: Figure 8.17 — Navigating to the Virtual machines page
  id: totrans-201
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图8.17 — 导航至虚拟机页面
- en: Select **Virtual machines** from the list of available options to navigate to
    the **Virtual machines** page (similar to what is shown in *Figure 8**.17*).
  id: totrans-202
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 从可用选项列表中选择**虚拟机**，跳转至**虚拟机**页面（类似于 *图8**.17* 所示）。
- en: On the **Virtual machines** page, click the **Create** button. Choose **Azure
    virtual machine** from the list of options from the drop-down menu.
  id: totrans-203
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**虚拟机**页面上，单击**创建**按钮。从下拉菜单中选择**Azure虚拟机**。
- en: 'On the **Create a virtual machine** page, specify the following configuration
    values under the **Basics** tab:'
  id: totrans-204
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '在**创建虚拟机**页面上，在**基本信息**选项卡下指定以下配置数值:'
- en: '**Project details** > **Subscription**: (Use existing subscription)'
  id: totrans-205
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**项目详情** > **订阅**:（使用现有订阅）'
- en: '**Project details** > **Resource** **group**: **resource-group-01**'
  id: totrans-206
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**项目详情** > **资源** **组**: **resource-group-01**'
- en: '**Instance details** > **Virtual machine** **name**: **ad-workstation-machine**'
  id: totrans-207
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**实例详情** > **虚拟机** **名称**: **ad-workstation-machine**'
- en: '**Instance details** > **Region**: **(US)** **East US**'
  id: totrans-208
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**实例详情** > **区域**: **(美国)** **东部美国**'
- en: '**Instance details** > **Security** **type**: **Standard**'
  id: totrans-209
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**实例详情** > **安全性** **类型**: **标准**'
- en: '**Instance details** > **Image**: Click the **See all** **images** link'
  id: totrans-210
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**实例详情** > **镜像**: 点击**查看全部** **镜像**链接'
- en: Note
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Clicking **See all images** will redirect you to the **Select an** **image**
    page.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
- en: On the **Select an image** page, type **windows** in the search box and then
    press *Enter*:![](image/B19755_08_18.jpg)
  id: totrans-213
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.18 — Selecting the Microsoft Windows 10 image
  id: totrans-214
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Choose **Microsoft Windows 10** by clicking the **Select** button, as highlighted
    in *Figure 8**.18*.
  id: totrans-215
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Select **Windows 10 Enterprise, version 22H2 – x64 Gen2** (or if there are other
    newer versions, choose the closest one from the list of options):![](image/B19755_08_19.jpg)
  id: totrans-216
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.19 — Selecting the image for the workstation VM instance
  id: totrans-217
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: This should redirect you back to the **Create a virtual** **machine** page.
  id: totrans-218
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
- en: If you are having issues selecting the Windows Server image and making it reflect
    in the drop-down menu as the selected image, simply refresh the page and then
    try again. Note that you will need to input the VM configuration settings again.
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
- en: 'Continuing where we left off on the **Create a virtual machine** page, specify
    the following configuration values as well:'
  id: totrans-221
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Project details** > **Size**: **Standard_B2ms – 2 vcpus, 8** **GiB memory**'
  id: totrans-222
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Administrator account** > **Username**: **workstation_user**'
  id: totrans-223
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Administrator account** > **Password**: **Workstation1234!!!**'
  id: totrans-224
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Administrator account** > **Confirm** **password**: **Workstation1234!!!**'
  id: totrans-225
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Inbound port rules** > **Public inbound** **ports**: **None**'
  id: totrans-226
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Licensing** > **I confirm I have an eligible Windows 10/11 license with multi-tenant
    hosting** **rights**: (checked)'
  id: totrans-227
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Click the **Next : Disks >** button after you''ve added the specified values.'
  id: totrans-228
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Accept the default configuration under the **Disks** tab and click **Next :**
    **Networking >**.
  id: totrans-229
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Under the **Networking** tab, make sure that the following configuration values
    are set:'
  id: totrans-230
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Virtual** **network**: **vnet-01**'
  id: totrans-231
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Subnet**: **subnet-01 (10.0.1.0/24)**'
  id: totrans-232
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**NIC network security** **group**: **Advanced**'
  id: totrans-233
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Configure network security** **group**: **nsg-01**'
  id: totrans-234
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Delete public IP and NIC when VM is** **deleted**: **(checked)**'
  id: totrans-235
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Here, we are configuring our second Windows VM instance (**ad-workstation-machine**)
    so that it’s deployed inside the same VNet (and subnet) as the first Windows VM
    instance. Note that these network resources already exist and were created automatically
    using Terraform in the previous section.
  id: totrans-236
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Now, continue clicking the **Next** button until you reach the last tab.
  id: totrans-237
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
- en: Simply accept the default settings under **Disks**, **Networking**, **Management**,
    **Monitoring**, **Advanced**, **Tags**, and **Review +** **create**.
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
- en: Once you reach the **Review + create** tab, click the **Create** button after
    reviewing the configuration details.
  id: totrans-240
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Wait until you see the **Your deployment is complete** message. Scroll down
    and click the **Go to resource** button. This should redirect you to the **Overview**
    blade of the VM we just created (**ad-workstation-machine**).
  id: totrans-241
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Locate and select **Connect** under the **Settings** section of the resource
    menu in the left pane.
  id: totrans-242
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click **Download RDP File**, as highlighted in *Figure 8**.20*:![](image/B19755_08_20.jpg)
  id: totrans-243
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.20 — Download RDP File
  id: totrans-244
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: This will download an RDP file (**ad-workstation-machine.rdp**) to your local
    machine. If you are viewing a newer version of the **Connect** page of the portal,
    simply click the **Select** button under **Native RDP** (under **Most common**)
    before clicking the **Download RDP** **File** button.
  id: totrans-245
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Open the RDP file using the **Microsoft Remote Desktop** app. Simply use **workstation_user**
    as the username and **Workstation1234!!!** as the password when prompted for the
    credentials:![](image/B19755_08_21.jpg)
  id: totrans-246
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.21 — Enter Your User Account
  id: totrans-247
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click the **Continue** button when you see the **You are connecting to the RDP**
    **host...** popup.
  id: totrans-248
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Important note
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
- en: In rare cases where we encounter a black screen, simply restart the VM instance
    and then try connecting again. Otherwise, delete the VM instance, recreate it,
    and then connect again.
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
- en: On the **Choose privacy settings for your device** screen, click **Accept**.
  id: totrans-251
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Type **cmd** in the search bar (located in the lower left corner of the screen),
    similar to what is shown in *Figure 8**.22*:![](image/B19755_08_22.jpg)
  id: totrans-252
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.22 — Opening the Command Prompt
  id: totrans-253
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click **Command Prompt** (under **Best match**) to open the Command Prompt application.
  id: totrans-254
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Run **ipconfig** to check the private IP address of the VM instance:![](image/B19755_08_23.jpg)
  id: totrans-255
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.23 — Results after running ipconfig inside the workstation VM instance
  id: totrans-256
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: This should return a set of configuration values similar to what we have in
    *Figure 8**.23*. Note that you might get a different IP address value for **IPv4
    Address**.
  id: totrans-257
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Part 3 of 3 – Testing network connectivity
  id: totrans-258
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'With the target VM instances launched, we need to verify if the target instances
    inside one VNet (**vnet-01**) can be reached from the attacker VM instance launched
    in another VNet (**vnet-02**) to test the VNet peering that we set up automatically
    using Terraform earlier:'
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
- en: '![](image/B19755_08_24.jpg)'
  id: totrans-260
  prefs: []
  type: TYPE_IMG
- en: Figure 8.24 — Testing network connectivity
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
- en: 'That said, let’s quickly check if both Windows instances (**ad-domain-controller**
    and **ad-workstation-machine**) are reachable from the attacker VM instance (**vm-kali**)
    before we proceed with the succeeding set of steps:'
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
- en: Navigate back to the browser tab you used to access the desktop/GUI environment
    of the attacker machine. If you have closed the browser tab already, simply go
    to **http://<VM KALI PUBLIC IP>:8081/vnc.html** in a new browser tab. Make sure
    you replace **<VM KALI PUBLIC IP>** with the **Public IP address** value of the
    Kali Linux VM instance.
  id: totrans-263
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
- en: Use **kali123** as the password (or the password you specified in *[Chapter
    5](B19755_05.xhtml)*, *Setting Up Isolated Penetration Testing Lab Environments
    on Azure*, when setting up the Kali Linux attacker machine) to access the desktop
    environment.
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
- en: Open a Terminal window inside the Kali Linux instance by clicking the icon highlighted
    in *Figure 8**.25*:![](image/B19755_08_25.jpg)
  id: totrans-266
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.25 — Opening a Terminal window
  id: totrans-267
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: This should open a Terminal window where we can run commands after the **$**
    sign.
  id: totrans-268
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Now, let’s run the following commands to scan the VM instance that will serve
    as the domain controller (**ad-domain-controller**):'
  id: totrans-269
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-270
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Make sure you update the **IP** variable value with the actual private IP address
    of the first target VM instance (**ad-domain-controller**). Running this command
    should give us the following results:'
  id: totrans-271
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](image/B19755_08_26.jpg)'
  id: totrans-272
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: Figure 8.26 — Initial scan on the domain controller VM instance
  id: totrans-273
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Here, we can see that network traffic from the attacker machine (**vm-kali**)
    can reach the domain controller VM instance (**ad-domain-controller**).
  id: totrans-274
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Next, let’s run the following commands to perform a scan of the second target
    VM instance (**ad-workstation-machine**). This will serve as the workstation that
    will be joined to the domain controller later in this chapter:'
  id: totrans-275
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-276
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Again, make sure you update the **IP** variable value with the actual private
    IP address of the second target VM instance (**ad-workstation-machine**). This
    should give us the following results:'
  id: totrans-277
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](image/B19755_08_27.jpg)'
  id: totrans-278
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: Figure 8.27 — Initial scan on the workstation machine (ad-workstation-machine)
  id: totrans-279
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Here, we can see that network traffic from the attacker machine (**vm-kali**)
    can reach the second Windows VM instance (**ad-workstation-machine**).
  id: totrans-280
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: At this point, we have our Windows VM instances ready. **Note that these Windows
    VM instances do not have Active Directory set up yet!** In the next section, we
    will complete our lab environment and set up and (mis)configure Active Directory
    inside these Windows VM instances.
  id: totrans-281
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Setting up and configuring the Active Directory lab
  id: totrans-282
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this section, we will set up the Active Directory domain controller, along
    with the workstation machine (which will be joined to the domain). Before we proceed
    with the hands-on portion of this section, let’s discuss some of the relevant
    concepts and terminologies first:'
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
- en: '**Domain**: This represents a logical group of network resources. We can think
    of a domain as a virtual city with its own unique identity and infrastructure.
    Just as a city groups together various neighborhoods, a domain logically groups
    network resources together.'
  id: totrans-284
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Domain controller**: This is a server that’s responsible for providing authentication
    and authorization services for domain users and computers. We can think of a domain
    controller as the city’s main security office that ensures only authorized individuals
    can access different parts of the city.'
  id: totrans-285
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Forest**: This represents the highest hierarchical level in Active Directory
    and contains multiple domains (along with other resources). We can think of a
    forest as a region containing multiple cities where each city (domain) operates
    independently, but they all belong to the same forest.'
  id: totrans-286
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Organizational unit** (**OU**): This is a container within a domain that
    can be used to contain users, computers, and other objects. We can think of an
    OU as a district within a city. It’s like a container that’s used to organize
    and manage resources, similar to how districts categorize buildings and services.'
  id: totrans-287
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Object**: This represents a single element or resource part of the Active
    Directory network (including user accounts, groups, and shared folders). We can
    think of objects as the individual elements that make up a city (such as houses,
    businesses, and parks).'
  id: totrans-288
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Note
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
- en: Note that there are other Active Directory concepts we can explore and discuss
    (which we did not include here). However, this should do the trick for now as
    an introduction to the fundamental concepts and components when working with Active
    Directory.
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
- en: With some of the key concepts defined, let’s define and describe Active Directory.
    As we can see, **Active Directory** is simply a *directory service* that’s designed
    to manage network resources and user accounts. Just as a city’s administration
    manages various neighborhoods and resources, Active Directory centrally manages
    network elements, user identities, and access controls within a digital ecosystem.
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
- en: 'Now that we have a better understanding of the key concepts for this section,
    we can proceed with setting up and (mis)configuring Active Directory inside the
    two Windows VM instances we launched in the previous section. Given that setting
    up the Active Directory lab requires a relatively long sequence of steps, we will
    divide this section into 12 parts:'
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
- en: '*Part 1 of 12 – Installing Active Directory* *Domain Services*'
  id: totrans-293
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 2 of 12 – Promoting the VM instance to become the* *domain controller*'
  id: totrans-294
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 3 of 12 – Setting up Active Directory* *Certificate Services*'
  id: totrans-295
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 4 of 12 – Configuring Active Directory* *Certificate Services*'
  id: totrans-296
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 5 of 12 – Updating the trusted hosts configuration and enabling* *PowerShell
    Remoting*'
  id: totrans-297
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 6 of 12 – Setting up the flag inside the* *domain controller*'
  id: totrans-298
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 7 of 12 – Creating the John* *Doe user*'
  id: totrans-299
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 8 of 12 – Creating the Jane* *Doe user*'
  id: totrans-300
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 9 of 12 – Creating the Service* *Account user*'
  id: totrans-301
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 10 of 12 – Setting up the SPN for the* *service account*'
  id: totrans-302
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 11 of 12 – Adding the Service Account user to the Remote Management*
    *Users group*'
  id: totrans-303
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Part 12 of 12 – Configuring the* *workstation machine*'
  id: totrans-304
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Without further ado, let’s begin!
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
- en: Part 1 of 1 – Installing Active Directory Domain Services
  id: totrans-306
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '*Remember the RDP session we minimized in a previous section?* Let’s use that
    session again as we will be installing **Active Directory Domain Services** inside
    the first VM instance (**ad-domain-controller**):'
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
- en: Make sure that you have the RDP session to the first VM instance (**ad-domain-controller**)
    open before proceeding to the next step.
  id: totrans-308
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note
  id: totrans-309
  prefs: []
  type: TYPE_NORMAL
- en: '**Active Directory** and **Active Directory Domain Services** (**AD DS**) are
    terms that are sometimes used interchangeably. However, while AD DS specifically
    refers to the core directory service component of Active Directory, it’s important
    to note that Active Directory (as a whole) encompasses a broader range of services
    and components than just AD DS.'
  id: totrans-310
  prefs: []
  type: TYPE_NORMAL
- en: Go to **Server Manager** > **Dashboard** and click **Add roles** **and features**:![](image/B19755_08_28.jpg)
  id: totrans-311
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.28 — Add roles and features
  id: totrans-312
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: You can find the **Add roles and features** link under **Configure this local
    server** (as highlighted in *Figure 8**.28*).
  id: totrans-313
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In the **Before you begin** tab, click **Next >**.
  id: totrans-314
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Under **Installation Type**, make sure that the **Role-based or feature-based
    installation** option is selected. Click the **Next >** button after.
  id: totrans-315
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Under **Server Selection**, make sure that the **Select a server from the server
    pool** option is selected before clicking **Next >**.
  id: totrans-316
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Under **Server Roles**, toggle *on* (check) the **Active Directory Domain**
    **Services** checkbox:![](image/B19755_08_29.jpg)
  id: totrans-317
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.29 — Server Roles
  id: totrans-318
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Find the checkbox highlighted in *Figure 8**.29*. Make sure you click the correct
    checkbox (that is, the checkbox corresponding to the **Active Directory Domain
    Services** option) since there are multiple options whose names start with “Active
    Directory”.
  id: totrans-319
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Checking the checkbox from the previous step should open the **Add Roles and
    Features Wizard** area (similar to what we have in *Figure 8**.30*):![](image/B19755_08_30.jpg)
  id: totrans-320
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.30 — Add Features
  id: totrans-321
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click the **Add Features** button (highlighted in *Figure 8**.30*) and then
    click **Next >** after (in the **Server** **Roles** tab).
  id: totrans-322
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In the **Features** and **AD DS** tabs, click **Next >** (twice) to proceed.
  id: totrans-323
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Confirmation** tab, click **Install**:![](image/B19755_08_31.jpg)
  id: totrans-324
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.31 — Confirm installation selections
  id: totrans-325
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click the **Close** button once the installation has finished. *Wasn’t that
    easy?* **At this point, we should have AD DS installed already!** Of course, we
    are not done yet as we will be working on other configuration steps in the succeeding
    parts of this section.
  id: totrans-326
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
- en: This step may take 10 to 15 minutes to complete. Feel free to grab a cup of
    coffee or tea while waiting!
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
- en: Part 2 of 12 – Promoting the VM instance to become the domain controller
  id: totrans-329
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Now, it’s time to promote the machine (**ad-domain-controller**) so that it
    becomes the domain controller:'
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
- en: Click the flag button (highlighted in *Figure 8**.32*) and then click **Promote
    this server to a** **domain controller**:![](image/B19755_08_32.jpg)
  id: totrans-331
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.32 — Promoting the machine to a domain controller
  id: totrans-332
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '*What does it mean to be a domain controller?* Once a server is promoted to
    a domain controller, it will be responsible for managing user authentication,
    authorization, and resource management within the network.'
  id: totrans-333
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Under **Deployment Configuration**, select **Add a** **new forest**:![](image/B19755_08_33.jpg)
  id: totrans-334
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.33 — Deployment Configuration
  id: totrans-335
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: For the **Root domain name** value, specify **domain.local** (similar to what
    is shown in *Figure 8**.33*). Click **Next >** after.
  id: totrans-336
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Under **Domain Controller Options**, use **Restore1234!!!** for the password:![](image/B19755_08_34.jpg)
  id: totrans-337
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.34 — Deployment Controller Options
  id: totrans-338
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Make sure you specify **Restore1234!!!** for both the **Password** and **Confirm
    password** fields (similar to what is shown in *Figure 8**.34*). Leave everything
    else as-is before clicking **Next >**.
  id: totrans-339
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In the **DNS Options** tab, click **Next** **>.**
  id: totrans-340
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Additional Options** tab, verify that the auto-populated **The NetBIOS
    domain name** field value is **DOMAIN**:![](image/B19755_08_35.jpg)
  id: totrans-341
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.35 — Additional Options
  id: totrans-342
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click the **Next >** button after (as highlighted in *Figure 8**.35*).
  id: totrans-343
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In the **Paths** tab, leave everything as-is and click the **Next >** button.
  id: totrans-344
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Review Options** tab, click **Next >**.
  id: totrans-345
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Prerequisites Check** tab, click the **Install** button (as highlighted
    in *Figure 8**.36*):![](image/B19755_08_36.jpg)
  id: totrans-346
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.36 — Prerequisites Check
  id: totrans-347
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: This step may take around 5 to 10 minutes to complete. This will automatically
    reboot the Windows VM instance (**ad-domain-controller**) and you will lose the
    RDP connection a few seconds after getting the **You’re about to be signed out**
    notification pop-up window. Wait for around 5 minutes before proceeding with the
    next set of steps.
  id: totrans-348
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-349
  prefs: []
  type: TYPE_NORMAL
- en: Do not worry – we can connect to the first Windows VM instance (**ad-domain-controller**)
    via RDP again after a few minutes. This time, we should be able to sign in using
    the domain credentials (as we’ll see in the next set of steps)!
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
- en: Part 3 of 12 – Setting up Active Directory Certificate Services
  id: totrans-351
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Now, we will be setting up **Active Directory Certificate Services** (**AD
    CS**):'
  id: totrans-352
  prefs: []
  type: TYPE_NORMAL
- en: Connect to the first Windows VM instance (**ad-domain-controller**) via RDP
    again. Simply use **domain\admin_user** as the username and **Windows1234!!!**
    as the password:![](image/B19755_08_37.jpg)
  id: totrans-353
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.37 — Enter Your User Account
  id: totrans-354
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click the **Continue** button when you see the **You are connecting to the RDP**
    **host...** popup.
  id: totrans-355
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-356
  prefs: []
  type: TYPE_NORMAL
- en: You may need to wait for around 5 minutes before you can sign in and proceed
    to the next step.
  id: totrans-357
  prefs: []
  type: TYPE_NORMAL
- en: Click **Add roles** **and features**:![](image/B19755_08_38.jpg)
  id: totrans-358
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.38 — Add roles and features
  id: totrans-359
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: You can find the **Add roles and features** link under **Configure this local
    server** (as highlighted in *Figure 8**.38*).
  id: totrans-360
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In the **Before You Begin** tab, click **Next >**.
  id: totrans-361
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Installation Type** tab, make sure that the **Role-based or feature-based
    installation** option is selected before clicking the **Next >** button.
  id: totrans-362
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Server Selection** tab, leave everything as-is and then click **Next
    >**.
  id: totrans-363
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Server Roles** tab, locate the checkbox corresponding to **Active Directory**
    **Certificate Services**:![](image/B19755_08_39.jpg)
  id: totrans-364
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.39 — Active Directory Certificate Services
  id: totrans-365
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Select (and check) **Active Directory Certificate Services**, as highlighted
    in *Figure 8**.39*.
  id: totrans-366
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-367
  prefs: []
  type: TYPE_NORMAL
- en: AD CS is a specific component of Active Directory that focuses on providing
    a **public key infrastructure** (**PKI**) for issuing and managing digital certificates.
    Similar to AD DS, AD CS plays a crucial role in enhancing security within a network
    environment by enabling encryption, authentication, and secure communication.
  id: totrans-368
  prefs: []
  type: TYPE_NORMAL
- en: Checking the checkbox from the previous step should open the **Add Roles and
    Features Wizard** area. Click the **Add Features** button and then click **Next
    >**.
  id: totrans-369
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Features** tab, click **Next >**.
  id: totrans-370
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **AD CS** tab, click **Next >**.
  id: totrans-371
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **AD CS > Role Services** tab, ensure the **Certification Authority**
    checkbox is toggled *on* (checked). Click the **Next >** button after:![](image/B19755_08_40.jpg)
  id: totrans-372
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.40 — AD CS > Role Services
  id: totrans-373
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Other than making sure that the **Certification Authority** checkbox is checked,
    we can leave everything else as-is.
  id: totrans-374
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In the **Confirmation** tab, check the **Restart the destination server automatically
    if** **required** checkbox:![](image/B19755_08_41.jpg)
  id: totrans-375
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.41 — Confirm installation selections
  id: totrans-376
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: A pop-up window similar to what is shown in *Figure 8**.41* will appear. Select
    **Yes**.
  id: totrans-377
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click the **Install** button after. Once the installation is complete, which
    will be after around 5 minutes (**Configuration required. Installation succeeded
    on ad-domain-contr.domain.local**), click **Close**.
  id: totrans-378
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note
  id: totrans-379
  prefs: []
  type: TYPE_NORMAL
- en: '**At this point, we should have AD CS installed**. Similar to AD DS, we will
    have to work on a few more steps to configure what we just installed.'
  id: totrans-380
  prefs: []
  type: TYPE_NORMAL
- en: Part 4 of 12 – Configuring Active Directory Certificate Services
  id: totrans-381
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Now, let’s configure AD CS:'
  id: totrans-382
  prefs: []
  type: TYPE_NORMAL
- en: 'Click the flag (with a warning sign) and select **Configure Active Directory
    Certificate Services on the destination server** (as highlighted in *Figure 8**.42*):'
  id: totrans-383
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](image/B19755_08_42.jpg)'
  id: totrans-384
  prefs: []
  type: TYPE_IMG
- en: Figure 8.42 — Configure Active Directory Certificate Services on the destination
    server
  id: totrans-385
  prefs: []
  type: TYPE_NORMAL
- en: In the **Credentials** tab, click **Next >**:![](image/B19755_08_43.jpg)
  id: totrans-386
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.43 — The Credentials tab
  id: totrans-387
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Since we won’t be modifying the currently set configuration in this tab, we
    can leave everything else as-is.
  id: totrans-388
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In the **Role Services** tab, check **Certification Authority**. Click the **Next
    >** button after:![](image/B19755_08_44.jpg)
  id: totrans-389
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.44 — Select Role Services to configure
  id: totrans-390
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Other than checking the first checkbox (as highlighted in *Figure 8**.44*),
    we can leave everything else as-is.
  id: totrans-391
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In the **Setup Type** tab, ensure **Enterprise CA** is selected. Click the **Next
    >** button after.
  id: totrans-392
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **CA Type** tab, ensure **Root CA** is selected and then click **Next
    >**.
  id: totrans-393
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Private Key** tab, ensure **Create a new private key** is selected
    and then click **Next >**.
  id: totrans-394
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Cryptography** tab, leave everything else as-is and then click **Next
    >**.
  id: totrans-395
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **CA Name** tab, click **Next >**.
  id: totrans-396
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Validity Period** tab, click **Next >**.
  id: totrans-397
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Certificate Locations** tab, click **Next >**.
  id: totrans-398
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Confirmation** tab, click **Configure**.
  id: totrans-399
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the **Results** tab, click **Close**.
  id: totrans-400
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Part 5 of 12 – Updating the trusted hosts configuration and enabling PowerShell
    Remoting
  id: totrans-401
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Now that we have successfully configured AD CS, let’s quickly update the trusted
    hosts configuration and enable PowerShell Remoting:'
  id: totrans-402
  prefs: []
  type: TYPE_NORMAL
- en: Let’s start by clicking the Windows icon (located in the lower left corner of
    the screen):![](image/B19755_08_45.jpg)
  id: totrans-403
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.45 — Opening Windows PowerShell
  id: totrans-404
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Locate and select **Windows PowerShell**, as highlighted in *Figure 8**.45*.
  id: totrans-405
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Run **Enable-PsRemoting**:'
  id: totrans-406
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-407
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE19]'
- en: Here, we are enabling **PowerShell Remoting**, a feature that allows remote
    access to execute PowerShell commands and scripts on a computer.
  id: totrans-408
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Let’s run the following to verify that port **5985** is listening:'
  id: totrans-409
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-410
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'This should return the following output:'
  id: totrans-411
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-412
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Update the trusted hosts configuration by running the following:'
  id: totrans-413
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-414
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE22]'
- en: When asked if you want to modify the **TrustedHosts** list for the WinRM client,
    enter **Y**.
  id: totrans-415
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Verify that the previous command worked by running the following command:'
  id: totrans-416
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-417
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE23]'
- en: This should confirm that the configuration value has been successfully updated
    to *****.
  id: totrans-418
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Run the following command to modify the firewall rule to allow incoming WinRM
    traffic:'
  id: totrans-419
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-420
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE24]'
- en: Note
  id: totrans-421
  prefs: []
  type: TYPE_NORMAL
- en: At this point, we have updated the trusted hosts configuration to allow connections
    from any host (*****). In addition to this, we have modified the firewall rule
    to allow incoming WinRM (**port** **5985**) traffic.
  id: totrans-422
  prefs: []
  type: TYPE_NORMAL
- en: Part 6 of 12 – Setting up the flag inside the domain controller
  id: totrans-423
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Continuing where we left off in the previous part, follow these steps:'
  id: totrans-424
  prefs: []
  type: TYPE_NORMAL
- en: 'Let’s navigate to **C:\** by running the following commands in the terminal
    (one line at a time):'
  id: totrans-425
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-426
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'Create a **flag.txt** file inside **C:\**:'
  id: totrans-427
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE26]'
  id: totrans-428
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'Restart the VM instance (**ad-domain-controller**) using **Restart-Computer**:'
  id: totrans-429
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE27]'
  id: totrans-430
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Note
  id: totrans-431
  prefs: []
  type: TYPE_NORMAL
- en: Wait for 3 to 5 minutes for the VM instance (**ad-domain-controller**) to complete
    the restart operation. Feel free to grab a cup of coffee or tea while waiting!
  id: totrans-432
  prefs: []
  type: TYPE_NORMAL
- en: Part 7 of 12 – Creating the John Doe user
  id: totrans-433
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Follow these steps:'
  id: totrans-434
  prefs: []
  type: TYPE_NORMAL
- en: Connect to the first VM instance (**ad-domain-controller**) via RDP again. Simply
    use **domain\admin_user** as the username and **Windows1234!!!** as the password:![](image/B19755_08_37.jpg)
  id: totrans-435
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.46 — Enter Your User Account
  id: totrans-436
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click the **Continue** button when you see the **You are connecting to the RDP**
    **host...** popup.
  id: totrans-437
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Under **Server Manager** > **Dashboard**, click **Tools** (the top right-hand
    corner of the window) and then select **Active Directory Users and Computers**
    from the list of options available:![](image/B19755_08_47.jpg)
  id: totrans-438
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.47 — Active Directory Users and Computers
  id: totrans-439
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Make sure you select the correct option from the multiple options available
    (similar to what is shown in *Figure 8**.47*).
  id: totrans-440
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In **Active Directory Users and Computers**, expand **domain.local** (in the
    tree) and then right-click on **Users**:![](image/B19755_08_48.jpg)
  id: totrans-441
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.48 — Users > New > User
  id: totrans-442
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Select **New** > **User** from the context menu (similar to what is shown in
    *Figure 8**.48*).
  id: totrans-443
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Using the **New Object - User** window, let’s create the **John Doe** (**johndoe**)
    user:![](image/B19755_08_49.jpg)
  id: totrans-444
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.49 — Creating a new user (John Doe)
  id: totrans-445
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Here, we must specify the following field values: **First name** – **John**,
    **Last name** – **Doe**, **Full name** – **John Doe**, and **User logon name**
    – **johndoe**. Click the **Next >** button after.'
  id: totrans-446
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Now, let’s configure the password settings for the **John Doe** (**johndoe**)
    user. Set **Passw0rd** as the password (for both the **Password** and **Confirm**
    **password** fields):![](image/B19755_08_50.jpg)
  id: totrans-447
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.50 — Setting a password
  id: totrans-448
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Uncheck **User must change password at next logon** and then check **Password
    never expires**, similar to what is shown in *Figure 8**.50*. After that, click
    the **Next >** button.
  id: totrans-449
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-450
  prefs: []
  type: TYPE_NORMAL
- en: Here, we have specified **Passw0rd** as the password with a capital **P** and
    a zero (**0**) instead of a letter, **o**. Note that these types of passwords
    are relatively common due to their simplicity and the false sense of security
    they provide. Unfortunately, using minor variations of common words or phrases,
    such as replacing letters with numbers or using easily guessable patterns such
    as **P@ssw0rd** (with **@** instead of **a**), does not significantly enhance
    security.
  id: totrans-451
  prefs: []
  type: TYPE_NORMAL
- en: Click **Finish** after.
  id: totrans-452
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note
  id: totrans-453
  prefs: []
  type: TYPE_NORMAL
- en: At this point, we should have the **John Doe** (**johndoe**) user created. As
    you can see, it’s relatively straightforward to create new users since we have
    a user interface to assist us during the creation process.
  id: totrans-454
  prefs: []
  type: TYPE_NORMAL
- en: Part 8 of 12 – Creating the Jane Doe user
  id: totrans-455
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Follow these steps:'
  id: totrans-456
  prefs: []
  type: TYPE_NORMAL
- en: Let’s create another user. Right-click on **Users**:![](image/B19755_08_51.jpg)
  id: totrans-457
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.51 — New > User
  id: totrans-458
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Select **New** > **User** from the list of options available in the context
    menu.
  id: totrans-459
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: This time, we will be creating the **Jane Doe** (**janedoe**) user:![](image/B19755_08_52.jpg)
  id: totrans-460
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.52 — Creating Jane Doe
  id: totrans-461
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Here, we must specify the following field values: **First name** – **Jane**,
    **Last name** – **Doe**, **Full name** – **Jane Doe**, and **User logon name**
    – **janedoe**. Click the **Next >** button after.'
  id: totrans-462
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Now, let’s configure the password settings for the **Jane Doe** (**janedoe**)
    user. Set **Passw0rd** as the password (for both the **Password** and **Confirm**
    **password** fields):![](image/B19755_08_53.jpg)
  id: totrans-463
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.53 — Configuring the password settings
  id: totrans-464
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Let’s also uncheck **User must change password at next logon**. Check **User
    cannot change password**, **Password never expires**, and **Account is disabled**
    (similar to what we have in *Figure 8**.53*). Click the **Next >** button after.
  id: totrans-465
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click **Finish**.
  id: totrans-466
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note
  id: totrans-467
  prefs: []
  type: TYPE_NORMAL
- en: At this point, we should have the **Jane Doe** (**janedoe**) user created. When
    building penetration testing lab environments, we must have “dummy” resources
    to make the lab setup mimic real-world environments. That said, we have the option
    to create as many user entities as possible.
  id: totrans-468
  prefs: []
  type: TYPE_NORMAL
- en: Part 9 of 12 – Creating the Service Account user
  id: totrans-469
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Now, let’s create the **Service Account** user (with administrator-level permissions):'
  id: totrans-470
  prefs: []
  type: TYPE_NORMAL
- en: Click **Users** (from the tree) and then locate **admin_user** from the list
    of users:![](image/B19755_08_54.jpg)
  id: totrans-471
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.54 — Copying admin_user
  id: totrans-472
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Right-click on **admin_user** and then select **Copy...** (similar to what is
    shown in *Figure 8**.54*).
  id: totrans-473
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In the **Copy Object - User** window, specify the following field values to
    create the **Service** **Account** user:![](image/B19755_08_55.jpg)
  id: totrans-474
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.55 — Creating a Service Account user
  id: totrans-475
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Here, we must specify the following field values: **First name** – **Service**,
    **Last name** – **Account**, **Full name** – **Service Account**, and **User logon
    name** – **service_account**. Click the **Next >** button after.'
  id: totrans-476
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Now, let’s configure the password settings for the **Service Account** (**service_account**)
    user. Set **Passw0rd** as the password (for both the **Password** and **Confirm**
    **password** fields):![](image/B19755_08_56.jpg)
  id: totrans-477
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.56 — Specifying the password for the Service Account user
  id: totrans-478
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Let’s also make sure that **User must change password at next logon**, **User
    cannot change password**, **Password never expires**, and **Account is disabled**
    are all unchecked (similar to what we have in *Figure 8**.56*). Click the **Next
    >** button after.
  id: totrans-479
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click **Finish**.
  id: totrans-480
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note
  id: totrans-481
  prefs: []
  type: TYPE_NORMAL
- en: User accounts in Active Directory are meant for individual human users. These
    accounts allow them to access resources and perform tasks within the network.
    Service accounts, on the other hand, are used by applications and services to
    interact with resources without the need to rely on user credentials.
  id: totrans-482
  prefs: []
  type: TYPE_NORMAL
- en: Part 10 of 12 – Setting up the SPN for the service account
  id: totrans-483
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Wait – there’s more! We’ll now configure the **Service Principal Name** (**SPN**)
    for the service account we created in the previous step. SPNs are identifiers
    that are used in Active Directory to associate services with service accounts
    and enable authentication for secure communication. By using SPNs to map a service
    instance to a service sign-in account, client applications gain the ability to
    request service authentication for that account, even if the client itself doesn’t
    possess the account name:'
  id: totrans-484
  prefs: []
  type: TYPE_NORMAL
- en: Important note
  id: totrans-485
  prefs: []
  type: TYPE_NORMAL
- en: Later, in the *Simulating penetration testing in the lab environment* section
    of this chapter, we’ll see how the (mis)configurations involving the SPNs of service
    accounts allow an attacker to abuse the authentication protocol. For more information
    about SPNs, feel free to check out [https://learn.microsoft.com/en-us/windows/win32/ad/service-principal-names](https://learn.microsoft.com/en-us/windows/win32/ad/service-principal-names).
  id: totrans-486
  prefs: []
  type: TYPE_NORMAL
- en: When you are ready, open a **Windows** **PowerShell** window:![](image/B19755_08_57.jpg)
  id: totrans-487
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.57 — Opening Windows PowerShell
  id: totrans-488
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: This will open a PowerShell window where we will set up the SPN for the service
    account (**service_account**) in the next set of steps.
  id: totrans-489
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Let’s get the hostname of the domain controller:'
  id: totrans-490
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE28]'
  id: totrans-491
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE28]'
- en: This should return **ad-domain-contr**.
  id: totrans-492
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Add the specified SPN to **domain\service_account**:'
  id: totrans-493
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE29]'
  id: totrans-494
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'This should yield the following output:'
  id: totrans-495
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE30]'
  id: totrans-496
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE30]'
- en: Note
  id: totrans-497
  prefs: []
  type: TYPE_NORMAL
- en: Feel free to validate this using **setspn -T domain.local -****Q */***.
  id: totrans-498
  prefs: []
  type: TYPE_NORMAL
- en: Close the PowerShell window.
  id: totrans-499
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Part 11 of 12 – Adding the Service Account user to the Remote Management Users
    group
  id: totrans-500
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Follow these steps:'
  id: totrans-501
  prefs: []
  type: TYPE_NORMAL
- en: Navigate back to the **Active Directory Users and Computers** window and locate
    the **Service Account** user inside **Users**.
  id: totrans-502
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Double-click **Service Account** to open **Service Account Properties**. Go
    to the **Member Of** tab (similar to what is shown in *Figure 8**.58*). Click
    the **Add** button after:![](image/B19755_08_58.jpg)
  id: totrans-503
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.58 — Service Account Properties
  id: totrans-504
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Here, you can see that the **Service Account** (**service_account**) user is
    a member of various groups, including the **Administrators**, **Domain Admins**,
    **Domain Users**, and **Enterprise Admins** groups (and more). **Yikes!**
  id: totrans-505
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Type **Remote Management Users** and then click the **Check** **Names** button:![](image/B19755_08_59.jpg)
  id: totrans-506
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.59 — Remote Management Users
  id: totrans-507
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click the **OK** button after.
  id: totrans-508
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click **Apply** and then click the **OK** button.
  id: totrans-509
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Part 12 of 12 – Configuring the workstation machine
  id: totrans-510
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We’re almost done! In this last part, we’ll configure the workstation machine
    and have it join the domain we created in the previous set of steps:'
  id: totrans-511
  prefs: []
  type: TYPE_NORMAL
- en: Let’s access the second Windows VM instance (**ad-workstation-machine**) via
    RDP.
  id: totrans-512
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Type **settings** in the search bar (located at the lower left portion of the
    screen) and then select **Settings** from the list of search results. Locate and
    select **Network & Internet** from the list of options available under **Windows
    Settings**.
  id: totrans-513
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the sidebar, click **Ethernet**:![](image/B19755_08_60.jpg)
  id: totrans-514
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.60 — Ethernet
  id: totrans-515
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click **Change adapter options** (under **Related settings**).
  id: totrans-516
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Right-click on **Ethernet** and then choose **Properties**:![](image/B19755_08_61.jpg)
  id: totrans-517
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.61 — Opening the Ethernet Properties window
  id: totrans-518
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: This will open the **Ethernet Properties** window. In this window, select **Internet
    Protocol Version 4 (TCP/IPv4)** and then click **Properties**.
  id: totrans-519
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Select **Use the following DNS server addresses:** (similar to what is shown
    in *Figure 8**.62*):![](image/B19755_08_62.jpg)
  id: totrans-520
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Figure 8.62 — Use the following DNS server addresses:'
  id: totrans-521
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Specify **10.0.1.4** for the **Preferred DNS server** value. Note that we are
    using the private IP address of the domain controller as the DNS server address.
  id: totrans-522
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-523
  prefs: []
  type: TYPE_NORMAL
- en: Make sure you use the actual private IP address value of your domain controller
    instance (**ad-domain-controller**) when setting the **Preferred DNS** **server**
    value.
  id: totrans-524
  prefs: []
  type: TYPE_NORMAL
- en: Click the **OK** button and then click **Close**.
  id: totrans-525
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note
  id: totrans-526
  prefs: []
  type: TYPE_NORMAL
- en: Note that the RDP Connection to the workstation (**ad-workstation-machine**)
    VM instance will be disconnected (without any warning or notification).
  id: totrans-527
  prefs: []
  type: TYPE_NORMAL
- en: Navigate to the VM instance details page (the **Overview** blade) of the **ad-workstation-machine**
    instance (in the Azure portal). Locate and click the **Restart** button (highlighted
    in *Figure 8**.63*):![](image/B19755_08_63.jpg)
  id: totrans-528
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.63 — Restarting the workstation VM instance
  id: totrans-529
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click the **Yes** button when you’re asked to restart **ad-workstation-machine**.
  id: totrans-530
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-531
  prefs: []
  type: TYPE_NORMAL
- en: Wait for 10 to 15 minutes for the VM instance to restart. Feel free to grab
    a cup of coffee or tea while waiting! You should see a notification message once
    the VM has been successfully restarted. Wait for another 5 minutes before proceeding
    to the next set of steps.
  id: totrans-532
  prefs: []
  type: TYPE_NORMAL
- en: Connect to the workstation VM instance (**ad-workstation-machine**) again with
    RDP:![](image/B19755_08_21.jpg)
  id: totrans-533
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.64 — Enter Your User Account
  id: totrans-534
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Simply use **workstation_user** as the username and **Workstation1234!!!** as
    the password.
  id: totrans-535
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Type **Access work or school** in the search box:![](image/B19755_08_65.jpg)
  id: totrans-536
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.65 — Access work or school
  id: totrans-537
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Select **Access work or school** from the search results (as highlighted in
    *Figure 8**.65*).
  id: totrans-538
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Under **Access work or school**, locate and click the **Connect** button. After
    that, click **Join this device to a local Active Directory domain** under **Alternate
    actions**.
  id: totrans-539
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Specify **domain.local** under **Domain name** on the **Join a domain** screen.
    Click the **Next** button after:![](image/B19755_08_66.jpg)
  id: totrans-540
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.66 — Join a domain
  id: totrans-541
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Use **admin_user** as the username and **Windows1234!!!** as the password when
    you’re prompted to enter a domain account.
  id: totrans-542
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In the **Add an account** window, select **Skip**.
  id: totrans-543
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click **Restart now**.
  id: totrans-544
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Note
  id: totrans-545
  prefs: []
  type: TYPE_NORMAL
- en: The RDP connection to the workstation VM instance (**ad-workstation-machine**)
    will be disconnected.
  id: totrans-546
  prefs: []
  type: TYPE_NORMAL
- en: Back in the domain controller (**ad-domain-controller**) RDP connection, verify
    if the workstation VM instance shows up under **Computers**:![](image/B19755_08_67.jpg)
  id: totrans-547
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.67 — The workstation VM instance (ad-workstation-machine) now shows
    up under Computers
  id: totrans-548
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Here, we can see that the workstation VM instance (**ad-workstation-machine**)
    is now showing up under **Computers**.
  id: totrans-549
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Close the RDP connection for **Domain Controller VM** **instance** (**ad-domain-controller**).
  id: totrans-550
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Connect to the workstation VM instance (**ad-workstation-machine**) again. This
    time, use **DOMAIN\admin_user** for the username and **Windows1234!!!** for the
    password.
  id: totrans-551
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Open **Computer Management**:![](image/B19755_08_68.jpg)
  id: totrans-552
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.68 — Opening Computer Management
  id: totrans-553
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: To open **Computer Management**, simply type **Computer Management** in the
    search box and then select **Computer Management** from the list of results (as
    highlighted in *Figure 8**.68*).
  id: totrans-554
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Expand **Local Users and Groups** (in the tree):![](image/B19755_08_69.jpg)
  id: totrans-555
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.69 — Local Users and Groups
  id: totrans-556
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click **Groups**, as highlighted in *Figure 8**.69*. Double-click on **Administrators**
    after.
  id: totrans-557
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Locate and click the **Add** button in the **Administrators** **Properties**
    window.
  id: totrans-558
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Input **John Doe** in the text area highlighted in *Figure 8**.70*:![](image/B19755_08_70.jpg)
  id: totrans-559
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.70 — Adding John Doe to the Administrators group
  id: totrans-560
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click **Check Names**. Click **OK** after.
  id: totrans-561
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click **Apply** and then click **OK**.
  id: totrans-562
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Close the RDP connection for the workstation VM instance (**ad-workstation-machine**).
  id: totrans-563
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**At this point, our lab environment setup is complete!** With everything ready,
    let’s proceed to the next section.'
  id: totrans-564
  prefs: []
  type: TYPE_NORMAL
- en: Simulating penetration testing in the lab environment
  id: totrans-565
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Given that our lab environment in Azure has been set up successfully, we can
    now focus on performing the penetration testing simulation to verify that everything
    has been configured correctly. Similar to the previous chapters, we will work
    with a simplified penetration process since our primary goal is to assess if the
    penetration testing lab environment has been set up and (mis)configured correctly.
  id: totrans-566
  prefs: []
  type: TYPE_NORMAL
- en: Our simulation will start with a port scan to check the open ports of one of
    the target Windows VM instances (**ad-domain-controller**). We will then use **ldapsearch**
    to retrieve the domain name (**domain.local**) that’s used in our Active Directory
    setup. Next, we will use **Kerbrute** to enumerate valid usernames along with
    brute-forcing the password of one of the enumerated user accounts (**johndoe**).
    Using the domain (**domain.local**) along with the credentials of the **johndoe**
    account, we will use **Impacket** to obtain the **service_account** account, along
    with its hash value. We will then crack this hash value and retrieve the password
    using **John the Ripper**. With the **service_acccount** account credentials,
    we will use **evil-winrm** to gain remote access to the target machine (**ad-domain-controller**).
    Finally, we will retrieve the flag stored inside the target machine. *Looks like
    we’ll be using several tools in* *this section!*
  id: totrans-567
  prefs: []
  type: TYPE_NORMAL
- en: Important note
  id: totrans-568
  prefs: []
  type: TYPE_NORMAL
- en: It is unethical and illegal to attack cloud resources owned by another user
    or company. Before proceeding, make sure you read the *Examining the considerations
    when building penetration testing lab environments in the cloud* section of *[Chapter
    1](B19755_01.xhtml)*, *Getting Started with Penetration Testing Labs in the Cloud*,
    since we will be simulating the attack process to validate if misconfigurations
    and vulnerabilities present in the applications and services running in the target
    VM instance are exploitable.
  id: totrans-569
  prefs: []
  type: TYPE_NORMAL
- en: 'With these aspects in mind, we can now start the penetration testing simulation:'
  id: totrans-570
  prefs: []
  type: TYPE_NORMAL
- en: 'In the Kali Linux desktop/GUI environment (in the browser), run the following
    commands in the terminal to check and scan the open ports on the Active Directory
    domain controller instance (**ad-domain-controller**). Make sure you set the **IP**
    variable value with the private IP address of the domain controller before running
    this command:'
  id: totrans-571
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE31]'
  id: totrans-572
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE31]'
- en: Here, we used the **--top-ports** option to specify the number of top ports
    that Nmap will scan. This speeds up the scanning process by focusing on the most
    commonly used ports. In addition to this, we used the **-Pn** option to disable
    host discovery and assume that the host is online.
  id: totrans-573
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Running this command should give us the following output:'
  id: totrans-574
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](image/B19755_08_71.jpg)'
  id: totrans-575
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: Figure 8.71 — Using nmap to scan the ports
  id: totrans-576
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In *Figure 8**.71*, we can see that more ports are open compared to when we
    last used Nmap to scan the ports of the domain controller VM instance (**ad-domain-controller**).
  id: totrans-577
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'This time, let’s try checking all the ports by running the following command:'
  id: totrans-578
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE32]'
  id: totrans-579
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'Similar to the previous command we ran, we used the **-Pn** option to disable
    host discovery. Now, we have **-p-**, indicating that we want to scan all 65,535
    ports. In addition to this, we also used **-v** to increase the verbosity level
    of the output. After a few minutes, we should get the following result:'
  id: totrans-580
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](image/B19755_08_72.jpg)'
  id: totrans-581
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: Figure 8.72 — Using nmap to scan all the ports
  id: totrans-582
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: In *Figure 8**.72*, we can see that port **5985** for the WinRM service is open.
    This means that we may be able to use tools such as **evil-winrm** to give us
    remote access with the right set of credentials!
  id: totrans-583
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Important note
  id: totrans-584
  prefs: []
  type: TYPE_NORMAL
- en: 'If port **5985** is not open (and potentially in a **filtered** state), make
    sure you run the following command in the **Administrator: Windows PowerShell**
    window of the first Windows VM instance (**ad-domain-controller**): **Set-NetFirewallRule
    -Name "WINRM-HTTP-In-TCP-PUBLIC" -RemoteAddress Any**. Note that additional troubleshooting
    steps might be needed if this does not fix the connectivity issues.'
  id: totrans-585
  prefs: []
  type: TYPE_NORMAL
- en: Now, let’s perform an LDAP search operation to retrieve the naming context(s)
    using **ldapsearch**. *What do we mean by retrieving the naming context?* This
    essentially means that we are obtaining information about the structure and organization
    of the LDAP directory (such as the domains or directory partitions that exist
    within it).
  id: totrans-586
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'When you are ready, run the following command:'
  id: totrans-587
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE33]'
  id: totrans-588
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'This should yield the following results:'
  id: totrans-589
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](image/B19755_08_73.jpg)'
  id: totrans-590
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: Figure 8.73 — Using ldapsearch
  id: totrans-591
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Running the preceding command allowed us to retrieve the domain name (**domain.local**)
    that we used in the Active Directory setup of our lab environment.
  id: totrans-592
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Before installing Kerbrute, we need to install Golang:'
  id: totrans-593
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE34]'
  id: totrans-594
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE34]'
- en: Feel free to verify that we were able to install Golang successfully by running
    **which go**. Running **which go** should return **/usr/bin/go**.
  id: totrans-595
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-596
  prefs: []
  type: TYPE_NORMAL
- en: This step may take around 5 minutes to complete.
  id: totrans-597
  prefs: []
  type: TYPE_NORMAL
- en: 'Set up **Kerbrute** in your Kali Linux attacker machine using the following
    commands:'
  id: totrans-598
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE35]'
  id: totrans-599
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE35]'
- en: Note
  id: totrans-600
  prefs: []
  type: TYPE_NORMAL
- en: 'If you are wondering what Kerbrute is, it is a tool that’s used to assess Kerberos
    security by brute-forcing and enumerating valid Active Directory accounts. It
    is similar to the **VNC login auxiliary scanner** Metasploit module we used in
    *[Chapter 5](B19755_05.xhtml)*, *Setting Up Isolated Penetration Testing Lab Environments
    on Azure*. This time, however, we have a tool designed specifically for the Kerberos
    authentication mechanism. You can find the GitHub repository of Kerbrute here:
    [https://github.com/ropnop/kerbrute](https://github.com/ropnop/kerbrute).'
  id: totrans-601
  prefs: []
  type: TYPE_NORMAL
- en: 'Now, let’s run the following commands (one line at a time) to check if **kerbrute_linux_386**
    and **kerbrute_linux_amd64** are inside the **dist** directory:'
  id: totrans-602
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE36]'
  id: totrans-603
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'Next, let’s use the **touch** command to create two empty files – **usernames.txt**
    and **passwords.txt**:'
  id: totrans-604
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE37]'
  id: totrans-605
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'Run the following command to open the empty **usernames.txt** file using Vim:'
  id: totrans-606
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE38]'
  id: totrans-607
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 'Press **i** to switch to **insert mode** so that we can edit the file. Type
    or paste the following usernames (one username per line) into our **usernames.txt**
    file:'
  id: totrans-608
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE39]'
  id: totrans-609
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE39]'
- en: Press the *Esc* key to switch to **normal mode**. Type **:wq!**. Press *Enter*
    after. This will save the changes that were made to **usernames.txt** and then
    exit Vim as well.
  id: totrans-610
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-611
  prefs: []
  type: TYPE_NORMAL
- en: In case you have forgotten already, **insert mode** in Vim allows us to type
    and make changes as we would in a regular text editor. In this mode, we can freely
    add, delete, or modify characters without affecting the surrounding text. On the
    other hand, **normal mode** allows us to navigate through the text, execute commands,
    and perform various operations on the file. In this mode, specific keystrokes
    (such as **:wq!**) can be used to move the cursor, search for text, copy and paste,
    and perform editing actions such as deleting, replacing, and undoing changes.
    For instance, **w** represents the *write* command (which saves changes to the
    file), and **q** represents the *quit* command (which exits the editor). What’s
    the exclamation point (**!**) for? The exclamation point, **!**, is simply an
    optional modifier that forces the command to execute, even if there are unsaved
    changes along with other warnings.
  id: totrans-612
  prefs: []
  type: TYPE_NORMAL
- en: 'Similarly, let’s run the following command to open the empty **passwords.txt**
    file using Vim:'
  id: totrans-613
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE40]'
  id: totrans-614
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE40]'
- en: 'Next, press **i** to switch to **insert mode** so that we can edit the file.
    Type or paste the following passwords (one password per line) into our **passwords.txt**
    file:'
  id: totrans-615
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE41]'
  id: totrans-616
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE41]'
- en: Press the *Esc* key to switch to **normal mode**. Type **:wq!**. Press *Enter*
    after. This will save the changes we’ve made to **passwords.txt** and then exit
    Vim as well.
  id: totrans-617
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Important note
  id: totrans-618
  prefs: []
  type: TYPE_NORMAL
- en: We are intentionally using short lists of usernames and passwords to demonstrate
    how to use Kerbrute. In real life, a much wider range of passwords needs to be
    prepared to maximize the chances of getting unauthorized access during a penetration
    testing activity or simulation.
  id: totrans-619
  prefs: []
  type: TYPE_NORMAL
- en: 'With everything ready, let’s use Kerbrute to enumerate valid Active Directory
    users using the username list file (**usernames.txt**) we prepared earlier:'
  id: totrans-620
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE42]'
  id: totrans-621
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE42]'
- en: 'This should yield the following output:'
  id: totrans-622
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](image/B19755_08_74.jpg)'
  id: totrans-623
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: Figure 8.74 — Using Kerbrute for enumerating valid Active Directory usernames
  id: totrans-624
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Here, we can see that two valid usernames were found using Kerbrute: **johndoe@domain**
    and **admin_user@domain**.'
  id: totrans-625
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Now, let’s run the following command to brute force the **johndoe** password
    using the password list file (**passwords.txt**) we prepared earlier:'
  id: totrans-626
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE43]'
  id: totrans-627
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE43]'
- en: 'This should yield the following output:'
  id: totrans-628
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](image/B19755_08_75.jpg)'
  id: totrans-629
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: Figure 8.75 — Using Kerbrute to brute force the password of the johndoe user
    account
  id: totrans-630
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Here, we can see that the password of the **johndoe** user account is **Passw0rd**!
    *What can we do with this password?* We’ll look at this in the next set of steps!
  id: totrans-631
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Let’s run the following command to request the SPN for the **DOMAIN.local/johndoe**
    user account:'
  id: totrans-632
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE44]'
  id: totrans-633
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE44]'
- en: 'Specify **Passw0rd** when prompted for the password. This should yield the
    following output:'
  id: totrans-634
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](image/B19755_08_76.jpg)'
  id: totrans-635
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: Figure 8.76 — KRB_TGS ticket
  id: totrans-636
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Here, we can see the **service_account** account and the password hash value
    (that is, the **KRB_TGS ticket** of the service account) under **CCache file is
    not found.** **Skipping ...**.
  id: totrans-637
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-638
  prefs: []
  type: TYPE_NORMAL
- en: We won’t dive deep into how the authentication protocol works in this book.
    Feel free to check out [https://learn.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos](https://learn.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos)
    for more details.
  id: totrans-639
  prefs: []
  type: TYPE_NORMAL
- en: Highlight and copy the hash value, similar to what is shown in *Figure 8**.77*:![](image/B19755_08_77.jpg)
  id: totrans-640
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Figure 8.77 — Copying the hash value
  id: totrans-641
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Here, we right-click on the highlighted hash value and then select **Copy Selection**
    from the list of options available.
  id: totrans-642
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Now, let’s use the **touch** command to create an empty *hash* file. Let’s
    open this file using Vim as well:'
  id: totrans-643
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE45]'
  id: totrans-644
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE45]'
- en: Next, press *i* to switch to insert mode so that we can edit the file. Paste
    the copied string value by right-clicking and choose **Paste Selection** from
    the list of options available. Press the *Esc* key to switch to normal mode. Type
    **:wq!**. Press *Enter* after.
  id: totrans-645
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-646
  prefs: []
  type: TYPE_NORMAL
- en: Feel free to verify if the hash value has been copied to the file correctly
    by running **cat hash**.
  id: totrans-647
  prefs: []
  type: TYPE_NORMAL
- en: With the *hash* file ready, we can now use **John the Ripper** (a widely used
    password-cracking tool for detecting and uncovering weak passwords) to crack the
    TGS hash and retrieve the cracked password.
  id: totrans-648
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'When you are ready, simply run the following command:'
  id: totrans-649
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE46]'
  id: totrans-650
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE46]'
- en: 'This should yield logs similar to what we have in *Figure 8**.78*:'
  id: totrans-651
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](image/B19755_08_78.jpg)'
  id: totrans-652
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: Figure 8.78 — Using John the Ripper to crack the TGS hash
  id: totrans-653
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '**Looks like we were able to successfully crack the password!** Feel free to
    run **john --format=krb5tgs hash --show** to show the cracked password (**Passw0rd**).'
  id: totrans-654
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-655
  prefs: []
  type: TYPE_NORMAL
- en: Behind the scenes, John the Ripper employs multiple techniques (such as dictionary
    attacks and brute-force attacks) to iteratively guess potential passwords and
    hash them to compare them with the target hash value.
  id: totrans-656
  prefs: []
  type: TYPE_NORMAL
- en: Now that we know the password, let’s use **evil-winrm** to gain remote access
    to the target machine. Here, we’re using a tool for establishing a remote connection
    to the Active Directory domain controller instance (**ad-domain-controller**)
    using the cracked credentials.
  id: totrans-657
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'When you are ready, run the following command:'
  id: totrans-658
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE47]'
  id: totrans-659
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE47]'
- en: 'Running this command should succeed and give us access similar to what is shown
    in *Figure 8**.79*:'
  id: totrans-660
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](image/B19755_08_79.jpg)'
  id: totrans-661
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: Figure 8.79 — Using evil-winrm to gain remote access
  id: totrans-662
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '**Looks like we were able to successfully gain shell access!** Now that we
    have shell access, we can run commands to locate the flag (which is what we’ll
    do in the next set of steps!)'
  id: totrans-663
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Important note
  id: totrans-664
  prefs: []
  type: TYPE_NORMAL
- en: Make sure that port **5985** of the first Windows VM instance (**ad-domain-controller**)
    is **open** in case you encounter issues running the **evil-winrm** command. Feel
    free to run **nmap -p5985 -Pn 10.0.1.4** to verify that the **STATE** value is
    **open** and not **filtered**.
  id: totrans-665
  prefs: []
  type: TYPE_NORMAL
- en: 'Navigate to the **C:\** directory and then list the files inside it using the
    **dir** cmdlet:'
  id: totrans-666
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE48]'
  id: totrans-667
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'This should yield the following output:'
  id: totrans-668
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![](image/B19755_08_80.jpg)'
  id: totrans-669
  prefs:
  - PREF_IND
  type: TYPE_IMG
- en: Figure 8.80 — Results after running dir cmdlet
  id: totrans-670
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Here, we can see that our **flag.txt** file is inside **C:\**.
  id: totrans-671
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Finally, let’s print the flag value inside **flag.txt** using the **cat** (**Get-Content**)
    command:'
  id: totrans-672
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE49]'
  id: totrans-673
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE49]'
- en: This should yield **FLAG** as the value! **Congratulations on successfully retrieving**
    **the flag!**
  id: totrans-674
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Right now, you are probably excited to try out other exploits and techniques
    in our lab environment setup. Feel free to modify the configuration of the target
    VM instances (**ad-domain-controller** and **ad-workstation-machine**) and then
    test if certain attacks or techniques work.
  id: totrans-675
  prefs: []
  type: TYPE_NORMAL
- en: Cleaning up
  id: totrans-676
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Cleaning up the cloud resources we created or deployed is a crucial step when
    working with vulnerable cloud applications and environments. If we don’t clean
    up and delete the resources we created right away, we might end up paying for
    unused cloud resources. At a *minimum*, we will be paying for the time the following
    resources are running:'
  id: totrans-677
  prefs: []
  type: TYPE_NORMAL
- en: 1 x **Standard_DS1_v2** Azure VM instance for the attacker machine
  id: totrans-678
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 2 x **Standard_B2ms** Azure VM instances for the target machines (**ad-domain-controller**
    and **ad-workstation-machine**)
  id: totrans-679
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Please be aware that there are other costs we have to take into account as well
    – including data transfer fees, storage costs for persistent data used by the
    instances, potential charges for other Azure services utilized in the account,
    along with any applicable taxes or fees associated to the usage of Azure resources.
  id: totrans-680
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-681
  prefs: []
  type: TYPE_NORMAL
- en: 'Since the overall cost when running these resources depends on several parameters,
    it is best to refer to the pricing documentation page provided by the cloud platform:
    [https://azure.microsoft.com/en-us/pricing/details/virtual-machines/windows/](https://azure.microsoft.com/en-us/pricing/details/virtual-machines/windows/).
    You can also utilize the **Azure Pricing Calculator** to estimate the cost of
    deploying resources on Azure. You can access the Azure Pricing Calculator at [https://azure.microsoft.com/en-us/pricing/calculator/](https://azure.microsoft.com/en-us/pricing/calculator/).'
  id: totrans-682
  prefs: []
  type: TYPE_NORMAL
- en: 'That said, let’s proceed with deleting the resources we created in this chapter:'
  id: totrans-683
  prefs: []
  type: TYPE_NORMAL
- en: Close all open RDP connections.
  id: totrans-684
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Manually turn off and delete the Windows VM instances (**ad-domain-controller**
    and **ad-workstation-machine**), along with their associated resources that were
    created in this chapter, via the Azure portal.
  id: totrans-685
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'In the Cloud Shell terminal, navigate to the **~/ch8_environment** directory
    and then use **terraform destroy** to clean up the resources we created earlier:'
  id: totrans-686
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE50]'
  id: totrans-687
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE50]'
- en: Feel free to run the **terraform destroy** command a few times in case some
    resources fail to delete (or take a bit of time to delete). If all else fails,
    you may delete resources manually using the user interface of the Azure portal.
  id: totrans-688
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-689
  prefs: []
  type: TYPE_NORMAL
- en: This step may take 10 to 15 minutes to complete.
  id: totrans-690
  prefs: []
  type: TYPE_NORMAL
- en: 'Verify that the resources have been destroyed successfully using the following
    command:'
  id: totrans-691
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE51]'
  id: totrans-692
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE51]'
- en: This should return an empty response since all the resources should have been
    deleted successfully.
  id: totrans-693
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Important note
  id: totrans-694
  prefs: []
  type: TYPE_NORMAL
- en: Feel free to perform a full audit of your Microsoft Azure account. This will
    help ensure that all resources have been properly deleted, minimize the risk of
    unintended costs, and address any potential security concerns.
  id: totrans-695
  prefs: []
  type: TYPE_NORMAL
- en: That’s pretty much it! At this point, we should have a good idea of how to prepare
    a vulnerable Active Directory lab environment on Microsoft Azure.
  id: totrans-696
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  id: totrans-697
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we were able to successfully set up an Active Directory Lab
    inside an isolated network environment in Microsoft Azure. We started by using
    Terraform to set up the isolated network environment so that we could secure the
    lab environment resources from external attacks. Inside this isolated network
    environment, we then launched two Windows VM instances. After that, we prepared
    and configured an Active Directory setup (using the VM instances we launched)
    with one domain controller and one workstation machine. After completing the lab
    environment, we performed a penetration testing simulation to verify if our lab
    had been (mis)configured correctly.
  id: totrans-698
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will discuss the best practices and strategies when
    building and automating penetration testing labs in the cloud. We will tackle
    specific techniques that will help us build on top of what we’ve learned in the
    chapters of this book.
  id: totrans-699
  prefs: []
  type: TYPE_NORMAL
- en: Further reading
  id: totrans-700
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'For additional information on the topics covered in this chapter, you may find
    the following resources helpful:'
  id: totrans-701
  prefs: []
  type: TYPE_NORMAL
- en: '*Active Directory Domain Services* *Overview* ([https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview))'
  id: totrans-702
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*What is Active Directory Certificate* *Services?* ([https://learn.microsoft.com/en-us/windows-server/identity/ad-cs/active-directory-certificate-services-overview](https://learn.microsoft.com/en-us/windows-server/identity/ad-cs/active-directory-certificate-services-overview))'
  id: totrans-703
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Microsoft* *Kerberos* ([https://learn.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos](https://learn.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos))'
  id: totrans-704
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Using Windows Remote* *Management* ([https://learn.microsoft.com/en-us/windows/win32/winrm/using-windows-remote-management](https://learn.microsoft.com/en-us/windows/win32/winrm/using-windows-remote-management))'
  id: totrans-705
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
