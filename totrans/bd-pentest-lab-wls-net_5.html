<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;5.&#xA0;Implementing Security"><div class="book" id="147LC2-3ecab517ca6e4afbb3c20ab15f7b4d82"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05" class="calibre1"/>Chapter 5. Implementing Security</h1></div></div></div><p class="calibre9">This chapter is dedicated to security solutions, as well as their installation and configuration. It will show you how to protect the lab environment from external attacks and unauthorized access, and how improve the lab complexity to practice advanced penetration testing and hacking techniques at the same time. We are going to divide security solutions and measures into two main groups: host-based (protecting hosts they are installed on) and network-based (protecting the whole lab network). Additionally, we want to have a closer look at a security information and event management solution that can be used to work together with the security mechanisms in order to identify network attacks and constantly monitor the security of a network.</p><p class="calibre9">This chapter covers the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Network-based security measures</li><li class="listitem">Host-based security measures</li><li class="listitem">Security information and event management system</li></ul></div></div>

<div class="book" title="Chapter&#xA0;5.&#xA0;Implementing Security">
<div class="book" title="Network-based security solutions"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch05lvl1sec31" class="calibre1"/>Network-based security solutions</h1></div></div></div><p class="calibre9">In this chapter, we<a id="id272" class="calibre1"/> are not trying to adhere to the levels of the standard ISO/OSI model, but we distinguish two main abstract security levels: network and host levels.</p><p class="calibre9">The host level is represented with host-based security solutions that are aimed towards protecting a certain host. However, network-based solutions are aimed towards protecting the whole network or its parts (or groups of hosts). We would like to start the chapter with network-based solutions.</p></div></div>

<div class="book" title="Chapter&#xA0;5.&#xA0;Implementing Security">
<div class="book" title="Network-based security solutions">
<div class="book" title="Configuring network access control"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec49" class="calibre1"/>Configuring network access control</h2></div></div></div><p class="calibre9">In <a id="id273" class="calibre1"/>order to <a id="id274" class="calibre1"/>imitate a real network and to protect our lab from access from an external network, we need to implement access control measures between our various lab VLANs on the network level. The access control mechanism that we are going to use is called <a id="id275" class="calibre1"/><span class="strong"><strong class="calibre2">access control lists</strong></span> (<span class="strong"><strong class="calibre2">ACLs</strong></span>) and can be implemented on the core router.</p><p class="calibre9">Generally<a id="id276" class="calibre1"/> speaking, ACL<a id="id277" class="calibre1"/> is a list of rules determining which traffic is allowed or disallowed and in which directions. We are also going to create several ACLs that will block or allow network traffic between various VLANs.</p><p class="calibre9">You may think that logically it should be done in <a class="calibre1" title="Chapter 3. Configuring Networking Lab Components" href="part0024_split_000.html#MSDG1-3ecab517ca6e4afbb3c20ab15f7b4d82">Chapter 3</a>, <span class="strong"><em class="calibre10">Configuring Networking Lab Components</em></span> during the network device configuration and you would be right! But we decided to put the ACL subtopic in this chapter because it influences the security of the whole lab environment and not only devices, and it should be emphasized.</p><div class="book" title="Isolating external and guest networks"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec20" class="calibre1"/>Isolating external and guest networks</h3></div></div></div><p class="calibre9">For the<a id="id278" class="calibre1"/> security of our lab, we need to isolate untrusted network segments as is required according to the communication rules described in <a class="calibre1" title="Chapter 3. Configuring Networking Lab Components" href="part0024_split_000.html#MSDG1-3ecab517ca6e4afbb3c20ab15f7b4d82">Chapter 3</a>, <span class="strong"><em class="calibre10">Configuring Networking Lab Components</em></span>. Let's quickly recall them:</p><div class="informalexample"><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22">Source</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Allowed destination</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Purpose</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">Admin workstation</p>
</td><td valign="top" class="calibre24">
<div class="itemizedlist2"><ul class="itemizedlist3"><li class="listitem1">All network devices</li><li class="listitem1">All servers</li><li class="listitem1">All user workstations</li><li class="listitem1">Internet (external network)</li></ul></div>
</td><td valign="top" class="calibre24">
<p class="calibre22">Network and system administration</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">Servers</p>
</td><td valign="top" class="calibre24">
<div class="itemizedlist2"><ul class="itemizedlist3"><li class="listitem1">Internet (external network)</li></ul></div>
</td><td valign="top" class="calibre24">
<p class="calibre22">Software installation and updates</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">User workstations</p>
</td><td valign="top" class="calibre24">
<div class="itemizedlist2"><ul class="itemizedlist3"><li class="listitem1">Internet (external network)</li><li class="listitem1">Servers</li></ul></div>
</td><td valign="top" class="calibre24">
<p class="calibre22">Internet access, access to the internal network services</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">Trusted WLAN</p>
</td><td valign="top" class="calibre24">
<div class="itemizedlist2"><ul class="itemizedlist3"><li class="listitem1">Internet (external network)</li><li class="listitem1">Servers</li></ul></div>
</td><td valign="top" class="calibre24">
<p class="calibre22">Internet access, access to the internal network services</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">Guest WLAN</p>
</td><td valign="top" class="calibre24">
<div class="itemizedlist2"><ul class="itemizedlist3"><li class="listitem1">Internet (external network)</li></ul></div>
</td><td valign="top" class="calibre24">
<p class="calibre22">Internet access</p>
</td></tr></tbody></table></div><p class="calibre9">First, we need to block all the incoming traffic from the external network and isolate the guest WLAN. Log in to the router console, start the configuration mode, and create an ACL for that purpose called <code class="literal">wan</code> with the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">ip access-list extended wan</strong></span>
<span class="strong"><strong class="calibre2">remark deny access from wan</strong></span>
<span class="strong"><strong class="calibre2">deny ip 192.168.0.0 0.0.255.255 any log</strong></span>
<span class="strong"><strong class="calibre2">deny icmp 192.168.0.0 0.0.255.255 any</strong></span>
<span class="strong"><strong class="calibre2">exit</strong></span>
<span class="strong"><strong class="calibre2">ip access-list extended guest</strong></span>
<span class="strong"><strong class="calibre2">remark deny access to guest wlan</strong></span>
<span class="strong"><strong class="calibre2">deny ip any 192.168.0.0 0.0.255.255</strong></span>
<span class="strong"><strong class="calibre2">deny icmp any 192.168.0.0 0.0.255.255</strong></span>
</pre></div><p class="calibre9">Let's quickly <a id="id279" class="calibre1"/>explain what we have just done:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The first and the sixth lines create extended named ACLs with the names <code class="literal">wan</code> and <code class="literal">guest</code> and enter the ACL configuration mode.</li><li class="listitem">The second and seventh commands set the user-friendly comments for the new ACLs.</li><li class="listitem">The third and fourth lines deny all IP and ICMP traffic from the network 192.168.0.0/16 to any destination. We are using the keyword <code class="literal">log</code> to write all denied packets to the log for a further analysis (it allows us to detect possible attacks on our lab).</li><li class="listitem">The last two commands deny all IP and ICMP traffic from any source to the 192.168.0.0/16 network.</li></ul></div><p class="calibre9">Now, we need to apply the ACL to the router subinterface, serving communications with an external network (in our case it is <code class="literal">fa0/0.5</code>). Exit the ACL configuration mode and get into the interface configuration mode (if you have defined sub-interfaces other than the ones we have done, just substitute <code class="literal">fa0/0.5</code> with the one corresponding to your subinterface connected to a SOHO router):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">interface fa0/0.5</strong></span>
</pre></div><p class="calibre9">Now, assign the ACL called <code class="literal">wan</code> to be applied on network traffic coming to the subinterface from outside:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">access-group wan-in in</strong></span>
</pre></div><p class="calibre9">Next, assign the ACL called <code class="literal">guest</code> to be applied on network traffic coming to the subinterface from inside:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">access-group guest-out out</strong></span>
</pre></div></div><div class="book" title="Isolating internal VLANs"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec21" class="calibre1"/>Isolating internal VLANs</h3></div></div></div><p class="calibre9">The following <a id="id280" class="calibre1"/>ACL for the rest of the router subinterfaces can be created and applied in a similar manner. Therefore, we will put them in a table for convenience:</p><div class="informalexample"><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/><col class="calibre18"/><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22">Name</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Subinterface</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Direction</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">ACL</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Remark</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">trusted-in</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">fa0/0.4</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">in</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">deny ip 172.16.1.0 0.0.0.255 172.16.0.0 0.0.0.255</code>
</p>
<p class="calibre22">
<code class="literal1">deny ip 172.16.1.0 0.0.0.255 10.1.0.0 0.0.0.255</code>
</p>
<p class="calibre22">
<code class="literal1">deny icmp 172.16.1.0 0.0.0.255 172.16.0.0 0.0.0.255</code>
</p>
<p class="calibre22">
<code class="literal1">deny icmp 172.16.1.0 0.0.0.255 10.1.0.0 0.0.0.255</code>
</p>
<p class="calibre22">
<code class="literal1">permit ip any any</code>
</p>
<p class="calibre22">
<code class="literal1">permit icmp any any</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Access from trusted WLANs</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">users-in</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">fa0/0.3</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">in</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">deny ip 172.16.0.0 0.0.0.255 172.16.1.0 0.0.0.255</code>
</p>
<p class="calibre22">
<code class="literal1">deny ip 172.16.0.0 0.0.0.255 10.1.0.0 0.0.0.255</code>
</p>
<p class="calibre22">
<code class="literal1">deny icmp 172.16.0.0 0.0.0.255 172.16.1.0 0.0.0.255</code>
</p>
<p class="calibre22">
<code class="literal1">deny icmp 172.16.0.0 0.0.0.255 10.1.0.0 0.0.0.255</code>
</p>
<p class="calibre22">
<code class="literal1">permit ip any any</code>
</p>
<p class="calibre22">
<code class="literal1">permit icmp any any</code>
</p>
</td><td valign="top" class="calibre24"> </td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">servers-in</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">fa0/0.2</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">in</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">permit ip 10.0.0.0 0.0.0.255 172.16.0.0 0.0.255.255 established</code>
</p>
<p class="calibre22">
<code class="literal1">permit icmp 10.0.0.0 0.0.0.255 172.16.0.0 0.0.255.255 established</code>
</p>
<p class="calibre22">
<code class="literal1">deny ip 10.0.0.0 0.0.0.255 172.16.0.0 0.0.255.255</code>
</p>
<p class="calibre22">
<code class="literal1">deny icmp 10.0.0.0 0.0.0.255 172.16.0.0 0.0.255.255</code>
</p>
<p class="calibre22">
<code class="literal1">deny ip 10.0.0.0 0.0.0.255 10.1.0.0 0.0.255.255</code>
</p>
<p class="calibre22">
<code class="literal1">deny icmp 10.0.0.0 0.0.0.255 10.1.0.0 0.0.255.255</code>
</p>
<p class="calibre22">
<code class="literal1">permit ip any any</code>
</p>
<p class="calibre22">
<code class="literal1">permit icmp any any</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Deny connections to users and trusted WLANs initiated by servers</p>
</td></tr></tbody></table></div></div></div></div></div>

<div class="book" title="Chapter&#xA0;5.&#xA0;Implementing Security">
<div class="book" title="Network-based security solutions">
<div class="book" title="Securing wireless access"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec50" class="calibre1"/>Securing wireless access</h2></div></div></div><p class="calibre9">According <a id="id281" class="calibre1"/>to our lab idea, we want to have secure wireless access to the lab environment, a trusted WLAN.</p><p class="calibre9">As you<a id="id282" class="calibre1"/> remember from <a class="calibre1" title="Chapter 1. Understanding Wireless Network Security and Risks" href="part0014_split_000.html#DB7S2-3ecab517ca6e4afbb3c20ab15f7b4d82">Chapter 1</a>, <span class="strong"><em class="calibre10">Understanding Wireless Network Security and Risks</em></span>, the best way to secure WLAN access is to implement WPA-Enterprise security based on the IEEE 802.1x standard. To be more exact, it should be based on <a id="id283" class="calibre1"/><span class="strong"><strong class="calibre2">EAP over LAN</strong></span> (<span class="strong"><strong class="calibre2">EAPOL</strong></span>) and an AAA server.</p><p class="calibre9">We decided <a id="id284" class="calibre1"/>to choose FreeRADIUS as a suitable solution for an AAA server. FreeRADIUS is a software package containing a RADIUS server software and several auxiliary libraries and modules. Currently, we are interested only in the RADIUS server, which is enough to fulfill our tasks.</p><p class="calibre9">FreeRADIUS is a very popular solution with a modular architecture. It works really fast and distributes the important services for a lab, free of charge.</p><p class="calibre9">Before we start implementing the solution, we would like to list our next steps to give you a clearer overview of the whole process:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Preparing a VM with FreeRADIUS.</li><li class="listitem" value="2">Creating certificates.</li><li class="listitem" value="3">Configuring a RADIUS server.</li><li class="listitem" value="4">Configuring an access point.</li><li class="listitem" value="5">Configuring a WLAN client.</li></ol><div class="calibre14"/></div><div class="book" title="Preparing the RADIUS server"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec22" class="calibre1"/>Preparing the RADIUS server</h3></div></div></div><p class="calibre9">We are<a id="id285" class="calibre1"/> going to install FreeRADIUS on a Debian-based virtual Linux server and put it into the server subnet on IP address 10.0.0.6. The installation process is very similar to the Ubuntu Server installation process:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create a VM with 1024 MB RAM.</li><li class="listitem" value="2">Download a Debian Linux 8 (Jessie) image from the official website.</li><li class="listitem" value="3">Install Debian Linux using guided installation and don't forget to set strong passwords for the root and non-root users during the installation, as this server will provide lab's security and we don't want it to be vulnerable.</li><li class="listitem" value="4">After the installation, start the VM and log in under the root account.</li><li class="listitem" value="5">Make sure that the VM can access the Internet. Use NAT if is not connected to the lab network or configure IP settings if it is.</li><li class="listitem" value="6">Check whether the <code class="literal">/etc/apt/sources.list</code> file contains the following line:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">deb http://ftp.debian.org/debian jessie main</strong></span>
</pre></div></li><li class="listitem" value="7">If not, add<a id="id286" class="calibre1"/> this line to the file.</li><li class="listitem" value="8">Update the packages list.</li><li class="listitem" value="9">Install FreeRADIUS using the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">apt-get update</strong></span>
<span class="strong"><strong class="calibre2">apt-get install freeradius</strong></span>
</pre></div></li></ol><div class="calibre14"/></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note18" class="calibre1"/>Note</h3><p class="calibre9">Alternatively, you can download the newest version of FreeRADIUS from the official FTP server and compile it (change the package version number to the current one and make sure that the <code class="literal">gcc</code> compiler is installed):</p><div class="informalexample"><pre class="programlisting">wget ftp://ftp.freeradius.org/pub/freeradius/freeradius-server-3.0.9.tar.gz
tar zxfv freeradius-server-3.0.9.tar.gz
cd freeradius-server-3.0.9
./configure
make
make install</pre></div></div></div><div class="book" title="Preparing the certificates"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec23" class="calibre1"/>Preparing the certificates</h3></div></div></div><p class="calibre9">Every<a id="id287" class="calibre1"/> authorized user in our lab will have a personal certificate for the trusted WLAN connections, and it is logical to prepare certificates before we start to put their paths into the server's configuration.</p><p class="calibre9">You can use the lab certificate authority installed in <a class="calibre1" title="Chapter 4. Designing Application Lab Components" href="part0029_split_000.html#RL0A1-3ecab517ca6e4afbb3c20ab15f7b4d82">Chapter 4</a>, <span class="strong"><em class="calibre10">Designing Application Lab Components</em></span>, to create all the necessary certificates. We already have a CA certificate created, so we only need to create server and client certificates and sign them with the CA:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create a server key and a certificate request:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openssl genrsa -out radius.key 2048</strong></span>
<span class="strong"><strong class="calibre2">openssl req -key radius.key -new -our radius.csr</strong></span>
</pre></div></li><li class="listitem" value="2">Create a <code class="literal">lab_ca.srl</code> file with a two-digit serial number in it, for example, 01.</li><li class="listitem" value="3">Sign the server certificate request using the CA (you will need to provide a path to the CA certificate and key files if they are not in the current directory) and create a server certificate:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openssl x509 -req -in radius.csr -CA rootCA.crt -CAKey rootCA.key -out radius.pem</strong></span>
</pre></div></li><li class="listitem" value="4">Create a client key and certificate request:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openssl genrsa -out attacker1.key 2048</strong></span>
<span class="strong"><strong class="calibre2">openssl req -new -key attacker1.key -out attacker1.csr</strong></span>
</pre></div></li><li class="listitem" value="5">Here, you <a id="id288" class="calibre1"/>should fill the certificate's field <span class="strong"><strong class="calibre2">Common name</strong></span> with the identity of the user that will hold the certificate, for example, <code class="literal">attacker1</code> or <code class="literal">alex</code>.</li><li class="listitem" value="6">Sign the client certificate using the certificate authority:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openssl x509 -req -in attacker1.csr -CA rootCA.crt -CAkey rootCA.key -CAcreateserial -out attacker1.crt -days 365</strong></span>
</pre></div></li><li class="listitem" value="7">Export the client certificate in the PKCS#12 format for a Windows client:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openssl pkcs12 -export -in attacker1.crt -inkey attacker1.key -out attacker1.p12 -clcerts</strong></span>
</pre></div></li></ol><div class="calibre14"/></div><p class="calibre9">You can create multiple client certificates for as many users as you would like to allow access to your lab via the trusted WLAN. Copy the server and CA certificates into the <code class="literal">/etc/freeradius/certs/lab</code> directory on the FreeRADIUS server.</p></div><div class="book" title="Configuring RADIUS"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec24" class="calibre1"/>Configuring RADIUS</h3></div></div></div><p class="calibre9">Now, it is<a id="id289" class="calibre1"/> time to configure FreeRADIUS for our needs. The configuration files can be found in the <code class="literal">/etc/freeradius</code> directory.</p><p class="calibre9">We are interested in the following configuration files now:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="literal">clients.conf</code>: This <a id="id290" class="calibre1"/>defines connection settings between authenticators (Cisco access point in our case) and an authentication server (FreeRADIUS)</li><li class="listitem"><code class="literal">eap.conf</code>: This<a id="id291" class="calibre1"/> defines <a id="id292" class="calibre1"/><span class="strong"><strong class="calibre2">extensible authentication protocol</strong></span> (<span class="strong"><strong class="calibre2">EAP</strong></span>) types and settings</li></ul></div><div class="book" title="clients.conf"><div class="book"><div class="book"><div class="book"><h4 class="title3"><a id="ch05lvl4sec02" class="calibre1"/>clients.conf</h4></div></div></div><p class="calibre9">We need to add <a id="id293" class="calibre1"/>the following lines to the file to set the connection parameters for the authenticator:</p><div class="informalexample"><pre class="programlisting">client 172.16.1.2 {
        secret = YourSecret
        shortname = TrustedWLAN
}</pre></div><p class="calibre9">The <code class="literal">secret</code> parameter contains a password used by an AP to connect to the RADIUS server, so you might want to use a strong combination of symbols to raise the security of your lab.</p></div><div class="book" title="eap.conf"><div class="book"><div class="book"><div class="book"><h4 class="title3"><a id="ch05lvl4sec03" class="calibre1"/>eap.conf</h4></div></div></div><p class="calibre9">Here, we set <a id="id294" class="calibre1"/>all the necessary parameters for the EAP-TLS authentication:</p><div class="informalexample"><pre class="programlisting">default_eap_type = tls
tls {
     certdir = ${confdir}/certs/lab
     cadir = ${confdir}/certs/lab
     private_key_password = YourServerKeyPassword
     private_key_file = ${certdir}/radius.key
     certificate_file = ${certdir}/radius.pem
     CA_file = ${cadir}/rootCA.crt
     dh_file = ${certdir}/../dh
     random_file = /dev/urandom
}</pre></div><p class="calibre9">The <code class="literal">certdir</code> and <code class="literal">cadir</code> parameters set the directory where FreeRADIUS will search for server and CA certificates. In our case, they are both in <code class="literal">/etc/freeradius/certs/lab</code>.</p><p class="calibre9">The <code class="literal">private_key_password</code> parameter<a id="id295" class="calibre1"/> is the password that you typed when creating the server's private key.</p></div></div><div class="book" title="Configuring the access point"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec25" class="calibre1"/>Configuring the access point</h3></div></div></div><p class="calibre9">We have <a id="id296" class="calibre1"/>already configured the Ethernet interface of the access point in <a class="calibre1" title="Chapter 3. Configuring Networking Lab Components" href="part0024_split_000.html#MSDG1-3ecab517ca6e4afbb3c20ab15f7b4d82">Chapter 3</a>, <span class="strong"><em class="calibre10">Configuring Networking Lab Components</em></span>, but we have omitted the wireless interface configuration because it is highly dependent on a RADIUS server which we didn't have before the current chapter. Now it is time to fill this gap:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Connect to the AP's console port and enter the privileged mode with the <code class="literal">enable</code> command and the password that you set during the initial AP configuration in <a class="calibre1" title="Chapter 3. Configuring Networking Lab Components" href="part0024_split_000.html#MSDG1-3ecab517ca6e4afbb3c20ab15f7b4d82">Chapter 3</a>, <span class="strong"><em class="calibre10">Configuring Networking Lab Components </em></span>(the default password is <code class="literal">Cisco</code>).</li><li class="listitem" value="2">Let's configure the authentication server (RADIUS) settings first:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">configure terminal</strong></span>
<span class="strong"><strong class="calibre2">aaa group server radius rad_eap</strong></span>
<span class="strong"><strong class="calibre2">server 10.0.0.6 auth-port 1812 acct-port 1813</strong></span>
<span class="strong"><strong class="calibre2">exit</strong></span>
<span class="strong"><strong class="calibre2">aaa new-model</strong></span>
<span class="strong"><strong class="calibre2">aaa authentication login eap_methods group rad_eap</strong></span>
<span class="strong"><strong class="calibre2">radius-server host 10.0.0.6 auth-port 1812 acct-port 1813 key YourSecret</strong></span>
<span class="strong"><strong class="calibre2">end</strong></span>
<span class="strong"><strong class="calibre2">write memory</strong></span>
</pre></div></li><li class="listitem" value="3">Change <code class="literal">YourSecret</code> to the value that you have set in <code class="literal">clients.conf</code> during the FreeRADIUS configuration.</li><li class="listitem" value="4">Now, we need to configure the radio interface called <code class="literal">dot11radio</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">configure terminal</strong></span>
<span class="strong"><strong class="calibre2">interface dot11radio 0</strong></span>
<span class="strong"><strong class="calibre2">encryption mode ciphers aes-ccm</strong></span>
<span class="strong"><strong class="calibre2">exit</strong></span>
<span class="strong"><strong class="calibre2">write memory</strong></span>
</pre></div></li><li class="listitem" value="5"><code class="literal">lab_private</code> is the SSID for our trusted WLAN and you can change it to anything you like.</li><li class="listitem" value="6">As the <a id="id297" class="calibre1"/>next step, we will configure the WLAN settings:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">configure terminal</strong></span>
<span class="strong"><strong class="calibre2">dot11 ssid lab_private</strong></span>
<span class="strong"><strong class="calibre2">authentication open eap eap-tls</strong></span>
<span class="strong"><strong class="calibre2">authentication key-management wpa version 2</strong></span>
<span class="strong"><strong class="calibre2">guest-mode</strong></span>
<span class="strong"><strong class="calibre2">end</strong></span>
<span class="strong"><strong class="calibre2">write memory</strong></span>
</pre></div></li><li class="listitem" value="7">You can omit the <code class="literal">guest-mode</code> command to disable SSID broadcasting, making your WLAN slightly more secure (but not really raising the security level).</li><li class="listitem" value="8">After configuring the radio interface and the SSID, we can assign the SSID to the interface and turn the interface on:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">configure terminal</strong></span>
<span class="strong"><strong class="calibre2">interface dot11radio 0</strong></span>
<span class="strong"><strong class="calibre2">ssid lab_private</strong></span>
<span class="strong"><strong class="calibre2">no shutdown</strong></span>
<span class="strong"><strong class="calibre2">exit</strong></span>
<span class="strong"><strong class="calibre2">copy running-config startup-config</strong></span>
</pre></div></li></ol><div class="calibre14"/></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note19" class="calibre1"/>Note</h3><p class="calibre9">If you have chosen to set a software AP for the trusted WLAN, you can use the following tools:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Built-in tools or <code class="literal">hostapd</code> software on Linux (we will show how to install and configure it in <a class="calibre1" title="Chapter 7. Preparing a Wireless Penetration Testing Platform" href="part0047_split_000.html#1CQAE1-3ecab517ca6e4afbb3c20ab15f7b4d82">Chapter 7</a>, <span class="strong"><em class="calibre10">Preparing a Wireless Penetration Testing Platform</em></span>)</li><li class="listitem">Special software (for example, Connectify or ARPMiner) on Windows</li></ul></div><p class="calibre9">After installing and configuring the chosen software, you will need to add a link between a wireless network and the virtual lab infrastructure using the tool Cloud of the GNS3 system, as described earlier in <a class="calibre1" title="Chapter 3. Configuring Networking Lab Components" href="part0024_split_000.html#MSDG1-3ecab517ca6e4afbb3c20ab15f7b4d82">Chapter 3</a>, <span class="strong"><em class="calibre10">Configuring Networking Lab Components</em></span>.</p></div></div><div class="book" title="Configuring the WLAN client"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec26" class="calibre1"/>Configuring the WLAN client</h3></div></div></div><p class="calibre9">As a <a id="id298" class="calibre1"/>closing step, we need to test our newly created WLAN by connecting a client machine to it. Let's do it on a Windows 8.1 machine:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, you need to copy the attacker's certificate in the PKCS#12 format to a client machine and install it.</li><li class="listitem" value="2">Then you need to click on the networking icon in the system tray to get a list of available wireless networks, as with WEP- or WPA-PSK-protected networks.</li><li class="listitem" value="3">Choose the <span class="strong"><strong class="calibre2">lab_private</strong></span> option in the wireless network list and click on the <span class="strong"><strong class="calibre2">Other ways to connect</strong></span> link:<div class="mediaobject"><img src="../images/00035.jpeg" alt="Configuring the WLAN client" class="calibre11"/></div><p class="calibre26"> </p></li><li class="listitem" value="4">Then, click on <span class="strong"><strong class="calibre2">Certificate</strong></span>, choose the lab certificate, and click on <span class="strong"><strong class="calibre2">OK</strong></span>:<div class="mediaobject"><img src="../images/00036.jpeg" alt="Configuring the WLAN client" class="calibre11"/></div><p class="calibre26"> </p></li></ol><div class="calibre14"/></div><p class="calibre9">Now, you are <a id="id299" class="calibre1"/>connected to the trusted WLAN and can penetrate our vulnerable servers. So far, we have reliably secured our trusted WLAN and the whole lab network from an unauthorized network access. We have almost reached the main goal of the book: building a lab with wireless access protected from attacks from outside.</p></div></div></div></div>

<div class="book" title="Chapter&#xA0;5.&#xA0;Implementing Security">
<div class="book" title="Network-based security solutions">
<div class="book" title="Installing a network intrusion detection system"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec51" class="calibre1"/>Installing a network intrusion detection system</h2></div></div></div><p class="calibre9">Now, let's see <a id="id300" class="calibre1"/>how <a id="id301" class="calibre1"/>we go ahead with installing the system in our network to detect any intrusion.</p><div class="book" title="Activating SPAN"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec27" class="calibre1"/>Activating SPAN</h3></div></div></div><p class="calibre9">Cisco <a id="id302" class="calibre1"/>devices have a feature<a id="id303" class="calibre1"/> called <span class="strong"><strong class="calibre2">Switched Port Analyzer</strong></span> (<span class="strong"><strong class="calibre2">SPAN</strong></span>), which basically mirrors network traffic from selected source ports to a selected destination port. We need this feature to copy network traffic coming through the server VLAN to our network-based IDS for further analysis.</p><p class="calibre9">We are going to monitor the whole server traffic (ports <code class="literal">fa0/7</code>-<code class="literal">fa0/10</code>) on the <code class="literal">fa0/11</code> port, so let's configure <a id="id304" class="calibre1"/>SPAN on our core switch with the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">enable</strong></span>
<span class="strong"><strong class="calibre2">config t</strong></span>
<span class="strong"><strong class="calibre2">interface fa0/11</strong></span>
<span class="strong"><strong class="calibre2">port monitor fa0/7</strong></span>
<span class="strong"><strong class="calibre2">port monitor fa0/8</strong></span>
<span class="strong"><strong class="calibre2">port monitor fa0/9</strong></span>
<span class="strong"><strong class="calibre2">port monitor fa0/10</strong></span>
<span class="strong"><strong class="calibre2">end</strong></span>
<span class="strong"><strong class="calibre2">copy running-config startup-config</strong></span>
</pre></div></div><div class="book" title="Snort"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec28" class="calibre1"/>Snort</h3></div></div></div><p class="calibre9">Snort<a id="id305" class="calibre1"/> is a<a id="id306" class="calibre1"/> free, open source network <span class="strong"><strong class="calibre2">Intrusion Detection System</strong></span> (<span class="strong"><strong class="calibre2">IDS</strong></span>)<a id="id307" class="calibre1"/> capable of performing packet logging and real-time traffic analysis in IP-based networks.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note21" class="calibre1"/>Note</h3><p class="calibre9">There are other alternatives to Snort that you might want to explore, for example, Suricata.</p></div><p class="calibre9">This IDS identifies the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Attacks on network protocols</li><li class="listitem">Scanning (ports and services)</li><li class="listitem">DoS attacks</li><li class="listitem">Attacks on services such as FTP, DNS, e-mail, and so on</li><li class="listitem">Attacks on databases</li><li class="listitem">Attacks on the Web</li><li class="listitem">Exploits and various malwares</li></ul></div><p class="calibre9">Taking into account the following points, we have a system with powerful features for security monitoring:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Ability to write their own rules</li><li class="listitem">Enhanced functionality by using the connectivity modules</li><li class="listitem">Flexible system of warning about the attacks (log files, output devices, or a database ID)</li></ul></div><p class="calibre9">Snort can be executed on various operating systems: Windows and Unix-like. In our case, we are using Ubuntu Server 14 and we will consider the Linux distribution.</p><div class="book" title="Installing Snort"><div class="book"><div class="book"><div class="book"><h4 class="title3"><a id="ch05lvl4sec04" class="calibre1"/>Installing Snort</h4></div></div></div><p class="calibre9">So, the<a id="id308" class="calibre1"/> installation process is pretty simple in Ubuntu Linux. We should just execute one command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">apt-get install snort</strong></span>
</pre></div><p class="calibre9">After a few<a id="id309" class="calibre1"/> minutes, installation will be complete and we can start the Snort service on our system using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">service snort start</strong></span>
</pre></div><p class="calibre9">Next, let's update the Snort rules set. You can get the latest version of the rules from the official website <a id="id310" class="calibre1"/>at <a class="calibre1" href="https://www.snort.org/downloads">https://www.snort.org/downloads</a> in the <span class="strong"><strong class="calibre2">Rules</strong></span> section. We will use the <span class="strong"><strong class="calibre2">Registered user release</strong></span> set, because it is the most up-to-date one. However, it needs registration. You can sign up at <a class="calibre1" href="https://www.snort.org/users/sign_up">https://www.snort.org/users/sign_up</a>.</p><p class="calibre9">After downloading, let's unpack the downloaded archive file and copy the rules directories <code class="literal">so_rules</code> and <code class="literal">preproc_rules</code> in <code class="literal">/etc/snort</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cp -R ./rules/ /etc/snort/</strong></span>
<span class="strong"><strong class="calibre2">cp -R ./so_rules/ /etc/snort/</strong></span>
<span class="strong"><strong class="calibre2">cp -R ./preproc_rules/ /etc/snort/</strong></span>
</pre></div><p class="calibre9">After that, we need to restart Snort:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">service snort restart</strong></span>
</pre></div><p class="calibre9">After all these manipulations, we have a working instance of the IDS Snort system. Next, let's configure our intrusion detection system in more detail.</p></div><div class="book" title="Configuring Snort"><div class="book"><div class="book"><div class="book"><h4 class="title3"><a id="ch05lvl4sec05" class="calibre1"/>Configuring Snort</h4></div></div></div><p class="calibre9">The <a id="id311" class="calibre1"/>main<a id="id312" class="calibre1"/> configuration of Snort is located in the <code class="literal">snort.conf</code> file in the<code class="literal"> /etc/snort/</code> directory. Initially, this file is based on the example configuration. It is big but very well commented, so it should not make you seriously confused. The configuration file consists of nine sections:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Network variables</li><li class="listitem">Configuration of the decoder</li><li class="listitem">Configuration of the base detection engine</li><li class="listitem">Configuration of dynamic loaded libraries</li><li class="listitem">Configuration of preprocessors</li><li class="listitem">Configuration of output plugins</li><li class="listitem">Customization of your rule set</li><li class="listitem">Customization of preprocessor and decoder rule set</li><li class="listitem">Customization of shared object rule set</li></ul></div><p class="calibre9">Let's start with<a id="id313" class="calibre1"/> basic variables that will describe our infrastructure:</p><div class="informalexample"><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22">Type</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Variable</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Value</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Description</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">ipvar</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">HOME_NET</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">[10.0.0.0/24,10.1.0.0/24]</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Home network, from which attacks are possible. It is a host or a list of hosts whose traffic will analyze Snort.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">ipvar</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">EXTERNAL_NET</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">[172.16.0.0/24,192.168.0.0/24,172.16.2.0/24]</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">The network from which the attack could begin.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">ipvar</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">DNS_SERVERS</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">10.0.0.2</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">It is a list of DNS servers.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">ipvar</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">HTTP_SERVERS</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">10.0.0.3,10.0.0.5</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">It is a list of web servers.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">ipvar</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">SQL_SERVERS</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">10.0.0.3</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">It is a list of SQL servers.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">portvar</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">HTTP_PORTS</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">80,443</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">It is a list of web ports.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">ipvar</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">SIP_SERVERS</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">10.0.0.4</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">It is a list of SIP servers.</p>
</td></tr></tbody></table></div><p class="calibre9">We leave the <a id="id314" class="calibre1"/>default values for the other settings in this file. Of course, you can configure Snort to work in the way that best suits your needs. Since this is a learning laboratory, settings in a particular case may be quite different.</p><p class="calibre9">In order for the changes to take effect, we need to restart the Snort daemon:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">service snort restart</strong></span>
</pre></div><p class="calibre9">Now, we can try to run Snort:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">snort -D -dev -c /etc/snort.conf</strong></span>
</pre></div><p class="calibre9">After starting <a id="id315" class="calibre1"/>the daemon, we will check the network interface that Snort is listening to:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">ifconfig -a</strong></span>
</pre></div><p class="calibre9">If the interface is in promisc mode, everything is fine.</p></div><div class="book" title="Snort rules"><div class="book"><div class="book"><div class="book"><h4 class="title3"><a id="ch05lvl4sec06" class="calibre1"/>Snort rules</h4></div></div></div><p class="calibre9">Writing <a id="id316" class="calibre1"/>your own rules is not difficult <a id="id317" class="calibre1"/>but is often necessary, because vulnerabilities are found every day, and in the case of a test laboratory, infrastructure is changing for the needs of tests.</p><p class="calibre9">The structure of the rules corresponds to the following scheme:</p><p class="calibre9">&lt;Action&gt; &lt;Protocol&gt; &lt;Port&gt; &lt;Direction&gt; &lt;Port&gt; ([metadata] [content of the package] [Data] [Action after detection])</p><p class="calibre9">Actions are divided into the following parts:</p><div class="informalexample"><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22">Action</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Description</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">alert</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Create an alert using the selected method, and pass the information to the system log.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">log</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Use the system log to record information about the package.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">pass</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Ignore the package.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">activate</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Use another dynamic rule.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">dynamic</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">After you have made the active rule, a rule is activated with the procedure logging.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">drop</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Discard packet using a firewall, and pass information to the system log. It works only in the inline mode.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">sdrop</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Discard the packet using software firewall and do not use the system log. It works only in the inline mode.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">reject</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Using firewall, discard the packet if the protocol is TCP, or record a message in the log file: ICMP port is not available if the package comes over UDP. It works only in the inline mode.</p>
</td></tr></tbody></table></div><p class="calibre9">Next, follow the protocol. This parameter can take the following values: TCP, UDP, IP, and ICMP.</p><p class="calibre9">The next three parameters determine the source and destination IP addresses and port numbers for the rule to be applied to. They can be set as a certain value, a range, or any value. A range of IP addresses can be set with a CIRD block mask starting with <code class="literal">/</code>, for example: <code class="literal">/24</code>. A range of ports can be set with the start and end port numbers separated with a colon, for example: <code class="literal">25 : 445</code>.</p><p class="calibre9">It also<a id="id318" class="calibre1"/> important to specify the traffic direction in which the rule should be applied with the symbols <code class="literal">-&gt;</code> for the direction from source to destination or <code class="literal">&lt;&gt;</code> for a bidirectional traffic flow.</p><p class="calibre9">After specifying <a id="id319" class="calibre1"/>all the parameters of a rule, you can also set several options that follow the rule header in brackets and should be separated from each other with a semicolon. The option keywords should be separated from their values with a colon.</p><p class="calibre9">All options can be divided into four categories:</p><div class="informalexample"><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22">Category</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Description</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">meta-data</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">These options are not specified for a data validation package. It contains information about the type of attack, the possible vulnerability of the materials, links, and so on.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">payload</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Parameters of this category contain information about the data itself, which contains a package.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">non-payload</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This category contains official information about the packet (header).</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal1">post-detection</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">It specifies the tasks to be carried out after finding the information in the package.</p>
</td></tr></tbody></table></div><p class="calibre9">For effective monitoring of activities, you should learn the language rules of Snort. Unfortunately, the full description of all rules is beyond the scope of this book, but you can find more information on the Internet.</p><p class="calibre9">For now, we have a working network intrusion detection system and we can develop it for specific needs.</p></div></div></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Host-based security solutions"><div class="book" id="1565U2-3ecab517ca6e4afbb3c20ab15f7b4d82"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec32" class="calibre1"/>Host-based security solutions</h1></div></div></div><p class="calibre9">The second class<a id="id320" class="calibre1"/> of security solutions that we are going to cover in the current chapter is host-based solutions. Such solutions are installed on the same hosts which they have to protect.</p><p class="calibre9">You need to have a host-based security solution in your lab mainly for two purposes: to practice firewall/IPS evasion techniques and to test the detectability and obfuscation of your exploits (payloads) and <a id="id321" class="calibre1"/>malware. But, as always, there could be other personal reasons for having such security measures.</p></div>

<div class="book" title="Host-based security solutions">
<div class="book" title="Workstation security"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec52" class="calibre1"/>Workstation security</h2></div></div></div><p class="calibre9">To <a id="id322" class="calibre1"/>better imitate a real enterprise network and create a possibility for testing various evasion techniques, we are going to install free endpoint security solutions on our lab workstations.</p><p class="calibre9">We recommend <a id="id323" class="calibre1"/>that you create snapshots of your workstations before installing any host-based security solutions, as they will definitely make penetrating workstations a bit problematic and you don't need it before you proceed to an advanced hacking level. Using snapshots allows quick switching between the various system states of a VM and you can always fall back if you have broken something.</p><div class="book" title="EMET"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec29" class="calibre1"/>EMET</h3></div></div></div><p class="calibre9">The<a id="id324" class="calibre1"/> first workstation security solution in our list is the <span class="strong"><strong class="calibre2">Enhanced Mitigation Experience Toolkit</strong></span> (<span class="strong"><strong class="calibre2">EMET</strong></span>) from Microsoft. This tool helps to protect <a id="id325" class="calibre1"/>applications from being exploited if they contain software vulnerabilities. The tool uses a lot of protection techniques, including memory randomization and protection techniques as well as certificate pinning feature to withstand man-in-the-middle attacks. It can be obtained from the official website at <a class="calibre1" href="http://www.microsoft.com/emet">http://www.microsoft.com/emet</a>.</p><p class="calibre9">We are going to install EMET 5.2 on a Windows 7 workstation. The installation process using graphical<a id="id326" class="calibre1"/> interface is not complicated, so we will use a lot of screenshots.</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Log in to a Windows 7 workstation and download EMET 5.2 (or newer if it is already available) from the official webpage:<div class="mediaobject"><img src="../images/00037.jpeg" alt="EMET" class="calibre11"/><div class="caption"><p class="calibre15">EMET 5.2 download menu</p></div></div><p class="calibre26"> </p></li><li class="listitem" value="2">Start the<a id="id327" class="calibre1"/> installation wizard and follow the dialog-based instructions:<div class="mediaobject"><img src="../images/00038.jpeg" alt="EMET" class="calibre11"/><div class="caption"><p class="calibre15">EMET 5.2 installation process</p></div></div><p class="calibre26"> </p></li><li class="listitem" value="3">Choose the recommended settings:<div class="mediaobject"><img src="../images/00039.jpeg" alt="EMET" class="calibre11"/><div class="caption"><p class="calibre15">EMET 5.2 settings choice</p></div></div><p class="calibre26"> </p></li><li class="listitem" value="4">After the<a id="id328" class="calibre1"/> installation, you can find the EMET icon in the taskbar. Right-click on it and open EMET:<div class="mediaobject"><img src="../images/00040.jpeg" alt="EMET" class="calibre11"/><div class="caption"><p class="calibre15">EMET 5.2 main window</p></div></div><p class="calibre26"> </p></li><li class="listitem" value="5">You can<a id="id329" class="calibre1"/> click on the <span class="strong"><strong class="calibre2">Apps</strong></span> button in the menu to see which protection setting is set for which applications:<div class="mediaobject"><img src="../images/00041.jpeg" alt="EMET" class="calibre11"/><div class="caption"><p class="calibre15">EMET 5.2 application protection settings</p></div></div><p class="calibre26"> </p></li></ol><div class="calibre14"/></div><p class="calibre9">Now, we can<a id="id330" class="calibre1"/> proceed with installing a host-based intrusion prevention system.</p></div><div class="book" title="HIPS"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec30" class="calibre1"/>HIPS</h3></div></div></div><p class="calibre9">Like<a id="id331" class="calibre1"/> EMET, we<a id="id332" class="calibre1"/> need a HIPS and antivirus mostly for evasion testing purposes and for advanced attacks or research scenarios. You can choose any of the popular software and the more solutions you have in the lab, the better it is because it will allow you to test your payloads and evasion techniques against a wider range of detection and protection tools. This will give you a better chance of a successful attack.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip20" class="calibre1"/>Tip</h3><p class="calibre9">Normally, it is not recommended to install a lot of security solutions of one type from different vendors as they can conflict and cause system instability. In our example, we have tested the proposed solution, but if you want to do the same thing with other software, we recommend you test it properly.</p></div><p class="calibre9">For<a id="id333" class="calibre1"/> demonstration purposes, it will be enough to install just one solution, and preferably it should be free. We have chosen Comodo Internet Security 2015.</p><p class="calibre9">Comodo <span class="strong"><strong class="calibre2">Internet Security</strong></span> (<span class="strong"><strong class="calibre2">IS</strong></span>) is a <a id="id334" class="calibre1"/>solution that combines antivirus, firewall, and auto-sandbox software and has a free version available at Comodo's website. The steps are as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">The installation process is also simple, as in the case of EMET. But it has some peculiarities. You should not miss the small link <span class="strong"><strong class="calibre2">Customize Installation</strong></span> in the bottom-left corner of the second installation dialog:<div class="mediaobject"><img src="../images/00042.jpeg" alt="HIPS" class="calibre11"/><div class="caption"><p class="calibre15">Accessing the Comodo IS installation customization dialog</p></div></div><p class="calibre26"> </p></li><li class="listitem" value="2">For our purposes, we don't need the GeekBuddy component or the Chromodo browser, so just uncheck the corresponding checkboxes:<div class="mediaobject"><img src="../images/00043.jpeg" alt="HIPS" class="calibre11"/><div class="caption"><p class="calibre15">Choosing Comodo IS components to install</p></div></div><p class="calibre26"> </p></li><li class="listitem" value="3">We also do <a id="id335" class="calibre1"/>not want Comodo to change our DNS settings, so uncheck the appropriate checkbox on the next dialog too. It is up to you to decide if you want to help Comodo by setting Yahoo! as the default search engine. However, in the case of a lab workstation, it will not help Comodo anyhow so we uncheck the option:<div class="mediaobject"><img src="../images/00044.jpeg" alt="HIPS" class="calibre11"/><div class="caption"><p class="calibre15">Comodo IS installation customization</p></div></div><p class="calibre26"> </p></li><li class="listitem" value="4">Finish the installation and restart the workstation.</li><li class="listitem" value="5">Comodo Internet Security 2015 is installed and working now. The last thing left to do is to create a snapshot of the VM state:<div class="mediaobject"><img src="../images/00045.jpeg" alt="HIPS" class="calibre11"/><div class="caption"><p class="calibre15">Comodo IS main window</p></div></div><p class="calibre26"> </p></li></ol><div class="calibre14"/></div></div></div></div>

<div class="book" title="Host-based security solutions">
<div class="book" title="Web application firewall"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec53" class="calibre1"/>Web application firewall</h2></div></div></div><p class="calibre9">Web<a id="id336" class="calibre1"/> application firewall <a id="id337" class="calibre1"/>is a class of security solutions that is dedicated to protecting web applications by inspecting HTTP/S requests and responses and taking various actions based on special patterns (rules). Those actions can be blocking or logging or some more complicated actions can be taken.</p><p class="calibre9">When<a id="id338" class="calibre1"/> talking about free web application firewalls, the first one that comes to our mind is definitely ModSecurity. To better explain what is it, we are going to quote the description from the official ModSecurity website (<a class="calibre1" href="https://www.modsecurity.org/">https://www.modsecurity.org/</a>):</p><div class="blockquote"><blockquote class="blockquote1"><p class="calibre25">"ModSecurity is an open source, cross-platform web application firewall (WAF) module. Known as the "Swiss Army Knife" of WAFs, it enables web application defenders to gain visibility into HTTP(S) traffic and provides a power rules language and API to implement advanced protections."</p></blockquote></div><p class="calibre9">We think we will not be wrong if we say that it is the most popular free web application firewall in the world and we would like to show you how to prepare it for lab usage on our web server. So, let's start.</p><p class="calibre9">First, we should<a id="id339" class="calibre1"/> install ModSecurity. There are several ways to install ModSecurity, but the fastest and the easiest one in our case is installing it from the Ubuntu package repository using <a id="id340" class="calibre1"/><span class="strong"><strong class="calibre2">Advanced Packaging Tool</strong></span> (<span class="strong"><strong class="calibre2">APT</strong></span>). Log in to the web server and run the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo apt-get update</strong></span>
<span class="strong"><strong class="calibre2">sudo apt-get install libapache2-modsecurity</strong></span>
</pre></div><p class="calibre9">To check whether ModSecurity was successfully installed and loaded, you can use the <code class="literal">apachectl</code> utility with the option <code class="literal">-M</code> and <code class="literal">grep</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo apachectl -M|gerp security</strong></span>
</pre></div><p class="calibre9">You should see something similar to <code class="literal">security2_module</code> (shared), which indicates that ModSecurity was successfully integrated to Apache.</p><p class="calibre9">ModSecurity keeps its configs in the <code class="literal">/etc/modsecurity/</code> directory and it is distributed with a sample of predefined rules and configs. The default configuration file is <code class="literal">modsecurity.conf-recommended</code>. It is a good idea to keep a backup of that file so that we will create a copy that will serve as a working config:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo cp /etc/modsecurity/modsecurity.conf-recommended /etc/modesecurity/modsecurity.conf</strong></span>
</pre></div><p class="calibre9">After that, we need to restart Apache web server in order to make it load with the new ModSecurity config:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo service apache2 restart</strong></span>
</pre></div><p class="calibre9">ModSecurity can work as an intrusion detection system and as an intrusion prevention system. When working in the detection mode, ModSecurity just logs activities that were determined as malicious according to a current rule set. In the prevention mode, it can actually block attacks.</p><p class="calibre9">The mode settings (as well as a lot of other ModSecurity settings) can be changed in <code class="literal">/etc/modsecurity/modsecurity.conf</code>.</p><p class="calibre9">For initial web hacking training, you probably don't want your attacks to be blocked, and in this case you can leave ModSecurity in an IDS mode (detection mode), leaving the <code class="literal">SecRuleEngine</code> option with the following value:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">SecRuleEngine DetectionOnly</strong></span>
</pre></div><p class="calibre9">This will allow you to practice various attacks without any interference from the WAF. At the same time, it allows you to understand how WAF works with a current rule set by inspecting its logs.</p><p class="calibre9">When you want to practice advanced attacks with WAF evasion techniques, you can switch WAF into the prevention mode by changing the value of the <code class="literal">SecRuleEngine</code> option to <code class="literal">On</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">SecRuleEngine On</strong></span>
</pre></div><p class="calibre9">There is also <a id="id341" class="calibre1"/>another interesting configuration option that is important in case of limited processing resources on VMs: <code class="literal">SecResponseBodyAccess</code>. This option enables and disables server response body inspection, which does not makes a lot of sense in a lab environment unless you need it for specific tasks. It also consumes additional processing resources that can slow down the server a bit. Our recommendation is to turn the response body inspection off in the meantime and turn it on when it is really necessary. The feature is turned on by default:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">SecResponseBodyAccess On</strong></span>
</pre></div><p class="calibre9">We need to change it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">SecResponseBodyAccess Off</strong></span>
</pre></div><p class="calibre9">To make use of ModSecurity, it should have rules set, according to which it will inspect requests (and/or responses). There is a predefined rule set distributed with ModSecurity and called <a id="id342" class="calibre1"/><span class="strong"><strong class="calibre2">Core Rule Set</strong></span> (<span class="strong"><strong class="calibre2">CRS</strong></span>). You can find it in <code class="literal">/usr/share/modsecurity-crs/</code>. To activate the rule set, we need to explicitly include their directories in Apache's configuration in the file <code class="literal">/etc/apache2/mods-enabled/mod-security.conf</code> file and create symlinks to the rules that we would like to activate in <code class="literal">/usr/share/modsecurity-crs/activated_rules/</code>:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open the <code class="literal">/etc/apache2/mods-enabled/security2.conf</code> file in the editor and put the following lines in the <code class="literal">&lt;IfModule security2_module&gt; &lt;/IfModule&gt;</code> section:<div class="informalexample"><pre class="programlisting">Include "/usr/share/modsecurity-crs/*.conf"
Include "/usr/share/modsecurity-crs/activated_rules/*.conf"</pre></div></li><li class="listitem" value="2">Create symlinks in <code class="literal">/usr/share/modsecurity-crs/activated_rules/</code>. Go to the directory and execute the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">ln –s ../base_rules/modsecurity_40_generic_attacks.data</strong></span>
<span class="strong"><strong class="calibre2">ln –s ../base_rules/modsecurity_crs_40_generic_attacks.conf</strong></span>
<span class="strong"><strong class="calibre2">ln –s ../base_rules/modsecurity_crs_41_xss_attacks.conf</strong></span>
<span class="strong"><strong class="calibre2">ln –s ../base_rules/modsecurity_crs_41_sql_injeciton_attacks.conf</strong></span>
</pre></div></li><li class="listitem" value="3">Reload the Apache service for the changes to take effect:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo service apache2 reload</strong></span>
</pre></div></li></ol><div class="calibre14"/></div><p class="calibre9">Now the configuration phase is finished, we need to check if ModSecurity works and detects malicious requests. Let's use DVWA for that. Open a browser on another machine and navigate to <code class="literal">http://10.0.0.5/dvwa/login.php</code>. Enter an obvious SQL injection pattern in the username field, for example:</p><div class="informalexample"><pre class="programlisting">user' or 1=1 --</pre></div><p class="calibre9">Click on <a id="id343" class="calibre1"/>the <span class="strong"><strong class="calibre2">Login</strong></span> button or just hit <span class="strong"><em class="calibre10">Enter</em></span>. Go back to the web server and check the content of the ModSecurity's log:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo cat /var/log/apache2/modsec_audit.log</strong></span>
</pre></div><p class="calibre9">The log should contain an alert indicating that the request matched a pattern from the SQL injection rule set:</p><div class="mediaobject"><img src="../images/00046.jpeg" alt="Web application firewall" class="calibre11"/><div class="caption"><p class="calibre15">ModSecurity has detected an SQL injection</p></div></div><p class="calibre12"> </p><div class="informalexample" title="Note"><h3 class="title2"><a id="note22" class="calibre1"/>Note</h3><p class="calibre9">This is just an example, but we strongly recommend you go beyond the examples and experiment by tweaking WAF rules and other WAFs in order to acquire outstanding penetration testing skills.</p></div></div></div>

<div class="book" title="Host-based security solutions">
<div class="book" title="ClamAV"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec54" class="calibre1"/>ClamAV</h2></div></div></div><p class="calibre9">So, we <a id="id344" class="calibre1"/>have protected workstations based on the Windows operating system from virus threats. Now, it's time to protect our Linux servers and e-mail services from malicious code.</p><p class="calibre9">To build a<a id="id345" class="calibre1"/> multi-tier protection, we must protect not only Windows platform hosts, but also Linux servers, as well as transfer and store file services. So, we create automatic scans for viruses for all incoming and outgoing e-mail messages.</p><p class="calibre9">For this purpose, as an antivirus solution, we consider ClamAV. ClamAV is antivirus software that runs on many operating systems, including Unix-like OSes, OpenVMS, Microsoft Windows, and Apple Mac OS X. ClamAV is produced under the GNU General Public License and is a free software.</p><p class="calibre9">The main objective of ClamAV is integration with e-mail servers to verify the files attached to messages. The package includes a scalable multi-threaded daemon clamd, which is controlled from the command line scanner clamscan, as well as a module signature that updates via the Internet freshclam.</p><p class="calibre9">Some of the ClamAV features<a id="id346" class="calibre1"/> are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Command-line management</li><li class="listitem">Can be used with most e-mail servers, including the implementation of milter-interface with Sendmail</li><li class="listitem">Scanner implemented as a C library</li><li class="listitem">Scanning files and e-mail on the fly</li><li class="listitem">Definition of over 850,000 viruses, worms, Trojans, and phishing messages</li><li class="listitem">Analysis of compressed files</li><li class="listitem">Support for scanning mbox, Maildir, and raw mail files</li><li class="listitem">Analysis file formats, such as portable executable, packed UPX, FSG, and Petite</li></ul></div><div class="book" title="Installing"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec31" class="calibre1"/>Installing</h3></div></div></div><p class="calibre9">Well, let's start with <a id="id347" class="calibre1"/>solution's installation. For obtaining the ClamAV distribution package, please visit the manufacturer's website <a class="calibre1" href="http://www.clamav.net/download.html">http://www.clamav.net/download.html</a>. Or, as in our case, you can use built-in operating system tools. Since we are using the Ubuntu Linux operating system 14.04.3, we just run following command in the console on behalf of the root user:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">apt-get clamav clamav-daemon</strong></span>
</pre></div><p class="calibre9">If you prefer to use a normal user, you can execute following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo apt-get clamav clamav-daemon</strong></span>
</pre></div><p class="calibre9">After this, we will have a working instance of ClamAV. To start or stop the service, you can use the built-in tools <a id="id348" class="calibre1"/>of your operating system.</p></div><div class="book" title="Configuring"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec32" class="calibre1"/>Configuring</h3></div></div></div><p class="calibre9">In the next step, we <a id="id349" class="calibre1"/>need to reconfigure ClamAV so that the ClamAV daemon uses TCP connections instead of a local Unix socket. For this, just execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">dpkg-reconfigure clamav-base</strong></span>
</pre></div><p class="calibre9">This command will start a configuration wizard. Let's leave all the answers at the default values, except for the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Socket type (set it to <code class="literal">TCP</code> instead of <code class="literal">Unix</code>)</li><li class="listitem">The TCP port <code class="literal">clamd</code> will listen on (you can set your own TCP port address for listening to incoming messages, but we recommend you leave it as <code class="literal">3310</code>)</li><li class="listitem">The IP address <code class="literal">clamd</code> will listen on (here, we should set the IP address of the used network interface, but you can also set it as any)</li></ul></div><p class="calibre9">You can check or clarify your configuration of ClamAV by editing the configuration file <code class="literal">/etc/clamav/clamd.conf</code>.</p><p class="calibre9">After the reconfiguration process is completed, we need to restart the ClamAV daemon:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">/etc/init.d/clamav-daemon restart</strong></span>
</pre></div><p class="calibre9">Next, we should update the database. For this, we need to execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">freshclam</strong></span>
</pre></div></div><div class="book" title="Usage and integration with the mail server"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec33" class="calibre1"/>Usage and integration with the mail server</h3></div></div></div><p class="calibre9">We <a id="id350" class="calibre1"/>have installed the antivirus solution and updated the database. Now we need to check how it works. For example, to check a directory, run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">clamscan -r /</strong></span>
</pre></div><p class="calibre9">This command will <a id="id351" class="calibre1"/>check the entire filesystem if it is necessary to check any particular directory; instead of <code class="literal">/</code>, specify the directory name. To check a suspicious file, just type <code class="literal">clamscan FILENAME</code>. Let's check our antivirus with an <a id="id352" class="calibre1"/><span class="strong"><strong class="calibre2">EICAR</strong></span> (<span class="strong"><strong class="calibre2">European Institute for Computer Antivirus Research</strong></span>) test file. It is a standard file that is used to check whether the antivirus and inherently is not a virus. You can get <a id="id353" class="calibre1"/>this file at <a class="calibre1" href="http://www.eicar.org/download/eicar.com.txt">http://www.eicar.org/download/eicar.com.txt</a>.</p><p class="calibre9">The next screenshot shows the output of ClamAV:</p><div class="mediaobject"><img src="../images/00047.jpeg" alt="Usage and integration with the mail server" class="calibre11"/><div class="caption"><p class="calibre15">The ClamAV output</p></div></div><p class="calibre12"> </p><p class="calibre9">Next, we<a id="id354" class="calibre1"/> need to check the open port for connecting third-party applications. It's enough to execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">netstat -antp | grep clamd</strong></span>
<span class="strong"><strong class="calibre2">tcp           0       0 0.0.0.0:3310        0.0.0.0:*        LISTEN       9917/clamd</strong></span>
<span class="strong"><strong class="calibre2">tcp6          0       0 :::3310             :::0:*           LISTEN       9917/clamd</strong></span>
</pre></div><p class="calibre9">After checking that it works, let's make sure that our mail server scans all messages for viruses. To do <a id="id355" class="calibre1"/>this, perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Run the management console of hMailServer and go to <span class="strong"><strong class="calibre2">Settings</strong></span> | <span class="strong"><strong class="calibre2">Anti-virus</strong></span>. In the right-hand pane, go to the <span class="strong"><strong class="calibre2">General</strong></span> tab to determine what to do with infected messages:<div class="mediaobject"><img src="../images/00048.jpeg" alt="Usage and integration with the mail server" class="calibre11"/><div class="caption"><p class="calibre15">hMailServer settings</p></div></div><p class="calibre26"> </p></li><li class="listitem" value="2">On the <span class="strong"><strong class="calibre2">ClamAV</strong></span> tab, we should set connection options for the ClamAV server:<div class="book"><ul class="itemizedlist1"><li class="listitem">Hostname (<code class="literal">10.0.0.107</code>)</li><li class="listitem">TCP/IP port (<code class="literal">3310</code>)</li></ul></div></li><li class="listitem" value="3">To check the connection, click on the <span class="strong"><strong class="calibre2">Test…</strong></span> button:<div class="mediaobject"><img src="../images/00049.jpeg" alt="Usage and integration with the mail server" class="calibre11"/><div class="caption"><p class="calibre15">hMailServer settings</p></div></div><p class="calibre26"> </p></li></ol><div class="calibre14"/></div><p class="calibre9">Now all the<a id="id356" class="calibre1"/> traffic of the <code class="literal">lab.local</code> e-mail accounts is scanning on the ClamAV server.</p></div></div></div>

<div class="book" title="Host-based security solutions">
<div class="book" title="OSSEC"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec55" class="calibre1"/>OSSEC</h2></div></div></div><p class="calibre9">We have<a id="id357" class="calibre1"/> already set up a network intrusion detection<a id="id358" class="calibre1"/> system and HIPS for Windows hosts. Let's now consider another option for Linux platform hosts.</p><p class="calibre9">OSSEC (<a class="calibre1" href="http://ossec.github.io/">http://ossec.github.io/</a>) is <a id="id359" class="calibre1"/>a host system intrusion detection system (HIDS), and it is free and open source. It conducts analysis of system logs, integrity checking, monitoring the registry of Windows, rootkit detection, and alerting at a particular time and event. It provides the function of intrusion detection for most operating systems, including Linux, BSD-like, Mac OS, Solaris, and Windows. Its cross-platform architecture makes it easy to manage and monitor for multiple operating systems.</p><p class="calibre9">OSSEC consists of a main application (server), agents, and the web management interface.</p><div class="book" title="Installing"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec34" class="calibre1"/>Installing</h3></div></div></div><p class="calibre9">Well, let's<a id="id360" class="calibre1"/> start with OSSEC by installing it in our infrastructure. First of all, we need to satisfy some requirements. OSSEC requires <code class="literal">gcc</code>, <code class="literal">libc</code>, and <code class="literal">apache</code> with <code class="literal">php5</code> support. For this, we should execute the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">apt-get install build-essential</strong></span>
<span class="strong"><strong class="calibre2">apt-get install apache2 apache2-utils libapache2-mod-php5</strong></span>
</pre></div><p class="calibre9">Next, we need to obtain OSSEC. For this purpose, we should execute the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">git clone https://github.com/ossec/ossec-hids</strong></span>
<span class="strong"><strong class="calibre2">git clone https://github.com/ossec/ossec-wui</strong></span>
</pre></div><p class="calibre9">Now that we have installation packages, let's install them using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cd ossec-hids/</strong></span>
<span class="strong"><strong class="calibre2">./install.sh</strong></span>
</pre></div><p class="calibre9">It starts a wizard with a few questions that we should answer. The most important question is about the type of installation. Here, we should create two different types of installation: for agents and for the server.</p><p class="calibre9">Next, let's install the web part of OSSEC. Move the <code class="literal">ossec-wui</code> directory to the folder where it can be accessed by the web server:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mv ossec-wui* /var/www/htdocs/ossec-wui</strong></span>
</pre></div><p class="calibre9">Then, execute the setup script:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cd /var/www/htdocs/ossec-wui</strong></span>
<span class="strong"><strong class="calibre2">./setup.sh</strong></span>
</pre></div><p class="calibre9">The wizard will start, so we should answer questions such as login and password to gain access to the web interface of OSSEC.</p></div><div class="book" title="Configuring"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec35" class="calibre1"/>Configuring</h3></div></div></div><p class="calibre9">OSSEC stores<a id="id361" class="calibre1"/> all the files in <code class="literal">/var/ossec</code>. Let's open the <code class="literal">/var/ossec/ossec.conf</code> file and give it the form we need. Here, we set sending alerts to e-mail by selecting the server address, mailing address, and the maximum possible number of messages per hour.</p><p class="calibre9">Then, there is a block of rules that describes what and how OSSEC will react.</p><p class="calibre9">The <code class="literal">syscheck</code> section sets the integrity check. Its meaning lies in the fact that the system calculates a hash of each file in the specified directory and checks them periodically. Here, we set what we will monitor in a directory and how long it will be checked for. The section describes the command scripts that can be used by the system under certain conditions.</p><p class="calibre9">In the end, we set log files that need to be analyzed and compared with the rules.</p><p class="calibre9">Now, the coarse settings of the OSSEC server are finished and we can run it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">service ossec-hids start</strong></span>
</pre></div><p class="calibre9">If successful, you<a id="id362" class="calibre1"/> will receive an e-mail with a message on startup in the mailing address.</p><p class="calibre9">After this, we need to add the user account of the web server (<code class="literal">www-data</code>) to the OSSEC group. Open the <code class="literal">/etc/group</code> file in editor:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">nano /etc/group</strong></span>
</pre></div><p class="calibre9">Find the line <code class="literal">ossec:x:1002</code> and change it to <code class="literal">ossec:x:1002:www-data</code>.</p><p class="calibre9">After that, we need to set permissions for the <code class="literal">tmp</code> directory of our OSSEC instance and restart Apache service.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">chmod 770 tmp/</strong></span>
<span class="strong"><strong class="calibre2">chgrp www-data tmp/</strong></span>
<span class="strong"><strong class="calibre2">apachectl restart</strong></span>
</pre></div><p class="calibre9">Now we can access the OSSEC web interface using the following link: <code class="literal">http://localhost/ossec-wui/</code>.</p></div><div class="book" title="Connecting OSSEC agents"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec36" class="calibre1"/>Connecting OSSEC agents</h3></div></div></div><p class="calibre9">Let's install <a id="id363" class="calibre1"/>an OSSEC agent from the same distribution. We choose the agent mode in the wizard. For the question "What's the IP Address or hostname of the OSSEC HIDS server?" we input the IP address of our OSSEC server. Now, we need to associate the OSSEC agent with our server. For this, we should go to the server and launch the manager working with the agents:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">/var/ossec/bin/manage_agents</strong></span>
</pre></div><p class="calibre9">In the interactive mode, we need to perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Select <span class="strong"><em class="calibre10">A</em></span> to add an agent (A).</li><li class="listitem" value="2">Write the name of our agent.</li><li class="listitem" value="3">Specify the IP address of our agent.</li><li class="listitem" value="4">Choose an agent ID. We can leave the ID that OSSEC suggests.</li><li class="listitem" value="5">"Confirm adding it? (Y / n)" Answer with <span class="strong"><em class="calibre10">y</em></span>.</li><li class="listitem" value="6">Then, select the <span class="strong"><em class="calibre10">E</em></span> key to extract an agent.</li><li class="listitem" value="7">Specify the ID of our new agent.</li><li class="listitem" value="8">Copy the base64 string and press <span class="strong"><em class="calibre10">Enter</em></span>.</li><li class="listitem" value="9">Select the Q output from the manager to work with agents.</li></ol><div class="calibre14"/></div><p class="calibre9">Restart the server for the successful addition of the agent:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">/etc/init.d/ossec restart</strong></span>
</pre></div><p class="calibre9">Then, let's go to our agent and go in the manager working with the agents:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">/var/ossec/bin/manage_agents</strong></span>
</pre></div><p class="calibre9">In the interactive mode, we need to perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Select the <span class="strong"><em class="calibre10">I</em></span> key to import from the server to add a key that we copied.</li><li class="listitem" value="2">Insert the key, add the agent, and exit.</li></ol><div class="calibre14"/></div><p class="calibre9">Then, we <a id="id364" class="calibre1"/>can run our agent:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">/etc/init.d/ossec start</strong></span>
</pre></div><p class="calibre9">It should come in the mail notification that a new agent is connected. Go to the server to check whether the agent is connected:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">/var/ossec/bin/agent_control -l</strong></span>
</pre></div><p class="calibre9">Here, we will see the list of our agents with the status <code class="literal">Active</code>. Also, <code class="literal">/var/ossec/logs/alerts.alerts.log</code> should have an event like that.</p><p class="calibre9">So the OSSEC agent is connected. Now, we can see our agent in the web interface.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note23" class="calibre1"/>Note</h3><p class="calibre9">If you want to learn more about OSSEC, the official documentation is available at <a class="calibre1" href="http://ossec.github.io/docs/">http://ossec.github.io/docs/</a>.</p></div></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="SIEM" id="164MG1-3ecab517ca6e4afbb3c20ab15f7b4d82"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec33" class="calibre1"/>SIEM</h1></div></div></div><p class="calibre9">
<span class="strong"><strong class="calibre2">SIEM</strong></span> (<span class="strong"><strong class="calibre2">Security information and event management</strong></span>) is the<a id="id365" class="calibre1"/> union of two terms denoting the application areas <span class="strong"><strong class="calibre2">Security Information Management</strong></span> (<span class="strong"><strong class="calibre2">SIM</strong></span>) and <a id="id366" class="calibre1"/><span class="strong"><strong class="calibre2">Security Event Management</strong></span> (<span class="strong"><strong class="calibre2">SEM</strong></span>). The <a id="id367" class="calibre1"/>SIEM technology provides real-time analysis of events (alarms), security emanating from network devices, and applications.</p><p class="calibre9">In our environment, SIEM solutions allows us to track security events and to better correlate the actions of the simulated attacker and security specialist.</p><p class="calibre9">The field of knowledge about SIEM is very broad and requires several books. In this book, we will only touch on this subject and show how to install the popular free solution OSSIM.</p><p class="calibre9">
<span class="strong"><strong class="calibre2">OSSIM</strong></span> (<span class="strong"><strong class="calibre2">Open Source Security Information Management</strong></span>) is a <a id="id368" class="calibre1"/>management, control, and information security system. Out of the box, OSSIM includes the following functionality:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The collection, analysis, and correlation of events—SIEM</li><li class="listitem">The <a id="id369" class="calibre1"/><span class="strong"><strong class="calibre2">host intrusion detection system</strong></span> (<span class="strong"><strong class="calibre2">HIDS</strong></span>)—OSSEC</li><li class="listitem"><span class="strong"><strong class="calibre2">Network intrusion</strong></span><a id="id370" class="calibre1"/><span class="strong"><strong class="calibre2"> detection system</strong></span> (<span class="strong"><strong class="calibre2">NIDS</strong></span>)—Suricata</li><li class="listitem"><span class="strong"><strong class="calibre2">Wireless Intrusion </strong></span><a id="id371" class="calibre1"/><span class="strong"><strong class="calibre2">Detection System</strong></span> (<span class="strong"><strong class="calibre2">WIDS</strong></span>)—Kismet</li><li class="listitem">Monitoring sites networks—Nagios</li><li class="listitem">An analysis of network anomalies—P0f, PADS, FProbe, Arpwatch, and others</li><li class="listitem">Vulnerability scanner—OpenVAS</li><li class="listitem">A powerful system of exchange of information about threats among users OSSIM—OTX</li><li class="listitem">More than 200 plugins for parsing and correlating logs from various external devices and services</li></ul></div><p class="calibre9">OSSIM is <a id="id372" class="calibre1"/>distributed in the form of a distribution image on a CD and at the same time, it only uses the 64-bit version of the software.</p><p class="calibre9">The<a id="id373" class="calibre1"/> distribution ISO image can be downloaded from the official website at <a class="calibre1" href="https://www.alienvault.com/products/ossim">https://www.alienvault.com/products/ossim</a>.</p></div>

<div class="book" title="SIEM" id="164MG1-3ecab517ca6e4afbb3c20ab15f7b4d82">
<div class="book" title="Installing"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec56" class="calibre1"/>Installing</h2></div></div></div><p class="calibre9">An OSSIM system<a id="id374" class="calibre1"/> is installed with the help of the installation image containing a complete Debian system and all the necessary components and modules.</p><p class="calibre9">The system requires a fairly productive machine with multiple processors and at least 3 GB of RAM. After creating the VM and connecting the downloaded ISO image, we can start the VM.</p><p class="calibre9">The installation is not different from installing Debian: just insert the OSSIM disk image into the DVD drive of your virtual machine, boot from it and follow the installation guide. Upon completion of the installation, a console window will appear.</p><p class="calibre9">Let's go to the link printed in the console and enter user credentials. After these steps, installing OSSIM is complete.</p></div></div>

<div class="book" title="SIEM" id="164MG1-3ecab517ca6e4afbb3c20ab15f7b4d82">
<div class="book" title="Configuration wizard"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec57" class="calibre1"/>Configuration wizard</h2></div></div></div><p class="calibre9">So, let's <a id="id375" class="calibre1"/>configure OSSIM. For this purpose, enter the credentials specified in the previous step. Again, we will get the configuration wizard.</p><p class="calibre9">First of all, we need to configure network interfaces with the IP setting of the server where you installed OSSIM.</p><p class="calibre9">On the next tab, OSSIM will automatically scan the network and prompts us to specify the types of the found hosts.</p><p class="calibre9">In the next step, we <a id="id376" class="calibre1"/>can automatically install the host intrusion detection system (OSSIM provides OSSEC). Let's try to install it on Windows hosts. To do this, we have to select the host name and credentials (for example, a domain administrator) and click on <span class="strong"><strong class="calibre2">Deploy</strong></span>.</p><p class="calibre9">After these steps, OSSIM will congratulate us with a message for successfully installing and configuring it.</p></div></div>

<div class="book" title="SIEM" id="164MG1-3ecab517ca6e4afbb3c20ab15f7b4d82">
<div class="book" title="Configuring HIDS"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec58" class="calibre1"/>Configuring HIDS</h2></div></div></div><p class="calibre9">To configure<a id="id377" class="calibre1"/> HIDS, go to <span class="strong"><strong class="calibre2">Environment</strong></span> | <span class="strong"><strong class="calibre2">Detection</strong></span> | <span class="strong"><strong class="calibre2">HIDS</strong></span> | <span class="strong"><strong class="calibre2">Agents</strong></span> and you will see two hosts. The first host is OSSIM itself and the second one is a Windows Server, which we deployed by clicking on <span class="strong"><strong class="calibre2">Deploy HIDS</strong></span> in the <span class="strong"><strong class="calibre2">Setup Wizard</strong></span>. So, go to the menu <span class="strong"><strong class="calibre2">HIDS agents</strong></span>.</p><p class="calibre9">Agent installation on a Windows host is performed automatically and requires no additional input or any information. A setting on a Linux host fully corresponds to the previously described process in the <span class="strong"><em class="calibre10">OSSEC</em></span> section.</p><p class="calibre9">The HIDS installation is finished now, so go to <span class="strong"><strong class="calibre2">Environment</strong></span> | <span class="strong"><strong class="calibre2">Detection</strong></span> and you can see the logs of OSSEC now.</p></div></div>
<div class="book" title="Summary" id="173721-3ecab517ca6e4afbb3c20ab15f7b4d82"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec34" class="calibre1"/>Summary</h1></div></div></div><p class="calibre9">In this chapter, we have shown readers how to protect the lab network from an unauthorized access and external attacks by installing and configuring network- and host-based security solutions. In addition to securing the lab network, we have prepared it to practice such important penetration testing topics as bypassing and evading security mechanisms and assessing their effectiveness.</p><p class="calibre9">The lab environment is ready for practicing now and in the next chapter we would like to give a brief overview of various penetration testing and security assessment frameworks and toolkits along with some examples of their usage in the lab.</p></div></body></html>