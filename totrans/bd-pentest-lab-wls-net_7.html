<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;7.&#xA0;Preparing a Wireless Penetration Testing Platform" id="1CQAE1-3ecab517ca6e4afbb3c20ab15f7b4d82"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07" class="calibre1"/>Chapter 7. Preparing a Wireless Penetration Testing Platform</h1></div></div></div><p class="calibre9">It is always necessary to be well prepared for a penetration test and have all your tools installed and your scripts tested to not lose valuable project time on downloading and making everything work. This is especially true when you don't have Internet access working on-site. In this chapter, we will help you to prepare for a wireless pentest exploring the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Commonly known variants of pentesting platforms</li><li class="listitem">Choosing a suitable Wi-Fi hardware interface</li><li class="listitem">Installing necessary Wi-Fi penetration testing software</li><li class="listitem">Preparing important configuration files and scripts</li><li class="listitem">Creating a bootable pentesting USB stick</li></ul></div></div>

<div class="book" title="Chapter&#xA0;7.&#xA0;Preparing a Wireless Penetration Testing Platform" id="1CQAE1-3ecab517ca6e4afbb3c20ab15f7b4d82">
<div class="book" title="Common variants of the pentesting platform"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch07lvl1sec40" class="calibre1"/>Common variants of the pentesting platform</h1></div></div></div><p class="calibre9">Preparing a <a id="id528" class="calibre1"/>penetration testing platform is not a complicated topic, but it should be properly considered in order to produce good results for your work. Normally, such <a id="id529" class="calibre1"/>a platform is based on a laptop, but not necessarily a specially prepared laptop. We consider three main options to prepare a pentesting platform and you can choose whichever you like:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Installing Linux and all necessary tools (or just a prepared pentesting distribution) as the main or second operating system on a laptop's hard drive</li><li class="listitem">Preparing a virtual machine with all necessary tools installed</li><li class="listitem">Preparing a bootable USB stick with a special penetration testing Linux distribution</li></ul></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note29" class="calibre1"/>Note</h3><p class="calibre9">When we talk about a Wi-Fi penetration testing machine, we always assume Linux OS by default. It does not mean that Windows or Mac OS cannot be used for that purpose. In our opinion, Linux is the most convenient OS for Wi-Fi penetration testing because it allows you to work with hardware interfaces on a low level without a lot of additional, sometimes commercial, software or hardware.</p><p class="calibre9">The process of preparing a Mac OS should be more or less similar to Linux and the only problem for us is Windows. The Wi-Fi penetration testing tools that we saw under Windows are distributed as shareware or work only with special devices that cost a lot, while everything that we use under Linux is free and open source.</p></div><p class="calibre9">Installing <a id="id530" class="calibre1"/>Linux is <a id="id531" class="calibre1"/>a simple topic already described a lot of times, so we will not repeat it here and we will just mention that the processes of installing it on physical and virtual machines are similar. It is mostly dependent on the availability of drivers for your hardware. In this chapter, we will help you to choose the right software and give you some automation hints for your future pentesting platform.</p><p class="calibre9">Using a virtual machine is a convenient option, especially if your main system is Windows and a physical Wi-Fi USB interface used for testing can be forwarded to the VM with the standard VirtualBox's USB forwarding feature. But as our experience shows, it cannot always be reliable and work well. That is why we would recommend using this option only when necessary.</p><p class="calibre9">Using a USB stick with a prepared pentesting distribution is a very good option when you use the system only for tests and do not want to change the main OS of the laptop, or you don't have full control over the laptop (for example, when you use somebody's else laptop).</p><p class="calibre9">In this chapter, we will tell you which software you will most probably need and how to install it. We will prepare some configurations and scripts for your pentesting platform and also show you how to create a bootable Kali Linux 2.0 USB stick. First, let's see how to choose a physical Wi-Fi interface suitable for penetration testing.</p></div></div>
<div class="book" title="Choosing an interface" id="1DOR01-3ecab517ca6e4afbb3c20ab15f7b4d82"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec41" class="calibre1"/>Choosing an interface</h1></div></div></div><p class="calibre9">Before <a id="id532" class="calibre1"/>we start <a id="id533" class="calibre1"/>preparing an instance, we need to care about a hardware Wi-Fi interface as probably the most important part of the pentesting platform. There are three main criteria for hardware Wi-Fi interfaces important for penetration testing and thus influence our choice:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre2">Chipset</strong></span>: The chipset <a id="id534" class="calibre1"/>of a Wi-Fi interface should be able to support packet injection mode, which allows us to interact with an interface on a low level and customize transmitted packets.</li><li class="listitem"><span class="strong"><strong class="calibre2">Power and sensitivity</strong></span>: This <a id="id535" class="calibre1"/>parameter determines the distance between you and your targets—the higher the power and sensitivity, the farther you can stay. But you should take into consideration that higher power consumes more energy and shortens a laptop's battery life.</li><li class="listitem"><span class="strong"><strong class="calibre2">Proportions</strong></span>: This <a id="id536" class="calibre1"/>parameter does not influence the quality of penetration testing, but it influences the ease of your work. The bigger an interface and the more wires you have, the less comfortable it is to use on-site.</li></ul></div><p class="calibre9">Let's review two<a id="id537" class="calibre1"/> typical hardware <a id="id538" class="calibre1"/>interface options:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre2">Built-in laptop interface</strong></span>: In some<a id="id539" class="calibre1"/> cases, you can use a laptop's built-in Wi-Fi interface, especially if you install OS and software on a host, not a VM instance or use a bootable USB stick.<p class="calibre27">The advantage is that it can save you some money on buying an additional interface and makes the whole platform more compact and less suspicious (a laptop with some strange wires and devices or external interfaces always brings more unnecessary questions if somebody operates it in public). Suspiciousness is actually less important for us, because we act as ethical hackers with permission to attack, but the comfort of work is usually very valuable.</p><p class="calibre27">The disadvantage is that such interfaces almost always have poor signal strength and can have a chipset that does not support the necessary mode and features, so they're not applicable for penetration testing.</p></li><li class="listitem"><span class="strong"><strong class="calibre2">External USB interface</strong></span>: Typical<a id="id540" class="calibre1"/> external USB interface form factors are dongles that should be inserted directly into a USB port or a device that should be connected to a USB port with a cable. Often, external USB interfaces also have external removable antennas.<p class="calibre27">The advantage is that this type of interface usually provides better transmitting/receiving capabilities and has higher signal power and sensitivity. In contrast to built-in interfaces, UBS interfaces are easily changeable.</p><p class="calibre27">The disadvantages of external Wi-Fi interfaces are additional cost, higher battery consumption, and reduced work comfort.</p></li></ul></div><p class="calibre9">When you choose <a id="id541" class="calibre1"/>an interface, the most important parameter should be the chipset. If it does not support packet injection mode, you don't need it. The other two criteria we leave to your taste.</p><p class="calibre9">You can easily find lists of chipsets that support packet injection mode on many websites and forums in Internet, but we would recommend you first get familiar with the manuals written by the <a id="id542" class="calibre1"/>Aircrack-ng team at their website:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><a class="calibre1" href="http://www.aircrack-ng.org/doku.php?id=compatible_cards">http://www.aircrack-ng.org/doku.php?id=compatible_cards</a></li><li class="listitem"><a class="calibre1" href="http://www.aircrack-ng.org/doku.php?id=compatibility_drivers">http://www.aircrack-ng.org/doku.php?id=compatibility_drivers</a></li></ul></div><p class="calibre9">In our experience, the most popular suitable chipsets are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Atheros AR9271</li><li class="listitem">Ralink RT3070</li><li class="listitem">Ralink RT3572</li><li class="listitem">Realtek 8187L</li></ul></div><p class="calibre9">If you don't want to spend time on comparing various Wi-Fi interfaces and their parameters, we can recommend our favorites from the company Alpha Network:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Alfa AWUS 036 H on RTL8187 chipset</li><li class="listitem">Alfa AWUS 036 NHR (v.2) on RTL8188RU chipset</li></ul></div><p class="calibre9">TP-Link TP-WN722N is a very good USB dongle interface. You can see all those three interfaces in the following image:</p><div class="mediaobject"><img src="../images/00071.jpeg" alt="Choosing an interface" class="calibre11"/><div class="caption"><p class="calibre15">Our "workhorses" for Wi-Fi pentesting</p></div></div><p class="calibre12"> </p><p class="calibre9">If you already <a id="id543" class="calibre1"/>have a Wi-Fi interface and you are not sure if it supports the packet injection mode, you can test it with the Aircrack-ng suite <a id="id544" class="calibre1"/>using the following manual:</p><p class="calibre9">
<a class="calibre1" href="http://www.aircrack-ng.org/doku.php?id=injection_test">http://www.aircrack-ng.org/doku.php?id=injection_test</a>
</p></div>
<div class="book" title="Installing the necessary software"><div class="book" id="1ENBI2-3ecab517ca6e4afbb3c20ab15f7b4d82"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec42" class="calibre1"/>Installing the necessary software</h1></div></div></div><p class="calibre9">The provided <a id="id545" class="calibre1"/>information should be enough to successfully choose an interface and we can move on to the software part of preparing a Wi-Fi hacking platform.</p><p class="calibre9">Let's assume that you have already installed a Debian-based Linux distribution on a hard drive or on a VM and want to prepare tools for a Wi-Fi penetration test. Here's the list of the necessary tools <a id="id546" class="calibre1"/>which we recommend you install first:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre2">Aircrack-ng suite</strong></span>: This <a id="id547" class="calibre1"/>is a great wireless hacking toolkit, which we have reviewed in <a class="calibre1" title="Chapter 6. Exploring Hacking Toolkits" href="part0042_split_000.html#181NK2-3ecab517ca6e4afbb3c20ab15f7b4d82">Chapter 6</a>, <span class="strong"><em class="calibre10">Exploring Hacking Toolkits</em></span>.</li><li class="listitem"><span class="strong"><strong class="calibre2">Hostapd</strong></span>: This is<a id="id548" class="calibre1"/> the software for installing rogue access points. It works well for WPA-Enterprise attacks when used with FreeRADIUS-WPE.</li><li class="listitem"><span class="strong"><strong class="calibre2">Hostapd-WPE</strong></span>: This<a id="id549" class="calibre1"/> is the software for installing rogue access points and mounting various attack types, including attacks on WLANs protected with WPA-Enterprise.</li><li class="listitem"><span class="strong"><strong class="calibre2">FreeRADIUS-WPE</strong></span>: This is <a id="id550" class="calibre1"/>a modification of the FreeRADIUS software that we have used to secure our WLAN. This modification saves usernames and password hashes in a log file during RADIUS authentication. It is now obsolete, and Hostapd-WPE is recommended instead.</li><li class="listitem"><span class="strong"><strong class="calibre2">Mana</strong></span>: This is the<a id="id551" class="calibre1"/> toolkit for attacking wireless clients (we have also reviewed it in <a class="calibre1" title="Chapter 6. Exploring Hacking Toolkits" href="part0042_split_000.html#181NK2-3ecab517ca6e4afbb3c20ab15f7b4d82">Chapter 6</a>, <span class="strong"><em class="calibre10">Exploring Hacking Toolkits</em></span>).</li><li class="listitem"><span class="strong"><strong class="calibre2">SSLstrip</strong></span>: This is <a id="id552" class="calibre1"/>the utility from the famous guy Moxie Marlinspike for man-in-the-middle attacks on SSL connections.</li><li class="listitem"><span class="strong"><strong class="calibre2">Wireshark or tcpdump</strong></span>: These<a id="id553" class="calibre1"/> are <a id="id554" class="calibre1"/>great tools for network traffic analysis, which is a standard for the majority of pentesters.</li><li class="listitem"><span class="strong"><strong class="calibre2">Reaver</strong></span>: This <a id="id555" class="calibre1"/>is a useful tool for attacking WPS.</li><li class="listitem"><span class="strong"><strong class="calibre2">Nmap</strong></span>: This is <a id="id556" class="calibre1"/>a popular network scanner, another well-known tool valued by thousands pentesters all over the world (you will already be familiar with it from <a class="calibre1" title="Chapter 6. Exploring Hacking Toolkits" href="part0042_split_000.html#181NK2-3ecab517ca6e4afbb3c20ab15f7b4d82">Chapter 6</a>, <span class="strong"><em class="calibre10">Exploring Hacking Toolkits</em></span>).</li><li class="listitem"><span class="strong"><strong class="calibre2">Wifite</strong></span>: This is a <a id="id557" class="calibre1"/>Python script that automates Wi-Fi hacking tasks. It requires Aircrack-ng to be installed.</li><li class="listitem"><span class="strong"><strong class="calibre2">WiFi Honey</strong></span>: This<a id="id558" class="calibre1"/> is a bash script for Wi-Fi hacking automation, and it also requires Airckrack-ng.</li><li class="listitem"><span class="strong"><strong class="calibre2">coWPAtty</strong></span>: This <a id="id559" class="calibre1"/>is a WPA-PSK cracking software that is able to crack with a regular dictionary attack and also using a precomputed PMK file.</li><li class="listitem"><span class="strong"><strong class="calibre2">Dnsmasq</strong></span>: This <a id="id560" class="calibre1"/>is a DNS and DHCP server software that will be useful for rogue APs.</li></ul></div><p class="calibre9">The list can be<a id="id561" class="calibre1"/> extended and you probably will have your own favorite useful tools that were not included (for example, Karmetasploit), but the tools listed here are the essential ones that we use in our regular work. Needless to say that you can always install whichever tools you consider you need or would like to try.</p><p class="calibre9">Most of the software from our list can be installed using <code class="literal">apt-get</code> with the following command combination:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo apt-get update &amp;&amp; sudo apt-get install -y aircrack-ng wifite reaver sslstrip wifite nmap dnsmasq</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note30" class="calibre1"/>Note</h3><p class="calibre9">The parameter <code class="literal">-y</code> makes <code class="literal">apt-get</code> assume that you answer <code class="literal">yes</code> to all installation prompts so it does not bother you several times.</p></div><p class="calibre9">But you need to <a id="id562" class="calibre1"/>download and install the other tools manually. In the following table, you can find the links to the official sources of the other software distributions:</p><div class="informalexample"><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22">Tools</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Sources</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">FreeRADIUS-WPE</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<a class="ulink" href="https://github.com/brad-anton/freeradius-wpe">https://github.com/brad-anton/freeradius-wpe</a>
</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">Hostapd-WPE</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<a class="ulink" href="https://github.com/OpenSecurityResearch/hostapd-wpe">https://github.com/OpenSecurityResearch/hostapd-wpe</a>
</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">Mana Toolkit</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<a class="ulink" href="https://github.com/sensepost/mana">https://github.com/sensepost/mana</a>
</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">WiFi Honey</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<a class="ulink" href="https://digi.ninja/projects/wifi_honey.php">https://digi.ninja/projects/wifi_honey.php</a>
</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">coWPAtty</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<a class="ulink" href="http://www.willhackforsushi.com/?page_id=50">http://www.willhackforsushi.com/?page_id=50</a>
</p>
</td></tr></tbody></table></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note31" class="calibre1"/>Note</h3><p class="calibre9">You can find additional information on installing and using a lot of wireless penetration testing tools in the book <span class="strong"><em class="calibre10">Kali Linux: Wireless Penetration Testing Beginner's Guide</em></span>, <span class="strong"><em class="calibre10">Vivek Ramachandran and Cameron Buchanan</em></span>, <span class="strong"><em class="calibre10">Packt Publishing</em></span> (<a class="calibre1" href="http://www.amazon.com/Kali-Linux-Wireless-Penetration-Beginners/dp/1783280417">http://www.amazon.com/Kali-Linux-Wireless-Penetration-Beginners/dp/1783280417</a>).</p></div><p class="calibre9">Let's start with installing<a id="id563" class="calibre1"/> FreeRADIUS-WPE. Although it is already obsolete, we have used it a lot and still appreciate it, thus we want to show you how to install and configure it in case you want to try it.</p><p class="calibre9">Since we use a Debian-based Linux distribution, you can download the latest available <code class="literal">.deb</code> file <code class="literal">freeradius-server-wpe_2.1.12-1_i386.deb</code> (<a class="calibre1" href="https://github.com/brad-anton/freeradius-wpe/raw/master/freeradius-server-wpe_2.1.12-1_i386.deb">https://github.com/brad-anton/freeradius-wpe/raw/master/freeradius-server-wpe_2.1.12-1_i386.deb</a>) and install it using the DPKG packet manager:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo dpkg --install freeradius-server-wpe_2.1.12-1_i386.deb &amp;&amp; sudo ldconfig</strong></span>
</pre></div><p class="calibre9">FreeRADIUS-WPE is <a id="id564" class="calibre1"/>now installed and you can check it by typing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">radius -v</strong></span>
</pre></div><p class="calibre9">To run FreeRADIUS-WPE server, enter the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">radiusd -x</strong></span>
</pre></div><p class="calibre9">But before you run it, you need to prepare certificates and change configuration files according to your target WLAN parameters. We will discuss it in the next topic. Now, let's proceed with installing Hostapd-WPE.</p><p class="calibre9">Installing <a id="id565" class="calibre1"/>Hostapd-WPE <a id="id566" class="calibre1"/>actually means patching Hostapd 2.2 with a special patch that adds attack functionality to it. So, we first need to install Hostapd itself. It can be installed from a repository with <code class="literal">apt-get</code>, but the current available version is v.2.1 whereas we need v.2.2. So we need to download v.2.2 directly from the website and install it manually, but it requires some prerequisites to be installed:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo apt-get update &amp;&amp; sudo apt-get install -y git libssl-dev libnl-dev</strong></span>
</pre></div><p class="calibre9">Then, download and unpack the necessary files:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">git clone https://github.com/OpenSecurityResearch/hostapd-wpe</strong></span>
<span class="strong"><strong class="calibre2">wget http://hostap.epitest.fi/releases/hostapd-2.2.tar.gz</strong></span>
<span class="strong"><strong class="calibre2">tar -zxf hostapd-2.2.tar.gz</strong></span>
</pre></div><p class="calibre9">Now, go into the new directory and patch Hostapd:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cd hostapd-2.2</strong></span>
<span class="strong"><strong class="calibre2">patch -p1 &lt; ../hostapd-wpe/hostapd-wpe.patch</strong></span>
</pre></div><p class="calibre9">Next, go into the <code class="literal">hostapd</code> directory and use the <code class="literal">make</code> command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cd hostapd</strong></span>
<span class="strong"><strong class="calibre2">make</strong></span>
</pre></div><p class="calibre9">The software is now installed. To start it, run the following command from the directory <code class="literal">hostapd-2.2/hostapd</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo ./hostapd-wpe %config_file_name%</strong></span>
</pre></div><p class="calibre9">You can find the results of authentication attempts in the <code class="literal">hostapd-wpe.log</code> file in the same directory.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note32" class="calibre1"/>Note</h3><p class="calibre9">When you work with Wi-Fi interfaces in Debian-based Linux, you will experience trouble because of interference with the networking service. To avoid this, edit its configuration file, <code class="literal">/etc/NetworkManager/NetworkManager.conf</code>, and append the following lines:</p><div class="informalexample"><pre class="programlisting">[keyfile]
unmanaged-devices=mac:xx:xx:xx:xx:xx:xx</pre></div><p class="calibre9">Here, <code class="literal">xx:xx:xx:xx:xx:xx</code> is the hardware address of your Wi-Fi interface (you can find it, for example, in the output of the command <code class="literal">ifconfig -a</code>).</p><p class="calibre9">After that, you need to restart the networking service:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo /etc/init.d/networking restart</strong></span>
</pre></div><p class="calibre9">This will exclude your Wi-Fi interface from the devices managed by the networking service and will get rid of interference.</p><p class="calibre9">Additionally, we recommend checking interference with other services and software using the <code class="literal">airmon-ng</code> feature <code class="literal">check</code>. If you add <code class="literal">kill</code> to the command, it will also kill all possibly interfering processes:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo airmon-ng check kill</strong></span>
</pre></div></div><p class="calibre9">Now, it is <a id="id567" class="calibre1"/>Mana's turn. Start with downloading the Mana archive from GitHub and unpack it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">unzip mana-master.zip</strong></span>
</pre></div><p class="calibre9">Then, go into the Mana directory and edit the installation script for Ubuntu:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cd mana-master/</strong></span>
<span class="strong"><strong class="calibre2">nano ubuntu-install.sh</strong></span>
</pre></div><p class="calibre9">You need to find the following line:</p><div class="informalexample"><pre class="programlisting">echo "deb http://http.kali.org/kali kali main non-free contrib" &gt; /etc/apt/sources.list.d/mana-kali.list</pre></div><p class="calibre9">Replace it with the following line:</p><div class="informalexample"><pre class="programlisting">echo "deb http://http.kali.org/kali sana main non-free contrib" &gt; /etc/apt/sources.list.d/mana-kali.list</pre></div><p class="calibre9">Now, you can update packages info and run the installation script:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo apt-get update &amp;&amp; sudo ./ubuntu-install.sh</strong></span>
</pre></div><p class="calibre9">It will show you a warning that the installer assumes you use Ubuntu 14.04.</p><p class="calibre9">This script will automatically install all necessary dependencies and you just need to answer <code class="literal">yes</code> during the installation and it will do everything. Now, the Mana Toolkit is installed.</p><p class="calibre9">WiFi Honey does not need an installation. But it requires the prerequisite software Screen and Aircrack-ng to be installed. We have already installed Aircrack-ng and you can install Screen with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo apt-get install screen</strong></span>
</pre></div><p class="calibre9">Next, just download the archive, put it into the directory you prefer, and unpack:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">tar jxf wifi_honey_1.0.tar.bz2</strong></span>
</pre></div><p class="calibre9">And make it executable with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">chmod +x wifi_honey.sh</strong></span>
</pre></div><p class="calibre9">WiFi Honey is ready to use.</p><p class="calibre9">The last software in our list is coWPAtty. First, we need to install OpenSSL and libpcap, which are required by coWPAtty:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo apt-get install openssl libpcap0.8-dev</strong></span>
</pre></div><p class="calibre9">Then, you can download the latest version archive from the official website to a folder you prefer and unpack it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">tar zxvf cowpatty-4.6.tgz</strong></span>
</pre></div><p class="calibre9">Then, go into the directory and compile coWPAtty:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cd cowpatty-4.6/</strong></span>
<span class="strong"><strong class="calibre2">make</strong></span>
</pre></div><p class="calibre9">It should compile coWPAtty in the same directory where you can start it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">./cowpatty</strong></span>
</pre></div><p class="calibre9">Finally, we have <a id="id568" class="calibre1"/>finished with the software installation and can go to the next step.</p></div>

<div id="page" style="height:0pt"/><div class="book" title="Preparing configs and scripts"><div class="book" id="1FLS42-3ecab517ca6e4afbb3c20ab15f7b4d82"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec43" class="calibre1"/>Preparing configs and scripts</h1></div></div></div><p class="calibre9">We have<a id="id569" class="calibre1"/> installed the necessary <a id="id570" class="calibre1"/>tools in our Wi-Fi pentesting system, but it is just a part of the preparation work. In order to be able to use some of them, we need to prepare some configuration files and develop a script to automate some tasks.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note35" class="calibre1"/>Note</h3><p class="calibre9">You might need to tweak some of the configs and scripts given in this chapter in order to make them work with your hardware and software setup.</p></div><p class="calibre9">We would like to <a id="id571" class="calibre1"/>start with Hostapd. We mostly use it in two situations: when we need to install a fake AP to attack clients' traffic and to set an AP with FreeRADIUS-WPE when we attack WPA-Enterprise protected networks.</p></div>

<div class="book" title="Preparing configs and scripts">
<div class="book" title="Standalone Hostapd-based APs"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec67" class="calibre1"/>Standalone Hostapd-based APs</h2></div></div></div><p class="calibre9">To install a <a id="id572" class="calibre1"/>rogue AP for client traffic or <a id="id573" class="calibre1"/>phishing attacks you can use Hostapd in a standalone mode without connecting it to a RADIUS server. Mostly, we need it open, but sometimes there are situations when we need it to be WPA/WPA2 protected, for example, when you need to imitate a certain WPA/WPA2-protected AP. Thus, we should prepare two configuration file templates for both situations:</p><p class="calibre9">The following is the content of <code class="literal">open.conf</code> for an open AP:</p><div class="informalexample"><pre class="programlisting">interface=wlan0
driver=nl80211
ssid=Free Wi-Fi
channel=8</pre></div><p class="calibre9">The following is the content of <code class="literal">wpa.conf</code> for a WPA2-protected AP:</p><div class="informalexample"><pre class="programlisting">interface=wlan0
driver=nl80211
ssid=YourSSID
channel=8
wpa_passphrase=your_passphrase
wpa=2
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP CCMP</pre></div><p class="calibre9">Before you use those templates, you need to modify some values for a certain situation:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Driver value should be changed to the one corresponding to your Wi-Fi interface (in terms of Hostapd, you can get it from the sample configuration file, distributed with Hostapd)</li><li class="listitem">Interface value should be changed to the name of your Wi-Fi interface if it is not connected as <code class="literal">wlan0</code></li><li class="listitem">We need the <code class="literal">ssid</code> value to change the WLAN's name</li><li class="listitem">The channel can have any value between 1 and 11</li><li class="listitem">We need the WPA passphrase if you are setting up a WPA-protected AP</li></ul></div><p class="calibre9">You can then start an AP with Hostapd and one of the previously mentioned configs, for example, <code class="literal">open.conf</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">sudo hostapd open.conf</strong></span>
</pre></div><p class="calibre9">In your Linux terminal, you should see the following:</p><div class="mediaobject"><img src="../images/00072.jpeg" alt="Standalone Hostapd-based APs" class="calibre11"/><div class="caption"><p class="calibre15">Starting an open AP</p></div></div><p class="calibre12"> </p><p class="calibre9">At the <a id="id574" class="calibre1"/>same<a id="id575" class="calibre1"/> time, you can see your open WLAN in the list of available networks on another device:</p><div class="mediaobject"><img src="../images/00073.jpeg" alt="Standalone Hostapd-based APs" class="calibre11"/><div class="caption"><p class="calibre15">Our open AP is listed among available WLANs</p></div></div><p class="calibre12"> </p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip22" class="calibre1"/>Tip</h3><p class="calibre9">If you have any trouble with an AP on Hostapd, the option <code class="literal">-d</code> can be very helpful. It makes Hostapd display debug information in the terminal. The option <code class="literal">-f</code> will forward debug output into a file instead of standard output. You might want to also use <code class="literal">-t</code> and <code class="literal">-K</code> options to include some additional information in debug output.</p></div><p class="calibre9">Let's go <a id="id576" class="calibre1"/>further and prepare a configuration <a id="id577" class="calibre1"/>for a DHCP server in order to use it to make your rogue APs more attractive and real. We use the Dnsmasq software to set up a DHCP server and it needs a configuration file, <code class="literal">/etc/dnsmasq.conf</code>:</p><div class="informalexample"><pre class="programlisting">interface=wlan0
dhcp-range=192.168.0.2,192.168.0.255,12h
dhcp-option=3,192.168.0.1
dhcp-option=6,192.168.0.1
log-facility=/var/log/dnsmasq.log
log-queries</pre></div><p class="calibre9">You need to change the interface parameter value if your Wi-Fi interface is not <code class="literal">wlan0</code>. With the DHCP options 3 and 6, we set the IP addresses of a router and a DNS server to be distributed in DHCP responses. With the last two lines, we configure log output to be able to debug our setup in case of problems.</p></div></div>

<div class="book" title="Preparing configs and scripts">
<div class="book" title="Automating the AP setup"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec68" class="calibre1"/>Automating the AP setup</h2></div></div></div><p class="calibre9">Usually, during a <a id="id578" class="calibre1"/>penetration test you do not want to spend time on changing configuration files and you could forget to change some parameters. Therefore, it is wise to automate the process. We have prepared a bash script, <code class="literal">hostapd_auto.sh</code>, for you, which automatically creates a temporary configuration file containing necessary parameters and then starts Hostapd with this configuration:</p><div class="informalexample"><pre class="programlisting">#!/bin/bash
#show usage tips if no argument supplied
if [[ $# &lt; 1 ]]
then
    echo -e "Usage: ./hostap_standalone.sh options"
    echo -e "\t-i|--interface - wlan interface to use (default wlan0)"
    echo -e "\t-s|--ssid - ssid to set (default \"Free WiFi\""
    echo -e "\t-d|--driver - driver, corresponding to hostapd (default nl80211)"
    echo -e "\t--security - security type: open, wpa, wpa2 (default \"open\")"
    exit
fi
#Let's save all command line arguments into variables
while [[ $# &gt; 1 ]]
do
key="$1"

case $key in
    -i|--interface)
    WIFIINTERFACE="$2"
    shift # pass next argument
    ;;
    -s|--ssid)
    SSID="$2"
    shift # pass next argument
    ;;
    -d|--driver)
    DRIVER="$2"
    shift # pass next argument
    ;;
    --security)
    SECURITY="$2"
    shift # pass next argument
    ;;
    *)
            # unknown option
    ;;
esac
shift # pass next argument
done
#Check if parameters were set
if [ -z "$WIFIINTERFACE" ]
then
    echo "WIFI interface not set ( -i | --interface ), using default wlan0"
    WIFIINTERFACE="wlan0"
fi
if [ -z "$SSID" ]
then
    echo -e "SSID not set ( -s | --ssid ), using default \"Free WiFi\""
    SSID="Free WiFi"
fi
if [ -z "$DRIVER" ]
then
    echo "Driver not set ( -d | --driver ), using default nl80211"
    DRIVER="nl80211"
fi
if [ ! -z "$SECURITY" ]
then
    case $SECURITY in
    wpa|WPA)
    wpa="wpa=1"
    echo "Enter WPA passphrase:"
    read PASS
    ;;
    wpa2|WPA2)
    wpa="wpa=2"
    echo "Enter WPA passphrase:"
    read PASS
    ;;
    open|Open|OPEN)

    ;;
    *)
    echo "Unknown security type, setting an open AP"
    SECURITY="open"
    ;;
     esac
else
    echo "Security not set ( --security ), setting an open AP"
     SECURITY="open"
fi
#Creating a temporary configuration file
echo "interface=$WIFIINTERFACE" &gt;&gt; temp.conf
echo "driver=$DRIVER" &gt;&gt; temp.conf
echo "channel=8" &gt;&gt; temp.conf
echo "ssid=$SSID" &gt;&gt; temp.conf
if [ "$SECURITY" != "open" ]
then
    echo $wpa &gt;&gt; temp.conf
    echo "wpa_passphrase=$PASS" &gt;&gt; temp.conf
    echo "wpa_key_mgmt=WPA-PSK" &gt;&gt; temp.conf
    echo "wpa_pairwise=TKIP CCMP" &gt;&gt; temp.conf
fi
#Preparing the host for network traffic processing
#Stopping the networking service to exclude conflicts
/etc/init.d/networking stop
#set the IP parameters for wireless interface
ifconfig $WIFIINTERFACE 192.168.0.1 netmask 255.255.255.0
route add -net 192.168.0.0 netmask 255.255.255.0 gw 192.168.0.1
#start dhcp and dns server
service dnsmasq start
#Prepare network traffic processing rules
iptables -F
iptables -t nat -F
iptables -A FORWARD -i eth0 -d 192.168.0.0/255.255.255.0 -j ACCEPT
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
#You can uncomment the following line to redirect client ssl traffic to TCP port 10000
#iptables -t nat -A PREROUTING -p tcp --destination-port 443 -j REDIRECT --to-port 10000
#enable network traffic forwarding
echo 1 &gt; /proc/sys/net/ipv4/ip_forward
#Starting AP
echo "Starting an AP with the following parameters:"
echo "SSID: $SSID"
echo "SECURITY: $SECURITY"
echo "Interface: $WIFIINTERFACE"
echo "Driver: $DRIVER"
hostapd temp.conf
wait
#Removing the temporary configuration file
rm temp.conf
#Stopping dnsmasq
service dnsmasq stop
#Starting networking service
/etc/init.d/networking start</pre></div><p class="calibre9">You just need <a id="id579" class="calibre1"/>to make the script executable (<code class="literal">chmod +x hostapd_auto.sh</code>) and start it without parameters to see the possible options. It will automatically delete the temporary configuration file when you stop Hostapd. Don't forget to use <code class="literal">sudo</code> when you start the script, because it will need to change system parameters requiring root privileges.</p></div></div>

<div class="book" title="Preparing configs and scripts">
<div class="book" title="Configuration for WPE-Enterprise"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec69" class="calibre1"/>Configuration for WPE-Enterprise</h2></div></div></div><p class="calibre9">Now, let's <a id="id580" class="calibre1"/>talk about a scenario with a WPE-Enterprise-protected WLAN. For that scenario, we need to use either Hostapd and FreeRADIUS-WPE, or Hostapd-WPE. In the first case, you'll need to configure a RADIUS server and create an additional configuration file for Hostapd.</p><p class="calibre9">But first, it does not matter what you use, you need to configure RADIUS certificate parameters and create certificates before you start attacking WPA-Enterprise-protected WLANs in both cases with FreeRADIUS-WPE and also with Hostapd-WPE. This can be done by changing the parameters in the <code class="literal">[certificate_authority]</code> section of the <code class="literal">ca.cnf</code> file and the <code class="literal">[server]</code> section of the <code class="literal">server.cnf</code> file. Depending on your tasks, you will probably want to also change the values in the <code class="literal">[client]</code> section of the <code class="literal">client.cnf</code> file.</p><p class="calibre9">Setting the parameters to the values corresponding to the same parameter values of your target WLAN will make attacks less visible and less suspicious. Just execute the bootstrap script from the same directory to generate certificates after changing all necessary parameter values:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">./bootstrap</strong></span>
</pre></div><p class="calibre9">The configuration <a id="id581" class="calibre1"/>process of FreeRADIUS-WPE is similar to the configuration process of FreeRADIUS described in <a class="calibre1" title="Chapter 5. Implementing Security" href="part0038_split_000.html#147LC2-3ecab517ca6e4afbb3c20ab15f7b4d82">Chapter 5</a>, <span class="strong"><em class="calibre10">Implementing Security</em></span>. Thus, we will not describe it in this chapter, but we will show you a configuration file, <code class="literal">wpa-e.conf</code>, that allows Hostapd to work together with FreeRADIUS-WPE:</p><div class="informalexample"><pre class="programlisting">interface=wlan0
driver=nl80211
ssid=YourSSID
ieee8021x=1
eapol_key_index_workaround=0
own_ip_addr=192.168.0.1
auth_server_addr=127.0.0.1
auth_server_port=1812
auth_server_shared_secret=YourRADIUSsecret
wpa=1
wpa_key_mgmt=WPA-EAP
channel=1
wpa_pairwise=TKIP CCMP
logger_stdout=-1
logger_stdout_level=0
dump_file=hostapd.dump</pre></div><p class="calibre9">In this example, you will need to change the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Change the <code class="literal">interface</code> and <code class="literal">driver</code> parameters and set values according to your hardware Wi-Fi interface.</li><li class="listitem">Change the <code class="literal">ssid</code> parameter. It should be identical to the SSID of your target WLAN.</li><li class="listitem">Change <code class="literal">auth_server_shared_secret</code> that is the secret (passphrase) for connecting Hostapd to the RADIUS server.</li></ul></div><p class="calibre9">The last three lines configure logging; you can comment them and use them when you need to debug your configuration.</p><p class="calibre9">Now, you can start FreeRADIUS-WPE first and then Hostapd to have a WPA-Enterprise-protected AP. But you can also do it with just Hostapd-WPE using a configuration file with the following content:</p><div class="informalexample"><pre class="programlisting">interface=wlan0
ssid=PACKT

eap_user_file=hostapd-wpe.eap_user
ca_cert=../../hostapd-wpe/certs/ca.pem
server_cert=../../hostapd-wpe/certs/server.pem
private_key=../../hostapd-wpe/certs/server.pem
private_key_passwd=whatever
dh_file=../../hostapd-wpe/certs/dh

hw_mode=g
channel=1

eap_server=1
eap_fast_a_id=101112131415161718191a1b1c1d1e1f
eap_fast_a_id_info=hostapd-wpe
eap_fast_prov=3
ieee8021x=1
pac_key_lifetime=604800
pac_key_refresh_time=86400
pac_opaque_encr_key=000102030405060708090a0b0c0d0e0f
wpa=1
wpa_key_mgmt=WPA-EAP
wpa_pairwise=TKIP CCMP</pre></div><p class="calibre9">But like <a id="id582" class="calibre1"/>Hostapd, Hostapd-WPE is distributed along with a sample configuration file called <code class="literal">hostapd-wpe.conf</code>, which contains information about all possible parameters as well as their default values. You can just change the <code class="literal">interface</code> and <code class="literal">ssid</code> parameters in this file and use it. Anyway, we recommend you look through it to understand how to create your own configuration files or modify existing ones.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip23" class="calibre1"/>Tip</h3><p class="calibre9">As an exercise, you can modify the automation script from the previous subtopic to make it also work with the WPA-Enterprise configuration.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Preparing a Kali USB stick"><div class="book" id="1GKCM2-3ecab517ca6e4afbb3c20ab15f7b4d82"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec44" class="calibre1"/>Preparing a Kali USB stick</h1></div></div></div><p class="calibre9">All that's <a id="id583" class="calibre1"/>written in<a id="id584" class="calibre1"/> the preceding sections is interesting for people who want to have a "clean" penetration testing platform with only the tools they have chosen and installed. But in the most cases, it is not necessary and we would say is often not worth the time you can spend on it. The convenient solution in this case is using a prepared penetration testing distribution. We have already mentioned it in the beginning of the chapter when we talked about a VM, but let's review the process of creating a <a id="id585" class="calibre1"/><span class="strong"><strong class="calibre2">bootable penetration testing USB stick</strong></span>.</p><p class="calibre9">In our example, we <a id="id586" class="calibre1"/>will show you how to create a bootable USB stick with the Kali 2.0 penetration testing distribution on both Windows and Linux systems. If you want to do it quickly and you don't want additional complexity on your USB stick, we would recommend creating it under Windows. But if you want to create a <a id="id587" class="calibre1"/><span class="strong"><strong class="calibre2">persistent encrypted USB stick</strong></span>, you will need to use Linux and do everything manually. We recommend this because the software that we use for image recording under Windows creates only one partition on a USB drive, and you'll need to have three partitions in the case of a bootable USB with encrypted persistent storage.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note36" class="calibre1"/>Note</h3><p class="calibre9">You will need to have a USB drive with at least an 8 GB capacity for an encrypted persistent storage.</p></div></div>

<div class="book" title="Preparing a Kali USB stick">
<div class="book" title="Creating a USB stick under Windows"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec70" class="calibre1"/>Creating a USB stick under Windows</h2></div></div></div><p class="calibre9">Let's start with <a id="id588" class="calibre1"/>the simplest option and create a non-persistent USB stick under Windows.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip24" class="calibre1"/>Tip</h3><p class="calibre9">If you want to have a persistent USB stick, you can directly proceed to the next subtopic and see how to create it under Linux.</p></div><p class="calibre9">We are going to use the <a id="id589" class="calibre1"/><span class="strong"><strong class="calibre2">Universal USB Installer</strong></span> (<span class="strong"><strong class="calibre2">UUI</strong></span>) software (<a class="calibre1" href="http://www.pendrivelinux.com/universal-usb-installer-easy-as-1-2-3/">http://www.pendrivelinux.com/universal-usb-installer-easy-as-1-2-3/</a>) for image recording. We assume you have already downloaded the latest version of the Kali Linux 2.0 image from the official website and started UUI. The process is very simple:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Choose the desired Linux distribution from the drop-down menu, as it is shown in the following screenshot:<div class="mediaobject"><img src="../images/00074.jpeg" alt="Creating a USB stick under Windows" class="calibre11"/><div class="caption"><p class="calibre15">Creating a bootable Kali USB stick</p></div></div><p class="calibre26"> </p></li><li class="listitem" value="2">Choose <a id="id590" class="calibre1"/>the OS image file you want to record.</li><li class="listitem" value="3">Choose the target USB disk from the drop-down menu. If it does not show your USB drive in the drop-down menu, set the <span class="strong"><strong class="calibre2">Show all drives</strong></span> checkbox and it will show all system-available drives.</li><li class="listitem" value="4">Select the option to format the USB drive before recording and click on <span class="strong"><strong class="calibre2">Create</strong></span>. Your settings should look like this:<div class="mediaobject"><img src="../images/00075.jpeg" alt="Creating a USB stick under Windows" class="calibre11"/><div class="caption"><p class="calibre15">Final UUI settings for Kali USB stick image recording</p></div></div><p class="calibre26"> </p></li><li class="listitem" value="5">The software will show you the summary of what it is going to do and will ask you again if you agree with it.</li><li class="listitem" value="6">Agree and <a id="id591" class="calibre1"/>wait until the recording process is finished.</li><li class="listitem" value="7">Enjoy your bootable Kali Linux 2.0 USB stick.</li></ol><div class="calibre14"/></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note37" class="calibre1"/>Note</h3><p class="calibre9">Alternatively, you can use <a id="id592" class="calibre1"/>Win32 Disk Imager to write bootable images to a USB stick or a disk. You can download the software from <a class="calibre1" href="https://sourceforge.net/projects/win32diskimager/">https://sourceforge.net/projects/win32diskimager/</a>.</p></div></div></div>

<div class="book" title="Preparing a Kali USB stick">
<div class="book" title="Creating a USB stick under Linux"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec71" class="calibre1"/>Creating a USB stick under Linux</h2></div></div></div><p class="calibre9">If you <a id="id593" class="calibre1"/>decide that you want to have an encrypted persistent USB stick or you just use Linux and not Windows normally, we will show you how to create a Kali USB stick under this system. You can also use a Linux VM with a USB forwarding feature on Windows if you don't have Linux installed as a host system.</p><p class="calibre9">We have downloaded a Kali image file called <code class="literal">kali-linux-2.0-amd64.iso</code> and if yours has the same name, you can leave it like that in the following guide. But if it has a different name, make sure to replace it in the commands you enter. The steps are as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Insert a USB drive or attach it to a VM. Find out the device name of the USB stick with <code class="literal">fdisk -l</code> (use <code class="literal">sudo</code> if necessary). In our case, it is <code class="literal">/dev/sdb</code>.</li><li class="listitem" value="2">Use the cloning <code class="literal">dd</code> command in Linux to copy the image to the USB drive:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">dd if=kali-linux-2.0-amd64.iso of=/dev/sdb bs=512k</strong></span>
</pre></div></li><li class="listitem" value="3">Wait until the image is fully copied to the USB drive. Depending on your software and hardware setup, it can take some time. In our case (using a VirtualBox VM with only USB 1.0 support), it took almost 20 minutes.</li><li class="listitem" value="4">When the process is finished, you will see a summary of how many bytes were copied and how much time it took. The image recording is finished at this point.</li><li class="listitem" value="5">You can run <code class="literal">fdisk -l </code>again to check the partitions on the USB drive. There should be two partitions:<div class="mediaobject"><img src="../images/00076.jpeg" alt="Creating a USB stick under Linux" class="calibre11"/><div class="caption"><p class="calibre15">Information about partitions on a bootable Kali USB stick</p></div></div><p class="calibre26"> </p></li></ol><div class="calibre14"/></div><p class="calibre9">Now, you can boot from your newly created Kali Linux 2.0 USB stick using any laptop; this is especially convenient if you travel a lot.</p></div></div>

<div class="book" title="Preparing a Kali USB stick">
<div class="book" title="Making an encrypted persistent partition"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec72" class="calibre1"/>Making an encrypted persistent partition</h2></div></div></div><p class="calibre9">Having a <a id="id594" class="calibre1"/>bootable Kali USB stick is convenient, but it has a big disadvantage: you cannot save anything in the system to keep after a reboot. Even system settings will be reset to default every time you reboot. It is especially awkward when you need to save project data in order to process it later on another computer, for example, crack hashes at a special powerful cracking server. In this subtopic, we are going to fix this issue and make our USB drive able to store our data. The manual is based on an official manual from the Kali Linux team, but we think some additional comments will help you.</p><p class="calibre9">Keeping in <a id="id595" class="calibre1"/>mind the fact that ethical hackers almost always work with sensitive customer data that has to be treated carefully, and USB drive is a small thing that is easy to lose, we will also secure it with encryption against unauthorized reading using Cryptsetup software. The idea is not to encrypt the whole USB stick, but to create an additional partition on it where you will keep your data <span class="strong"><strong class="calibre2">persistent</strong></span> and <span class="strong"><strong class="calibre2">encrypted</strong></span>.</p><p class="calibre9">If you have used a USB drive larger than 4 GB, there should be some unallocated space left after recording the Kali image on it. We will use this space for our persistent partition. The steps are as follows (we will continue doing it on a Kali Linux VM):</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Insert the USB drive and check the partitions with <code class="literal">fdisk -l</code>.</li><li class="listitem" value="2">Get the space occupied by Kali image in bytes (it is 3,167 in our case):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">du -bcm kali-linux-2.0-amd64.iso</strong></span>
</pre></div></li><li class="listitem" value="3">Create the third partition on the USB drive starting right after Kali image (use your Kali image size value):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">parted /dev/sdb mkpart primary 3167 7gb</strong></span>
</pre></div><p class="calibre27">Say <span class="strong"><strong class="calibre2">Yes</strong></span> if parted offers you another allocation and ignore the following warning. The process should look like the following screenshot:</p><div class="mediaobject"><img src="../images/00077.jpeg" alt="Making an encrypted persistent partition" class="calibre11"/><div class="caption"><p class="calibre15">The partition creation process</p></div></div><p class="calibre26"> </p></li><li class="listitem" value="4">Check the partitions again with <code class="literal">fdisk -l</code> and you should see the new one (<code class="literal">/dev/sdb3</code> in our case).</li><li class="listitem" value="5">Prepare a strong password and then continue encrypting the new partition with the <code class="literal">cryptsetup</code> software. The following prompt can be seen on the screen, and install it if you don't have it yet (<code class="literal">sudo apt-get install cryptsetup-bin</code>):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cryptsetup --verbose --verify-passphrase luksFormat /dev/sdb3</strong></span>
</pre></div></li><li class="listitem" value="6">Open <a id="id596" class="calibre1"/>the new partition with the mapping name <code class="literal">kali_stor</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cryptsetup luksOpen /dev/sdb3 kali_stor</strong></span>
</pre></div></li><li class="listitem" value="7">Then, build a filesystem labeled <code class="literal">persistence</code> on the new partition. The filesystem type should be <code class="literal">ext3</code> (this process can also take several minutes):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mkfs.ext3 -L persistence /dev/mapper/kali_stor &amp;&amp; e2label /dev/mapper/kali_stor persistence</strong></span>
</pre></div></li><li class="listitem" value="8">Then, you need to mount the new filesystem. However, to be able to do it, first you need to create a mount point in <code class="literal">/mnt/</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mkdir -p /mnt/kali_stor &amp;&amp; mount /dev/mapper/kali_stor /mnt/kali_stor</strong></span>
</pre></div></li><li class="listitem" value="9">Now, create a <code class="literal">persistence.conf</code> file in <code class="literal">/mnt/kali_stor</code> with the content <code class="literal">/ union</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">echo "/ union" &gt; /mnt/kali_stor/persistence.conf</strong></span>
</pre></div></li><li class="listitem" value="10">Finally, you can unmount the storage and encrypt it (close):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">umount /dev/mapper/kali_stor &amp;&amp; cryptsetup luksClose /dev/mapper/kali_stor</strong></span>
</pre></div></li><li class="listitem" value="11">Let's check the persistent storage. Unplug the USB drive from the Linux machine and boot from it. When you boot, choose the <span class="strong"><strong class="calibre2">Live USB Encrypted Persistence</strong></span> boot option and enter your encryption passphrase when prompted:<div class="mediaobject"><img src="../images/00078.jpeg" alt="Making an encrypted persistent partition" class="calibre11"/><div class="caption"><p class="calibre15">Kali Linux 2.0 USB stick boot menu</p></div></div><p class="calibre26"> </p></li><li class="listitem" value="12">When Kali <a id="id597" class="calibre1"/>starts, create a file on the desktop with random content and reboot. The file should still be there after reboot, which means persistence works well.</li></ol><div class="calibre14"/></div></div></div>
<div class="book" title="Summary" id="1HIT81-3ecab517ca6e4afbb3c20ab15f7b4d82"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec45" class="calibre1"/>Summary</h1></div></div></div><p class="calibre9">In this chapter, we saw how to prepare a "battle" laptop for wireless penetration testing, listed the criteria for choosing a Wi-Fi interface, reviewed the list of the necessary software, and developed the useful scripts and configuration files to speed up the active phase of penetration tests. Now, you can load your device and start pentesting. Before you start with a project, we strongly recommend you learn how to use the tools and practice using them in your lab—that is what it's for!</p><p class="calibre9">At this point, you are almost ready to start learning penetration testing and practicing it in your lab, but one thing is still missing. We are going to cover it in the final chapter: suggested next steps for your further penetration testing skills development.</p></div></body></html>