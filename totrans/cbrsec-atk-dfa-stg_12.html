<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Threat Intelligence</h1>
                </header>
            
            <article>
                
<p>By now, you've been through different phases in your journey to a better defense model. In the last chapter, you learned about the importance of a good detection system, and now it's time to move to the next level. The use of threat intelligence to better know the adversary, and gain insights about the current threats, is a valuable tool for the Blue Team. Although threat intelligence is a relatively new domain, the use of intelligence to learn how the enemy is operating is an old concept. Bringing intelligence to the field of cybersecurity was a natural transition, mainly because now the threat landscape is so broad and the adversaries vary widely, from state-sponsored actors to cybercriminals extorting money from their victims.</p>
<p>In this chapter, we are going to cover the following topics:</p>
<ul>
<li>Introduction to threat intelligence</li>
<li>Open source tools for threat intelligence</li>
<li>Microsoft threat intelligence</li>
<li>Leveraging threat intelligence to investigate suspicious activity</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introduction to threat intelligence</h1>
                </header>
            
            <article>
                
<p>It was clear in the last chapter that having a strong detection system is imperative for your organization's security posture. However, this system can be improved if the number of false positives and noise can be reduced. One of the main challenges that you face when you have many alerts and logs to review is that you end up randomly prioritizing, and in some cases even ignoring, future alerts because you believe it is not worth reviewing them. According to Microsoft's <em>Lean on the Machine</em> report, an average large organization has to look through 17,000 malware alerts each week, taking on average 99 days for an organization to discover a security breach.</p>
<p>Alert triage usually happens at the <strong>network operations center</strong> (<span><strong>NOC</strong></span>) level, and delays to triage can lead to a domino effect, because if triage fails at this level, the operation will also fail, and in this case, the operation will be handled by the incident response team.</p>
<p>Let's step back and think about threat intelligence outside of cyberspace.</p>
<p>How do you believe the Department of Homeland Security improves the United States, threats to border security?</p>
<p>They have the <strong>Office of Intelligence and Analysis</strong> (<strong>I&amp;A</strong>), which uses intelligence to enhance border security. This is done by driving information sharing across different agencies and providing predictive intelligence to decision makers at all levels. Now, use the same rationale toward cyber threat intelligence, and you will understand how effective and important this is. This insight shows that you can improve your detection by learning more about your adversaries, their motivations, and the techniques that they are using. Using this threat intelligence towards the data that you collect can bring more meaningful results and reveal actions that are not detectable by traditional sensors.</p>
<p>It is important to mention that the attacker's profile will be directly related to their motivation. Here are some examples of an attacker's profile/motivation:</p>
<ul>
<li><strong>Cybercriminal</strong>: The main motivation is to obtain financial results</li>
<li><strong>Hacktivist</strong>: This group has a broader scope of motivation—it can range from an expression of political preference to just an expression for a particular cause</li>
<li><strong>Cyber espionage/state sponsored</strong>: Although you can have cyber espionage without it being state sponsored (usually in the private sector), a growing number of cyber espionage cases are happening because they are part of bigger state-sponsored campaigns</li>
</ul>
<p>The question now is: Which attack profile is most likely to target your organization? It depends. If your organization is sponsoring a particular political party, and this political party is doing something that a hacktivist group is totally against, you might be a target. If you identify yourself as the target, the next question is: What assets do I have that are most likely desired by this group? Again, it depends. If you are a financial group, cybercriminals will be your main threat, and they usually want credit card information, financial data, and so on.</p>
<p>Another advantage of using threat intelligence as part of your defense system is the ability to scope data based on the adversary. For example, if you are responsible for the defense of a financial institution, you want to obtain threat intel from adversaries that are actively attacking this industry. It really doesn't help much if you start receiving alerts related to attacks that are happening in education institutions. Knowing the type of assets that you are trying to protect can also help to narrow down the threat actors that you should be more concerned about, and threat intelligence can give you that information.</p>
<p>Let's use the WannaCry ransomware as an example. The outbreak happened on Friday, May 12, 2017. At the time, the only <strong>i</strong><span><strong>ndicator of compromise</strong> (</span><strong>IoCs</strong>) available were the hashes and filenames of the ransomware sample. However, even before WannaCry existed, the EternalBlue exploit was already available, and as you know, WannaCry used the EternalBlue exploit. EternalBlue exploited Microsoft's implementation of the <strong>Server Message Block</strong> (<strong>SMB</strong>) protocol v1 (CVE-2017-0143). Microsoft released the patch for this vulnerability in March 14, 2017 (almost two months prior to the WannaCry outbreak). Are you following? Well, let's contextualize in the following diagram:</p>
<div class="packt_figure">
<div class="CDPAlignCenter CDPAlign"><img height="474" width="864" src="assets/be9c7d1c-2b12-409c-a77b-46b7621fec0f.png"/></div>
</div>
<p>Note that threat intelligence is receiving relevant information about this threat in the early stages, even when the EternalBlue exploit (originally discovered by the NSA) was leaked online (April 2017) by a hacker group calling itself <strong>The Shadow Brokers</strong> (<strong>TSB</strong>). The group was not a newbie, which means there was intel related to the work they had done in the past and their previous motivations. Take all this into consideration to predict what your adversary's next movement is going to be. By having this information, and knowing how EternalBlue works, now it is just a matter of waiting for the vendor (Microsoft, in this case) to send out a patch, which happened in March 2017. At this point, the Blue Team has enough information to determine the criticality of this patch to the business that they are trying to protect.</p>
<p>Many organizations didn't fully realize the impact of this issue, and instead of patching, they just disabled SMB access from the internet. While this was an acceptable workaround, it didn't fix the root cause of the issue. As a result, in June 2017 another ransomware outbreak happened—this time it was Petya. This ransomware used EternalBlue for lateral movement. In other words, once it compromised one machine inside the internal network (see, your firewall rule doesn't matter anymore), it was going to exploit other systems that were not patched with MS17-010. As you can see, there is a level of predictability here, since part of the Petya operation was implemented successfully after using an exploit similar to the one used by previous ransomware.</p>
<p>The conclusion to all this is simple: by knowing your adversaries, you can make better decisions to protect your assets. Having said that, it is also fair to say that you can't think of threat intelligence as an IT security tool—it goes beyond that. You have to think of threat intelligence as a tool to help make decisions regarding the organization's defense, help managers to decide how they should invest in security, and help CISOs to rationalize the situation with top executives. The information that you obtain from threat intelligence can be used in different areas, such as:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="300" width="837" src="assets/4148ddaf-022b-4042-857b-9ee18187153d.png"/></div>
<p>In summary, the correct use of threat intelligence is going to have a direct impact on the entire organization.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Open source tools for threat intelligence</h1>
                </header>
            
            <article>
                
<p>As mentioned earlier, DHS partners with the intelligence community to enhance its own intelligence, and this is pretty much standard in this field. Collaboration and information sharing are the foundations of the intelligence community. There are many open source threat intelligence tools out there that can be used. Some are commercial tools (paid) and some are free. You can start consuming threat intelligence by consuming TI feeds. OPSWAT Metadefender Cloud TI feeds have a variety of options that range from free to paid versions, and they can be delivered in four different formats: JSON, CSV, RSS, and Bro.</p>
<div class="packt_infobox">For more information about Metadefender Cloud TI feeds, visit: <a href="https://www.metadefender.com/threat-intelligence-feeds"><span class="URLPACKT">https://www.metadefender.com/threat-intelligence-feeds</span></a>.</div>
<p>Another option for a quick verification is the website <a href="https://fraudguard.io"><span class="URLPACKT">https://fraudguard.io</span></a>. You can perform a quick IP validation to obtain threat intel from that location. In the example that follows, the IP 220.227.71.226 was used as a test, (the test result is relative to the day that it was done, which was 10/27/2017), and the result shows the following fields:</p>
<pre>{ 
    "isocode": "IN", 
    "country": "India", 
    "state": "Maharashtra", 
    "city": "Mumbai", 
    "discover_date": "2017-10-27 09:32:45", 
    "threat": "honeypot_tracker", 
    "risk_level": "5" 
} </pre>
<p>The complete screenshot of the query is shown here:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="302" width="744" src="assets/1131afeb-3383-4afb-9072-299ea0787661.png"/></div>
<p>While this is just a simple example, there are more capabilities available that will depend on the level of the service that you are using. It also varies across the free and the paid versions. You also can integrate threat intelligence feeds into your Linux system by using the Critical Stack Intel Feed (<a href="https://intel.criticalstack.com/"><span class="URLPACKT">https://intel.criticalstack.com/</span></a>), which integrates with The Bro Network Security Monitor (<a href="https://www.bro.org/"><span class="URLPACKT">https://www.bro.org/</span></a>). Palo Alto Networks also has a free solution called MineMeld (<a href="https://live.paloaltonetworks.com/t5/MineMeld/ct-p/MineMeld"><span class="URLPACKT">https://live.paloaltonetworks.com/t5/MineMeld/ct-p/MineMeld</span></a>) that can be used to retrieve threat intelligence.</p>
<div class="packt_infobox">Visit this GitHub location for a list of free tools, including free threat intel: <a href="https://github.com/hslatman/awesome-threat-intelligence"><span class="URLPACKT">https://github.com/hslatman/awesome-threat-intelligence</span></a>.</div>
<p>In scenarios where the incident response team is unsure about whether a specific file is malicious or not, you can also submit it for analysis at <a href="https://malwr.com"><span class="URLPACKT">https://malwr.com</span></a>. They provide a decent amount of detail about IoC and samples that can be used to detect new threats.</p>
<p>As you can see, there are many free resources, but there are also open source initiatives that are paid, such as AlienVault USM Anywhere (<a href="https://www.alienvault.com/products/usm-anywhere"><span class="URLPACKT">https://www.alienvault.com/products/usm-anywhere</span></a>). To be fair, this solution is way more than just a source of threat intelligence. It can perform vulnerability assessment, inspect the network traffic, and look for known threats, policy violations, and suspicious activities.</p>
<p>On the initial configuration of AlienVault USM Anywhere, you can configure the <strong>threat intelligence exchange</strong> (<strong>OTX</strong>). Note that you need an account for this, as well as a valid key, as shown here:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="439" width="699" src="assets/3f625da2-ea5e-49a9-8ed0-81e4a5615ae9.png"/></div>
<p>After you finish configuring, USM will continuously monitor your environment, and when something happens, it will trigger an alarm. You can see the alarm status, and most importantly, which strategy and method were used by this attack, as shown here:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/6365b696-4509-4185-b8f6-0834bbd87d6c.png"/></div>
<p>You can dig into the alert and look for more details about the issue; that's when you will see more details about the threat intelligence that was used to raise this alarm. The image that follows has an example of this alarm; however, for privacy, the IP addresses are hidden:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="538" width="434" src="assets/0365faf4-8c91-4370-9403-a79cc406866b.png"/></div>
<p>From this list, you have some very important information—the source of the attack, the destination of the attack, the malware family, and a description, which gives you a lot of details about the attack. If you need to pass this information over to the incident response team to take action, you can also click on the <span class="packt_screen">Recommendations</span> tab to see what should be done next. While this is a generic recommendation, you can always use it to improve your own response.</p>
<p>At any moment, you can also access OTX Pulse from <a href="https://otx.alienvault.com/pulse"><span class="URLPACKT">https://otx.alienvault.com/pulse</span></a>, and there you have TI information from the latest threats, as shown in the following example:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="466" width="787" src="assets/c5fd72fc-f9e1-4546-a1e1-37489c54fd42.png"/></div>
<p>This dashboard gives you a good amount of threat intel information, and while the preceding example shows entries from AlienVault, the community also contributes. At the time of writing, we had the BadRabbit outbreak, and I tried to use the search capability on this dashboard to look for more information about BadRabbit, and I got a lot of hits.</p>
<p>Here is one example of some important data that can be useful to enhance your defense system:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="351" width="888" src="assets/2983780d-8adc-4072-811b-fc37df62c0ba.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Microsoft threat intelligence</h1>
                </header>
            
            <article>
                
<p>For organizations that are using Microsoft products, whether on-premises or in the cloud, they threat intelligence as part of the product itself. That's because nowadays many Microsoft products and services take advantage of shared threat intelligence, and with this, they can offer context, relevance, and priority management to help people take action. Microsoft consumes threat intelligence through different channels, such as:</p>
<ul>
<li>The Microsoft Threat Intelligence Center, which aggregates data from:
<ul>
<li>Honeypots, malicious IP addresses, botnets, and malware detonation feeds</li>
<li>Third-party sources (threat intelligence feeds)</li>
<li>Human-based observation and intelligence collection</li>
</ul>
</li>
<li>Intelligence coming from consumption of their service</li>
<li>Intelligence feeds generated by Microsoft and third parties</li>
</ul>
<p><span>Microsoft integrates the result of this threat intelligence into its products, such as Windows Defender Advanced Threat Protection, Azure Security Center, Office 365 Threat Intelligence, Cloud App Security, and others.</span></p>
<div class="packt_infobox">Visit <a href="https://aka.ms/MSTI"><span class="URLPACKT">https://aka.ms/MSTI</span></a> for more information about how Microsoft uses threat intelligence to protect, detect, and respond to threat.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Azure Security Center</h1>
                </header>
            
            <article>
                
<p>In the last chapter, we used Security Center to identify suspicious activities based on behavior analytics. While that was a great capability for cloud-based VMs and on-premises servers, you can also leverage threat intelligence to better understand whether your environment was, or still is, compromised. In the Security Center dashboard, there is an option in the left-hand navigation menu called <span class="packt_screen">Threat intelligence</span>. When you click on it, you have to select the workspace that contains your data, and after making this selection you will be able to see the TI dashboard.</p>
<p>For the purpose of this example, the TI dashboard that you see is a demo environment that is fully compromised, and that's the reason why there are so many alerts:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="534" width="874" src="assets/88eec5a1-9c11-4cc8-a139-fa0a1a8f70df.png"/></div>
<p>In this dashboard, you have a summary of the types of threats. In this case, all of them are botnets. You also have the origin country (where the threat is coming from), and a map that shows the geolocation of the threats. The cool thing about this dashboard is that you can keep digging into the data—in other words, if you click on one of the countries, it will open a search result showing all systems that were compromised for this threat coming from this country. In this case, the image that follows is the result of a search for all compromised systems. Where the attacker is coming from Ukraine, the raw search is:</p>
<pre>let schemaColumns = datatable(RemoteIPCountry:string)[];          <br/>union isfuzzy= true schemaColumns, W3CIISLog, DnsEvents, WireData, <br/>WindowsFirewall, CommonSecurityLog          | where <br/>isnotempty(MaliciousIP) and (isnotempty(MaliciousIPCountry) or <br/>isnotempty(RemoteIPCountry))| extend Country = <br/>iff(isnotempty(MaliciousIPCountry), MaliciousIPCountry, <br/>iff(isnotempty(RemoteIPCountry), RemoteIPCountry, ''))                      <br/>| where Country == "Ukraine" </pre>
<p>The result is as follows:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/b1e762ca-3837-4e8c-8c61-52e17942a758.png"/></div>
<p>The initial data that you receive has some interesting information, including the local IP address of the system that was compromised, the protocol that was used, the direction, and the malicious IP. However, the best part appears when you click <span class="packt_screen">show more</span>.</p>
<p>There, you will see which file was compromised and which application was used:</p>
<pre>...IndicatorThreatType:Botnet  
...Confidence:75  
...FirstReportedDateTime:2017-10-27T11:40:44.0000000Z  
...LastReportedDateTime:2017-10-27T16:27:01.2410977Z  
...IsActive:true  
...RemoteIPLongitude:27.82  
...RemoteIPLatitude:48.44  
...SessionStartTime:10/27/2017 12:29:30.000 PM  
...SessionEndTime:10/27/2017 12:29:45.000 PM  
...LocalSubnet:10.0.0.0/24  
...LocalPortNumber:3389  
...RemotePortNumber:0  
...SentBytes:1591  
...TotalBytes:2755  
...ApplicationProtocol:RDP  
...ProcessID:3052  
...ProcessName:C:WindowsSystem32svchost.exe  </pre>
<p>In this case, the <kbd>svchost.exe</kbd> process seems to be the process that was compromised by the attacker. What you need to do at this point is go to the target system and start an investigation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Leveraging threat intelligence to investigate suspicious activity</h1>
                </header>
            
            <article>
                
<p>At this point, there is no more doubt that the use of threat intelligence to help your detection system is imperative. Now, how do you take advantage of this information when responding to a security incident? While the Blue Team works primarily on the defense system, they do collaborate with the incident response team by providing the right data that can lead them to find the root cause of the issue. If we use the previous example from Security Center, we could just hand it that search result and it would be good enough. But knowing the system that was compromised is not the only goal of an incident response.</p>
<p>At the end of the investigation, you must answer at least the following questions:</p>
<ul>
<li style="list-style-type: none">
<ul>
<li>Which systems were compromised?</li>
<li>Where did the attack start?</li>
<li>Which user account was used to start the attack?</li>
<li>Did it move laterally?
<ul>
<li>If it did, what were the systems involved in this movement?</li>
</ul>
</li>
<li>Did it escalate privilege?
<ul>
<li>If it did, which privilege account was compromised?</li>
</ul>
</li>
<li>Did it try to communicate with command and control?</li>
<li>If it did, was it successful?
<ul>
<li>If it was, did it download anything from there?</li>
<li>If it was, did it send anything to there?</li>
</ul>
</li>
<li>Did it try to clear evidence?
<ul>
<li>If it did, was it successful?</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>These are some keys questions that you must answer at the end of the investigation, and this can help you to truly bring a close to the case, and be confident that the threat was completely contained and removed from the environment.</p>
<p>You can use the Security Center investigation feature to answer most of these questions. This feature enables investigators to see the attack path, the user accounts involved, the systems that were compromised, and the malicious activities that were done. In the previous chapter, you learned about the Security Incident feature in Security Center, which aggregates alerts that are part of the same attack campaign. From that interface, you can click <span class="packt_screen">Start Investigation</span> to access the Investigation dashboard, as shown here:</p>
<div style="font-size: 1em" class="packt_figure CDPAlignCenter CDPAlign"><img height="459" width="557" src="assets/44f40f14-8abc-4a3b-b36d-58648589981a.png"/></div>
<p><span>The investigation map contains all entities (alerts, computers, and users) that are correlated with this incident. When you first open the dashboard, the focus of the map is the security incident itself; however, you can click on any entity and the map will expand with the information that is correlated with the object that you just selected. The second part of the dashboard has more details about the selected entity, which include:</span></p>
<ul>
<li>Detection timeline</li>
<li>Compromised host</li>
<li>Detailed description of the event</li>
<li>Remediation steps</li>
<li>Incident stage</li>
</ul>
<p>In the following example, the security incident was selected on the investigation map, and this is the information available for this entity:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="515" width="416" src="assets/30e19eed-258a-449d-8908-4c93fdd04b76.png"/></div>
<p>The content of this pane will vary according to the entity selection on the left (the investigation map). Note that for the incident itself, there are some options that are grayed out, which means that these options are not available for this particular entity, which is expected.</p>
<div class="packt_infobox">Watch one of the authors of this book, Yuri Diogenes, demonstrating how this feature works at Ignite 2017 in Orlando at <a href="https://blogs.technet.microsoft.com/yuridiogenes/2017/09/30/ignite-2017-azure-security-center-domination/"><span class="URLPACKT">https://blogs.technet.microsoft.com/yuridiogenes/2017/09/30/ignite-2017-azure-security-center-domination/</span></a>.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">References</h1>
                </header>
            
            <article>
                
<ol>
<li><em>Microsoft Lean on the Machine Report</em> <a href="http://download.microsoft.com/download/3/4/0/3409C40C-2E1C-4A55-BD5B-51F5E1164E20/Microsoft_Lean_on_the_Machine_EN_US.pdf">http://download.microsoft.com/download/3/4/0/3409C40C-2E1C-4A55-BD5B-51F5E1164E20/Microsoft_Lean_on_the_Machine_EN_US.pdf</a></li>
<li><em>Wanna Decryptor (WNCRY) Ransomware Explained</em> <a href="https://blog.rapid7.com/2017/05/12/wanna-decryptor-wncry-ransomware-explained/">https://blog.rapid7.com/2017/05/12/wanna-decryptor-wncry-ransomware-explained/</a></li>
<li><em>A Technical Analysis of WannaCry Ransomware</em> <a href="https://logrhythm.com/blog/a-technical-analysis-of-wannacry-ransomware/">https://logrhythm.com/blog/a-technical-analysis-of-wannacry-ransomware/</a><a href="http://openioc.org/resources/An_Introduction_to_OpenIOC.pdf"/></li>
<li><em>New ransomware, old techniques: Petya adds worm capabilities</em> <a href="https://blogs.technet.microsoft.com/mmpc/2017/06/27/new-ransomware-old-techniques-petya-adds-worm-capabilities/">https://blogs.technet.microsoft.com/mmpc/2017/06/27/new-ransomware-old-techniques-petya-adds-worm-capabilities/</a><a href="https://www.fireeye.com/content/dam/fireeye-www/services/freeware/sdl-ioc-editor.zip"/></li>
<li><em>DUQU Uses STUXNET-Like Techniques to Conduct Information Theft</em> <a href="https://www.trendmicro.com/vinfo/us/threat-encyclopedia/web-attack/90/duqu-uses-stuxnetlike-techniques-to-conduct-information-theft">https://www.trendmicro.com/vinfo/us/threat-encyclopedia/web-attack/90/duqu-uses-stuxnetlike-techniques-to-conduct-information-theft</a></li>
<li><em>Open Source Threat Intelligence</em> <a href="https://www.sans.org/summit-archives/file/summit-archive-1493741141.pdf">https://www.sans.org/summit-archives/file/summit-archive-1493741141.pdf</a> <a href="https://www.sans.org/summit-archives/file/summit-archive-1493741141.pdf"/></li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, you learned about the importance of threat intelligence and how it can be used to gain more information about current threat actors and their techniques, and, in some circumstances, predict their next step. You learned how to leverage threat intelligence from the open source community, based on some free tools, as well as commercial tools. Next, you learned how Microsoft integrates threat intelligence as part of its products and services, and how to use Security Center not only to consume threat intelligence, but also to visualize potentially compromised features of your environment based on the threat intel acquired, compared to your own data. Lastly, you learned about the investigation feature in Security Center and how this feature can be used by the incident response team to find the root cause of a security issue.</p>
<p>In the next chapter, we will continue talking about defense strategies, but this time we will focus on response, which is a continuation of what we started in this chapter. You will learn more about the investigation, both on-premises and in the cloud.</p>


            </article>

            
        </section>
    </body></html>