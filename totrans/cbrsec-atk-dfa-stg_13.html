<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Investigating an Incident</h1>
                </header>
            
            <article>
                
<p>In the previous chapter, you learned about the importance of using threat intelligence to help the Blue Team enhance the organization's defense and also to know their adversaries better. In this chapter, you will learn how to put all these tools together to perform an investigation. Beyond the tools, you will also learn how to approach an incident, ask the right questions, and narrow down the scope. To illustrate that, there will be two scenarios, where one is in an on-premises organization and the other one is in a hybrid environment. Each scenario will have its unique characteristics and challenges.</p>
<p>In this chapter, we are going over the following topics:</p>
<ul>
<li>Scoping the issue</li>
<li>On-premises compromised system</li>
<li>Cloud-based compromised system</li>
<li>Conclusion and lessons learned</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Scoping the issue</h1>
                </header>
            
            <article>
                
<p>Let's face it, not every incident is a security-related incident and, for this reason, it is vital to scope the issue prior to start an investigation. Sometimes, the symptoms may lead you to initially think that you are dealing with a security-related problem, but as you ask more questions and collect more data, you may realize that the problem was not really related to security.</p>
<p>For this reason, the initial triage of the case has an important role on how the investigation will succeed. If you have no real evidence that you are dealing with a security issue other than the end user opening an incident saying that his computer is running slow and he <em>thinks</em> it is compromised, than you should start with basic performance troubleshooting, rather than dispatching a security responder to initiate an investigation. For this reason, IT, operations, and security must be fully aligned to avoid false positive dispatches, which results in utilizing a security resource to perform a support-based task.</p>
<p>During this initial triage, it is also important to determine the frequency of the issue. If the issue is not currently happening, you may need to configure the environment to collect data when the user is able to reproduce the problem. Make sure to document all the steps and provide an accurate action plan for the end user. The success of this investigation will depend on the quality of the data that was collected.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Key artifacts</h1>
                </header>
            
            <article>
                
<p>Nowadays, there is so much data available that data collection should focus on obtaining just the vital and relevant artifacts from the target system. More data doesn't necessarily mean better investigation, mainly because you still need to perform data correlation in some cases and too much data can deviate you from the root cause of the problem.</p>
<p>When dealing with an investigation for a global organization that has devices spread out across different regions of the planet, it is important to make sure you know the time zone of the system that you are investigating. In a Windows system, this information is located in the registry key at <kbd>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\TimeZoneInformation</kbd>. You could use the PowerShell command <kbd>Get-ItemProperty</kbd> to retrieve this information from the system, as follows:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/b6326cc4-338a-42d1-af3e-c3b1ebf859a8.png"/></div>
<p>Notice the value <kbd>TimeZoneKeyName</kbd>, which is set to <kbd>Central Standard Time</kbd>. This data will be relevant when you start analyzing the logs and performing data correlation. Another important registry key to obtain network information is <kbd>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Signatures\Unmanaged and Managed</kbd>. These keys will show the networks that this computer has been connected to. Here is a result of the <kbd>unmanaged</kbd> key:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="133" width="448" src="assets/f77a4a23-29b6-40fb-857a-29183534922e.png"/></div>
<p>These two artifacts are important for determining the location (time zone) of the machine and the networks that this machine visited. This is even more important for devices that are used by employees to work outside the office, such as laptops and tablets. Depending on the issue that you are investigating, it is also important to verify the USB usage on this machine. To do that, export the registry keys <kbd>HKLM\SYSTEM\CurrentControlSet\Enum\USBSTOR</kbd> and <kbd>HKLM\SYSTEM\CurrentControlSet\Enum\USB</kbd>. An example of what this key looks like is shown in the following image:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="208" width="451" src="assets/749478c1-0306-42e7-8a07-06f8a5697754.png"/></div>
<p>To determine if there is any malicious software configured to start when Windows starts, review the registry key, <kbd>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</kbd>. Usually, when the malicious program appears in there, it will also create a service; therefore, it is also important to review the registry key, <kbd>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services</kbd>. Look for random name services and entries that are not part of the computer's profile pattern. Another way to obtain these services is to run the <kbd>msinfo32</kbd> utility:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/a3a4e818-709b-4cb5-bffb-76708c4efebf.png"/></div>
<p>In addition to that, make sure to also capture all security events and, when analyzing them focus on the following ones:</p>
<table class="MsoTableGrid">
<tbody>
<tr>
<td>
<p><strong>Event ID</strong></p>
</td>
<td>
<p><strong>Description</strong></p>
</td>
<td>
<p><strong>Security scenario</strong></p>
</td>
</tr>
<tr>
<td>
<p>1102</p>
</td>
<td>
<p>The audit log was cleared</p>
</td>
<td>
<p>As attackers infiltrate your environment, they might want to clear their evidence and cleaning the event log is an indication of that. Make sure to review who cleaned the log, if this operation was intentional and authorized, or if it was unintentional or unknown (due to a compromised account).</p>
</td>
</tr>
<tr>
<td>
<p>4624</p>
</td>
<td>
<p>An account was successfully logged on</p>
</td>
<td>
<p>It is very common to log only the failures, but in many cases knowing who successfully logged in is important for understanding who performed which action.</p>
</td>
</tr>
<tr>
<td>
<p>4625</p>
</td>
<td>
<p>An account failed to log on</p>
</td>
<td>
<p>Multiple attempts to access an account can be a sign of a brute force account attack. Reviewing this log can give you some indications of that.</p>
</td>
</tr>
<tr>
<td>
<p>4657</p>
</td>
<td>
<p>A registry value was modified</p>
</td>
<td>
<p>Not everyone should be able to change the registry key and, even when you have high privileges to perform this operation, is still an operation that needs further investigation to understand the veracity of this change.</p>
</td>
</tr>
<tr>
<td>
<p>4663</p>
</td>
<td>
<p>An attempt was made to access an object</p>
</td>
<td>
<p>While this event might generate a lot of false positives, it is still relevant to collect and look at it on demand. In other words, if you have other evidences that point to unauthorized access to the filesystem, you may use this log to drill down who performed this change.</p>
</td>
</tr>
<tr>
<td>
<p>4688</p>
</td>
<td>
<p>A new process has been created</p>
</td>
<td>
<p>When Petya ransomware outbreak happened, one of the indicators of compromise was the <kbd>cmd.exe /c schtasks /RU "SYSTEM" /Create /SC once /TN "" /TR "C:Windowssystem32shutdown.exe /r /f" /ST &lt;time&gt;</kbd>. When the <kbd>cmd.exe</kbd> command was executed, a new process was created and an event 4688 was also created. Obtaining the details about this event is extremely important when investigating a security-related issue.</p>
</td>
</tr>
<tr>
<td>
<p>4700</p>
</td>
<td>
<p>A scheduled task was enabled</p>
</td>
<td>
<p>The use of scheduled tasks to perform an action has been used over the years by attackers. Using the same example as shown above (Petya), the event 4700 can give you more details about a scheduled task.</p>
</td>
</tr>
<tr>
<td>
<p>4702</p>
</td>
<td>
<p>A scheduled task was updated</p>
</td>
<td>
<p>If you see 4700 from a user who doesn't usually perform this type of operation and you keep seeing 4702 to update this task, you should investigate further. Keep in mind that it could be a false positive, but it all depends on who made this change and the user's profile of doing this type of operation.</p>
</td>
</tr>
<tr>
<td>
<p>4719</p>
</td>
<td>
<p>System audit policy was changed</p>
</td>
<td>
<p>Just like the first event of this list, in some scenarios, attackers that already compromised an administrative level account may need to perform changes in the system policy to continue their infiltration and lateral movement. Make sure to review this event and follow up on the veracity of the changes that were done.</p>
</td>
</tr>
<tr>
<td>
<p>4720</p>
</td>
<td>
<p>A user account was created</p>
</td>
<td>
<p>In an organization, only certain users should have the privilege to create an account. If you see an ordinary user creating an account, the chances are that his credential was compromised and the attacker already escalated privilege to perform this operation.</p>
</td>
</tr>
<tr>
<td>
<p>4722</p>
</td>
<td>
<p>A user account was enabled</p>
</td>
<td>
<p>As part of the attack campaign, an attacker may need to enable an account that was previously disabled. Make sure to review the legitimacy of this operation in case you see this event.</p>
</td>
</tr>
<tr>
<td>
<p>4724</p>
</td>
<td>
<p>An attempt was made to reset an accounts password</p>
</td>
<td>
<p>Another common action during the system's infiltration, and lateral movement. If you find this event, make sure to review the legitimacy of this operation.</p>
</td>
</tr>
<tr>
<td>
<p>4727</p>
</td>
<td>
<p>A security-enabled global group was created</p>
</td>
<td>
<p>Again, only certain users should have the privilege to create a security-enabled group. If you see an ordinary user creating a new group, the chances are that his credential was compromised, and the attacker already escalated privilege to perform this operation. If you find this event, make sure to review the legitimacy of this operation.</p>
</td>
</tr>
<tr>
<td>
<p>4732</p>
</td>
<td>
<p>A member was added to a security-enabled local group</p>
</td>
<td>
<p>There are many ways to escalate privilege and, sometimes, one shortcut is to add itself as member of a higher privileged group. Attackers may use this technique to gain privilege access to resources. If you find this event, make sure to review the legitimacy of this operation.</p>
</td>
</tr>
<tr>
<td>
<p>4739</p>
</td>
<td>
<p>Domain policy was changed</p>
</td>
<td>
<p>In many cases, the main objective of an attacker's mission is domain dominance and this event could reveal that. If an unauthorized user is making domain policy changes, it means the level of compromise arrived in the domain level hierarchy. If you find this event, make sure to review the legitimacy of this operation.</p>
</td>
</tr>
<tr>
<td>
<p>4740</p>
</td>
<td>
<p>A user account was locked out</p>
</td>
<td>
<p>When multiple attempts to log on are performed, one will hit the account lockout threshold, and the account will be locked out. This could be a legitimate log on attempt or it could be an indication of a brute force attack. Make sure to take these facts into consideration when reviewing this event.</p>
</td>
</tr>
<tr>
<td>
<p>4825</p>
</td>
<td>
<p>A user was denied the access to remote desktop. By default, users are allowed to connect only if they are members of the remote desktop users group or administrators group</p>
</td>
<td>
<p>This is a very important event, mainly if you have computers with RDP port open to the internet, such as VMs located in the cloud. This could be legitimate, but it could also indicate an unauthorized attempt to gain access to a computer via RDP connection.</p>
</td>
</tr>
<tr>
<td>
<p>4946</p>
</td>
<td>
<p>A change has been made to Windows Firewall exception list. A rule was added.</p>
</td>
<td>
<p>When a machine is compromised, and a piece of malware is dropped in the system, it is common that, upon execution, this malware tries to establish access to command and control. Some attackers will try to change the Windows Firewall exception list to allow this communication to take place.</p>
</td>
</tr>
<tr>
<td>
<p>4948</p>
</td>
<td>
<p>A change has been made to Windows Firewall exception list. A rule was deleted.</p>
</td>
<td>
<p>This is a similar scenario to the one described above; the difference is that, in this case, the attacker decided to delete a rule, instead of creating a new one. This also could be an attempt to cover his previous action. For example, he could create the rule to allow external communication and, once this operation was finished,  delete the rule to clear evidence of compromise.</p>
</td>
</tr>
</tbody>
</table>
<p class="mce-root">It is important to mention that some of these events will only appear if the security policy in the local computer is correctly configured. For example, the event 4663 will not appear in the system below because auditing is not enabled for <kbd>Object Access</kbd>:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="331" width="396" src="assets/5c27faeb-a21e-4d2b-9a64-0fd49c8b7d37.png"/></div>
<p>In addition to that,<span> also</span> make sure to collect network traces using Wireshark when dealing with live investigation and, if necessary, use <kbd>procdump</kbd> tool from Sysinternals, to create a dump of the compromised process.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Investigating a compromised system on-premises</h1>
                </header>
            
            <article>
                
<p>For the first scenario, we will use a machine that got compromised after the end user opened a phishing email that looks like following:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/b73b8fbe-c080-4640-a792-d9e54d5f0e43.png"/></div>
<p>This end user was located in the Brazilian branch office, hence the email in Portuguese. The content of this email is a bit concerning, since it talks about an ongoing law process, and the user was curious to see if he really had anything to do with it. After poking around within the email, he noticed that nothing apparently happened. He ignored and continued working. A couple of days later, he receiving an automated report from IT saying that he accessed a suspicious site and he should call support to follow up on this ticket.</p>
<p>He called support and explained that the only suspicious activity that he remembers was to open an odd email, he than presented this email as evidence. When questioned about what he did, he explained that he clicked the image that was apparently attached in the email thinking that he could download it, but nothing came in, only a glimpse of an opening window that quickly disappeared and nothing more.</p>
<p>The first step of the investigation was to validate the URL that was linked to the image in the email. The quickest way to validate is by using VirusTotal, which in this case returned the following value (test performed on November 15, 2017):</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/21f57484-8bc8-4dfe-8ce7-09b4823ad98b.png"/></div>
<p>This was already a strong indication that this site was malicious, the question at that point was: what did it download onto the user's system that the antimalware installed in the local box didn't find? When there is no indication of compromise from the antimalware and there are indications that a malicious file was successfully downloaded in the system, reviewing the event logs is usually the next step.</p>
<p>Using Windows Event Viewer, we filtered the security event for event ID 4688 and started looking into each single event until the following one was found:</p>
<pre>Log Name:      Security 
Source:        Microsoft-Windows-Security-Auditing 
Event ID:      4688 
Task Category: Process Creation 
Level:         Information 
Keywords:      Audit Success 
User:          N/A 
Computer:      BRANCHBR 
Description: 
A new process has been created. 
 
Creator Subject: 
   Security ID:            BRANCHBRJose 
   Account Name:           Jose 
   Account Domain:         BRANCHBR 
   Logon ID:         0x3D3214 
 
Target Subject: 
   Security ID:            NULL SID 
   Account Name:           - 
   Account Domain:         - 
   Logon ID:         0x0 
 
Process Information: 
   New Process ID:         0x1da8 
   New Process Name: C:tempToolsmimix64mimikatz.exe 
   Token Elevation Type:   %%1937 
   Mandatory Label:        Mandatory LabelHigh Mandatory Level 
   Creator Process ID:     0xd88 
   Creator Process Name:   C:WindowsSystem32cmd.exe 
   Process Command Line:    </pre>
<p>As you can see, this is the infamous <kbd>mimikatz</kbd>. It is widely used for credential theft attack, such as <strong>Pass-the-Hash</strong>. Further analysis shows that this user shouldn't be able to run this program since he didn't have administrative privileges in the machine. Following this rationale, we started looking to other tools that were potentially executed prior to this one and we found the following ones:</p>
<pre>Process Information: 
   New Process ID:         0x510 
   New Process Name: C:tempToolsPSExecPsExec.exe </pre>
<p><kbd>PsExec</kbd> tool is commonly used by attackers to launch a command prompt (<kbd>cmd.exe</kbd>) with elevated (system) privileges; later on, we also found another 4688 event:</p>
<pre>Process Information: 
   New Process ID:         0xc70 
   New Process Name: C:tempToolsProcDumpprocdump.exe </pre>
<p><kbd>ProcDump</kbd> tool is commonly used by attackers to dump the credentials from the <kbd>lsass.exe</kbd> process. It was still not clear how Jose was able to gain privileged access and one of the reasons is because we found event ID 1102, which shows that, at some point prior to executing these tools, he cleared the log on the local computer:</p>
<pre>Log Name:      Security 
Source:        Microsoft-Windows-Eventlog 
Event ID:      1102 
Task Category: Log clear 
Level:         Information 
Keywords:      Audit Success 
User:          N/A 
Computer:      BRANCHBR 
Description: 
The audit log was cleared. 
Subject: 
   Security ID:      BRANCHBRJose 
   Account Name:     BRANCHBR 
   Domain Name:      BRANCHBR 
   Logon ID:   0x3D3214 </pre>
<p>Upon further investigation of the local system, it was possible to conclude:</p>
<ul>
<li>Everything started with a phishing email</li>
<li>This email had an embedded image that had a hyperlink to a site that was compromised</li>
<li>A package was downloaded an extracted in the local system, this package contained many tools, such as <kbd><em>mimikatz</em></kbd>, <kbd>procdump</kbd>, and <kbd>psexec</kbd></li>
<li>This computer was not part of the domain, so only local credentials were compromised</li>
</ul>
<div class="packt_infobox">Attacks against Brazilian accounts are growing; by the time we were writing this chapter, Talos Threat Intelligence identified a new attack. The blog <em>Banking Trojan Attempts To Steal Brazillion$</em> at <a href="https://aka.ms/MSTI"><span class="URLPACKT">http://blog.talosintelligence.com/2017/09/brazilbanking.html</span></a> describes a sophisticated phishing email that used a legitimate VMware digital signature binary.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Investigating a compromised system in a hybrid cloud</h1>
                </header>
            
            <article>
                
<p>For this hybrid scenario, the compromised system will be located on-premises and the company has a cloud-based monitoring system, which for the purpose of this example will be Azure Security Center. To show how a hybrid cloud scenario can be similar to an on-premises online scenario, we will use the same case that was used before. Again, a user received a phishing email, clicked on the hyperlink, and got compromised. The difference now is that there is an active sensor monitoring the system, which will trigger an alert to SecOps, and the user will be contacted. The users don't need to wait days to realize they were compromised; the response is faster and more accurate.</p>
<p>The SecOps engineer has access to the Security Center dashboard and, when an alert is created, it shows the <span class="packt_screen">NEW</span> flag besides the alert name. The SecOps engineer also noticed that a new security incident was created, as shown in the following screenshot:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/66d6740d-1078-4607-872c-b43b85b984aa.png"/></div>
<p>As mentioned in <a href="" target="_blank"><span class="ChapterrefPACKT">Chapter 11</span></a>, <em>Active Sensors</em>, a security incident in Azure Security Center represents two or more alerts that are correlated. In other words, they are part of the same attack campaign against a target system. By clicking on this security incident, the SecOps engineer noticed the following alerts:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/0cd06579-4fbc-49c8-a8e8-553d03700a06.png"/></div>
<p>There are four alerts included in this incident and, as you can see, they are organized by time and not by priority. In the bottom part of this pane, there are two notable events included, which are extra information that can be useful during the investigation. The first event only reports that the antimalware installed in the local machine was able to block an attempt to drop a piece of malware in the local system. That's good, but, unfortunately, the attacker was highly motivated to continue his attack and managed to disable antimalware on the local system. It is important to keep in mind that, in order to do that, the attacker had to escalate privilege, and run a command such as <kbd>Taskkill</kbd> or <kbd>killav</kbd> to kill the antimalware process. Moving on, we have a medium priority alert showing that a suspicious process name was detected, as show in the following screenshot:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="501" width="350" src="assets/a09cd79f-cf31-4f68-b7e3-3646239b8b82.png"/></div>
<p>In this case the process is <kbd>mimikatz.exe</kbd>, which was also used in our previous case. You may ask: why is this medium priority and not high? It is because, at this point, this process was not launched yet. That's why the alert says: <span class="packt_screen">Suspicious process name detected</span>. Another important fact about this event is that type of attacked resource, which is <span class="packt_screen">Non-Azure</span> <span class="packt_screen">Resource</span>, and this is how you identify that this is on-premises or a VM in another cloud provider (such as Amazon AWS). Moving on to the next alert, we have a <span class="packt_screen">Suspicious Process Execution Activity Detected</span>:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="521" width="407" src="assets/e68141b0-862d-4350-9cf8-c40260491aff.png"/></div>
<p>The description of this alert is pretty clear about what is happening at this point and this is one of the biggest advantages of having a monitoring system watching process behavior. It will observe these patterns and correlate this data with its own threat intelligence feed to understand if these activities are suspicious or not. The remediation steps provided can also help to take the next steps. Let's continue looking to the other alerts. The next one is the high priority alert, which is the execution of a suspicious process:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="561" width="274" src="assets/e89db748-141b-4617-ae7d-4e7a66a91897.png"/></div>
<div class="packt_figure"/>
<p>This alert shows that <kbd>mimikatz.exe</kbd> was executed and that the parent process was <kbd>cmd.exe</kbd>. Since <kbd>mimikatz</kbd> requires a privileged account to successfully run, the assumption is that this command prompt is running in the context of a high privilege account, which in this case is <span class="packt_screen">EMSAdmin</span>. The notable events that you have in the bottle should also be reviewed. We will skip the first one, since we know is about cleaning the evidence (wipe out the logs), but the next one is not so clear, so let's review it:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="493" width="361" src="assets/d8165712-4a68-4897-b847-c780ac9d4a9c.png"/></div>
<p>This is another indication that the attacker compromised other files, such as the <kbd>rundll32.exe</kbd>. At this point, you have enough information to continue your investigation process. As described in <a href="809bdc34-0360-4a24-b60c-d73cf35528f1.xhtml" target="_blank"><span class="ChapterrefPACKT">Chapter 12</span></a>, <em>Threat Intelligence</em>, the Azure Security Center has a feature that enables you to go deeply into the details of a security issue, which is the investigation feature. In this case, we will select the second alert of this list and click on the <span class="packt_screen">Investigatio</span><span class="packt_screen">n</span> button. The investigation path for this particular case is shown in the following screenshot:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="493" width="501" src="assets/f0ff5871-6529-4664-b311-942dee296611.png"/></div>
<p>Each entity in this diagram provides details about its own object and, if there are other entities related to the one selected, you can pivot it by clicking on the object itself, as shown in the following screenshot:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="497" width="510" src="assets/fdc53c7e-713e-41a5-8cd9-42043d3befd0.png"/></div>
<p>The investigation map helps you to visualize the steps that were taken during this attack and better understand the correlation between all entities that were involved.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Search and you shall find it</h1>
                </header>
            
            <article>
                
<p>In a real-world scenario, the amount of data that gets collected by sensors and monitoring systems can be overwhelming. Manual investigation of these logs can take days, and that's why you need a security monitoring system that can aggregate all these logs, digest them, and rationalize the result for you. Having said that, you also need searching capabilities to be able to keep digging up more important information as you continue your investigation.</p>
<p>Security Center search capabilities are powered by Azure Log Analytics, which has its<span> own</span> query language. By using Log Analytics, you can search across different workspaces and customize the details about your search. Let's say that you needed to know if there were other machines in this environment that had the process named <kbd>mimikatz</kbd> present on it. The search query would be similar to the following:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="80" width="301" src="assets/009730cd-9412-4ea6-8275-842db4415cc8.png"/></div>
<p>Notice that in this case the operator says <kbd>contains</kbd> but it could be <kbd>equals</kbd>. The reason to use <kbd>contains</kbd> is that it could bring more results and, for the purpose of this investigation, we want to know all processes that contain these strings in the name. The result for this query shows the following entries:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/bae76a69-f8bd-4156-83de-e3a3289decdd.png"/></div>
<p>The output always comes in this table format and allows you to visualize all the details about the matches for this query.</p>
<div class="packt_infobox">Access the following link for another example of using search capabilities to find important information about an attack: <a href="https://blogs.technet.microsoft.com/yuridiogenes/2017/10/20/searching-for-a-malicious-process-in-azure-security-center/">https://blogs.technet.microsoft.com/yuridiogenes/2017/10/20/searching-for-a-malicious-process-in-azure-security-center/</a>.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Lessons learned</h1>
                </header>
            
            <article>
                
<p>Every time an incident comes to its closure, you should not only document each step that was done during the investigation but also make sure that you identify key aspects of the investigation that need to be either reviewed to improve or fix since it didn't work so well. The lessons learned are crucial for the continuous improvement of the process and to avoid making the same mistakes again.</p>
<p>In both cases, a credential theft tool was used to gain access to a user's credential and escalate privileges. Attacks against a user's credential are a growing threat and the solution is not based on a silver bullet product, instead, it is an aggregation of tasks, such as:</p>
<ul>
<li>Reducing the number of administrative level accounts and eliminating administrative accounts in local computers. Regular users shouldn't be administrators on their own workstation.</li>
<li>Using multifactor authentication as much as you can.</li>
<li>Adjusting your security policies to restrict login rights.</li>
<li>Having a plan to periodically reset the <strong>Kerberos TGT</strong> (<strong>KRBTGT</strong>) account. This account is used to perform a golden ticket attack.</li>
</ul>
<p>These are only some basic improvements for this environment; the Blue Team should create an extensive report to document the lessons learned and how this will be used to improve the defense controls.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">References</h1>
                </header>
            
            <article>
                
<ol>
<li><em>Banking Trojan Attempts To Steal Brazillion$</em>: <a href="http://blog.talosintelligence.com/2017/09/brazilbanking.html"><span class="URLPACKT">http://blog.talosintelligence.com/2017/09/brazilbanking.html</span></a></li>
<li><em>Security Playbook in Azure Security Center (Preview)</em>: <a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-playbooks"><span class="URLPACKT">https://docs.microsoft.com/en-us/azure/security-center/security-center-playbooks</span></a></li>
<li><em>Handling Security Incidents in Azure Security Center</em>: <a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-incident"><span class="URLPACKT">https://docs.microsoft.com/en-us/azure/security-center/security-center-incident</span></a><a href="http://openioc.org/resources/An_Introduction_to_OpenIOC.pdf"/></li>
<li><em>Threat intelligence in Azure Security Center</em>:<span class="URLPACKT"> </span><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-threat-intel"><span class="URLPACKT">https://docs.microsoft.com/en-us/azure/security-center/security-center-threat-intel</span></a></li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, you learned how important it is to correctly scope an issue before investigating it from the security perspective. You learned the key artifacts in a Windows system and how to improve your data analysis by reviewing only the relevant logs for the case. Next, you followed an on-premises investigation case, the relevant data that was analyzed, and how to interpret that data. You also follow a hybrid cloud investigation case, but this time using Azure Security Center as the main monitoring tool.</p>
<p>In the next chapter, you will learn how to perform a recovery process in a system that was previously compromised. You will also learn about backup and disaster recovery plans.</p>


            </article>

            
        </section>
    </body></html>