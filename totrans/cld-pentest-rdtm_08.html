<html><head></head><body>
		<div id="_idContainer045">
			<h1 id="_idParaDest-142" class="chapter-number"><a id="_idTextAnchor141"/>8</h1>
			<h1 id="_idParaDest-143"><a id="_idTextAnchor142"/>Pentesting Azure Features through Serverless Applications and Tools</h1>
			<p>In the last chapter, we looked at the various SaaS, PaaS, and IaaS services Azure has <span class="No-Break">to offer.</span></p>
			<p>Now, it’s time to actually practice some vulnerability scanning and pentesting in your very own Azure deployment! This will be fun and educational. If you have gone through <a href="B18672_05.xhtml#_idTextAnchor080"><span class="No-Break"><em class="italic">Chapter 5</em></span></a>, <em class="italic">Pentesting AWS Features through Serverless Applications and Tools</em>, we’re going to be doing the same kind of work in this chapter, but <span class="No-Break">in Azure.</span></p>
			<p>This chapter features a step-by-step guide to using Azure’s own first-party security tools to check security configurations and conduct vulnerability assessments. The featured tools are Microsoft Defender for Cloud and Azure Firewall Manager. After that, we will learn how to configure the most popular third-party Azure pentesting tools. The featured tools are Prowler, MFASweep, and ScoutSuite. Lastly, we’ll have a look at the pentesting tutorials to find credentials, enumerate Azure services, conduct vulnerability scans, and discover exposed services with Prowler, MFASweep, <span class="No-Break">and ScoutSuite.</span></p>
			<p>The following topics will be covered in <span class="No-Break">this chapter:</span></p>
			<ul>
				<li>Setting up an <span class="No-Break">Azure instance</span></li>
				<li>Setting up an <span class="No-Break">Azure account</span></li>
				<li>Using Azure Cloud Shell <span class="No-Break">and PowerShell</span></li>
				<li>Azure native <span class="No-Break">security tools</span></li>
				<li>Azure <span class="No-Break">pentesting tools</span></li>
				<li>Exploiting <span class="No-Break">Azure applications</span></li>
			</ul>
			<p>So, let’s get into some <span class="No-Break">practical exercises!</span></p>
			<h1 id="_idParaDest-144"><a id="_idTextAnchor143"/>Technical requirements</h1>
			<p>We will be working with Microsoft’s infrastructure. Massive Azure data centers will be doing the bulk of the computer processing work for the exercises in this chapter. So, fortunately, you don’t need to have a top-of-the-line workstation. You will need <span class="No-Break">the following:</span></p>
			<ul>
				<li>A <span class="No-Break">web browser</span></li>
				<li>A desktop or <span class="No-Break">laptop PC</span></li>
				<li>An Android or <span class="No-Break">iPhone smartphone</span></li>
				<li>A good, reliable <span class="No-Break">internet connection</span></li>
			</ul>
			<p>Check out the following video to view the Code in <span class="No-Break">Action: </span><a href="https://bit.ly/3rUulqT"><span class="No-Break">https://bit.ly/3rUulqT</span></a></p>
			<h1 id="_idParaDest-145"><a id="_idTextAnchor144"/>Setting up an Azure instance</h1>
			<p>Anyone can set up their own Microsoft Azure<a id="_idIndexMarker654"/> account. Many Azure services are free of charge. I strongly recommend deploying your own Azure instance to practice vulnerability scanning and pentesting in Azure before you do paid work for a client so that you can practice your skills. And chances are that your Azure test deployment is simpler than the Azure network the organization you work <span class="No-Break">for operates!</span></p>
			<p>Thanks to the magic of the cloud and the fact that the computer processing, data storage, and bandwidth are on Microsoft’s infrastructure, you don’t need to have a powerful workstation computer to try the exercises I will demonstrate in this chapter. A typical desktop or laptop PC with Windows, macOS, or Linux, good web functionality, and a modern web browser <span class="No-Break">will do.</span></p>
			<p>First, open your web browser<a id="_idIndexMarker655"/> and go to Microsoft’s guide to free Azure services (<a href="https://azure.microsoft.com/en-ca/free">https://azure.microsoft.com/en-ca/free</a>). Here are most of the Azure services that are free as of the time of this writing <span class="No-Break">in 2023:</span></p>
			<ul>
				<li><strong class="bold">Azure Active Directory</strong> is always free, but you’re limited<a id="_idIndexMarker656"/> to 50,000 stored objects with a <strong class="bold">single sign-on</strong> (<strong class="bold">SSO</strong>) authentication interface. Again, this shouldn’t be a problem <a id="_idIndexMarker657"/>with your <span class="No-Break">test deployment.</span></li>
				<li><strong class="bold">Azure Advisor</strong> services are always free and unlimited. Advisor makes personalized<a id="_idIndexMarker658"/> recommendations and identifies best practices for <span class="No-Break">using Azure.</span></li>
				<li>You get 12 months of <strong class="bold">Anomaly Detector</strong> services for free. Anomaly<a id="_idIndexMarker659"/> Detector uses <strong class="bold">artificial intelligence</strong> (<strong class="bold">AI</strong>) and <strong class="bold">machine learning</strong> (<strong class="bold">ML</strong>) to help you troubleshoot<a id="_idIndexMarker660"/> technical problems<a id="_idIndexMarker661"/> <span class="No-Break">in Azure.</span></li>
				<li><strong class="bold">Azure App Configuration</strong> is always free, but there’s a limit of 1,000 requests per day with 10 MB of storage. It’s very unlikely<a id="_idIndexMarker662"/> that your Azure test deployment will make more<a id="_idIndexMarker663"/> than 1,000 requests per day. App Configuration manages and stores the configurations of your <span class="No-Break">Azure apps.</span></li>
				<li><strong class="bold">Azure App Service</strong> is always free. App Service makes it possible to create apps for any<a id="_idIndexMarker664"/> platform or device using tools such as PHP and Node.js. You are limited to 10 apps with 1 GB of storage and 1 hour per day, though. This is unlikely to be an issue with your <span class="No-Break">test deployment.</span></li>
				<li><strong class="bold">Azure DevOps</strong> is always free but with a limit of five users. Azure DevOps <a id="_idIndexMarker665"/>facilitates building apps with CI/CD methodologies, using Git repositories. Basically, if your app needs to deploy several updates per day, Azure DevOps helps to make <span class="No-Break">it happen.</span></li>
				<li><strong class="bold">Azure Files</strong> is free for the first 12 months. It makes it possible to migrate your files across platforms<a id="_idIndexMarker666"/> without changing any code. But you’re limited to 100 GB of <strong class="bold">locally redundant storage</strong> (<strong class="bold">LRS</strong>) transactions and 2 million file operations. That may be restrictive<a id="_idIndexMarker667"/> to some corporate clients, but it’s unlikely to be a problem with your test deployment. (LRS is about synchronously replicating data to <span class="No-Break">three disks.)</span></li>
				<li><strong class="bold">Azure Kubernetes Service</strong> (<strong class="bold">AKS</strong>) is always free. That’s very important because Kubernetes<a id="_idIndexMarker668"/> containerization is one of the most common use cases for cloud networks! You’ll learn about pentesting Kubernetes containerizations<a id="_idIndexMarker669"/> in Azure in <a href="B18672_09.xhtml#_idTextAnchor159"><span class="No-Break"><em class="italic">Chapter 9</em></span></a><span class="No-Break">.</span></li>
				<li><strong class="bold">Azure Lighthouse</strong> is always free. It allows you to manage different service providers interfacing<a id="_idIndexMarker670"/> with your Azure network under the Zero Trust network security model. Zero Trust is a more secure alternative to the old perimeter model of security. Instead of having a perimeter with your trusted computers inside, the internet and other untrusted computers outside, and authentication at the perimeter, Zero Trust creates authentication vectors at all possible points and distrusts all unauthenticated data transmissions by default, even if they’re coming from inside your <span class="No-Break">own network.</span></li>
				<li><strong class="bold">Azure Maps</strong> is an equivalent to Google Maps in the Azure ecosystem. It has many APIs<a id="_idIndexMarker671"/> and features and integrates natively with all Azure applications. You can do things with custom embedded maps on your own mobile, desktop, and web applications alike. Using Azure Maps in the applications you develop is always free, but you’re limited to 1,000 to 5,000 transactions for specific mapping and location <span class="No-Break">insights features.</span></li>
				<li><strong class="bold">Azure Migrate</strong> is always free. It helps you migrate your <strong class="bold">virtual machines</strong> (<strong class="bold">VMs</strong>) from your premises or other<a id="_idIndexMarker672"/> cloud platforms<a id="_idIndexMarker673"/> <span class="No-Break">to Azure.</span></li>
				<li><strong class="bold">Azure Policy</strong> helps you comply with data privacy and cybersecurity regulations. This is likely more of an issue<a id="_idIndexMarker674"/> for your employer than for your Azure test deployment. But you do get free access to configuration and change <span class="No-Break">tracking features.</span><p class="list-inset">You get 15 GB of outbound<a id="_idIndexMarker675"/> data transfer bandwidth free for the first 12 months, and 100 GB of inbound data transfer for <span class="No-Break">free always.</span></p></li>
				<li><strong class="bold">Blobs</strong> are a kind of unstructured data object. You get<a id="_idIndexMarker676"/> 5 GB of LRS storage in Blob Storage, with 20,000 read and 10,000 write operations for free for the first 12 months. But I don’t anticipate you using Blob Storage for your test <span class="No-Break">deployment</span><span class="No-Break"><a id="_idIndexMarker677"/></span><span class="No-Break"> anyway.</span></li>
				<li>As far as <strong class="bold">Cloud Shell</strong> is concerned, you get 5 GB of free storage in Azure Files for free for the first 12 months. It’s the Azure<a id="_idIndexMarker678"/> equivalent of AWS CloudShell, which I demonstrated in <em class="italic">Chapters 5</em> and <em class="italic">6</em>. Having access to a CLI in your web browser is very important, and you almost certainly will be using Azure Cloud Shell in your Azure test <span class="No-Break">deployment too!</span></li>
				<li><strong class="bold">Container Apps</strong> is always free but with some<a id="_idIndexMarker679"/> limits. Container Apps makes it possible to deploy apps and microservices in serverless containers, and you’re limited to 180,000 vCPU seconds, 360,000 GiB seconds, and 2 million requests. That’s unless you’re ready to <span class="No-Break">pay extra.</span></li>
				<li><strong class="bold">Container Registry</strong> stores and manages your container <a id="_idIndexMarker680"/>images throughout Azure’s ecosystem. It’s free for the first 12 months, but you’re limited to one Standard tier registry with 100 GB storage and <span class="No-Break">10 webhooks.</span></li>
				<li><strong class="bold">Cost Management</strong> is always free. So, you won’t be paying<a id="_idIndexMarker681"/> extra to save money and optimize your Azure<a id="_idIndexMarker682"/> cloud services expenses with full visibility into your expenditures. And of course, if you always stay within the free services and their limits, then there won’t be any expenditures in the first place! But you can always check with Cost <span class="No-Break">Management anyway.</span></li>
				<li><strong class="bold">Database Migration Service</strong> makes it easier to migrate databases from on-premises servers<a id="_idIndexMarker683"/> to the cloud. It’s unlikely you’ll be doing that with your test deployment, but the Free Standard Compute level is <span class="No-Break">always free.</span></li>
				<li><strong class="bold">DevTest Labs</strong> enables developers to test their work<a id="_idIndexMarker684"/> in dev/test environments. It’s <span class="No-Break">always free.</span></li>
				<li><strong class="bold">Event Grid</strong> assures reliable event delivery at a massive <a id="_idIndexMarker685"/>scale, to facilitate service integration. It’s always free, but you’re limited to 100,000 operations per month. You should <span class="No-Break">be fine!</span></li>
				<li><strong class="bold">Functions</strong> makes it possible to process events<a id="_idIndexMarker686"/> with a serverless code architecture. Just in case you want to use it, 1 million requests are <span class="No-Break">always free.</span></li>
				<li><strong class="bold">Key Vault</strong> safely stores the encryption keys<a id="_idIndexMarker687"/> you use in your Azure services. Its services are free for the first 12 months, but you’re limited to 10,000 transactions, RSA 2048-bit keys, or secret operations at the <span class="No-Break">Standard tier.</span></li>
				<li>You get some amount of <strong class="bold">Linux VMs</strong> for free for the first 12 months. The limit<a id="_idIndexMarker688"/> is 750 hours of B1s <span class="No-Break">burstable VMs.</span></li>
				<li><strong class="bold">Load Balancer</strong> assures that the usage of your Azure deployment is balanced across servers<a id="_idIndexMarker689"/> according to demands at any given time. For the first 12 months, you get 750 hours, 15 GB of data processing, and up to five rules with Standard <span class="No-Break">Load Balancer.</span></li>
				<li><strong class="bold">Managed Disks</strong> is a service used for Azure Virtual Machines<a id="_idIndexMarker690"/> block storage. For the first 12 months, you get 2 drives of 64 GB SSD storage, plus 1 GB snapshot and 2 million I/O operations for free. Anything more is going to <span class="No-Break">cost you!</span></li>
				<li><strong class="bold">Media Services</strong> makes it possible for you to deploy streaming media to any kind of device, such as streaming<a id="_idIndexMarker691"/> video or audio. It’s unlikely that you’ll be doing that with your test<a id="_idIndexMarker692"/> deployment. But just in case, you get 5 hours each of Standard Passthrough, Live Transcription, and Standard Streaming endpoints free for the first <span class="No-Break">12 months.</span></li>
				<li><strong class="bold">Monitor</strong> gives you full visibility and observability <a id="_idIndexMarker693"/>into your applications, infrastructure, and network. There are different limits per feature, but otherwise, it’s <span class="No-Break">always free.</span></li>
				<li><strong class="bold">Network Watcher</strong> helps you monitor, diagnose, and otherwise understand your network <a id="_idIndexMarker694"/>performance in Azure. It’s always free, but you’re limited to 5 GB storage with 1,000 checks, 10 tests, and 10 <span class="No-Break">connection metrics.</span></li>
				<li><strong class="bold">Notification Hubs</strong> allows you to send push notifications to any mobile device (iOS and Android). You’re limited <a id="_idIndexMarker695"/>to 1 million push notifications, but that much is free. This should only be a concern if you’re using your Azure instance to deploy mobile <span class="No-Break">apps, though.</span></li>
				<li><strong class="bold">Private Link</strong> lets you privately access your Azure services from any of your own <a id="_idIndexMarker696"/>endpoints. It’s <span class="No-Break">always free.</span></li>
				<li><strong class="bold">Resource Manager</strong> lets you see how your app resources<a id="_idIndexMarker697"/> are being used and enables you to manage it all. It’s <span class="No-Break">always free.</span></li>
				<li><strong class="bold">Security Center</strong> makes it possible to prevent, detect, and respond<a id="_idIndexMarker698"/> to threats across all your Azure deployments. Policy assessments and recommendations are <span class="No-Break">always free!</span></li>
				<li>It’s highly likely that your web apps<a id="_idIndexMarker699"/> and other database-driven apps will need <strong class="bold">SQL Database</strong>. For the first 12 months, you get a 250 GB S0 instance with 10 database transaction units <span class="No-Break">for free.</span></li>
				<li><strong class="bold">SQL Server 2019 Developer Edition</strong> makes it possible to build, test, and demonstrate applications<a id="_idIndexMarker700"/> outside of your production environment. It’s <span class="No-Break">always free.</span></li>
				<li>You also get some amount of <strong class="bold">Windows VMs</strong> for free for the first 12 months. Again, the limit is 750 hours<a id="_idIndexMarker701"/> of B1s <span class="No-Break">burstable VMs.</span></li>
				<li>You get 50 instances of <strong class="bold">Virtual Network</strong> for free, always. But that’s for provisioning private networks<a id="_idIndexMarker702"/> and connecting them to a data center that’s on your premises. That’s not likely something you’ll need for your <span class="No-Break">test deployment.</span></li>
				<li><strong class="bold">VPN Gateway</strong> makes it possible to deploy VPNs across data centers and cloud services. That encrypts<a id="_idIndexMarker703"/> your data in transit in a very effective way. You get 750 hours for free for the first 12 months. But that’s probably a service that’s much more useful for the organization<a id="_idIndexMarker704"/> that you’re working for than for your Azure <span class="No-Break">test deployment.</span></li>
			</ul>
			<p>Let’s deploy an Azure instance for you to use for <span class="No-Break">testing purposes.</span></p>
			<h1 id="_idParaDest-146"><a id="_idTextAnchor145"/>Setting up an Azure account</h1>
			<p>Everything you need<a id="_idIndexMarker705"/> to do to launch your first Azure instance to practice your pentesting skills can be done from your web browser. <span class="No-Break">Here’s how:</span></p>
			<ol>
				<li>While you’re on the Azure free services web page (<a href="https://azure.microsoft.com/en-ca/free">https://azure.microsoft.com/en-ca/free</a>), click on the green <strong class="bold">Start </strong><span class="No-Break"><strong class="bold">free</strong></span><span class="No-Break"> button:</span></li>
			</ol>
			<div>
				<div id="_idContainer036" class="IMG---Figure">
					<img src="image/B18672_08_1.jpg" alt="Figure 8.1 – Azure free account creation page"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.1 – Azure free account creation page</p>
			<p class="list-inset">You’ll be taken to a screen<a id="_idIndexMarker706"/> to sign in to a Microsoft account. If you use Windows 10 or Windows 11 at home, chances are you already have a Microsoft account. You can choose to use your existing Microsoft account, create a new Microsoft account (which you may do even if you already have another Microsoft account), or sign in with your GitHub credentials if you <span class="No-Break">have them.</span></p>
			<p class="list-inset">I decided to use a Microsoft<a id="_idIndexMarker707"/> account that I already have. I’m cautious when it comes to cybersecurity, so I already had <strong class="bold">multi-factor authentication</strong> (<strong class="bold">MFA</strong>) set up on my Android phone with Microsoft Authenticator. I used my password and a code sent to my phone through Microsoft Authenticator, and I was logged in. Microsoft Authenticator is free for both Android and iOS, and I strongly recommend<a id="_idIndexMarker708"/> using it for your Azure services. Here’s where you can learn more about Microsoft <span class="No-Break">Authenticator: </span><a href="https://www.microsoft.com/en-ca/security/mobile-authenticator-app"><span class="No-Break">https://www.microsoft.com/en-ca/security/mobile-authenticator-app</span></a><span class="No-Break">.</span></p>
			<p class="list-inset">Just to make sure there’s no confusion, I use my phone for Microsoft Authenticator, but I use my Windows 11 laptop to work with Azure through its web interfaces. It’s not very practical to manage your cloud services from your phone. Fortunately, a MacBook or a Linux PC works just as well as a Windows PC for <span class="No-Break">this work.</span></p>
			<ol>
				<li value="2">Once I logged in, I was taken to a form where I entered my name, my region (in my case, Canada), and my phone number. I even got $200 USD of credit to use in my first 30 days! Thank you, Microsoft. My phone number was confirmed via an SMS text message. Then, I entered my home mailing address and agreed to the customer agreement. At the bottom of the form, click <span class="No-Break">on </span><span class="No-Break"><strong class="bold">Next</strong></span><span class="No-Break">.</span></li>
				<li>Then, you’ll see a screen where<a id="_idIndexMarker709"/> you enter your credit card information. Even if you’re using free services, this step is mandatory. Your card will be charged if you incur any number of paid services or consume over your free services limits. I recommend using Azure’s Cost Management app to watch <span class="No-Break">that carefully!</span><p class="list-inset">At the bottom, click on the blue <strong class="bold">Sign </strong><span class="No-Break"><strong class="bold">up</strong></span><span class="No-Break"> button.</span></p></li>
				<li>Wait a few moments, and your account will be set up. Then, you’ll see a screen that says <strong class="bold">You’re ready to start with Azure</strong>. Click on the blue button that says <strong class="bold">Go to the Azure portal</strong>. It sounds very exciting! We’re going on a cloud services <span class="No-Break">journey together.</span><p class="list-inset">The QuickStart Center<a id="_idIndexMarker710"/> will show you a lot of different options for you to get started. You can take an online course, follow setup guides, or start a project. The project options under the <strong class="bold">Projects and guides</strong> <span class="No-Break">tab are:</span></p><ul><li><strong class="bold">Create a </strong><span class="No-Break"><strong class="bold">web app</strong></span></li><li><strong class="bold">Deploy a </strong><span class="No-Break"><strong class="bold">virtual machine</strong></span></li><li><strong class="bold">Deploy and run a </strong><span class="No-Break"><strong class="bold">container-based app</strong></span></li><li><strong class="bold">Set up </strong><span class="No-Break"><strong class="bold">a database</strong></span></li><li><strong class="bold">Get started with data analytics, machine learning, </strong><span class="No-Break"><strong class="bold">and intelligence</strong></span></li><li><strong class="bold">Store, back up, or </strong><span class="No-Break"><strong class="bold">archive data</strong></span></li><li><strong class="bold">Build, deploy, and operate a </strong><span class="No-Break"><strong class="bold">serverless app</strong></span></li></ul><p class="list-inset">You can see an overview of <span class="No-Break">this here:</span></p></li>
			</ol>
			<div>
				<div id="_idContainer037" class="IMG---Figure">
					<img src="image/B18672_08_2.jpg" alt="Figure 8.2 – Microsoft Azure Quickstart Center"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.2 – Microsoft Azure Quickstart Center</p>
			<p class="list-inset">For now, let’s deploy<a id="_idIndexMarker711"/> a VM. (We’ll deploy and run a container-based app in <a href="B18672_09.xhtml#_idTextAnchor159"><span class="No-Break"><em class="italic">Chapter 9</em></span></a><span class="No-Break">.)</span></p>
			<ol>
				<li value="5">Next, you’ll be given the option to create a Windows VM or a <span class="No-Break">Linux VM:</span></li>
			</ol>
			<div>
				<div id="_idContainer038" class="IMG---Figure">
					<img src="image/B18672_08_3.jpg" alt="Figure 8.3 – Screen to deploy a VM from Quickstart Center"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.3 – Screen to deploy a VM from Quickstart Center</p>
			<p class="list-inset">Because I used a Linux VM<a id="_idIndexMarker712"/> in the AWS chapter, we’ll shake things up and choose a Windows VM here. But if you create a Linux VM, you can use the Linux Bash commands at the CLI that I used in <a href="B18672_05.xhtml#_idTextAnchor080"><span class="No-Break"><em class="italic">Chapter 5</em></span></a> <span class="No-Break">for AWS.</span></p>
			<ol>
				<li value="6">The next screen says <strong class="bold">Create a virtual machine</strong> at the top. You’ll have a form to <span class="No-Break">fill out:</span><ul><li>Under <strong class="bold">Project details</strong>, leave the subscription as default or <strong class="bold">Azure subscription 1</strong>. Under resource group, leave it at <strong class="bold">(New) </strong><span class="No-Break"><strong class="bold">Resource group</strong></span><span class="No-Break">.</span></li><li>Under <strong class="bold">Instance details</strong>, give VM an original name that you’ll remember. I entered <strong class="source-inline">PentestingWindowsVM</strong>. Spaces and special characters <span class="No-Break">aren’t allowed!</span></li><li>I chose <strong class="bold">(US) East US</strong> as my region. But you can choose any region that you’d like. It doesn’t even need to be near your physical location. You can be in India and choose <strong class="bold">(Europe) Norway East</strong> if <span class="No-Break">you want!</span></li><li>Under <strong class="bold">Availability options</strong>, I chose <strong class="bold">No infrastructure redundancy required</strong>. That’s your safest bet if you want to avoid service charges. However, the organization you work for has much greater needs than your test deployment and would probably choose a <span class="No-Break">different option.</span></li><li>Under <strong class="bold">Security type</strong>, I chose <strong class="bold">Standard</strong>. That’s the safest bet for your own test deployment to avoid service charges, but a business, institution, or enterprise should probably choose a greater <span class="No-Break">security level.</span></li><li>I left the default Windows<a id="_idIndexMarker713"/> Server 2016 Datacenter as my image. x64 is the only VM architecture option for that image. Besides, ARM64 isn’t a free <span class="No-Break">service option.</span></li><li>I chose the smallest possible size (1 vCPU, 3.5 GiB memory for $91.98 per month). I’m only going to be using my instance for a month, and this will fit into my $200 USD of free credit. Fingers crossed! You don’t need a large size for your own <span class="No-Break">test deployment.</span></li></ul></li>
				<li>On the next screen, create a username and password for your administrator account. Make sure your password is strong! I used a password manager to generate a complex password with lots of characters. I recommend using a password manager too, perhaps one built into your web browser. Then, you won’t have to remember your <span class="No-Break">complex passwords.</span></li>
				<li>On the next screen, I disabled public inbound ports. Then, at the bottom left, I clicked on the blue <strong class="bold">Review + create</strong> button because I decided to leave the rest of the defaults for <strong class="bold">Disks</strong>, <strong class="bold">Networking</strong>, <strong class="bold">Management</strong>, and <strong class="bold">Monitoring</strong>. Your view may look similar or a little different. Look at the words on your screen carefully. I plan to cancel my Azure account in about a month. But if you need to keep your Azure test deployment longer, then I recommend clicking on <strong class="bold">Next</strong> instead of <strong class="bold">Review + create</strong> and consider your <span class="No-Break">options carefully.</span></li>
				<li>If the options on your screen look good, click on the blue <strong class="bold">Create</strong> button in the lower-left corner. Otherwise, click on the <strong class="bold">Previous</strong> button to change your <span class="No-Break">configuration accordingly.</span><p class="list-inset">It takes a few moments for your deployment to be ready. <span class="No-Break">Be patient!</span></p></li>
			</ol>
			<p>Your mileage may vary. But for me, my deployment took about a minute to take effect. Then, the screen said <strong class="bold">Your deployment is complete</strong>. So, I clicked on the blue <strong class="bold">Go to </strong><span class="No-Break"><strong class="bold">resource</strong></span><span class="No-Break"> button.</span></p>
			<p>In <a href="B18672_09.xhtml#_idTextAnchor159"><span class="No-Break"><em class="italic">Chapter 9</em></span></a>, we will pentest the VM we <span class="No-Break">just deployed.</span></p>
			<p>If you’re really technical, you’ll love the screen<a id="_idIndexMarker714"/> that appears after clicking <strong class="bold">Go to resource</strong>. You can browse all of the technicalities of your VM and other Azure services. But for now, let’s get into Azure <span class="No-Break">Cloud Shell.</span></p>
			<h1 id="_idParaDest-147"><a id="_idTextAnchor146"/>Using Azure Cloud Shell and PowerShell</h1>
			<p>Wherever you are in the web interface<a id="_idIndexMarker715"/> for managing your Azure<a id="_idIndexMarker716"/> services (the URL in your address bar should say <strong class="source-inline">portal.azure.com</strong>), as long as you’re logged in, there will be a blue menu bar at the top. To the right of the search bar, there’s an icon that looks like a command prompt (something like <span class="No-Break">this: </span><span class="No-Break"><strong class="bold">&gt;_</strong></span><span class="No-Break">):</span></p>
			<div>
				<div id="_idContainer039" class="IMG---Figure">
					<img src="image/B18672_08_4.jpg" alt="Figure 8.4 – Azure menu bar and Cloud Shell"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.4 – Azure menu bar and Cloud Shell</p>
			<p>Click on it to launch Azure Cloud Shell. In Azure Cloud Shell, you can switch back and forth between PowerShell and Bash at the drop-down menu in the top-left corner. You may have to choose <strong class="bold">Create storage</strong> the first time you launch <span class="No-Break">Cloud Shell:</span></p>
			<div>
				<div id="_idContainer040" class="IMG---Figure">
					<img src="image/B18672_08_5.jpg" alt="Figure 8.5 – Azure Cloud Shell screen"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.5 – Azure Cloud Shell screen</p>
			<p>You’ll find some Bash<a id="_idIndexMarker717"/> commands in <a href="B18672_05.xhtml#_idTextAnchor080"><span class="No-Break"><em class="italic">Chapter 5</em></span></a>, <em class="italic">Pentesting AWS Features through Serverless Applications and Tools</em>. We will be using<a id="_idIndexMarker718"/> Bash when installing and executing the tools in this chapter. But let’s review some useful PowerShell commands that you can use at the Azure Cloud Shell CLI. They’re handy to know, and you may need to use PowerShell commands when conducting some other activities in Azure <span class="No-Break">Cloud Shell:</span></p>
			<ul>
				<li>Similar to Bash, you can use the following commands to change which directory you <span class="No-Break">have open:</span><ul><li><span class="No-Break"><strong class="source-inline">cd</strong></span></li><li><span class="No-Break"><strong class="source-inline">chdir</strong></span></li></ul></li>
				<li>Copy an item with one of the following commands before the filename of the item <span class="No-Break">you’re copying:</span><ul><li><span class="No-Break"><strong class="source-inline">copy</strong></span></li><li><span class="No-Break"><strong class="source-inline">cp</strong></span></li></ul></li>
				<li>You can move an item with any of the following commands. You’ll also need to enter the file path and filename that you’re moving and the destination file path in <span class="No-Break">the command:</span><ul><li><span class="No-Break"><strong class="source-inline">mi</strong></span></li><li><span class="No-Break"><strong class="source-inline">move</strong></span></li><li><span class="No-Break"><strong class="source-inline">mv</strong></span></li></ul></li>
				<li>Remove an item with one of the following commands and the name of the file or files you’d like to remove. Remember, this will delete <span class="No-Break">your files:</span><ul><li><span class="No-Break"><strong class="source-inline">del</strong></span></li><li><span class="No-Break"><strong class="source-inline">erase</strong></span></li><li><span class="No-Break"><strong class="source-inline">rd</strong></span></li><li><span class="No-Break"><strong class="source-inline">ri</strong></span></li><li><span class="No-Break"><strong class="source-inline">rm</strong></span></li></ul></li>
				<li>This command will remove an entire directory. Be careful when you <span class="No-Break">use it:</span><ul><li><span class="No-Break"><strong class="source-inline">rmdir</strong></span></li></ul></li>
				<li>If you want to create<a id="_idIndexMarker719"/> a new item, use the following command. I’ll usually<a id="_idIndexMarker720"/> only use it for text-based documents that can be modified in Notepad, though. Using this command will create an empty file with the filename you choose in <span class="No-Break">your command:</span><ul><li><span class="No-Break"><strong class="source-inline">ni</strong></span></li></ul></li>
				<li>Set a new value on an item with <span class="No-Break">this command:</span><ul><li><span class="No-Break"><strong class="source-inline">si</strong></span></li></ul><p class="list-inset">For instance, you can enter <strong class="source-inline">si path &lt;string&gt;</strong> to a string or <strong class="source-inline">si value &lt;object&gt;</strong> to an object, such <span class="No-Break">as </span><a href="https://ss64.com/ps/set-item.html"><span class="No-Break">https://ss64.com/ps/set-item.html</span></a><span class="No-Break">.</span></p></li>
				<li>Start a background job (executable task) with <span class="No-Break">this command:</span><ul><li><span class="No-Break"><strong class="source-inline">sajb</strong></span></li></ul></li>
				<li>Suspend the job with <span class="No-Break">this command:</span><ul><li><span class="No-Break"><strong class="source-inline">sujb</strong></span></li></ul></li>
				<li>Resume the job with <span class="No-Break">this command:</span><ul><li><span class="No-Break"><strong class="source-inline">rujb</strong></span></li></ul></li>
				<li>Start a <span class="No-Break">stopped service:</span><ul><li><span class="No-Break"><strong class="source-inline">sasv</strong></span></li></ul></li>
			</ul>
			<p>In Azure Cloud Shell, whether you run PowerShell or Bash, the following guide will be displayed the moment<a id="_idIndexMarker721"/> you launch Cloud Shell. The commands I’ve shown here so far work in the Azure CLI, and checking <a id="_idIndexMarker722"/>out the built-in help guide is always a good use of <span class="No-Break">your time:</span></p>
			<pre class="console">
Type "az" to use Azure CLI
Type "help"" to learn about Cloud Shell</pre>			<p>Up next, let us take a look at some of the native Azure <span class="No-Break">security tools.</span></p>
			<h1 id="_idParaDest-148"><a id="_idTextAnchor147"/>Azure native security tools</h1>
			<p>Here’s what’s built into Azure that can help you <span class="No-Break">with security.</span></p>
			<h2 id="_idParaDest-149"><a id="_idTextAnchor148"/>Microsoft Defender</h2>
			<p>Microsoft Defender for Cloud<a id="_idIndexMarker723"/> is an important application<a id="_idIndexMarker724"/> for checking your security posture in Azure. It will give you security recommendations based on your current configuration and let you know about some of the security vulnerabilities you have. This is information that you can use in your <span class="No-Break">pentest report.</span></p>
			<p>Let’s open Microsoft Defender and see what we can learn about how secure our Azure <span class="No-Break">deployment is:</span></p>
			<ol>
				<li>To execute the application, first, make sure that you’re logged in to your Azure account in your web browser. Visit <a href="http://portal.azure.com">portal.azure.com</a>. You should then see <span class="No-Break">this screen.</span></li>
				<li>Next, at the blue menu<a id="_idIndexMarker725"/> bar at the top, enter <strong class="source-inline">Defender</strong> in the search bar. A link to Microsoft<a id="_idIndexMarker726"/> Defender for Cloud should populate. Click <span class="No-Break">on it.</span><p class="list-inset">You may need to add Microsoft Defender for Cloud as a paid service. If you haven’t signed up for it already, there will be a handy <strong class="bold">Upgrade</strong> button on the main page of the application. Be careful to check the subscription fees before <span class="No-Break">you commit!</span></p></li>
				<li>Once you’re in Microsoft Defender for Cloud, there will be a menu on the left-hand side with a number of different sections (<span class="No-Break"><em class="italic">Figure 8</em></span><em class="italic">.6</em>). They represent different tools for understanding your security posture <span class="No-Break">in Azure:</span><ul><li><strong class="bold">Recommendations</strong> will show you some security improvement recommendations, classified as <strong class="bold">High</strong>, <strong class="bold">Medium</strong>, and <strong class="bold">Low</strong> <span class="No-Break">in severity.</span></li><li><strong class="bold">Attach path analysis</strong> will show if Defender has identified an attack path to your Azure instance that a threat actor could use. Hopefully, this page will say <strong class="bold">No attack paths were found</strong>. Whether or not an attack path was found, you can include this information in your <span class="No-Break">pentest report.</span></li><li><strong class="bold">Security alerts</strong> is similar to <strong class="bold">Recommendations</strong>. Alerts are classified as <strong class="bold">High</strong>, <strong class="bold">Medium</strong>, and <strong class="bold">Low</strong> <span class="No-Break">in severity.</span></li><li><strong class="bold">Cloud Security Explorer</strong> will show you a bunch of query templates you <span class="No-Break">can execute:</span><ul><li><span class="No-Break">Internet-exposed VMs</span></li><li>Internet-exposed VMs with <span class="No-Break">high-severity vulnerabilities</span></li><li>VMs vulnerable to a <span class="No-Break">specific vulnerability</span></li><li>Internet-exposed SQL servers with <span class="No-Break">managed identity</span></li><li>User accounts without MFA<a id="_idIndexMarker727"/> and with permissions<a id="_idIndexMarker728"/> to <span class="No-Break">storage accounts</span></li><li>Azure Kubernetes pods running images with <span class="No-Break">high-severity vulnerabilities</span></li><li>Key Vault keys and secrets without any <span class="No-Break">expiration period</span></li><li>User accounts with permission to <span class="No-Break">vulnerable VMs</span></li><li>Internet-exposed SQL servers tagged <span class="No-Break">as production</span></li><li>External users with permission to SQL VMs that allow code execution on <span class="No-Break">the host</span></li><li>VMs with Log4Shell vulnerability that has permissions to <span class="No-Break">storage accounts</span></li><li>Kubernetes namespaces that contain <span class="No-Break">vulnerable pods</span></li><li>Internet-exposed <strong class="bold">Simple Storage Service</strong> (<strong class="bold">S3</strong>) buckets with sensitive data<a id="_idIndexMarker729"/> that allow <span class="No-Break">public access</span></li><li>Internet-exposed storage account containers with sensitive data that allow <span class="No-Break">public access</span></li></ul></li><li><strong class="bold">Diagnose and solve problems</strong> offers a number of automated troubleshooters to resolve issues in <span class="No-Break">these areas:</span><ul><li>Defender <strong class="bold">cloud security posture management</strong> (<span class="No-Break"><strong class="bold">CSPM</strong></span><span class="No-Break">) plan</span></li><li>Defender <span class="No-Break">for servers</span></li><li>Onboarding <span class="No-Break">and settings</span></li><li>Pricing, billing, <span class="No-Break">and usage</span></li><li>Secure score <span class="No-Break">and recommendations</span></li><li><span class="No-Break">Security alerts</span></li><li><strong class="bold">Vulnerability </strong><span class="No-Break"><strong class="bold">assessment</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">VA</strong></span><span class="No-Break">)</span></li></ul></li></ul><p class="list-inset">The latter two troubleshooters should be especially useful for you to make sure your security alerts and vulnerability assessments <span class="No-Break">work properly!</span></p><ul><li>Under <strong class="bold">Cloud Security</strong>, <strong class="bold">Security posture</strong> will present an overview with a secure score and environment indicators (Management groups, Subscriptions, Unhealthy resources, and Recommendations). You can also generate a governance report from the top of the screen. This data may be useful to include in your <span class="No-Break">pentest report.</span></li><li>From the left menu in Microsoft Defender for Cloud, you can also view <strong class="bold">Azure Firewall Manager</strong>, which will show<a id="_idIndexMarker730"/> you monitoring reports<a id="_idIndexMarker731"/> <span class="No-Break">and overviews.</span></li><li>You can also manage <strong class="bold">Azure Firewall Policies</strong>, <strong class="bold">distributed denial-of-service</strong> (<strong class="bold">DDoS</strong>) <strong class="bold">Protection Plans</strong>, and <strong class="bold">Web Application </strong><span class="No-Break"><strong class="bold">Firewall Policies</strong></span><span class="No-Break">.</span></li></ul></li>
			</ol>
			<p>In the next section, I’ll walk you through the installation processes we’ll use when we exploit our own Azure <span class="No-Break">test deployments.</span></p>
			<h1 id="_idParaDest-150"><a id="_idTextAnchor149"/>Azure pentesting tools</h1>
			<p>In the previous chapter, I listed <a id="_idIndexMarker732"/>several different third-party applications that you can use when you <span class="No-Break">pentest Azure.</span></p>
			<p>Everything that I’ll demonstrate here is permitted under Microsoft’s policies, as long as you’re either conducting these activities in your own Azure instance or you have permission from the owner of the Azure instance you’re working with to conduct vulnerability scanning and <span class="No-Break">pentesting there.</span></p>
			<p>But I believe there’s no such thing<a id="_idIndexMarker733"/> as being too cautious. So, I’m linking to Microsoft’s policies again (<a href="https://www.microsoft.com/en-us/msrc/pentest-rules-of-engagement">https://www.microsoft.com/en-us/msrc/pentest-rules-of-engagement</a>). Please read and understand those policies so that you can abide by them, whether or not the Azure instance<a id="_idIndexMarker734"/> you’re working in is yours, because ultimately, you’re still working in Microsoft’s infrastructure <span class="No-Break">either way!</span></p>
			<h2 id="_idParaDest-151"><a id="_idTextAnchor150"/>Prowler</h2>
			<p>In the AWS section (<a href="B18672_05.xhtml#_idTextAnchor080"><span class="No-Break"><em class="italic">Chapter 5</em></span></a>), we found Prowler<a id="_idIndexMarker735"/> to be a very useful vulnerability scanning tool. Prowler<a id="_idIndexMarker736"/> is also good for vulnerability scanning in Azure, so I’ll walk you through Prowler’s installation process <span class="No-Break">in Azure:</span></p>
			<ol>
				<li>Launch Azure Cloud Shell by looking to the right of the search bar at the top. There’s an icon that looks like a command prompt (something like <span class="No-Break">this: </span><span class="No-Break"><strong class="bold">&gt;_</strong></span><span class="No-Break">).</span><p class="list-inset">Click <span class="No-Break">on it!</span></p></li>
				<li>Instead of launching the PowerShell CLI in Azure Cloud Shell, we’ll need to run Bash instead. At the top left of the Azure Cloud Shell display, there’s a drop-down menu to switch back and forth between PowerShell and Bash. Make sure Bash <span class="No-Break">is selected.</span></li>
				<li>We’re going to use <strong class="source-inline">pip</strong> to install<a id="_idIndexMarker737"/> Prowler, so it might be useful to make sure<a id="_idIndexMarker738"/> the version of <strong class="source-inline">pip</strong> that you have installed in Azure is up to date. Try this <span class="No-Break">command first:</span><pre class="source-code">
<strong class="bold">pip install --upgrade pip</strong></pre></li>				<li>Now, we’re going to install Prowler with one simple command. First, make sure you’re in your home directory or the directory you’d like to run and install Prowler in. Use the <strong class="source-inline">cd</strong> command if you need to do so. Then, use <strong class="source-inline">pip</strong> to install Prowler, <span class="No-Break">like this:</span><pre class="source-code">
<strong class="bold">pip install prowler</strong></pre></li>			</ol>
			<p>You’ll see the various Prowler<a id="_idIndexMarker739"/> components downloaded at the command<a id="_idIndexMarker740"/> line, and then all of the necessary packages should be installed. Hopefully, you will be good<a id="_idIndexMarker741"/> to go! If you need more help, check out the official Prowler documentation (<a href="https://docs.prowler.cloud/en/latest/">https://docs.prowler.cloud/en/latest/</a>) and the official pip <span class="No-Break">documentation (</span><a href="https://pip.pypa.io/en/stable/"><span class="No-Break">https://pip.pypa.io/en/stable/</span></a><span class="No-Break">).</span></p>
			<p>Next, let’s install <span class="No-Break">MFASweep</span><span class="No-Break"> (</span><a href="https://github.com/dafthack/MFASweep"><span class="No-Break">https://github.com/dafthack/MFASweep</span></a><span class="No-Break">).</span></p>
			<h2 id="_idParaDest-152"><a id="_idTextAnchor151"/>MFASweep</h2>
			<p><strong class="bold">MFASweep</strong> is a PowerShell script that attempts<a id="_idIndexMarker742"/> to log in to various Microsoft services using a provided set of credentials<a id="_idIndexMarker743"/> and will attempt to identify if MFA is enabled. It’s very important for all user accounts in Azure to have MFA enabled to protect those accounts from <span class="No-Break">cyber attackers.</span></p>
			<p>Let’s <span class="No-Break">install it!</span></p>
			<ol>
				<li>In another web browser tab, make sure you’re logged in to your GitHub account at <a href="http://github.com">github.com</a>. If necessary, create a new <span class="No-Break">GitHub account.</span></li>
				<li>Next, run this command to link your GitHub<a id="_idIndexMarker744"/> account to your Azure account. You may need to add a <strong class="bold">one-time password</strong> (<strong class="bold">OTP</strong>) in order to do so. If that’s the case, an OTP for you to enter into GitHub (in the other web browser tab) will <span class="No-Break">be generated:</span><pre class="source-code">
<strong class="bold">gh auth login</strong></pre></li>				<li>Now, enter this command to use Git to <span class="No-Break">install MFASweep:</span><pre class="source-code">
<strong class="bold">gh repo clone dafthack/MFASweep</strong></pre></li>			</ol>
			<div>
				<div id="_idContainer041" class="IMG---Figure">
					<img src="image/B18672_08_6.jpg" alt="Figure 8.6 – MFASweep installation process in Azure"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.6 – MFASweep installation process in Azure</p>
			<p>In the preceding screenshot, you<a id="_idIndexMarker745"/> can see the GitHub repository<a id="_idIndexMarker746"/> cloning process and installation of MFASweep at the <span class="No-Break">command line.</span></p>
			<h2 id="_idParaDest-153"><a id="_idTextAnchor152"/>ScoutSuite</h2>
			<p>Now, let’s install ScoutSuite. ScoutSuite<a id="_idIndexMarker747"/> is useful for auditing the security posture<a id="_idIndexMarker748"/> of our Azure instance. In Bash, enter <span class="No-Break">this command:</span></p>
			<pre class="source-code">
<strong class="bold">pip install scoutsuite</strong></pre>			<p>Various ScoutSuite components will be downloaded and installed. But if that doesn’t work properly, I recommend checking out the ScoutSuite page on GitHub (<a href="https://github.com/nccgroup/ScoutSuite">https://github.com/nccgroup/ScoutSuite</a>) for <span class="No-Break">additional help:</span></p>
			<div>
				<div id="_idContainer042" class="IMG---Figure">
					<img src="image/B18672_08_7.jpg" alt="Figure 8.7 – ScoutSuite installation process"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.7 – ScoutSuite installation process</p>
			<p>Now, let’s use the tools <span class="No-Break">we installed!</span></p>
			<h1 id="_idParaDest-154"><a id="_idTextAnchor153"/>Exploiting Azure applications</h1>
			<p>Now, let’s run some security tests<a id="_idIndexMarker749"/> with the tools <span class="No-Break">we’ve installed.</span></p>
			<h2 id="_idParaDest-155"><a id="_idTextAnchor154"/>Prowler</h2>
			<p>First, let’s run a default Prowler<a id="_idIndexMarker750"/> scan in Azure. The default scan is an effective general vulnerability assessment. Follow <span class="No-Break">these steps:</span></p>
			<ol>
				<li>Launch Azure Cloud Shell and make sure you’re using Bash. At the top left of the Azure Cloud Shell display, there’s a drop-down menu to switch back and forth between PowerShell and Bash. There <span class="No-Break">you go!</span></li>
				<li>I like to just make sure that Prowler is installed properly before I commence a scan. Check the version of Prowler you have with <span class="No-Break">this command:</span><pre class="source-code">
<strong class="bold">prowler -v</strong></pre></li>				<li>Next, let’s see which security checks you can run with Prowler in Azure with <span class="No-Break">this command:</span><pre class="source-code">
<strong class="bold">prowler azure --list-checks</strong></pre></li>				<li>Now, let’s run some of the checks that were listed as a response to the previous command. Make sure <strong class="source-inline">--az-cli-auth</strong> is at the end of your <strong class="source-inline">prowler azure</strong> command so that you can execute it with the <span class="No-Break">necessary permissions.</span><p class="list-inset">If you experience technical problems with IAM at the command line, you can check your IAM settings by visiting this page in another web browser tab (Make sure you’re logged <a id="_idIndexMarker751"/>in to your Azure administrative <span class="No-Break">account properly!):</span></p><p class="list-inset"><a href="https://portal.azure.com/#view/Microsoft_AAD_IAM/RolesManagementMenuBlade/~/AllRoles/adminUnitObjectId//resourceScope/%2F"><span class="No-Break">https://portal.azure.com/#view/Microsoft_AAD_IAM/RolesManagementMenuBlade/~/AllRoles/adminUnitObjectId//resourceScope/%2F</span></a></p></li>
				<li>Run a few checks from the <strong class="source-inline">--list-checks</strong> output, <span class="No-Break">like this:</span><pre class="source-code">
<strong class="bold">prowler azure --checks defender_ensure_defender_for_app_services_is_on defender_ensure_defender_for_storage_is_on storage_infrastructure_encryption_is_enabled --az-cli-auth</strong></pre><p class="list-inset">In between <strong class="source-inline">--checks</strong> and <strong class="source-inline">--az-cli-auth</strong>, you can input the names of any checks that are displayed as a result of the <strong class="source-inline">prowler azure --list-checks</strong> command. Give them a try! Try as many checks as <span class="No-Break">you want.</span></p><p class="list-inset">The result of the checks<a id="_idIndexMarker752"/> scan will print on screen according to whether they passed or failed. You can also acquire logs from your scan in HTML, CSV, and JSON formats by going to the <strong class="source-inline">/</strong><span class="No-Break"><strong class="source-inline">home/&lt;your_name_here&gt;/output/</strong></span><span class="No-Break"> directory.</span></p></li>				<li>Next, you can see which services you can scan with Prowler in Azure with <span class="No-Break">this command:</span><pre class="source-code">
<strong class="bold">prowler azure --list-services</strong></pre><p class="list-inset">The Azure services you can scan will output in a list at the <span class="No-Break">command line.</span></p></li>				<li>Next, let’s scan those services! Use a command <span class="No-Break">like this:</span><pre class="source-code">
<strong class="bold">prowler azure --services defender iam storage --az-cli-auth</strong></pre><p class="list-inset">Between <strong class="source-inline">--services</strong> and <strong class="source-inline">--az-cli-auth</strong>, you can enter the names of any services you’d like printed on screen from the <strong class="source-inline">prowler azure –</strong><span class="No-Break"><strong class="source-inline">list-services</strong></span><span class="No-Break"> command:</span></p></li>			</ol>
			<p>As with the checks <a id="_idIndexMarker753"/>scan, you can also acquire logs from your scan in HTML, CSV, and JSON formats by going to the <strong class="source-inline">/</strong><span class="No-Break"><strong class="source-inline">home/&lt;your_name_here&gt;/output/</strong></span><span class="No-Break"> directory.</span></p>
			<p>Let’s run an MFA check <span class="No-Break">with MFASweep.</span></p>
			<h2 id="_idParaDest-156"><a id="_idTextAnchor155"/>MFASweep</h2>
			<p>Making sure that MFA <a id="_idIndexMarker754"/>is enabled on all of the accounts linked to your (or your client’s) Azure instance is very important! Passwords are a relatively weak method of authentication. Passwords are frequently cracked or breached. Implementing MFA is crucial to ensuring that your accounts are still secure, even when cyber threat actors threaten your passwords. I use Microsoft Authenticator on my phone as my second factor of authentication. In cybersecurity speak, my password is “something I know,” while Microsoft Authenticator (via my phone) is “something I have.” If I were to implement some sort of biometrics, such as a fingerprint scanner, that’d be “something <span class="No-Break">I am.”</span></p>
			<p>Let’s execute MFASweep to check to see if the user accounts in Azure have MFA enabled. This command will make MFASweep <a id="_idIndexMarker755"/>check both my main Azure account and <strong class="bold">Active Directory Federation </strong><span class="No-Break"><strong class="bold">Services</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">ADFS</strong></span><span class="No-Break">):</span></p>
			<pre class="source-code">
<strong class="bold">Invoke-MFASweep -Username &lt;insert_username_of_account_email_address_here&gt;@&lt;insert_domain_name_here&gt; -Password &lt;insert_password_here&gt; -Recon -IncludeADFS</strong></pre>			<p>Notice how careful I am not to share my Azure credentials in that example! That’s the kind of thinking you need<a id="_idIndexMarker756"/> to use to be effective at cybersecurity. We call that <strong class="bold">OPSEC</strong>, otherwise known as <span class="No-Break"><strong class="bold">operational security</strong></span><span class="No-Break">.</span></p>
			<p>A new command line will be populated that starts with <strong class="source-inline">&gt;&gt;</strong>. I found that it took several minutes to see the results<a id="_idIndexMarker757"/> of my scan, so you may need to <span class="No-Break">be patient:</span></p>
			<div>
				<div id="_idContainer043" class="IMG---Figure">
					<img src="image/B18672_08_8.jpg" alt="Figure 8.8 – MFASweep scan results"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.8 – MFASweep scan results</p>
			<h2 id="_idParaDest-157"><a id="_idTextAnchor156"/>ScoutSuite</h2>
			<p>Now, it’s time to conduct<a id="_idIndexMarker758"/> a basic ScoutSuite scan in Azure. Your authentication credentials should already be set from using the <span class="No-Break">previous tools.</span></p>
			<p>Run the scan with the <span class="No-Break">following command:</span></p>
			<pre class="console">
scout azure --cli</pre>			<p>A number of actions will output at the command line, <span class="No-Break">like this:</span></p>
			<div>
				<div id="_idContainer044" class="IMG---Figure">
					<img src="image/B18672_08_9.jpg" alt="Figure 8.9 – ScoutSuite scanning at the command line"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.9 – ScoutSuite scanning at the command line</p>
			<p>When that’s all done, logs in JS, JSON, and HTML formats will be <span class="No-Break">written here:</span></p>
			<p><span class="No-Break"><strong class="source-inline">scoutsuite-report/scoutsuite-results/scoutsuite_results_azure-tenant-&lt;unique_identifier_here&gt;.&lt;file_extension_here&gt;</strong></span></p>
			<p>Prowler, MFASweep, and ScoutSuite should produce command-line output and logs that you will find very useful when pentesting Azure. Make sure to include these results in your pentest report<a id="_idIndexMarker759"/> and interpret them in your <span class="No-Break">own words.</span></p>
			<h1 id="_idParaDest-158"><a id="_idTextAnchor157"/>Summary</h1>
			<p>There are a number of handy tools you can use to check your security posture in Azure, run vulnerability scans, and conduct simple pentests. All of the information you can acquire from these tools can be useful to include in your <span class="No-Break">pentest report.</span></p>
			<p>Microsoft Defender for Cloud is your main security posture hub. It provides security recommendations, security alerts, attack path analysis, troubleshooters, and security configuration information. Azure Firewall Manager is also built in. Azure Firewall helps to allow and deny activity in your Azure instance. You definitely want to deny activity that could help a cyber <span class="No-Break">threat actor!</span></p>
			<p>The Azure Cloud Shell CLI can be executed in your web browser while you’re logged in to Azure’s web application. We can install and run third-party pentesting tools from Azure <span class="No-Break">Cloud Shell.</span></p>
			<p>Prowler is just as useful for pentesting Azure as it is for <span class="No-Break">pentesting AWS.</span></p>
			<p>MFASweep is specifically for Azure. It’s the most effective way to make sure MFA is set up to protect all accounts that have access to your <span class="No-Break">Azure instance.</span></p>
			<p>ScoutSuite is another tool with a lot of very useful scans and checks for Azure built <span class="No-Break">right in.</span></p>
			<p>In the next chapter, we’ll deploy containerized applications in Azure, and pentest <span class="No-Break">them too.</span></p>
			<h1 id="_idParaDest-159"><a id="_idTextAnchor158"/>Further reading</h1>
			<p>To learn more about the topics covered in this chapter, you can visit the <span class="No-Break">following links:</span></p>
			<ul>
				<li><em class="italic">A list of free services in </em><span class="No-Break"><em class="italic">Azure</em></span><span class="No-Break">: </span><a href="https://azure.microsoft.com/en-ca/free"><span class="No-Break">https://azure.microsoft.com/en-ca/free</span></a></li>
				<li><em class="italic">A cheat sheet with PowerShell </em><span class="No-Break"><em class="italic">commands</em></span><span class="No-Break">: </span><a href="https://www.comparitech.com/net-admin/powershell-cheat-sheet/"><span class="No-Break">https://www.comparitech.com/net-admin/powershell-cheat-sheet/</span></a></li>
				<li><em class="italic">Prowler </em><span class="No-Break"><em class="italic">documentation</em></span><span class="No-Break">: </span><a href="https://docs.prowler.cloud"><span class="No-Break">https://docs.prowler.cloud</span></a></li>
				<li><span class="No-Break"><em class="italic">MFASweep</em></span><span class="No-Break">: </span><a href="https://github.com/dafthack/MFASweep"><span class="No-Break">https://github.com/dafthack/MFASweep</span></a></li>
				<li><span class="No-Break"><em class="italic">ScoutSuite</em></span><span class="No-Break">: </span><a href="https://github.com/nccgroup/ScoutSuite"><span class="No-Break">https://github.com/nccgroup/ScoutSuite</span></a></li>
			</ul>
		</div>
	</body></html>