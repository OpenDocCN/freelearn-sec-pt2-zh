- en: '8'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Pentesting Azure Features through Serverless Applications and Tools
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the last chapter, we looked at the various SaaS, PaaS, and IaaS services
    Azure has to offer.
  prefs: []
  type: TYPE_NORMAL
- en: Now, it’s time to actually practice some vulnerability scanning and pentesting
    in your very own Azure deployment! This will be fun and educational. If you have
    gone through [*Chapter 5*](B18672_05.xhtml#_idTextAnchor080), *Pentesting AWS
    Features through Serverless Applications and Tools*, we’re going to be doing the
    same kind of work in this chapter, but in Azure.
  prefs: []
  type: TYPE_NORMAL
- en: This chapter features a step-by-step guide to using Azure’s own first-party
    security tools to check security configurations and conduct vulnerability assessments.
    The featured tools are Microsoft Defender for Cloud and Azure Firewall Manager.
    After that, we will learn how to configure the most popular third-party Azure
    pentesting tools. The featured tools are Prowler, MFASweep, and ScoutSuite. Lastly,
    we’ll have a look at the pentesting tutorials to find credentials, enumerate Azure
    services, conduct vulnerability scans, and discover exposed services with Prowler,
    MFASweep, and ScoutSuite.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following topics will be covered in this chapter:'
  prefs: []
  type: TYPE_NORMAL
- en: Setting up an Azure instance
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Setting up an Azure account
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using Azure Cloud Shell and PowerShell
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Azure native security tools
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Azure pentesting tools
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Exploiting Azure applications
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: So, let’s get into some practical exercises!
  prefs: []
  type: TYPE_NORMAL
- en: Technical requirements
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'We will be working with Microsoft’s infrastructure. Massive Azure data centers
    will be doing the bulk of the computer processing work for the exercises in this
    chapter. So, fortunately, you don’t need to have a top-of-the-line workstation.
    You will need the following:'
  prefs: []
  type: TYPE_NORMAL
- en: A web browser
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A desktop or laptop PC
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: An Android or iPhone smartphone
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A good, reliable internet connection
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Check out the following video to view the Code in Action: [https://bit.ly/3rUulqT](https://bit.ly/3rUulqT)'
  prefs: []
  type: TYPE_NORMAL
- en: Setting up an Azure instance
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Anyone can set up their own Microsoft Azure account. Many Azure services are
    free of charge. I strongly recommend deploying your own Azure instance to practice
    vulnerability scanning and pentesting in Azure before you do paid work for a client
    so that you can practice your skills. And chances are that your Azure test deployment
    is simpler than the Azure network the organization you work for operates!
  prefs: []
  type: TYPE_NORMAL
- en: Thanks to the magic of the cloud and the fact that the computer processing,
    data storage, and bandwidth are on Microsoft’s infrastructure, you don’t need
    to have a powerful workstation computer to try the exercises I will demonstrate
    in this chapter. A typical desktop or laptop PC with Windows, macOS, or Linux,
    good web functionality, and a modern web browser will do.
  prefs: []
  type: TYPE_NORMAL
- en: 'First, open your web browser and go to Microsoft’s guide to free Azure services
    ([https://azure.microsoft.com/en-ca/free](https://azure.microsoft.com/en-ca/free)).
    Here are most of the Azure services that are free as of the time of this writing
    in 2023:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Azure Active Directory** is always free, but you’re limited to 50,000 stored
    objects with a **single sign-on** (**SSO**) authentication interface. Again, this
    shouldn’t be a problem with your test deployment.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure Advisor** services are always free and unlimited. Advisor makes personalized
    recommendations and identifies best practices for using Azure.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: You get 12 months of **Anomaly Detector** services for free. Anomaly Detector
    uses **artificial intelligence** (**AI**) and **machine learning** (**ML**) to
    help you troubleshoot technical problems in Azure.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure App Configuration** is always free, but there’s a limit of 1,000 requests
    per day with 10 MB of storage. It’s very unlikely that your Azure test deployment
    will make more than 1,000 requests per day. App Configuration manages and stores
    the configurations of your Azure apps.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure App Service** is always free. App Service makes it possible to create
    apps for any platform or device using tools such as PHP and Node.js. You are limited
    to 10 apps with 1 GB of storage and 1 hour per day, though. This is unlikely to
    be an issue with your test deployment.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure DevOps** is always free but with a limit of five users. Azure DevOps
    facilitates building apps with CI/CD methodologies, using Git repositories. Basically,
    if your app needs to deploy several updates per day, Azure DevOps helps to make
    it happen.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure Files** is free for the first 12 months. It makes it possible to migrate
    your files across platforms without changing any code. But you’re limited to 100
    GB of **locally redundant storage** (**LRS**) transactions and 2 million file
    operations. That may be restrictive to some corporate clients, but it’s unlikely
    to be a problem with your test deployment. (LRS is about synchronously replicating
    data to three disks.)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure Kubernetes Service** (**AKS**) is always free. That’s very important
    because Kubernetes containerization is one of the most common use cases for cloud
    networks! You’ll learn about pentesting Kubernetes containerizations in Azure
    in [*Chapter 9*](B18672_09.xhtml#_idTextAnchor159).'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure Lighthouse** is always free. It allows you to manage different service
    providers interfacing with your Azure network under the Zero Trust network security
    model. Zero Trust is a more secure alternative to the old perimeter model of security.
    Instead of having a perimeter with your trusted computers inside, the internet
    and other untrusted computers outside, and authentication at the perimeter, Zero
    Trust creates authentication vectors at all possible points and distrusts all
    unauthenticated data transmissions by default, even if they’re coming from inside
    your own network.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure Maps** is an equivalent to Google Maps in the Azure ecosystem. It has
    many APIs and features and integrates natively with all Azure applications. You
    can do things with custom embedded maps on your own mobile, desktop, and web applications
    alike. Using Azure Maps in the applications you develop is always free, but you’re
    limited to 1,000 to 5,000 transactions for specific mapping and location insights
    features.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure Migrate** is always free. It helps you migrate your **virtual machines**
    (**VMs**) from your premises or other cloud platforms to Azure.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure Policy** helps you comply with data privacy and cybersecurity regulations.
    This is likely more of an issue for your employer than for your Azure test deployment.
    But you do get free access to configuration and change tracking features.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: You get 15 GB of outbound data transfer bandwidth free for the first 12 months,
    and 100 GB of inbound data transfer for free always.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '**Blobs** are a kind of unstructured data object. You get 5 GB of LRS storage
    in Blob Storage, with 20,000 read and 10,000 write operations for free for the
    first 12 months. But I don’t anticipate you using Blob Storage for your test deployment
    anyway.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: As far as **Cloud Shell** is concerned, you get 5 GB of free storage in Azure
    Files for free for the first 12 months. It’s the Azure equivalent of AWS CloudShell,
    which I demonstrated in *Chapters 5* and *6*. Having access to a CLI in your web
    browser is very important, and you almost certainly will be using Azure Cloud
    Shell in your Azure test deployment too!
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Container Apps** is always free but with some limits. Container Apps makes
    it possible to deploy apps and microservices in serverless containers, and you’re
    limited to 180,000 vCPU seconds, 360,000 GiB seconds, and 2 million requests.
    That’s unless you’re ready to pay extra.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Container Registry** stores and manages your container images throughout
    Azure’s ecosystem. It’s free for the first 12 months, but you’re limited to one
    Standard tier registry with 100 GB storage and 10 webhooks.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Cost Management** is always free. So, you won’t be paying extra to save money
    and optimize your Azure cloud services expenses with full visibility into your
    expenditures. And of course, if you always stay within the free services and their
    limits, then there won’t be any expenditures in the first place! But you can always
    check with Cost Management anyway.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Database Migration Service** makes it easier to migrate databases from on-premises
    servers to the cloud. It’s unlikely you’ll be doing that with your test deployment,
    but the Free Standard Compute level is always free.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**DevTest Labs** enables developers to test their work in dev/test environments.
    It’s always free.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Event Grid** assures reliable event delivery at a massive scale, to facilitate
    service integration. It’s always free, but you’re limited to 100,000 operations
    per month. You should be fine!'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Functions** makes it possible to process events with a serverless code architecture.
    Just in case you want to use it, 1 million requests are always free.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Key Vault** safely stores the encryption keys you use in your Azure services.
    Its services are free for the first 12 months, but you’re limited to 10,000 transactions,
    RSA 2048-bit keys, or secret operations at the Standard tier.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: You get some amount of **Linux VMs** for free for the first 12 months. The limit
    is 750 hours of B1s burstable VMs.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Load Balancer** assures that the usage of your Azure deployment is balanced
    across servers according to demands at any given time. For the first 12 months,
    you get 750 hours, 15 GB of data processing, and up to five rules with Standard
    Load Balancer.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Managed Disks** is a service used for Azure Virtual Machines block storage.
    For the first 12 months, you get 2 drives of 64 GB SSD storage, plus 1 GB snapshot
    and 2 million I/O operations for free. Anything more is going to cost you!'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Media Services** makes it possible for you to deploy streaming media to any
    kind of device, such as streaming video or audio. It’s unlikely that you’ll be
    doing that with your test deployment. But just in case, you get 5 hours each of
    Standard Passthrough, Live Transcription, and Standard Streaming endpoints free
    for the first 12 months.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Monitor** gives you full visibility and observability into your applications,
    infrastructure, and network. There are different limits per feature, but otherwise,
    it’s always free.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Network Watcher** helps you monitor, diagnose, and otherwise understand your
    network performance in Azure. It’s always free, but you’re limited to 5 GB storage
    with 1,000 checks, 10 tests, and 10 connection metrics.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Notification Hubs** allows you to send push notifications to any mobile device
    (iOS and Android). You’re limited to 1 million push notifications, but that much
    is free. This should only be a concern if you’re using your Azure instance to
    deploy mobile apps, though.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Private Link** lets you privately access your Azure services from any of
    your own endpoints. It’s always free.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Resource Manager** lets you see how your app resources are being used and
    enables you to manage it all. It’s always free.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Security Center** makes it possible to prevent, detect, and respond to threats
    across all your Azure deployments. Policy assessments and recommendations are
    always free!'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It’s highly likely that your web apps and other database-driven apps will need
    **SQL Database**. For the first 12 months, you get a 250 GB S0 instance with 10
    database transaction units for free.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**SQL Server 2019 Developer Edition** makes it possible to build, test, and
    demonstrate applications outside of your production environment. It’s always free.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: You also get some amount of **Windows VMs** for free for the first 12 months.
    Again, the limit is 750 hours of B1s burstable VMs.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: You get 50 instances of **Virtual Network** for free, always. But that’s for
    provisioning private networks and connecting them to a data center that’s on your
    premises. That’s not likely something you’ll need for your test deployment.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**VPN Gateway** makes it possible to deploy VPNs across data centers and cloud
    services. That encrypts your data in transit in a very effective way. You get
    750 hours for free for the first 12 months. But that’s probably a service that’s
    much more useful for the organization that you’re working for than for your Azure
    test deployment.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Let’s deploy an Azure instance for you to use for testing purposes.
  prefs: []
  type: TYPE_NORMAL
- en: Setting up an Azure account
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Everything you need to do to launch your first Azure instance to practice your
    pentesting skills can be done from your web browser. Here’s how:'
  prefs: []
  type: TYPE_NORMAL
- en: 'While you’re on the Azure free services web page ([https://azure.microsoft.com/en-ca/free](https://azure.microsoft.com/en-ca/free)),
    click on the green **Start** **free** button:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 8.1 – Azure free account creation page](image/B18672_08_1.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 8.1 – Azure free account creation page
  prefs: []
  type: TYPE_NORMAL
- en: You’ll be taken to a screen to sign in to a Microsoft account. If you use Windows
    10 or Windows 11 at home, chances are you already have a Microsoft account. You
    can choose to use your existing Microsoft account, create a new Microsoft account
    (which you may do even if you already have another Microsoft account), or sign
    in with your GitHub credentials if you have them.
  prefs: []
  type: TYPE_NORMAL
- en: 'I decided to use a Microsoft account that I already have. I’m cautious when
    it comes to cybersecurity, so I already had **multi-factor authentication** (**MFA**)
    set up on my Android phone with Microsoft Authenticator. I used my password and
    a code sent to my phone through Microsoft Authenticator, and I was logged in.
    Microsoft Authenticator is free for both Android and iOS, and I strongly recommend
    using it for your Azure services. Here’s where you can learn more about Microsoft
    Authenticator: [https://www.microsoft.com/en-ca/security/mobile-authenticator-app](https://www.microsoft.com/en-ca/security/mobile-authenticator-app).'
  prefs: []
  type: TYPE_NORMAL
- en: Just to make sure there’s no confusion, I use my phone for Microsoft Authenticator,
    but I use my Windows 11 laptop to work with Azure through its web interfaces.
    It’s not very practical to manage your cloud services from your phone. Fortunately,
    a MacBook or a Linux PC works just as well as a Windows PC for this work.
  prefs: []
  type: TYPE_NORMAL
- en: Once I logged in, I was taken to a form where I entered my name, my region (in
    my case, Canada), and my phone number. I even got $200 USD of credit to use in
    my first 30 days! Thank you, Microsoft. My phone number was confirmed via an SMS
    text message. Then, I entered my home mailing address and agreed to the customer
    agreement. At the bottom of the form, click on **Next**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Then, you’ll see a screen where you enter your credit card information. Even
    if you’re using free services, this step is mandatory. Your card will be charged
    if you incur any number of paid services or consume over your free services limits.
    I recommend using Azure’s Cost Management app to watch that carefully!
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: At the bottom, click on the blue **Sign** **up** button.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Wait a few moments, and your account will be set up. Then, you’ll see a screen
    that says **You’re ready to start with Azure**. Click on the blue button that
    says **Go to the Azure portal**. It sounds very exciting! We’re going on a cloud
    services journey together.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The QuickStart Center will show you a lot of different options for you to get
    started. You can take an online course, follow setup guides, or start a project.
    The project options under the **Projects and guides** tab are:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '**Create a** **web app**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Deploy a** **virtual machine**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Deploy and run a** **container-based app**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Set up** **a database**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Get started with data analytics, machine learning,** **and intelligence**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Store, back up, or** **archive data**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Build, deploy, and operate a** **serverless app**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'You can see an overview of this here:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![Figure 8.2 – Microsoft Azure Quickstart Center](image/B18672_08_2.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 8.2 – Microsoft Azure Quickstart Center
  prefs: []
  type: TYPE_NORMAL
- en: For now, let’s deploy a VM. (We’ll deploy and run a container-based app in [*Chapter
    9*](B18672_09.xhtml#_idTextAnchor159).)
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, you’ll be given the option to create a Windows VM or a Linux VM:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 8.3 – Screen to deploy a VM from Quickstart Center](image/B18672_08_3.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 8.3 – Screen to deploy a VM from Quickstart Center
  prefs: []
  type: TYPE_NORMAL
- en: Because I used a Linux VM in the AWS chapter, we’ll shake things up and choose
    a Windows VM here. But if you create a Linux VM, you can use the Linux Bash commands
    at the CLI that I used in [*Chapter 5*](B18672_05.xhtml#_idTextAnchor080) for
    AWS.
  prefs: []
  type: TYPE_NORMAL
- en: 'The next screen says **Create a virtual machine** at the top. You’ll have a
    form to fill out:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Under **Project details**, leave the subscription as default or **Azure subscription
    1**. Under resource group, leave it at **(New)** **Resource group**.
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Under **Instance details**, give VM an original name that you’ll remember. I
    entered **PentestingWindowsVM**. Spaces and special characters aren’t allowed!
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: I chose **(US) East US** as my region. But you can choose any region that you’d
    like. It doesn’t even need to be near your physical location. You can be in India
    and choose **(Europe) Norway East** if you want!
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Under **Availability options**, I chose **No infrastructure redundancy required**.
    That’s your safest bet if you want to avoid service charges. However, the organization
    you work for has much greater needs than your test deployment and would probably
    choose a different option.
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Under **Security type**, I chose **Standard**. That’s the safest bet for your
    own test deployment to avoid service charges, but a business, institution, or
    enterprise should probably choose a greater security level.
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: I left the default Windows Server 2016 Datacenter as my image. x64 is the only
    VM architecture option for that image. Besides, ARM64 isn’t a free service option.
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: I chose the smallest possible size (1 vCPU, 3.5 GiB memory for $91.98 per month).
    I’m only going to be using my instance for a month, and this will fit into my
    $200 USD of free credit. Fingers crossed! You don’t need a large size for your
    own test deployment.
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: On the next screen, create a username and password for your administrator account.
    Make sure your password is strong! I used a password manager to generate a complex
    password with lots of characters. I recommend using a password manager too, perhaps
    one built into your web browser. Then, you won’t have to remember your complex
    passwords.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the next screen, I disabled public inbound ports. Then, at the bottom left,
    I clicked on the blue **Review + create** button because I decided to leave the
    rest of the defaults for **Disks**, **Networking**, **Management**, and **Monitoring**.
    Your view may look similar or a little different. Look at the words on your screen
    carefully. I plan to cancel my Azure account in about a month. But if you need
    to keep your Azure test deployment longer, then I recommend clicking on **Next**
    instead of **Review + create** and consider your options carefully.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: If the options on your screen look good, click on the blue **Create** button
    in the lower-left corner. Otherwise, click on the **Previous** button to change
    your configuration accordingly.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: It takes a few moments for your deployment to be ready. Be patient!
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Your mileage may vary. But for me, my deployment took about a minute to take
    effect. Then, the screen said **Your deployment is complete**. So, I clicked on
    the blue **Go to** **resource** button.
  prefs: []
  type: TYPE_NORMAL
- en: In [*Chapter 9*](B18672_09.xhtml#_idTextAnchor159), we will pentest the VM we
    just deployed.
  prefs: []
  type: TYPE_NORMAL
- en: If you’re really technical, you’ll love the screen that appears after clicking
    **Go to resource**. You can browse all of the technicalities of your VM and other
    Azure services. But for now, let’s get into Azure Cloud Shell.
  prefs: []
  type: TYPE_NORMAL
- en: Using Azure Cloud Shell and PowerShell
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Wherever you are in the web interface for managing your Azure services (the
    URL in your address bar should say **portal.azure.com**), as long as you’re logged
    in, there will be a blue menu bar at the top. To the right of the search bar,
    there’s an icon that looks like a command prompt (something like this: **>_**):'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.4 – Azure menu bar and Cloud Shell](image/B18672_08_4.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 8.4 – Azure menu bar and Cloud Shell
  prefs: []
  type: TYPE_NORMAL
- en: 'Click on it to launch Azure Cloud Shell. In Azure Cloud Shell, you can switch
    back and forth between PowerShell and Bash at the drop-down menu in the top-left
    corner. You may have to choose **Create storage** the first time you launch Cloud
    Shell:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.5 – Azure Cloud Shell screen](image/B18672_08_5.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 8.5 – Azure Cloud Shell screen
  prefs: []
  type: TYPE_NORMAL
- en: 'You’ll find some Bash commands in [*Chapter 5*](B18672_05.xhtml#_idTextAnchor080),
    *Pentesting AWS Features through Serverless Applications and Tools*. We will be
    using Bash when installing and executing the tools in this chapter. But let’s
    review some useful PowerShell commands that you can use at the Azure Cloud Shell
    CLI. They’re handy to know, and you may need to use PowerShell commands when conducting
    some other activities in Azure Cloud Shell:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Similar to Bash, you can use the following commands to change which directory
    you have open:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**cd**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**chdir**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Copy an item with one of the following commands before the filename of the
    item you’re copying:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**copy**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**cp**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'You can move an item with any of the following commands. You’ll also need to
    enter the file path and filename that you’re moving and the destination file path
    in the command:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**mi**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**move**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**mv**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Remove an item with one of the following commands and the name of the file
    or files you’d like to remove. Remember, this will delete your files:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**del**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**erase**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**rd**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**ri**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**rm**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'This command will remove an entire directory. Be careful when you use it:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**rmdir**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'If you want to create a new item, use the following command. I’ll usually only
    use it for text-based documents that can be modified in Notepad, though. Using
    this command will create an empty file with the filename you choose in your command:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**ni**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Set a new value on an item with this command:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**si**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: For instance, you can enter **si path <string>** to a string or **si value <object>**
    to an object, such as [https://ss64.com/ps/set-item.html](https://ss64.com/ps/set-item.html).
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Start a background job (executable task) with this command:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**sajb**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Suspend the job with this command:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**sujb**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Resume the job with this command:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**rujb**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Start a stopped service:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**sasv**'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'In Azure Cloud Shell, whether you run PowerShell or Bash, the following guide
    will be displayed the moment you launch Cloud Shell. The commands I’ve shown here
    so far work in the Azure CLI, and checking out the built-in help guide is always
    a good use of your time:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: Up next, let us take a look at some of the native Azure security tools.
  prefs: []
  type: TYPE_NORMAL
- en: Azure native security tools
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Here’s what’s built into Azure that can help you with security.
  prefs: []
  type: TYPE_NORMAL
- en: Microsoft Defender
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Microsoft Defender for Cloud is an important application for checking your security
    posture in Azure. It will give you security recommendations based on your current
    configuration and let you know about some of the security vulnerabilities you
    have. This is information that you can use in your pentest report.
  prefs: []
  type: TYPE_NORMAL
- en: 'Let’s open Microsoft Defender and see what we can learn about how secure our
    Azure deployment is:'
  prefs: []
  type: TYPE_NORMAL
- en: To execute the application, first, make sure that you’re logged in to your Azure
    account in your web browser. Visit [portal.azure.com](http://portal.azure.com).
    You should then see this screen.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Next, at the blue menu bar at the top, enter **Defender** in the search bar.
    A link to Microsoft Defender for Cloud should populate. Click on it.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: You may need to add Microsoft Defender for Cloud as a paid service. If you haven’t
    signed up for it already, there will be a handy **Upgrade** button on the main
    page of the application. Be careful to check the subscription fees before you
    commit!
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Once you’re in Microsoft Defender for Cloud, there will be a menu on the left-hand
    side with a number of different sections (*Figure 8**.6*). They represent different
    tools for understanding your security posture in Azure:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Recommendations** will show you some security improvement recommendations,
    classified as **High**, **Medium**, and **Low** in severity.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Attach path analysis** will show if Defender has identified an attack path
    to your Azure instance that a threat actor could use. Hopefully, this page will
    say **No attack paths were found**. Whether or not an attack path was found, you
    can include this information in your pentest report.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Security alerts** is similar to **Recommendations**. Alerts are classified
    as **High**, **Medium**, and **Low** in severity.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Cloud Security Explorer** will show you a bunch of query templates you can
    execute:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Internet-exposed VMs
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Internet-exposed VMs with high-severity vulnerabilities
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: VMs vulnerable to a specific vulnerability
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Internet-exposed SQL servers with managed identity
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: User accounts without MFA and with permissions to storage accounts
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Azure Kubernetes pods running images with high-severity vulnerabilities
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Key Vault keys and secrets without any expiration period
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: User accounts with permission to vulnerable VMs
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Internet-exposed SQL servers tagged as production
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: External users with permission to SQL VMs that allow code execution on the host
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: VMs with Log4Shell vulnerability that has permissions to storage accounts
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Kubernetes namespaces that contain vulnerable pods
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Internet-exposed **Simple Storage Service** (**S3**) buckets with sensitive
    data that allow public access
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Internet-exposed storage account containers with sensitive data that allow public
    access
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Diagnose and solve problems** offers a number of automated troubleshooters
    to resolve issues in these areas:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Defender **cloud security posture management** (**CSPM**) plan
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Defender for servers
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Onboarding and settings
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Pricing, billing, and usage
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Secure score and recommendations
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Security alerts
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Vulnerability** **assessment** (**VA**)'
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: The latter two troubleshooters should be especially useful for you to make sure
    your security alerts and vulnerability assessments work properly!
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Under **Cloud Security**, **Security posture** will present an overview with
    a secure score and environment indicators (Management groups, Subscriptions, Unhealthy
    resources, and Recommendations). You can also generate a governance report from
    the top of the screen. This data may be useful to include in your pentest report.
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: From the left menu in Microsoft Defender for Cloud, you can also view **Azure
    Firewall Manager**, which will show you monitoring reports and overviews.
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: You can also manage **Azure Firewall Policies**, **distributed denial-of-service**
    (**DDoS**) **Protection Plans**, and **Web Application** **Firewall Policies**.
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: In the next section, I’ll walk you through the installation processes we’ll
    use when we exploit our own Azure test deployments.
  prefs: []
  type: TYPE_NORMAL
- en: Azure pentesting tools
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the previous chapter, I listed several different third-party applications
    that you can use when you pentest Azure.
  prefs: []
  type: TYPE_NORMAL
- en: Everything that I’ll demonstrate here is permitted under Microsoft’s policies,
    as long as you’re either conducting these activities in your own Azure instance
    or you have permission from the owner of the Azure instance you’re working with
    to conduct vulnerability scanning and pentesting there.
  prefs: []
  type: TYPE_NORMAL
- en: But I believe there’s no such thing as being too cautious. So, I’m linking to
    Microsoft’s policies again ([https://www.microsoft.com/en-us/msrc/pentest-rules-of-engagement](https://www.microsoft.com/en-us/msrc/pentest-rules-of-engagement)).
    Please read and understand those policies so that you can abide by them, whether
    or not the Azure instance you’re working in is yours, because ultimately, you’re
    still working in Microsoft’s infrastructure either way!
  prefs: []
  type: TYPE_NORMAL
- en: Prowler
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In the AWS section ([*Chapter 5*](B18672_05.xhtml#_idTextAnchor080)), we found
    Prowler to be a very useful vulnerability scanning tool. Prowler is also good
    for vulnerability scanning in Azure, so I’ll walk you through Prowler’s installation
    process in Azure:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Launch Azure Cloud Shell by looking to the right of the search bar at the top.
    There’s an icon that looks like a command prompt (something like this: **>_**).'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on it!
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Instead of launching the PowerShell CLI in Azure Cloud Shell, we’ll need to
    run Bash instead. At the top left of the Azure Cloud Shell display, there’s a
    drop-down menu to switch back and forth between PowerShell and Bash. Make sure
    Bash is selected.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'We’re going to use **pip** to install Prowler, so it might be useful to make
    sure the version of **pip** that you have installed in Azure is up to date. Try
    this command first:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Now, we’re going to install Prowler with one simple command. First, make sure
    you’re in your home directory or the directory you’d like to run and install Prowler
    in. Use the **cd** command if you need to do so. Then, use **pip** to install
    Prowler, like this:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: You’ll see the various Prowler components downloaded at the command line, and
    then all of the necessary packages should be installed. Hopefully, you will be
    good to go! If you need more help, check out the official Prowler documentation
    ([https://docs.prowler.cloud/en/latest/](https://docs.prowler.cloud/en/latest/))
    and the official pip documentation ([https://pip.pypa.io/en/stable/](https://pip.pypa.io/en/stable/)).
  prefs: []
  type: TYPE_NORMAL
- en: Next, let’s install MFASweep ([https://github.com/dafthack/MFASweep](https://github.com/dafthack/MFASweep)).
  prefs: []
  type: TYPE_NORMAL
- en: MFASweep
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '**MFASweep** is a PowerShell script that attempts to log in to various Microsoft
    services using a provided set of credentials and will attempt to identify if MFA
    is enabled. It’s very important for all user accounts in Azure to have MFA enabled
    to protect those accounts from cyber attackers.'
  prefs: []
  type: TYPE_NORMAL
- en: Let’s install it!
  prefs: []
  type: TYPE_NORMAL
- en: In another web browser tab, make sure you’re logged in to your GitHub account
    at [github.com](http://github.com). If necessary, create a new GitHub account.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Next, run this command to link your GitHub account to your Azure account. You
    may need to add a **one-time password** (**OTP**) in order to do so. If that’s
    the case, an OTP for you to enter into GitHub (in the other web browser tab) will
    be generated:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Now, enter this command to use Git to install MFASweep:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: '![Figure 8.6 – MFASweep installation process in Azure](image/B18672_08_6.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 8.6 – MFASweep installation process in Azure
  prefs: []
  type: TYPE_NORMAL
- en: In the preceding screenshot, you can see the GitHub repository cloning process
    and installation of MFASweep at the command line.
  prefs: []
  type: TYPE_NORMAL
- en: ScoutSuite
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Now, let’s install ScoutSuite. ScoutSuite is useful for auditing the security
    posture of our Azure instance. In Bash, enter this command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'Various ScoutSuite components will be downloaded and installed. But if that
    doesn’t work properly, I recommend checking out the ScoutSuite page on GitHub
    ([https://github.com/nccgroup/ScoutSuite](https://github.com/nccgroup/ScoutSuite))
    for additional help:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.7 – ScoutSuite installation process](image/B18672_08_7.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 8.7 – ScoutSuite installation process
  prefs: []
  type: TYPE_NORMAL
- en: Now, let’s use the tools we installed!
  prefs: []
  type: TYPE_NORMAL
- en: Exploiting Azure applications
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Now, let’s run some security tests with the tools we’ve installed.
  prefs: []
  type: TYPE_NORMAL
- en: Prowler
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'First, let’s run a default Prowler scan in Azure. The default scan is an effective
    general vulnerability assessment. Follow these steps:'
  prefs: []
  type: TYPE_NORMAL
- en: Launch Azure Cloud Shell and make sure you’re using Bash. At the top left of
    the Azure Cloud Shell display, there’s a drop-down menu to switch back and forth
    between PowerShell and Bash. There you go!
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'I like to just make sure that Prowler is installed properly before I commence
    a scan. Check the version of Prowler you have with this command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Next, let’s see which security checks you can run with Prowler in Azure with
    this command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Now, let’s run some of the checks that were listed as a response to the previous
    command. Make sure **--az-cli-auth** is at the end of your **prowler azure** command
    so that you can execute it with the necessary permissions.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'If you experience technical problems with IAM at the command line, you can
    check your IAM settings by visiting this page in another web browser tab (Make
    sure you’re logged in to your Azure administrative account properly!):'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[https://portal.azure.com/#view/Microsoft_AAD_IAM/RolesManagementMenuBlade/~/AllRoles/adminUnitObjectId//resourceScope/%2F](https://portal.azure.com/#view/Microsoft_AAD_IAM/RolesManagementMenuBlade/~/AllRoles/adminUnitObjectId//resourceScope/%2F)'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Run a few checks from the **--list-checks** output, like this:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: In between **--checks** and **--az-cli-auth**, you can input the names of any
    checks that are displayed as a result of the **prowler azure --list-checks** command.
    Give them a try! Try as many checks as you want.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: The result of the checks scan will print on screen according to whether they
    passed or failed. You can also acquire logs from your scan in HTML, CSV, and JSON
    formats by going to the **/****home/<your_name_here>/output/** directory.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Next, you can see which services you can scan with Prowler in Azure with this
    command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The Azure services you can scan will output in a list at the command line.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Next, let’s scan those services! Use a command like this:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Between **--services** and **--az-cli-auth**, you can enter the names of any
    services you’d like printed on screen from the **prowler azure –****list-services**
    command:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: As with the checks scan, you can also acquire logs from your scan in HTML, CSV,
    and JSON formats by going to the **/****home/<your_name_here>/output/** directory.
  prefs: []
  type: TYPE_NORMAL
- en: Let’s run an MFA check with MFASweep.
  prefs: []
  type: TYPE_NORMAL
- en: MFASweep
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Making sure that MFA is enabled on all of the accounts linked to your (or your
    client’s) Azure instance is very important! Passwords are a relatively weak method
    of authentication. Passwords are frequently cracked or breached. Implementing
    MFA is crucial to ensuring that your accounts are still secure, even when cyber
    threat actors threaten your passwords. I use Microsoft Authenticator on my phone
    as my second factor of authentication. In cybersecurity speak, my password is
    “something I know,” while Microsoft Authenticator (via my phone) is “something
    I have.” If I were to implement some sort of biometrics, such as a fingerprint
    scanner, that’d be “something I am.”
  prefs: []
  type: TYPE_NORMAL
- en: 'Let’s execute MFASweep to check to see if the user accounts in Azure have MFA
    enabled. This command will make MFASweep check both my main Azure account and
    **Active Directory Federation** **Services** (**ADFS**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: Notice how careful I am not to share my Azure credentials in that example! That’s
    the kind of thinking you need to use to be effective at cybersecurity. We call
    that **OPSEC**, otherwise known as **operational security**.
  prefs: []
  type: TYPE_NORMAL
- en: 'A new command line will be populated that starts with **>>**. I found that
    it took several minutes to see the results of my scan, so you may need to be patient:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.8 – MFASweep scan results](image/B18672_08_8.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 8.8 – MFASweep scan results
  prefs: []
  type: TYPE_NORMAL
- en: ScoutSuite
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Now, it’s time to conduct a basic ScoutSuite scan in Azure. Your authentication
    credentials should already be set from using the previous tools.
  prefs: []
  type: TYPE_NORMAL
- en: 'Run the scan with the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'A number of actions will output at the command line, like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.9 – ScoutSuite scanning at the command line](image/B18672_08_9.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 8.9 – ScoutSuite scanning at the command line
  prefs: []
  type: TYPE_NORMAL
- en: 'When that’s all done, logs in JS, JSON, and HTML formats will be written here:'
  prefs: []
  type: TYPE_NORMAL
- en: '**scoutsuite-report/scoutsuite-results/scoutsuite_results_azure-tenant-<unique_identifier_here>.<file_extension_here>**'
  prefs: []
  type: TYPE_NORMAL
- en: Prowler, MFASweep, and ScoutSuite should produce command-line output and logs
    that you will find very useful when pentesting Azure. Make sure to include these
    results in your pentest report and interpret them in your own words.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: There are a number of handy tools you can use to check your security posture
    in Azure, run vulnerability scans, and conduct simple pentests. All of the information
    you can acquire from these tools can be useful to include in your pentest report.
  prefs: []
  type: TYPE_NORMAL
- en: Microsoft Defender for Cloud is your main security posture hub. It provides
    security recommendations, security alerts, attack path analysis, troubleshooters,
    and security configuration information. Azure Firewall Manager is also built in.
    Azure Firewall helps to allow and deny activity in your Azure instance. You definitely
    want to deny activity that could help a cyber threat actor!
  prefs: []
  type: TYPE_NORMAL
- en: The Azure Cloud Shell CLI can be executed in your web browser while you’re logged
    in to Azure’s web application. We can install and run third-party pentesting tools
    from Azure Cloud Shell.
  prefs: []
  type: TYPE_NORMAL
- en: Prowler is just as useful for pentesting Azure as it is for pentesting AWS.
  prefs: []
  type: TYPE_NORMAL
- en: MFASweep is specifically for Azure. It’s the most effective way to make sure
    MFA is set up to protect all accounts that have access to your Azure instance.
  prefs: []
  type: TYPE_NORMAL
- en: ScoutSuite is another tool with a lot of very useful scans and checks for Azure
    built right in.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we’ll deploy containerized applications in Azure, and pentest
    them too.
  prefs: []
  type: TYPE_NORMAL
- en: Further reading
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'To learn more about the topics covered in this chapter, you can visit the following
    links:'
  prefs: []
  type: TYPE_NORMAL
- en: '*A list of free services in* *Azure*: [https://azure.microsoft.com/en-ca/free](https://azure.microsoft.com/en-ca/free)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*A cheat sheet with PowerShell* *commands*: [https://www.comparitech.com/net-admin/powershell-cheat-sheet/](https://www.comparitech.com/net-admin/powershell-cheat-sheet/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Prowler* *documentation*: [https://docs.prowler.cloud](https://docs.prowler.cloud)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*MFASweep*: [https://github.com/dafthack/MFASweep](https://github.com/dafthack/MFASweep)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*ScoutSuite*: [https://github.com/nccgroup/ScoutSuite](https://github.com/nccgroup/ScoutSuite)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
