<html><head></head><body>
		<div id="_idContainer067">
			<h1 id="_idParaDest-197" class="chapter-number"><a id="_idTextAnchor197"/>11</h1>
			<h1 id="_idParaDest-198"><a id="_idTextAnchor198"/>Pentesting GCP Features through Serverless Applications and Tools</h1>
			<p>Now that we’ve learned <a id="_idIndexMarker929"/>a bit about the various services that <strong class="bold">Google Cloud Platform</strong> (<strong class="bold">GCP</strong>) has to offer, it’s time to start our own GCP deployment and learn about some GCP pentesting tools through <span class="No-Break">hands-on practice.</span></p>
			<p>We will install and execute some pentesting tools in the GCP virtual machine we set up in <a href="B18672_10.xhtml#_idTextAnchor172"><span class="No-Break"><em class="italic">Chapter 10</em></span></a>. They include Prowler, GCPBucketBrute, and GCP Scanner. We’ll also look at the security tools that Google provides for us in Security <span class="No-Break">Command Center.</span></p>
			<p>This chapter will cover the <span class="No-Break">following topics:</span></p>
			<ul>
				<li>GCP <span class="No-Break">free tier</span></li>
				<li>Launching a <span class="No-Break">GCP network</span></li>
				<li>Using GCP <span class="No-Break">Cloud Shell</span></li>
				<li>GCP native <span class="No-Break">security tools</span></li>
				<li>GCP <span class="No-Break">pentesting tools</span></li>
				<li>Exploiting <span class="No-Break">GCP applications</span></li>
			</ul>
			<p>Let’s <span class="No-Break">get started!</span></p>
			<h1 id="_idParaDest-199"><a id="_idTextAnchor199"/>Technical requirements</h1>
			<p>We will be working with Google’s infrastructure. Massive GCP data centers will be doing the bulk of the computer processing work for the exercises in this chapter. So, fortunately, you don’t need to have a top-of-the-line workstation. You will need <span class="No-Break">the following:</span></p>
			<ul>
				<li>A <span class="No-Break">web browser</span></li>
				<li>A desktop or <span class="No-Break">laptop PC</span></li>
				<li>An Android phone <span class="No-Break">or iPhone</span></li>
				<li>A good reliable <span class="No-Break">internet connection</span></li>
			</ul>
			<p>Check out the following video to view the Code in <span class="No-Break">Action: </span><a href="https://bit.ly/4093wMk"><span class="No-Break">https://bit.ly/4093wMk</span></a></p>
			<h1 id="_idParaDest-200"><a id="_idTextAnchor200"/>GCP free tier</h1>
			<p>I strongly recommend setting up your own GCP network to test out the exercises in this chapter and <a href="B18672_12.xhtml#_idTextAnchor215"><span class="No-Break"><em class="italic">Chapter 12</em></span></a><span class="No-Break">.</span></p>
			<p>There are several GCP products and services that you can enjoy in the free tier without incurring <a id="_idIndexMarker930"/>charges to your account. Do keep in mind though that you will need to give GCP your credit card number when you sign up. Your credit card will be charged if you go over the free tier limits, so you must check your usage and billing very carefully. When I signed up, I was given a 300 USD free credit for service fees in the first 90 days of my subscription. Depending on when you sign up, where in the world you sign up from, and the specifics of your situation, you may or may not receive a similar credit. Later in this chapter, I will show you where you can check your billing status so that you can make sure you don’t incur service charges that you can’t afford or otherwise wouldn’t want to <span class="No-Break">pay for.</span></p>
			<p>As of this writing in 2023, here are the services that are available in GCP’s free tier, as well as their <span class="No-Break">limits (</span><a href="https://cloud.google.com/free/docs/free-cloud-features"><span class="No-Break">https://cloud.google.com/free/docs/free-cloud-features</span></a><span class="No-Break">):</span></p>
			<ul>
				<li><strong class="bold">Compute Engine</strong> is the service that powers virtual machines on GCP. The free tier includes <a id="_idIndexMarker931"/>one e2-micro <a id="_idIndexMarker932"/>instance per month. That means “<em class="italic">1 non-preemptible e2-micro VM instance per month in one of the following US regions: us-west1, us-central1, us-east1. 30 GB-months standard persistent disk. 1 GB network egress from North America to all region destinations (excluding China and Australia) per month</em>” (<a href="https://cloud.google.com/free/docs/free-cloud-features?hl=en#compute">https://cloud.google.com/free/docs/free-cloud-features?hl=en#compute</a>). Remember that the regions are where GCP’s data centers are. <em class="italic">You</em> don’t have to physically be in the United States. You and your laptop can be in Brazil, India, Ethiopia, or any country that can connect to GCP services. So long as the GCP data center you’re using is in <strong class="source-inline">us-west1</strong>, <strong class="source-inline">us-central1</strong>, <strong class="source-inline">or us-east1</strong>, <span class="No-Break">you’re covered.</span></li>
				<li><strong class="bold">Cloud Storage</strong> is the main service for storing your data. 5 GB per month is included in <a id="_idIndexMarker933"/>the free tier. What <a id="_idIndexMarker934"/>does 5 GB per month mean? “<em class="italic">5,000 Class A Operations per month, 50,000 Class B Operations per month, 100 GB network egress from North America to all region destinations (excluding China and Australia) per month.”</em> (<a href="https://cloud.google.com/free/docs/free-cloud-features#storage">https://cloud.google.com/free/docs/free-cloud-features#storage</a>). If you use your GCP network the way I demonstrate in this book, you should <span class="No-Break">be fine.</span></li>
				<li><strong class="bold">BigQuery</strong> is a <a id="_idIndexMarker935"/>serverless data <a id="_idIndexMarker936"/>analytics platform. We won’t be using it in this book, but in the free tier, you get 1 TB of BigQuery queries <span class="No-Break">per month.</span></li>
				<li><strong class="bold">App Engine</strong> is a <a id="_idIndexMarker937"/>platform for deploying web applications and mobile apps. You get 28 instance hours per <a id="_idIndexMarker938"/>day in the free tier. We won’t be using App Engine in this book, but if you deploy an App Engine app with lots of users, you will definitely be charged <span class="No-Break">for it.</span></li>
				<li><strong class="bold">Cloud Run</strong> is a <a id="_idIndexMarker939"/>service for deploying <a id="_idIndexMarker940"/>stateless containers. The free tier limit is 2 million requests per month, so you should <span class="No-Break">be fine.</span></li>
				<li><strong class="bold">Cloud Build</strong> can import builds from source code from Cloud Storage, Cloud Source <a id="_idIndexMarker941"/>Repositories, GitHub, or Bitbucket <a id="_idIndexMarker942"/>to create Docker containers or other sorts of software artifacts. You get 120 build minutes per day in the free tier. We won’t be using this service in this book; we will just be using standard default Docker and Kubernetes container images. You’ll <span class="No-Break">be fine.</span></li>
				<li>With <strong class="bold">Google Kubernetes Engine</strong>, you get <a id="_idIndexMarker943"/>one Autopilot <a id="_idIndexMarker944"/>or Zonal cluster per month. We’ll just deploy one cluster in <a href="B18672_12.xhtml#_idTextAnchor215"><span class="No-Break"><em class="italic">Chapter 12</em></span></a><span class="No-Break">.</span><p class="list-inset">In the free tier, you get some Cloud Logging, Cloud Monitoring, and Cloud Trace allotments in the operations suite (formerly known as Stackdriver). Those are functions that you can use to analyze your cloud activity in GCP. The free allotments are a bit complicated, but <a id="_idIndexMarker945"/>it’s unlikely that you will go <a id="_idIndexMarker946"/>over them by following the instructions in this book. Read more about the free allotments just to be <span class="No-Break">safe (</span><a href="https://cloud.google.com/stackdriver/pricing"><span class="No-Break">https://cloud.google.com/stackdriver/pricing</span></a><span class="No-Break">).</span></p></li>
				<li><strong class="bold">Firestore</strong> is a <a id="_idIndexMarker947"/>NoSQL document <a id="_idIndexMarker948"/>database service. You get 1 GB of storage in the free tier, but I won’t be using it here. It’s for <span class="No-Break">application development.</span></li>
				<li>You get 2 million invocations <a id="_idIndexMarker949"/>per month in the free tier for <strong class="bold">Cloud Functions</strong>. It’s a serverless environment to build and connect cloud services. We probably won’t be using <span class="No-Break">it anyway.</span></li>
				<li><strong class="bold">Workflows</strong> facilitates <a id="_idIndexMarker950"/>service calls <a id="_idIndexMarker951"/>between GCP and external HTTP APIs. You get 5,000 free internal steps per month, which should be more <span class="No-Break">than enough.</span></li>
				<li>The free <a id="_idIndexMarker952"/>tier includes <a id="_idIndexMarker953"/>free access for five users in <strong class="bold">Cloud Source Repositories</strong>, a service for hosting private Git repositories for application development. We won’t be using that <span class="No-Break">service anyway.</span></li>
				<li>We will be <a id="_idIndexMarker954"/>using <strong class="bold">Secret Manager</strong>, which stores passwords, certificates, API keys, and the like. The six secret versions we get per month <a id="_idIndexMarker955"/>in the free tier should <span class="No-Break">be plenty.</span></li>
			</ul>
			<p>Alright! Now that we know what we’re getting, let’s deploy a GCP network together. We’ll need our own GCP deployment to test our pentesting skills in this book. Just like when we deployed instances in AWS and Azure, I’ll walk you through the process step <span class="No-Break">by step.</span></p>
			<h1 id="_idParaDest-201"><a id="_idTextAnchor201"/>Launching a GCP network</h1>
			<p>As with AWS and Azure, all you need is a modern laptop or desktop PC running Windows, macOS, or a Linux distribution to launch and manage a GCP network. Google’s computers <a id="_idIndexMarker956"/>and infrastructure do all of the heavy lifting as far as computing resources <span class="No-Break">are concerned.</span></p>
			<p>I would also recommend using Google Authenticator on your Android phone (<a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&amp;pli=1">https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&amp;pli=1</a>) or iPhone (<a href="https://apps.apple.com/us/app/google-authenticator/id388497605">https://apps.apple.com/us/app/google-authenticator/id388497605</a>) so that you can use <strong class="bold">multi-factor authentication</strong> (<strong class="bold">MFA</strong>) with your <a id="_idIndexMarker957"/>GCP services. I would not recommend using your phone to do most of your GCP work as a PC screen and a physical keyboard are ideal for those purposes. But you may install the Google Cloud app (<a href="https://cloud.google.com/app">https://cloud.google.com/app</a>) on your phone if you want to check the status of your GCP services. It’s especially great for checking your billing on the go to make sure you’re not doing <span class="No-Break">anything expensive!</span></p>
			<p>A PC or a MacBook made in the past 10 years and a reliable internet connection are all you need on your end, wherever in the world you are, to deploy GCP and do pentesting <span class="No-Break">on GCP.</span></p>
			<p>All the work to start your own GCP deployment is done in your web browser. Let’s <span class="No-Break">get started:</span></p>
			<ol>
				<li>The first step to setting up your own GCP network is to visit the Google Cloud free tier page (<a href="https://cloud.google.com/free">https://cloud.google.com/free</a>) in your web browser and click the blue <strong class="bold">Get started for free</strong> button in the middle of <span class="No-Break">your screen:</span></li>
			</ol>
			<div>
				<div id="_idContainer054" class="IMG---Figure">
					<img src="image/B18672_11_01.jpg" alt="Figure 11.1 – Google Cloud signup page"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.1 – Google Cloud signup page</p>
			<ol>
				<li value="2">On the next screen, make sure your Gmail or Google account is logged in. Set up an account <a id="_idIndexMarker958"/>if you don’t already have one, or sign in to the one you already have. In the drop-down box, select your country and answer the <strong class="bold">What best describes your organization or needs?</strong> question. I chose <strong class="bold">Other</strong>. Make sure you select that you’ve read the <strong class="bold">Terms of Service</strong> details, and click on the blue button that <span class="No-Break">says </span><span class="No-Break"><strong class="bold">CONTINUE</strong></span><span class="No-Break">:</span></li>
			</ol>
			<div>
				<div id="_idContainer055" class="IMG---Figure">
					<img src="image/B18672_11_02.jpg" alt="Figure 11.2 – Google Cloud signup screen"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.2 – Google Cloud signup screen</p>
			<ol>
				<li value="3">The next screen requires you to select your <strong class="bold">Payments</strong> profile. Google needs to have a way to charge you in case you incur GCP service charges, even if you manage to stay within the free tier’s limits. I already have a <strong class="bold">Payments</strong> profile because I’ve <a id="_idIndexMarker959"/>paid for Google Play applications and services, I’m a YouTube Premium subscriber, and I’ve used Google Pay. If you don’t have a <strong class="bold">Payments</strong> profile, you may need to enter your credit card number or link your Google Pay <span class="No-Break">account (</span><a href="https://payments.google.com/"><span class="No-Break">https://payments.google.com/</span></a><span class="No-Break">).</span></li>
				<li>Under <strong class="bold">Account type</strong>, I’ve entered <strong class="bold">Individual</strong>. Unless you’re setting up GCP on behalf of a business or organization, I would recommend <strong class="bold">Individual</strong> <span class="No-Break">for you.</span></li>
				<li>Under <strong class="bold">Name and address</strong>, make sure your name and street address match what’s on your credit card or Google <span class="No-Break">Pay account.</span></li>
				<li>Underneath, click on the blue <strong class="bold">Start my free trial</strong> button. Any time limits for bonus services and credits, such as my 90-day $300 services credit, <span class="No-Break">start now!</span><p class="list-inset">If you scroll <a id="_idIndexMarker960"/>down a little bit, you’ll see buttons to launch GCP projects. First, there are pre-built <span class="No-Break">solution templates:</span></p><ul><li><strong class="bold">Deploy load balanced </strong><span class="No-Break"><strong class="bold">managed VMs</strong></span></li><li><strong class="bold">Create a secure </strong><span class="No-Break"><strong class="bold">CI/CD pipeline</strong></span></li><li><strong class="bold">Deploy a Java application using </strong><span class="No-Break"><strong class="bold">Compute Engine</strong></span></li></ul><p class="list-inset">There are also buttons for launching a product without <span class="No-Break">a template:</span></p><ul><li><strong class="bold">Create </strong><span class="No-Break"><strong class="bold">a VM</strong></span></li><li><strong class="bold">Create a </strong><span class="No-Break"><strong class="bold">containerized app</strong></span></li><li><strong class="bold">Run </strong><span class="No-Break"><strong class="bold">containerized apps</strong></span></li><li><strong class="bold">Modernize and </strong><span class="No-Break"><strong class="bold">run apps</strong></span></li><li><strong class="bold">Execute </strong><span class="No-Break"><strong class="bold">your builds</strong></span></li><li><strong class="bold">Get started </strong><span class="No-Break"><strong class="bold">with containers</strong></span></li></ul><p class="list-inset">This is <a id="_idIndexMarker961"/>what the project launch page <span class="No-Break">looks like:</span></p></li>
			</ol>
			<div>
				<div id="_idContainer056" class="IMG---Figure">
					<img src="image/B18672_11_04.jpg" alt="Figure 11.3 – Google Cloud project launch page"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.3 – Google Cloud project launch page</p>
			<ol>
				<li value="7">For now, let’s click on <strong class="bold">Create a VM</strong> to deploy a simple VM on GCP with Compute Engine that we can use for the pentesting we’ll do in <span class="No-Break">this chapter.</span></li>
				<li>The next screen says <strong class="bold">Compute Engine API</strong> and the overview says <strong class="bold">Creates and runs virtual machines on Google Cloud Platform</strong>. Click on the blue <span class="No-Break"><strong class="bold">Enable</strong></span><span class="No-Break"> button.</span></li>
				<li>You’ll be directed to the VM instances dashboard, which looks like this. Click on the blue <strong class="bold">CREATE </strong><span class="No-Break"><strong class="bold">INSTANCE</strong></span><span class="No-Break"> button:</span></li>
			</ol>
			<div>
				<div id="_idContainer057" class="IMG---Figure">
					<img src="image/B18672_11_05.jpg" alt="Figure 11.4 – GCP Compute Engine screen"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.4 – GCP Compute Engine screen</p>
			<ol>
				<li value="10">On the <a id="_idIndexMarker962"/>next screen, we can name our instance and choose its region and zone, as well as its machine configuration. I will walk you through a configuration that will be the least likely to incur <span class="No-Break">service charges:</span></li>
			</ol>
			<div>
				<div id="_idContainer058" class="IMG---Figure">
					<img src="image/B18672_11_06.jpg" alt="Figure 11.5 – Machine configuration for a VM instance"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.5 – Machine configuration for a VM instance</p>
			<ul>
				<li>In the <a id="_idIndexMarker963"/><strong class="bold">name</strong> field, name your instance whatever you want. I named <span class="No-Break">mine </span><span class="No-Break"><strong class="source-inline">crowgirl-1</strong></span><span class="No-Break">.</span></li>
				<li>In the free tier, our usage of Compute Engine is limited to “<em class="italic">1 non-preemptible e2-micro VM instance per month in one of the following US regions: us-west1, us-central1, us-east1.</em>” So, I chose <strong class="bold">us-east1</strong> as my region. You can select <strong class="bold">us-west1</strong>, <strong class="bold">us-central1</strong>, or <strong class="bold">us-east1</strong> regardless of where in the world <span class="No-Break">you are.</span></li>
				<li>Under <strong class="bold">Machine configuration</strong>, to save money, I chose <strong class="bold">General purpose</strong>, <strong class="bold">E2 under Series</strong>, the <strong class="bold">e2-micro</strong> machine type (the only machine type that’s covered under the free tier), and the Standard VM provisioning model. At the bottom, click on the blue <span class="No-Break"><strong class="bold">Create</strong></span><span class="No-Break"> button.</span></li>
			</ul>
			<p class="list-inset">In a few seconds to a minute, our very basic VM in Compute Engine will be ready! You’ll see a screen that looks something <span class="No-Break">like this:</span></p>
			<div>
				<div id="_idContainer059" class="IMG---Figure">
					<img src="image/B18672_11_07.jpg" alt="Figure 11.6 – List of VM instances in a project"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.6 – List of VM instances in a project</p>
			<p>The default <a id="_idIndexMarker964"/>Debian Linux image will be installed. We have a Linux VM that can use the <span class="No-Break">Bash CLI!</span></p>
			<p>I always prefer to use the CLI that’s built into the cloud platform’s web interface. So, let’s launch GCP <span class="No-Break">Cloud Shell.</span></p>
			<h1 id="_idParaDest-202"><a id="_idTextAnchor202"/>Using GCP Cloud Shell</h1>
			<p>To launch <a id="_idIndexMarker965"/>GCP Cloud Shell, look at the menu bar at the top and click on the icon that looks like <strong class="bold">&gt;_</strong> to the immediate right of the search bar. Do you notice how similar GCP’s web interface is to the web interfaces in AWS <span class="No-Break">and Azure?</span></p>
			<div>
				<div id="_idContainer060" class="IMG---Figure">
					<img src="image/B18672_11_08.jpg" alt="Figure 11.7 – Top menu bar in the GCP console"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.7 – Top menu bar in the GCP console</p>
			<p>All of the Bash commands we used in <a href="B18672_05.xhtml#_idTextAnchor080"><span class="No-Break"><em class="italic">Chapter 5</em></span></a> for AWS and <a href="B18672_08.xhtml#_idTextAnchor141"><span class="No-Break"><em class="italic">Chapter 8</em></span></a> for Azure will work here. Our Linux VM in GCP is functionally just like any other Linux-based computer; a Bash CLI is standard. If you want, you can review some Bash commands from <a href="B18672_05.xhtml#_idTextAnchor080"><span class="No-Break"><em class="italic">Chapter 5</em></span></a><span class="No-Break">.</span></p>
			<p>The Cloud Shell screen looks <span class="No-Break">like this:</span></p>
			<div>
				<div id="_idContainer061" class="IMG---Figure">
					<img src="image/B18672_11_09.jpg" alt="Figure 11.8 – The Cloud Shell screen"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.8 – The Cloud Shell screen</p>
			<p>Next, let’s check <a id="_idIndexMarker966"/>out some of the tools Google provides that will help us when we work as <span class="No-Break">GCP pentesters.</span></p>
			<h1 id="_idParaDest-203"><a id="_idTextAnchor203"/>GCP native security tools</h1>
			<p>Security Command Center is your starting point for all of the security tools that are built into GCP. It integrates <a id="_idIndexMarker967"/>various first-party GCP security tools that I mentioned in <a href="B18672_10.xhtml#_idTextAnchor172"><span class="No-Break"><em class="italic">Chapter 10</em></span></a>. This means you can see data from these applications <a id="_idIndexMarker968"/>and services within your <strong class="bold">Security Command Center</strong> (<span class="No-Break"><strong class="bold">SCC</strong></span><span class="No-Break">) panel:</span></p>
			<ul>
				<li><strong class="bold">Identity and Access Management</strong> (<a href="https://cloud.google.com/iam">https://cloud.google.com/iam</a>), which manages <a id="_idIndexMarker969"/>all of the user identities and machine identities (such as a TLS certificate for a web server) in your GCP network with robust logging that’s integrated into SCC and can also be integrated into an organization’s third-party security monitoring services. “<em class="italic">Identity and Access Management (IAM) lets administrators authorize who can take action on specific resources, giving you full control and visibility to manage Google Cloud </em><span class="No-Break"><em class="italic">resources centrally.</em></span><span class="No-Break">”</span></li>
				<li><strong class="bold">Cloud IDS</strong> (<a href="https://cloud.google.com/intrusion-detection-system">https://cloud.google.com/intrusion-detection-system</a>), which serves the <a id="_idIndexMarker970"/>same functions as most network-based IDSs. It reads your network logs in real time and notifies security administrators of when there may be indications of network threats. It can observe and generate alerts for both ingress (east-west, from one internal server or application to another) and egress (north-south, between your cloud network and the public internet or other external networks) traffic. This is a central concept of zero-trust network security – malicious traffic can come from anywhere. The days of a firm network security perimeter between the internal network and external networks are in the past. Possible threats that Cloud IDS can detect include malware and command and control <span class="No-Break">center-driven attacks.</span></li>
				<li><strong class="bold">Cloud Firewall</strong> (<a href="https://cloud.google.com/firewall">https://cloud.google.com/firewall</a>), which has functions similar to <a id="_idIndexMarker971"/>most other stateful inspection-based network firewalls. There are global network firewall policies that can be applied to permit or forbid traffic according to general GCP security baselines. IAM-governed tags can be used to permit or forbid traffic according to how user and machine identity accounts are marked with tags. Google Cloud Threat Intelligence lists can also be applied so that when Google learns of new cyber threats, your firewall is updated accordingly. Of course, security and network administrators can also block or permit specific users and <span class="No-Break">machines manually.</span></li>
				<li><strong class="bold">Cloud DLP</strong> (<a href="https://cloud.google.com/dlp">https://cloud.google.com/dlp</a>), a tool for <strong class="bold">data loss prevention</strong> (<strong class="bold">DLP</strong>). It tracks <a id="_idIndexMarker972"/>how data travels through your GCP network <a id="_idIndexMarker973"/>and how it exits your GCP network to ensure that sensitive data isn’t breached by your network. Sensitive data can be prevented from being uploaded to your network to an external destination, or it can be tokenized or masked according to the situation (for example, writing a credit card number <span class="No-Break">as </span><span class="No-Break"><em class="italic">45xx-xxxx-xxxx-xxx</em></span><span class="No-Break">).</span></li>
			</ul>
			<p>While testing SCC, I learned that I had to set up Cloud Identity to access the application. There is a service called Cloud Identity Premium, which is a paid service with extra features. I chose <strong class="bold">Cloud Identity Free</strong> because we’re keeping costs low to practice <span class="No-Break">pentesting GCP:</span></p>
			<ol>
				<li>Go <span class="No-Break">to </span><a href="https://workspace.google.com/gcpidentity/signup?sku=identitybasic"><span class="No-Break">https://workspace.google.com/gcpidentity/signup?sku</span> =identitybasic</a> to set up <a id="_idIndexMarker974"/>Cloud Identity Free once you’ve established a GCP account. The following screenshot shows what the first step in setting up <strong class="bold">Cloud Identity Free</strong> <span class="No-Break">looks like:</span></li>
			</ol>
			<div>
				<div id="_idContainer062" class="IMG---Figure">
					<img src="image/B18672_11_010.jpg" alt="Figure 11.9 – Setting up a Cloud Identity account"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.9 – Setting up a Cloud Identity account</p>
			<ol>
				<li value="2">On the next screen, you will need to enter your first and last name and contact email address. Click <strong class="bold">Next</strong>. Then, you’ll need to enter a domain name (such as <strong class="source-inline">packtpub.com</strong>, but not <strong class="source-inline">packtpub.com</strong> because that domain belongs to the publisher of this book) that you have access to. Fortunately, I already had a domain name that I used for another project. If you don’t have your own domain name that you have administrative access to, I recommend getting one through <a href="http://namecheap.com">namecheap.com</a>. Depending on the top-level domain (such as <strong class="source-inline">.com</strong>, <strong class="source-inline">.net</strong>, or<strong class="source-inline">.io</strong>) that you choose, it may only cost you 5.00 USD <span class="No-Break">per year.</span></li>
				<li>Once you’ve <a id="_idIndexMarker975"/>given Cloud Identity Free a domain name that <em class="italic">you own and have administrative access to</em>, the final step is to enter a username and password for your new Cloud Identity/Google <span class="No-Break">Workspace account:</span></li>
			</ol>
			<div>
				<div id="_idContainer063" class="IMG---Figure">
					<img src="image/B18672_11_011.jpg" alt="Figure 11.1﻿0 – Cloud Identity credentials creation screen"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.10 – Cloud Identity credentials creation screen</p>
			<ol>
				<li value="4">Next, the Cloud <a id="_idIndexMarker976"/>Identity wizard will direct you to add a DNS verification record to your domain so that Cloud Identity can protect it. The application knew that I used Namecheap to register my domain, and directed me in the process of adding a verification record, <span class="No-Break">like so:</span></li>
			</ol>
			<div>
				<div id="_idContainer064" class="IMG---Figure">
					<img src="image/B18672_11_012.jpg" alt="Figure 11.11 ﻿– How to connect your Cloud Identity ﻿account with your DNS provider"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.11 – How to connect your Cloud Identity account with your DNS provider</p>
			<p class="list-inset">Once you’ve <a id="_idIndexMarker977"/>followed the steps in the wizard, you may need to wait a few minutes for the DNS verification process <span class="No-Break">to complete.</span></p>
			<ol>
				<li value="5">Then, you’ll see a screen like this, where you can click on the blue <span class="No-Break"><strong class="bold">CONTINUE</strong></span><span class="No-Break"> button:</span></li>
			</ol>
			<div>
				<div id="_idContainer065" class="IMG---Figure">
					<img src="image/B18672_11_013.jpg" alt="Figure 11.12 ﻿– Cloud Identity user setup screen"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.12 – Cloud Identity user setup screen</p>
			<p>Once Cloud <a id="_idIndexMarker978"/>Identity has been established, Google won’t let you access SCC yet. Follow the instructions on the <em class="italic">Creating and managing organization resources</em> (<a href="https://cloud.google.com/resource-manager/docs/creating-managing-organization">https://cloud.google.com/resource-manager/docs/creating-managing-organization</a>) page in the Google Cloud documentation to add your Cloud Identity to an organization with SCC access. I found TechTrapture’s YouTube video <em class="italic">How to create Organization,Folder and projects in GCP</em> (<a href="https://www.youtube.com/watch?v=QvpedBNZqvA">https://www.youtube.com/watch?v=QvpedBNZqvA</a>) to be helpful to make sure my Cloud Identity account was an organization I could add a project to so that I could <span class="No-Break">access SCC.</span></p>
			<p>In the IAM section of my Google Cloud console (<strong class="source-inline">console.cloud.google.com</strong>), I had to make sure that my owner account had Security Center Admin access, <span class="No-Break">like so:</span></p>
			<div>
				<div id="_idContainer066" class="IMG---Figure">
					<img src="image/B18672_11_014.jpg" alt="Figure 11.13 – Assigning roles to user accounts in GCP"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.13 – Assigning roles to user accounts in GCP</p>
			<h2 id="_idParaDest-204"><a id="_idTextAnchor204"/>Exploring the GCP console</h2>
			<p>Once you’re in, you’ll see <a id="_idIndexMarker979"/>a menu on the left-hand side that consists of the <span class="No-Break">following panels:</span></p>
			<ul>
				<li><span class="No-Break"><strong class="bold">Overview</strong></span></li>
				<li><span class="No-Break"><strong class="bold">Threats</strong></span></li>
				<li><span class="No-Break"><strong class="bold">Vulnerabilities</strong></span></li>
				<li><span class="No-Break"><strong class="bold">Compliance</strong></span></li>
				<li><span class="No-Break"><strong class="bold">Assets</strong></span></li>
				<li><span class="No-Break"><strong class="bold">Findings</strong></span></li>
				<li><span class="No-Break"><strong class="bold">Sources</strong></span></li>
			</ul>
			<p>Now that we’ve had a look at SCC, we know how to access it while we’re conducting pentests to access important security <span class="No-Break">posture information.</span></p>
			<p>Once you’ve set everything up with your administrative Cloud Identity account and your organization, you can access SCC at any time from the web application at <a href="http://console.cloud.google.com">console.cloud.google.com</a>. The way I always find it is by going to the search bar in the menu bar at the top of the console screen and searching for <strong class="source-inline">Security </strong><span class="No-Break"><strong class="source-inline">Command Center</strong></span><span class="No-Break">.</span></p>
			<p>You can use this data in your pentest report. The <strong class="bold">Compliance</strong> panel is especially important for your organization’s blue team. There are many data protection regulations that <a id="_idIndexMarker980"/>your organization may need to be compliant with, including PCI DSS, Sarbanes Oxley, HIPAA, GDPR, and many others. Which ones apply to your organization will depend on your industry, where in the world you are, and which foreign countries your company manages the data of. For instance, your company may be in India, but if some of your customers are in the European Union, the GDPR will apply to how your organization handles <span class="No-Break">their data.</span></p>
			<p>Make sure you look through <strong class="bold">Security Command Center</strong> before you pentest GCP, and before you write your pentest report. The <strong class="bold">Vulnerabilities</strong>, <strong class="bold">Assets</strong>, and <strong class="bold">Findings </strong>panels are especially useful for <span class="No-Break">your report.</span></p>
			<p>Now, let’s run some vulnerability scans and pentests <span class="No-Break">in GCP!</span></p>
			<h1 id="_idParaDest-205"><a id="_idTextAnchor205"/>Installing GCP pentesting tools</h1>
			<p>There are <a id="_idIndexMarker981"/>a few different third-party tools that we’ll use to conduct security scans in our GCP instance. First, we’ll <span class="No-Break">install them.</span></p>
			<h2 id="_idParaDest-206"><a id="_idTextAnchor206"/>Prowler</h2>
			<p>I mentioned Prowler for AWS in <a href="B18672_05.xhtml#_idTextAnchor080"><span class="No-Break"><em class="italic">Chapter 5</em></span></a> and for Azure in <a href="B18672_08.xhtml#_idTextAnchor141"><span class="No-Break"><em class="italic">Chapter 8</em></span></a>. You can also use Prowler <a id="_idIndexMarker982"/>to find vulnerabilities in GCP. I’ll briefly walk you through this process as Prowler has already been covered quite a bit in <span class="No-Break">this book.</span></p>
			<p>Everything we’ll be <a id="_idIndexMarker983"/>doing will be in Cloud Shell. From the GCP console web application, click on the icon that looks like <strong class="bold">&gt;_</strong> on the right-hand side of the search bar in the top menu bar to open Cloud Shell. The default CLI is a terminal, which is Bash. All of the Linux Bash commands we used in the AWS and Azure chapters will <span class="No-Break">work here.</span></p>
			<p>First, I verified that I had <strong class="source-inline">pip</strong> installed and which version it was with <span class="No-Break">this command:</span></p>
			<pre class="console">
pip -V</pre>			<p>This was the response I got at the <span class="No-Break">command line:</span></p>
			<pre class="console">
pip 20.3.4 from /usr/lib/python3/dist-packages/pip (python 3.9)</pre>			<p>So, <strong class="source-inline">pip</strong> with Python 3.9 was already installed in my GCP-based Linux VM without me having to do anything. <strong class="source-inline">pip</strong> is a program that’s used to install Python applications. Prowler is based on Python. So, you can use these commands to install Prowler <span class="No-Break">in GCP:</span></p>
			<pre class="console">
sudo apt-get install python3-distutils
pip install prowler</pre>			<p>Alternatively, you can use GitHub to install Prowler with these commands, and then verify the <a id="_idIndexMarker984"/><span class="No-Break">installation after:</span></p>
			<pre class="console">
git clone https://github.com/prowler-cloud/prowler
cd prowler
python prowler.py -v</pre>			<p>Next, let’s install <a id="_idIndexMarker985"/>GCPBucketBrute, which I introduced in <a href="B18672_10.xhtml#_idTextAnchor172"><span class="No-Break"><em class="italic">Chapter 10</em></span></a><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-207"><a id="_idTextAnchor207"/>GCPBucketBrute</h2>
			<p>GCPBucketBrute is specifically designed to scan Google Storage buckets, determine what access <a id="_idIndexMarker986"/>you have to them, and whether or <a id="_idIndexMarker987"/>not they can be privilege escalated. This can be very useful data for your pentest report because if GCPBucketBrute can access your buckets easily, so can malicious <span class="No-Break">cyber attackers!</span></p>
			<p>We can use <strong class="source-inline">git</strong> to install GCPBucketBrute from Cloud Shell (if you’re still in the Prowler directory, return to your main directory with the <strong class="source-inline">cd</strong> <span class="No-Break">command first):</span></p>
			<pre class="console">
git clone https://github.com/RhinoSecurityLabs/GCPBucketBrute.git
cd GCPBucketBrute/
pip3 install -r requirements.txt</pre>			<p>Now, let’s install <span class="No-Break">GCP Scanner.</span></p>
			<h2 id="_idParaDest-208"><a id="_idTextAnchor208"/>GCP Scanner</h2>
			<p>GCP Scanner <a id="_idIndexMarker988"/>is a GCP pentesting application that’s developed by people at <a id="_idIndexMarker989"/>Google but they state this in the <strong class="source-inline">README</strong> <span class="No-Break">file (</span><a href="https://github.com/google/gcp_scanner"><span class="No-Break">https://github.com/google/gcp_scanner</span></a><span class="No-Break">):</span></p>
			<p>“<em class="italic">This project is not an official Google project. It is not supported by Google and Google specifically disclaims all warranties as to its quality, merchantability, or fitness for a </em><span class="No-Break"><em class="italic">particular purpose.</em></span><span class="No-Break">”</span></p>
			<p>I found that installing GCP Scanner with <strong class="source-inline">git</strong> <span class="No-Break">worked best:</span></p>
			<pre class="console">
git clone https://github.com/google/gcp_scanner
cd gcp_scanner
pip install .</pre>			<p>Next, let’s run the applications we’ve <span class="No-Break">just installed!</span></p>
			<h1 id="_idParaDest-209"><a id="_idTextAnchor209"/>Exploiting GCP applications</h1>
			<p>Now that <a id="_idIndexMarker990"/>we’ve installed a few third-party scanning tools, it’s time to <span class="No-Break">use them.</span></p>
			<h2 id="_idParaDest-210"><a id="_idTextAnchor210"/>Prowler</h2>
			<p>Let’s go through the basics of scanning GCP with <span class="No-Break">Prowler first.</span></p>
			<p>By default, Prowler will <a id="_idIndexMarker991"/>use the credentials of whichever <a id="_idIndexMarker992"/>account you used to log in to GCP for your VM. If you need to change your account, verify your accounts in IAM in the GCP web console. Verify your account credentials. You can change accounts in GCP with <span class="No-Break">this command:</span></p>
			<pre class="console">
gcloud config set account &lt;account&gt;</pre>			<p>Now, we can run a default Prowler scan in GCP with this command. Make sure you’re in the Prowler directory first, then run <span class="No-Break">a scan:</span></p>
			<pre class="console">
cd prowler
prowler gcp</pre>			<p>If you used GitHub to install Prowler, use <strong class="source-inline">prowler.py</strong> instead of <strong class="source-inline">prowler</strong> in <span class="No-Break">your commands.</span></p>
			<p>I recommend executing the <strong class="source-inline">help</strong> file first so that you can see all of the commands and options you can use in Prowler. As in previous chapters, you can get Prowler to list services and checks, and run specific service scans and checks in particular locations with particular logging options. All of that information can be printed on your screen the Cloud Shell CLI with <span class="No-Break">this command:</span></p>
			<pre class="console">
prowler -h</pre>			<p>Alternatively, you can use the <span class="No-Break">following command:</span></p>
			<pre class="console">
python prowler.py -h</pre>			<p>Scan results can be printed both on screen and in CSV, JSON, or HTML files in your Prowler directory. You can use those logs when you write your <span class="No-Break">pentest report.</span></p>
			<h2 id="_idParaDest-211"><a id="_idTextAnchor211"/>GCPBucketBrute</h2>
			<p>Next, let’s scan <a id="_idIndexMarker993"/>with GCPBucketBrute. So long as you’re logged into a user <a id="_idIndexMarker994"/>account instead of a service account, you can get effective results with an unauthenticated scan. You may need to go to your GCP web console first to make sure you’re logged in to a <span class="No-Break">user account.</span></p>
			<p>Next, enter <span class="No-Break">this command:</span></p>
			<pre class="console">
python3 gcpbucketbrute.py -k &lt;enter your keyword here&gt; -u</pre>			<p>In the CiA video, I used the <strong class="source-inline">test</strong> keyword, <span class="No-Break">like this:</span></p>
			<pre class="console">
python3 gcpbucketbrute.py -k test -u</pre>			<p>I would also suggest trying other keywords that may appear in the files of your buckets, such as <strong class="source-inline">file</strong> <span class="No-Break">or </span><span class="No-Break"><strong class="source-inline">print</strong></span><span class="No-Break">.</span></p>
			<p>When I ran a scan with <strong class="source-inline">test</strong>, this was the beginning of my results. The printout at my CLI was much longer than <span class="No-Break">this though:</span></p>
			<pre class="console">
    EXISTS: test-pubsub
    EXISTS: project_test
    EXISTS: dl_test
    EXISTS: test_6
    EXISTS: test-export
    EXISTS: gcplogs-test
    EXISTS: teamcity-test
    EXISTS: testproject
    EXISTS: appenginetest
    EXISTS: test-artifacts
    EXISTS: estest
    EXISTS: ops_test
    EXISTS: staging_test
    EXISTS: testtemp
    EXISTS: templates-test
    EXISTS: bucket_test
    EXISTS: testservices
    EXISTS: syslog-test
    EXISTS: test-sitemaps
    EXISTS: cloudtest
    EXISTS: trace-test
    EXISTS: audit_test
    EXISTS: test_ml
    EXISTS: gcp-logs-test
    EXISTS: test-videos
    EXISTS: ux_test
    EXISTS: test_tasks
    EXISTS: tmp_test
    EXISTS: dockertest
    EXISTS: testassets
    EXISTS: testops
    EXISTS: test_support
    UNAUTHENTICATED ACCESS ALLOWED: pictures-test
        - UNAUTHENTICATED LISTABLE (storage.objects.list)
        - UNAUTHENTICATED READABLE (storage.objects.get)
        - ALL PERMISSIONS:
            [
                "storage.objects.get",
                "storage.objects.list"
            ]</pre>			<h2 id="_idParaDest-212"><a id="_idTextAnchor212"/>GCP Scanner</h2>
			<p>Now, let’s give <a id="_idIndexMarker995"/>GCP Scanner a try. First, make sure you’re in <a id="_idIndexMarker996"/>the directory that GCP Scanner <span class="No-Break">is in:</span></p>
			<pre class="console">
cd gcp_scanner</pre>			<p>Create a folder to save your scan <span class="No-Break">results in:</span></p>
			<pre class="console">
mkdir &lt;folder name of your choice here&gt;</pre>			<p>If you enter this command, you will get a handy help guide printed at the <span class="No-Break">command line:</span></p>
			<pre class="console">
python3 scanner.py -h</pre>			<p>I ran a simple metadata scan with this command. This checks the metadata in your GCP VM’s files to see whether sensitive credentials are exposed <span class="No-Break">in them:</span></p>
			<pre class="console">
python3 scanner.py -o &lt;folder name you used in mkdir command here&gt; -ls -m</pre>			<p>Feel free to play around with all of the options and arguments that are shown in GCP Scanner’s <span class="No-Break">help guide:</span></p>
			<pre class="console">
GCP Scanner
optional arguments:
  -h, --help            show this help message and exit
  -ls, --light-scan     Return only the most important GCP resource fields in the output.
  -k KEY_PATH, --sa-key-path KEY_PATH
                        Path to directory with SA keys in json format
  -g GCLOUD_PROFILE_PATH, --gcloud-profile-path GCLOUD_PROFILE_PATH
                        Path to directory with gcloud profile. Specify - to search for credentials in default gcloud config path
  -m, --use-metadata    Extract credentials from GCE instance metadata
  -at ACCESS_TOKEN_FILES, --access-token-files ACCESS_TOKEN_FILES
                        A list of comma separated files with access token and OAuth scopes.TTL limited. A token and scopes should be stored in JSON format.
  -rt REFRESH_TOKEN_FILES, --refresh-token-files REFRESH_TOKEN_FILES
                        A list of comma separated files with refresh_token, client_id,token_uri and client_secret stored in JSON format.
  -s KEY_NAME, --service-account KEY_NAME
                        Name of individual SA to scan
  -p TARGET_PROJECT, --project TARGET_PROJECT
                        Name of individual project to scan
  -f FORCE_PROJECTS, --force-projects FORCE_PROJECTS
                        Comma separated list of project names to include in the scan
  -c CONFIG_PATH, --config CONFIG_PATH
                        A path to config file with a set of specific resources to scan.
  -l {DEBUG,INFO,WARNING,ERROR,CRITICAL}, --logging {DEBUG,INFO,WARNING,ERROR,CRITICAL}
                        Set logging level (INFO, WARNING, ERROR)
  -lf LOG_FILE, --log-file LOG_FILE
                        Save logs to the path specified rather than displaying in console</pre>			<p>Congratulations, you’ve <a id="_idIndexMarker997"/>just produced a bunch of GCP pentest <a id="_idIndexMarker998"/>scanning logs that you can reference in your <span class="No-Break">pentest report!</span></p>
			<p>In the next chapter, we’ll conduct pentesting scans within Docker and Kubernetes containers <span class="No-Break">in GCP.</span></p>
			<h1 id="_idParaDest-213"><a id="_idTextAnchor213"/>Summary</h1>
			<p>Everything you need to create a GCP network to practice pentesting can be done with the services in the GCP free tier. Just make sure you check your billing in the GCP web console to make sure you aren’t <span class="No-Break">incurring charges.</span></p>
			<p>You may need to set up a Google Workspace or Cloud Identity account to get the most out of GCP. That includes using SCC. SCC is your starting point for all of the security tools that are built into GCP. It integrates various first-party GCP security tools. You can use SCC to check for some threats, vulnerabilities, and security recommendations based on Google’s threat intelligence. As with running third-party pentesting tools, SCC may provide you with useful information that you can use in your <span class="No-Break">pentest report.</span></p>
			<p>Just like with AWS and Azure, Prowler can be used to scan for vulnerabilities and regulatory compliance in GCP. We ran a Prowler vulnerability scan at the command line in <span class="No-Break">Cloud Shell.</span></p>
			<p>GCPBucketBrute checks whether attackers can access your GCP buckets and whether they can be privilege escalated. Because we just set up a simple GCP deployment with a VM without much on it, it’s surprising that GCPBucketBrute was still able to find somewhere with <span class="No-Break">unauthenticated access!</span></p>
			<p>GCP Scanner can be used to determine what level of access particular credentials have in your <span class="No-Break">GCP deployment.</span></p>
			<p>In the next chapter, we will deploy Docker and Kubernetes clusters in GCP and run some vulnerability scans <span class="No-Break">in them.</span></p>
			<h1 id="_idParaDest-214"><a id="_idTextAnchor214"/>Further reading</h1>
			<p>To learn more about the topics that were covered in this chapter, take a look at the <span class="No-Break">following resources:</span></p>
			<ul>
				<li><em class="italic">List of free services in </em><span class="No-Break"><em class="italic">GCP</em></span><span class="No-Break">: </span><a href="https://cloud.google.com/free?hl=en"><span class="No-Break">https://cloud.google.com/free?hl=en</span></a></li>
				<li><em class="italic">TechTrapture’s YouTube video</em> <em class="italic">How to create Organization,Folder and projects in </em><span class="No-Break"><em class="italic">GCP</em></span><span class="No-Break">: </span><a href="https://www.youtube.com/watch?v=QvpedBNZqvA"><span class="No-Break">https://www.youtube.com/watch?v=QvpedBNZqvA</span></a></li>
				<li><em class="italic">Prowler in </em><span class="No-Break"><em class="italic">GCP</em></span><span class="No-Break">: </span><a href="https://docs.prowler.cloud/en/latest/#google-cloud"><span class="No-Break">https://docs.prowler.cloud/en/latest/#google-cloud</span></a></li>
				<li><span class="No-Break"><em class="italic">GCPBucketBrute</em></span><span class="No-Break">: </span><a href="https://github.com/RhinoSecurityLabs/GCPBucketBrute"><span class="No-Break">https://github.com/RhinoSecurityLabs/GCPBucketBrute</span></a></li>
				<li><em class="italic">GCP </em><span class="No-Break"><em class="italic">Scanner</em></span><span class="No-Break">: </span><a href="https://github.com/google/gcp_scanner"><span class="No-Break">https://github.com/google/gcp_scanner</span></a></li>
			</ul>
		</div>
	</body></html>