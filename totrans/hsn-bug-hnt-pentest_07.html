<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Detecting XML External Entities</h1>
                </header>
            
            <article>
                
<p class="mce-root"><strong>XXE</strong> is an abbreviation of <strong>XML External Entity</strong>. As an attack, it takes advantage of a flaw in an application's XML parser configuration to perform a number of malicious actions, including exposing the contents of protected files, or causing the exponential use of memory, resulting in a DoS attack.</p>
<p class="mce-root">XML, like JSON, comprises a big part of the data transfer that powers the modern internet. As a system for encoding documents in both human and machine-readable ways, XML is common in tech stacks of a certain age, and persists in older API architectures such as <strong>Simple Object Access Protocol</strong> (<strong>SOAP</strong>), even though web applications rely more and more on JSON as a common standard. In 2017, OWASP named XXE as number four on their list of the top ten web vulnerabilities—it wasn't included in the list in the previous survey in 2014.</p>
<p class="mce-root">The nature of the attack stems from XML's conceptions of entities, a primitive data type that combines a string with a unique alias or reserved word. When the XML parser expands the entity, the parser looks for and stores the contents of the URI in the final XML document. If the entity is pointing to a sensitive file on the web server, then that information is compromised. There are different vectors for inputting that XML, including application form inputs. Because the vulnerability includes XML code being mistakenly parsed (and executed) after it is submitted through a form input, XXE can be classified as a form of code injection.</p>
<p class="mce-root">There are a couple of risk factors for XXE, which are allowed in by weakly or misconfigured XML parsers: if a parser accepts tainted data within the <strong>Document Type Declaration</strong> (<strong>DTD</strong>), and it processes that DTD and resolves external entities, the site is at risk. As an example, if you're using PHP, the language's documentation specifically states that you need to set the <kbd>libxml_disable_entity_loader</kbd> variable to <kbd>true</kbd> in order to disable the ability to load external entities (<a href="https://secure.php.net/manual/en/function.libxml-disable-entity-loader.php">https://secure.php.net/manual/en/function.libxml-disable-entity-loader.php</a>).</p>
<p class="mce-root"/>
<p class="mce-root">This chapter will cover:</p>
<ul>
<li class="mce-root">Details of how an XML processor can become compromised</li>
<li class="mce-root">How to craft XXE snippets and where to find community-sourced lists of them</li>
<li class="mce-root">Tools to use in detecting XXE</li>
<li class="mce-root">How to take a XXE vulnerability from discovery, to validation, to inclusion in a bug report submission</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>For this chapter, we'll be using our standard version of Chrome (<kbd>66.0.3359.139</kbd>), along with a new developer environment deployment system, Vagrant, which—coupled with VirtualBox—will allow us to bootstrap our deliberately vulnerable XXE app (which we're using thanks to <a href="https://github.com/jbarone/xxelab">https://github.com/jbarone/xxelab</a>). VirtualBox is a <strong>Virtual Machine</strong> (<strong><span>VM</span></strong>) client, and Vagrant adds a layer of dependency and environment management on top of that.</p>
<p>To install Vagrant and VirtualBox, pick the appropriate client for your system from their respective <span class="packt_screen">Downloads</span> pages (<a href="https://www.vagrantup.com/downloads.html">https://www.vagrantup.com/downloads.html</a> and <a href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a>).</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">A simple XXE example</h1>
                </header>
            
            <article>
                
<p>There are a few different types of XXE attack which can attempt <strong>Remote Code Execution</strong> (<strong>RCE</strong>) or <span>– </span>as we covered in the introduction <span>– </span>disclose information from targeted files. Here's an example of the second variety, from OWASP's entry for XXE:</p>
<pre> &lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;<br/> &lt;!DOCTYPE foo [  <br/>   &lt;!ELEMENT foo ANY &gt;<br/>   &lt;!ENTITY xxe SYSTEM "file:///etc/passwd" &gt;]&gt;&lt;foo&gt;&amp;xxe;&lt;/foo&gt;</pre>
<p>Here, you can see the external entity and its attempt—through the location string's <kbd>file</kbd> prefix and the following system path—to access a sensitive file on the vulnerable server.</p>
<p class="mce-root"/>
<p>XXE can also be used to conduct DoS attacks through an XML variant of a popular logic bomb tactic called a <strong>Billion Laughs</strong>. A DoS attack that occurs via a logic bomb—a piece of code that when executed causes the host to max out its resource consumption—is a bit different from a DoS attack caused by one or more outside agents (if there is more than one outside agent, then it would be a DDoS attack). A DoS attack is usually considered easier to mitigate because there's only one source for the attack—network administrators don't have to play whack-a-mole with multiple sources of malicious traffic. But a DoS attack coming from a single source also means that an attacker only needs access to that vulnerable input, as opposed to a swarm of machines generating traffic as part of a botnet.</p>
<p>Here's an example of the a billion laughs XML snippet from Wikipedia's page on the attack:</p>
<pre>&lt;?xml version="1.0"?&gt;<br/>&lt;!DOCTYPE lolz [<br/> &lt;!ENTITY lol "lol"&gt;<br/> &lt;!ELEMENT lolz (#PCDATA)&gt;<br/> &lt;!ENTITY lol1 "&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;"&gt;<br/> &lt;!ENTITY lol2 "&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;"&gt;<br/> &lt;!ENTITY lol3 "&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;"&gt;<br/> &lt;!ENTITY lol4 "&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;"&gt;<br/> &lt;!ENTITY lol5 "&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;"&gt;<br/> &lt;!ENTITY lol6 "&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;"&gt;<br/> &lt;!ENTITY lol7 "&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;"&gt;<br/> &lt;!ENTITY lol8 "&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;"&gt;<br/> &lt;!ENTITY lol9 "&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;"&gt;<br/>]&gt;<br/>&lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;</pre>
<p>You can see that there's only one root element, <kbd>&lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;</kbd>. When the text of that element, <kbd>&amp;lol9;</kbd>, is expanded (since it's a defined entity), the parser looks and sees the entity <kbd>&amp;lol8;</kbd> and tries to expand it too, which leads it to <kbd>&amp;lol7;</kbd>, then <kbd>&amp;lol6;</kbd>, and on and on through the entity list <span>–</span> it's turtles and memory usage all the way down.</p>
<p>The result is that after all the entity expansions have been processed, this small, less-than-1 KB snippet, will create 10 to the 9th power <kbd>lols</kbd>, totaling over 3 GB of memory usage.</p>
<p class="mce-root"/>
<p>Billion Laughs attacks are not unique to XML (you can do a similar attack in YAML or any other file format that supports references), but they do clearly illustrate the means through which an unguarded XXE vulnerability can wreak havoc.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">XML injection vectors</h1>
                </header>
            
            <article>
                
<p>XML injection and XML parsing-related vulnerabilities aren't always observable from the client-side code <span>–</span> the XML part of the processing chain could be occurring within the server formatting your client-side input.</p>
<p>Following an OWASP XML injection example, the client-side form (assuming, for argument's sake, that it's making a <kbd>GET</kbd> request) will create an HTTP request that looks like this:</p>
<pre>Username: james<br/>Password: Thew45p!<br/>E-mail: james.mowry@terran.gov</pre>
<p>Then, before inserting itself into an XML-document-like-database, the application will build an individual XML node:</p>
<pre>&lt;user&gt; <br/>    &lt;username&gt;james&lt;/username&gt; <br/>    &lt;password&gt;Thew45p!&lt;/password&gt; <br/>    &lt;userid&gt;500&lt;/userid&gt;<br/>    &lt;mail&gt;james.mowry@terran.gov&lt;/mail&gt;<br/>&lt;/user&gt;</pre>
<p>You can exploit this behavior to do different kinds of injection, including tag-based injection. That's when you would add a valid XML tag within your input, spoofing a valuable property (this assumes that a <kbd>&lt;userid&gt;</kbd> of 0 represents an admin user) by making an HTTP request along these lines:</p>
<pre>Username: james<br/>Password: Thew45p!&lt;/password&gt;&lt;!--<br/>E-mail: --&gt;&lt;userid&gt;0&lt;/userid&gt;&lt;mail&gt;james.mowry@terran.gov</pre>
<p>That HTTP request, when assembled into the XML-like datastore, results in one of the redundant <kbd>&lt;userid&gt;</kbd> tags being filtered out, resulting in a perfectly valid record that also escalates James's privileges.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The final result is as follows:</p>
<pre>&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt; <br/>&lt;users&gt; <br/>    &lt;user&gt; <br/>        &lt;username&gt;bob&lt;/username&gt; <br/>        &lt;password&gt;!4rct0R&lt;/password&gt; <br/>        &lt;userid&gt;0&lt;/userid&gt;<br/>        &lt;mail&gt;&lt;/mail&gt;<br/>    &lt;/user&gt; <br/>    &lt;user&gt; <br/>        &lt;username&gt;helward&lt;/username&gt; <br/>        &lt;password&gt;!nverteDW0rld&lt;/password&gt; <br/>        &lt;userid&gt;500&lt;/userid&gt;<br/>        &lt;mail&gt;helward.mann@winverted.hmm&lt;/mail&gt;<br/>    &lt;/user&gt; <br/>    &lt;user&gt; <br/>        &lt;username&gt;james&lt;/username&gt; <br/>        &lt;password&gt;Thew45p!&lt;/password&gt;&lt;!--&lt;/password&gt; <br/>        &lt;userid&gt;500&lt;/userid&gt;<br/>        &lt;mail&gt;--&gt;&lt;userid&gt;0&lt;/userid&gt;&lt;mail&gt;james.mowry@terran.gov&lt;/mail&gt;<br/>    &lt;/user&gt;<br/>&lt;/users&gt;</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">XML injection and XXE – stronger together</h1>
                </header>
            
            <article>
                
<p>We previously covered the anatomy of an XXE bug and how nested entity expansion can lead to exponential resource use. We've also covered how valid XML structures can be injected through RESTful APIs so that malicious tags are recreated in the XML formatting (we used a fictional case of an XML-like DB, but the analysis holds for any server-side XML processing layer).</p>
<p>You can see how these two dynamics complement one another—if you have discovered a valid XML injection vector, that gives you the delivery mechanism with which to define and execute your XXE validation.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Testing for XXE – where to find it, and how to verify it</h1>
                </header>
            
            <article>
                
<p>As we discussed previously, none of the inputs available to you need to state that the application accepts XML for a service to be vulnerable to XXE: the XML parsing layer of the application could be opaque to you, stitching together data that you sent as a <kbd>GET</kbd> or <kbd>POST</kbd> request into an XML document.<br/>
<br/>
Besides services that use XML as their primary document formatting system under-the-hood, there are also many API services that support different data formats by default. Even if you're making a GET request and receiving JSON in return, you can test whether or not that API endpoint can format your request as XML by trying the XML content header, that is, <kbd>Content-Type: application/xml</kbd>. Because services often have this capacity to switch between different content types that are built-in, the owner of the service might not know that it has the ability to format requests as XML.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">XXE – an end-to-end example</h1>
                </header>
            
            <article>
                
<p>Let's set up our XXE lab so that we can see the vulnerability in action. After downloading Vagrant, VirtualBox, and cloning the git repository from <a href="https://github.com/jbarone/xxelab">https://github.com/jbarone/xxelab</a>, we can start the application by navigating into the <kbd>xxelab</kbd> directory and running <kbd>vagrant up</kbd>. After downloading the Ubuntu images and other dependencies, your app should be up and running on <kbd>http://192.168.33.10/</kbd>:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/05c7cdca-0c14-48cd-9382-1e9c3cb5c7f4.png"/></div>
<p>Let's enter some test values into our submission form, making sure that our Burp Suite proxy has its <span class="packt_screen">Intercept</span> feature turned on:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/9f4086d6-24e8-496c-b4f0-e24f21d1d4ab.png"/></div>
<p class="mce-root"/>
<p>After trying to submit our form, we can head over to Burp to see what our intercepted raw HTTP request looks like:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/cab50b14-5df3-4461-a19b-580ef04b6040.png"/></div>
<p>Seeing that our submission is being formatted in XML, we can try a basic entity expansion test, substituting our <kbd>email</kbd> form value with a test message by using the <kbd>&amp;example;</kbd> entity:</p>
<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;!DOCTYPE replace [&lt;!ENTITY example "Success"&gt; ]&gt;<br/>&lt;root&gt;&lt;name&gt;Edward Hawks&lt;/name&gt;&lt;tel&gt;5555555555&lt;/tel&gt;&lt;email&gt;&amp;example;&lt;/email&gt;&lt;password&gt;roguemoon&lt;/password&gt;&lt;/root&gt;</pre>
<p>Here's what it looks like when entered into our intercept proxy:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/c13069b1-9efa-4295-8d02-9b3bdcdc108b.png"/></div>
<p class="mce-root"/>
<p>Note that this app is designed to mimic the experience of trying to exfiltrate data through error messages, so it will always return an error message stating that the email in question (with the full email printed) is not available. This means that if the XML parser is susceptible to entity expansion, we'll see success printed in the error message:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/e4ae1dc5-6f39-49cc-8da8-0ee6f9ca2df9.png"/></div>
<p>Indeed, success has been registered.</p>
<p>For validating an XML bug, this is enough to open a report and begin the submission process. Using the entity expansion to replace values is a harmless PoC that, nevertheless, points to the possible damage other XXE attacks could accomplish.</p>
<p>But, since we're working locally, let's do some of that damage. Leveraging our knowledge of the vulnerability, we can replace our intercepted values with an XXE snippet pulled from OWASP's Testing for XML Injection (<a href="https://www.owasp.org/index.php/Testing_for_XML_Injection_(OTG-INPVAL-008)">https://www.owasp.org/index.php/Testing_for_XML_Injection_(OTG-INPVAL-008)</a>) page:</p>
<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/> &lt;!DOCTYPE foo [  <br/>  &lt;!ELEMENT foo ANY &gt;<br/>  &lt;!ENTITY xxe SYSTEM "file:///dev/random" &gt;]&gt;&lt;foo&gt;&amp;xxe;&lt;/foo&gt;</pre>
<p>When the server attempts to expand the entity and access the contents of <kbd>/dev/random</kbd>, it can cause the server to crash. That's because <kbd>/dev/random</kbd> is a special, pseudorandom number generator, that will block the thread if there's insufficient entropy for the random number generation. Here, we've entered the snippet into another intercepted attempt to create an account:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/57ad7365-959d-4e75-80a9-b695e4c43b4f.png"/></div>
<p>After forwarding the request, we see the server hang—and hang. Upon opening a new tab, we can no longer get the IP address to resolve. We've successfully crashed it!</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/28e4b721-53f0-4f2d-be2a-48de5cd32b93.png" style=""/></div>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Gathering report information</h1>
                </header>
            
            <article>
                
<p>Let's walk through the information we need to write our report.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Category</h1>
                </header>
            
            <article>
                
<p>This is an XXE attack.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Timestamps</h1>
                </header>
            
            <article>
                
<p>For our timestamp, we can use an approximate time for when we submitted our XXE entity replacement request.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">URL</h1>
                </header>
            
            <article>
                
<p>The location of the vulnerability is the application index, for example:</p>
<pre>http://192.168.33.10/</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Payload</h1>
                </header>
            
            <article>
                
<p>Here, we can enter the XML snippet we used as our PoC for validating the capacity for entity expansion:</p>
<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;!DOCTYPE replace [&lt;!ENTITY example "Success"&gt; ]&gt;<br/>&lt;root&gt;&lt;name&gt;Edward Hawks&lt;/name&gt;&lt;tel&gt;5555555555&lt;/tel&gt;&lt;email&gt;&amp;example;&lt;/email&gt;&lt;password&gt;roguemoon&lt;/password&gt;&lt;/root&gt;</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Methodology</h1>
                </header>
            
            <article>
                
<p>To prove that the service in question is susceptible to an XXE attack, we used Burp Suite to intercept and modify an HTTP <kbd>POST</kbd> request, replacing the XML document generated by our form submission with our payload.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Instructions to reproduce</h1>
                </header>
            
            <article>
                
<p>Our instructions to reproduce are to navigate to the form and use a proxy tool (in our case, Burp Proxy) to replace the form data with our payload.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Attack scenario</h1>
                </header>
            
            <article>
                
<p>We've already seen how an entity expansion pointing to <kbd>/dev/random</kbd> can cause a server to crash. Using an XXE attack, we can also disclose the contents of sensitive server files like <kbd>/etc/password</kbd> and, in some cases, perform RCE.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Final report</h1>
                </header>
            
            <article>
                
<p>Let's use this information to format our submission:</p>
<pre>CATEGORY: XXE attack<br/><br/>TIME: 2018-07-28 16:27 (16:27) UTC<br/><br/>URL: http://192.168.33.10/<br/><br/>PAYLOAD: <br/><br/>&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;!DOCTYPE replace [&lt;!ENTITY example "Success"&gt; ]&gt;<br/>&lt;root&gt;&lt;name&gt;Edward Hawks&lt;/name&gt;&lt;tel&gt;5555555555&lt;/tel&gt;&lt;email&gt;&amp;example;&lt;/email&gt;&lt;password&gt;roguemoon&lt;/password&gt;&lt;/root&gt;<br/><br/>METHODOLOGY: The vulnerability was discovered by manually intercepting and editing the create account form to include the above entity replacement changes.<br/><br/>INSTRUCTIONS TO REPRODUCE:<br/><br/>1. Navigate to the create account form at http://192.168.33.10/.<br/><br/>2. Enter dummy values into the form and submit it.<br/><br/>3. Intercept the generated HTTP POST request using a tool like Burp Proxy. Edit the XML data to include the payload above.<br/><br/>4. Forward the POST request on to the server.<br/><br/>ATTACK SCENARIO:<br/>In the case of this XXE attack, a malicious agent could submit entity expansion code to retrieve the contents of a sensitive file on the server, like the contents of /etc/password, or make a call to /dev/random and crash the server, or even use a different DoS method with the nested entity expansion strategy of a "Billion Laughs"-style attack (https://en.wikipedia.org/wiki/Billion_laughs_attack).</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we covered XXE and touched on the nature of XML parsing attacks, discussed XXE within the historical context of the Billion Laughs vulnerability, reviewed a specific weakness that makes many XML parsers vulnerable to XXE, and end-gamed some of the possible attack scenarios associated with an XXE bug, in addition to taking an XXE vulnerability all the way from discovery to report submission.</p>
<p>In the next chapter, we will discuss access control and security through obscurity.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li>What makes an XML parser susceptible to XXE? What is an example misconfiguration?</li>
<li>How do you use Burp to test for XXE?</li>
<li>What are some impacts of an XXE vulnerability? What are some common attack scenarios involving the bug?</li>
<li>What is <kbd>/dev/random</kbd>?</li>
<li>What's a non-impactful way you can test for the presence of an XXE vulnerability?</li>
<li>What's the Billion Laughs attack?</li>
<li>How can some services (especially API endpoints) be vulnerable to XXE when they use JSON for data exchanges?</li>
</ol>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p>You can find out more about some of the topics we have discussed in this chapter at:</p>
<ul>
<li><strong>Billion Laughs Attack</strong>: <a href="https://en.wikipedia.org/wiki/Billion_laughs_attack">https://en.wikipedia.org/wiki/Billion_laughs_attack</a></li>
<li><strong>Hunting XXE For Fun and Profit</strong>: <a href="https://www.bugcrowd.com/advice-from-a-bug-hunter-xxe/">https://www.bugcrowd.com/advice-from-a-bug-hunter-xxe/</a></li>
</ul>


            </article>

            
        </section>
    </body></html>