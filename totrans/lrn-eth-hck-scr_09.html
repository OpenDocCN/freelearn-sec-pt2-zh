<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Network Penetration Testing, Detection, and Security</h1>
                </header>
            
            <article>
                
<p class="mce-root"><span>In this chapter, we are going to learn about how to detect ARP poisoning; to do that, we will first look at what ARP poisoning is, how to perform the attack ourselves, and then how to detect it. This chapter also cover how to detect suspicious behavior for which we will be using the Wireshark tool.</span></p>
<p>To sum up, in this chapter, we will cover the following topics:</p>
<ul>
<li>Detecting ARP poisoning </li>
<li>Detecting suspicious behavior</li>
</ul>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Detecting ARP poisoning</h1>
                </header>
            
            <article>
                
<p>Let's take a look at how to detect ARP poisoning attacks. First of all, we need to gain an understanding of the ARP table. On our Windows device, which is the device that we always attack, we are going to run the <kbd>arp -a</kbd><span> command </span><span>to list all the entries in the ARP table. Each computer has an ARP table, and that table associates IP addresses with MAC addresses. We have the IP address of a router, which is</span> <kbd>10.0.2.1</kbd> and i<span>s associated with the MAC address</span> <kbd>52-54-00-12-35-00</kbd>, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1294 image-border" src="assets/dbffd319-fd45-4439-916e-9e44905f3c21.png" style="width:30.50em;height:14.92em;"/></div>
<p>ARP poisoning works via trusted requests; as you can see in the previous screenshot, when a request is trusted, responses are accepted by the client even if a request isn't actually sent. The hacker sends a response to the client telling them that they are the router, which is automatically trusted and then accepted. Hacker will now send another response to the router, telling it that we're the client. This will modify the entries in the ARP tables for both the router and the client, associating the hacker's MAC address with the router's IP address. In other words, the router's MAC address is now the attacker's MAC address. By doing this, the hacker will be able to read, analyze, and modify any packets flowing through the device, as shown in the following diagram:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1598 image-border" src="assets/ea954b71-c2ad-41ac-b3e3-62f44e47a7d9.png" style="width:32.00em;height:14.25em;"/></div>
<p>We'll now run a <span>normal</span> ARP poisoning attack from Kali machine. Following is the command:</p>
<pre><strong>mitmf --arp --spoof --gateway 10.0.2.1 --target 10.0.2.5 -i eth0</strong></pre>
<p>When we return and execute the same command as earlier, <kbd>arp -a</kbd>, we should see a different MAC address, as illustrated in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1295 image-border" src="assets/210714d0-cf0b-4e77-82e4-82e56516e2b4.png" style="width:26.50em;height:13.17em;"/></div>
<p>The MAC address for the router used to be <kbd><span>52-54-00-12-35-00</span></kbd> but that has since changed to <kbd>08-00-27-0b-91-66</kbd>, the MAC address of the network card the attacker is using.</p>
<p>If we run <kbd>ifconfig eth0</kbd> on Kali machine, we will get the same MAC address, as shown in the previous screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1293 image-border" src="assets/77725ea2-b151-4730-9404-8d47d744290e.png" style="width:34.42em;height:8.50em;"/></div>
<p>This is the simplest way to detect ARP poisoning attacks but not the most efficient. To save time, it is recommend to use a tool called XArp, which performs the <kbd>ifconfig</kbd> command for us. XArp is available on Linux and Windows and can be downloaded from the web. When XArp stops an attack, the altered IP address is reverted back to the original value; in this case, the router's MAC address returns to the default address.</p>
<p>Running XArp triggers a similar process to the <kbd>arp -a</kbd> command, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1296 image-border" src="assets/0a438be2-3cad-4110-9422-600a5816bb1f.png" style="width:47.67em;height:35.83em;"/></div>
<p>As we can see in the previous screenshot, the XArp tool has provided us with an IP address and the MAC address associated with it. The tool will then automatically monitor these values, notifying the user of any changes or duplicates.</p>
<p>If we run an ARP poisoning attack similar to the one we did earlier, XArp should display an alert, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1298 image-border" src="assets/725282de-6087-4b9f-a8fb-3f6840a84160.png" style="width:20.83em;height:34.33em;"/></div>
<p>The notification will convey a message that the <span class="packt_screen">MAC address for IP </span><span class="packt_screen">changed from 52-54-00-12-35-00 to 08-00-27-0b-91-66</span>.</p>
<p>Once we click <span class="packt_screen">OK</span>, we can see that the affected machines are the router, our Windows machine, and our attacker Kali machine as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1299 image-border" src="assets/a052096d-7a4a-4003-9420-ed7dc8f43914.png" style="width:65.33em;height:49.08em;"/></div>
<p>The preceding screenshot tells us that the machine at <kbd>10.0.2.15</kbd> is trying to perform an ARP poisoning attack because that's the value the router's MAC address has changed to.</p>
<p>As we can see, the XArp tool is really handy because not only does it automatically monitor your machine, it also tell you when someone is trying to ARP poison your network.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Detecting suspicious behavior</h1>
                </header>
            
            <article>
                
<p>We will now look at how to use Wireshark to find suspicious activity within our network. Before we go any further, we need to change a few settings inside Wireshark; go to <span class="packt_screen">Edit</span> | <span class="packt_screen">Preferences...</span> under <span class="packt_screen">Protocols</span>, find <span class="packt_screen">ARP/RARP</span> and enable the option to <span class="packt_screen">Detect ARP request storms</span>:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1312 image-border" src="assets/fcb5f449-a00c-4c71-8364-468296abc0b0.png" style="width:57.83em;height:41.33em;"/></div>
<p class="mce-root"/>
<p class="mce-root"/>
<p>This will notify us if anybody is trying to discover any devices on the network. Click on <span class="packt_screen">OK</span> and begin starting the capture by clicking on <span class="packt_screen">Capture</span> | <span class="packt_screen">Start</span>:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1313 image-border" src="assets/a7205381-ed4d-4679-9935-bfcb6e0cf2f2.png" style="width:28.08em;height:13.17em;"/></div>
<p>Now we need to switch to the Kali machine and use <kbd>netdiscover</kbd>. Instead of ARP poisoning, we are trying to discover what devices are connected to network. This is done by launching the following command:</p>
<pre><strong>netdiscover -i eth0 -r 10.0.2.1/24</strong></pre>
<p>Once we have launched the <kbd>netdiscover</kbd> command, it quickly discovered the available devices on the network:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1314 image-border" src="assets/0b0ee1aa-8ef5-404f-aa35-92fb1121e013.png" style="width:42.75em;height:14.00em;"/></div>
<p>Wireshark will then generate packets that include the name of a device, what its destination is, and what it's inquiring from each IP address, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1316 image-border" src="assets/753acd29-f7c0-449b-8542-189bb0a8964e.png" style="width:66.58em;height:40.08em;"/></div>
<p>As the results show, a device is checking to see whether any possible IP in a particular range exists. The device is asking for responses to be sent to <kbd>10.0.2.67</kbd>, so it's safe to deduce that whoever is trying to discover our connected devices has the IP address <kbd>10.0.2.67</kbd>.</p>
<p>If we go to <span class="packt_screen">Analyze</span> | <span class="packt_screen">Expert</span> <span class="packt_screen">Information</span>, you'll see that an ARP packet storm has been detected:</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1449 image-border" src="assets/61cd1c36-7a8b-46f7-8ce8-72329a531b60.png" style="width:57.33em;height:18.17em;"/></div>
<p>This means that there is a single device sending a large number of ARP packets, more than likely with the aim of finding connected devices and ports.</p>
<p>We are now going to perform an ARP poisoning attack using a man-in-the-middle framework in order to see if we get any notifications or warnings in Wireshark. If we go to <span class="packt_screen">Analyze</span> | <span class="packt_screen">Expert Information</span> again, a warning telling us that a duplicate IP address has been configured should appear:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1450 image-border" src="assets/df6b4196-6b36-4e5d-990d-c3cf2ebbd466.png" style="width:57.33em;height:15.25em;"/></div>
<p>This means the IP address of the router has two different MAC addresses, which indicates that someone is tampering with the connections and trying to place themselves in the middle using an ARP poisoning attack.</p>
<p>Now that we've explored a number of ways to detect ARP poisoning, let's discuss how we can prevent those attacks and protect ourselves from them. Running the <kbd>arp -a</kbd> command will generate the following table: </p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1319 image-border" src="assets/89414b0e-6def-44cf-9a2c-d6577c09bc4a.png" style="width:31.42em;height:17.67em;"/></div>
<p>As you can see in the previous screenshot, the <kbd>arp -a</kbd> command monitors our network and will notify us of, or even prevent, any ARP poisoning attacks. Another way of doing this is utilizing the dynamic entries seen in the router's table. A dynamic type is essentially a physical address that the system will allow to be changed. In the previous screenshot, those values are static, which means the values cannot be changed. Although using static ARP tables means that configuring each IP address, ARP table, and MAC address manually, the system will refuse any outside attempts to change those values.</p>
<p>The static solution is not very efficient when used in a big company or firm, but is an ideal solution for small companies where values are more likely to be configured. If a table is set up so that it's fixed and not dynamic, any ARP poisoning attack should fail.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we looked at how we can detect ARP attacks on a system. First, we learned what an ARP attack is and launched one ourselves. Then we saw how to detect an ARP attack, as well as general suspicious behavior with the use of Wireshark.</p>
<p>The next few chapters we are going to look at how we can gain access to the victims machines for which we will be learning about the server-side and client-side attacks.</p>


            </article>

            
        </section>
    </body></html>