<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Introduction to Malware Analysis</h1>
                
            
            <article>
                
<p class="calibre2">The number of cyber attacks is undoubtedly on the rise, targeting government, military, public and private sectors. These cyber attacks focus on targeting individuals or organizations with an effort to extract valuable information. Sometimes, these cyber attacks are allegedly linked to cybercrime or state-sponsored groups, but may also be carried out by individual groups to achieve their goals. Most of these cyber attacks use malicious software (also called malware) to infect their targets. Knowledge, skills, and tools required to analyze malicious software are essential to detect, investigate and defend against such attacks.</p>
<p class="calibre2">In this chapter, you will learn the following topics:</p>
<ul class="calibre11">
<li class="calibre12">What malware means and its role in the cyber-attacks</li>
<li class="calibre12">Malware analysis and its significance in digital forensics</li>
<li class="calibre12">Different types of malware analysis</li>
<li class="calibre12">Setting up the lab environment</li>
<li class="calibre12">Various sources to obtain malware samples</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">1. What Is Malware?</h1>
                
            
            <article>
                
<p class="calibre2">Malware is a code that performs malicious actions; it can take the form of an executable, script, code, or any other software. Attackers use malware to steal sensitive information, spy on the infected system, or take control of the system. It typically gets into your system without your consent and can be delivered via various communication channels such as email, web, or USB drives.</p>
<p class="calibre2">The following are some of the malicious actions performed by malware:</p>
<ul class="calibre11">
<li class="calibre12">Disrupting computer operations</li>
<li class="calibre12">Stealing sensitive information, including personal, business, and financial data</li>
<li class="calibre12">Unauthorized access to the victim's system</li>
<li class="calibre12">Spying on the victims</li>
<li class="calibre12">Sending spam emails</li>
<li class="calibre12">Engaging in distributed-denial-of-service attacks (DDOS)</li>
<li class="calibre12">Locking up the files on the computer and holding them for ransom</li>
</ul>
<p class="calibre2"><em class="calibre17">Malware</em> is a broad term that refers to different types of malicious programs such as trojans, viruses, worms, and rootkits. While performing malware analysis, you will often come across various types of malicious programs; some of these malicious programs are categorized based on their functionality and attack vectors as mentioned here:</p>
<ul class="calibre11">
<li class="calibre12"><strong class="calibre1">Virus or Worm</strong>: Malware that is capable of copying itself and spreading to other computers. A virus needs user intervention, whereas a worm can spread without user intervention.</li>
<li class="calibre12"><strong class="calibre1">Trojan</strong>: Malware that disguises itself as a regular program to trick users to install it on their systems. Once installed, it can perform malicious actions such as stealing sensitive data, uploading files to the attacker's server, or monitoring webcams.</li>
<li class="calibre12"><strong class="calibre1">Backdoor / Remote Access Trojan (RAT)</strong>: This is a type of <em class="calibre19">Trojan</em> that enables the attacker to gain access to and execute commands on the compromised system.</li>
<li class="calibre12"><strong class="calibre1">Adware</strong>: Malware that presents unwanted advertisements (ads) to the user. They usually get delivered via free downloads and can forcibly install software on your system.</li>
<li class="calibre12"><strong class="calibre1">Botnet</strong>: This is a group of computers infected with the same malware (called <em class="calibre19">bots</em>), waiting to receive instructions from the command-and-control server controlled by the attacker. The attacker can then issue a command to these bots, which can perform malicious activities such as DDOS attacks or sending spam emails.</li>
<li class="calibre12"><strong class="calibre1">Information stealer</strong>: Malware designed to steal sensitive data such as banking credentials or typed keystrokes from the infected system. Some examples of these malicious programs include key loggers, spyware, sniffers, and form grabbers.</li>
<li class="calibre12"><strong class="calibre1">Ransomware</strong>: Malware that holds the system for ransom by locking users out of their computer or by encrypting their files.</li>
<li class="calibre12"><strong class="calibre1">Rootkit</strong>: Malware that provides the attacker with privileged access to the infected system and conceals its presence or the presence of other software.</li>
<li class="calibre12"><strong class="calibre1">Downloader or dropper</strong>: Malware designed to download or install additional malware components.</li>
</ul>
<div class="packt_infobox">A handy resource for understanding malware terminologies and definitions is available at <a href="https://blog.malwarebytes.com/glossary/" class="calibre20">https://blog.malwarebytes.com/glossary/</a>.</div>
<p class="calibre2">Classifying malware based on their functionalities may not always be possible because a single malware can contain multiple functionalities, which may fall into a variety of categories mentioned just now. For example, malware can include a worm component that scans the network looking for vulnerable systems and can drop another malware component such as a <em class="calibre17">backdoor</em> or a <em class="calibre17">ransomware</em> upon successful exploitation.</p>
<p class="calibre2">Malware classification can also be undertaken based on the attacker's motive. For example, if the malware is used to steal personal, business, or proprietary information for profit, then the malware can be classified as c<em class="calibre17">rimeware</em> or c<em class="calibre17">ommodity malware</em>. If the malware is used to target a particular organization or industry to steal information/gather intelligence for espionage, then it can be classified as t<em class="calibre17">argeted</em> or e<em class="calibre17">spionage malware</em>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">2. What Is Malware Analysis?</h1>
                
            
            <article>
                
<p class="calibre2">Malware analysis is the study of malware's behavior. The objective of malware analysis is to understand the working of malware and how to detect and eliminate it. It involves analyzing the suspect binary in a safe environment to identify its characteristics and functionalities so that better defenses can be built to protect an organization's network.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">3. Why Malware Analysis?</h1>
                
            
            <article>
                
<p class="calibre2">The primary motive behind performing malware analysis is to extract information from the malware sample, which can help in responding to a malware incident. The goal of malware analysis is to determine the capability of malware, detect it, and contain it. It also helps in determining identifiable patterns that can be used to cure and prevent future infections. The following are some of the reasons why you will perform malware analysis:</p>
<ul class="calibre11">
<li class="calibre12">To determine the nature and purpose of the malware. For example, it can help you determine whether malware is an information stealer, HTTP bot, spam bot, rootkit, keylogger, or RAT, <span>and so on</span>.</li>
<li class="calibre12">To gain an understanding of how the system was compromised and its impact.</li>
<li class="calibre12">To identify the network indicators associated with the malware, which can then be used to detect similar infections using network monitoring. For example, during your analysis, if you determine that a malware contacts a particular <em class="calibre19">domain/IP address</em>, then you can use this domain/IP address to create a signature and monitor the network traffic to identify all the hosts contacting that domain/IP address.</li>
<li class="calibre12">To extract host-based indicators such as filenames, and registry keys, which, in turn, can be used to determine similar infection using host-based monitoring. For instance, if you learn that a malware creates a registry key, you can use this registry key as an indicator to create a signature, or scan your network to identify the hosts that have the same registry key.</li>
<li class="calibre12">To determine the attacker's intention and motive. For instance, during your analysis, if you find that the malware is stealing banking credentials, then you can deduce that the motive of the attacker is monetary gain.</li>
</ul>
<div class="packt_infobox">Threat intelligence teams very often use the indicators determined from a malware analysis to classify the attack and attribute them to known threats. Malware analysis can help you get information about who could be behind the attack (competitor, state-sponsored attack group, <span class="calibre21">and so on</span>).</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">4. Types Of Malware Analysis</h1>
                
            
            <article>
                
<p class="calibre2">To understand the working and the characteristics of malware and to assess its impact on the system, you will often use different analysis techniques. The following is the classification of these analysis techniques:</p>
<ul class="calibre11">
<li class="calibre12"><strong class="calibre1">Static analysis</strong>: This is the process of analyzing a binary without executing it. It is easiest to perform and allows you to extract the metadata associated with the suspect binary. Static analysis might not reveal all the required information, but it can sometimes provide interesting information that helps in determining where to focus your subsequent analysis efforts. <a href="part0032.html#UGI00-ac10ba3f98854c44bac1c2c5641ca485" class="calibre10">Chapter 2</a>, <em class="calibre19">Static Analysis</em>, covers the tools and techniques to extract useful information from the malware binary using static analysis.</li>
<li class="calibre12"><strong class="calibre1">Dynamic analysis (Behavioral Analysis)</strong>: This is the process of executing the suspect binary in an isolated environment and monitoring its behavior. This analysis technique is easy to perform and gives valuable insights into the activity of the binary during its execution. This analysis technique is useful but does not reveal all the functionalities of the hostile program. <a target="_blank" href="part0065.html#1TVKI0-ac10ba3f98854c44bac1c2c5641ca485" class="calibre10">Chapter 3</a>, <em class="calibre19">Dynamic Analysis</em>, covers the tools and techniques to determine the behavior of the malware using dynamic analysis.</li>
<li class="calibre12"><strong class="calibre1">Code analysis</strong>: It is an advanced technique that focuses on analyzing the code to understand the inner workings of the binary. This technique reveals information that is not possible to determine just from static and dynamic analysis. Code analysis is further divided into <em class="calibre19">Static code analysis</em> and <em class="calibre19">Dynamic code analysis</em>. <em class="calibre19">Static code analysis</em> involves disassembling the suspect binary and looking at the code to understand the program's behavior, whereas <em class="calibre19">Dynamic code analysis </em>involves debugging the suspect binary in a controlled manner to understand its functionality. Code analysis requires an understanding of the programming language and operating system concepts. The upcoming chapters (<em class="calibre19">Chapters 4 to 9</em>) will cover the knowledge, tools, and techniques required to perform code analysis.</li>
<li class="calibre12"><strong class="calibre1">Memory analysis (Memory forensics)</strong>: This is the technique of analyzing the computer's RAM for forensic artifacts. It is typically a forensic technique, but integrating it into your malware analysis will assist in gaining an understanding of the malware's behavior after infection. Memory analysis is especially useful to determine the stealth and evasive capabilities of the malware. You will learn how to perform memory analysis in subsequent chapters (<em class="calibre19">Chapters 10 and 11</em>).</li>
</ul>
<div class="packt_tip">Integrating different analysis techniques while performing malware analysis can reveal a wealth of contextual information, which will prove to be valuable in your malware investigation.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">5. Setting Up The Lab Environment</h1>
                
            
            <article>
                
<p class="calibre2">Analysis of a hostile program requires a safe and secure lab environment, as you do not want to infect your system or the production system. A malware lab can be very simple or complex depending on the resources available to you (hardware, virtualization software, Windows license, and so on). This section will guide you to set up a simple personal lab on a single physical system consisting of <em class="calibre17">virtual machines (VMs)</em>. <span class="calibre7">If you wish to set up a similar lab environment, feel free to follow along or skip to the next section (<em class="calibre17">Section 6: Malware Sources</em>).</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">5.1 Lab Requirements</h1>
                
            
            <article>
                
<p class="calibre2">Before you begin setting up a lab, you need a few components: a <em class="calibre17">physical system</em> running a base operating system of <em class="calibre17">Linux, Windows</em>, or <em class="calibre17">macOS X</em>, and installed with virtualization software (such as <em class="calibre17">VMware</em> or <em class="calibre17">VirtualBox</em>). When analyzing the malware, you will be executing the malware on a Windows-based virtual machine (Windows VM). The advantage of using a virtual machine is that after you finish analyzing the malware, you can revert it to a clean state.</p>
<div class="packt_infobox"><em class="calibre22">VMware Workstation</em> for Windows and Linux is available for download from <a href="https://www.vmware.com/products/workstation/workstation-evaluation.html" class="calibre20">https://www.vmware.com/products/workstation/workstation-evaluation.html</a>, and <em class="calibre22">VMware Fusion</em> for macOS X is available for download from <a href="https://www.vmware.com/products/fusion/fusion-evaluation.html" class="calibre20">https://www.vmware.com/products/fusion/fusion-evaluation.html</a>. VirtualBox for different flavors of operating systems is available for download from <a href="https://www.virtualbox.org/wiki/Downloads" class="calibre20">https://www.virtualbox.org/wiki/Downloads</a>.                                                                                   </div>
<p class="calibre2">To create a safe lab environment, you should take the necessary precautions to avoid malware from escaping the virtualized environment and infecting your physical (host) system. <span class="calibre7">The following </span>are a few points to remember when setting up the virtualized lab:</p>
<ul class="calibre11">
<li class="calibre12">Keep your virtualization software up to date. This is necessary because it might be possible for malware to exploit a vulnerability in the virtualization software, escape from the virtual environment, and infect your host system.</li>
<li class="calibre12">Install a fresh copy of the operating system inside the virtual machine (VM), and do not keep any sensitive information in the virtual machine.</li>
<li class="calibre12">While analyzing a malware, if you don't want the malware to reach out to the Internet, then you should consider using <em class="calibre19">host-only</em> network configuration mode or restrict your network traffic within your lab environment using simulated services.</li>
<li class="calibre12">Do not connect any removable media that might later be used on the physical machines, <span>such as USB drives</span>.</li>
<li class="calibre12">Since you will be analyzing Windows malware (typically Executable or DLL), it is recommended to choose a base operating system such as Linux or macOS X for your host machine instead of Windows. This is because, even if a Windows malware escapes from the virtual machine, it will still not be able to infect your host machine.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">5.2 Overview Of Lab Architecture</h1>
                
            
            <article>
                
<p class="calibre2">The lab architecture I will be using throughout the book consists of a <em class="calibre17">physical machine (called host machine)</em> running <em class="calibre17">Ubuntu Linux</em> with instances of <em class="calibre17">Linux virtual machine (Ubuntu Linux VM)</em> and <em class="calibre17">Windows virtual machine (Windows VM)</em>. These virtual machines will be configured to be part of the same network and use <em class="calibre17">Host-only</em> network configuration mode so that the malware is not allowed to contact the Internet and network traffic is contained in the isolated lab environment.</p>
<p class="calibre2"><em class="calibre17">Windows VM</em> is where the malware will be executed during analysis, and the <em class="calibre17">Linux VM</em> is used to monitor the network traffic and will be configured to simulate Internet services (DNS, HTTP, <span class="calibre7">and so on</span>) to provide an appropriate response when the malware requests for these services. For example, the Linux VM will be configured such that when the malware requests a service such as DNS, the Linux VM will provide the proper DNS response. <a target="_blank" href="part0065.html#1TVKI0-ac10ba3f98854c44bac1c2c5641ca485" class="calibre10">Chapter 3</a>, <em class="calibre17">Dynamic Analysis</em>, covers this concept in detail.</p>
<p class="calibre2">The following figure shows an example of a simple lab architecture, which I will use in this book. In this setup, the <em class="calibre17">Linux VM</em> will be preconfigured to IP address <kbd class="calibre13">192.168.1.100</kbd>, and the IP address of the <em class="calibre17">Windows VM</em> will be set to <kbd class="calibre13">192.168.1.x</kbd> (where x is any number from <kbd class="calibre13">1</kbd> to <kbd class="calibre13">254</kbd> except <kbd class="calibre13">100</kbd>). The default gateway and the DNS of the Windows VM will be set to the IP address of the Linux VM (that is, <kbd class="calibre13">192.168.1.100</kbd>) so that all of the Windows network traffic is routed through the Linux VM. The upcoming section will guide you to set up the Linux VM and Windows VM to match with this setup.</p>
<div class="cdpaligncenter"><img src="../images/00005.jpeg" class="calibre23"/></div>
<div class="packt_tip">You need not restrict yourself to the lab architecture shown in the preceding Figure; different lab configurations are possible, it is not feasible to provide instructions on every possible configuration. In this book, I will show you how to set up and use the lab architecture shown in the <span class="calibre21">preceding </span>figure.</div>
<p class="calibre2">It is also possible to set up a lab consisting of multiple VMs running different versions of Windows; this will allow you to analyze the malware specimen on various versions of Windows operating systems. An example configuration containing multiple Windows VMs will look similar to the one shown in the following diagram:</p>
<div class="cdpaligncenter"><img src="../images/00006.jpeg" class="calibre24"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">5.3 Setting Up And Configuring Linux VM</h1>
                
            
            <article>
                
<p class="calibre2">To set up the Linux VM, I will use <em class="calibre17">Ubuntu 16.04.2 LTS</em> <span class="calibre7">Linux distribution</span> (<a href="http://releases.ubuntu.com/16.04/" class="calibre10">http://releases.ubuntu.com/16.04/</a>). The reason I have chosen Ubuntu is that most of the tools covered in this book are either preinstalled or available through the <em class="calibre17">apt-get</em> package manager. The following is a step-by-step procedure to configure Ubuntu 16.04.2 LTS on <em class="calibre17">VMware</em> and <em class="calibre17">VirtualBox.</em> Feel free to follow the instructions given here depending on the virtualization software (either <em class="calibre17">VMware</em> or <em class="calibre17">VirtualBox</em>) installed on your system:</p>
<p class="calibre2"><strong class="calibre5"> </strong></p>
<div class="packt_infobox">If you are not familiar with installing and configuring virtual machines, refer to VMware's guide at <a href="http://pubs.vmware.com/workstation-12/topic/com.vmware.ICbase/PDF/workstation-pro-12-user-guide.pdf" class="calibre20">http://pubs.vmware.com/workstation-12/topic/com.vmware.ICbase/PDF/workstation-pro-12-user-guide.pdf</a> or the VirtualBox user manual (<a href="https://www.virtualbox.org/manual/UserManual.html" class="calibre20">https://www.virtualbox.org/manual/UserManual.html</a>).</div>
<ol class="calibre14">
<li value="1" class="calibre12">Download Ubuntu 16.04.2 LTS from <a href="http://releases.ubuntu.com/16.04/" target="_blank" class="calibre10">http://releases.ubuntu.com/16.04/</a> and install it in VMware Workstation/Fusion or VirtualBox. If you wish to install any other version of Ubuntu Linux, you are free to do so as long as you are comfortable installing packages and solving any dependency issues.</li>
<li value="2" class="calibre12">Install the <em class="calibre19">Virtualization Tools</em> <span>on Ubuntu; this will allow Ubuntu's screen resolution to automatically adjust to match your monitor's geometry and provide additional enhancements, such as the ability to share clipboard content and to copy/paste or drag and drop files across your underlying</span> <em class="calibre19">host machine</em> <span>and the</span> <em class="calibre19">Linux virtual machine</em><span>. To install virtualization tools on VMware Workstation or VMware Fusion, you can follow the procedure mentioned at </span><a href="https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1022525" class="calibre10">https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1022525</a> <span>or watch the video at </span><a href="https://youtu.be/ueM1dCk3o58" class="calibre10">https://youtu.be/ueM1dCk3o58</a><span>. Once installed, reboot the system.</span></li>
<li value="3" class="calibre12">If you are using <em class="calibre19">VirtualBox</em><span>, you must install </span><em class="calibre19">Guest Additions software</em><span>. To accomplish this, from the VirtualBox menu, select</span> <span><span>Devices</span> | <span>Insert guest additions CD image</span></span>. T<span>his will bring up the</span> <strong class="calibre1"> </strong><span>Guest Additions Dialog Window. T</span><span>hen click on</span> <span>Run</span> <span>to invoke the installer from the virtual CD. Authenticate with your password when prompted and reboot.</span></li>
<li value="4" class="calibre12">Once the Ubuntu operating system and the virtualization tools are installed, start the Ubuntu VM and install the following tools and packages.</li>
<li value="5" class="calibre12">Install <em class="calibre19">pip</em><span>; pip is a package management system used to install and manage packages written in Python. In this book, I will be running a few Python scripts; some of them rely on third-party libraries. To automate the installation of third-party packages, you need to install</span> <em class="calibre19">pip</em><span>. Run the following command in the terminal to install and upgrade</span> <em class="calibre19">pip</em><span>:</span></li>
</ol>
<pre class="calibre25"><strong class="calibre1">$ sudo apt-get update</strong><br class="title-page-name"/><strong class="calibre1">$ sudo apt-get install python-pip</strong><br class="title-page-name"/><strong class="calibre1">$ pip install --upgrade pip</strong></pre>
<p class="calibre26">The following are some of the tools and Python packages that will be used in this book. To install these tools and Python packages, run these commands in the terminal:</p>
<pre class="calibre25"><strong class="calibre1">$ sudo apt-get install python-magic</strong><br class="title-page-name"/><strong class="calibre1">$ sudo apt-get install upx</strong><br class="title-page-name"/><strong class="calibre1">$ sudo pip install pefile</strong><br class="title-page-name"/><strong class="calibre1">$ sudo apt-get install yara</strong><br class="title-page-name"/><strong class="calibre1">$ sudo pip install yara-python</strong><br class="title-page-name"/><strong class="calibre1">$ sudo apt-get install ssdeep</strong><br class="title-page-name"/><strong class="calibre1">$ sudo apt-get install build-essential libffi-dev python python-dev \ libfuzzy-dev</strong><br class="title-page-name"/><strong class="calibre1">$ sudo pip install ssdeep</strong><br class="title-page-name"/><strong class="calibre1">$ sudo apt-get install wireshark</strong><br class="title-page-name"/><strong class="calibre1">$ sudo apt-get install tshark</strong></pre>
<ol start="6" class="calibre14">
<li value="6" class="calibre12"><em class="calibre19">INetSim</em> (<a href="http://www.inetsim.org/index.html" class="calibre10">http://www.inetsim.org/index.html</a>) is a powerful utility that allows simulating various Internet services (such as DNS, and HTTP) that malware frequently expects to interact with. Later, you will understand how to configure <em class="calibre19">INetSim</em> to simulate services. To install INetSim, use the following commands. The use of INetSim will be covered in detail in <a target="_blank" href="part0065.html#1TVKI0-ac10ba3f98854c44bac1c2c5641ca485" class="calibre10">Chapter 3</a>, <em class="calibre19">Dynamic Analysis</em>. If you have difficulties installing INetSim, refer to the documentation (<a href="http://www.inetsim.org/packages.html" class="calibre10">http://www.inetsim.org/packages.html</a>):</li>
</ol>
<pre class="calibre25"><strong class="calibre1">$ sudo su </strong><br class="title-page-name"/><strong class="calibre1"># echo "deb http://www.inetsim.org/debian/ binary/" &gt; \ /etc/apt/sources.list.d/inetsim.list</strong><br class="title-page-name"/><strong class="calibre1"># wget -O - http://www.inetsim.org/inetsim-archive-signing-key.asc | \ <br class="title-page-name"/>apt-key add -</strong><br class="title-page-name"/><strong class="calibre1"># apt update</strong><br class="title-page-name"/><strong class="calibre1"># apt-get install inetsim</strong></pre>
<ol start="7" class="calibre14">
<li value="7" class="calibre12">You can now isolate Ubuntu VM within your lab by configuring the virtual appliance to use <em class="calibre19">Host-only</em> network mode. On <em class="calibre19">VMware,</em> bring up the <span>Network Adapter Settings</span> and choose <span>Host-only mode</span> as shown in the <span>following </span><em class="calibre19">Figure</em>. Save the settings and reboot<em class="calibre19">.</em></li>
</ol>
<div class="cdpaligncenter"><img src="../images/00007.jpeg" class="calibre27"/></div>
<p class="calibre26">In VirtualBox, shut down <em class="calibre17">Ubuntu VM</em> and then<em class="calibre17"> </em>bring up <span class="calibre7">Settings</span>. Select <span class="calibre7">Network</span> and change the adapter settings to <span class="calibre7">Host-only Adapter</span> as shown in the following diagram; click on <span class="calibre7">OK</span>.</p>
<div class="packt_tip">On VirtualBox, sometimes when you choose the <span class="calibre21">Host-only adapter</span> option, the interface name might appear as <em class="calibre22">Not selected.</em> In that case, you need to first create at least one host-only interface by navigating to <span class="calibre21">File</span>| <span class="calibre21">Preferences</span> | <span class="calibre21">Network</span> | <span class="calibre21">Host-only networks</span> | <span class="calibre21">Add host-only</span> network. Click on <span class="calibre21">OK</span>; then<strong class="calibre28"> b</strong>ring up the <span class="calibre21">Settings</span>. Select <span class="calibre21">Network</span> and change the adapter settings to <span class="calibre21">Host-only Adapter</span>, as shown in the following screenshot. Click on <span class="calibre21">OK</span>.</div>
<div class="cdpaligncenter"><img src="../images/00008.jpeg" class="calibre29"/></div>
<ol start="8" class="calibre14">
<li value="8" class="calibre12">Now we will assign a static IP address of <kbd class="calibre13">192.168.1.100</kbd> to the Ubuntu Linux VM. To do that, power on the Linux VM, open the terminal window, type the command <kbd class="calibre13">ifconfig</kbd>, and note down the interface name. In my case, the interface name is <kbd class="calibre13">ens33</kbd>. In your case, the interface name might be different. If it is different, you need to make changes to the following steps accordingly<strong class="calibre1">.</strong> Open the file <kbd class="calibre13">/etc/network/interfaces</kbd> using the <span>following </span>command:</li>
</ol>
<pre class="calibre25"><strong class="calibre1">$ sudo gedit /etc/network/interfaces</strong></pre>
<p class="calibre26">Add the <span class="calibre7">following </span>entries at the end of the file (make sure you replace <kbd class="calibre13">ens33</kbd> with the interface name on your system) and save it:</p>
<pre class="calibre25">auto ens33<br class="title-page-name"/>iface ens33 inet static<br class="title-page-name"/>address 192.168.1.100<br class="title-page-name"/>netmask 255.255.255.0</pre>
<p class="calibre26">The <kbd class="calibre13">/etc/network/interfaces</kbd> file should now look like the one shown here. Newly added entries are highlighted here:</p>
<pre class="calibre25"># interfaces(5) file used by ifup(8) and ifdown(8)<br class="title-page-name"/>auto lo<br class="title-page-name"/>iface lo inet loopback<br class="title-page-name"/><br class="title-page-name"/><strong class="calibre1">auto ens33</strong><br class="title-page-name"/><strong class="calibre1">iface ens33 inet static</strong><br class="title-page-name"/><strong class="calibre1">address 192.168.1.100</strong><br class="title-page-name"/><strong class="calibre1">netmask 255.255.255.0</strong></pre>
<p class="calibre26">Then restart the Ubuntu Linux VM. At this point, the IP address of the Ubuntu VM should be set to <kbd class="calibre13">192.168.1.100</kbd>. You can verify that by running the following command:</p>
<pre class="calibre25">$ <strong class="calibre1">ifconfig</strong><br class="title-page-name"/>ens33 Link encap:Ethernet HWaddr 00:0c:29:a8:28:0d <br class="title-page-name"/>inet addr:<strong class="calibre1">192.168.1.100</strong> Bcast:192.168.1.255 Mask:255.255.255.0<br class="title-page-name"/>inet6 addr: fe80::20c:29ff:fea8:280d/64 Scope:Link<br class="title-page-name"/>UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1<br class="title-page-name"/>RX packets:21 errors:0 dropped:0 overruns:0 frame:0<br class="title-page-name"/>TX packets:49 errors:0 dropped:0 overruns:0 carrier:0<br class="title-page-name"/>collisions:0 txqueuelen:1000 <br class="title-page-name"/>RX bytes:5187 (5.1 KB) TX bytes:5590 (5.5 KB)</pre>
<ol start="9" class="calibre14">
<li value="9" class="calibre12">The next step is to configure <em class="calibre19">INetSim</em> so that it can listen to and simulate all the services on the configured IP address <kbd class="calibre13">192.168.1.100</kbd>. By default, it listens on the local interface (<kbd class="calibre13">127.0.0.1</kbd>), which needs to be changed to <kbd class="calibre13">192.168.1.100</kbd>. To do that, open the configuration file located at <kbd class="calibre13">/etc/inetsim/inetsim.conf</kbd> using the following command:</li>
</ol>
<pre class="calibre25">$ <strong class="calibre1">sudo gedit /etc/inetsim/inetsim.conf</strong></pre>
<p class="calibre26">Go to the <kbd class="calibre13">service_bind_address</kbd> section in the configuration file and add the entry shown here:</p>
<pre class="calibre30">service_bind_address   192.168.1.100</pre>
<p class="calibre26">The added entry (highlighted) in the configuration file should look like this:</p>
<pre class="calibre25"># service_bind_address<br class="title-page-name"/>#<br class="title-page-name"/># IP address to bind services to<br class="title-page-name"/>#<br class="title-page-name"/># Syntax: service_bind_address &lt;IP address&gt;<br class="title-page-name"/>#<br class="title-page-name"/># Default: 127.0.0.1<br class="title-page-name"/>#<br class="title-page-name"/>#service_bind_address 10.10.10.1<br class="title-page-name"/><strong class="calibre1">service_bind_address 192.168.1.100</strong></pre>
<p class="calibre26">By default, INetSim's DNS server will resolve all the domain names to <kbd class="calibre13">127.0.0.1</kbd>. Instead of that, we want the domain name to resolve to <kbd class="calibre13">192.168.1.100</kbd> (the IP address of Linux VM). To do that, go to the <kbd class="calibre13">dns_default_ip</kbd> section in the configuration file and add an entry as shown here:</p>
<pre class="calibre25">dns_default_ip  192.168.1.100</pre>
<p class="calibre26">The added entry (highlighted in<span class="calibre7"> the following code</span>) in the configuration file should look like this:</p>
<pre class="calibre25"># dns_default_ip<br class="title-page-name"/>#<br class="title-page-name"/># Default IP address to return with DNS replies<br class="title-page-name"/>#<br class="title-page-name"/># Syntax: dns_default_ip &lt;IP address&gt;<br class="title-page-name"/>#<br class="title-page-name"/># Default: 127.0.0.1<br class="title-page-name"/>#<br class="title-page-name"/>#dns_default_ip 10.10.10.1<br class="title-page-name"/><strong class="calibre1">dns_default_ip 192.168.1.100</strong></pre>
<p class="calibre26">Once the configuration changes are done, <span class="calibre7">Save</span> the configuration file and launch the INetSim main program. Verify that all the services are running and also check whether the <kbd class="calibre13">inetsim</kbd> is listening on <kbd class="calibre13">192.168.1.100</kbd>, as highlighted in the following code. You can stop the service by pressing <em class="calibre17">CTRL+C</em>:</p>
<pre class="calibre25">$ <strong class="calibre1">sudo inetsim</strong><br class="title-page-name"/>INetSim 1.2.6 (2016-08-29) by Matthias Eckert &amp; Thomas Hungenberg<br class="title-page-name"/>Using log directory: /var/log/inetsim/<br class="title-page-name"/>Using data directory: /var/lib/inetsim/<br class="title-page-name"/>Using report directory: /var/log/inetsim/report/<br class="title-page-name"/>Using configuration file: /etc/inetsim/inetsim.conf<br class="title-page-name"/>=== INetSim main process started (PID 2640) ===<br class="title-page-name"/>Session ID: 2640<br class="title-page-name"/>Listening on: <strong class="calibre1">192.168.1.100</strong><br class="title-page-name"/>Real Date/Time: 2017-07-08 07:26:02<br class="title-page-name"/>Fake Date/Time: 2017-07-08 07:26:02 (Delta: 0 seconds)<br class="title-page-name"/> Forking services...<br class="title-page-name"/> * irc_6667_tcp - started (PID 2652)<br class="title-page-name"/> * ntp_123_udp - started (PID 2653)<br class="title-page-name"/> * ident_113_tcp - started (PID 2655)<br class="title-page-name"/> * time_37_tcp - started (PID 2657)<br class="title-page-name"/> * daytime_13_tcp - started (PID 2659)<br class="title-page-name"/> * discard_9_tcp - started (PID 2663)<br class="title-page-name"/> * echo_7_tcp - started (PID 2661)<br class="title-page-name"/> * dns_53_tcp_udp - started (PID 2642)<br class="title-page-name"/> [..........REMOVED.............]<br class="title-page-name"/> * http_80_tcp - started (PID 2643)<br class="title-page-name"/> * https_443_tcp - started (PID 2644)<br class="title-page-name"/> done.<br class="title-page-name"/>Simulation running.</pre>
<ol start="10" class="calibre14">
<li value="10" class="calibre12">At some point, you need the ability to transfer files between the host and the virtual machine. To enable that on <em class="calibre19">VMware</em>, power off the virtual machine and bring up the <span>Settings</span>. Select <span>Options</span> | <span>Guest Isolation</span> and check both <span>Enable drag and drop</span> and <span>Enable copy and paste</span>. <span>Save</span> the settings.</li>
</ol>
<p class="calibre26">On <em class="calibre17">Virtualbox</em>, while the virtual machine is powered off, bring up <span class="calibre7">Settings</span> | <span class="calibre7">General</span> | <span class="calibre7">Advanced</span> and make sure that both <span class="calibre7">Shared Clipboard and Drag 'n' Drop</span> are set to <span class="calibre7">Bidirectional</span>. Click on <span class="calibre7">OK</span>.</p>
<ol start="11" class="calibre14">
<li value="11" class="calibre12">At this point, the Linux VM is configured to use <span>Host-only</span> mode, and INetSim is set up to simulate all the services. The last step is to take a snapshot (clean snapshot) and give it a name of your choice so that you can revert it back to the clean state when required. To take a snapshot on  <span>VMware workstation</span>, click on <span>VM</span> | <span>Snapshot</span> | <span>Take Snapshot</span>. On <span>Virtualbox</span>, the same can be done by clicking on <span>Machine</span> | <span>Take Snapshot</span>.</li>
</ol>
<div class="packt_tip">Apart from the <em class="calibre22">drag and drop</em> feature, it is also possible to transfer files from the host machine to the virtual machine using shared folders; refer to the following for VirtualBox (<a href="https://www.virtualbox.org/manual/ch04.html#sharedfolders" class="calibre20">https://www.virtualbox.org/manual/ch04.html#sharedfolders</a>) and to the following for VMware (<a href="https://docs.vmware.com/en/VMware-Workstation-Pro/14.0/com.vmware.ws.using.doc/GUID-AACE0935-4B43-43BA-A935-FC71ABA17803.html" target="_blank" class="calibre20">https://docs.vmware.com/en/VMware-Workstation-Pro/14.0/com.vmware.ws.using.doc/GUID-AACE0935-4B43-43BA-A935-FC71ABA17803.html</a>).</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">5.4 Setting Up And Configuring Windows VM</h1>
                
            
            <article>
                
<p class="calibre2">Before setting up the Windows VM, you first need to install a Windows operating system (Windows 7, Window 8, and so on) of your choice in the virtualization software (such as VMware or VirtualBox). Once you have Windows installed, follow these steps:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Download Python from <a href="https://www.python.org/downloads/" class="calibre10">https://www.python.org/downloads/</a>. Be sure to download <em class="calibre19">Python 2.7.x</em> (such as 2.7.13); most of the scripts used in this book are written to run on the Python 2.7 version and may not run correctly on Python 3. After you've downloaded the file, run the installer. Make sure you check the option to install <span>pip</span> and <span>Add python.exe to Path</span>, as shown in the following screenshot. Installing pip will make it easier to install any third-party Python libraries, and adding Python to the path will make it easier to run Python from any location.<strong class="calibre1"><br class="title-page-name"/></strong></li>
</ol>
<div class="cdpaligncenter"><img src="../images/00009.jpeg" class="calibre31"/></div>
<ol start="2" class="calibre14">
<li value="2" class="calibre12">Configure your Windows VM to run in <span>Host-only</span> network configuration mode. To do that in <span>VMware</span> or <span>VirtualBox</span>, bring up the <span>Network Settings</span> and choose the <span>Host-only mode</span>; save the settings and reboot <strong class="calibre1">(t</strong>his step is similar to the one covered in the <em class="calibre19">Setting Up and Configuring Linux VM</em> section).</li>
<li value="3" class="calibre12">Configure the IP address of the Windows VM to <kbd class="calibre13">192.168.1.x</kbd> (choose any IP address except <kbd class="calibre13">192.168.1.100</kbd> because the Linux VM is set to use that IP) and set up your <span>Default gateway</span> and the <span>DNS server</span> to the IP address of Linux VM (that is, <kbd class="calibre13">192.168.1.100</kbd>), as shown in the following screenshot<em class="calibre19">.</em> This configuration is required so that when we execute the hostile program on the Windows VM, all of the network traffic will be routed through the Linux VM.</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00010.jpeg" class="calibre32"/></div>
<ol start="4" class="calibre14">
<li value="4" class="calibre12">Power on both the <span>Linux VM</span> and the <span>Window VM</span>, and make sure they can communicate with each other. You can check for the connectivity by running the ping command, as shown in this screenshot:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00011.jpeg" class="calibre33"/></div>
<ol start="5" class="calibre14">
<li value="5" class="calibre12">Windows Defender Service needs to be disabled on your Windows VM as it may interfere when you are executing the malware sample. To do that, press the <em class="calibre19">Windows key + R</em> to open the Run menu, enter <em class="calibre19">gpedit.msc</em>, and hit <em class="calibre19"><span>Enter</span></em> to launch the <span>Local Group Policy Editor</span>. In the left-hand pane of <span>Local Group Policy Editor</span>, navigate to <span>Computer Configuration</span> <span>|</span> <span>Administrative Templates</span> <span>|</span> <span>Windows Components</span> <span>|</span> <span>Windows Defender</span><span>. In the right-hand pane, double-click on the</span> <span>Turn off Windows Defender policy</span> <span>to edit it; then select</span> <span>Enabled</span> <span>and click on</span> <span>OK</span><span>:</span></li>
</ol>
<div class="cdpaligncenter"><img src="../images/00012.jpeg" class="calibre34"/></div>
<ol start="6" class="calibre14">
<li value="6" class="calibre12">To be able to transfer files (drag and drop) and to copy clipboard content between the host machine and the Windows VM, follow the instructions as mentioned in S<em class="calibre19">tep 7 of</em> the <em class="calibre19">Setting Up and Configuring Linux VM</em> section<em class="calibre19">.</em></li>
<li value="7" class="calibre12">Take a clean snapshot so that you can revert to the pristine/clean state after every analysis. The procedure to take a snapshot was covered in <em class="calibre19">Step 10 of</em> the <em class="calibre19">Setting Up and Configuring Linux VM</em> section<em class="calibre19">.</em></li>
</ol>
<p class="calibre2">At this point, your lab environment should be ready. The Linux and Windows VMs in your clean snapshot should be in <span class="calibre7">Host-only</span> network mode and should be able to communicate with each other. <span class="calibre7">Throughout this book, I will be covering various malware analysis tools; if you wish to use those tools, you can copy them to the clean snapshot on the virtual machines. To keep your clean snapshot up to date, just transfer/install those tools on the virtual machines and take a new clean </span>snapshot.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">6. Malware Sources</h1>
                
            
            <article>
                
<p class="calibre2">Once you have a lab set up, you will need malware samples for performing analysis. <span class="calibre7">In this book, I have used various malware samples in the examples, since these samples are from real attacks, I have decided not to distribute them as there may be legal issues distributing such samples with the book. You can find them (or similar samples) by searching various malware repositories. </span>The following are some of the sources from where you can get malware samples for your analysis. Some of these sources allow you to download malware samples for free (or after free registration), and some require you to contact the owner to set up an account, after which you will be able to obtain the samples:</p>
<ul class="calibre11">
<li class="calibre12"><em class="calibre19">Hybrid Analysis</em>: <a href="https://www.hybrid-analysis.com/" target="_blank" class="calibre10">https://www.hybrid-analysis.com/</a></li>
<li class="calibre12"><em class="calibre19">KernelMode.info</em>: <a href="http://www.kernelmode.info/forum/viewforum.php?f=16" target="_blank" class="calibre10">http://www.kernelmode.info/forum/viewforum.php?f=16</a></li>
<li class="calibre12"><em class="calibre19">VirusBay</em>: <a href="https://beta.virusbay.io/" target="_blank" class="calibre10">https://beta.virusbay.io/</a></li>
<li class="calibre12"><em class="calibre19">Contagio malware dump</em>: <a href="http://contagiodump.blogspot.com/" target="_blank" class="calibre10">http://contagiodump.blogspot.com/</a></li>
<li class="calibre12"><em class="calibre19">AVCaesar</em>: <a href="https://avcaesar.malware.lu/" target="_blank" class="calibre10">https://avcaesar.malware.lu/</a></li>
<li class="calibre12"><em class="calibre19">Malwr</em>: <a href="https://malwr.com/" target="_blank" class="calibre10">https://malwr.com/</a></li>
<li class="calibre12"><em class="calibre19">VirusShare</em>: <a href="https://virusshare.com/" target="_blank" class="calibre10">https://virusshare.com/</a></li>
<li class="calibre12"><em class="calibre19">theZoo</em>: <a href="http://thezoo.morirt.com/" target="_blank" class="calibre10">http://thezoo.morirt.com/</a></li>
</ul>
<p class="calibre2">You can find links to various other malware sources in Lenny Zeltser's blog post about <a href="https://zeltser.com/malware-sample-sources/" target="_blank" class="calibre10">https://zeltser.com/malware-sample-sources/</a>.</p>
<p class="calibre2">If none of the aforementioned methods work for you and you wish to get the malware samples used in this book, please feel free to contact the author.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">Setting up an isolated lab environment is crucial before analyzing malicious programs. While performing malware analysis, you will usually run the hostile code to observe its behavior, so having an isolated lab environment will prevent the accidental spreading of malicious code to your system or production systems on your network. In the next chapter<span class="calibre7">, you will learn about the tools and techniques to extract valuable information from the malware specimen using <em class="calibre17">Static Analysis.</em></span></p>


            </article>

            
        </section>
    </body></html>