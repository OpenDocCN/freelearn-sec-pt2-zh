<html><head></head><body>
		<div id="_idContainer099">
			<h1 id="_idParaDest-27"><em class="italic"><a id="_idTextAnchor027"/>Chapter 2</em>: Route the Hardware</h1>
			<p>This chapter will take you on the lovely journey of understanding how to connect physical <strong class="bold">hardware</strong> to virtual infrastructure. Understanding how a machine is running <strong class="bold">ESXi</strong> can route communications through to local <strong class="bold">Programmable Logic Controllers</strong> (<strong class="bold">PLCs</strong>), <strong class="bold">Human Machine Interfaces</strong> (<strong class="bold">HMIs</strong>), and other such devices. This section will utilize <strong class="bold">Koyo Click</strong> software and hardware to start with, as the Koyo Click PLC is a very cost-effective choice, and the engineering programming software is free to use, unlike other mainstream vendors who require you to pay hefty sums of money to license their programming software. Know that the principles and methods discussed in this chapter are reflected in those of other automation vendors, such as Siemens, Rockwell, Schneider, Omron, Mitsubishi, and many others. If getting access to a Koyo Click proves to be difficult, you can follow along with a PLC of your choice. Note that you will be required to get access to the engineering program software of the vendor that you choose. We will be installing the <strong class="bold">Click software</strong>, setting up the physical <strong class="bold">PLC</strong>, and finally, configuring the communication between a <em class="italic">virtual machine</em> and the physical PLC.</p>
			<p>Familiarizing yourself with how industrial technology is programmed will drastically increase your success rate in a pentest. Knowing the intricacies of how the software reacts, the resources it uses, and the communication method will allow you to detect possible vectors of entry going forward.</p>
			<p>In this chapter, we're going to cover the following main topics:</p>
			<ul>
				<li>Installing the Click software</li>
				<li>Setting up Koyo Click</li>
				<li>Configuring communication </li>
			</ul>
			<h1 id="_idParaDest-28"><a id="_idTextAnchor028"/>Technical requirements </h1>
			<p>For this chapter, you will need the following: </p>
			<ul>
				<li>Koyo Click software, which you can download from here: <a href="https://www.automationdirect.com/support/software-downloads?itemcode=CLICK">https://www.automationdirect.com/support/software-downloads?itemcode=CLICK</a></li>
				<li>Koyo Click hardware, which you can find here: <a href="https://www.automationdirect.com/adc/overview/catalog/programmable_controllers/click_series_plcs/">https://www.automationdirect.com/adc/overview/catalog/programmable_controllers/click_series_plcs/</a></li>
				<li>A Windows 7 Machine, which was covered in the previous chapter</li>
				<li>ESXi, as was covered in the previous chapter</li>
			</ul>
			<h1 id="_idParaDest-29"><a id="_idTextAnchor029"/>Installing the Click software</h1>
			<p>Welcome <a id="_idIndexMarker118"/>to the first topic of the chapter. In this section, we will be stepping through the installation of the Koyo Click software. This software will let us communicate with, and upload and download programs to and from, the Koyo Click PLC. </p>
			<p>I am going to preface this chapter by saying that, once again, this is not a sales pitch for Koyo Click or AutomationDirect; it simply is a very flexible, versatile, holistic, and cost-effective choice of PLC. Additionally, AutomationDirect <a id="_idIndexMarker119"/>is a one-stop-shop, whereby you can place an order and obtain everything you need to build a complete lab.</p>
			<p>With that disclaimer out of the way, let's navigate over to the <a id="_idIndexMarker120"/>AutomationDirect website. Please click on the following link: <a href="https://www.automationdirect.com/support/software-downloads?itemcode=CLICK">https://www.automationdirect.com/support/software-downloads?itemcode=CLICK</a>.</p>
			<p>We are going to download the software for programming a Koyo Click from AutomationDirect. Once you have navigated to the preceding link, this will land you on the following screen:</p>
			<div>
				<div id="_idContainer047" class="IMG---Figure">
					<img src="image/Figure_2.01_B16321.jpg" alt="Figure 2.1 – Click software download&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.1 – Click software download</p>
			<p>Next, you will <a id="_idIndexMarker121"/>proceed by clicking the green <strong class="bold">DOWNLOAD</strong> button, and this will then cast a notification update and require an <strong class="bold">Email Address</strong>, as shown in <em class="italic">Figure 2.2</em>, followed up by a <em class="italic">confirmation of the email address</em> to proceed further:</p>
			<div>
				<div id="_idContainer048" class="IMG---Figure">
					<img src="image/Figure_2.02_B16321.jpg" alt="Figure 2.2 – Email confirmation&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.2 – Email confirmation</p>
			<p>Once your email address is confirmed, the software starts to download. Now you should have the software downloaded. You will have to transfer it to your <strong class="bold">Windows 7</strong> virtual machine that we created in <a href="B16321_01_Epub_AM.xhtml#_idTextAnchor013"><em class="italic">Chapter 1</em></a>, <em class="italic">Using Virtualization</em>. There are many ways of doing this – building a second interface on the VM and placing it in the VM network segment on the <strong class="bold">ESXi hypervisor</strong> is one method that can be used. There are multiple different file <a id="_idIndexMarker122"/>transfer protocols/tools for moving this file. I simply default to what is the easiest option and this has become second nature to me. During assessments, I have performed many file drops and reverse shell pushes on boxes/machines by simply spinning up a <strong class="bold">Python 3</strong> web server and having the <strong class="bold">Windows 7</strong> machine navigate to the file and download it.</p>
			<p>Here is the command for initiating the Python 3 web server:</p>
			<div>
				<div id="_idContainer049" class="IMG---Figure">
					<img src="image/Figure_2.03_B16321.jpg" alt="Figure 2.3 – Initiating the python3 web server&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.3 – Initiating the python3 web server</p>
			<p>When the client connects, you can see an HTTP 200 OK success status response code as seen here:</p>
			<div>
				<div id="_idContainer050" class="IMG---Figure">
					<img src="image/Figure_2.04_B16321.jpg" alt="Figure 2.4 – Response code for success status&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.4 – Response code for success status</p>
			<p>As you can see, the Windows 7 machine connects and downloads the software file. The following screenshot shows the <strong class="bold">Directory listing</strong> hosted on the local server:</p>
			<div>
				<div id="_idContainer051" class="IMG---Figure">
					<img src="image/Figure_2.05_B16321.jpg" alt="Figure 2.5 – Python HTTP server directory listing&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.5 – Python HTTP server directory listing</p>
			<p>I have<a id="_idIndexMarker123"/> touched on this because it would be a good habit to build moving forward as it will come in handy during future <strong class="bold">pentesting</strong> engagements when you need to move files between your host machine and the box that you are trying to crack.</p>
			<p>This screenshot shows the <strong class="bold">CD Image</strong> that can be extracted to begin the installation process:</p>
			<div>
				<div id="_idContainer052" class="IMG---Figure">
					<img src="image/Figure_2.06_B16321.jpg" alt="Figure 2.6 – Koyo Click CD Image&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.6 – Koyo Click CD Image</p>
			<p>Now that we have the software downloaded to our Windows 7 <strong class="bold">Virtual Machine</strong> (<strong class="bold">VM</strong>), we want to extract the <strong class="bold">CD Image</strong> and run the <strong class="bold">Install</strong> option that follows: </p>
			<div>
				<div id="_idContainer053" class="IMG---Figure">
					<img src="image/Figure_2.07_B16321.jpg" alt="Figure 2.7 – Install Click software&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.7 – Install Click software</p>
			<p>This will<a id="_idIndexMarker124"/> then trigger a <strong class="bold">User Account Control</strong> (<strong class="bold">UAC</strong>) dialog box, shown in <em class="italic">Figure 2.8</em>, that we will want to click the <strong class="bold">Yes</strong> button on. After clicking <strong class="bold">Yes</strong>, the software will generate a dialog box allowing us to install the <strong class="bold">CLICK Programming Software</strong>:</p>
			<div>
				<div id="_idContainer054" class="IMG---Figure">
					<img src="image/Figure_2.08_B16321.jpg" alt="Figure 2.8 – Accept UAC install validation&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.8 – Accept UAC install validation</p>
			<p>The next series of screenshots will walk you through installing the Click programming software. We will click the <strong class="bold">Install Software</strong> button first, as seen here: </p>
			<div>
				<div id="_idContainer055" class="IMG---Figure">
					<img src="image/Figure_2.09_B16321.jpg" alt="Figure 2.9 – Click programming software&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.9 – Click programming software</p>
			<p>Now you<a id="_idIndexMarker125"/> should see the page shown in <em class="italic">Figure 2.10.</em> Click the <strong class="bold">Next &gt;</strong> button to proceed with the <strong class="bold">InstallShield Wizard</strong>, which will trigger a dialog box indicating that you should disable anti-virus software on your Windows 7 machine as it will cause issues with installing the programming software correctly and completely:</p>
			<div>
				<div id="_idContainer056" class="IMG---Figure">
					<img src="image/Figure_2.10_B16321.jpg" alt="Figure 2.10 – Click InstallShield&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.10 – Click InstallShield</p>
			<p>To enable this, you <a id="_idIndexMarker126"/>would have to simply click <strong class="bold">OK</strong> once you know that the anti-virus software is not on, and technically it should not be because we never installed any in <a href="B16321_01_Epub_AM.xhtml#_idTextAnchor013"><em class="italic">Chapter 1</em></a>, <em class="italic">Using Virtualization</em>:</p>
			<div>
				<div id="_idContainer057" class="IMG---Figure">
					<img src="image/Figure_2.11_B16321.jpg" alt="Figure 2.11 – Anti-virus check&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.11 – Anti-virus check</p>
			<p>In the next screenshot, we <a id="_idIndexMarker127"/>want to accept the <strong class="bold">License Agreement</strong> and press <strong class="bold">Next &gt;</strong>:</p>
			<div>
				<div id="_idContainer058" class="IMG---Figure">
					<img src="image/Figure_2.12_B16321.jpg" alt="Figure 2.12 – License Agreement&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.12 – License Agreement</p>
			<p>This will result in the page<a id="_idIndexMarker128"/> shown in <em class="italic">Figure 2.13</em>. In the boxes, fill out your <strong class="bold">User Name</strong> and <strong class="bold">Company Name</strong>. From <em class="italic">Figure 2.13</em>, you can tell that I've used my name, <strong class="source-inline">Paul Smith</strong>, and <strong class="source-inline">ICS Lab</strong> as the company name. This is an example of what to do but you would need to put in your own information: </p>
			<div>
				<div id="_idContainer059" class="IMG---Figure">
					<img src="image/Figure_2.13_B16321.jpg" alt="Figure 2.13 – Configure Customer Information&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.13 – Configure Customer Information</p>
			<p>Now the<a id="_idIndexMarker129"/> following page will load:</p>
			<div>
				<div id="_idContainer060" class="IMG---Figure">
					<img src="image/Figure_2.14_B16321.jpg" alt="Figure 2.14 – Choose Destination Location&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.14 – Choose Destination Location</p>
			<p>On this page, you<a id="_idIndexMarker130"/> will choose the destination of your software installation. I personally just kept the default folder structure as you can see in <em class="italic">Figure 2.14</em> to the left of the <strong class="bold">Change</strong> button. Then, you will click on the <strong class="bold">Next &gt;</strong> button, which then generates another dialog window to click through as follows: </p>
			<div>
				<div id="_idContainer061" class="IMG---Figure">
					<img src="image/Figure_2.15_B16321.jpg" alt="Figure 2.15 – Install the program&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.15 – Install the program</p>
			<p>Once the program<a id="_idIndexMarker131"/> is installed, InstallShield will ask you if you want to <strong class="bold">Create a Desktop Icon</strong>, shown in <em class="italic">Figure 2.16</em>. I chose this option as it will be easy to find going forward: </p>
			<div>
				<div id="_idContainer062" class="IMG---Figure">
					<img src="image/Figure_2.16_B16321.jpg" alt="Figure 2.16 – Create a Desktop Icon&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.16 – Create a Desktop Icon</p>
			<p>Finally, we are at <a id="_idIndexMarker132"/>the end of the installation, and it shouldn't have been too painful. Click on <strong class="bold">Finish</strong>, as seen in <em class="italic">Figure 2.17</em>, and then let's launch the software:</p>
			<p> </p>
			<div>
				<div id="_idContainer063" class="IMG---Figure">
					<img src="image/Figure_2.17_B16321.jpg" alt="Figure 2.17 – Finish the installation&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.17 – Finish the installation</p>
			<p>Launch <a id="_idIndexMarker133"/>the <strong class="bold">CLICK Programming Software</strong> icon by double-clicking. It should be visible on your desktop as follows: </p>
			<div>
				<div id="_idContainer064" class="IMG---Figure">
					<img src="image/Figure_2.18_B16321.jpg" alt="Figure 2.18 – CLICK Programming Software icon&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.18 – CLICK Programming Software icon</p>
			<p>This will launch the following dialog, allowing us to <strong class="bold">Start a new project</strong>, <strong class="bold">Open an existing project</strong>, or <strong class="bold">Connect to PLC</strong>:</p>
			<div>
				<div id="_idContainer065" class="IMG---Figure">
					<img src="image/Figure_2.19_B16321.jpg" alt="Figure 2.19 – Start a new project&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.19 – Start a new project</p>
			<p>Once we are<a id="_idIndexMarker134"/> here, we are all set up and ready to go.  </p>
			<p>Now, I wouldn't be doing you any justice if I didn't point out the obvious, and maybe you are asking yourself the same question: <strong class="bold">Where is the hash?</strong> This is a prime example of what a <strong class="bold">watering hole attack</strong> looks like. A watering hole attack<a id="_idIndexMarker135"/> is an exploit whereby an attacker has poisoned a software package or update and has published it to a website where users of the equipment or software come to download this corrupted file. This is very similar to what occurred with the <strong class="bold">SolarWinds</strong> attack, which we touched on briefly in <a href="B16321_01_Epub_AM.xhtml#_idTextAnchor013"><em class="italic">Chapter 1</em></a>, <em class="italic">Using Virtualization</em>. This type of attack can have a very deep and wide fallout if a well-used piece of technology is compromised. </p>
			<p>Therefore, going forward, be very wary of where you get software for your <strong class="bold">Industrial Control System</strong> (<strong class="bold">ICS</strong>) equipment and what control impact it has on your SCADA/ICS system. Now we will move on to setting up the hardware, but we will return to the software shortly.</p>
			<h1 id="_idParaDest-30"><a id="_idTextAnchor030"/>Setting up Koyo Click</h1>
			<p>I have a number of these different units, but I will be focusing on the model <strong class="bold">C0-10ARE-D</strong>, which is the<a id="_idIndexMarker136"/> Ethernet Basic PLC Unit. Once again, if you don't have access to a Koyo Click, you can use any other type or model of PLC and engineering software to follow along. The choice to use Koyo comes from the fact that it is one of the few controllers that I have spare that isn't wrapped up in a project. More importantly, however, this device is specifically used for the Ethernet communication port that comes with this PLC and the engineering software is free. Additionally, it leverages the discrete I/O to energize and de-energize coils and will help establish a correlation between real-world processes and equipment, and the equipment we will be simulating in our <strong class="bold">ICS</strong> lab. </p>
			<p>By default, the <strong class="bold">Koyo Click</strong> comes with two<a id="_idIndexMarker137"/> native protocols:</p>
			<ul>
				<li>Modbus</li>
				<li>Ethernet/IP</li>
			</ul>
			<p>If you remember <a id="_idIndexMarker138"/>from the previous chapter, the tools that we installed were focused on these protocols to allow us to interact with equipment using the native communication paths. Now, another detail about the <strong class="bold">Koyo Click</strong> that is enticing is the <em class="italic">design</em> and <em class="italic">expandable nature</em> of the Click's modularization. The modularization allows you to add on different control capabilities, from analog to digital, to relay control, and specialty modules. You can stack them together and expand the control range to accommodate almost any project with an endless amount of I/O. </p>
			<p>The following link will take you to <em class="italic">AutomationDirect</em> and the <strong class="bold">CLICK PLC</strong> equipment: <a href="https://www.automationdirect.com/adc/overview/catalog/programmable_controllers/click_series_plcs/">https://www.automationdirect.com/adc/overview/catalog/programmable_controllers/click_series_plcs/</a>.</p>
			<p>Now it is possible to run your own power supply to the PLC, however, for the price of the C0-01AC, it is just as easy to package them together. The reason why I am suggesting 01AC over the 00AC power supply is that you would be future-proofing your lab, and 01AC has 1.3 A, which allows it to support and drive a fully expanded controller.  </p>
			<p>This is an image of the <em class="italic">C0-01AC</em> power supply:</p>
			<div>
				<div id="_idContainer066" class="IMG---Figure">
					<img src="image/Figure_2.20_B16321.jpg" alt="Figure 2.20 – C0-01AC power supply&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.20 – C0-01AC power supply</p>
			<p>This is an<a id="_idIndexMarker139"/> image of the Koyo Click model <strong class="bold">C0-10ARE-D</strong> that I will be using in the lab:</p>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer067" class="IMG---Figure">
					<img src="image/Figure_2.21_B16321.jpg" alt="Figure 2.21 – Controller&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.21 – Controller</p>
			<p>Once you have<a id="_idIndexMarker140"/> the power supply and PLC in your lab, then make sure to wire up the terminals from your wall to your power supply and from your power supply to the bottom of your controller.  </p>
			<p>You will see the terminals required to supply power to the controller. Now that we have power to the controller, go ahead and connect an Ethernet cable linking the PLC to your computer. This can be done via a direct connection or through a switch.  </p>
			<p>The next step will be to open the CLICK programming software and select <strong class="bold">Connect to PLC</strong>, and this should bring up a <strong class="bold">Windows Security Alert</strong> dialog box asking you to allow this connection type on private networks and on public networks. Since this is a lab, and isolated, I have chosen to enable both, as seen in the following screenshot: </p>
			<div>
				<div id="_idContainer068" class="IMG---Figure">
					<img src="image/Figure_2.22_B16321.jpg" alt="Figure 2.22 – Firewall access&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.22 – Firewall access</p>
			<p>Once you have<a id="_idIndexMarker141"/> clicked on <strong class="bold">Allow access</strong> at the bottom of the screen, you will be presented with a dialog window allowing you to connect to a <strong class="bold">CLICK PLC</strong>. From here, you have to select the <strong class="bold">Port Type</strong>, which has three options:</p>
			<ul>
				<li><strong class="bold">USB</strong></li>
				<li><strong class="bold">Serial</strong></li>
				<li><strong class="bold">Ethernet</strong></li>
			</ul>
			<p>We will select <strong class="bold">Ethernet</strong> of course, and then proceed to our next option, which is selecting the specific <strong class="bold">Network Adapter</strong>. Depending on your system, there could be any number of adapters. Select the <strong class="bold">Network Adapter</strong> that has a path to the <strong class="bold">CLICK PLC</strong>. If a path exists between the PLC and the Windows 7 virtual machine, you should see the PLC listed with the <strong class="bold">IP Address</strong>, <strong class="bold">Subnet Mask</strong>, <strong class="bold">Part Number</strong>, <strong class="bold">Firmware</strong>, <strong class="bold">Mode</strong>, <strong class="bold">Status</strong>, and <strong class="bold">MAC Address</strong>, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer069" class="IMG---Figure">
					<img src="image/Figure_2.23_B16321.jpg" alt="Figure 2.23 – Connect to PLC&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.23 – Connect to PLC</p>
			<p>From here, you<a id="_idIndexMarker142"/> can select the PLC and click on the <strong class="bold">Connect</strong> button. It will display another <strong class="bold">Windows Security Alert</strong>, but this time it is for the <strong class="bold">Communication Server</strong> and allowing it to communicate on private or public networks. You can see what this looks like in the following screenshot: </p>
			<div>
				<div id="_idContainer070" class="IMG---Figure">
					<img src="image/Figure_2.24_B16321.jpg" alt="Figure 2.24 – Allow Firewall Access&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.24 – Allow Firewall Access</p>
			<p>Click on <strong class="bold">Allow access</strong> at the <a id="_idIndexMarker143"/>bottom of your screen. Once this occurs, you should get a networking mismatch error as shown in the following screenshot, because we still need to configure the network connectivity through <strong class="bold">ESXi</strong> to the PLC and place the PLC in the correct network: </p>
			<div>
				<div id="_idContainer071" class="IMG---Figure">
					<img src="image/Figure_2.25_B16321.jpg" alt="Figure 2.25 – Subnet Matching Error&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.25 – Subnet Matching Error</p>
			<p>This leads us onto the next section of the chapter, where we will configure the hardware to communicate and sit in the correct subnet.</p>
			<h1 id="_idParaDest-31"><a id="_idTextAnchor031"/>Configuring communication</h1>
			<p>Now we know that<a id="_idIndexMarker144"/> there is a path through to the physical PLC, however, we are not able to communicate with it. The solution to this is that we will have to adjust the IP address of the Windows 7 VM to align with the subnet that the PLC is in. This will allow us to connect directly to the PLC and configure the address to align with the subnet that we established for the virtual PLC developed in the previous chapter. </p>
			<p>By looking at <em class="italic">Figure 2.26</em>, we want to make sure that we provide Windows 7 with an <strong class="bold">IP</strong> address that can ping the Koyo CLICK. I have decided to arbitrarily choose <strong class="source-inline">192.168.0.20</strong> because my CLICK has a default address of <strong class="source-inline">192.168.0.10</strong>, however, depending on the default address that your Koyo CLICK may have, you will need to adjust this appropriately:</p>
			<div>
				<div id="_idContainer072" class="IMG---Figure">
					<img src="image/Figure_2.26_B16321.jpg" alt="Figure 2.26 – Configure Windows interface&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.26 – Configure Windows interface</p>
			<p>Once you have set <a id="_idIndexMarker145"/>your IP address, you can launch the CLICK programming software and click on <strong class="bold">Connect to PLC</strong>, then select the PLC that you see. If everything is configured correctly, you should see a page as shown in <em class="italic">Figure 2.27</em>. This step now allows you to read the pre-existing project inside the PLC or simply skip over reading it:</p>
			<div>
				<div id="_idContainer073" class="IMG---Figure">
					<img src="image/Figure_2.27_B16321.jpg" alt="Figure 2.27 – Pre-existing project inside the PLC &#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.27 – Pre-existing project inside the PLC </p>
			<p class="callout-heading">Tip/important note</p>
			<p class="callout">It is good <a id="_idIndexMarker146"/>practice to always read the project from the PLC. There is a good chance that no one has a backup of the current project file running, and this one-time connection might be the only chance to get a copy. </p>
			<p class="callout">You don't have to be L337 to cause major disruption if an attacker has a foothold at this level whereby they can access the PLC and read/write project files. They simply need to write a blank project file to the PLC and now the process grinds to a halt. If they don't have any project backups locally, this could mean millions of dollars in losses because of downtime. It is a common practice that large companies place the responsibility and management of these backups on the third-party engineering firm they have contracted for the operation and maintenance of the equipment.</p>
			<p>In the following screenshot, you can see there are two options that are presented to us. As stated previously<a id="_idIndexMarker147"/> we will select <strong class="bold">Read the project from the PLC</strong>: </p>
			<div>
				<div id="_idContainer074" class="IMG---Figure">
					<img src="image/Figure_2.28_B16321.jpg" alt="Figure 2.28 – Read the project file&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.28 – Read the project file</p>
			<p>Now you should have a blank project sitting in front of you. We are going to go and change the PLC address information to align with our design from <a href="B16321_01_Epub_AM.xhtml#_idTextAnchor013"><em class="italic">Chapter 1</em></a>, <em class="italic">Using Virtualization</em>. You will need to click <strong class="bold">Setup</strong> and then select <strong class="bold">Com Port Setup</strong> as shown in the following screenshot: </p>
			<div>
				<div id="_idContainer075" class="IMG---Figure">
					<img src="image/Figure_2.29_B16321.jpg" alt="Figure 2.29 – Com Port Setup&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.29 – Com Port Setup</p>
			<p>This will then <a id="_idIndexMarker148"/>present you with the layout of the CLICK PLC and let you choose the setup of the two available ports. Proceed by selecting the <strong class="bold">Port 1</strong> setup, which will be the Ethernet port as shown in the following screenshot: </p>
			<div>
				<div id="_idContainer076" class="IMG---Figure">
					<img src="image/Figure_2.30_B16321.jpg" alt="Figure 2.30 – Koyo Click COM Port Setup&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.30 – Koyo Click COM Port Setup</p>
			<p>From here, you <a id="_idIndexMarker149"/>can see two options as shown in the following screenshot: </p>
			<ul>
				<li><strong class="bold">Use default fixed address</strong></li>
				<li><strong class="bold">Set manually:</strong></li>
			</ul>
			<div>
				<div id="_idContainer077" class="IMG---Figure">
					<img src="image/Figure_2.31_B16321.jpg" alt="Figure 2.31 – Com Port Setup Details&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.31 – Com Port Setup Details</p>
			<p>We are going to <a id="_idIndexMarker150"/>set the information manually, so select the <strong class="bold">Set manually</strong> option as you can see in <em class="italic">Figure 2.32</em>.</p>
			<p>This will open <strong class="bold">IP Address</strong>, <strong class="bold">Subnet Mask</strong>, and <strong class="bold">Default Gateway</strong>:</p>
			<div>
				<div id="_idContainer078" class="IMG---Figure">
					<img src="image/Figure_2.32_B16321.jpg" alt="Figure 2.32 – Set the IP address&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.32 – Set the IP address</p>
			<p>As a friendly<a id="_idIndexMarker151"/> reminder from <a href="B16321_01_Epub_AM.xhtml#_idTextAnchor013"><em class="italic">Chapter 1</em></a>, <em class="italic">Using Virtualization</em>, we know that our virtual PLC resides inside <strong class="bold">Level 1: Process</strong>, as seen in the following table: </p>
			<div>
				<div id="_idContainer079" class="IMG---Figure">
					<img src="image/Figure_2_Table_1_B16321.jpg" alt=""/>
				</div>
			</div>
			<p>Next, we will pre-assign IP addresses to the virtual machines that we have built out.</p>
			<p>We will assign the following IP addresses:</p>
			<ul>
				<li><strong class="bold">PLC</strong>: <strong class="source-inline">192.168.1.10</strong></li>
				<li><strong class="bold">SCADA</strong>: <strong class="source-inline">192.168.2.10</strong></li>
				<li><strong class="bold">Workstation</strong>: <strong class="source-inline">192.168.3.10</strong></li>
				<li><strong class="bold">Kali</strong>: <strong class="source-inline">172.16.0.1</strong></li>
			</ul>
			<p>We are going to set <a id="_idIndexMarker152"/>our physical PLC to reside in the same subnet, as follows:</p>
			<ul>
				<li><strong class="bold">CLICK</strong>: <strong class="source-inline">192.168.1.20</strong></li>
				<li><strong class="bold">Set IP Address</strong>: <strong class="source-inline">192.168.1.20</strong></li>
				<li><strong class="bold">Set Mask</strong>: <strong class="source-inline">255.255.0.0</strong></li>
				<li><strong class="bold">Set Gateway</strong>: <strong class="source-inline">192.168.1.1</strong></li>
			</ul>
			<p>Now, to commit your changes, you need to write the project to the PLC, navigate to the PLC menu, and select <strong class="bold">Write Project into PLC…</strong> as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer080" class="IMG---Figure">
					<img src="image/Figure_2.33_B16321.jpg" alt="Figure 2.33 – Write Project into PLC&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.33 – Write Project into PLC</p>
			<p>Now if you followed<a id="_idIndexMarker153"/> along, the programming software should throw an error that looks like this: </p>
			<div>
				<div id="_idContainer081" class="IMG---Figure">
					<img src="image/Figure_2.34_B16321.jpg" alt="Figure 2.34 – Syntax error&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.34 – Syntax error</p>
			<p>If you look at the output window, you should see a helpful hint, which is <strong class="source-inline">No unconditional END instruction in the Main Program</strong> as seen here:</p>
			<div>
				<div id="_idContainer082" class="IMG---Figure">
					<img src="image/Figure_2.35_B16321.jpg" alt="Figure 2.35 – Debug window&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.35 – Debug window</p>
			<p>If for some reason, you are<a id="_idIndexMarker154"/> missing the output window, navigate to <strong class="bold">View</strong> | <strong class="bold">Window</strong> | <strong class="bold">Output</strong> to turn it on as demonstrated in the following screenshot: </p>
			<div>
				<div id="_idContainer083" class="IMG---Figure">
					<img src="image/Figure_2.36_B16321.jpg" alt="Figure 2.36 – View selection&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.36 – View selection</p>
			<p>From here, we need to add an <em class="italic">unconditional end</em> to one of our rungs. Look under <strong class="bold">Instruction List</strong> and scroll until you find the <strong class="bold">End</strong> function as shown here:</p>
			<div>
				<div id="_idContainer084" class="IMG---Figure">
					<img src="image/Figure_2.37_B16321.jpg" alt="Figure 2.37 – Instruction List&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.37 – Instruction List</p>
			<p>Next, drag the <strong class="bold">End</strong> function<a id="_idIndexMarker155"/> to one of the <strong class="bold">( NOP )</strong> outputs as shown here:</p>
			<div>
				<div id="_idContainer085" class="IMG---Figure">
					<img src="image/Figure_2.38_B16321.jpg" alt="Figure 2.38 – Ladder logic&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.38 – Ladder logic</p>
			<p>You should see that the <strong class="bold">END</strong> function replaces <strong class="bold">( NOP )</strong> as the output:</p>
			<div>
				<div id="_idContainer086" class="IMG---Figure">
					<img src="image/Figure_2.39_B16321.jpg" alt="Figure 2.39 – Instruction replacement&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.39 – Instruction replacement</p>
			<p>Now, let's return to <a id="_idIndexMarker156"/>writing the project to the PLC, which as a refresher is under the <strong class="bold">PLC</strong> menu item. Now our project should compile and present us with a dialog box showing us our changes that we made to <strong class="bold">Port 1</strong>. Click the button at the bottom of the newly changed Port1 configuration, which is labeled <strong class="bold">Use This Setup</strong> as shown here: </p>
			<div>
				<div id="_idContainer087" class="IMG---Figure">
					<img src="image/Figure_2.40_B16321.jpg" alt="Figure 2.40 – Set project details&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.40 – Set project details</p>
			<p>Once it is clicked, this will show us an error indicating that the communication will be lost between the Windows 7 VM and the CLICK as shown in the following screenshot: </p>
			<div>
				<div id="_idContainer088" class="IMG---Figure">
					<img src="image/Figure_2.41_B16321.jpg" alt="Figure 2.41 – Confirm update&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.41 – Confirm update</p>
			<p>Click <strong class="bold">OK</strong> and<a id="_idIndexMarker157"/> proceed to the <strong class="bold">Write Project into PLC</strong> screen as shown here: </p>
			<div>
				<div id="_idContainer089" class="IMG---Figure">
					<img src="image/Figure_2.42_B16321.jpg" alt="Figure 2.42 – Write project details&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.42 – Write project details</p>
			<p>Here, we are prompted with the final check before pushing the changes to the PLC. If you have no errors, click <strong class="bold">OK</strong> and once everything is completed you will be presented with a <strong class="bold">Transfer completed</strong> dialog<a id="_idIndexMarker158"/> box as follows: </p>
			<div>
				<div id="_idContainer090" class="IMG---Figure">
					<img src="image/Figure_2.43_B16321.jpg" alt="Figure 2.43 - Transfer completed&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.43 - Transfer completed</p>
			<p>Now you can see that the IP address has changed, so click on the <strong class="bold">Connect</strong> button as shown in <em class="italic">Figure 2.44</em>, and you should get a timeout error. This is OK as we moved subnets: </p>
			<div>
				<div id="_idContainer091" class="IMG---Figure">
					<img src="image/Figure_2.44_B16321.jpg" alt="Figure 2.44 – PLC Connect&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.44 – PLC Connect</p>
			<p>Now if you remember back to our ESXi network architecture, you will notice that <strong class="bold">No physical adapters</strong> has been set, as seen in <em class="italic">Figure 2.45</em>. This means that the virtual PLC and the physical PLC have no means of communication:</p>
			<div>
				<div id="_idContainer092" class="IMG---Figure">
					<img src="image/Figure_2.45_B16321.jpg" alt="Figure 2.45 – vSwitch topology&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.45 – vSwitch topology</p>
			<p>We can quickly<a id="_idIndexMarker159"/> test this by logging into the virtual PLC and try to ping the physical PLC as follows: </p>
			<div>
				<div id="_idContainer093" class="IMG---Figure">
					<img src="image/Figure_2.46_B16321.jpg" alt="Figure 2.46 – Ping connection test&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.46 – Ping connection test</p>
			<p>As you can see, the host is unreachable. What we need to do is add an uplink to the virtual switch. Select <strong class="bold">vSwitch1</strong> and click <strong class="bold">Add uplink</strong> as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer094" class="IMG---Figure">
					<img src="image/Figure_2.47_B16321.jpg" alt="Figure 2.47 – Add uplink&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.47 – Add uplink</p>
			<p>Now we can see <a id="_idIndexMarker160"/>that <strong class="bold">Uplink 1</strong> is showing a dropdown with a list of physical network adapters. This is all dependent on your hardware setup. I have decided to keep things consistent with <strong class="bold">vSwitch0</strong> being associated with <strong class="source-inline">vmnic0</strong> and <strong class="bold">vSwitch1</strong> associated with <strong class="source-inline">vmnic1</strong> as shown here: </p>
			<div>
				<div id="_idContainer095" class="IMG---Figure">
					<img src="image/Figure_2.48_B16321.jpg" alt="Figure 2.48 – Connect physical PLC to virtual switch&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.48 – Connect physical PLC to virtual switch</p>
			<p>Now when you look at the topology, you should see a physical adapter associated with your vSwitch and connecting the port groups created in <a href="B16321_01_Epub_AM.xhtml#_idTextAnchor013"><em class="italic">Chapter 1</em></a>, <em class="italic">Using Virtualization</em>:</p>
			<div>
				<div id="_idContainer096" class="IMG---Figure">
					<img src="image/Figure_2.49_B16321.jpg" alt="Figure 2.49 – vSwitch topology with physical connection&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.49 – vSwitch topology with physical connection</p>
			<p>Go ahead and try <a id="_idIndexMarker161"/>pinging the physical PLC from the virtual PLC now. You should get a reply back as shown in the following screenshot: </p>
			<div>
				<div id="_idContainer097" class="IMG---Figure">
					<img src="image/Figure_2.50_B16321.jpg" alt="Figure 2.50 – Connection test&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.50 – Connection test</p>
			<p>Now for a little cleanup. As I added a secondary adapter to the Windows 7 VM to connect to the Koyo CLICK via the VM network and <strong class="source-inline">vmnic0</strong> adapter, I am going to go back and disconnect that<a id="_idIndexMarker162"/> adapter and test to see if I can still connect to the CLICK through <strong class="source-inline">vmnic1</strong> next: </p>
			<div>
				<div id="_idContainer098" class="IMG---Figure">
					<img src="image/Figure_2.51_B16321.jpg" alt="Figure 2.51 – Connect to PLC&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.51 – Connect to PLC</p>
			<p>And Voila! We<a id="_idIndexMarker163"/> have a path from Windows 7 to the <strong class="bold">CLICK PLC</strong>. Now, for you networking gurus reading this, I know that you are probably smirking to yourselves and thinking, <em class="italic">Duh, we are using a class B subnet mask! Of course, we can communicate between the subnets!</em> Firstly, I want to thank you for reading this book, as it means a lot to me, and secondly, I felt this was the path of least resistance over assembling firewalls into VMs and writing policies, as that could be a dedicated book on its own.</p>
			<h1 id="_idParaDest-32"><a id="_idTextAnchor032"/>Summary</h1>
			<p>We have installed the Koyo Click programming software on our Windows 7 virtual machine. We have also wired our power supply to our Koyo Click PLC and powered it on. We have successfully configured the physical network of the Koyo Click PLC to communicate through the ESXi vSwitch and to the network interface of the Windows 7 interface.</p>
			<p>Wrapping up this chapter, we have a running Koyo CLICK PLC sitting in the <strong class="bold">Level 1: Process</strong> network segment, and we have installed and tested the CLICK programming software on the Windows 7 VM that is sitting in the <strong class="bold">Level 3: Operations network</strong> segment. We tested the network communication between the virtual PLC and the physical PLC as well. We added a physical adapter uplink to the ESXi virtual switch that we configured in the previous chapter.  </p>
			<p>Now we have a better understanding of how an automation engineer spends their time when they begin a project. Understanding how to orchestrate and install software will allow you to shape and hone your pentesting skills in future engagements.</p>
			<p>In the next chapter, we will be writing our first PLC program and downloading it onto the Koyo CLICK.</p>
		</div>
	</body></html>