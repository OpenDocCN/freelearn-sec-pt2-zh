<html><head></head><body>
		<div id="_idContainer543">
			<h1 id="_idParaDest-123"><em class="italic"><a id="_idTextAnchor139"/>Chapter 12</em>: I See the Future</h1>
			<p>After the previous chapter, if you are reading this in the order as it was written, then we have pivoted through our corporate network through the firewall and now have a remote desktop session on our Windows 7 machine. We have come full circle as we started this book by building the lab, routing virtual traffic to our physical <strong class="bold">Programmable Logic Controller</strong> (<strong class="bold">PLC</strong>), and building our first program. This Windows 7 machine is what we used to configure our first PLC program and push it to Koyo Click. On this adventure, we have slowly added bits and pieces to our lab, building our skillset and knowledge along the way. Arriving here indicates that the finish line is within sight. However, we have one last challenge, and that challenge is connecting to the process and simulating disruption. Simulation is the keyword here; as we've mentioned throughout this book, process disruption could have an extreme impact in terms of costs and potentially life-threatening issues, so you must tread lightly when you are at this level in your customer's network.</p>
			<p>In this chapter, we will be updating the firewall that we installed in the previous chapter by adding a second interface to handle the local control network. We will then connect our Ignition SCADA to our LABCORP domain using the <strong class="bold">Lightweight Directory Access Protocol</strong> (<strong class="bold">LDAP</strong>) to emphasize the dangers of credential reuse. We will then use the packages we installed in <a href="B16321_01_Epub_AM.xhtml#_idTextAnchor013"><em class="italic">Chapter 1</em></a>, <em class="italic">Using Virtualization</em>, to configure a simple <strong class="bold">File Transfer Protocol</strong> (<strong class="bold">FTP</strong>) server and <strong class="bold">Hypertext Preprocessor</strong> (<strong class="bold">PHP</strong>) web server to simulate low-level access points.  </p>
			<p>In this chapter, we're going to cover the following main topics:</p>
			<ul>
				<li>Additional lab configurations</li>
				<li>User interface control</li>
				<li>Script access</li>
			</ul>
			<h1 id="_idParaDest-124"><a id="_idTextAnchor140"/>Technical requirements</h1>
			<p>For this chapter, you will need the following:</p>
			<ul>
				<li>A pfSense firewall, which we installed in <a href="B16321_11_Epub_AM.xhtml#_idTextAnchor130"><em class="italic">Chapter 11</em></a>, <em class="italic">Whoot… I Have To Go Deep</em>.</li>
				<li>A Kali Linux VM must be open and running.</li>
			</ul>
			<p>You can view this chapter's code in action here: <a href="https://bit.ly/3j2HgiS">https://bit.ly/3j2HgiS</a></p>
			<h1 id="_idParaDest-125"><a id="_idTextAnchor141"/>Additional lab configurations</h1>
			<p>To round out our lab, we will add more segmentation by adding an interface to our firewall. This interface will <a id="_idIndexMarker813"/>allow us to add rules between our Level 3 and Level 2 network segments:</p>
			<ol>
				<li>To do this, we need to make changes to our ESXi server. On our ESXi server, we will need to add an additional network adapter to our pfSense firewall. The following screenshot shows how I added <strong class="bold">Level 2: Local Control</strong> where the SCADA VM sits:<div id="_idContainer511" class="IMG---Figure"><img src="image/B16321_12_001.jpg" alt="Figure 12.1 – New Network Adapter&#13;&#10;"/></div><p class="figure-caption">Figure 12.1 – New Network Adapter</p></li>
				<li>After adding the network adapter, we must restart our pfSense firewall and navigate to the web interface. From here, we want to log in to the web portal, select <strong class="bold">Interfaces</strong>, and then <strong class="bold">Assignments</strong>, as shown in the following screenshot:<div id="_idContainer512" class="IMG---Figure"><img src="image/B16321_12_002.jpg" alt="Figure 12.2 – Interfaces | Assignments&#13;&#10;"/></div><p class="figure-caption">Figure 12.2 – Interfaces | Assignments</p><p>You will now see our <a id="_idIndexMarker814"/>newly added adapter sitting in the <strong class="bold">Interface</strong> list being addressed as <strong class="bold">Available network ports</strong>, as shown in the following screenshot:</p><div id="_idContainer513" class="IMG---Figure"><img src="image/B16321_12_003.jpg" alt="Figure 12.3 – Available network ports&#13;&#10;"/></div><p class="figure-caption">Figure 12.3 – Available network ports</p></li>
				<li>Continue by clicking the <strong class="bold">+ Add</strong> button and then <strong class="bold">Save</strong> the configuration. You should see that your interface has been added and given a new interface name, as shown here:<div id="_idContainer514" class="IMG---Figure"><img src="image/B16321_12_004.jpg" alt="Figure 12.4 – OPT1 interface&#13;&#10;"/></div><p class="figure-caption">Figure 12.4 – OPT1 interface</p></li>
				<li>Once created, go back to the <strong class="bold">Interfaces</strong> menu. At this point, you should see <strong class="bold">OPT1</strong> in your drop-down list. Select the <strong class="bold">OPT1</strong> interface, as shown in the following screenshot:<div id="_idContainer515" class="IMG---Figure"><img src="image/B16321_12_005.jpg" alt="Figure 12.5 – New OPT1 interface&#13;&#10;"/></div><p class="figure-caption">Figure 12.5 – New OPT1 interface</p></li>
				<li>Now, you should see the <strong class="bold">General Configuration</strong> screen for your newly minted <strong class="bold">OPT1</strong> interface. From here, you can enable the interface, change the description's name, select IPv4 configuration, and more. From here, we want to make sure that we enable <a id="_idIndexMarker815"/>the interface and change <strong class="bold">IPv4 Configuration Type</strong> to <strong class="bold">Static IPv4 </strong>as we are going to use this interface as our DHCP server for our <strong class="bold">Level 2: Local Control</strong> network segment. Here is the screenshot of the initial settings:<div id="_idContainer516" class="IMG---Figure"><img src="image/B16321_12_006.jpg" alt="Figure 12.6 – Enabling Static IPv4&#13;&#10;"/></div><p class="figure-caption">Figure 12.6 – Enabling Static IPv4</p></li>
				<li>Next, we need to set the static IP address for this interface. If you remember our initial setup, we gave the <strong class="bold">Level 2: Local Control</strong> network segment a subnet of <strong class="source-inline">192.168.2.0/24</strong>. I am going to set our interface to <strong class="source-inline">192.168.2.1/24</strong>, as shown here:<div id="_idContainer517" class="IMG---Figure"><img src="image/B16321_12_007.jpg" alt="Figure 12.7 – Static IPv4 address&#13;&#10;"/></div><p class="figure-caption">Figure 12.7 – Static IPv4 address</p></li>
				<li>Click the <strong class="bold">Save</strong> button and then the <strong class="bold">Apply Changes</strong> button to commit the new interface <a id="_idIndexMarker816"/>settings. After this, we must set up the DHCP server for this new interface by navigating to <strong class="bold">Services</strong> | <strong class="bold">DHCP Server</strong> from the top menu bar, as shown here:<div id="_idContainer518" class="IMG---Figure"><img src="image/B16321_12_008.jpg" alt="Figure 12.8 – DHCP Server services&#13;&#10;"/></div><p class="figure-caption">Figure 12.8 – DHCP Server services</p></li>
				<li>Similar to our initial configuration for our LAN interface, we are going to configure it for OPT1. Go back to <a href="B16321_11_Epub_AM.xhtml#_idTextAnchor130"><em class="italic">Chapter 11</em></a>, <em class="italic">Whoot…. I Have To Go Deep</em>, for a refresher; the only thing I will add here is the IP address pool, which is picking a range from <strong class="source-inline">192.168.2.10</strong> to <strong class="source-inline">192.168.2.254</strong>, as shown in the following screenshot:<div id="_idContainer519" class="IMG---Figure"><img src="image/B16321_12_009.jpg" alt="Figure 12.9 – DHCP Server&#13;&#10;"/></div><p class="figure-caption">Figure 12.9 – DHCP Server</p></li>
				<li>Finally, we have to create a vulnerable <em class="italic">any</em>:<em class="italic">any</em> rule in our firewall to allow our new interface <a id="_idIndexMarker817"/>to communicate northbound. Navigate to <strong class="bold">Firewall</strong> | <strong class="bold">Rules</strong>, as shown here:<div id="_idContainer520" class="IMG---Figure"><img src="image/B16321_12_010.jpg" alt="Figure 12.10 – Firewall | Rules&#13;&#10;"/></div><p class="figure-caption">Figure 12.10 – Firewall | Rules</p></li>
				<li>From here, click the <strong class="bold">Add Rule</strong> button. You will be presented with a screen that will allow you to edit a new rule. Set <strong class="bold">Action</strong> to <strong class="bold">Pass</strong>, <strong class="bold">Interface</strong> to <strong class="bold">OPT1</strong>, <strong class="bold">Address Family</strong> to <strong class="bold">IPv4</strong>, and <strong class="bold">Protocol</strong> to <strong class="bold">Any</strong>, as shown here:<div id="_idContainer521" class="IMG---Figure"><img src="image/B16321_12_011.jpg" alt="Figure 12.11 – Any rule&#13;&#10;"/></div><p class="figure-caption">Figure 12.11 – Any rule</p></li>
				<li>Click the <strong class="bold">Save</strong> button and then <strong class="bold">Apply Changes</strong>. After that, try and ping various elements in your network. You should be able to ping the Corp Domain Controller on the <a id="_idIndexMarker818"/>WAN interface from our SCADA VM, and our Windows 7 host should be able to ping the SCADA VM.  </li>
			</ol>
			<p>Now that you have tested that you can route between networks, we are going to connect our Ignition SCADA to our LABCORP domain.</p>
			<h2 id="_idParaDest-126"><a id="_idTextAnchor142"/>LDAP connection</h2>
			<p>To connect our Ignition SCADA to our LABCORP domain, we will perform the following steps:</p>
			<ol>
				<li value="1">For this, we <a id="_idIndexMarker819"/>will need to log in too <a id="_idIndexMarker820"/>our Ignition SCADA interface. Once we have established a connection, navigate to the <strong class="bold">Config</strong> icon and then select <strong class="bold">Users, Roles</strong> from under the <strong class="bold">SECURITY</strong> section, as shown here:<div id="_idContainer522" class="IMG---Figure"><img src="image/B16321_12_012.jpg" alt="Figure 12.12 – Users, Roles&#13;&#10;"/></div><p class="figure-caption">Figure 12.12 – Users, Roles</p></li>
				<li>Selecting the <strong class="bold">Users, Roles</strong> link will bring up the <strong class="bold">Users Sources</strong> configuration screen. From here, we are going to select the <strong class="bold">Create new User Source…</strong> link, as shown here:<div id="_idContainer523" class="IMG---Figure"><img src="image/B16321_12_013.jpg" alt="Figure 12.13 – Create new User Source&#13;&#10;"/></div><p class="figure-caption">Figure 12.13 – Create new User Source</p></li>
				<li>Once we have clicked the link to create a new user source, a list of credential source <a id="_idIndexMarker821"/>options will be presented. We want to focus specifically on the <strong class="bold">Active Directory</strong> options. Here, we have <a id="_idIndexMarker822"/>one traditional and two hybrid sources. I am going to use the <strong class="bold">AD/Internal Hybrid</strong> source as it allows me to leverage the auth mechanics of AD and maintain group access and control granularity inside Ignition. You can see these options in the following screenshot:<div id="_idContainer524" class="IMG---Figure"><img src="image/B16321_12_014.jpg" alt="Figure 12.14 – New sources&#13;&#10;"/></div><p class="figure-caption">Figure 12.14 – New sources</p></li>
				<li>Once you have selected the <strong class="bold">Next &gt;</strong> button, a new screen will be presented, allowing us <a id="_idIndexMarker823"/>to configure the elements of our <strong class="bold">AD/Internal Hybrid</strong> source selection. We are going to provide <a id="_idIndexMarker824"/>the source with a name; I used the name <strong class="source-inline">Operators</strong> here. Next, scroll down to <strong class="bold">Active Directory Properties</strong> and fill in the required items: <ul><li><strong class="bold">Domain</strong>: <strong class="source-inline">labcorp.local</strong></li><li><strong class="bold">AD Username</strong>: <strong class="source-inline">operator1</strong></li><li><strong class="bold">AD Password</strong>: <strong class="source-inline">Password1</strong></li><li><strong class="bold">Domain IP Address</strong>: <strong class="source-inline">172.16.0.2</strong></li><li><strong class="bold">LDAP port #</strong>: <strong class="source-inline">389</strong></li></ul><p>The following screenshot shows these configuration fields:</p><div id="_idContainer525" class="IMG---Figure"><img src="image/B16321_12_015.jpg" alt="Figure 12.15 – Active Directory Properties"/></div><p class="figure-caption">Figure 12.15 – Active Directory Properties</p></li>
				<li>After updating the fields and saving the configuration, Ignition SCADA will use the <a id="_idIndexMarker825"/>configuration to reach out to the domain controller and perform a user search. This will build a list of domain <a id="_idIndexMarker826"/>users who can be leveraged to access the Ignition SCADA platform. See the following list of users that Ignition pulled in from the domain controller that I created in <a href="B16321_10_Epub_AM.xhtml#_idTextAnchor112"><em class="italic">Chapter 10</em></a>, <em class="italic">I Can Do It 420</em>:<div id="_idContainer526" class="IMG---Figure"><img src="image/B16321_12_016.jpg" alt="Figure 12.16 – Domain users&#13;&#10;"/></div><p class="figure-caption">Figure 12.16 – Domain users</p></li>
				<li>Next, we need to add the role of <strong class="bold">Administrator</strong> and assign it to our <strong class="source-inline">Operator1</strong> user, as shown here:<div id="_idContainer527" class="IMG---Figure"><img src="image/B16321_12_017.jpg" alt="Figure 12.17 – Roles&#13;&#10;"/></div><p class="figure-caption">Figure 12.17 – Roles</p></li>
				<li>After creating the <strong class="bold">Administrator</strong> role and adding it to the <strong class="source-inline">Operator1</strong> user account, we <a id="_idIndexMarker827"/>are going to update the <strong class="bold">Identity Providers</strong> list by creating a new identity provider, as shown here:<div id="_idContainer528" class="IMG---Figure"><img src="image/B16321_12_018.jpg" alt="Figure 12.18 – Identity Providers&#13;&#10;"/></div><p class="figure-caption">Figure 12.18 – Identity Providers</p></li>
				<li>Once we click the <strong class="bold">Create new Identity Provider</strong> link, we will be presented with a screen <a id="_idIndexMarker828"/>with multiple sections to configure the new identity. We want to give our new identity provider a name here. I used <strong class="source-inline">ActiveDirectory</strong> as it makes for a clear reminder. Then, I changed <strong class="bold">User Source</strong> to <strong class="bold">Operators</strong>, as shown here:<div id="_idContainer529" class="IMG---Figure"><img src="image/B16321_12_019.jpg" alt="Figure 12.19 – Basic Details&#13;&#10;"/></div><p class="figure-caption">Figure 12.19 – Basic Details</p></li>
				<li>After <a id="_idIndexMarker829"/>saving your configuration <a id="_idIndexMarker830"/>updates, you should see the newly created provider in the list, as shown here:<div id="_idContainer530" class="IMG---Figure"><img src="image/B16321_12_020.jpg" alt="Figure 12.20 – Identity Provider added&#13;&#10;"/></div><p class="figure-caption">Figure 12.20 – Identity Provider added</p></li>
				<li>Finally, we want to change our <strong class="bold">General Gateway Security Settings</strong>. We want to switch <strong class="bold">System Identity Provider</strong> to <strong class="bold">ActiveDirectory</strong>, as shown here:<div id="_idContainer531" class="IMG---Figure"><img src="image/B16321_12_021.jpg" alt="Figure 12.21 – Switching Identity Provider&#13;&#10;"/></div><p class="figure-caption">Figure 12.21 – Switching Identity Provider</p></li>
				<li>Now, we <a id="_idIndexMarker831"/>must test our <strong class="source-inline">operator1</strong> domain <a id="_idIndexMarker832"/>user by logging in to the Ignition SCADA user interface with the domain credentials that we discovered in <a href="B16321_10_Epub_AM.xhtml#_idTextAnchor112"><em class="italic">Chapter 10</em></a>, <em class="italic">I Can Do It 420</em>. </li>
			</ol>
			<div>
				<div id="_idContainer532" class="IMG---Figure">
					<img src="image/B16321_12_022.jpg" alt="Figure 12.22 – operator1 login&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.22 – operator1 login</p>
			<p>After connecting and testing our <strong class="source-inline">operator1</strong> credentials, you should have a better awareness of the pitfall that many organizations suffer from with widespread credential reuse. If you find credentials on a domain-connected system, there is a high likelihood that those credentials will help you gain access to different systems inside the network.</p>
			<p class="callout-heading">Storytime</p>
			<p class="callout">During an engagement, I was able to gain a foothold into the network by leveraging a domain service account that was used for provisioning new computers and joining them to the domain. For some reason, the Ansible-like script failed to remove the service account from the newly provisioned system and, to my surprise, it failed to remove the service account from all computers. This service account was a unique find as it allowed me to navigate and jump around the system, but its most interesting use was the access rights it had to the domain information. I used this account to analyze every user in the domain, as well as understand their titles and what machines they owned. This was very useful for narrowing down my search for staff members that would have direct access to the <strong class="bold">Distributed Control System</strong> (<strong class="bold">DCS</strong>). After quickly discovering the specific lead operations account and the computer that this individual owned, I used <strong class="bold">Remote Desktop Protocol</strong> (<strong class="bold">RDP</strong>) to navigate to the machine and then dumped the credentials, similar to what we did in <a href="B16321_10_Epub_AM.xhtml#_idTextAnchor112"><em class="italic">Chapter 10</em></a>, <em class="italic">I Can Do It 420</em>. After gathering the user's credentials, I was able to reuse them to gain a foothold through a saved putty connection stored on their desktop.</p>
			<h2 id="_idParaDest-127"><a id="_idTextAnchor143"/>PHP setup</h2>
			<p>We will round out this <a id="_idIndexMarker833"/>lab configuration section by creating and updating our <strong class="source-inline">ftp</strong> folder and configuration file. We installed <strong class="source-inline">vsftp</strong> in <a href="B16321_01_Epub_AM.xhtml#_idTextAnchor013"><em class="italic">Chapter 1</em></a>, <em class="italic">Using Virtualization</em>, and now we are going to use it. We will perform the following steps:</p>
			<ol>
				<li value="1">Create a public folder for our <strong class="source-inline">ftp</strong> server:<p class="source-code"><strong class="bold">sudo mkdir -p /var/ftp/pub</strong></p></li>
				<li>Change the ownership of our public folder:<p class="source-code"><strong class="bold">sudo chown nobody:nogroup /var/ftp/pub</strong></p><p class="source-code"><strong class="bold">sudo chown -R ftp /var/ftp/pub</strong></p></li>
				<li>Make a backup of our original <strong class="source-inline">vsftp</strong> config file:<p class="source-code"><strong class="bold">sudo cp /etc/vsftpd.conf /etc/vsftpd.conf.orig</strong></p><p class="source-code"><strong class="bold">sudo rm /etc/vsftpd.conf</strong></p></li>
				<li>Create a new configuration file using vulnerable settings:<p class="source-code"><strong class="bold">sudo echo "listen=NO" &gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "listen_ipv6=YES" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "anonymous_enable=YES" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "local_enable=NO" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "write_enable=YES" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "anon_upload_enable=YES" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "anon_mkdir_write_enable=YES" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "anon_root=/var/ftp/" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "no_anon_password=YES" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "hide_ids=YES" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "anon_umask=022" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "anon_other_write_enable=YES" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "dirmessage_enable=YES" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "use_localtime=YES" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "xferlog_enable=YES" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "connect_from_port_20=YES" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "pam_service_name=vsftpd" &gt;&gt; /etc/vsftpd.conf</strong></p><p class="source-code"><strong class="bold">sudo echo "utf8_filesystem=YES" &gt;&gt; /etc/vsftpd.conf</strong></p></li>
				<li>Spin up <a id="_idIndexMarker834"/>a PHP server:<p class="source-code"><strong class="bold">sudo systemctl restart vsftpd</strong></p><p class="source-code"><strong class="bold">echo 'Finished -Running Webserver'</strong></p><p class="source-code"><strong class="bold">cd /var/ftp/pub</strong></p><p class="source-code"><strong class="bold">php -S 0.0.0.0:8000</strong></p></li>
			</ol>
			<p>Once implemented, we will have a fully baked FTP and a PHP web server running. As simple as these tools might seem, they truly do replicate real-world installations and setups. It is very common to find FTP servers inside the industrial network as these are typically used to pass control software updates, patches, and even firmware around.  Finding these servers is key as typically, they allow read and write access, which we can leverage to escalate our privileges at this level in the network. In the next section, we will build a tunnel and use proxy chains to gain access to the <strong class="bold">User Interface</strong> (<strong class="bold">UI</strong>) control of the SCADA network.</p>
			<h1 id="_idParaDest-128"><a id="_idTextAnchor144"/>User interface control</h1>
			<p>Now, I know that we installed a SCADA system into our lab for testing purposes, and yes, we have been beating <a id="_idIndexMarker835"/>up on Ignition SCADA throughout this book, but know that performing these actions and practicing these attacks translates into real industry installations. At the <a id="_idIndexMarker836"/>core of all SCADA and <strong class="bold">Distributed Control Systems</strong> (<strong class="bold">DCS</strong>) lies the same underlying principle: </p>
			<ol>
				<li value="1">Take in the input. </li>
				<li>Run logic and routines against the input. </li>
				<li>Deliver the output to the process.</li>
			</ol>
			<p>This means that even though countless companies are producing SCADA and DCS software, they all function the same way. The following are a few systems that you may see:</p>
			<ul>
				<li>Weatherford <strong class="bold">Cygent</strong> SCADA</li>
				<li>Schneider Electric <strong class="bold">Telvent</strong></li>
				<li>Emerson <strong class="bold">Zedi Solutions</strong>, <strong class="bold">Ovation</strong>, <strong class="bold">Progea</strong>, and <strong class="bold">DeltaV</strong></li>
				<li>Aveva <strong class="bold">Citech</strong> SCADA</li>
				<li>Honeywell <strong class="bold">Experion</strong></li>
				<li>ABB <strong class="bold">SCADAvantage</strong>, <strong class="bold">Symphony</strong>, and <strong class="bold">800xA</strong></li>
				<li>GE <strong class="bold">Cimplicity</strong></li>
				<li><strong class="bold">SurvalentOne</strong> SCADA</li>
			</ul>
			<p>The list goes on, and the one supplied here is a generalized list of systems you will come across. There is still a healthy mixture of older legacy systems still being utilized in various parts of the world. It has often been the motto <em class="italic">If it isn't broken, don't fix it</em>, which means if the <a id="_idIndexMarker837"/>process is running and generating revenue, then there is no need to replace the system. So, gaining a working knowledge of these systems will allow you to leverage them further in your pentesting career. In this section, we will be leveraging the knowledge that we gained in the previous chapter. We will pivot deeper into the network and go down to our workstation, which has access to our SCADA system. We will then exploit a credential reuse attack to gain access to the user interface of the SCADA system.  </p>
			<p>The following diagram shows our attack path to the SCADA user interface:</p>
			<div>
				<div id="_idContainer533" class="IMG---Figure">
					<img src="image/B16321_12_023.jpg" alt="Figure 12.23 – Attack path&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.23 – Attack path</p>
			<p>Using a dynamic SSH tunnel and running <strong class="source-inline">xfreerdp</strong> via proxy chains, as we covered in <a href="B16321_11_Epub_AM.xhtml#_idTextAnchor130"><em class="italic">Chapter 11</em></a>, <em class="italic">Whoot…. I Have To Go Deep</em>, we can establish a remote connection to our SCADA host. As a quick refresher, running the following command will build our dynamic SSH tunnel:</p>
			<p class="source-code">ssh -D 9000 -fN operator1@172.16.0.4</p>
			<p>Then, we will want to run <strong class="source-inline">xfreerdp</strong> with <strong class="source-inline">proxychains</strong> by using the following command:</p>
			<p class="source-code">proxychains xfreerdp /u:operator1 /p:Password1 /v:172.16.0.7</p>
			<p>In a production environment, you will find that the workstation is typically logged in to the SCADA system or at least has the web portal up and running for easy access. The worst case is that there <a id="_idIndexMarker838"/>is a link sitting on the desktop. Now, this is certainly not <em class="italic">hacker-sexy</em> as it were because we are merely leveraging poor security practices, bad policies, and broken firewall rules. However, the entire point of pentesting a system is to help the customer find flaws in their system, as well as leverage, exploit, and document them. More often than not, you will find <em class="italic">reusable credentials</em>, default creds, or vendor commissioned credentials as a point of entry.  </p>
			<p>Once our remote session has been established, use our <strong class="source-inline">operator1</strong>/<strong class="source-inline">Password1</strong> credentials to access our Ignition console, as shown here:</p>
			<div>
				<div id="_idContainer534" class="IMG---Figure">
					<img src="image/B16321_12_024.jpg" alt="Figure 12.24 – Credential reuse&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.24 – Credential reuse</p>
			<p>Once inside the system, you should make note of the equipment and controls that this SCADA solution has access to. We want to build our situational awareness and document the findings for reporting purposes. We will talk about this in more detail in the next chapter. Here is a quick checklist of items to look for:</p>
			<ul>
				<li>What is the process that this SCADA system controls?</li>
				<li>What assets have read/write access?</li>
				<li>How is the security set up for this system?</li>
				<li>Are there connected databases, such as data historians?</li>
			</ul>
			<p>Understanding how much access there is can determine the level of impact you might have on an organization. At the user interface access level, most people default to the fact that you have ultimate control over the process. Yes, this is a scary scenario where attackers could shut down and disable a process or a plant but think about deeper and broader scenarios. If the <a id="_idIndexMarker839"/>system is domain-connected, just like our SCADA system is, what if the attacker removed the configuration? This would mean that no one from the domain could authenticate to the SCADA system to make changes. This would create havoc as the process is still running but now there is a loss of control.  </p>
			<p>You might be saying to yourself, <em class="italic">If I can shut down the process, why do I care about loss of control?</em> This is a good question and you would be right, but most of these operations can still be operated locally and manually. When incidents like this occur and, funnily enough, they occur more often than you would think – not from threat actors but more from misconfigurations – the operators would disconnect remote access and run the process manually. Look at the following screenshot; how many different items could you upgrade, downgrade, restore, or change to cause havoc in the system?</p>
			<div>
				<div id="_idContainer535" class="IMG---Figure">
					<img src="image/B16321_12_025.jpg" alt="Figure 12.25 – User interface configuration access&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.25 – User interface configuration access</p>
			<p class="callout-heading">Warning</p>
			<p class="callout">Once again, just because you can gain this level of access doesn't mean that you should implement or change anything. These types of actions can land you in prison.</p>
			<p>The reasoning behind addressing abstract and out-of-band actions is solely for reporting purposes. It might be the case that you come across a client that has gone to great lengths to implement and <a id="_idIndexMarker840"/>deploy security measures to thwart your actions. You may not be as lucky to gain the full control and access that we have shown in this lab, so you will need to adapt, think on your feet, and dig deep to find points of risk to report on. In the next section, we will explore getting deeper access into the SCADA server by utilizing scripts.</p>
			<h1 id="_idParaDest-129"><a id="_idTextAnchor145"/>Script access</h1>
			<p>In the previous section, we discussed the level of access and control that we can perform by gaining UI <a id="_idIndexMarker841"/>control. In this section, we are going to look at trying to gain deeper access into the SCADA server, which will allow us to bypass the UI control and communicate directly with the physical equipment. In our case, this would be Koyo Click.</p>
			<p>From our workstation, we want to test whether our SCADA server is running some sort of file share that is open for easy intranet file transfers. Run the following command:</p>
			<p class="source-code">ftp 192.168.2.11</p>
			<p>This will bring us to a login prompt. I tend to always check whether a service is running with anonymous credential access. In this case, we will use the username <strong class="source-inline">anonymous</strong>. As you can see from the <strong class="source-inline">230 Login successful</strong> response, we have anonymous access:</p>
			<div>
				<div id="_idContainer536" class="IMG---Figure">
					<img src="image/B16321_12_026.jpg" alt="Figure 12.26 – FTP connection to SCADA&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.26 – FTP connection to SCADA</p>
			<p>Next, we will want to switch to the <strong class="source-inline">pub</strong> folder and check our access rights. We can quickly do this by <a id="_idIndexMarker842"/>creating a folder inside the <strong class="source-inline">pub</strong> folder using the following command:</p>
			<p class="source-code">mkdir images</p>
			<p>And like that, we know that we have write access to this folder:</p>
			<div>
				<div id="_idContainer537" class="IMG---Figure">
					<img src="image/B16321_12_027.jpg" alt="Figure 12.27 – Write access to the pub folder&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.27 – Write access to the pub folder</p>
			<p>Yes, we are cheating a little bit as we did configure this FTP server in the first section of this chapter, but I want you to get a feel for how the flow works and go through the motions of accessing the system at this level. We know that we have a PHP server listening on port <strong class="source-inline">8000</strong> of the SCADA server, so on our compromised workstation, we can browse to that port and see the <a id="_idIndexMarker843"/>server hosting data. Now, this is a development server, which means that there will be <em class="italic">no</em> native directory listing like that of Apache or <strong class="bold">Internet Information Services</strong> (<strong class="bold">IIS</strong>), so don't be alarmed when you encounter a <strong class="source-inline">Not Found</strong> message. This can be corrected by simply adding a blank <strong class="source-inline">index.php</strong> file to the root folder or by creating a dedicated PHP file that performs the directory listing for you, which is outside the scope of this book.  </p>
			<p>Next, we want to upload a PHP <strong class="source-inline">webshell</strong> to our FTP server. When using Kali Linux, by default, there are <strong class="source-inline">webshells</strong> stored under the <strong class="source-inline">/usr/share/webshells</strong> folder and if you <a id="_idIndexMarker844"/>view a listing of that folder, you should see the following:</p>
			<div>
				<div id="_idContainer538" class="IMG---Figure">
					<img src="image/B16321_12_028.jpg" alt="Figure 12.28 – webshells&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.28 – webshells</p>
			<p>We want to copy the PHP <strong class="source-inline">php-reverse-shell.php</strong> file to our Kali working directory and then <a id="_idIndexMarker845"/>perform some slight changes. If you scroll partway down the file, you will come across the following details:</p>
			<div>
				<div id="_idContainer539" class="IMG---Figure">
					<img src="image/B16321_12_029.jpg" alt="Figure 12.29 – php-reverse-shell.php&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.29 – php-reverse-shell.php</p>
			<p>Here, we want to change the <strong class="source-inline">$ip</strong> information and the <strong class="source-inline">$port</strong> information so that it matches our Kali Linux host IP address and port of our choosing. Once you have changed this information, we are going to get this file onto our Windows 7 workstation. As a refresher, I always use the following command:</p>
			<p class="source-code">python3 -m http.server</p>
			<p>I have done this to generate a temporary server that I can navigate to and pull down files. Once you have placed your <strong class="source-inline">php-reverse-shell.php</strong> file onto the victim's workstation computer, you must run the following command to get the file into the FTP server on the SCADA box:</p>
			<p class="source-code">put php-reverse-shell.php</p>
			<p>If everything worked correctly, you should see the following output:</p>
			<div>
				<div id="_idContainer540" class="IMG---Figure">
					<img src="image/B16321_12_030.jpg" alt="Figure 12.30 – PUT php-reverse-shell.php&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.30 – PUT php-reverse-shell.php</p>
			<p>Next, we want to <a id="_idIndexMarker846"/>make sure that we have a listener set up on Kali by running the following command: </p>
			<p class="source-code">nc -nvlp 4444</p>
			<p>Make sure to change your port number so that it matches the port that you configured in the <strong class="source-inline">webshell</strong> file. After setting up the listener, navigate back to the workstation and browse to the following location:</p>
			<div>
				<div id="_idContainer541" class="IMG---Figure">
					<img src="image/B16321_12_031.jpg" alt="Figure 12.31 – Navigating to the reverse shell&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.31 – Navigating to the reverse shell</p>
			<p>If you go back to your Kali listener, you should see that you have a new shell, as shown here:</p>
			<div>
				<div id="_idContainer542" class="IMG---Figure">
					<img src="image/B16321_12_032.jpg" alt="Figure 11.32 – New reverse shell&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.32 – New reverse shell</p>
			<p>As you can see, we have a reverse shell and we are running as root. From here, we can simply copy in the scripts that we wrote in <a href="B16321_08_Epub_AM.xhtml#_idTextAnchor097"><em class="italic">Chapter 8</em></a>, <em class="italic">Protocols 202</em>, and exploit the physical PLC by turning the lights ON and OFF. In a professional engagement, when we gain this level of access, we can load in tools to discover equipment that the SCADA/DCS system has <a id="_idIndexMarker847"/>connectivity to. Depending on the level of engagement, you may be asked to go deeper and determine what hardware can be comprised.  </p>
			<p class="callout-heading">Warning</p>
			<p class="callout">I do caution that like the UI control, making changes and being active at this level of the network can have adverse effects that may cause disruption, damage, and possibly death. Even if your client encourages you to go deeper, I would caution you to abstain as the byproduct of change is seldom discovered until it is too late.</p>
			<p>At this point, we have full access to the network, from top to bottom. Now, we can move and push any changes and configurations we want. We completely own the system, and that is part of the rush that comes with the career of a pentester. </p>
			<h1 id="_idParaDest-130"><a id="_idTextAnchor146"/>Summary</h1>
			<p>In this chapter, we segmented our lab network further by adding a new interface to our firewall. We then utilized the skills we learned about in <a href="B16321_11_Epub_AM.xhtml#_idTextAnchor130"><em class="italic">Chapter 11</em></a>, <em class="italic">Whoot…. I Have To Go Deep</em>, to gain a dynamic shell and launch a remote desktop session with proxy chains to our workstation victim. After this, we discussed the various SCADA and DCS systems that we could encounter in our pentesting journeys. We reused various credentials to exploit the UI of our SCADA system before capitalizing on a misconfigured FTP server and, in turn, gaining a reverse shell back to our attacking box. We exploited the system right up to the control hardware and in doing so, discussed the pitfalls of going deeper into the control plane. Gaining this deep of a foothold should suffice for 99.99% of the engagements that you will be part of.  </p>
			<p>Understanding the technology and the ramifications and outcome of going deeper will be an important addition to the out brief report. We will do this in the next chapter, and this is the final stage of all pentesting engagements: the reporting phase.</p>
		</div>
	</body></html>