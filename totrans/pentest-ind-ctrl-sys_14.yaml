- en: '*Chapter 13*: Pwned but with Remorse'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We have finally arrived at our destination. Make sure your seat backs and tray
    tables are in their full upright position. Make sure your seat belt is securely
    fastened and all carry-on luggage is stowed. We are now at the point in the pentest
    where we must collect all the information that we captured and correlate the data
    into a report. Know that if there is no report, then the engagement never happened.
    From a business perspective, this is fundamentally the most pivotal part of the
    pentesting engagement. In this chapter, we will discuss how to build a report
    template, backfill that template with key information found during the engagement,
    and finally provide some remediation points to help close the security gap.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, we''re going to cover the following main topics:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: Preparing a pentest report
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Closing the security gap
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Technical requirements
  id: totrans-5
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'For this chapter, you will need the following:'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
- en: A word processor tool, such as Microsoft Word or Google Docs
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A drawing tool, which will be used for graphics in the report
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Preparing a pentest report
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: When preparing a report, it ultimately comes down to personal preference and,
    possibly, if you are working for a larger company, corporate branding. Getting
    the theme, icons, logos, and brands out of the way, at the core, there is a fundamental
    structure that should be used as a guideline to build your report against. Now,
    depending on your educational background, talking about report structure might
    come across as redundant; however, it is critical to build a clear and concise
    report that can be easily ingested by your customer because if they can't follow
    the flow of the report, it might be the last engagement you have with that client.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: Story time
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: I spent many years working with, and for, **Engineering Procurement Construction**
    (**EPC**) companies. During that time, I became very familiar with **search and
    replace all** word processor functions. Building a reusable set of reporting templates
    is vital to a successful pentesting career. With each engagement and deliverable,
    you can modify, tweak, and enhance the template to make a dynamite report. I personally
    feel that even if you are the best technical pentester but you cannot write a
    report, even if your life depended on it, then you will have a very hard career
    ahead of you. I think the big houses have spent years building out their report
    templates, and the few of us running smaller shops are still sharpening our reporting
    deliverables.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
- en: 'I like to start every report with a title page containing the company''s logo,
    the name of the report, and the customer''s company logo, as this helps appease
    the marketing team. Based on my background working with engineering companies,
    I then add a table containing the following information:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: Revision
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Date
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Description
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: By
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Approval
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The report should look something like the following:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 13.1 – Change control'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
- en: '](image/B16321_13_001.jpg)'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: Figure 13.1 – Change control
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
- en: The *Revision* number is a way to track which version of the report you are
    working on, in the event that you have multiple team members. *Date* should be
    obvious, as you want to track when the revision was done. The *Description* column
    gives the description of the changes/actions that occurred in the report. *By*
    is for the author of the revision and then, finally, the approver. This will help
    turn the report into a controlled engineering document, and it should adhere to
    a change management process.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: 'You then want to build out a high-level summary, which should include a scoring
    mechanism that relates the level of risk discovered through the testing. The risk
    score can be calculated by the following formula:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
- en: '*(attack vector) x (probability of happening) x (level of complexity) – (security
    controls) = cyber risk.*'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
- en: The following headings break down the formula and explain in greater detail
    each variable in the formula.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: Attack vector
  id: totrans-27
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: This can be open services, reusable credentials, spear phishing, and vulnerabilities
    associated with software that is discovered in the environment. You should be
    providing numerical weighting to each of these techniques. I haven't determined
    whether there is a *best* method for doing this yet. I feel everyone struggles
    with associating numerical weighting with specific attack vectors.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
- en: Probability of happening
  id: totrans-29
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Calculating the probability of an event happening is a straightforward stats
    problem where you use the classical probability rule, by taking the simple event
    and dividing it by the total number of plausible event outcomes. If we take our
    attack vector events as an example, it would be a ¼ or 0.25 probability of any
    one of those events occurring.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
- en: Level of complexity
  id: totrans-31
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'There are many methods to calculate complexity. I, however, simply use an expertise
    scale:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
- en: Script kiddy (beginner)
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Hacker (junior)
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Career pentester (intermediate)
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Nation state (senior)
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a service is open and external-facing, such as **File Transfer Protocol**
    (**FTP**), **Network File System** (**NFS**), or something similar, then it is
    easy to say that this is a relatively low level of complexity, which increases
    the risk factor.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: Security controls
  id: totrans-38
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'This directly relates to technology, policy, and procedures that a customer
    uses to secure their industrial environment. Asking very direct questions as you
    are performing testing is important to quantify and categorize the controls. Some
    of these questions can be as follows:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: Are they using firewalls?
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Are they using legacy firewalls?
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Are there issues with the firewall rules?
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Are they using crazy black-site **Access Control Lists** (**ACLs**) that no
    one knows exists? (This should be a story for another day).
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Are they using **Network Access Control** (**NAC**)?
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Are they using a **Network-based Intrusion Detection System** (**NIDS**)?
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Are they using a **Host-based Intrusion Detection System** (**HIDS**)?
  id: totrans-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Taking our last example, which we talked about in *Level of complexity*, even
    in a case of an open service exposure, if they have mitigating controls, the risk
    goes down considerably.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
- en: 'After the summary, we get down to the nitty-gritty. You may have noticed while
    reading through the book that there was a unique feel and flow. This was by design;
    we started working through some fundamentals on lab development, dabbled with
    the hardware, and then we moved on to explore techniques and tactics utilized
    in pentesting engagements. This is where we loosely followed the following plan:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
- en: Information gathering
  id: totrans-49
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Enumeration
  id: totrans-50
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Access
  id: totrans-51
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Privilege escalation
  id: totrans-52
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Lateral movement
  id: totrans-53
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Impact analysis
  id: totrans-54
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'This by no means is set in stone, hence the word loosely in the previous sentence.
    Everyone has their own strategy and groove for what works for them, and with time
    you will find what works best for you and your future clients. We started tackling
    the first item in the aforementioned plan, information gathering, in [*Chapter
    4*](B16321_04_Epub_AM.xhtml#_idTextAnchor040), *Open Source Ninja*, where we explored
    *Google Fu*, *Searching LinkedIn*, *Experimenting with Shodan.io*, *Investigating
    with ExploitDB*, and *Traversing NVD*. Performing these tasks allows us to consume
    a lot of information; during these actions, we need to capture the important,
    useful, and reusable data and store it, so that we can compile it for the information
    gathering section. This data needs to be communicated to the customer if it divulges
    too much detail that ultimately opens the door for a threat actor to slip in.
    Some of the key information I look for are email addresses and passwords that
    have been part of pwned reports. The following link allows you to quickly check
    to see whether your email has been compromised but also to check whether your
    customers'' emails have been compromised: [https://haveibeenpwned.com/](https://haveibeenpwned.com/)
    (thanks to Mr. Troy Hunt, the creator of the website). There are many services
    that are paid subscriptions and allow access to the breach data to pull out sensitive
    information.'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
- en: 'After the information section, we roll into the enumeration portion of the
    report. The tools to capture this data are found in [*Chapter 7*](B16321_07_Epub_AM.xhtml#_idTextAnchor081),
    *Scanning 101*, where we worked with **Nmap**, **RustScan**, **Gobuster**, and
    **feroxbuster**. Using these tools will help discover open ports, services, web
    applications, and hidden pages. There will be an incredible amount of data that
    can be harvested using these tools, and I have seen reports turned in where it
    has been pages and pages of Nmap scans, which I feel were used to pad the report
    page count. I caution that adding multiple pages of scans, like in the following
    figure, would be the wrong approach:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 13.2 – NMAP scan of a single host'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
- en: '](image/B16321_13_002.jpg)'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
- en: Figure 13.2 – NMAP scan of a single host
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
- en: 'Look strategically at what machines are found and the ports that are identified,
    and build a very clear and concise table of data discovered. In [*Chapter 5*](B16321_05_Epub_AM.xhtml#_idTextAnchor049),
    *Span Me If You Can*, we talked about **Intrusion Detection System** (**IDS**)
    technology, which is a great solution for automatically building out asset lists
    with ports and services. There are companies such as Forescout, Tenable, Cisco,
    Nozomi, Claroty, and SCADAfence that offer a 90-day trial and test IDS software.
    You can use these tools to build out presentation-worthy imagery. I will use an
    open source tool called **NetworkMiner**, which you can install by following this
    link: [https://www.netresec.com/?page=networkminer](https://www.netresec.com/?page=networkminer).'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 战略性地观察找到的机器以及识别的端口，并构建一个非常清晰简洁的数据表格。在[*第 5 章*](B16321_05_Epub_AM.xhtml#_idTextAnchor049)《如果你能，跨越我》，我们讨论了**入侵检测系统**（**IDS**）技术，这是一个自动构建包含端口和服务的资产列表的绝佳解决方案。像
    Forescout、Tenable、Cisco、Nozomi、Claroty 和 SCADAfence 等公司提供90天的试用，并测试 IDS 软件。你可以使用这些工具构建出适合展示的图像。我将使用一个名为
    **NetworkMiner** 的开源工具，你可以通过以下链接进行安装：[https://www.netresec.com/?page=networkminer](https://www.netresec.com/?page=networkminer)。
- en: 'Here is a quick sample of the information that can be gathered while running
    enumeration on the lab equipment:'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 这是在对实验室设备进行枚举时能够收集到的一些信息示例：
- en: '![Figure 13.3 – NetworkMiner lab details'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 13.3 – NetworkMiner 实验室详细信息'
- en: '](image/B16321_13_003.jpg)'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/B16321_13_003.jpg)'
- en: Figure 13.3 – NetworkMiner lab details
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.3 – NetworkMiner 实验室详细信息
- en: 'Now that we have enumeration covered, we want to move on to access. In this
    step, we want to clearly communicate how we established access into our customer''s
    network, what services we leveraged, and what user accounts we compromised to
    gain access, including diagrams, as the following is very useful as a visual aid:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经完成了枚举阶段，我们要进入访问阶段。在这一步中，我们要清晰地说明我们是如何建立与客户网络的连接、利用了哪些服务、以及我们如何通过哪些用户账户进行入侵以获得访问权限，并附上图示，因为以下内容作为视觉辅助非常有用：
- en: '![Figure 13.4 – Initial network access'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 13.4 – 初始网络访问'
- en: '](image/B16321_13_004.jpg)'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/B16321_13_004.jpg)'
- en: Figure 13.4 – Initial network access
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.4 – 初始网络访问
- en: Initial access could be an open service that was discovered during enumeration
    as in the preceding figure, or it could be a reverse shell driven by a phishing
    email, or a credential reuse attack from harvested data during the information
    gathering process. Regardless of the method of documenting, it is very important
    because if the access isn't documented, then the access never occurred.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 初始访问可能是通过枚举发现的一个开放服务，如前面的图所示，或者可能是由钓鱼邮件驱动的反向 shell，亦或是通过信息收集过程中获取的数据进行的凭证重用攻击。无论记录的方式如何，都是非常重要的，因为如果访问没有被记录，那就意味着访问从未发生过。
- en: 'After documenting the initial attack, we want to document how we performed
    and gained privilege escalation on the systems. We covered this in [*Chapter 11*](B16321_11_Epub_AM.xhtml#_idTextAnchor130),
    *Whoot… I Have To Go Deep*, and we talked about **horizontal** and **vertical**
    types of privilege escalation. We used **Mimikatz** to *pass the ticket*, and
    **WinPEAS** to automate the discovery of even more methods and tactics to use
    to elevate privileges. During the course of your testing, you should document
    the procedures run, the machines that you ran them on, and the privileges that
    you discovered. The following figure is a screenshot of a WinPEAS scan:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 在记录初始攻击后，我们需要记录如何在系统上执行并获取权限提升。我们在[*第 11 章*](B16321_11_Epub_AM.xhtml#_idTextAnchor130)《哇…我得深入研究》一章中讨论了**水平**和**垂直**类型的权限提升。我们使用了**Mimikatz**来*传递票证*，并使用**WinPEAS**来自动化发现更多的提升权限的方法和战术。在测试过程中，你应记录运行的过程、运行的机器以及发现的权限。下图是
    WinPEAS 扫描的截图：
- en: '![Figure 13.5 – WinPEAS basic scan'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 13.5 – WinPEAS 基础扫描'
- en: '](image/B16321_13_005.jpg)'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/B16321_13_005.jpg)'
- en: Figure 13.5 – WinPEAS basic scan
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.5 – WinPEAS 基础扫描
- en: 'After documenting privilege escalation, we want to move on to lateral movement.
    We want to mention how we were able to migrate from the enterprise network down
    into the operational network and then finally pivot down into the controls-level
    network, where the **Programmable Logic Controllers** (**PLCs**), **Remote Terminal
    Units** (**RTUs**), controllers, and other industrial equipment resides. Now,
    depending on the engagement level and type of pentest that you are running, the
    lateral movement might simply be from operations to control, based on the fact
    that the customer dropped you into the operations network. Providing a graphic
    as shown in the following figure helps the customer''s blue team really understand
    where they need to apply more security controls:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 13.6 – Lateral movement'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
- en: '](image/B16321_13_006.jpg)'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
- en: Figure 13.6 – Lateral movement
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: Finally, after all the previous steps have been documented, we arrive at the
    last item, impact analysis. Impact analysis might be the single most important
    topic of the entire report, as it is the justification for why customers hire
    pentesters in the first place. The requirement for them is to understand whether
    it is a temporary loss of operational control, business interruption, shutdown,
    ransom, or a myriad of other nasty issues that could cause financial loss, catastrophic
    failure, or even loss of life.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
- en: Story time
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
- en: When working in the northern part of Canada, I saw an engineering team switch
    configurations on two controllers. One controller was managing and operating a
    compressor and the other controller was operating a pump. No one caught the error
    until it was too late; the compressor blew all the seals and the pump cavitated.
    Needless to say, there was major disruption and financial losses for something
    so simple as pushing a new configuration to a PLC, much like we did in [*Chapter
    3*](B16321_03_Epub_AM.xhtml#_idTextAnchor033), *I Love My Bits – Lab Setup*. No
    lives were lost, which is fortunate, but this is a cautionary tale of being absolutely
    cautious when you gain access at the control level. If automation engineers who
    designed the system can make a simple mistake and cause tens of millions of dollars'
    worth of damage, imagine what damage a pentester could do by spraying the network
    with scans, scripts, and pushing different configurations to PLCs, RTUs, **Human
    Machine Interfaces** (**HMIs**), or controllers.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: The impact analysis section should be very clean and clear, and tied back to
    the lateral movement and privilege escalation. In [*Chapter 12*](B16321_12_Epub_AM.xhtml#_idTextAnchor139),
    *I See the Future*, we gained access to the user interface of the SCADA system,
    which is a great example of absolute system control. We would document our findings
    from [*Chapter 12*](B16321_12_Epub_AM.xhtml#_idTextAnchor139), *I See the Future*,
    in the impact analysis, due to the fact that we were able to reuse credentials
    discovered in the operations network; we could authenticate to the SCADA system
    and ultimately lock every user out and shut down the system. The key importance
    here is knowing the industry that your customer is in, which should have been
    discovered in the pre-engagement, kick-off meeting, or information-gathering step.
    Different industries will contain different levels of impact, and knowing this
    will be critical to document potential losses.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 影响分析部分应该非常简洁明了，并与横向移动和权限升级相关。在[*第12章*](B16321_12_Epub_AM.xhtml#_idTextAnchor139)，*我看到了未来*中，我们获得了SCADA系统用户界面的访问权限，这是绝对系统控制的一个很好的例子。我们将在影响分析中记录我们在[*第12章*](B16321_12_Epub_AM.xhtml#_idTextAnchor139)，*我看到了未来*中的发现，因为我们能够重新使用在运营网络中发现的凭证；我们可以验证SCADA系统，并最终将每个用户锁定并关闭系统。这里的关键是了解客户所在的行业，这应该在前期接洽、启动会议或信息收集步骤中发现。不同的行业将有不同的影响程度，了解这一点对于记录潜在损失至关重要。
- en: In this section, we discussed a general format that you can take to formulate
    a well-rounded penetration report. We talked about structure, content, and impact,
    and a high-level strategy to follow. Once again, this isn't the only way to write
    a report and everyone can put their own spin and take on how to architect their
    report. It ultimately comes down to client industry and personal branding. In
    the next section, we are going to discuss some remediation tactics to close the
    security gap and ultimately help the blue team build a better defensive strategy.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 在这一部分，我们讨论了一个通用格式，你可以用来制定全面的渗透报告。我们谈到了结构、内容和影响，以及要遵循的高层战略。再次强调，这并不是撰写报告的唯一方式，每个人都可以根据自己的风格和方式来构建报告。最终，还是取决于客户的行业和个人品牌。在接下来的部分中，我们将讨论一些修复战术，以弥补安全漏洞，最终帮助蓝队建立更好的防御策略。
- en: Closing the security gap
  id: totrans-83
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 弥补安全漏洞
- en: When it comes to pentesting, it isn't always doom and gloom. We do have a bright
    side to the job and that comes in the form of conveying security recommendations
    to help prevent the tactics and techniques used throughout your testing. In this
    section, we will discuss some of the security technology that can be implemented
    to help shore up a blue team's security posture.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 在渗透测试中，并非总是充满黑暗和沮丧。我们确实有工作的亮点，那就是通过传达安全建议来帮助防范在测试中使用的战术和技术。在这一部分，我们将讨论一些可以实施的安全技术，帮助加强蓝队的安全防御。
- en: MITRE ATT&CK
  id: totrans-85
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: MITRE ATT&CK
- en: 'Before we jump right into the technology side of things, I want to talk about
    the MITRE ATT&CK matrix, which can be found at this link: [https://collaborate.mitre.org/attackics/index.php/Main_Page](https://collaborate.mitre.org/attackics/index.php/Main_Page).'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们直接进入技术方面之前，我想谈谈MITRE ATT&CK矩阵，可以通过以下链接找到：[https://collaborate.mitre.org/attackics/index.php/Main_Page](https://collaborate.mitre.org/attackics/index.php/Main_Page)。
- en: 'This is a great visual representation of adversarial **Tactics, Techniques,
    and Procedures** (**TTPs**). I recommend running through each item and verifying
    whether your organization is vulnerable to any of the documented TTPs. Using the
    lateral movement tactic that we discussed in [*Chapter 10*](B16321_10_Epub_AM.xhtml#_idTextAnchor112),
    *I Can Do It 420*, [*Chapter 11*](B16321_11_Epub_AM.xhtml#_idTextAnchor130), *Whoot...
    I Have To Go Deep*, and [*Chapter 12*](B16321_12_Epub_AM.xhtml#_idTextAnchor139),
    *I See the Future*, we will focus on the valid accounts technique, as shown in
    the following figure:'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个很好的视觉展示，呈现了对抗性**战术、技术与流程**（**TTPs**）。我建议逐项检查并验证你的组织是否容易受到任何已记录的TTP攻击。使用我们在[*第10章*](B16321_10_Epub_AM.xhtml#_idTextAnchor112)中讨论的横向移动战术，*我能做到420*，[*第11章*](B16321_11_Epub_AM.xhtml#_idTextAnchor130)，*哇...我得深入了解*，以及[*第12章*](B16321_12_Epub_AM.xhtml#_idTextAnchor139)，*我看到了未来*，我们将重点讨论有效账户技巧，如下图所示：
- en: '![Figure 13.7 – Lateral movement tactic'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: '![图13.7 – 横向移动战术'
- en: '](image/B16321_13_007.jpg)'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/B16321_13_007.jpg)'
- en: Figure 13.7 – Lateral movement tactic
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 图13.7 – 横向移动战术
- en: 'As we discussed in [*Chapter 12*](B16321_12_Epub_AM.xhtml#_idTextAnchor139),
    *I See the Future*, password reuse is a major issue in the Industrial Control
    System (ICS) space. Under the valid accounts technique, you will find a description
    of the technique, assets that it can affect, real-world attacks that use valid
    accounts as the technique to compromise the organizations, and, most importantly,
    the mitigations. The following figure shows a screenshot of the valid accounts
    technique:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 正如我们在[*第12章*](B16321_12_Epub_AM.xhtml#_idTextAnchor139)中讨论的，*我看见未来*，密码重用是工业控制系统（ICS）领域的一个主要问题。在有效账户技术下，你将找到该技术的描述、它可能影响的资产、利用有效账户作为技术来入侵组织的真实攻击案例，最重要的是，缓解措施。下图展示了有效账户技术的截图：
- en: '![Figure 13.8 – Valid accounts technique'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: '![图13.8 – 有效账户技术'
- en: '](image/B16321_13_008.jpg)'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/B16321_13_008.jpg)'
- en: Figure 13.8 – Valid accounts technique
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 图13.8 – 有效账户技术
- en: 'As stated previously, mitigations are a very important piece of information
    that can be implemented by the blue team, and these implementations will increase
    the security maturity of their company. The following figure is an example of
    the mitigations that can be taken to protect your organization against lateral
    movement tactics using the valid accounts technique:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，缓解措施是蓝队可以实施的非常重要的信息，这些实施将提升公司安全成熟度。下图展示了可以采取的缓解措施，以保护你的组织免受使用有效账户技术进行横向移动战术的攻击：
- en: '![Figure 13.9 – Valid account technique mitigations'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: '![图13.9 – 有效账户技术缓解措施'
- en: '](image/B16321_13_009.jpg)'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: '](image/B16321_13_009.jpg)'
- en: Figure 13.9 – Valid account technique mitigations
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 图13.9 – 有效账户技术缓解措施
- en: 'There are automated systems that help ease this procedure. However, they do
    come with a hefty price tag. You will be able to see the results of some of these
    tools and how they were able to stack up to detection count, analytic coverage,
    telemetry coverage, and visibility of the Triton attack of 2017 if you follow
    this link: [https://attackevals.mitre-engenuity.org/ics/triton/](https://attackevals.mitre-engenuity.org/ics/triton/).'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 有一些自动化系统可以帮助简化这一过程。然而，它们的价格相当高。如果你点击此链接，你将能看到一些这些工具的结果，以及它们如何在检测数量、分析覆盖率、遥测覆盖率和2017年Triton攻击的可见性方面进行对比：[https://attackevals.mitre-engenuity.org/ics/triton/](https://attackevals.mitre-engenuity.org/ics/triton/)。
- en: Now that we have discussed the MITRE ATT&CK matrix, we will move on to technology
    that can be adopted to help improve a defense strategy. I know that when people
    read this section, they will suggest that posture, procedures, and defense in
    depth are more important, and they wouldn't be wrong. However, those topics are
    very subjective in nature, and we can get lost down many rabbit holes discussing
    those particular topics. I chose the topic of technology for the simple reason
    that everyone can agree that budgets for shiny new products get approval before
    strategic training programs. Also, there needs to be some bare minimums in place
    to mitigate at least 90% of most attacks.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们讨论完MITRE ATT&CK矩阵后，我们将继续探讨可以采用的技术，以帮助提升防御策略。我知道，当人们阅读这一部分时，他们会建议姿态、流程和深度防御更为重要，这样说也没有错。然而，这些话题本质上非常主观，我们在讨论这些话题时容易走进死胡同。我选择技术这一话题，原因很简单，大家都能同意的是，新产品的预算比战略性培训计划更容易获得批准。而且，为了至少缓解90%的大多数攻击，必须设立一些最低标准。
- en: Industrial firewalls
  id: totrans-101
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工业防火墙
- en: One of the oldest security technologies and one of the most fundamental is the
    firewall. You would be surprised but there are organizations that still do not
    use firewalls in their industrial environment. There are fewer and fewer of these
    organizations to be found, especially after the numerous international industrial
    incidents, but they can still be discovered. We quickly discussed firewalls in
    [*Chapter 11*](B16321_11_Epub_AM.xhtml#_idTextAnchor130), *Whoot… I Have To Go
    Deep*, and did a bit of high-level configuration of a pfSense firewall. In this
    section, we are going to discuss industry firewalls that you will come across
    in your pentesting journeys.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 最古老且最基础的安全技术之一就是防火墙。你可能会惊讶地发现，有些组织仍然没有在其工业环境中使用防火墙。这类组织虽然越来越少，尤其是在经历了诸多国际工业事故之后，但它们仍然存在。我们在[*第11章*](B16321_11_Epub_AM.xhtml#_idTextAnchor130)中简要讨论了防火墙，*哇...我得深入了解*，并对pfSense防火墙进行了高层次的配置。在本节中，我们将讨论在渗透测试过程中可能遇到的工业防火墙。
- en: 'The Cisco ISA3000 is an industrial firewall that you most certainly will come
    across; it is hyper-prevalent in the oil and gas industry. If you come across
    a customer that uses Cisco core switches, then there is a high probability that
    you find the ISA3000 in the lower segments. There are many highlights of the ISA3000,
    such as its ability to integrate into the greater Cisco ecosystem alongside **Identity
    Services Engine** (**ISE**), **Cyber Vision**, **SecureX**, **Threat Response**,
    and other Cisco security products. The ISA3000 supports containers, and this allows
    for the organization to quickly spin up Cisco Cyber Vision, which is an **industrial
    intrusion detection system**. Because of the containerization, the need for extra
    hardware and excesses spanning to take place is reduced. Next, with the ISE integration,
    it allows for newly discovered devices to be immediately quarantined by having
    ISE publish **Security Group Tags** (**SGTs**), which will auto-create rules for
    the network. This type of behavior can be very frustrating when operating a pentest
    in an environment that has enabled this type of integration. You will notice that
    you have access to certain assets for a short period of time and then, moments
    later, a loss of communication with the same assets due to published rules. More
    information about this can be found at the following link: [https://www.cisco.com/c/en/us/products/security/industrial-security-appliance-isa/index.html](https://www.cisco.com/c/en/us/products/security/industrial-security-appliance-isa/index.html).'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: Cisco ISA3000是一款你肯定会遇到的工业防火墙，它在石油和天然气行业中非常普及。如果你遇到一个使用思科核心交换机的客户，那么在较低的网络层级中找到ISA3000的可能性非常高。ISA3000有很多亮点，比如它能够与更大的思科生态系统集成，包括**身份服务引擎**（**ISE**）、**Cyber
    Vision**、**SecureX**、**Threat Response**和其他思科安全产品。ISA3000支持容器化，这使得组织能够快速启动思科Cyber
    Vision，这是一款**工业入侵检测系统**。由于容器化的存在，减少了额外硬件和扩展所需的开销。接下来，借助ISE集成，它能够通过ISE发布**安全组标签**（**SGTs**），使新发现的设备立即被隔离，这将自动创建网络规则。当在启用了这种集成的环境中进行渗透测试时，这种行为可能会非常令人沮丧。你会注意到，你能够访问某些资产的时间很短，片刻之后，因发布的规则失去与相同资产的通信。有关此内容的更多信息，请访问以下链接：[https://www.cisco.com/c/en/us/products/security/industrial-security-appliance-isa/index.html](https://www.cisco.com/c/en/us/products/security/industrial-security-appliance-isa/index.html)。
- en: 'The Palo Alto PA-220R has gained amazing traction in many unique industries
    and is the second most common firewall that I have encountered inside the industrial
    networks that I have worked with. Just like Cisco, Palo Alto has integrated ruggedized
    firewalls into a larger overarching ecosystem. One of the most interesting features
    in my mind would have to be Palo Alto''s WildFire service. WildFire is a community-shared
    service, where anything detected and crafted is detected and shared across the
    subscription service. If a rogue malicious file is detected on the system, it
    is tagged, and a signature is generated and submitted to WildFire. Any customer
    subscribed to WildFire has the ability to automatically pull down the signature
    and add it to the list of detection signatures inside the PA-220R. This service,
    if enabled, can be painfully annoying, as it requires some advanced strategies
    using **MSFvenom** and **Shikata Ga Nai**, which is a polymorphic encoder for
    generating reverse shellcode. This helps prevent WildFire from stopping unique
    files containing shellcode from being blocked across entire industries. More information
    about the Palo Alto ruggedized firewall can be found at the following link: [https://www.paloaltonetworks.com/network-security/next-generation-firewall/pa-220r](https://www.paloaltonetworks.com/network-security/next-generation-firewall/pa-220r).'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: Palo Alto PA-220R在许多独特的行业中获得了惊人的关注，它是我在与工业网络合作时遇到的第二常见防火墙。就像思科一样，Palo Alto将坚固耐用的防火墙集成到了更大的生态系统中。在我看来，最有趣的功能之一就是Palo
    Alto的WildFire服务。WildFire是一个共享社区服务，任何被检测到和制作的内容都会被检测并在订阅服务中共享。如果系统中检测到恶意文件，它会被标记，并生成一个签名，提交到WildFire。任何订阅了WildFire的客户都可以自动下载这个签名，并将其添加到PA-220R中的检测签名列表中。如果启用此服务，它可能会非常烦人，因为它需要一些高级策略，使用**MSFvenom**和**Shikata
    Ga Nai**，后者是一种多态编码器，用于生成反向shell代码。这有助于防止WildFire阻止包含shell代码的独特文件在整个行业中被拦截。有关Palo
    Alto坚固防火墙的更多信息，请访问以下链接：[https://www.paloaltonetworks.com/network-security/next-generation-firewall/pa-220r](https://www.paloaltonetworks.com/network-security/next-generation-firewall/pa-220r)。
- en: 'The Check Point Quantum Rugged 1570R is another NGFW to percolate down into
    the **ICS** space, and I have definitely come across this in utility companies.
    Touting a library of 1500 ICS protocols, I can definitely vouch for a number of
    these and, specifically, the protocols that we discussed in [*Chapter 8*](B16321_08_Epub_AM.xhtml#_idTextAnchor097),
    *Protocols 202*. The following link will provide more information: [https://www.checkpoint.com/quantum/next-generation-firewall/industrial-control-systems-appliances/](https://www.checkpoint.com/quantum/next-generation-firewall/industrial-control-systems-appliances/).'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
- en: Other notable firewalls include Fortinet, Hirschmann, Red Lion, and Stormshield,
    to name a few.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
- en: In the next section, we will be discussing various OT monitoring solutions.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
- en: OT monitoring solutions
  id: totrans-108
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'For some time, OT monitoring solutions were the de facto technology being utilized
    in industrial networks. These solutions are a mixture of agents, rules, baselines,
    policies, and signatures. The deployment method was to install agents on the workstations,
    data historians, SCADA servers, and various other equipment, and have those agents
    collect key operational information from the assets that they are installed on
    and send it to a collection point. At this collection point, rules and signatures
    are applied to detect changes or anomalous behavior on the endpoint. This generates
    alerts and events that can be monitored by a security team. The following diagram
    is what a typical installation could look like inside our lab:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 13.10 – A typical OT monitoring solution'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
- en: '](image/B16321_13_010.jpg)'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
- en: Figure 13.10 – A typical OT monitoring solution
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
- en: 'Industrial Defender''s solution, now called ASM, is notably one of the first,
    if not the first, industrial cybersecurity solutions to hit the market. This product
    can be found on six or seven continents in multiple industries and landed a heavy
    presence in the electrical utility industry, as it embraced the **North American
    Electric Reliability Corporation** (**NERC**) **Critical Infrastructure Protection**
    (**CIP**) standard and provided an automated solution that aided utilities in
    adhering to compliance requirements. This product allows the customer to have
    a complete granularity of every asset in the network, software installed, users
    that have access, firewall rules applied, patches applied, services running, and
    much more. If a new account is locally created, an alert is instantly triggered
    and sent off to the security team, due to the fact that the baseline of the asset
    has been altered. The following link can provide more solution information: [https://www.industrialdefender.com/ot-cyber-risk-management/](https://www.industrialdefender.com/ot-cyber-risk-management/).'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
- en: 'PAS''s Cyber Integrity is a direct competitor to Industrial Defender''s ASM
    solution. Both provide similar features to address the fortification tasks that
    the industrial cybersecurity landscape presents. PAS has a unique feature that
    allows customers to keep track of their PLC, RTU, and controller source code,
    and perform differentials on files, looking for any major issues that could rear
    their ugly head, plus the added value of having a gold copy of the source for
    a quick rollback. If you follow this link, you will find more information about
    Cyber Integrity: [https://cyber.pas.com/cyber-integrity/ot-ics-cyber-integrity](https://cyber.pas.com/cyber-integrity/ot-ics-cyber-integrity).'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
- en: Other notable OT monitoring products include Verve and Tripwire.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
- en: In the next section, we will be discussing **IDS**
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
- en: .
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
- en: Intrusion detection systems
  id: totrans-118
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'In [*Chapter 5*](B16321_05_Epub_AM.xhtml#_idTextAnchor049), *Span Me If You
    Can*, I covered IDS in great detail, and now we are talking about them again due
    to the fact that they really have taken the industry by storm, and at the time
    of writing this, Dragos, Claroty, and Nozomi Networks have all raised $100 million
    of additional capital, which means that these technologies certainly have legs
    and the confidence of institutional investors. Dale Peterson and Roger Collins
    started a company called Digital Bond over two decades before the writing of this
    book. They wrote the first signatures for the IDS space. I wonder if they knew
    at the time that the industry would grow as dramatically as it has, with companies
    such as SecurityMatters, Indegy, CyberX, and Sentryo being acquired for close
    to a combined value of $500 million, and then the previous three companies adding
    over $300 million extra in funding, in addition to companies such as SCADAfence
    and Armis, which tips the industry value into well over $1 billion. If the company
    you come across doesn''t have an IDS, I would say that this is an easy win when
    it comes to recommendations. If you look at the following diagram, you can see
    the typical placement of IDS sensors, although you can have variable numbers of
    sensors scattered around the network:'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 13.11 – A typical IDS installation'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
- en: '](image/B16321_13_011.jpg)'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
- en: Figure 13.11 – A typical IDS installation
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: 'The Dragos Platform has infused the latest industry intelligence with top-tier
    talent to develop a holistic solution. The unique part of the product is the battle-tested
    playbooks that they incorporate into the solution. On top of the detection and
    alerting features that generate events, there lies a module that provides clients
    with plans of actions to take to close any security gaps that are detected. This
    allows for the product to be managed and monitored by non-industry experts, which
    happens to be one of the biggest issues in industrial cybersecurity – the drastic
    lack of skilled talent. If you come across this technology, know that you have
    a high probability of having your device being blacklisted across the switchgear.
    More information about the platform can be found at this link: [https://www.dragos.com/platform/](https://www.dragos.com/platform/).'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
- en: 'Claroty''s **Continuous Threat Detection** (**CTD**) brings all the bells and
    whistles those other IDS solutions present. The security research team is top-notch,
    and they have published information on multiple vulnerabilities for the community
    to consume and detect. One of the most interesting features is the root-cause
    analysis that the platform performs. This allows the user to trace from where
    a security breach or vulnerability started. A lot of research goes into a module
    that performs this unique analysis, and the customer base benefits from this and
    enables the security team to plug the holes. For more information, follow this
    link: [https://claroty.com/comprehensive-platform-overview/](https://claroty.com/comprehensive-platform-overview/).'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
- en: Notable vendors include Nozomi Networks, Cisco Cyber Vision (Sentryo), SCADAfence,
    Tenable OT (Indegy), Microsoft (CyberX), and Forescout (SecurityMatters).
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
- en: I should make a note that when mentioning other tools, there has been no bias,
    just simply equipment that I have come across during my career in industrial cybersecurity.
    There are many other products and vendors that round out the topics that were
    covered, such as industrial firewalls, OT monitoring solutions, IDS, and host
    IDS. Make sure that you do your due diligence when researching and investigating
    products and technology that you want to recommend to your clients during the
    recommendations stage of your report.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  id: totrans-127
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we discussed tips and techniques for drafting a penetration
    report and went through key elements that will help close the security gap for
    your customers.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
- en: 'These topics round out the pentesting journey, which brings us to the end of
    the chapter and, ultimately, the book. Some people might have made it this far
    and they may be disappointed that there was no *click, deploy, and pwn* solution
    to hack critical infrastructure. I have to say that writing this book caused some
    moral dilemmas with how deep to go on certain topics and how much compromising
    information should be revealed. I think that enough knowledge was passed on to
    help new pentesters establish a firm foundation and build on these fundamental
    skills. I wish you luck and best wishes on your journey, and I will leave you
    with this quote:'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
- en: '"There''s really no secret about our approach. We keep moving forward – opening
    up new doors and doing new things – because we''re curious. And curiosity keeps
    leading us down new paths. We''re always exploring and experimenting."'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
- en: – Walt Disney
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
