<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Pentest Automation Using Python</h1>
                </header>
            
            <article>
                
<p class="mce-root"><span>Folks, this is the last chapter of this book, and I would like to congratulate you on getting this far. Only disciplined and motivated people get to the finishing line, and you all have my respect. So far, you've learned many Terminal commands that you can execute during security tests. However, one thing that you will realize during pentests is that a lot of commands will just repeat over and over again, so why not <strong>automate</strong> these commands using a scripting language such as Python?</span></p>
<p class="mce-root"><span>In this chapter, I will </span><span>quickly</span><span> </span><span>show you how to install a Python IDE on Kali, and after that, we will look at a practical scenario and try to develop a program using Python. I will walk you through all the steps needed for you to start automating your penetration testing tasks, using practical examples as much as possible.</span></p>
<div class="mce-root packt_infobox">I created a full reference section for Python in <em>Appendix E. C</em>heck it out.</div>
<p><span>Are you ready to start? First, let me give you a heads up of the contents of this chapter:</span></p>
<ul>
<li>Learning how to install a Python IDE on Kali</li>
<li>Learning how to develop an automated script in Python</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Python IDE</h1>
                </header>
            
            <article>
                
<p>You will need a Python <strong>I<span>ntegrated Development Environment</span></strong> (<strong>IDE</strong>) to develop your own scripts. Y<span>ou're not obliged</span> to use a Python IDE,<span> and instead, you can use any text editor in Kali Linux (for example, nano, vim, or gedit). However, using a professional IDE is a must if you want to easily develop large scripts that allow you to debug errors, format the source code, visualize the output, and detect errors even before the application is run. In this chapter, we will use a very popular and free Python IDE called</span> <strong>PyCharm</strong><span>. You can find it at </span><a href="https://www.jetbrains.com/pycharm/">https://www.jetbrains.com/pycharm/</a><span>.</span></p>
<p><span>You</span><span> </span>can also use the Python interpreter using your Terminal window. Let's say you have an idea and you want to test it quickly. Open your Terminal window in Kali, type <kbd>python</kbd>, and then press <em>Enter</em>. Let's look at an example. I will create a variable called <kbd>ip_address</kbd>, give it a value, and then print it on the screen:</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/b47ecd04-5c8c-42f9-ac1c-3a1981fd99f4.png" width="1995" height="589"/></div>
<p class="mce-root">You can see in the preceding screenshot that the default Python interpreter in Kali is 2.7.14, and in fact, that's the one that I will be using in this chapter. Yes, there is a newer version of Python (version 3), but it will not be covered in this book. If you would like to deepen your knowledge of Python, I advise you to watch some online courses to speed up the learning process and buy at least one book as a reference for your advanced projects as well (also, don't forget to check out <em>Appendix E</em>).</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Downloading and installing PyCharm </h1>
                </header>
            
            <article>
                
<p>In this section, we will download and install PyCharm on Kali:</p>
<ol>
<li>Open your browser and head straight to the download section at <a href="https://www.jetbrains.com/pycharm/download">https://www.jetbrains.com/pycharm/download</a>: </li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/c127d2ad-bcf5-49fe-bd75-d51af530a5fb.png" width="1284" height="606"/></div>
<ol start="2">
<li>Once you are on the <span class="packt_screen">Download</span> page, download the free community edition of PyCharm. After the download is finished, you will need to right-click on the newly downloaded file and select <span class="packt_screen">Extract Here</span>:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/32cf4360-8961-46be-b376-7327027730f6.png" style="width:42.08em;height:25.50em;" width="894" height="541"/></div>
<ol start="3">
<li>Once you extract the archived directory, try to open the <kbd>bin</kbd> folder, then execute the <kbd>pycharm.sh</kbd> file:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/41e4824e-6d5b-4c97-bc2f-587e4c7fb74e.png" width="1995" height="296"/></div>
<p>After executing the preceding command, you will be prompted by a few dialogs to help the installation. Nothing special! All you need to do is accept the agreement and the default installation parameters. Don't worry, because you can edit them later if you change your mind. With that said, we're done with downloading and installing PyCharm.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">PyCharm quick overview</h1>
                </header>
            
            <article>
                
<p>In this section, we will try to execute a simple <kbd>Hello World</kbd> example using PyCharm, and we will change its configuration to use Python version 2.7 as well. To run it, execute the <kbd>pycharm.sh</kbd> code phrase that we executed earlier when we installed PyCharm:</p>
<ol>
<li>In the dialog window, click the <span class="packt_screen">Create New Project</span> button. Next, select the path to the location where you want to save your project:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/038a3841-e810-4a18-9248-cb26432977a5.png" style="width:29.92em;height:22.17em;" width="1724" height="1281"/></div>
<ol start="2">
<li>As you can see in the preceding screenshot, I changed the <span class="packt_screen">Base interpreter</span> to Python 2.7 to make sure the code will compile according to this version's syntax specification. Also, take note that in the preceding example, I've chosen to save the source in the <kbd>/root/PycharmProjects/test</kbd> path. Click on the <span class="packt_screen">Create</span> button to create the new project.</li>
<li>The IDE UI will open, and the first thing you will need to do is create the Python file. To do this, right-click on the <kbd>test</kbd> directory in the left section of PyCharm, choose <span class="packt_screen">New</span>, then click on<span class="packt_screen"> Python</span> <span class="packt_screen">File</span> from the menu:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/4531c68b-878e-46ab-8d92-508bfec5b4ca.png" style="width:42.25em;height:17.42em;" width="1995" height="822"/></div>
<ol start="4">
<li>I will call the <kbd>HelloWorld</kbd> file and create it. Next, let's try to create your first Python program. I will add the following simple line of code to print the phrase <kbd>Hello World</kbd> to the screen:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/8bf0be0c-d363-475f-880f-ee85b54aa098.png" style="width:39.08em;height:11.50em;" width="1695" height="497"/></div>
<ol start="5">
<li>What if you made a mistake? The IDE will let you know before you run the code by underlining the mistake with a red line. It will also tell you what is wrong with your code. Next, let's run the <kbd>Hello World</kbd> script. To do this, select the <span class="packt_screen">Run</span> menu and choose <span class="packt_screen">Run..</span><span class="packt_screen">.</span> from the list to execute the script:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/58f4e733-5050-4aee-8f0a-89dc40f5d875.png" style="width:40.17em;height:15.17em;" width="1924" height="727"/></div>
<p style="padding-left: 60px">If you look closely at the bottom of the IDE, you will see the output of the script:</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/2b6d7b8f-b96f-4964-b5c9-8b7acff0082b.png" style="width:42.08em;height:7.92em;" width="1836" height="346"/></div>
<p class="mce-root CDPAlignLeft CDPAlign"><span>Congratulations! You just finished building your first program using the PyCharm IDE. Let's go to the next section and develop the real automated script.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Penetration testing automation</h1>
                </header>
            
            <article>
                
<p>In this section, I will show you how to develop a fully functioning application that can automatically perform a TCP scan and  perform a service enumeration as well. The application will first execute an Nmap TCP scan, then we will check whether the FTP or HTTP ports are opened, and finally we will enumerate those services. I have limited this application to only FTP and HTTP ports, but you can add more services to your liking.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title"> Automate.py in action</h1>
                </header>
            
            <article>
                
<p>I highly encourage you to go ahead and try to download the source code from <a href="https://github.com/PacktPublishing/Practical-Web-Penetration-Testing">https://github.com/PacktPublishing/Practical-Web-Penetration-Testing</a>. Be sure to install <kbd>gobuster</kbd> in Kali (using the <kbd>apt-get install gobuster</kbd> <span>command</span><span>).</span></p>
<p>In Kali Linux, open the Terminal window and execute the following command in your Terminal window (make sure you are in the same directory):</p>
<pre><strong>python Automate.py</strong></pre>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/6ff267f2-f0d4-45f2-aa12-4bf2803e80f4.png" width="1115" height="598"/></div>
<p>After executing the command, you will enter the target IP address that you want to scan, and the application will show you the progress of the scan until it has finished. Finally, you can check the report contents of your scan in the <kbd>reports</kbd> folder:</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/6f7bb6a0-e6e9-461f-8530-88ba723a5351.png" style="width:39.83em;height:32.83em;" width="899" height="741"/></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Utility functions</h1>
                </header>
            
            <article>
                
<p>In this section of the tool, I added the utility functions that we will reuse throughout the source code. These functions are shown in the following bullet list:</p>
<ul>
<li>For printing the separators lines, use the following:</li>
</ul>
<pre style="padding-left: 60px">separator_single_line = <span>'------------------------------------------------------------'<br/></span>separator_double_line = <span>'============================================================'</span></pre>
<ul>
<li>For printing the colored texts on the Terminal window, use the following:</li>
</ul>
<pre style="padding-left: 60px"><span># Printing Red Text for errors<br/></span><span>def </span>print_red(text): <span>print</span>(<span>"</span><span>\033</span><span>[91m {}</span><span>\033</span><span>[00m"</span>.format (text))<br/><br/><br/><span># Printing Green Text for messages<br/></span><span>def </span>print_green(text): <span>print</span>(<span>"</span><span>\033</span><span>[92m {}</span><span>\033</span><span>[00m"</span>.format (text))<br/><br/><br/><span># Printing Yellow Text for warnings<br/></span><span>def </span>print_yellow(text): <span>print</span>(<span>"</span><span>\033</span><span>[93m {}</span><span>\033</span><span>[00m"</span>.format (text))</pre>
<ul>
<li>For saving the report results to a file, use the following:</li>
</ul>
<pre style="padding-left: 60px"><span>def </span>save_results(results, folder_name, file_name):<br/>    <span>try</span>:<br/>        <span># Save the results to a folder/file<br/></span><span>        </span>file_name_path = folder_name + <span>"/" </span>+ file_name<br/><br/>        <span># If the folder does not exist then create it<br/></span><span>        </span><span>if not </span>os.path.isdir (folder_name):<br/>            os.mkdir (folder_name)<br/><br/>        <span># Create the file object<br/></span><span>        </span>file_to_save = <span>open </span>(file_name_path, <span>'w'</span>)<br/>        <span># Make sure the output is correctly encoded<br/></span><span>        </span>results = results.encode (<span>'utf-8'</span>)<br/>        <span># Write the changes<br/></span><span>        </span>file_to_save.write (results)<br/>        <span># Close file object<br/></span><span>        </span>file_to_save.close ()<br/>    <span>except </span><span>Exception</span>, e:<br/>        exception_message = <span>str </span>(e)<br/>        print_red (<span>'[!] Error: Cannot save the results to a file! Reason:</span><span>\r\n</span><span>' </span>+ exception_message)</pre>
<ul>
<li>To execute a Terminal window command, use the following:</li>
</ul>
<pre style="padding-left: 60px"><span>def </span>execute_cmd(tool_name, cmd):<br/>    start_msg = <span>"[+] Starting %s ..." </span>% tool_name<br/>    print_green (start_msg)<br/>    <span># The output variable that stores the output from the command line<br/></span><span>    </span>output = <span>''<br/></span><span><br/></span><span>    </span><span>try</span>:<br/>        <span># Cleanup the command string<br/></span><span>        </span>cmd = cmd.rstrip()<br/>        <span># Execute the command<br/></span><span>        </span>output += subprocess.check_output(cmd, <span>shell</span>=<span>True</span>, <span>stderr</span>=subprocess.STDOUT)<br/>        <span># Add a new line<br/></span><span>        </span>output += <span>'</span><span>\r\n</span><span>'<br/></span><span>    </span><span>except </span><span>Exception</span>, e:<br/>        exception_message = <span>str </span>(e)<br/>        output += exception_message<br/>        print_red (<span>"[!] Error executing the command: " </span>+ cmd + <span>" Reason:</span><span>\r\n</span><span>" </span>+ exception_message)<br/>        output += <span>'</span><span>\r\n</span><span>'<br/></span><span><br/></span><span>    </span>output += separator_single_line + <span>'</span><span>\r\n</span><span>'<br/></span><span><br/></span><span>    </span>end_msg = <span>"[+] Finished %s ..." </span>% tool_name<br/>    print_green (end_msg)<br/>    <span>return </span>output</pre>
<ul>
<li>To print error messages after the command's execution, use the following:</li>
</ul>
<pre style="padding-left: 60px"><span>def </span>error_execution(tool_name): print_red (<span>"Error Executing " </span>+ tool_name)</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Service enumeration</h1>
                </header>
            
            <article>
                
<p>As I mentioned earlier, the application will enumerate the HTTP and FTP services after running the Nmap TCP scan (if the ports are open):</p>
<ul>
<li>For FTP enumeration using Nmap, use the following:</li>
</ul>
<pre style="padding-left: 60px">nmap_ftp_tool_name = <span>'NMAP FTP Enum'<br/><br/></span><span>def </span>execute_nmap_ftp_enum(ip_address, port_number):<br/> command = <span>"nmap -sV -p %s --script=ftp* %s" </span>% (port_number, ip_address)<br/> <span>return </span>execute_cmd (nmap_ftp_tool_name, command)</pre>
<ul>
<li>For HTTP, I used Nmap for script scanning and <kbd>gobuster</kbd> to find hidden URLs:</li>
</ul>
<pre style="padding-left: 60px">nmap_tool_name = <span>'NMAP HTTP Enum'<br/></span>crawler_tool_name = <span>'Gobuster'<br/></span><span><br/></span><span># Description: Execute an Nmap HTTP enum command<br/></span><span># Return: The output after command execution<br/></span><span>def </span>execute_nmap_http_enum(ip_address, port_number):<br/>    command = <span>"nmap -sV -p %s --script=http-enum,http-vuln*  %s" </span>% (port_number, ip_address)<br/>    <span>return </span>execute_cmd (nmap_tool_name, command)<br/><br/><span># Description: Execute an HTTP browsing enum command<br/></span><span># Return: The output after command execution<br/></span><span>def </span>execute_directories_http_enum(ip_address, port_number):<br/>    command = <span>"gobuster -u http://%s:%s -w /usr/share/wordlists/dirb/common.txt -s '200,204,301,302,307,403,500' -e" </span>% (<br/>        ip_address, port_number)<br/>    <span>return </span>execute_cmd (crawler_tool_name, command)</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">DTO service class</h1>
                </header>
            
            <article>
                
<p>The <strong>data transfer object</strong> (<strong>DTO</strong>) service class will hold the results of each service that is found after a TCP scan. A service will have three criteria:</p>
<ul>
<li>Service port</li>
<li>Name</li>
<li>Description</li>
</ul>
<p>We will call this class when using the Nmap results parser, as follows:</p>
<pre><span>class </span>ServiceDTO:<br/>    <span># Class Constructor<br/></span><span>    </span><span>def </span><span>__init__</span>(<span>self</span>, port, name, description):<br/>        <span>self</span>.description = description<br/>        <span>self</span>.port = port<br/>        <span>self</span>.name = name</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">The scanner core</h1>
                </header>
            
            <article>
                
<p>The core section will run the TCP scan using Nmap, then we parse the results, and finally, for all the services that are found, we call the enumerate methods that we talked about previously, as shown in the following list:</p>
<ul>
<li>To execute the TCP scan using Nmap, use the following:</li>
</ul>
<pre style="padding-left: 60px"><span>def </span>start_nmap_tcp_scan(ip_address):<br/>    nmap_tcp_command = <span>"nmap -T4 -sS -sV -sC -p- -O --open --osscan-guess --version-all %s" </span>% ip_address<br/>    nmap_tcp_output = execute_cmd (<span>'Nmap TCP Scan'</span>, nmap_tcp_command)<br/>    <span>#Parse the nmap scan results<br/></span><span>    </span>service_names_list = parse_nmap_output(nmap_tcp_output)<br/>    <span>#Start the enumeration process<br/></span><span>    </span>start_enumeration_process(service_names_list,ip_address)<br/>    print_yellow(<span>"[!] The Program Scanner Has Finished The Execution (report saved to /reports)"</span>)</pre>
<ul>
<li>To parse the Nmap output results, use the following:</li>
</ul>
<pre style="padding-left: 60px"><span>def </span>parse_nmap_output(nmap_output):<br/>    service_names_list = {}<br/>    nmap_output = nmap_output.split (<span>"</span><span>\n</span><span>"</span>)<br/>    <span>for </span>output_line <span>in </span>nmap_output:<br/>        output_line = output_line.strip ()<br/>        services_list = []<br/>        <span># if port is opened<br/></span><span>        </span><span>if </span>(<span>"tcp" </span><span>in </span>output_line) <span>and </span>(<span>"open" </span><span>in </span>output_line) <span>and not </span>(<span>"Discovered" </span><span>in </span>output_line):<br/>            <span># cleanup the spaces<br/></span><span>            </span><span>while </span><span>"  " </span><span>in </span>output_line:<br/>                output_line = output_line.replace (<span>"  "</span>, <span>" "</span>)<br/>            <span># Split the line<br/></span><span>            </span>output_line_split = output_line.split (<span>" "</span>)<br/>            <span># The third part of the split is the service name<br/></span><span>            </span>service_name = output_line_split[<span>2</span>]<br/>            <span># The first part of the split is the port number<br/></span><span>            </span>port_number = output_line_split[<span>0</span>]<br/><br/>            <span># It's time to get the service description<br/></span><span>            </span>output_line_split_length = <span>len </span>(output_line_split)<br/>            end_position = output_line_split_length - <span>1<br/></span><span>            </span>current_position = <span>3<br/></span><span>            </span>service_description = <span>''<br/></span><span><br/></span><span>            </span><span>while </span>current_position &lt;= end_position:<br/>                service_description += <span>' ' </span>+ output_line_split[current_position]<br/>                current_position += <span>1<br/></span><span><br/></span><span>            </span><span># Create the service Object<br/></span><span>            </span>service = ServiceDTO (port_number, service_name, service_description)<br/>            <span># Make sure to add a new service if another one already exists on a different port number<br/></span><span>            </span><span>if </span>service_name <span>in </span>service_names_list:<br/>                <span># Get the objects that are previously saved<br/></span><span>                </span>services_list = service_names_list[service_name]<br/><br/>            services_list.append (service)<br/>            service_names_list[service_name] = services_list<br/><br/>    <span>return </span>service_names_list</pre>
<ul>
<li><span>Start the enumeration process after both the TCP scan and the parsing of the results:</span></li>
</ul>
<pre style="padding-left: 60px"><span># Start the enumeration process after the TCP scan<br/></span><span>def </span>start_enumeration_process(nmap_output_services_list, ip_address):<br/>    enum_output = <span>''<br/></span><span>    </span><span>for </span>service_name <span>in </span>nmap_output_services_list:<br/>        services = nmap_output_services_list[service_name]<br/>        <span>if </span>service_name == <span>"http"</span>:<br/>            <span>for </span>service <span>in </span>services:<br/>                port_number = service.port.split(<span>"/"</span>)[<span>0</span>]<br/>                enum_output += enum_http(ip_address,port_number)<br/>        <span>elif </span><span>"ftp" </span><span>in </span>service_name:<br/>            <span>for </span>service <span>in </span>services:<br/>                port_number = service.port.split (<span>"/"</span>)[<span>0</span>]<br/>                enum_output += enum_ftp(ip_address,port_number)<br/><br/>    save_results(enum_output,<span>'./reports'</span>, ip_address+<span>".txt"</span>)</pre>
<p>Again, I invite you to download the source code from GitHub and play with it in your IDE in Kali Linux.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>We're done, folks! I hope that you loved reading this book, and to make sure that I can help you with any questions or comments regarding the contents of this book, here's a list of contact details that you can use to communicate with me:</p>
<ul>
<li><strong>Email</strong>: <kbd>gus.khawaja@guskhawaja.me</kbd></li>
<li><strong>Twitter</strong>: <kbd>@gusKhawaja</kbd></li>
<li><strong>LinkedIn</strong>: <kbd>https://ca.linkedin.com/in/guskhawaja</kbd></li>
<li><strong>Blog</strong>: <kbd>http://ethicalhackingblog.com</kbd></li>
</ul>
<p><strong>Hacking is not a sin—it's an art!</strong></p>


            </article>

            
        </section>
    </div>



  </body></html>