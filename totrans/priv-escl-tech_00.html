<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer047">
			<h1 id="_idParaDest-30"><em class="italic"><a id="_idTextAnchor030"/>Chapter 2</em>: Setting Up Our Lab</h1>
			<p>Given the robust and technical nature of the work that a security researcher or penetration tester indulges in, it is vitally important that you practice and test your hacking skills in a safe and isolated virtual environment to avoid causing damage to public systems, computers, or networks. The art of setting up a <strong class="bold">virtual hacking lab</strong> is an essential skill for a <em class="italic">penetration tester</em>, as it allows for the rapid deployment, testing, and exploitation of systems without having to target public systems or network infrastructures.</p>
			<p>It is, therefore, vitally important to know how to set up a <strong class="bold">virtualized environment</strong> that can be used for practicing your penetration testing skills legally. Having a personal virtual hacking lab allows you to test out new attacks, exploits, and tools, and this, in turn, will enhance your learning process and will consistently build up your skill set making you a more competent hacker. Similarly, in this chapter, you will learn how to design and configure your own robust isolated virtual hacking lab, which will be used for learning and practicing the various <em class="italic">exploitation</em> and <em class="italic">privilege escalation</em> techniques on the Windows and Linux operating systems that are demonstrated in this book.</p>
			<p>This chapter will give you the necessary knowledge and skills to design, deploy, configure, and troubleshoot your own isolated virtual hacking lab.</p>
			<p>In this chapter, we will cover the following topics:</p>
			<ul>
				<li>Designing our lab</li>
				<li>Building our lab</li>
				<li>Setting up Kali Linux</li>
			</ul>
			<h1 id="_idParaDest-31"><a id="_idTextAnchor031"/>Technical requirements </h1>
			<p>To follow along with the demonstrations in this chapter, you will need to ensure that you have met the following hardware and software requirements:</p>
			<ul>
				<li>A Windows, Linux, or macOS-hosted operating system is required.</li>
				<li>A minimum of 4 GB of RAM is required. 8 GB is the preferred specification.</li>
				<li>More than 500 GB of free storage.</li>
				<li>A processor that supports virtualization technology (for instance, Intel VT-x or AMD VT).</li>
				<li>A general understanding of how <strong class="bold">VirtualBox</strong> works.</li>
			</ul>
			<p>Now that we have an idea of what we will be covering, let's dive right into the first topic.</p>
			<p>You can view this chapter's code in action here: <a href="https://bit.ly/3ukgh6C">https://bit.ly/3ukgh6C</a></p>
			<h1 id="_idParaDest-32"><a id="_idTextAnchor032"/>Designing our lab</h1>
			<p>In this section, we will start building our virtual hacking lab. We will <a id="_idIndexMarker082"/>design and structure our lab based on our <a id="_idIndexMarker083"/>requirements for the exercises and demonstrations in this book. </p>
			<p>To set up our lab infrastructure, we need to leverage <strong class="bold">virtualization</strong> technology. This will allow us to avoid any additional costs related to hardware and networking, as we will be running all of our <em class="italic">guest operating systems</em> and configuring our <em class="italic">virtual network</em> on one host.</p>
			<p>Before we get started with designing and structuring our lab, we need to explore virtualization as a concept and as a practice. First, we will learn about the importance of and the role of virtualization in building and configuring our virtual hacking lab.</p>
			<h2 id="_idParaDest-33"><a id="_idTextAnchor033"/>Virtualization</h2>
			<p>Virtualization is the <a id="_idIndexMarker084"/>process of running a virtualized <a id="_idIndexMarker085"/>instance of an operating system with an abstracted hardware layer. Virtualization facilitates the running of multiple operating systems on a single computer, or host, simultaneously. It was invented as a way to help large organizations and companies reduce their need for and expenditure on hardware for hosting and networking equipment.</p>
			<p>Originally, large companies and organizations would have to buy entire servers to host services such as email and web applications. Each service was hosted on its own dedicated server. This, in turn, led to an increase in spending by companies with no added benefit to factors such as performance and resource efficiency, given the fact that most servers are configured to be high performance, have a high number of system resources such as <em class="italic">RAM</em>, and are configured with powerful CPUs. However, given the fact that companies were only able to host one service per server, most of the time, the system resources such as processing power and RAM would be underutilized, which made hosting inefficient. This type of traditional hosting infrastructure is illustrated in <em class="italic">Figure 2.1</em>:</p>
			<div>
				<div id="_idContainer015" class="IMG---Figure">
					<img src="Images/B17389_02_001.jpg" alt="Figure 2.1 – A traditional hosting infrastructure&#13;&#10;" width="558" height="188"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.1 – A traditional hosting infrastructure</p>
			<p>This problem <a id="_idIndexMarker086"/>of resource inefficiency is what virtualization <a id="_idIndexMarker087"/>was created to solve. With virtualization in place, companies are now able to run multiple operating systems and host multiple services on one dedicated server. Virtualization ensures that system resources are properly and efficiently utilized, as a server can be configured to run as many services as possible within the constraints of the physical resources and the capacity of the server.</p>
			<p><em class="italic">Figure 2.2</em> illustrates how, using a <em class="italic">hypervisor</em> such as VirtualBox, virtualization can be used to configure multiple operating systems and services to run on one server:</p>
			<div>
				<div id="_idContainer016" class="IMG---Figure">
					<img src="Images/B17389_02_002.jpg" alt="Figure 2.2 – A modern hosting infrastructure&#13;&#10;" width="366" height="404"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.2 – A modern hosting infrastructure</p>
			<p>In <em class="italic">Figure 2.2</em>, a server has been configured to <strong class="bold">virtualize three</strong> operating systems that each host their own <a id="_idIndexMarker088"/>services. This clearly outlines the benefits of <a id="_idIndexMarker089"/>utilizing virtualization not only for companies but also for individuals and professionals. Likewise, we will be using virtualization to host our target and attacker operating systems on one host system. For us to leverage virtualization technology, we will need to take a look at hypervisors.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">A key feature offered or facilitated by virtualization is the isolation of guest operating systems, which provides security and stability to the infrastructure. <em class="italic">Virtual machine isolation</em> can be configured as needed; we will take a closer look at guest isolation and virtual networking when we set up our virtual machines.</p>
			<h2 id="_idParaDest-34"><a id="_idTextAnchor034"/>Hypervisors</h2>
			<p>A <strong class="bold">hypervisor</strong> is a computer <a id="_idIndexMarker090"/>program that is responsible for <a id="_idIndexMarker091"/>creating, running, and managing virtual machines. It is responsible for facilitating the virtualization process and setting up the emulated environment required to run an operating system.</p>
			<p>Hypervisors are split into two main categories based on their deployment and use case:</p>
			<ul>
				<li><strong class="bold">Type 1 hypervisors</strong>: These hypervisors <a id="_idIndexMarker092"/>are installed directly on top of hardware and, typically, run as operating systems. These types of hypervisors <a id="_idIndexMarker093"/>are also known as <strong class="bold">bare-metal hypervisors</strong>. Some examples of type 1 hypervisors include the following:<p>a) VMware ESX</p><p>b) Microsoft Hyper-V Server</p><p>c) Proxmox-VE</p><p><em class="italic">Figure 2.3</em> illustrates the deployment structure of a type 1 hypervisor, where the hypervisor management system is installed directly onto hardware and acts as the main operating system that creates and manages the virtual machines:</p></li>
			</ul>
			<div>
				<div id="_idContainer017" class="IMG---Figure">
					<img src="Images/B17389_02_003.jpg" alt="Figure 2.3 – The Type 1 hypervisor structure&#13;&#10;" width="431" height="461"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.3 – The Type 1 hypervisor structure</p>
			<ul>
				<li><strong class="bold">Type 2 hypervisors</strong>: These hypervisors <a id="_idIndexMarker094"/>are installed directly on top of a host operating system such as Windows, Linux, or macOS. They operate like traditional programs as opposed to being run directly on top of the hardware. <p>Type 2 hypervisors do not have direct access to the system hardware; instead, type 2 hypervisors utilize the system resources that are available to the host operating system. <em class="italic">Figure 2.2</em> illustrates a typical type 2 hypervisor setup where the hypervisor is installed directly on <a id="_idIndexMarker095"/>top of the host operating system. Some examples of free and commercial type 2 hypervisors are listed as follows:</p><p>a) Oracle VirtualBox (free)</p><p>b) VMware Player (free)</p><p>c) VMware Workstation Pro (commercial)</p><p>d) Parallels Desktop for macOS (commercial)</p></li>
			</ul>
			<h3>What is a virtual machine?</h3>
			<p>A virtual machine is an <a id="_idIndexMarker096"/>emulated operating system that runs directly on top of another operating system. Virtual machines have access to and can be allotted resources based on user requirements. For instance, we can specify the amount of RAM, the number of cores and logical processors, and the network interfaces and USB devices that the virtual machine will have access to. By default, virtual machines utilize a <em class="italic">virtual disk image</em> for storage <a id="_idIndexMarker097"/>and can be extended if required. Hypervisors such as VirtualBox also give us the ability to take snapshots of virtual machines as a form of redundancy. This can be extremely helpful in situations where virtual machines fail due to misconfigurations or system errors; you can easily restore a virtual machine to a previous snapshot.</p>
			<h3>What type of hypervisor should you use?</h3>
			<p>As mentioned earlier, the <a id="_idIndexMarker098"/>type of hypervisor you decide to use will depend on the nature of your deployment and individual use cases. If you have more than one computer or laptop, you can try out a type 1 hypervisor such as Proxmox-VE, which I personally use given the extended functionality it offers. If you intend on running your virtual hacking lab on a single computer or laptop, the obvious choice would be a type 2 hypervisor, as it can be installed directly onto the host operating system.</p>
			<p>Now that we have a better understanding of what virtualization is and how we can leverage the technology to set <a id="_idIndexMarker099"/>up our virtual hacking lab, we can take a look at how to structure our lab.</p>
			<h2 id="_idParaDest-35"><a id="_idTextAnchor035"/>Lab structure</h2>
			<p>Before we begin building our virtual lab, we need to understand how it will be structured, what <a id="_idIndexMarker100"/>software and operating systems we will use, and the network configuration we will implement. This will make the deployment phase much simpler and more straightforward.</p>
			<p>The first step is to select our preferred hypervisor. In this book, we will be using <strong class="bold">Oracle VirtualBox</strong>, which <a id="_idIndexMarker101"/>is a type 2 hypervisor that is free and open source. It also offers great functionality out of the box. We will look at how to install and configure VirtualBox in the next section.</p>
			<h3>Operating systems</h3>
			<p>We will be deploying a <a id="_idIndexMarker102"/>robust variety of both Windows and Linux operating systems. This will give you the ability to simulate <em class="italic">real-world attacks</em> on different types of operating systems as opposed to a single target. You are also likely to encounter different operating systems during a typical penetration test. We will be using the following operating systems in our virtual hacking lab:</p>
			<ul>
				<li><strong class="bold">Windows 7</strong></li>
				<li><strong class="bold">Windows Server 2008</strong></li>
				<li><strong class="bold">Windows Server 2012</strong></li>
				<li><strong class="bold">Windows 10</strong></li>
				<li><strong class="bold">Metasploitable2</strong></li>
				<li><strong class="bold">Kali Linux</strong></li>
			</ul>
			<p>We will be utilizing Kali Linux as our offensive operating system, and the other operating systems will be used as targets.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">The Windows Server 2012 target virtual machine is optional. Most of the techniques and attacks demonstrated in this book can be replicated on Windows Server 2008.</p>
			<p>Now that we have an <a id="_idIndexMarker103"/>idea of what hypervisor and operating systems we will be utilizing, we can set up our desired virtual network structure.</p>
			<h3>The virtual network topology</h3>
			<p><em class="italic">Figure 2.4</em> outlines the <a id="_idIndexMarker104"/>desired network <strong class="bold">topology</strong> that we will be <a id="_idIndexMarker105"/>using to set up our virtual network within VirtualBox. All virtual machines will be interconnected and isolated from any other external networks:</p>
			<div>
				<div id="_idContainer018" class="IMG---Figure">
					<img src="Images/B17389_02_004.jpg" alt="Figure 2.4 – The virtual network topology&#13;&#10;" width="535" height="382"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.4 – The virtual network topology</p>
			<p>VirtualBox allows us to create a completely isolated virtual network without the need for a router or switch. Each virtual machine will need to be assigned an IP address. We will be using the built-in virtual switch <a id="_idIndexMarker106"/>within VirtualBox to set up a <strong class="bold">Dynamic Host Configuration Protocol</strong> (<strong class="bold">DHCP</strong>)-based network where IP addresses will be distributed to the virtual machines automatically. This will simulate a real network environment; we will then have to perform some basic host discovery to manually map out the network and the hosts.</p>
			<p>We now have a good <a id="_idIndexMarker107"/>understanding of the software that we will be using and the desired structure and network topology of our lab. The next step is to put all of these pieces together.</p>
			<h1 id="_idParaDest-36"><a id="_idTextAnchor036"/>Building our lab</h1>
			<p>We are now ready to begin putting the various pieces together to build our virtual hacking lab. We will start <a id="_idIndexMarker108"/>by setting up our hypervisor of choice, VirtualBox. Feel free to use any other preferred hypervisor if you are already familiar with one. Most of these steps can also be recreated on <em class="italic">VMware Worksta<a id="_idTextAnchor037"/>tion</em> and <em class="italic">VMware Player</em>.</p>
			<h2 id="_idParaDest-37"><a id="_idTextAnchor038"/>Installing and configuring VirtualBox</h2>
			<p>VirtualBox <a id="_idIndexMarker109"/>is a cross-platform open source type 2 hypervisor <a id="_idIndexMarker110"/>that offers excellent <a id="_idIndexMarker111"/>functionality and performance. The first step is to download the correct installation <em class="italic">binary </em>based on the host operating system you are running:</p>
			<ol>
				<li>Open <a href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a> in your browser. You will be greeted with download links for the supported operating systems, as shown in <em class="italic">Figure 2.5</em>. Select your host operating system to begin the download:<div id="_idContainer019" class="IMG---Figure"><img src="Images/B17389_02_005.jpg" alt="Figure 2.5 – Downloading VirtualBox" width="783" height="608"/></div><p class="figure-caption">Figure 2.5 – Downloading VirtualBox</p></li>
				<li>After the <a id="_idIndexMarker112"/>installation binary has been downloaded, you will need to <a id="_idIndexMarker113"/>install it. The binary or executable will present you with a standard installation wizard. Follow the installation steps while keeping all the settings and configurations at their default settings. Once completed, you can now open up VirtualBox, and you will be greeted with a window similar to the one shown in <em class="italic">Figure 2.6</em>:</li>
			</ol>
			<div>
				<div id="_idContainer020" class="IMG---Figure">
					<img src="Images/B17389_02_006.jpg" alt="Figure 2.6 – The VirtualBox welcome screen" width="799" height="307"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.6 – The VirtualBox welcome screen</p>
			<p>We now have VirtualBox installed and we can begin setting up and configuring the virtual network.</p>
			<h2 id="_idParaDest-38"><a id="_idTextAnchor039"/>Configuring a virtual network</h2>
			<p>We will be using <a id="_idIndexMarker114"/>the network topology, as outlined in <em class="italic">Figure 2.4</em>, as our guide to set up and configure our virtual network adapter within VirtualBox. </p>
			<p>VirtualBox provides a simple, yet powerful, virtual network manager that can facilitate the creation of adapters and network configurations with customizable parameters and functionality.</p>
			<p>Our virtual network will require the following options and parameters:</p>
			<ul>
				<li>IPv4 address mask: <strong class="source-inline">10.10.10.1/24</strong></li>
				<li>A DHCP server enabled</li>
			</ul>
			<p>Now that we have an understanding of the IP address mask, we can configure our virtual network:</p>
			<ol>
				<li value="1">To open up the <strong class="bold">Network</strong> manager, click on the menu in the upper-right corner of the <strong class="bold">Tools </strong>ribbon:<div id="_idContainer021" class="IMG---Figure"><img src="Images/B17389_02_007.jpg" alt="Figure 2.7 – VirtualBox Network tools" width="635" height="248"/></div><p class="figure-caption">Figure 2.7 – VirtualBox Network tools</p><p>You will be greeted with a new window similar to <em class="italic">Figure 2.8</em>, prompting you to either <strong class="bold">Create</strong> or <strong class="bold">Remove</strong> the virtual network adapters.</p></li>
				<li>In our case, we will <a id="_idIndexMarker115"/>create our own virtual network adapter that will be used to interconnect all our virtual machines under the same IP address mask. Click on the <strong class="bold">Create</strong> button to begin the configuration process:<div id="_idContainer022" class="IMG---Figure"><img src="Images/B17389_02_008.jpg" alt="Figure 2.8 – Creating a VirtualBox adapter" width="357" height="102"/></div><p class="figure-caption">Figure 2.8 – Creating a VirtualBox adapter</p></li>
				<li>You should now be greeted with the virtual network manager screen. Based on our network requirements, as described earlier, we will need to set up a specific IP address mask and enable DHCP for automatic IP assignment. To configure our IP address mask, select the virtual network adapter we created and click on the <strong class="bold">Properties</strong> button to begin the customization process:<div id="_idContainer023" class="IMG---Figure"><img src="Images/B17389_02_009.jpg" alt="Figure 2.9 – Configuring a virtual network adapter&#13;&#10;" width="503" height="369"/></div><p class="figure-caption">Figure 2.9 – Configuring a virtual network adapter</p></li>
				<li>Within the configuration options for the adapter, ensure that you check the <strong class="bold">Configure Adapter Manually</strong> option, as <a id="_idIndexMarker116"/>demonstrated in <em class="italic">Figure 2.9</em>. Add the IP address mask we specified earlier. Once done, click on the <strong class="bold">Apply</strong> button to save the configuration.<p>We now need to enable the DHCP server. This can be enabled and configured under the <strong class="bold">DHCP Server</strong> tab in the <strong class="bold">Adapter Configuration</strong> menu. After enabling DHCP, you will need to provide the addressing schema and the default gateway address. You can use the configuration outlined in <em class="italic">Figure 2.10</em>:</p><div id="_idContainer024" class="IMG---Figure"><img src="Images/B17389_02_010.jpg" alt="Figure 2.10 – The VirtualBox DHCP configuration&#13;&#10;" width="503" height="368"/></div><p class="figure-caption">Figure 2.10 – The VirtualBox DHCP configuration</p></li>
				<li>After modifying the IP <a id="_idIndexMarker117"/>addressing schema for the DHCP server, click on <strong class="bold">Apply</strong> to save the configuration.</li>
			</ol>
			<p>Now that we have created and configured our virtual network within VirtualBox, we can begin setting up our virtual machines within VirtualBox and adding them to the virtual network we have created.</p>
			<h2 id="_idParaDest-39"><a id="_idTextAnchor040"/>Setting up our target virtual machines</h2>
			<p>We now have a <a id="_idIndexMarker118"/>fully configured hypervisor and virtual network in which we can operate; however, we also need to set up our <strong class="bold">target virtual machines</strong>, which will comprise two of the most popular operating systems used and adopted worldwide: Windows and Linux. Having practical experience in exploiting both operating systems is vital for a penetration tester, as you are likely to encounter both operating systems in real-world scenarios, although under different deployments and use cases. </p>
			<p>As outlined earlier, our target virtual machines will comprise a robust mix of different versions of Windows and Linux, and some of them will have been preconfigured with vulnerabilities to aid and enhance the learning process.</p>
			<h3>Setting up Windows virtual machines</h3>
			<p>Given the popularity and <a id="_idIndexMarker119"/>adoption of the Windows operating system, it is essential to understand how to perform privilege escalation attacks on both <em class="italic">Desktop</em> versions of Windows and <em class="italic">Windows Server deployments</em>. For this reason, our lab will consist of the following versions of Windows:</p>
			<ul>
				<li>Windows 10</li>
				<li>Windows 7</li>
				<li>Windows Server 2008</li>
			</ul>
			<p>Windows operating systems require a license and need to be activated in order to function. However, we can leverage the benefits offered by <em class="italic">Microsoft TechNet Evaluation Center</em>. This offers between 90-day and 180-day trials for both desktop and server operating systems.</p>
			<p>However, this service only offers the latest versions of Windows from Windows 10 and Windows Server 2016 to Windows Server 2012 and Windows 8.1. For our Windows 7 virtual machine, we <a id="_idIndexMarker120"/>can leverage the <strong class="bold">Microsoft Edge Legacy</strong> virtual machines that use older versions of Windows.</p>
			<p>I will not be covering the Windows installation process. In this book, I will demonstrate the process of configuring and adding our virtual machines to the virtual network we  have created.</p>
			<p>We will start by downloading and configuring our required Windows virtual machines in the next sections.</p>
			<h4>Setting up the Windows 7 virtual machine</h4>
			<p>We will now take a <a id="_idIndexMarker121"/>look at how to set up our Windows 7 virtual machine on VirtualBox.</p>
			<p>To set up the Windows 7 virtual machine, follow these steps:</p>
			<ol>
				<li value="1">First, you will need to download the Windows 7 virtual machine <strong class="bold">OVA</strong> file, which can be <a id="_idIndexMarker122"/>downloaded at <a href="https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/">https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/</a>.</li>
				<li>On the website, you will be prompted to select your virtual machine version and virtual machine platform, as illustrated in <em class="italic">Figure 2.11</em>. Ensure that you specify <strong class="bold">Win7</strong> as the version and <strong class="bold">VirtualBox</strong> as the platform:<div id="_idContainer025" class="IMG---Figure"><img src="Images/B17389_02_011.jpg" alt="Figure 2.11 – Downloading the Windows 7 virtual machine image&#13;&#10;" width="737" height="452"/></div><p class="figure-caption">Figure 2.11 – Downloading the Windows 7 virtual machine image</p></li>
				<li>You can now <a id="_idIndexMarker123"/>click on the <strong class="bold">Download</strong> button to download the compressed VirtualBox OVA file.</li>
				<li>After you have downloaded and extracted the archive, you will be presented with an OVA file. The OVA file is a preconfigured and preinstalled virtual machine that does not need to be installed or configured; therefore, this will save time. The OVA file can be imported by double-clicking on it. This will open an <strong class="bold">Import Virtual Appliance</strong> screen, as shown here:<div id="_idContainer026" class="IMG---Figure"><img src="Images/B17389_02_012.jpg" alt="Figure 2.12 – VirtualBox OVA import" width="701" height="518"/></div><p class="figure-caption">Figure 2.12 – VirtualBox OVA import</p></li>
				<li>Ensure that you <a id="_idIndexMarker124"/>specify the <strong class="bold">Machine Base Folder</strong> to a directory or location that you have set up and configured for your virtual machines; this is the directory where the virtual machine will be imported to. After specifying the base folder, you can click on <strong class="bold">Import</strong> to begin the import process, as illustrated in <em class="italic">Figure 2.13</em>:<div id="_idContainer027" class="IMG---Figure"><img src="Images/B17389_02_013.jpg" alt="Figure 2.13 – The VirtualBox OVA import process" width="407" height="134"/></div><p class="figure-caption">Figure 2.13 – The VirtualBox OVA import process</p></li>
				<li>After the importation process has been completed, we can now add the virtual machine to the virtual network we have set up. To do this, select the virtual machine, as shown in the left-hand bar in <em class="italic">Figure 2.14</em>, and click on the <strong class="bold">Settings</strong> button to modify the virtual machine settings:<div id="_idContainer028" class="IMG---Figure"><img src="Images/B17389_02_014.jpg" alt="Figure 2.14 – The virtual machine settings" width="648" height="159"/></div><p class="figure-caption">Figure 2.14 – The virtual machine settings</p></li>
				<li>This will bring up the <strong class="bold">Options</strong> menu, where <a id="_idIndexMarker125"/>you can change the virtual machine name and resource allocation; however, we are also interested in adding the virtual machine to the virtual network. This can be done by clicking on the <strong class="bold">Network</strong> option, as shown in <em class="italic">Figure 2.15</em>, and specifying the adapter (in this case, <strong class="bold">Adapter 1</strong> on the screen) as <strong class="bold">Host-only Adapter</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer029" class="IMG---Figure">
					<img src="Images/B17389_02_015.jpg" alt="Figure 2.15 – Virtual machine network configuration&#13;&#10;" width="636" height="228"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.15 – Virtual machine network configuration</p>
			<p>The virtual machine should now be configured to run and operate in the virtual network we have created. We can now move on to set up our Windows Server 2008 virtual machine also <a id="_idIndexMarker126"/>known as <strong class="bold">Metasploitable3</strong>.</p>
			<h4>Setting up the Metasploitable3 virtual machine</h4>
			<p>For our <a id="_idIndexMarker127"/>Windows Server 2008 virtual machine, we will be using an intentionally vulnerable virtual machine based on Windows Server 2008, called Metasploitable3. It was designed and created by <em class="italic">Rapid7</em> to teach and demonstrate various penetration testing and privilege escalation techniques.</p>
			<p>To learn more about Metasploitable3, you can read up on the release notes at <a href="https://blog.rapid7.com/2016/11/15/test-your-might-with-the-shiny-new-metasploitable3/">https://blog.rapid7.com/2016/11/15/test-your-might-with-the-shiny-new-metasploitable3/</a>.</p>
			<p>Setting up Metasploitable3 involves a manual building process; however, prebuilt virtual machine files also exist, which we <a id="_idIndexMarker128"/>can use to set up our virtual machine without any hassle or installation:</p>
			<ol>
				<li value="1">To get started with the setup process, we first need to download the OVA file.<p>The prebuilt <strong class="bold">Metasploitable3 Box</strong> file can be <a id="_idIndexMarker129"/>downloaded at <a href="https://app.vagrantup.com/rapid7/boxes/metasploitable3-win2k8">https://app.vagrantup.com/rapid7/boxes/metasploitable3-win2k8</a>.</p></li>
				<li>After downloading the virtual machine file, the importation process is similar to that of Windows 7. Simply double-click on the <strong class="bold">OVA</strong> file and it will bring up the virtual machine import screen, as follows:<div id="_idContainer030" class="IMG---Figure"><img src="Images/B17389_02_016.jpg" alt="Figure 2.16 – Importing Metasploitable3&#13;&#10;" width="638" height="490"/></div><p class="figure-caption">Figure 2.16 – Importing Metasploitable3</p></li>
				<li>Specify your <strong class="bold">Base Directory</strong> virtual <a id="_idIndexMarker130"/>machine and begin the import process, as follows:<div id="_idContainer031" class="IMG---Figure"><img src="Images/B17389_02_017.jpg" alt="Figure 2.17 – Importing Metasploitable3" width="438" height="130"/></div><p class="figure-caption">Figure 2.17 – Importing Metasploitable3</p></li>
				<li>After the virtual machine has been imported, we can modify the virtual machine settings to configure Metasploitable3 to use the virtual network, as follows:</li>
			</ol>
			<div>
				<div id="_idContainer032" class="IMG---Figure">
					<img src="Images/B17389_02_018.jpg" alt="Figure 2.18 – Metasploitable3 network settings" width="640" height="230"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.18 – Metasploitable3 network settings</p>
			<h4>Setting up the Windows 10 virtual machine</h4>
			<p>You will need to <a id="_idIndexMarker131"/>manually install the Windows 10 virtual machine, given that no prebuilt virtual machine files are offered by Microsoft. If you have no experience of installing Windows manually from an <em class="italic">ISO</em> file or a <em class="italic">disc image</em>, use the installation guide at <a href="https://www.extremetech.com/computing/198427-how-to-install-windows-10-in-a-virtual-machine">https://www.extremetech.com/computing/198427-how-to-install-windows-10-in-a-virtual-machine</a>:</p>
			<ol>
				<li value="1">To download the Windows 10 ISO, you will need to navigate to the following URL: <a href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise">https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise</a>. This will prompt you to specify the version of Windows 10 you would like to download. Go ahead and specify <strong class="bold">Windows 10 Enterprise</strong> and click on <strong class="bold">Continue</strong>. Afterward, you will need to provide your personal information to access the download:<div id="_idContainer033" class="IMG---Figure"><img src="Images/B17389_02_019.jpg" alt="Figure 2.19 – Downloading Windows 10 ISO&#13;&#10;" width="516" height="342"/></div><p class="figure-caption">Figure 2.19 – Downloading Windows 10 ISO</p></li>
				<li>After downloading <a id="_idIndexMarker132"/>the ISO, you can create the virtual machine in VirtualBox and install Windows manually.</li>
				<li>After successfully installing Windows 10, you can now modify the <strong class="bold">Network</strong> settings to configure the virtual machine to use the virtual network we have created, as shown <a id="_idTextAnchor041"/>in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer034" class="IMG---Figure">
					<img src="Images/B17389_02_020.jpg" alt="Figure 2.20 – Windows network settings&#13;&#10;" width="636" height="229"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.20 – Windows network settings</p>
			<p>We have now successfully set up our Windows virtual machines and configured them to use our <a id="_idIndexMarker133"/>customized virtual network. Let's now take a look at how to set up our Linux virtual machine.</p>
			<h3>Setting up Linux virtual machines</h3>
			<p>Typically, Linux is set up <a id="_idIndexMarker134"/>and configured to run as a server, primarily for the hosting of services such as web applications, mail gateways, and database servers. This vastly increases the threat surface and the number of attack vectors that an attacker can exploit in order to gain initial access into a Linux system; for example, a vulnerability in the web server can lead to total system compromise.</p>
			<p>For this reason, we will be using an intentionally vulnerable Linux virtual machine called <strong class="bold">Metasploitable2</strong>, which is <a id="_idIndexMarker135"/>also created by <em class="italic">Rapid7</em> with the aim of teaching and demonstrating Linux exploitation and privilege escalation techniques.</p>
			<h4>Setting up Metasploitable2</h4>
			<p>Metasploitable2 is a free <a id="_idIndexMarker136"/>and intentionally vulnerable Ubuntu virtual machine that can be set up and deployed on any type 2 hypervisor. Let's take a look at how to set it up:</p>
			<ol>
				<li value="1">Metasploitable2 can be downloaded at <a href="https://sourceforge.net/projects/metasploitable/files/Metasploitable2/">https://sourceforge.net/projects/metasploitable/files/Metasploitable2/</a>.</li>
				<li>This URL will direct you to <strong class="bold">SourceForge</strong>, where you will be prompted to download the Metasploitable2 compressed archive, as follows:<div id="_idContainer035" class="IMG---Figure"><img src="Images/B17389_02_021.jpg" alt="Figure 2.21 – The Metasploitable2 archive&#13;&#10;" width="841" height="248"/></div><p class="figure-caption">Figure 2.21 – The Metasploitable2 archive</p></li>
				<li>After downloading and extracting the archive, we are presented with a <strong class="source-inline">VMDK</strong> (<strong class="bold">Virtual Machine Disk</strong>) file that <a id="_idIndexMarker137"/>we will use to set up the virtual machine, which you can see in the list here:<div id="_idContainer036" class="IMG---Figure"><img src="Images/B17389_02_022.jpg" alt="Figure 2.22 – The Metasploitable2 archive&#13;&#10;" width="628" height="142"/></div><p class="figure-caption">Figure 2.22 – The Metasploitable2 archive</p></li>
				<li>To set up Metasploitable2, we <a id="_idIndexMarker138"/>will need to create a new virtual machine. Click on the <strong class="bold">New</strong> button in VirtualBox, as shown in the following screenshot:<div id="_idContainer037" class="IMG---Figure"><img src="Images/B17389_02_023.jpg" alt="Figure 2.23 – The New VirtualBox virtual machine" width="509" height="104"/></div><p class="figure-caption">Figure 2.23 – The New VirtualBox virtual machine</p></li>
				<li>We will now need to specify the virtual machine <strong class="bold">Name</strong> and the base directory under which the virtual machine will be installed. This is illustrated in <em class="italic">Figure 2.24</em>:<div id="_idContainer038" class="IMG---Figure"><img src="Images/B17389_02_024.jpg" alt="Figure 2.24 – Metasploitable2 configuration" width="414" height="271"/></div><p class="figure-caption">Figure 2.24 – Metasploitable2 configuration</p></li>
				<li>We will now be <a id="_idIndexMarker139"/>prompted to specify the amount of RAM we wish to allocate to the virtual machine under the <strong class="bold">Memory Size</strong> option, as shown in <em class="italic">Figure 2.25</em>. Leave the option at the pre-configured amount, which should be <strong class="source-inline">512 MB</strong>:<div id="_idContainer039" class="IMG---Figure"><img src="Images/B17389_02_025.jpg" alt="Figure 2.25 – Metasploitable2 Memory size setting" width="406" height="172"/></div><p class="figure-caption">Figure 2.25 – Metasploitable2 Memory size setting</p></li>
				<li>After specifying the desired memory, you will be prompted to specify whether you would like to create a <strong class="bold">virtual hard disk</strong> or use an existing one. Select the option to use your own virtual hard disk and specify the directory of the <strong class="source-inline">Metasploitable2.vmdk</strong> file that you have downloaded, as shown here:<div id="_idContainer040" class="IMG---Figure"><img src="Images/B17389_02_026.jpg" alt="Figure 2.26 – The Metasploitable2 VMDK specification" width="402" height="306"/></div><p class="figure-caption">Figure 2.26 – The Metasploitable2 VMDK specification</p></li>
				<li>After creating <a id="_idIndexMarker140"/>the Metasploitable2 virtual machine, you now need to configure the virtual machine to use the custom virtual network. This can be done by modifying the <strong class="bold">Settings</strong> of the virtual machine and modifying the <strong class="bold">Network Adapter</strong>, as follows:</li>
			</ol>
			<div>
				<div id="_idContainer041" class="IMG---Figure">
					<img src="Images/B17389_02_027.jpg" alt="Figure 2.27 – The Metasploitable2 Network configuration" width="638" height="231"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.27 – The Metasploitable2 Network configuration</p>
			<p>In this section, we have learned how to set up both Windows and Linux virtual machines and how to configure a customized isolated virtual network for our virtual hacking lab.</p>
			<p>We have now set up all our target virtual machines and have configured them to run in the same virtual network. Our final virtual machine to set up is our <em class="italic">main attacker</em> virtual machine.</p>
			<h1 id="_idParaDest-40"><a id="_idTextAnchor042"/>Setting up Kali Linux</h1>
			<p><strong class="bold">Kali Linux</strong> is a <em class="italic">Debian</em>-based Linux <a id="_idIndexMarker141"/>distribution that is tailored toward penetration testers and security researchers. It is preconfigured and prepackaged with over 300 tools that can be used for penetration tests, security audits, and forensics. It is arguably the de facto standard for all industry professionals, as it offers a solid base to work from, various deployment and installation options, and an excellent software repository.</p>
			<p>Kali Linux can be downloaded from the official <a id="_idIndexMarker142"/>Kali website (<a href="https://kali.org">https://kali.org</a>) and can be installed and configured in a plethora of ways. You can directly install it from an ISO or use a pre-configured OVA file for a preinstalled solution. In our case, as with the Windows 7 virtual machine, we will be using the OVA file, as it saves time and is much more convenient.</p>
			<p>To begin, take the following steps:</p>
			<ol>
				<li value="1">To download the Kali Linux virtual appliance, navigate to the following link and download the <strong class="bold">32-bit</strong> or <strong class="bold">64-bit</strong> <strong class="bold">Kali Linux VirtualBox</strong> image based on your preferred system architecture (https://www.offensive-security.com/kali-linux-vm-vmware-virtualbox-image-download/#1572305786534-030ce714-cc3b):<div id="_idContainer042" class="IMG---Figure"><img src="Images/B17389_02_028.jpg" alt="Figure 2.28 – Kali Linux VirtualBox Images&#13;&#10;" width="1085" height="339"/></div><p class="figure-caption">Figure 2.28 – Kali Linux VirtualBox Images</p></li>
				<li>After downloading and extracting the Kali Linux archive, the contents of the extracted directory will contain a Kali Linux OVA file that can be directly imported into VirtualBox. We can do this by double-clicking on the <strong class="bold">OVA image</strong>.</li>
				<li>This will bring up the VirtualBox <strong class="bold">Import virtual appliance wizard</strong>, where we will need to specify the base directory under which our virtual machine will be stored.</li>
				<li>The importing <a id="_idIndexMarker143"/>process will begin and will take a few minutes to complete:<div id="_idContainer043" class="IMG---Figure"><img src="Images/B17389_02_029.jpg" alt="Figure 2.29 – Importing Kali Linux OVA" width="525" height="133"/></div><p class="figure-caption">Figure 2.29 – Importing Kali Linux OVA</p></li>
				<li>After the import is complete, we will need to configure the Kali virtual machine to use the custom network we created. This can be done by modifying the settings of the virtual machine, as follows:</li>
			</ol>
			<div>
				<div id="_idContainer044" class="IMG---Figure">
					<img src="Images/B17389_02_030.jpg" alt="Figure 2.30 – Kali Linux network settings&#13;&#10;" width="639" height="229"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.30 – Kali Linux network settings</p>
			<p>We have now been able to set up our virtual hacking lab comprehensively, and we can move on to the testing phase. It involves starting up all of the virtual machines and performing a host discovery <a id="_idIndexMarker144"/>scan from Kali Linux to test the efficacy and functionality of our virtual network configuration.</p>
			<h2 id="_idParaDest-41"><a id="_idTextAnchor043"/>Putting it all together</h2>
			<p>We can begin the test by starting up <a id="_idIndexMarker145"/>our virtual machines individually and running the following tests:</p>
			<ol>
				<li value="1">To log in to the Kali Linux virtual machine, use the credentials for the <strong class="source-inline">root</strong> user. The username will be root and the password will be <strong class="source-inline">toor</strong>. This can be changed by running the <strong class="source-inline">passwd</strong> utility in the Terminal, as follows:<div id="_idContainer045" class="IMG---Figure"><img src="Images/B17389_02_031.jpg" alt="Figure 2.31 – The Kali Linux password change functionality" width="440" height="169"/></div><p class="figure-caption">Figure 2.31 – The Kali Linux password change functionality</p></li>
				<li>After you have started your virtual machines, you can perform a network discovery scan with a utility called <strong class="source-inline">netdiscover</strong>, which uses <strong class="bold">Address Resolution Protocol</strong> (<strong class="bold">ARP</strong>) pings to <a id="_idIndexMarker146"/>detect hosts on a network. To run a network discovery scan, run the following command in your Kali Linux Terminal:<p class="source-code"><strong class="bold">$ netdiscover -i &lt;interface&gt; -r 10.10.10.1/24</strong></p></li>
				<li>After running the <strong class="source-inline">netdiscover</strong> command, we will discover two hosts that are online and active as illustrated in <em class="italic">Figure 2.32</em>. This demonstrates our network configuration is working and that we can communicate with other hosts on the network:</li>
			</ol>
			<div>
				<div id="_idContainer046" class="IMG---Figure">
					<img src="Images/B17389_02_032.jpg" alt="Figure 2.32 – The results of netdiscover&#13;&#10;" width="748" height="210"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.32 – The results of netdiscover</p>
			<p>We have now set up our Kali Linux <a id="_idIndexMarker147"/>virtual machine and configured it to run in the same virtual network and have tested our virtual network by performing a host discovery scan.</p>
			<h1 id="_idParaDest-42"><a id="_idTextAnchor044"/>Summary</h1>
			<p>In this chapter, we began by understanding how to structure a virtual hacking lab and the role of virtualization. We then looked at how to set up and configure our hypervisor and a custom isolated network that could be used to interconnect our virtual machines. Later in the chapter, we set up our target virtual machines on VirtualBox and configured them to use our custom virtual network. We then ended the chapter by deploying Kali Linux in our virtual hacking lab.</p>
			<p>Now that we have a functional virtual hacking lab, we can move on to the initial exploitation progress.</p>
			<p>In the next chapter, we will begin the privilege escalation process by gaining our initial foothold on our target virtual machines. We will take a look at the various attack vectors that can be leveraged to give us access to the systems.</p>
		</div>
	</div></body></html>