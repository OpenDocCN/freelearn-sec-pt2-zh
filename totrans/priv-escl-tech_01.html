<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer078">
			<h1 id="_idParaDest-43"><em class="italic"><a id="_idTextAnchor045"/>Chapter 3</em>: Gaining Access (Exploitation)</h1>
			<p>Before we can get our hands dirty with privilege escalation on both Windows and Linux, we need to explore the process of <strong class="bold">exploitation</strong> and the various <em class="italic">exploitation techniques</em> that can be leveraged, including how these techniques will affect the privilege escalation process. </p>
			<p>Exploitation is a unique phase of the <strong class="bold">penetration testing life cycle</strong>. This is because it involves actively engaging with the target to determine or discover flaws or vulnerabilities that can be exploited in order to gain access. </p>
			<p>Exploitation sets the scene for a successful penetration test and validates how far you will be able to get on a target system or network. Choosing the correct <em class="italic">attack vector</em> and <em class="italic">exploitation framework</em> or exploit is critical for gaining and maintaining access to a target system. </p>
			<p>In this chapter, you will learn about the various ways of exploiting both Windows and Linux systems and how to leverage exploitation frameworks such as <strong class="bold">Metasploit</strong>.</p>
			<p>In this chapter, we will cover the following topics:</p>
			<ul>
				<li>Setting up Metasploit</li>
				<li><a id="_idTextAnchor046"/>Information gathering and footprinting</li>
				<li>Gaining access</li>
			</ul>
			<h1 id="_idParaDest-44"><a id="_idTextAnchor047"/>Technical requirements </h1>
			<p>To follow along with the demonstrations in this chapter, you need to ensure that you meet the following technical requirements:</p>
			<ul>
				<li>A basic understanding of the <em class="italic">Linux Terminal commands</em></li>
				<li>Some familiarity with information gathering and <em class="italic">footprinting</em> techniques</li>
			</ul>
			<p>You can view this chapter's code in action here: <a href="https://bit.ly/3m5qIaI">https://bit.ly/3m5qIaI</a></p>
			<h1 id="_idParaDest-45"><a id="_idTextAnchor048"/>Setting up Metasploit</h1>
			<p>The <strong class="bold">Metasploit framework</strong> is an open <a id="_idIndexMarker148"/>source exploitation framework developed by H.D. Moore. It<a id="_idIndexMarker149"/> was originally written in Perl and later rewritten in Ruby. It is the de facto exploitation framework adopted by security professionals worldwide. It was acquired by <em class="italic">Rapid7</em>, in 2009, and is actively maintained and supported.</p>
			<p>It was designed to streamline and enhance the penetration testing process. It does this by offering compartmentalized functionality in the form of modules based on various phases of the penetration testing methodology. </p>
			<p>Metasploit can be used in almost every stage of the penetration testing life cycle, from information gathering to exploitation and privilege escalation. This robust functionality is what makes Metasploit an essential framework to learn for any penetration tester.</p>
			<p>Metasploit has two<a id="_idIndexMarker150"/> versions available that offer varying functionality and features:</p>
			<ul>
				<li><strong class="bold">Metasploit Pro</strong></li>
				<li><strong class="bold">Metasploit Community</strong></li>
			</ul>
			<p>During the course of this book, we will be utilizing the Metasploit framework version of Metasploit.</p>
			<h2 id="_idParaDest-46"><a id="_idTextAnchor049"/>The Metasploit structure</h2>
			<p>Before we can<a id="_idIndexMarker151"/> begin setting up and using the Metasploit framework, first, we need to understand exactly how it is structured. <em class="italic">Figure 3.1</em> outlines the components that make up the Metasploit framework and provides a high-level overview of how these components interact with each other:</p>
			<div>
				<div id="_idContainer048" class="IMG---Figure">
					<img src="Images/B17389_03_001.jpg" alt="Figure 3.1 – The Metasploit architecture&#13;&#10;" width="651" height="477"/>
				</div>
			</div>
			<p class="figure-caption">Figure 3.1 – The Metasploit architecture</p>
			<p>Given the subject <a id="_idIndexMarker152"/>matter of this book, we will not be taking a detailed look at how each of these components works and what their purpose is. Instead, we will focus on the most important element of the Metasploit framework in relation to exploitation, that is, the <em class="italic">modules</em>.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">The Metasploit framework comes prepackaged. It is installed on <em class="italic">Kali Linux</em> and is also available in the official Kali repositories. As a result, we will not be discussing how to install Metasploit manually.</p>
			<p>The best way to understand how Metasploit modules are structured is to browse through the directory on Kali Linux. The default Metasploit framework directory is located under <strong class="source-inline">/usr/share/metasploit-framework</strong>, and you can list the contents of the directory by running the following command:</p>
			<p class="source-code">ls -al /usr/share/metasploit-framework</p>
			<p><em class="italic">Figure 3.2</em> outlines the contents of the default Metasploit framework directory on Kali Linux. As you can see, the directory contains binaries and directories based on their functionality. For example, we can see the <strong class="source-inline">msfdb</strong> binary that is responsible for interacting with the Metasploit framework database, and we can also see that the modules have <a id="_idIndexMarker153"/>been sorted into their own directory:</p>
			<div>
				<div id="_idContainer049" class="IMG---Figure">
					<img src="Images/B17389_03_002.jpg" alt="Figure 3.2 – Layout of the Metasploit directory &#13;&#10;" width="883" height="688"/>
				</div>
			</div>
			<p class="figure-caption">Figure 3.2 – Layout of the Metasploit directory </p>
			<p>In the next section, we will take a look at how modules are further organized based on their type.</p>
			<h3>The Metasploit modules</h3>
			<p>Given the <a id="_idIndexMarker154"/>compartmentalized nature of the framework, Metasploit utilizes modules to segregate functionality. It does this by categorizing modules based on their specific functionality in respect to the role they play in the penetration testing life cycle. You can access this by viewing the contents of the module's directory under <strong class="source-inline">/usr/share/metasploit/framework/modules</strong>, as shown in <em class="italic">Figure 3.3</em>:</p>
			<div>
				<div id="_idContainer050" class="IMG---Figure">
					<img src="Images/B17389_03_003.jpg" alt="Figure 3.3 – The Metasploit module directory&#13;&#10;" width="605" height="251"/>
				</div>
			</div>
			<p class="figure-caption">Figure 3.3 – The Metasploit module directory</p>
			<p>The modules and their functionality are sorted as follows:</p>
			<ul>
				<li><strong class="bold">Exploits</strong>: These are pieces of code whose function is to exploit/leverage particular vulnerabilities within a system or program. Metasploit sorts these exploits further based on the target operating system, architecture, and service version. </li>
				<li><strong class="bold">Payloads</strong>: These are pieces of code that are typically bundled with an exploit and are used to execute additional commands and instructions after successful exploitation. For example, most remote access exploits utilize payloads to spawn reverse shells that grant direct access to attackers.</li>
				<li><strong class="bold">Auxiliary modules</strong>: These<a id="_idIndexMarker155"/> modules are used to perform a specific function, typically involving information gathering, fuzzing, and scanning for vulnerabilities.</li>
				<li><strong class="bold">Encoders</strong>: Encoders are used to encode and obfuscate payloads in order to avoid antivirus and signature-based detection. Encoders are also used to generate various types of payloads for specific use cases.</li>
				<li><strong class="bold">Post-exploitation</strong>: Post-exploitation modules are used after a successful exploitation to further increase control over the target system. Typically, they are used to perform the following tasks:<p>a) Privilege escalation</p><p>b) Credential harvesting and dumping hashes</p><p>c) Capturing user input on the target system</p><p>d) Executing processes and binaries</p><p>e) Setting up persistence</p></li>
			</ul>
			<p>Now that we have familiarized ourselves with the various modules available in the Metasploit <a id="_idIndexMarker156"/>framework, we can begin setting up and configuring the Metasploit framework to use.</p>
			<h2 id="_idParaDest-47"><a id="_idTextAnchor050"/>Setting up the Metasploit framework</h2>
			<p>To begin using<a id="_idIndexMarker157"/> the Metasploit framework, we will need to<a id="_idIndexMarker158"/> create and initialize the <strong class="bold">Metasploit database</strong>. You will need to perform the following steps:</p>
			<ol>
				<li>Metasploit utilizes a <em class="italic">PostgreSQL</em> database backend for storage. First, we will need to ensure that the PostgreSQL service is running by inputting the following command:<p class="source-code"><strong class="bold">sudo systemctl start postgresql</strong></p></li>
				<li>We can now initialize the Metasploit database by running the following command with root privileges:<p class="source-code"><strong class="bold">sudo msfdb init</strong></p><p>The initialization process will create the <strong class="source-inline">msf</strong> database and add the <strong class="source-inline">msf_test</strong> role to the database configuration.</p></li>
				<li>We can now access <a id="_idIndexMarker159"/>the Metasploit framework console, which is also known as <strong class="bold">msfconsole</strong>. This can be done by running the following command in the Terminal:<p class="source-code"><strong class="bold">msfconsole</strong></p><p>As you can see, in <em class="italic">Figure 3.4</em>, starting <strong class="source-inline">msfconsole</strong> will take a few seconds:</p><div id="_idContainer051" class="IMG---Figure"><img src="Images/B17389_03_004.jpg" alt="Figure 3.4 – Staring msfconsole&#13;&#10;" width="593" height="55"/></div><p class="figure-caption">Figure 3.4 – Staring msfconsole</p></li>
				<li>After <strong class="source-inline">msfconsole</strong> has started up, you will be greeted with a banner and the <strong class="source-inline">msf</strong> prompt, as outlined in the following screenshot:<div id="_idContainer052" class="IMG---Figure"><img src="Images/B17389_03_005.jpg" alt="Figure 3.5 – The msfconsole banner&#13;&#10;" width="748" height="454"/></div><p class="figure-caption">Figure 3.5 – The msfconsole banner</p></li>
				<li>Before we can start using <strong class="source-inline">msfconsole</strong>, we need to verify that the Metasploit database is <a id="_idIndexMarker160"/>connected by running the following command within <strong class="source-inline">msfconsole</strong>:<p class="source-code"><strong class="bold">db_status</strong></p></li>
			</ol>
			<p>As you can see, in <em class="italic">Figure 3.6</em>, the output informs us that <strong class="source-inline">msfconsole</strong> is connected to the database:</p>
			<div>
				<div id="_idContainer053" class="IMG---Figure">
					<img src="Images/B17389_03_006.jpg" alt="Figure 3.6 – The database status of Metasploit " width="608" height="79"/>
				</div>
			</div>
			<p class="figure-caption">Figure 3.6 – The database status of Metasploit </p>
			<p>The Metasploit framework should now be fully functional and ready to use. We can now move on to the next phase, which involves performing footprinting and <em class="italic">active reconnaissance</em> on our target virtual machines.</p>
			<h1 id="_idParaDest-48"><a id="_idTextAnchor051"/>Information gathering and footprinting</h1>
			<p>Before we can<a id="_idIndexMarker161"/> exploit a target system, we need to accurately <a id="_idIndexMarker162"/>enumerate in order to retrieve important information from our targets. This phase of the penetration testing life cycle involves scanning and discovering hosts on a network. We scan these hosts to find the open <em class="italic">ports</em> and <em class="italic">services</em> that are running along with their versions. Additionally, we identify what operating systems the <em class="italic">targets</em> are running.</p>
			<p>This is one of the most important phases of a penetration test, as it will determine the overall success of the exploitation phase. If we can gather and enumerate enough information from our targets, we can set up effective attacks and exploits. However, if we don't do this, our exploitation methods will be inefficient and may not yield any results.</p>
			<p>We will begin the <strong class="bold">footprinting</strong> process by mapping out our virtual network to discover the target virtual machines and their corresponding IP addresses. </p>
			<h2 id="_idParaDest-49"><a id="_idTextAnchor052"/>Network mapping with Nmap</h2>
			<p><strong class="bold">Network Mapper</strong> (<strong class="bold">Nmap</strong>) is a <a id="_idIndexMarker163"/>free, open<a id="_idIndexMarker164"/> source network mapping utility that is used to discover hosts on a network, perform port scanning and service detection, and operate system detection. It does this by sending specially crafted packets to the targets and analyzing the responses that are sent from the target. Based on these responses, Nmap makes decisions as to whether a port is open, a target is online, or a firewall is in place.</p>
			<p>We will be using Nmap in conjunction with Metasploit, where we will import our Nmap scan results into the Metasploit framework database. Nmap can generate output in a wide variety of formats. In our case, we will be exporting our scan results in XML format so that we can import them into the Metasploit database.</p>
			<p>Ensure that you have the following target virtual machines running, as we will be utilizing them in this chapter:</p>
			<ul>
				<li><strong class="bold">Windows 7</strong></li>
				<li><strong class="bold">Metasploitable3</strong></li>
				<li><strong class="bold">Metasploitable2</strong></li>
			</ul>
			<p>Now that we have a<a id="_idIndexMarker165"/> clear picture of what hosts we will be targeting, we can begin the host<a id="_idIndexMarker166"/> discovery process with Nmap.</p>
			<h3>Host discovery with Nmap</h3>
			<p>The first <a id="_idIndexMarker167"/>step in footprinting is to discover <a id="_idIndexMarker168"/>the active hosts on a network and their corresponding IP addresses. Following this, we will scan these hosts individually to discover open ports, the services running, and the operating system that is being used:</p>
			<ol>
				<li value="1">We can perform a <em class="italic">ping sweep</em> scan on the entire virtual network subnet that we created in <a href="B17389_02_Final_PG_ePub.xhtml#_idTextAnchor030"><em class="italic">Chapter 2</em></a>, <em class="italic">Setting Up Our Lab</em>, by running the following command:<p class="source-code"><strong class="bold">sudo nmap -sn 10.10.10.1/24</strong></p><p>As you can see, in <em class="italic">Figure 3.7</em>, we have four active hosts on our network. However, we still do not know what operating systems these hosts are running, making it very difficult to identify what IP addresses correspond to our virtual machines:</p><div id="_idContainer054" class="IMG---Figure"><img src="Images/B17389_03_007.jpg" alt="Figure 3.7 – Host discovery with Nmap&#13;&#10;" width="783" height="600"/></div><p class="figure-caption">Figure 3.7 – Host discovery with Nmap</p><p>This Nmap scan will send <em class="italic">ping</em> requests to all hosts on the network and will determine whether a host is online based on the responses it receives.</p></li>
				<li>To determine the operating systems that the target virtual machines are running, we can run an aggressive scan on our virtual network subnet with Nmap. This can be done by running the following command:<p class="source-code"><strong class="bold">sudo nmap -A -T4 10.10.10.1/24</strong></p><p>This scan will reveal the target operating system, the services running, the service versions, and the open ports running on the target systems. For instance, you should be able to determine what operating system a host is running by analyzing the operating system scan discovery results. <em class="italic">Figure 3.8</em> outlines the <strong class="source-inline">OS discovery results</strong> for the virtual machine with an IP address of <strong class="source-inline">10.10.10.7</strong>. As you can see, the <strong class="source-inline">OS discovery results</strong> indicate that the host is running <strong class="source-inline">Windows Server 2008 SP1</strong>, which means it<a id="_idIndexMarker169"/> is the Metasploitable3<a id="_idIndexMarker170"/> virtual machine:</p><div id="_idContainer055" class="IMG---Figure"><img src="Images/B17389_03_008.jpg" alt="Figure 3.8 – OS discovery with Nmap&#13;&#10;" width="1152" height="592"/></div><p class="figure-caption">Figure 3.8 – OS discovery with Nmap</p><p class="callout-heading">Note</p><p class="callout">You can also scan for specific information such as the operating system and service information by using the <strong class="source-inline">-O</strong> flag and the <strong class="source-inline">-sV</strong> flag. </p><p>Given the <a id="_idIndexMarker171"/>infrastructure of our virtual network and the use of <strong class="bold">Dynamic Host Configuration Protocol</strong> (<strong class="bold">DHCP</strong>), your virtual machine IP addresses might be assigned differently in comparison to the scenario here. In this case, the IP addresses correspond to the following hosts:</p><p>a) Metasploitable3: <strong class="source-inline">10.10.10.4</strong></p><p>b) Metasploitable2: <strong class="source-inline">10.10.10.8</strong></p><p>c) Windows 7: <strong class="source-inline">10.10.10.7</strong></p><p>Now that we <a id="_idIndexMarker172"/>have mapped out<a id="_idIndexMarker173"/> the hosts on our network, we can perform our individual scans on all the hosts on the network to determine what services are running and what ports are open.</p></li>
				<li>To perform a comprehensive scan on a target, we will use a <em class="italic">half-open advanced scan</em> (<em class="italic">SYN scan</em>) in Nmap on all TCP ports. This will give us an accurate picture of what services and ports are open and are running on the target systems. We will also output the results into XML format for importation into <strong class="source-inline">msfconsole</strong>. This can be done by running the following Nmap scan:<p class="source-code"><strong class="bold">sudo nmap -sS -A -T4 -p- &lt;IP-ADDRESS&gt; -oX output_file.xml</strong></p><p class="callout-heading">Important note</p><p class="callout">You will need to run this scan for all target virtual machines on the virtual network to determine what ports are open and what services are running. We will use this information in the next section, which involves performing a vulnerability analysis to determine potential vulnerabilities that can be exploited.</p></li>
				<li>After running the scans, you should have your scan results saved in XML format. We can now begin importing the results into Metasploit. First, we need to start <strong class="source-inline">msfconsole</strong>.</li>
				<li>After starting <strong class="source-inline">msfconsole</strong>, we can import the Nmap XML results by running the <strong class="source-inline">db_import</strong> command:<p class="source-code"><strong class="bold">db_import /home/kali/Desktop/outpute_file.xml</strong></p><p>This will import the scan results, and <strong class="source-inline">msfconsole</strong> will automatically add the target specified in the scan as a host, as demonstrated in the following screenshot:</p></li>
			</ol>
			<div>
				<div id="_idContainer056" class="IMG---Figure">
					<img src="Images/B17389_03_009.jpg" alt="Figure 3.9 – Importing the Nmap scan results&#13;&#10;" width="641" height="149"/>
				</div>
			</div>
			<p class="figure-caption">Figure 3.9 – Importing the Nmap scan results</p>
			<p>After importing<a id="_idIndexMarker174"/> the scan results, we can<a id="_idIndexMarker175"/> perform a vulnerability analysis on these results to identify potentially exploitable vulnerabilities. This process is extremely important as it will determine our chances of successful exploitation.</p>
			<h2 id="_idParaDest-50"><a id="_idTextAnchor053"/>Vulnerability assessment</h2>
			<p><strong class="bold">Vulnerability assessment</strong> is the process of identifying, quantifying, and prioritizing vulnerabilities<a id="_idIndexMarker176"/> within a system. This process can be automated through the use of vulnerability scanning systems such as <em class="italic">OpenVAS</em> and <em class="italic">Nessus</em>. However, automated vulnerability scans do not actively exploit vulnerabilities on systems, they only report them. This is where penetration tests come in. As a penetration tester, you will not only need to discover vulnerabilities but actively attempt to exploit them to verify their severity and risk. </p>
			<p>Therefore, it is important, as a penetration tester, to learn how to perform manual vulnerability assessments on your targets as opposed to relying on automated <em class="italic">vulnerability scanning</em> tools. The ability to actively scan and detect vulnerabilities manually is an essential skill.</p>
			<p>Based on the results we have gathered from our targets in the footprinting phase, we can begin the<a id="_idIndexMarker177"/> process of identifying vulnerabilities by closely examining the operating systems and services that are running on the target virtual machines.</p>
			<h3>Metasploitable3 vulnerabilities</h3>
			<p>We can<a id="_idIndexMarker178"/> begin analyzing the Nmap results <a id="_idIndexMarker179"/>for the Metasploitable3 virtual machine in <strong class="source-inline">msfconsole</strong>:</p>
			<ol>
				<li value="1">After starting <strong class="source-inline">msfconsole</strong>, we can list the active hosts to identify the Metasploitable3 virtual machine. You can do this by running the following command in <strong class="source-inline">msfconsole</strong>:<p class="source-code"><strong class="bold">hosts -u</strong></p><p><em class="italic">Figure 3.10</em> outlines all of the active hosts that we imported from our Nmap scan results. As you can see, <strong class="source-inline">msfconsole</strong> lists the target IP addresses and OS name. This information is useful; however, we need to identify the operating system and service versions:</p><div id="_idContainer057" class="IMG---Figure"><img src="Images/B17389_03_010.jpg" alt="Figure 3.10 – The msfconsole hosts&#13;&#10;" width="1110" height="281"/></div><p class="figure-caption">Figure 3.10 – The msfconsole hosts</p></li>
				<li>To display the services and service versions running on a particular host, we can use the following command in <strong class="source-inline">msfconsole</strong>:<p class="source-code"><strong class="bold">services &lt;IP-ADDRESS&gt;</strong></p><p>As outlined in <em class="italic">Figure 3.11</em>, we can identify that the operating system version is <strong class="source-inline">Windows Server 2008 R2, Service Pack 1</strong>:</p><div id="_idContainer058" class="IMG---Figure"><img src="Images/B17389_03_011.jpg" alt="Figure 3.11 – Metasploitable3 services&#13;&#10;" width="1406" height="694"/></div><p class="figure-caption">Figure 3.11 – Metasploitable3 services</p><p>After some<a id="_idIndexMarker180"/> quick Google <a id="_idIndexMarker181"/>searching, I can identify an unpatched vulnerability in the operating system.</p><p>You can search for service and operating system-specific vulnerabilities through search engines such as Google. This process can be fine-tuned through the use of specific search engine operators, as demonstrated in <em class="italic">Figure 3.12</em>:</p><div id="_idContainer059" class="IMG---Figure"><img src="Images/B17389_03_012.jpg" alt="Figure 3.12 – Searching for vulnerabilities&#13;&#10;" width="706" height="686"/></div><p class="figure-caption">Figure 3.12 – Searching for vulnerabilities</p><p>This particular <a id="_idIndexMarker182"/>version of<a id="_idIndexMarker183"/> Windows Server 2008 is vulnerable to the <em class="italic">MS17-010 </em>vulnerability, which is code-named <strong class="bold">EternalBlue</strong>. For <a id="_idIndexMarker184"/>more information about this vulnerability, please refer to <a href="https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010">https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010</a>. <strong class="bold">EternalBlue</strong> is an exploit that allows<a id="_idIndexMarker185"/> attackers to remotely execute arbitrary code by exploiting a vulnerability in Microsoft's <strong class="bold">Server Message Block (SMB</strong>) V1 protocol.</p></li>
				<li>To verify that our target is vulnerable to this exploit, we can search for an auxiliary scanner module within <strong class="source-inline">msfconsole</strong>. This can be done by running the following command:<p class="source-code"><strong class="bold">search eternalblue</strong></p><p>As you can see, in <em class="italic">Figure 3.13</em>, this will display multiple modules matching the search term of <strong class="source-inline">eternalblue</strong>. However, we want to select the auxiliary module that will identify whether our target is vulnerable or not:</p><div id="_idContainer060" class="IMG---Figure"><img src="Images/B17389_03_013.jpg" alt="Figure 3.13 – The auxiliary module" width="1021" height="366"/></div><p class="figure-caption">Figure 3.13 – The auxiliary module</p></li>
				<li>To use the <a id="_idIndexMarker186"/>module, we <a id="_idIndexMarker187"/>can use the <strong class="source-inline">use</strong> command and specify the module name:<p class="source-code"><strong class="bold">use auxiliary/scanner/smb/smb_ms17_010</strong></p></li>
				<li>After specifying the module, we will need to configure the scanner options. The main option that we need to modify is the <strong class="source-inline">RHOSTS</strong> option. The <strong class="source-inline">RHOSTS</strong> option is used to specify the target IP address, as shown in <em class="italic">Figure 3.14</em>:<div id="_idContainer061" class="IMG---Figure"><img src="Images/B17389_03_014.jpg" alt="Figure 3.14 – The RHOSTS option" width="1643" height="471"/></div><p class="figure-caption">Figure 3.14 – The RHOSTS option</p></li>
				<li>We can set the <strong class="source-inline">RHOSTS</strong> option by running the following command:<p class="source-code"><strong class="bold">set RHOSTS &lt;IP-ADDRESS&gt;</strong></p></li>
				<li>After setting the <strong class="source-inline">RHOSTS</strong> option, we can run the auxiliary module using the following command:<p class="source-code"><strong class="bold">run</strong></p><p>As demonstrated in <em class="italic">Figure 3.15</em>, our Metasploitable3 virtual machine is vulnerable to the EternalBlue exploit:</p></li>
			</ol>
			<div>
				<div id="_idContainer062" class="IMG---Figure">
					<img src="Images/B17389_03_015.jpg" alt="Figure 3.15 – The host is vulnerable" width="800" height="205"/>
				</div>
			</div>
			<p class="figure-caption">Figure 3.15 – The host is vulnerable</p>
			<p>We have now <a id="_idIndexMarker188"/>identified and confirmed a <a id="_idIndexMarker189"/>potential vulnerability that could provide us with remote access to the target if successfully exploited. In the next section, we will take a look at the exploitation phase.</p>
			<h3>Metasploitable2 vulnerabilities</h3>
			<p>Similar to<a id="_idIndexMarker190"/> Metasploitable3, we<a id="_idIndexMarker191"/> can analyze the Nmap results that we imported for the Metasploitable2 virtual machine in <em class="italic">msfconsole</em>. Let's perform the following steps: </p>
			<ol>
				<li value="1">To display the services and service versions running on Metasploitable2, we can use the following command in <strong class="source-inline">msfconsole</strong>:<p class="source-code"><strong class="bold">services &lt;IP-ADDRESS&gt;</strong></p><p>As you can see, in <em class="italic">Figure 3.16</em>, Metasploitable2 has services running. Most of these are outdated given the service versions. We can also deduce that the server<a id="_idIndexMarker192"/> is running an <a id="_idIndexMarker193"/>older version of Ubuntu:</p><div id="_idContainer063" class="IMG---Figure"><img src="Images/B17389_03_016.jpg" alt="Figure 3.16 – Metasploitable2 services&#13;&#10;" width="1149" height="812"/></div><p class="figure-caption">Figure 3.16 – Metasploitable2 services</p></li>
				<li>We can utilize a useful tool, called <strong class="source-inline">searchsploit</strong>, which comes prepackaged with Kali Linux, to find potential exploits for the specific service versions that are running on the target. We can do this by running the following command:<p class="source-code"><strong class="bold">searchsploit &lt;Service Name &amp; Version&gt;</strong></p><p class="callout-heading">Note</p><p class="callout"><strong class="bold">Searchsploit</strong> is a utility<a id="_idIndexMarker194"/> that allows you to search for exploits available on <strong class="source-inline">exploit-db</strong> without having to directly access the <strong class="source-inline">exploit-db</strong> website manually.</p></li>
				<li>If we use searchsploit to scan for vulnerabilities that affect the <em class="italic">Samba smbd V3.0.20</em> service, we will discover that it is vulnerable to the command execution and has a corresponding Metasploit module that can be used to exploit this vulnerability. First, you will need to run the following command:<p class="source-code"><strong class="bold">searchsploit samba 3.0.20</strong></p><p><em class="italic">Figure 3.17</em> outlines the various exploits available for Samba <strong class="source-inline">smbd V3.0.20</strong>. We will be using the second exploit, which has a Metasploit module available:</p></li>
			</ol>
			<div>
				<div id="_idContainer064" class="IMG---Figure">
					<img src="Images/B17389_03_017.jpg" alt="Figure 3.17 – The Metasploitable2 vulnerability&#13;&#10;" width="813" height="244"/>
				</div>
			</div>
			<p class="figure-caption">Figure 3.17 – The Metasploitable2 vulnerability</p>
			<p>Now that we have<a id="_idIndexMarker195"/> identified a potential<a id="_idIndexMarker196"/> exploit on our target systems, we can take a look at how to use the utilize exploit modules to gain access.</p>
			<h1 id="_idParaDest-51"><a id="_idTextAnchor054"/>Gaining access </h1>
			<p>We can now get started with <strong class="bold">exploitation</strong>, which is the most exciting phase of the penetration testing life cycle. We have already identified our potential exploits on our target systems; therefore, we now need to run and test these exploits to gain our initial foothold.</p>
			<p>The objective of the exploitation phase is to gain stable and persistent access to the target system, which will ensure that once a system is exploited, we will have persistent access even if the system is restarted.</p>
			<h2 id="_idParaDest-52"><a id="_idTextAnchor055"/>Exploiting Metasploitable3</h2>
			<p>In the previous <a id="_idIndexMarker197"/>section, we were able to identify and verify the <em class="italic">EternalBlue</em> exploit as a potential access vector inside the Metasploitable3 host. Let's take a look at how we can use this exploit to gain access:</p>
			<ol>
				<li value="1">The first step is to fire up <strong class="source-inline">msfconsole</strong> and search for the <em class="italic">EternalBlue</em> exploit module by running the following command:<p class="source-code"><strong class="bold">search eternalblue</strong></p></li>
				<li>The module we will use is the exploit module named <strong class="source-inline">exploit/windows/smb/ms17_010_eternalblue</strong>, as shown in the following screenshot:<div id="_idContainer065" class="IMG---Figure"><img src="Images/B17389_03_018.jpg" alt="Figure 3.18 – The Metasploitable3 eternalblue exploit&#13;&#10;" width="779" height="252"/></div><p class="figure-caption">Figure 3.18 – The Metasploitable3 eternalblue exploit</p></li>
				<li>To use this module, we will run the following command:<p class="source-code"><strong class="bold">use exploit/windows/smb/ms17_010_eternalblue</strong></p></li>
				<li>After specifying the module, we will need to configure the module options. The main option that we need to modify is the <strong class="source-inline">RHOSTS</strong> option. The <strong class="source-inline">RHOSTS</strong> option is used to specify <a id="_idIndexMarker198"/>the target IP address, as demonstrated in the following screenshot:<div id="_idContainer066" class="IMG---Figure"><img src="Images/B17389_03_019.jpg" alt="Figure 3.19 – EternalBlue module options" width="1016" height="600"/></div><p class="figure-caption">Figure 3.19 – EternalBlue module options</p></li>
				<li>We can set the <strong class="source-inline">RHOSTS</strong> option by running the following command:<p class="source-code"><strong class="bold">set RHOSTS &lt;IP-ADDRESS&gt;</strong></p></li>
				<li>We can also set the <strong class="bold">payload</strong> to be used and the <em class="italic">payload listener</em> options, as specified in <em class="italic">Figure 3.20</em>. We use the default options specified by the module.</li>
				<li>After setting the <strong class="source-inline">RHOSTS</strong> option, we can run the auxiliary module with the following command:<p class="source-code"><strong class="bold">run</strong></p></li>
				<li>If the exploit is successful, we should get a <strong class="source-inline">meterpreter</strong> session on the target system, as illustrated at the bottom of the following screenshot: <div id="_idContainer067" class="IMG---Figure"><img src="Images/B17389_03_020.jpg" alt="Figure 3.20 – The successful exploitation of eternalblue&#10;" width="1056" height="674"/></div><p class="figure-caption">Figure 3.20 – The successful exploitation of eternalblue </p><p class="callout-heading">What is meterpreter?</p><p class="callout"><strong class="bold">Meterpreter</strong> is an<a id="_idIndexMarker199"/> advanced<a id="_idIndexMarker200"/> payload that <a id="_idIndexMarker201"/>uses in-memory <strong class="bold">Dynamic Link Library</strong> (<strong class="bold">DLL</strong>) injection and provides attackers with an advanced interactive shell that can be used to explore the target system, run system commands, and execute code.</p></li>
				<li>The <strong class="bold">meterpreter shell</strong> gives <a id="_idIndexMarker202"/>us the ability to explore the system and run commands. However, we still need to set up persistence in the event that our connection is terminated, or the system is restarted. We can do this by using the persistence module within Metasploit. However, before we can use this module, we will need to send our <em class="italic">meterpreter</em> session into <strong class="source-inline">background</strong> by running the following command:<p class="source-code"><strong class="bold">background</strong></p><p><em class="italic">Figure 3.21</em> outlines a list of active meterpreter sessions and their corresponding details:</p><div id="_idContainer068" class="IMG---Figure"><img src="Images/B17389_03_021.jpg" alt="Figure 3.21 – The background meterpreter session&#13;&#10;" width="1223" height="227"/></div><p class="figure-caption">Figure 3.21 – The background meterpreter session</p></li>
				<li>After the meterpreter session is in the background, we can load the persistence module by<a id="_idIndexMarker203"/> running the following command:<p class="source-code"><strong class="bold">use exploit/windows/local/persistence</strong></p></li>
				<li>We now need to configure the module options. In this case, we need to change the <strong class="source-inline">SESSION</strong> option by running the following command: <p class="source-code"><strong class="bold">set SESSION 1</strong></p><p>Additionally, we need to change the payload option, in particular, the <strong class="source-inline">LPORT </strong>option, this can be done by running the following command: </p><p class="source-code"><strong class="bold">set LPORT 4443</strong></p><p><em class="italic">Figure 3.22</em> outlines the various options available for the persistence module. The highlighted options are the values that need to be changed:</p><div id="_idContainer069" class="IMG---Figure"><img src="Images/B17389_03_022.jpg" alt="Figure 3.22 – The persistence module options&#13;&#10;" width="1293" height="542"/></div><p class="figure-caption">Figure 3.22 – The persistence module options</p></li>
				<li>After setting <a id="_idIndexMarker204"/>the module options, we can run the module with the following command:<p class="source-code"><strong class="bold">run</strong></p></li>
				<li>If successful, the persistence module should install <strong class="source-inline">VBS script</strong> and autorun to the registry, as shown in <em class="italic">Figure 3.23</em>:</li>
			</ol>
			<div>
				<div id="_idContainer070" class="IMG---Figure">
					<img src="Images/B17389_03_023.jpg" alt="Figure 3.23 – The persistence module is successful&#13;&#10;" width="1273" height="163"/>
				</div>
			</div>
			<p class="figure-caption">Figure 3.23 – The persistence module is successful</p>
			<p>We have successfully exploited and set up persistence on our Metasploitable3 host. Next, we will look at how to exploit <strong class="bold">Metasploitable2</strong>, which is our Linux host.</p>
			<h2 id="_idParaDest-53"><a id="_idTextAnchor056"/>Exploiting Metasploitable2</h2>
			<p>In the <em class="italic">Information gathering and footprinting</em> section, we were able to identify an exploit for<a id="_idIndexMarker205"/> the <em class="italic">Samba smbd 3.0.20</em> service. Let's take a look at how we can use this exploit to gain access:</p>
			<ol>
				<li value="1">The first step is to fire up <strong class="source-inline">msfconsole</strong> and search for the <strong class="source-inline">Samba 3.0.20</strong> exploit module by running the following command:<p class="source-code"><strong class="bold">search samba 3.0.20</strong></p></li>
				<li>The module we will use is the exploit module, called <strong class="source-inline">exploit/multi/samba/usermap_script</strong>, as demonstrated in the following screenshot:  <div id="_idContainer071" class="IMG---Figure"><img src="Images/B17389_03_024.jpg" alt="Figure 3.24 – The Metasploitable2 exploit module&#13;&#10;" width="690" height="170"/></div><p class="figure-caption">Figure 3.24 – The Metasploitable2 exploit module</p></li>
				<li>To use this module, we will run the following command:<p class="source-code"><strong class="bold">use exploit/multi/samba/usermap_script</strong></p></li>
				<li>After specifying the module, we will need to configure the module options. The main option that we need to modify is the <strong class="source-inline">RHOSTS</strong> option. The <strong class="source-inline">RHOSTS</strong> option is used to specify the target IP address, as shown in <em class="italic">Figure 3.25</em>:<div id="_idContainer072" class="IMG---Figure"><img src="Images/B17389_03_025.jpg" alt="Figure 3.25 – The Metasploitable2 exploit module options&#13;&#10;" width="899" height="441"/></div><p class="figure-caption">Figure 3.25 – The Metasploitable2 exploit module options</p></li>
				<li>We can set <a id="_idIndexMarker206"/>the <strong class="source-inline">RHOSTS</strong> option by running the following command:<p class="source-code"><strong class="bold">set RHOSTS &lt;IP-ADDRESS&gt;</strong></p></li>
				<li>We can also set the payload <em class="italic">to be used</em> and the payload listener options, as specified in <em class="italic">Figure 3.25</em>. We use the default options specified by the module.</li>
				<li>After setting the <strong class="source-inline">RHOSTS</strong> option, we can run the auxiliary module with the following command:<p class="source-code"><strong class="bold">run</strong></p></li>
				<li>If the exploit is successful, we should get a command shell on the target system, as demonstrated in the following screenshot:<div id="_idContainer073" class="IMG---Figure"><img src="Images/B17389_03_026.jpg" alt="Figure 3.26 – The Metasploitable2 command shell" width="1012" height="101"/></div><p class="figure-caption">Figure 3.26 – The Metasploitable2 command shell</p></li>
				<li>We can use the command-shell session to run system commands and explore the system. However, for more consistent access, we will need to upgrade the command shell to a meterpreter session. We can do this by moving the command-shell session to the background. This can be done by using the keyboard combination of <strong class="source-inline">Ctrl + Z</strong>, as shown in <em class="italic">Figure 3.27</em>: <div id="_idContainer074" class="IMG---Figure"><img src="Images/B17389_03_027.jpg" alt="Figure 3.27 – The Metasploitable2 background command shell" width="894" height="248"/></div><p class="figure-caption">Figure 3.27 – The Metasploitable2 background command shell</p></li>
				<li>After the <a id="_idIndexMarker207"/>command-shell session has moved to the background, we can load the shell to the meterpreter module by running the following command:<p class="source-code"><strong class="bold">use post/multi/manage/shell_to_meterpreter</strong></p></li>
				<li>We now need to configure the module options. Here, we need to change the <strong class="source-inline">SESSION</strong> option. We can do this by running this command:<p class="source-code"><strong class="bold">set SESSION 1</strong></p><p>Additionally, we can change the payload option, <strong class="source-inline">LPORT</strong>, by running the following command:</p><p class="source-code"><strong class="bold">set LPORT 4443</strong></p><p><em class="italic">Figure 3.28</em> outlines the options available for the <strong class="source-inline">shell_to_meterpreter</strong> module:</p><div id="_idContainer075" class="IMG---Figure"><img src="Images/B17389_03_028.jpg" alt="Figure 3.28 – The shell_to_meterpreter module options&#13;&#10;" width="992" height="247"/></div><p class="figure-caption">Figure 3.28 – The shell_to_meterpreter module options</p></li>
				<li>After setting the module options, we can run the module with the following command:<p class="source-code"><strong class="bold">run</strong></p></li>
				<li>If successful, the <strong class="source-inline">shell_to_meterpreter</strong> module should send a new stage and launch<a id="_idIndexMarker208"/> a meterpreter session in the background, as demonstrated in the following screenshot: <div id="_idContainer076" class="IMG---Figure"><img src="Images/B17389_03_029.jpg" alt="Figure 3.29 – The shell_to_meterpreter module is successful&#10;" width="1151" height="465"/></div><p class="figure-caption">Figure 3.29 – The shell_to_meterpreter module is successful </p></li>
				<li>We can switch to this session by running the following command:<p class="source-code"><strong class="bold">sessions 2</strong></p></li>
				<li>As you can see in <em class="italic">Figure 3.30</em>, we have successfully upgraded our command shell to a meterpreter session:</li>
			</ol>
			<div>
				<div id="_idContainer077" class="IMG---Figure">
					<img src="Images/B17389_03_030.jpg" alt="Figure 3.30 – The Metasploitable2 meterpreter session&#13;&#10;" width="513" height="144"/>
				</div>
			</div>
			<p class="figure-caption">Figure 3.30 – The Metasploitable2 meterpreter session</p>
			<p>We have now been able to successfully exploit a Windows and Linux host via different exploitation vectors<a id="_idIndexMarker209"/> to gain our initial foothold onto the system. We are now ready to begin the privilege escalation process.</p>
			<h1 id="_idParaDest-54"><a id="_idTextAnchor057"/>Summary</h1>
			<p>In this chapter, we started by familiarizing ourselves with the structure of the Metasploit framework. We then looked at how to perform both footprinting and vulnerability analyses on our targets with <em class="italic">Nmap</em> and <em class="italic">Metasploit</em>. We then ended the chapter by exploring how to use the information we gathered during footprinting to successfully exploit a Windows and Linux host through the operating system and service vulnerabilities.</p>
			<p>Now that we have learned how to establish our initial foothold on the system, we can learn how to perform local system enumeration.</p>
			<p>In the next chapter, we will discover the various tools and techniques that we can use to enumerate information from our target systems and explore how to use this information to stage a privilege escalation attack.</p>
		</div>
	</div></body></html>