<html><head></head><body>
		<div id="_idContainer006">
			<h1 id="_idParaDest-7"><a id="_idTextAnchor006"/>Preface</h1>
			<p>PowerShell is everywhere – it is preinstalled on every modern Windows operating system. On the one hand, this is great for administrators, as this enables them to manage their systems out of the box, but on the other hand, adversaries can leverage PowerShell to execute their <span class="No-Break">malicious payloads.</span></p>
			<p>PowerShell itself provides a variety of features that can not only help you to improve the security of your environment but also help you with your next red team engagement. In this book, we will look at PowerShell for cybersecurity from both sides of the coin – attacker and defender, red and blue team. By reading this book, you’ll gain a deep understanding of PowerShell’s security capabilities and how to <span class="No-Break">use them.</span></p>
			<p>You will learn that PowerShell is not “dangerous,” as some people assume; you will, rather, learn how to configure and utilize it to strengthen the security of your <span class="No-Break">environment instead.</span></p>
			<p>This book provides guidance on using PowerShell and related mitigations to detect attacks and strengthen your environment against threats. We’ll first revisit the basics of PowerShell and learn about scripting fundamentals. You’ll gain unique insights into PowerShell security-related event logging that you won’t find elsewhere, and learn about configuring <span class="No-Break">PowerShell remoting.</span></p>
			<p>We will dive into system and API access, exploring exploitation and hijacking techniques, and how adversaries leverage Active Directory and Azure AD/Entra ID, combined with a variety of deep and detailed knowledge behind those technologies. The red and blue team cookbooks both provide valuable code snippets for the daily use of <span class="No-Break">PowerShell practitioners.</span></p>
			<p>Another very important topic is mitigations that help you secure your environment. We will deep-dive into <strong class="bold">Just Enough Administration</strong> (<strong class="bold">JEA</strong>), a technology that is not very well known, providing you with detailed explanations, examples, and even a way to simplify deploying this technology. We will explore language modes and learn how application control and code signing impact PowerShell. We’ll also look at the <strong class="bold">Antimalware Scan Interface</strong> (<strong class="bold">AMSI</strong>) and learn why it is helpful and how adversaries attempt to <span class="No-Break">bypass it.</span></p>
			<p>So, what are you waiting for? Get ready to transform PowerShell into your greatest ally, empowering both red and blue teamers alike in the relentless battle against <span class="No-Break">cyber threats.</span></p>
			<h1 id="_idParaDest-8"><a id="_idTextAnchor007"/>Who this book is for</h1>
			<p>This book is designed for security professionals, penetration testers, system administrators, red and blue teamers, and cybersecurity enthusiasts who want to enhance their security operations with PowerShell. Whether you’re experienced or new to the field, the book provides valuable insights and practical techniques to leverage PowerShell for various security tasks, including research and development exploits and security bypasses, as well as understanding how adversaries operate to mitigate threats and better protect <span class="No-Break">your environment.</span></p>
			<p>A basic understanding of PowerShell and cybersecurity fundamentals is recommended, and familiarity with concepts such as Active Directory and other programming languages, such as C and Assembly, can <span class="No-Break">be beneficial.</span></p>
			<h1 id="_idParaDest-9"><a id="_idTextAnchor008"/>What this book covers</h1>
			<p><a href="B16679_01_Final_PD.xhtml#_idTextAnchor016"><span class="No-Break"><em class="italic">Chapter 1</em></span></a>, <em class="italic">Getting Started with PowerShell</em>, provides an introduction to PowerShell, exploring its history and highlighting its relevance in cybersecurity. You will learn about Object-Oriented Programming principles, key concepts such as the execution policy and the help system, and the security features introduced in each <span class="No-Break">PowerShell version.</span></p>
			<p><a href="B16679_02_Final_PD.xhtml#_idTextAnchor034"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>, <em class="italic">PowerShell Scripting Fundamentals</em>, covers the PowerShell scripting essentials, including variables, data types, operators, control structure conditions and loops, and naming conventions. The chapter also explores PowerShell profiles, PSDrives, and creating reusable code with cmdlets, functions, modules, <span class="No-Break">and aliases.</span></p>
			<p><a href="B16679_03_Final_PD.xhtml#_idTextAnchor064"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Exploring PowerShell Remote Management Technologies and PowerShell Remoting</em>, dives into some of PowerShell’s remote management technologies, such as WinRM, WMI, CIM, OMI, SSH remoting, and, of course, PowerShell remoting. You will learn how to configure PowerShell remoting to establish remote connections, create custom endpoints, and execute PowerShell <span class="No-Break">commands remotely.</span></p>
			<p><a href="B16679_04_Final_PD.xhtml#_idTextAnchor090"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, <em class="italic">Detection – Auditing and Monitoring</em>, explores the importance of logging for effective detection and monitoring in PowerShell environments. You will learn about essential log files, logging features such as module and script block logging, protected event logging, PowerShell transcripts, and how to analyze event logs <span class="No-Break">using PowerShell.</span></p>
			<p><a href="B16679_05_Final_PD.xhtml#_idTextAnchor110"><span class="No-Break"><em class="italic">Chapter 5</em></span></a>, <em class="italic">PowerShell Is Powerful – System and API Access</em>, explores PowerShell’s system and API access capabilities. You will learn about working with the Windows registry, employing the Windows API, utilizing .NET classes for advanced techniques, and leveraging the power of WMI. The chapter also covers how to execute PowerShell without directly <span class="No-Break">invoking </span><span class="No-Break"><strong class="source-inline">powershell.exe</strong></span><span class="No-Break">.</span></p>
			<p><a href="B16679_06_Final_PD.xhtml#_idTextAnchor150"><span class="No-Break"><em class="italic">Chapter 6</em></span></a>, <em class="italic">Active Directory – Attacks and Mitigation</em>, explores AD security, including authentication protocols, enumeration, privileged accounts, password spraying, access rights, credential theft risks, and mitigation strategies. We will also look at Microsoft security baselines and the Security <span class="No-Break">Compliance Toolkit.</span></p>
			<p><a href="B16679_07_Final_PD.xhtml#_idTextAnchor179"><span class="No-Break"><em class="italic">Chapter 7</em></span></a>, <em class="italic">Hacking the Cloud – Exploiting Azure Active Directory/Entra ID</em>, delves into Azure AD/Entra ID and explores its authentication mechanisms, privileged accounts, PowerShell access, and various attack vectors. You will gain insights into techniques such as anonymous enumeration, password spraying, and credential theft in Azure AD, along with <span class="No-Break">mitigation strategies.</span></p>
			<p><a href="B16679_08_Final_PD.xhtml#_idTextAnchor204"><span class="No-Break"><em class="italic">Chapter 8</em></span></a>, <em class="italic">Red Team Tasks and Cookbook</em>, introduces you to the phases of an attack and common PowerShell red team tools. The chapter then provides a red team cookbook with various recipes, sorted by MITRE ATT&amp;CK areas, such as reconnaissance, execution, persistence, defense evasion, credential access, discovery, lateral movement, command and control, exfiltration, <span class="No-Break">and impact.</span></p>
			<p><a href="B16679_09_Final_PD.xhtml#_idTextAnchor228"><span class="No-Break"><em class="italic">Chapter 9</em></span></a>, <em class="italic">Blue Team Tasks and Cookbook</em>, focuses on blue team tasks and provides a cookbook of practical PowerShell code snippets. It first introduces the “protect, detect, respond” approach and highlights common PowerShell blue team tools. The cookbook provides a variety of blue team recipes, such as examining installed and missing updates, monitoring and preventing bypasses, isolating compromised systems, and analyzing and managing processes, services, and <span class="No-Break">network connections.</span></p>
			<p><a href="B16679_10_Final_PD.xhtml#_idTextAnchor278"><span class="No-Break"><em class="italic">Chapter 10</em></span></a>, <em class="italic">Language Modes and Just Enough Administration (JEA)</em>, first explores language modes in PowerShell and their impact on script execution. It then focuses on JEA, enabling administrators to delegate specific tasks to non-admin users using role-based access control. The chapter explains JEA in detail, including role capability and session configuration files, logging, and best practices, and provides guidance on how to efficiently <span class="No-Break">deploy JEA.</span></p>
			<p><a href="B16679_11_Final_PD.xhtml#_idTextAnchor306"><span class="No-Break"><em class="italic">Chapter 11</em></span></a>, <em class="italic">AppLocker, Application Control, and Code Signing</em>, dives into application control and code signing, focusing on preventing unauthorized script execution, planning for application control, and deploying mechanisms such as Microsoft AppLocker and Windows Defender Application Control. It also explores virtualization-based security and the impact on PowerShell when application control <span class="No-Break">is enforced.</span></p>
			<p><a href="B16679_12_Final_PD.xhtml#_idTextAnchor324"><span class="No-Break"><em class="italic">Chapter 12</em></span></a>, <em class="italic">Exploring the Antimalware Scan Interface (AMSI)</em>, covers the AMSI, exploring its functionality and purpose. It provides practical examples to demonstrate the importance of the AMSI in detecting malicious activities. The chapter also discusses various techniques that adversaries use to bypass and disable AMSI, including obfuscation and <span class="No-Break">Base64 encoding.</span></p>
			<p><a href="B16679_13_Final_PD.xhtml#_idTextAnchor341"><span class="No-Break"><em class="italic">Chapter 13</em></span></a>, <em class="italic">What Else? – Further Mitigations and Resources</em>, provides an overview of the additional PowerShell-related mitigations and resources to enhance your security, such as secure scripting, Desired State Configuration, hardening systems and environments, and Endpoint Detection <span class="No-Break">and Response.</span></p>
			<h1 id="_idParaDest-10"><a id="_idTextAnchor009"/>To get the most out of this book</h1>
			<p>For most chapters, you will need PowerShell 7.3 and above, as well as a Visual Studio Code installation to examine and edit <span class="No-Break">your code.</span></p>
			<p>Depending on the chapter you follow, we will also look at other technologies, such as Windows PowerShell 5.1, Visual Studio, C/C++/C#, Visual Basic, Assembly, Ghidra, Wireshark, and <span class="No-Break">Microsoft Excel.</span></p>
			<table class="No-Table-Style" id="table001">
				<colgroup>
					<col/>
					<col/>
				</colgroup>
				<tbody>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><strong class="bold">Software/hardware covered in </strong><span class="No-Break"><strong class="bold">the book</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p><strong class="bold">Operating </strong><span class="No-Break"><strong class="bold">system requirements</strong></span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p>PowerShell 7.3 <span class="No-Break">and above</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Windows 10 <span class="No-Break">and above</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p>Windows <span class="No-Break">PowerShell 5.1</span></p>
						</td>
						<td class="No-Table-Style">
							<p>Windows Server 2019 <span class="No-Break">and above</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p>Visual <span class="No-Break">Studio Code</span></p>
						</td>
						<td class="No-Table-Style"/>
					</tr>
				</tbody>
			</table>
			<p>Although most examples in this book might work with one test machine only, it is highly recommended to set up a demo environment to improve your experience for some parts of <span class="No-Break">this book.</span></p>
			<p>I used virtual machines to set up my environment, and I recommend doing the same to follow along. Hyper-V is a free hypervisor that you can use to set up <span class="No-Break">your machines.</span></p>
			<p>For my demo environment, I set up the following machines, which I will reference throughout <span class="No-Break">this book:</span></p>
			<ul>
				<li><strong class="bold">PSSec-PC01</strong>: <strong class="source-inline">172.29.0.12</strong>, Windows 10 Enterprise, 22H2, joined to the domain <strong class="source-inline">PSSec.local</strong></li>
				<li><strong class="bold">PSSec-PC02</strong>: <strong class="source-inline">172.29.0.13</strong>, Windows 10 Enterprise, 22H2, joined to the domain <strong class="source-inline">PSSec.local</strong></li>
				<li><strong class="bold">PSSec-Server</strong>: <strong class="source-inline">172.29.0.20</strong>, Windows Server 2019 Datacenter, joined to the domain <strong class="source-inline">PSSec.local</strong></li>
				<li><strong class="bold">DC01</strong>: <strong class="source-inline">172.29.0.10</strong>, Windows Server 2019 Datacenter, hosting the domain <strong class="source-inline">PSSec.local</strong><ul><li><strong class="bold">Installed relevant roles</strong>: Active Directory Certificate, Active Directory Domain Services, DNS Server, and Group Policy Management</li></ul></li>
				<li><strong class="bold">Azure demo environment </strong>for <a href="B16679_07_Final_PD.xhtml#_idTextAnchor179"><em class="italic">Chapter 7</em></a>: <strong class="source-inline">PSSec-Demo.onmicrosoft.com</strong></li>
				<li><strong class="bold">Optional</strong>: Linux and macOS to follow the PowerShell remoting (SSH) configuration in <a href="B16679_03_Final_PD.xhtml#_idTextAnchor064"><em class="italic">Chapter 3</em></a></li>
			</ul>
			<p>The following diagram demonstrates the relevant setup used in <span class="No-Break">this book:</span></p>
			<div>
				<div class="IMG---Figure" id="_idContainer004">
					<img alt="" src="image/Preface_001.jpg"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure P.1 – The setup used in this book</p>
			<p>This setup is only configured in a test environment and should, therefore, not be used in <span class="No-Break">production environments.</span></p>
			<p><strong class="bold">If you are using the digital version of this book, we advise you to type the code yourself or access the code from the book’s GitHub repository (a link is available in the next section). Doing so will help you avoid any potential errors related to the copying and pasting </strong><span class="No-Break"><strong class="bold">of code.</strong></span></p>
			<h1 id="_idParaDest-11"><a id="_idTextAnchor010"/>Download the example code files</h1>
			<p>You can download the example code files for this book from GitHub at <a href="https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity">https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity</a>. If there’s an update to the code, it will be updated in the <span class="No-Break">GitHub repository.</span></p>
			<p>We also have other code bundles from our rich catalog of books and videos available at <a href="https://github.com/PacktPublishing/">https://github.com/PacktPublishing/</a>. Check <span class="No-Break">them out!</span></p>
			<p>All the links mentioned in each chapter will be maintained on our GitHub repository. Links are often subject to change, the links on the GitHub repository will remain up-to-date (of course following update cycles) in case the printed URLs give <span class="No-Break">an error.</span></p>
			<h1 id="_idParaDest-12"><a id="_idTextAnchor011"/>Conventions used</h1>
			<p>There are a number of text conventions used throughout <span class="No-Break">this book.</span></p>
			<p><strong class="source-inline">Code in text</strong>: Indicates code words in text, database table names, folder names, filenames, file extensions, pathnames, dummy URLs, user input, and Twitter handles. Here is an example: “Export one or more aliases with <strong class="source-inline">Export-Alias</strong> – either as a <strong class="source-inline">.csv</strong> file or as <span class="No-Break">a script.”</span></p>
			<p>A block of code is set <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
if (&lt;condition&gt;)
{
    &lt;action&gt;
}</pre>
			<p>When we wish to draw your attention to a particular part of a code block, the relevant lines or items are set <span class="No-Break">in bold:</span></p>
			<pre class="source-code">
if ($color -eq "<strong class="bold">blue</strong>") {
    Write-Host "The color is blue!"
}
elseif ($color -eq "<strong class="bold">green</strong>"){
    Write-Host "The color is green!"
}</pre>
			<p>Any command-line input or output is written <span class="No-Break">as follows:</span></p>
			<pre class="console">
&gt; ("Hello World!").Length
12</pre>
			<p><strong class="bold">Bold</strong>: Indicates a new term, an important word, or words that you see on screen. For instance, words in menus or dialog boxes appear in <strong class="bold">bold</strong>. Here is an example: “Configure the <strong class="bold">Turn on Script Execution</strong> setting, and choose the <strong class="bold">Allow local scripts and remote signed </strong><span class="No-Break"><strong class="bold">scripts</strong></span><span class="No-Break"> option.”</span></p>
			<p class="callout-heading">Tips or important notes</p>
			<p class="callout">Appear like this.</p>
			<h1 id="_idParaDest-13"><a id="_idTextAnchor012"/>Get in touch</h1>
			<p>Feedback from our readers is <span class="No-Break">always welcome.</span></p>
			<p><strong class="bold">General feedback</strong>: If you have questions about any aspect of this book, email us at <a href="http://customercare@packtpub.com">customercare@packtpub.com</a> and mention the book title in the subject of your message. You can also contact the author via Twitter (<strong class="source-inline">@miriamxyra</strong>) or via <span class="No-Break">Mastodon (</span><span class="No-Break"><strong class="source-inline">@mw@infosec.exchange</strong></span><span class="No-Break">).</span></p>
			<p><strong class="bold">Errata</strong>: Although we have taken every care to ensure the accuracy of our content, mistakes do happen. If you have found a mistake in this book, we would be grateful if you would report this to us. Please visit <a href="http://www.packtpub.com/support/errata">www.packtpub.com/support/errata</a> and fill in <span class="No-Break">the form.</span></p>
			<p><strong class="bold">Piracy</strong>: If you come across any illegal copies of our works in any form on the internet, we would be grateful if you would provide us with the location address or website name. Please contact us at <a href="http://copyright@packt.com">copyright@packt.com</a> with a link to <span class="No-Break">the material.</span></p>
			<p><strong class="bold">If you are interested in becoming an author</strong>: If there is a topic that you have expertise in and you are interested in either writing or contributing to a book, please <span class="No-Break">visit </span><a href="http://authors.packtpub.com"><span class="No-Break">authors.packtpub.com</span></a></p>
			<h1 id="_idParaDest-14"><a id="_idTextAnchor013"/>Share Your Thoughts</h1>
			<p>Once you’ve read <em class="italic">PowerShell Automation and Scripting for CyberSecurity</em>, we’d love to hear your thoughts! <a href="https://packt.link/r/1800566379">Please click here to go straight to the Amazon review page for this book and share <span class="No-Break">your feedback</span></a><span class="No-Break">.</span></p>
			<p>Your review is important to us and the tech community and will help us make sure we’re delivering excellent <span class="No-Break">quality content.</span></p>
			<p>.</p>
			<h1 id="_idParaDest-15"><a id="_idTextAnchor014"/>Download a free PDF copy of this book</h1>
			<p>Thanks for purchasing <span class="No-Break">this book!</span></p>
			<p>Do you like to read on the go but are unable to carry your print <span class="No-Break">books everywhere?</span></p>
			<p>Is your eBook purchase not compatible with the device of <span class="No-Break">your choice?</span></p>
			<p>Don’t worry, now with every Packt book you get a DRM-free PDF version of that book at <span class="No-Break">no cost.</span></p>
			<p>Read anywhere, any place, on any device. Search, copy, and paste code from your favorite technical books directly into <span class="No-Break">your application.</span></p>
			<p>The perks don’t stop there, you can get exclusive access to discounts, newsletters, and great free content in your <span class="No-Break">inbox daily</span></p>
			<p>Follow these simple steps to get <span class="No-Break">the benefits:</span></p>
			<ol>
				<li>Scan the QR code or visit the link below</li>
			</ol>
			<div>
				<div class="IMG---Figure" id="_idContainer005">
					<img alt="" src="image/B16679_QR_Free_PDF.jpg"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><a href="https://packt.link/free-ebook/9781800566378">https://packt.link/free-ebook/9781800566378</a></p>
			<ol>
				<li value="2">Submit your proof of purchase</li>
				<li>That’s it! We’ll send your free PDF and other benefits to your email directly</li>
			</ol>
		</div>
		<div>
			<div class="Basic-Text-Frame" id="_idContainer007">
			</div>
		</div>
		<div>
			<div class="Basic-Text-Frame" id="_idContainer008">
			</div>
		</div>
	

		<div>
			<div class="Basic-Graphics-Frame" id="_idContainer009">
			</div>
		</div>
		<div class="Content" id="_idContainer010">
			<h1 id="_idParaDest-16"><a id="_idTextAnchor015"/>Part 1: PowerShell Fundamentals</h1>
			<p>In this part, we are revisiting the PowerShell fundamentals necessary for getting started with PowerShell for cybersecurity. We will begin by reviewing the basics, including Object-Oriented Programming principles, the differences between Windows PowerShell and PowerShell Core, the fundamental concepts of PowerShell, as well as the security features introduced in each <span class="No-Break">PowerShell version.</span></p>
			<p>Next, we’ll explore the essential foundations of PowerShell scripting. By the end of this part, you will have the skills to write PowerShell scripts utilizing various control structures, variables, and operators, enabling you to create reusable <span class="No-Break">code efficiently.</span></p>
			<p>You will also explore how to configure and utilize remote management technologies, with a special focus on PowerShell Remoting. You will gain insights into the security-specific facts and best practices regarding PowerShell Remoting <span class="No-Break">and authentication.</span></p>
			<p>Finally, we will look into PowerShell-related Event Logging: you will understand which Windows event logs and events are the most important ones when it comes to PowerShell cybersecurity. We’ll examine how to configure Script Block Logging, Module Logging, and transcripts and how to analyze event logs <span class="No-Break">most efficiently.</span></p>
			<p>This part has the <span class="No-Break">following chapters:</span></p>
			<ul>
				<li><a href="B16679_01_Final_PD.xhtml#_idTextAnchor016"><em class="italic">Chapter 1</em></a>, <em class="italic">Getting Started with PowerShell</em></li>
				<li><a href="B16679_02_Final_PD.xhtml#_idTextAnchor034"><em class="italic">Chapter 2</em></a>, <em class="italic">PowerShell Scripting Fundamentals</em></li>
				<li><a href="B16679_03_Final_PD.xhtml#_idTextAnchor064"><em class="italic">Chapter 3</em></a>,<em class="italic"> Exploring PowerShell Remote Management Technologies and PowerShell Remoting</em></li>
				<li><a href="B16679_04_Final_PD.xhtml#_idTextAnchor090"><em class="italic">Chapter 4</em></a>,<em class="italic"> Detection – Auditing and Monitoring</em></li>
			</ul>
		</div>
		<div>
			<div class="Basic-Graphics-Frame" id="_idContainer011">
			</div>
		</div>
		<div>
			<div id="_idContainer012">
			</div>
		</div>
	</body></html>