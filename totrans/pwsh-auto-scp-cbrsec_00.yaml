- en: Preface
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: PowerShell is everywhere – it is preinstalled on every modern Windows operating
    system. On the one hand, this is great for administrators, as this enables them
    to manage their systems out of the box, but on the other hand, adversaries can
    leverage PowerShell to execute their malicious payloads.
  prefs: []
  type: TYPE_NORMAL
- en: PowerShell itself provides a variety of features that can not only help you
    to improve the security of your environment but also help you with your next red
    team engagement. In this book, we will look at PowerShell for cybersecurity from
    both sides of the coin – attacker and defender, red and blue team. By reading
    this book, you’ll gain a deep understanding of PowerShell’s security capabilities
    and how to use them.
  prefs: []
  type: TYPE_NORMAL
- en: You will learn that PowerShell is not “dangerous,” as some people assume; you
    will, rather, learn how to configure and utilize it to strengthen the security
    of your environment instead.
  prefs: []
  type: TYPE_NORMAL
- en: This book provides guidance on using PowerShell and related mitigations to detect
    attacks and strengthen your environment against threats. We’ll first revisit the
    basics of PowerShell and learn about scripting fundamentals. You’ll gain unique
    insights into PowerShell security-related event logging that you won’t find elsewhere,
    and learn about configuring PowerShell remoting.
  prefs: []
  type: TYPE_NORMAL
- en: We will dive into system and API access, exploring exploitation and hijacking
    techniques, and how adversaries leverage Active Directory and Azure AD/Entra ID,
    combined with a variety of deep and detailed knowledge behind those technologies.
    The red and blue team cookbooks both provide valuable code snippets for the daily
    use of PowerShell practitioners.
  prefs: []
  type: TYPE_NORMAL
- en: Another very important topic is mitigations that help you secure your environment.
    We will deep-dive into **Just Enough Administration** (**JEA**), a technology
    that is not very well known, providing you with detailed explanations, examples,
    and even a way to simplify deploying this technology. We will explore language
    modes and learn how application control and code signing impact PowerShell. We’ll
    also look at the **Antimalware Scan Interface** (**AMSI**) and learn why it is
    helpful and how adversaries attempt to bypass it.
  prefs: []
  type: TYPE_NORMAL
- en: So, what are you waiting for? Get ready to transform PowerShell into your greatest
    ally, empowering both red and blue teamers alike in the relentless battle against
    cyber threats.
  prefs: []
  type: TYPE_NORMAL
- en: Who this book is for
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This book is designed for security professionals, penetration testers, system
    administrators, red and blue teamers, and cybersecurity enthusiasts who want to
    enhance their security operations with PowerShell. Whether you’re experienced
    or new to the field, the book provides valuable insights and practical techniques
    to leverage PowerShell for various security tasks, including research and development
    exploits and security bypasses, as well as understanding how adversaries operate
    to mitigate threats and better protect your environment.
  prefs: []
  type: TYPE_NORMAL
- en: A basic understanding of PowerShell and cybersecurity fundamentals is recommended,
    and familiarity with concepts such as Active Directory and other programming languages,
    such as C and Assembly, can be beneficial.
  prefs: []
  type: TYPE_NORMAL
- en: What this book covers
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '[*Chapter 1*](B16679_01_Final_PD.xhtml#_idTextAnchor016), *Getting Started
    with PowerShell*, provides an introduction to PowerShell, exploring its history
    and highlighting its relevance in cybersecurity. You will learn about Object-Oriented
    Programming principles, key concepts such as the execution policy and the help
    system, and the security features introduced in each PowerShell version.'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 2*](B16679_02_Final_PD.xhtml#_idTextAnchor034), *PowerShell Scripting
    Fundamentals*, covers the PowerShell scripting essentials, including variables,
    data types, operators, control structure conditions and loops, and naming conventions.
    The chapter also explores PowerShell profiles, PSDrives, and creating reusable
    code with cmdlets, functions, modules, and aliases.'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 3*](B16679_03_Final_PD.xhtml#_idTextAnchor064), *Exploring PowerShell
    Remote Management Technologies and PowerShell Remoting*, dives into some of PowerShell’s
    remote management technologies, such as WinRM, WMI, CIM, OMI, SSH remoting, and,
    of course, PowerShell remoting. You will learn how to configure PowerShell remoting
    to establish remote connections, create custom endpoints, and execute PowerShell
    commands remotely.'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 4*](B16679_04_Final_PD.xhtml#_idTextAnchor090), *Detection – Auditing
    and Monitoring*, explores the importance of logging for effective detection and
    monitoring in PowerShell environments. You will learn about essential log files,
    logging features such as module and script block logging, protected event logging,
    PowerShell transcripts, and how to analyze event logs using PowerShell.'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 5*](B16679_05_Final_PD.xhtml#_idTextAnchor110), *PowerShell Is Powerful
    – System and API Access*, explores PowerShell’s system and API access capabilities.
    You will learn about working with the Windows registry, employing the Windows
    API, utilizing .NET classes for advanced techniques, and leveraging the power
    of WMI. The chapter also covers how to execute PowerShell without directly invoking
    **powershell.exe**.'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 6*](B16679_06_Final_PD.xhtml#_idTextAnchor150), *Active Directory
    – Attacks and Mitigation*, explores AD security, including authentication protocols,
    enumeration, privileged accounts, password spraying, access rights, credential
    theft risks, and mitigation strategies. We will also look at Microsoft security
    baselines and the Security Compliance Toolkit.'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 7*](B16679_07_Final_PD.xhtml#_idTextAnchor179), *Hacking the Cloud
    – Exploiting Azure Active Directory/Entra ID*, delves into Azure AD/Entra ID and
    explores its authentication mechanisms, privileged accounts, PowerShell access,
    and various attack vectors. You will gain insights into techniques such as anonymous
    enumeration, password spraying, and credential theft in Azure AD, along with mitigation
    strategies.'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 8*](B16679_08_Final_PD.xhtml#_idTextAnchor204), *Red Team Tasks and
    Cookbook*, introduces you to the phases of an attack and common PowerShell red
    team tools. The chapter then provides a red team cookbook with various recipes,
    sorted by MITRE ATT&CK areas, such as reconnaissance, execution, persistence,
    defense evasion, credential access, discovery, lateral movement, command and control,
    exfiltration, and impact.'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 9*](B16679_09_Final_PD.xhtml#_idTextAnchor228), *Blue Team Tasks
    and Cookbook*, focuses on blue team tasks and provides a cookbook of practical
    PowerShell code snippets. It first introduces the “protect, detect, respond” approach
    and highlights common PowerShell blue team tools. The cookbook provides a variety
    of blue team recipes, such as examining installed and missing updates, monitoring
    and preventing bypasses, isolating compromised systems, and analyzing and managing
    processes, services, and network connections.'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 10*](B16679_10_Final_PD.xhtml#_idTextAnchor278), *Language Modes
    and Just Enough Administration (JEA)*, first explores language modes in PowerShell
    and their impact on script execution. It then focuses on JEA, enabling administrators
    to delegate specific tasks to non-admin users using role-based access control.
    The chapter explains JEA in detail, including role capability and session configuration
    files, logging, and best practices, and provides guidance on how to efficiently
    deploy JEA.'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 11*](B16679_11_Final_PD.xhtml#_idTextAnchor306), *AppLocker, Application
    Control, and Code Signing*, dives into application control and code signing, focusing
    on preventing unauthorized script execution, planning for application control,
    and deploying mechanisms such as Microsoft AppLocker and Windows Defender Application
    Control. It also explores virtualization-based security and the impact on PowerShell
    when application control is enforced.'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 12*](B16679_12_Final_PD.xhtml#_idTextAnchor324), *Exploring the Antimalware
    Scan Interface (AMSI)*, covers the AMSI, exploring its functionality and purpose.
    It provides practical examples to demonstrate the importance of the AMSI in detecting
    malicious activities. The chapter also discusses various techniques that adversaries
    use to bypass and disable AMSI, including obfuscation and Base64 encoding.'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 13*](B16679_13_Final_PD.xhtml#_idTextAnchor341), *What Else? – Further
    Mitigations and Resources*, provides an overview of the additional PowerShell-related
    mitigations and resources to enhance your security, such as secure scripting,
    Desired State Configuration, hardening systems and environments, and Endpoint
    Detection and Response.'
  prefs: []
  type: TYPE_NORMAL
- en: To get the most out of this book
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: For most chapters, you will need PowerShell 7.3 and above, as well as a Visual
    Studio Code installation to examine and edit your code.
  prefs: []
  type: TYPE_NORMAL
- en: Depending on the chapter you follow, we will also look at other technologies,
    such as Windows PowerShell 5.1, Visual Studio, C/C++/C#, Visual Basic, Assembly,
    Ghidra, Wireshark, and Microsoft Excel.
  prefs: []
  type: TYPE_NORMAL
- en: '| **Software/hardware covered in** **the book** | **Operating** **system requirements**
    |'
  prefs: []
  type: TYPE_TB
- en: '| PowerShell 7.3 and above | Windows 10 and above |'
  prefs: []
  type: TYPE_TB
- en: '| Windows PowerShell 5.1 | Windows Server 2019 and above |'
  prefs: []
  type: TYPE_TB
- en: '| Visual Studio Code |  |'
  prefs: []
  type: TYPE_TB
- en: Although most examples in this book might work with one test machine only, it
    is highly recommended to set up a demo environment to improve your experience
    for some parts of this book.
  prefs: []
  type: TYPE_NORMAL
- en: I used virtual machines to set up my environment, and I recommend doing the
    same to follow along. Hyper-V is a free hypervisor that you can use to set up
    your machines.
  prefs: []
  type: TYPE_NORMAL
- en: 'For my demo environment, I set up the following machines, which I will reference
    throughout this book:'
  prefs: []
  type: TYPE_NORMAL
- en: '**PSSec-PC01**: **172.29.0.12**, Windows 10 Enterprise, 22H2, joined to the
    domain **PSSec.local**'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**PSSec-PC02**: **172.29.0.13**, Windows 10 Enterprise, 22H2, joined to the
    domain **PSSec.local**'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**PSSec-Server**: **172.29.0.20**, Windows Server 2019 Datacenter, joined to
    the domain **PSSec.local**'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**DC01**: **172.29.0.10**, Windows Server 2019 Datacenter, hosting the domain
    **PSSec.local**'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Installed relevant roles**: Active Directory Certificate, Active Directory
    Domain Services, DNS Server, and Group Policy Management'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Azure demo environment** for [*Chapter 7*](B16679_07_Final_PD.xhtml#_idTextAnchor179):
    **PSSec-Demo.onmicrosoft.com**'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Optional**: Linux and macOS to follow the PowerShell remoting (SSH) configuration
    in [*Chapter 3*](B16679_03_Final_PD.xhtml#_idTextAnchor064)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The following diagram demonstrates the relevant setup used in this book:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](image/Preface_001.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure P.1 – The setup used in this book
  prefs: []
  type: TYPE_NORMAL
- en: This setup is only configured in a test environment and should, therefore, not
    be used in production environments.
  prefs: []
  type: TYPE_NORMAL
- en: '**If you are using the digital version of this book, we advise you to type
    the code yourself or access the code from the book’s GitHub repository (a link
    is available in the next section). Doing so will help you avoid any potential
    errors related to the copying and pasting** **of code.**'
  prefs: []
  type: TYPE_NORMAL
- en: Download the example code files
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: You can download the example code files for this book from GitHub at [https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity](https://github.com/PacktPublishing/PowerShell-Automation-and-Scripting-for-Cybersecurity).
    If there’s an update to the code, it will be updated in the GitHub repository.
  prefs: []
  type: TYPE_NORMAL
- en: We also have other code bundles from our rich catalog of books and videos available
    at [https://github.com/PacktPublishing/](https://github.com/PacktPublishing/).
    Check them out!
  prefs: []
  type: TYPE_NORMAL
- en: All the links mentioned in each chapter will be maintained on our GitHub repository.
    Links are often subject to change, the links on the GitHub repository will remain
    up-to-date (of course following update cycles) in case the printed URLs give an
    error.
  prefs: []
  type: TYPE_NORMAL
- en: Conventions used
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: There are a number of text conventions used throughout this book.
  prefs: []
  type: TYPE_NORMAL
- en: '**Code in text**: Indicates code words in text, database table names, folder
    names, filenames, file extensions, pathnames, dummy URLs, user input, and Twitter
    handles. Here is an example: “Export one or more aliases with **Export-Alias**
    – either as a **.csv** file or as a script.”'
  prefs: []
  type: TYPE_NORMAL
- en: 'A block of code is set as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'When we wish to draw your attention to a particular part of a code block, the
    relevant lines or items are set in bold:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'Any command-line input or output is written as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: '**Bold**: Indicates a new term, an important word, or words that you see on
    screen. For instance, words in menus or dialog boxes appear in **bold**. Here
    is an example: “Configure the **Turn on Script Execution** setting, and choose
    the **Allow local scripts and remote signed** **scripts** option.”'
  prefs: []
  type: TYPE_NORMAL
- en: Tips or important notes
  prefs: []
  type: TYPE_NORMAL
- en: Appear like this.
  prefs: []
  type: TYPE_NORMAL
- en: Get in touch
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Feedback from our readers is always welcome.
  prefs: []
  type: TYPE_NORMAL
- en: '**General feedback**: If you have questions about any aspect of this book,
    email us at [customercare@packtpub.com](http://customercare@packtpub.com) and
    mention the book title in the subject of your message. You can also contact the
    author via Twitter (**@miriamxyra**) or via Mastodon (**@mw@infosec.exchange**).'
  prefs: []
  type: TYPE_NORMAL
- en: '**Errata**: Although we have taken every care to ensure the accuracy of our
    content, mistakes do happen. If you have found a mistake in this book, we would
    be grateful if you would report this to us. Please visit [www.packtpub.com/support/errata](http://www.packtpub.com/support/errata)
    and fill in the form.'
  prefs: []
  type: TYPE_NORMAL
- en: '**Piracy**: If you come across any illegal copies of our works in any form
    on the internet, we would be grateful if you would provide us with the location
    address or website name. Please contact us at [copyright@packt.com](http://copyright@packt.com)
    with a link to the material.'
  prefs: []
  type: TYPE_NORMAL
- en: '**If you are interested in becoming an author**: If there is a topic that you
    have expertise in and you are interested in either writing or contributing to
    a book, please visit [authors.packtpub.com](http://authors.packtpub.com)'
  prefs: []
  type: TYPE_NORMAL
- en: Share Your Thoughts
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Once you’ve read *PowerShell Automation and Scripting for CyberSecurity*, we’d
    love to hear your thoughts! [Please click here to go straight to the Amazon review
    page for this book and share your feedback](https://packt.link/r/1800566379).
  prefs: []
  type: TYPE_NORMAL
- en: Your review is important to us and the tech community and will help us make
    sure we’re delivering excellent quality content.
  prefs: []
  type: TYPE_NORMAL
- en: .
  prefs: []
  type: TYPE_NORMAL
- en: Download a free PDF copy of this book
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Thanks for purchasing this book!
  prefs: []
  type: TYPE_NORMAL
- en: Do you like to read on the go but are unable to carry your print books everywhere?
  prefs: []
  type: TYPE_NORMAL
- en: Is your eBook purchase not compatible with the device of your choice?
  prefs: []
  type: TYPE_NORMAL
- en: Don’t worry, now with every Packt book you get a DRM-free PDF version of that
    book at no cost.
  prefs: []
  type: TYPE_NORMAL
- en: Read anywhere, any place, on any device. Search, copy, and paste code from your
    favorite technical books directly into your application.
  prefs: []
  type: TYPE_NORMAL
- en: The perks don’t stop there, you can get exclusive access to discounts, newsletters,
    and great free content in your inbox daily
  prefs: []
  type: TYPE_NORMAL
- en: 'Follow these simple steps to get the benefits:'
  prefs: []
  type: TYPE_NORMAL
- en: Scan the QR code or visit the link below
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](image/B16679_QR_Free_PDF.jpg)'
  prefs: []
  type: TYPE_IMG
- en: '[https://packt.link/free-ebook/9781800566378](https://packt.link/free-ebook/9781800566378)'
  prefs: []
  type: TYPE_NORMAL
- en: Submit your proof of purchase
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: That’s it! We’ll send your free PDF and other benefits to your email directly
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Part 1: PowerShell Fundamentals'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this part, we are revisiting the PowerShell fundamentals necessary for getting
    started with PowerShell for cybersecurity. We will begin by reviewing the basics,
    including Object-Oriented Programming principles, the differences between Windows
    PowerShell and PowerShell Core, the fundamental concepts of PowerShell, as well
    as the security features introduced in each PowerShell version.
  prefs: []
  type: TYPE_NORMAL
- en: Next, we’ll explore the essential foundations of PowerShell scripting. By the
    end of this part, you will have the skills to write PowerShell scripts utilizing
    various control structures, variables, and operators, enabling you to create reusable
    code efficiently.
  prefs: []
  type: TYPE_NORMAL
- en: You will also explore how to configure and utilize remote management technologies,
    with a special focus on PowerShell Remoting. You will gain insights into the security-specific
    facts and best practices regarding PowerShell Remoting and authentication.
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally, we will look into PowerShell-related Event Logging: you will understand
    which Windows event logs and events are the most important ones when it comes
    to PowerShell cybersecurity. We’ll examine how to configure Script Block Logging,
    Module Logging, and transcripts and how to analyze event logs most efficiently.'
  prefs: []
  type: TYPE_NORMAL
- en: 'This part has the following chapters:'
  prefs: []
  type: TYPE_NORMAL
- en: '[*Chapter 1*](B16679_01_Final_PD.xhtml#_idTextAnchor016), *Getting Started
    with PowerShell*'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[*Chapter 2*](B16679_02_Final_PD.xhtml#_idTextAnchor034), *PowerShell Scripting
    Fundamentals*'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[*Chapter 3*](B16679_03_Final_PD.xhtml#_idTextAnchor064), *Exploring PowerShell
    Remote Management Technologies and PowerShell Remoting*'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[*Chapter 4*](B16679_04_Final_PD.xhtml#_idTextAnchor090), *Detection – Auditing
    and Monitoring*'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
