<html><head></head><body>
<div id="_idContainer032">
<h1 class="chapter-number" id="_idParaDest-102"><a id="_idTextAnchor100"/><span class="koboSpan" id="kobo.1.1">6</span></h1>
<h1 id="_idParaDest-103"><a id="_idTextAnchor101"/><span class="koboSpan" id="kobo.2.1">SMB, Active Directory, LDAP and Kerberos</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, we will explore how PowerShell can be used as part of a comprehensive penetration</span><a id="_idIndexMarker288"/><span class="koboSpan" id="kobo.4.1"> test on </span><strong class="bold"><span class="koboSpan" id="kobo.5.1">Server Message Block</span></strong><span class="koboSpan" id="kobo.6.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.7.1">SMB</span></strong><span class="koboSpan" id="kobo.8.1">), </span><strong class="bold"><span class="koboSpan" id="kobo.9.1">Active Directory</span></strong><span class="koboSpan" id="kobo.10.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.11.1">AD</span></strong><span class="koboSpan" id="kobo.12.1">), and </span><strong class="bold"><span class="koboSpan" id="kobo.13.1">Lightweight Directory Access Protocol</span></strong><span class="koboSpan" id="kobo.14.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.15.1">LDAP</span></strong><span class="koboSpan" id="kobo.16.1">). </span><span class="koboSpan" id="kobo.16.2">We will </span><a id="_idIndexMarker289"/><span class="koboSpan" id="kobo.17.1">delve</span><a id="_idIndexMarker290"/><span class="koboSpan" id="kobo.18.1"> into the powerful capabilities of PowerShell to conduct thorough security assessments and identify potential vulnerabilities in these critical components of </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">enterprise networks.</span></span></p>
<p><span class="koboSpan" id="kobo.20.1">PowerShell, as a scripting language developed by Microsoft, offers a wide array of tools and cmdlets that can be harnessed by security professionals and penetration testers to assess the security posture of SMB shares, user accounts, group memberships, and directory services. </span><span class="koboSpan" id="kobo.20.2">Through a series of worked examples, we will illustrate how PowerShell can be leveraged to enumerate, profile, and exploit weaknesses in </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">these systems.</span></span></p>
<p><span class="koboSpan" id="kobo.22.1">Our journey begins with SMB, where we will demonstrate how PowerShell can be used to assess SMB versioning, enumerate shared resources, and test for weak passwords. </span><span class="koboSpan" id="kobo.22.2">We will then transition to Active Directory, where we will showcase PowerShell’s capabilities in auditing user account security, identifying inactive accounts, and evaluating </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">group memberships.</span></span></p>
<p><span class="koboSpan" id="kobo.24.1">Moving on to LDAP, we will explore how PowerShell can be employed to assess LDAP permissions, test authentication, and monitor LDAP traffic. </span><span class="koboSpan" id="kobo.24.2">Each step of our exploration will be accompanied by practical examples, empowering you to apply these techniques effectively in your own </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">security assessments.</span></span></p>
<p><span class="koboSpan" id="kobo.26.1">By the end of this chapter, you will have a comprehensive understanding of how PowerShell can be an invaluable tool in the arsenal of penetration testers and security professionals. </span><span class="koboSpan" id="kobo.26.2">It will equip you with the knowledge and skills to proactively identify vulnerabilities, assess security configurations, and ultimately, enhance the resilience of SMB, AD, and LDAP implementations within </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">your organizations.</span></span></p>
<p><span class="koboSpan" id="kobo.28.1">The following are the main topics we will cover in </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.30.1">PowerShell </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">and SMB</span></span></li>
<li><span class="koboSpan" id="kobo.32.1">PowerShell, AD, </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">and LDAP</span></span></li>
<li><span class="koboSpan" id="kobo.34.1">PowerShell </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">and Kerberos</span></span></li>
</ul>
<h1 id="_idParaDest-104"><a id="_idTextAnchor102"/><span class="koboSpan" id="kobo.36.1">PowerShell and SMB</span></h1>
<p><span class="koboSpan" id="kobo.37.1">PowerShell can be</span><a id="_idIndexMarker291"/><span class="koboSpan" id="kobo.38.1"> effectively employed </span><a id="_idIndexMarker292"/><span class="koboSpan" id="kobo.39.1">to perform security tests against network services such as the SMB protocol, which is commonly used for file sharing and resource access in Windows environments. </span><span class="koboSpan" id="kobo.39.2">In this section, we’ll explore how PowerShell can be used to conduct a security test against SMB, identify vulnerabilities, and bolster </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">network defenses.</span></span></p>
<p><span class="koboSpan" id="kobo.41.1">The SMB protocol is a critical component of Windows-based networks, facilitating file and printer sharing, as well as access to various resources. </span><span class="koboSpan" id="kobo.41.2">While SMB is vital for seamless data exchange, it can also present security risks if not adequately configured. </span><span class="koboSpan" id="kobo.41.3">These risks include unauthorized access, data leakage, and susceptibility to ransomware attacks. </span><span class="koboSpan" id="kobo.41.4">To ensure the robust security of your network, it’s essential to conduct thorough security testing of </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">SMB implementations.</span></span></p>
<h2 id="_idParaDest-105"><a id="_idTextAnchor103"/><span class="koboSpan" id="kobo.43.1">Enumerating SMB shares</span></h2>
<p><span class="koboSpan" id="kobo.44.1">A fundamental </span><a id="_idIndexMarker293"/><span class="koboSpan" id="kobo.45.1">aspect of SMB security testing is discovering shared resources on a remote server. </span><span class="koboSpan" id="kobo.45.2">PowerShell provides cmdlets such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.46.1">Get-SmbShare</span></strong><span class="koboSpan" id="kobo.47.1"> that allow you to enumerate </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">SMB shares:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.49.1">
Get-SmbShare</span></pre> <p><span class="koboSpan" id="kobo.50.1">This command lists all the available shares on a remote server, providing information about share names, paths, and access permissions. </span><span class="koboSpan" id="kobo.50.2">Security testers can use this information to assess share permissions, identify misconfigurations, and determine which shares may </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">be vulnerable.</span></span></p>
<h2 id="_idParaDest-106"><a id="_idTextAnchor104"/><span class="koboSpan" id="kobo.52.1">An SMB version assessment</span></h2>
<p><span class="koboSpan" id="kobo.53.1">To identify </span><a id="_idIndexMarker294"/><span class="koboSpan" id="kobo.54.1">potential vulnerabilities related to outdated or insecure SMB versions, PowerShell can be used to check the SMB version running on a remote system. </span><span class="koboSpan" id="kobo.54.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.55.1">Get-SmbConnection</span></strong><span class="koboSpan" id="kobo.56.1"> cmdlet reveals details about SMB connections, including the </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">dialect version:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.58.1">
Get-SmbConnection</span></pre> <p><span class="koboSpan" id="kobo.59.1">This command provides insights into the SMB version in use, helping you evaluate whether your network is running secure and up-to-date versions </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">of SMB.</span></span></p>
<h2 id="_idParaDest-107"><a id="_idTextAnchor105"/><span class="koboSpan" id="kobo.61.1">Testing for weak passwords</span></h2>
<p><span class="koboSpan" id="kobo.62.1">Weak or default</span><a id="_idIndexMarker295"/><span class="koboSpan" id="kobo.63.1"> passwords can be a significant security risk in SMB environments. </span><span class="koboSpan" id="kobo.63.2">PowerShell can be employed to perform password audits by attempting to connect to SMB shares using a list of commonly used or known weak passwords. </span><span class="koboSpan" id="kobo.63.3">The following script automates </span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">this process:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.65.1">
$computers = Get-Content computers.txt
$passwords = Get-Content passwords.txt
foreach ($computer in $computers) {
    foreach ($password in $passwords) {
        $credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList ("$computer\Administrator", (ConvertTo-SecureString -String $password -AsPlainText -Force))
        try {
            Invoke-Command -ComputerName $computer -Credential $credential -ScriptBlock { Get-SmbShare }
        } catch {
            Write-Host "Failed to connect to $computer with password $password"
        }
    }
}</span></pre> <p><span class="koboSpan" id="kobo.66.1">This script attempts to connect to each computer in the list using a set of passwords and logs any failed</span><a id="_idIndexMarker296"/><span class="koboSpan" id="kobo.67.1"> attempts, helping you identify weak or unchanged </span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">default credentials.</span></span></p>
<h2 id="_idParaDest-108"><a id="_idTextAnchor106"/><span class="koboSpan" id="kobo.69.1">SMB vulnerability scanning</span></h2>
<p><span class="koboSpan" id="kobo.70.1">PowerShell can be</span><a id="_idIndexMarker297"/><span class="koboSpan" id="kobo.71.1"> leveraged to perform SMB vulnerability scanning using third-party modules or scripts. </span><span class="koboSpan" id="kobo.71.2">Tools such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.72.1">Invoke-SMBScanner</span></strong><span class="koboSpan" id="kobo.73.1"> can be integrated into PowerShell to identify SMB vulnerabilities on </span><span class="No-Break"><span class="koboSpan" id="kobo.74.1">target systems:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.75.1">
Invoke-SMBScanner -Target 192.168.107.100-192.168.107.150</span></pre> <p><span class="koboSpan" id="kobo.76.1">Such tools perform scans for common SMB vulnerabilities, including known exploits such as EternalBlue or SMBGhost, and provide insights into </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">potential risks.</span></span></p>
<h2 id="_idParaDest-109"><a id="_idTextAnchor107"/><span class="koboSpan" id="kobo.78.1">Assessing SMB signing and encryption</span></h2>
<p><span class="koboSpan" id="kobo.79.1">SMB signing and </span><a id="_idIndexMarker298"/><span class="koboSpan" id="kobo.80.1">encryption are crucial to ensure data integrity and confidentiality. </span><span class="koboSpan" id="kobo.80.2">PowerShell allows you to check whether SMB signing and encryption are enabled on a remote server. </span><span class="koboSpan" id="kobo.80.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.81.1">Get-SmbClientConfiguration</span></strong><span class="koboSpan" id="kobo.82.1"> cmdlet can be used to retrieve SMB client configuration, including signing and </span><span class="No-Break"><span class="koboSpan" id="kobo.83.1">encryption settings:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.84.1">
Get-SmbClientConfiguration</span></pre> <p><span class="koboSpan" id="kobo.85.1">Inspect the </span><strong class="source-inline"><span class="koboSpan" id="kobo.86.1">RequireSecuritySignature</span></strong><span class="koboSpan" id="kobo.87.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.88.1">EncryptData</span></strong><span class="koboSpan" id="kobo.89.1"> properties to verify whether these security features are enabled. </span><span class="koboSpan" id="kobo.89.2">Securely configured SMB servers should have both signing and encryption enabled to enhance </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">network security.</span></span></p>
<h2 id="_idParaDest-110"><a id="_idTextAnchor108"/><span class="koboSpan" id="kobo.91.1">The enumeration of active SMB sessions</span></h2>
<p><span class="koboSpan" id="kobo.92.1">PowerShell can be </span><a id="_idIndexMarker299"/><span class="koboSpan" id="kobo.93.1">used to enumerate active SMB sessions, providing insights into who is currently accessing shared resources. </span><span class="koboSpan" id="kobo.93.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.94.1">Get-SmbSession</span></strong><span class="koboSpan" id="kobo.95.1"> cmdlet allows you to retrieve information about SMB sessions on a local or </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">remote system:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.97.1">
Get-SmbSession</span></pre> <p><span class="koboSpan" id="kobo.98.1">By analyzing session</span><a id="_idIndexMarker300"/><span class="koboSpan" id="kobo.99.1"> data, security professionals can identify unauthorized or </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">suspicious connections.</span></span></p>
<h2 id="_idParaDest-111"><a id="_idTextAnchor109"/><span class="koboSpan" id="kobo.101.1">Checking for guest access</span></h2>
<p><span class="koboSpan" id="kobo.102.1">Guest access to</span><a id="_idIndexMarker301"/><span class="koboSpan" id="kobo.103.1"> SMB shares can be a significant security risk. </span><span class="koboSpan" id="kobo.103.2">PowerShell can be used to verify whether guest access is allowed on a remote system. </span><span class="koboSpan" id="kobo.103.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1">Get-SmbShare</span></strong><span class="koboSpan" id="kobo.105.1"> cmdlet can be customized to check for </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">guest access:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.107.1">
Get-SmbShare | Where-Object { $_.IsGuestOnly -eq $true }</span></pre> <p><span class="koboSpan" id="kobo.108.1">This command lists shares that only allow guest access, highlighting potential </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">security concerns.</span></span></p>
<h2 id="_idParaDest-112"><a id="_idTextAnchor110"/><span class="koboSpan" id="kobo.110.1">Evaluating share permissions</span></h2>
<p><span class="koboSpan" id="kobo.111.1">PowerShell enables </span><a id="_idIndexMarker302"/><span class="koboSpan" id="kobo.112.1">security testers to evaluate share permissions</span><a id="_idIndexMarker303"/><span class="koboSpan" id="kobo.113.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.114.1">Access Control Lists</span></strong><span class="koboSpan" id="kobo.115.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.116.1">ACLs</span></strong><span class="koboSpan" id="kobo.117.1">) for SMB shares. </span><span class="koboSpan" id="kobo.117.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.118.1">Get-Acl</span></strong><span class="koboSpan" id="kobo.119.1"> cmdlet can be used to retrieve and analyze the ACL of a </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">specific share:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.121.1">
$shareName = "ShareName"
(Get-SmbShare -Name $shareName).Path | Get-Acl</span></pre> <p><span class="koboSpan" id="kobo.122.1">This command displays the share’s security descriptor, helping you identify overly permissive or misconfigured </span><span class="No-Break"><span class="koboSpan" id="kobo.123.1">share permissions.</span></span></p>
<h2 id="_idParaDest-113"><a id="_idTextAnchor111"/><span class="koboSpan" id="kobo.124.1">SMB session monitoring</span></h2>
<p><span class="koboSpan" id="kobo.125.1">PowerShell</span><a id="_idIndexMarker304"/><span class="koboSpan" id="kobo.126.1"> can be employed to set up continuous monitoring of SMB sessions. </span><span class="koboSpan" id="kobo.126.2">By periodically running commands to retrieve active sessions, you can spot any unexpected or suspicious connections over time. </span><span class="koboSpan" id="kobo.126.3">Consider using a scheduled task to automate </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">session monitoring:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.128.1">
$interval = 60
while ($true) {
    Get-SmbSession
    Start-Sleep -Seconds $interval
}</span></pre> <p><span class="koboSpan" id="kobo.129.1">This script continually retrieves SMB session information and can be run as a background task to </span><a id="_idIndexMarker305"/><span class="koboSpan" id="kobo.130.1">monitor for any unauthorized or </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">suspicious access.</span></span></p>
<h2 id="_idParaDest-114"><a id="_idTextAnchor112"/><span class="koboSpan" id="kobo.132.1">Automated ransomware detection</span></h2>
<p><span class="koboSpan" id="kobo.133.1">PowerShell can </span><a id="_idIndexMarker306"/><span class="koboSpan" id="kobo.134.1">be used to detect suspicious or rapid changes in files that may indicate ransomware activity. </span><span class="koboSpan" id="kobo.134.2">Scripts can be written to monitor file attributes, such as file size and modification time, and raise alerts when unexpected </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">changes occur:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.136.1">
$filePath = "C:\Test\ImportantFile.txt"
$initialSize = (Get-Item $filePath).Length
while ($true) {
    $currentSize = (Get-Item $filePath).Length
    if ($currentSize -ne $initialSize) {
        Write-Host "File size changed. </span><span class="koboSpan" id="kobo.136.2">Possible ransomware activity detected."
</span><span class="koboSpan" id="kobo.136.3">    }
    Start-Sleep -Seconds 300
}</span></pre> <p><span class="koboSpan" id="kobo.137.1">This script monitors the size of a specific file and raises an alert if the file size changes unexpectedly, which could indicate </span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">ransomware activity.</span></span></p>
<p><span class="koboSpan" id="kobo.139.1">PowerShell provides a robust set of tools and techniques for conducting security tests against SMB implementations. </span><span class="koboSpan" id="kobo.139.2">By leveraging these capabilities, security professionals can proactively identify vulnerabilities, assess share permissions, monitor SMB activity, and strengthen network defenses. </span><span class="koboSpan" id="kobo.139.3">It’s crucial to conduct these tests with proper authorization and compliance with applicable laws and regulations. </span><span class="koboSpan" id="kobo.139.4">Regularly auditing SMB configurations and actively monitoring for suspicious activity can help organizations secure their network services effectively and mitigate potential threats </span><span class="No-Break"><span class="koboSpan" id="kobo.140.1">to SMB.</span></span></p>
<h1 id="_idParaDest-115"><a id="_idTextAnchor113"/><span class="koboSpan" id="kobo.141.1">PowerShell, AD, and LDAP</span></h1>
<p><span class="koboSpan" id="kobo.142.1">PowerShell can</span><a id="_idIndexMarker307"/><span class="koboSpan" id="kobo.143.1"> be harnessed to perform</span><a id="_idIndexMarker308"/><span class="koboSpan" id="kobo.144.1"> comprehensive security tests </span><a id="_idIndexMarker309"/><span class="koboSpan" id="kobo.145.1">against </span><a id="_idIndexMarker310"/><span class="koboSpan" id="kobo.146.1">AD and LDAP services. </span><span class="koboSpan" id="kobo.146.2">In this extensive guide, we’ll delve into how PowerShell can be used to conduct security tests against AD and LDAP, identify vulnerabilities, and bolster the security of </span><span class="No-Break"><span class="koboSpan" id="kobo.147.1">directory services.</span></span></p>
<p><span class="koboSpan" id="kobo.148.1">AD is Microsoft’s directory service used in Windows environments to manage users, groups, computers, and other network resources. </span><span class="koboSpan" id="kobo.148.2">LDAP is a protocol used to access and manage directory services, including AD. </span><span class="koboSpan" id="kobo.148.3">Both AD and LDAP are critical components of many enterprise networks, and securing them is paramount to maintaining a </span><span class="No-Break"><span class="koboSpan" id="kobo.149.1">secure environment.</span></span></p>
<p><span class="koboSpan" id="kobo.150.1">Before diving into the specifics of security testing, let’s briefly understand the core concepts of AD </span><span class="No-Break"><span class="koboSpan" id="kobo.151.1">and LDAP.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.152.1">AD</span></strong><span class="koboSpan" id="kobo.153.1">: AD is a directory </span><a id="_idIndexMarker311"/><span class="koboSpan" id="kobo.154.1">service developed by Microsoft for Windows domain networks. </span><span class="koboSpan" id="kobo.154.2">It stores and manages information about network resources, including user accounts, groups, and computers. </span><span class="koboSpan" id="kobo.154.3">AD plays a central role in authentication, authorization, and resource management in </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">Windows environments.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.156.1">LDAP</span></strong><span class="koboSpan" id="kobo.157.1">: LDAP is a protocol used to access and manage directory services, including AD. </span><span class="koboSpan" id="kobo.157.2">It provides a standardized way to query, update, and administer directory information. </span><span class="koboSpan" id="kobo.157.3">LDAP is commonly used in various network services and applications to access </span><span class="No-Break"><span class="koboSpan" id="kobo.158.1">directory data.</span></span></li>
</ul>
<h2 id="_idParaDest-116"><a id="_idTextAnchor114"/><span class="koboSpan" id="kobo.159.1">The enumeration of active directory objects</span></h2>
<p><span class="koboSpan" id="kobo.160.1">AD contains a wealth </span><a id="_idIndexMarker312"/><span class="koboSpan" id="kobo.161.1">of information about users, groups, and computers. </span><span class="koboSpan" id="kobo.161.2">PowerShell allows you to enumerate these objects to gain insights into your AD structure. </span><span class="koboSpan" id="kobo.161.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.162.1">Get-ADObject</span></strong><span class="koboSpan" id="kobo.163.1"> cmdlet is a powerful tool for this purpose – for example, to list all user objects in a specific </span><strong class="bold"><span class="koboSpan" id="kobo.164.1">Organizational </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.165.1">Unit</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.166.1"> (</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.167.1">OU</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.168.1">):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.169.1">
Get-ADObject -Filter {ObjectClass -eq 'user'} -SearchBase 'OU=Employees,DC=snowcapcyber,DC=com'</span></pre> <p><span class="koboSpan" id="kobo.170.1">This command retrieves all user objects within the specified OU, providing details such as usernames and distinguished names. </span><span class="koboSpan" id="kobo.170.2">Enumeration is the first step in understanding your AD environment, and</span><a id="_idIndexMarker313"/><span class="koboSpan" id="kobo.171.1"> it can help identify objects that shouldn’t be accessible </span><span class="No-Break"><span class="koboSpan" id="kobo.172.1">or exist.</span></span></p>
<h2 id="_idParaDest-117"><a id="_idTextAnchor115"/><span class="koboSpan" id="kobo.173.1">Assessing user account security</span></h2>
<p><span class="koboSpan" id="kobo.174.1">User accounts are a</span><a id="_idIndexMarker314"/><span class="koboSpan" id="kobo.175.1"> primary target for attackers. </span><span class="koboSpan" id="kobo.175.2">PowerShell can be used to assess user account security by checking for common issues, such as password complexity and expiration settings. </span><span class="koboSpan" id="kobo.175.3">For instance, the following can be used to list users whose passwords </span><span class="No-Break"><span class="koboSpan" id="kobo.176.1">never expire:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.177.1">
Get-ADUser -Filter {PasswordNeverExpires -eq $true}</span></pre> <p><span class="koboSpan" id="kobo.178.1">This command identifies users with accounts set to never expire, which may be a security risk. </span><span class="koboSpan" id="kobo.178.2">Security testing often involves evaluating password policies, account lockout settings, and other </span><span class="No-Break"><span class="koboSpan" id="kobo.179.1">security-related attributes.</span></span></p>
<h2 id="_idParaDest-118"><a id="_idTextAnchor116"/><span class="koboSpan" id="kobo.180.1">Identifying inactive user accounts</span></h2>
<p><span class="koboSpan" id="kobo.181.1">Inactive user</span><a id="_idIndexMarker315"/><span class="koboSpan" id="kobo.182.1"> accounts can be exploited by attackers. </span><span class="koboSpan" id="kobo.182.2">PowerShell can help identify and disable or remove inactive accounts by checking the last login date. </span><span class="koboSpan" id="kobo.182.3">Here’s an example of finding users who haven’t logged in for </span><span class="No-Break"><span class="koboSpan" id="kobo.183.1">90 days:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.184.1">
$90DaysAgo = (Get-Date).AddDays(-90)
Get-ADUser -Filter {LastLogonDate -lt $90DaysAgo} -Properties LastLogonDate</span></pre> <p><span class="koboSpan" id="kobo.185.1">This script identifies users who haven’t logged in for the specified period, allowing you to take appropriate action, such as disabling or deleting </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">the accounts.</span></span></p>
<h2 id="_idParaDest-119"><a id="_idTextAnchor117"/><span class="koboSpan" id="kobo.187.1">Auditing group memberships</span></h2>
<p><span class="koboSpan" id="kobo.188.1">Group memberships</span><a id="_idIndexMarker316"/><span class="koboSpan" id="kobo.189.1"> can grant users access to sensitive resources. </span><span class="koboSpan" id="kobo.189.2">PowerShell can audit group memberships to ensure they adhere to the principle of least privilege. </span><span class="koboSpan" id="kobo.189.3">For instance, to list the members of a specific group, the following command can </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">be used:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.191.1">
Get-ADGroupMember -Identity 'ITAdmins'</span></pre> <p><span class="koboSpan" id="kobo.192.1">This command retrieves all members of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">ITAdmins</span></strong><span class="koboSpan" id="kobo.194.1"> group, helping you verify that only authorized </span><a id="_idIndexMarker317"/><span class="koboSpan" id="kobo.195.1">individuals have access to </span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">administrative privileges.</span></span></p>
<h2 id="_idParaDest-120"><a id="_idTextAnchor118"/><span class="koboSpan" id="kobo.197.1">Identifying privileged accounts</span></h2>
<p><span class="koboSpan" id="kobo.198.1">Privileged accounts, such </span><a id="_idIndexMarker318"/><span class="koboSpan" id="kobo.199.1">as administrators, require extra scrutiny. </span><span class="koboSpan" id="kobo.199.2">PowerShell can help identify and review privileged accounts. </span><span class="koboSpan" id="kobo.199.3">To list all users with administrative roles, use the </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.201.1">
Get-ADGroupMember -Identity 'Administrators'</span></pre> <p><span class="koboSpan" id="kobo.202.1">This command provides a list of all users in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">Administrators</span></strong><span class="koboSpan" id="kobo.204.1"> group, allowing you to review their roles </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">and permissions.</span></span></p>
<h2 id="_idParaDest-121"><a id="_idTextAnchor119"/><span class="koboSpan" id="kobo.206.1">Auditing password policy</span></h2>
<p><span class="koboSpan" id="kobo.207.1">Password policies</span><a id="_idIndexMarker319"/><span class="koboSpan" id="kobo.208.1"> are crucial for security. </span><span class="koboSpan" id="kobo.208.2">PowerShell can be used to check the password policy settings in your domain. </span><span class="koboSpan" id="kobo.208.3">For example, to retrieve the password policy for your domain, use the </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.210.1">
Get-ADDefaultDomainPasswordPolicy</span></pre> <p><span class="koboSpan" id="kobo.211.1">This command provides details about password complexity requirements, length, and other </span><span class="No-Break"><span class="koboSpan" id="kobo.212.1">policy settings.</span></span></p>
<h2 id="_idParaDest-122"><a id="_idTextAnchor120"/><span class="koboSpan" id="kobo.213.1">Assessing LDAP permissions</span></h2>
<p><span class="koboSpan" id="kobo.214.1">LDAP permissions </span><a id="_idIndexMarker320"/><span class="koboSpan" id="kobo.215.1">can also be assessed using PowerShell. </span><span class="koboSpan" id="kobo.215.2">You can query AD to determine which users or groups have specific LDAP permissions. </span><span class="koboSpan" id="kobo.215.3">For instance, to find users with read access to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">CN=Users</span></strong><span class="koboSpan" id="kobo.217.1"> container, use the </span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.219.1">
Get-ACL 'AD:\CN=Users,DC=snowcapcyber,DC=com' | Select-Object -ExpandProperty Access | Where-Object { $_.ActiveDirectoryRights -like 'ReadProperty' }</span></pre> <p><span class="koboSpan" id="kobo.220.1">This command identifies users or groups that have read access to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">CN=Users</span></strong><span class="koboSpan" id="kobo.222.1"> container. </span><span class="koboSpan" id="kobo.222.2">You can </span><a id="_idIndexMarker321"/><span class="koboSpan" id="kobo.223.1">adapt this approach to check other permissions </span><span class="No-Break"><span class="koboSpan" id="kobo.224.1">as well.</span></span></p>
<h2 id="_idParaDest-123"><a id="_idTextAnchor121"/><span class="koboSpan" id="kobo.225.1">Testing LDAP authentication</span></h2>
<p><span class="koboSpan" id="kobo.226.1">PowerShell can </span><a id="_idIndexMarker322"/><span class="koboSpan" id="kobo.227.1">be employed to test LDAP authentication by attempting to bind to the LDAP directory with different credentials. </span><span class="koboSpan" id="kobo.227.2">This can help identify weak or unprotected accounts. </span><span class="koboSpan" id="kobo.227.3">Here’s </span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">an example:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.229.1">
$ldapServer = 'ldap://ldap.snowcapcyber.com'
$username = 'ajcblyth'
$password = 'MYpassword123'
try {
    $ldap = [ADSI]($ldapServer)
    $ldap.Username = $username
    $ldap.Password = $password
    $ldap.AuthenticationType = [System.DirectoryServices.AuthenticationTypes]::Secure
    $ldap.Bind()
    Write-Host "LDAP auth success for $username"
} catch {
    Write-Host "LDAP auth failed for $username"
}</span></pre> <p><span class="koboSpan" id="kobo.230.1">This script attempts to bind to the LDAP directory using the specified credentials and reports whether the authentication </span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">was successful.</span></span></p>
<h2 id="_idParaDest-124"><a id="_idTextAnchor122"/><span class="koboSpan" id="kobo.232.1">Identifying unsecured LDAP ports</span></h2>
<p><span class="koboSpan" id="kobo.233.1">Attackers often </span><a id="_idIndexMarker323"/><span class="koboSpan" id="kobo.234.1">target unsecured LDAP ports. </span><span class="koboSpan" id="kobo.234.2">PowerShell can be used to check whether LDAP services are exposed on unsecured ports. </span><span class="koboSpan" id="kobo.234.3">You can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.235.1">Test-NetConnection</span></strong><span class="koboSpan" id="kobo.236.1"> cmdlet to test </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">LDAP connectivity:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.238.1">
Test-NetConnection -ComputerName ldap.snowcapcyber.com -Port 389</span></pre> <p><span class="koboSpan" id="kobo.239.1">This command checks whether the LDAP service runs on the default unsecured port (</span><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">389</span></strong><span class="koboSpan" id="kobo.241.1">). </span><span class="koboSpan" id="kobo.241.2">If it is, consider securing LDAP with TLS </span><span class="No-Break"><span class="koboSpan" id="kobo.242.1">or SSL.</span></span></p>
<h2 id="_idParaDest-125"><a id="_idTextAnchor123"/><span class="koboSpan" id="kobo.243.1">Monitoring LDAP traffic</span></h2>
<p><span class="koboSpan" id="kobo.244.1">PowerShell can </span><a id="_idIndexMarker324"/><span class="koboSpan" id="kobo.245.1">be employed to monitor LDAP traffic for unusual or suspicious activities. </span><span class="koboSpan" id="kobo.245.2">Tools such as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.246.1">Get-WinEvent</span></strong><span class="koboSpan" id="kobo.247.1"> cmdlet can help you analyze event logs for </span><span class="No-Break"><span class="koboSpan" id="kobo.248.1">LDAP-related events:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.249.1">
Get-WinEvent -LogName 'Security' | Where-Object { $_.Id -eq 2887 }</span></pre> <p><span class="koboSpan" id="kobo.250.1">This command retrieves security event logs containing LDAP channel binding failures, which may indicate unauthorized </span><span class="No-Break"><span class="koboSpan" id="kobo.251.1">access attempts.</span></span></p>
<h2 id="_idParaDest-126"><a id="_idTextAnchor124"/><span class="koboSpan" id="kobo.252.1">Testing LDAP with LDAPS</span></h2>
<p><strong class="bold"><span class="koboSpan" id="kobo.253.1">LDAP over SSL</span></strong><span class="koboSpan" id="kobo.254.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.255.1">LDAPS</span></strong><span class="koboSpan" id="kobo.256.1">) is a</span><a id="_idIndexMarker325"/><span class="koboSpan" id="kobo.257.1"> secure </span><a id="_idIndexMarker326"/><span class="koboSpan" id="kobo.258.1">way to access directory services. </span><span class="koboSpan" id="kobo.258.2">PowerShell can be used to verify whether LDAPS is properly configured. </span><span class="koboSpan" id="kobo.258.3">Here’s </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">an example:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.260.1">
Test-NetConnection -ComputerName ldap.snowcapcyber.com -Port 636</span></pre> <p><span class="koboSpan" id="kobo.261.1">This command checks whether the LDAPS service runs on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">636</span></strong><span class="koboSpan" id="kobo.263.1">. </span><span class="koboSpan" id="kobo.263.2">LDAPS should be used to encrypt LDAP traffic for </span><span class="No-Break"><span class="koboSpan" id="kobo.264.1">enhanced security.</span></span></p>
<h2 id="_idParaDest-127"><a id="_idTextAnchor125"/><span class="koboSpan" id="kobo.265.1">Identifying anomalies with PowerShell scripts</span></h2>
<p><span class="koboSpan" id="kobo.266.1">Custom PowerShell</span><a id="_idIndexMarker327"/><span class="koboSpan" id="kobo.267.1"> scripts </span><a id="_idIndexMarker328"/><span class="koboSpan" id="kobo.268.1">can be created to identify anomalies and potential security breaches in AD and LDAP. </span><span class="koboSpan" id="kobo.268.2">For example, you can create a script that regularly checks for unusual login patterns, such as multiple failed login attempts, and sends alerts </span><span class="No-Break"><span class="koboSpan" id="kobo.269.1">when detected:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.270.1">
$threshold = 3
$logPath = "C:\Logs\FailedLogins.log"
$failedLogins = Get-WinEvent -LogName 'Security' | Where-Object { $_.Id -eq 4625 }
if ($failedLogins.Count -ge $threshold) {
    $failedLogins | Out-File -Append $logPath
    Send-MailMessage -To 'admin@snowcapcyber.com' -From 'alerts@snowcapcyber.com' -Subject 'Security Alert: Multiple Failed Logins Detected' -Body "Multiple failed login attempts detected. </span><span class="koboSpan" id="kobo.270.2">Check $logPath for details."
</span><span class="koboSpan" id="kobo.270.3">}</span></pre> <p><span class="koboSpan" id="kobo.271.1">This script monitors the security event log for multiple failed login attempts and sends an alert if the threshold </span><span class="No-Break"><span class="koboSpan" id="kobo.272.1">is exceeded.</span></span></p>
<p><span class="koboSpan" id="kobo.273.1">PowerShell is an invaluable tool for conducting security tests against AD and LDAP services. </span><span class="koboSpan" id="kobo.273.2">By using these PowerShell commands and scripts, security professionals can proactively identify vulnerabilities, assess user account security, audit group memberships, and monitor directory service activity. </span><span class="koboSpan" id="kobo.273.3">However, it’s essential to conduct these tests with proper authorization and in compliance with applicable laws and regulations. </span><span class="koboSpan" id="kobo.273.4">Regularly </span><a id="_idIndexMarker329"/><span class="koboSpan" id="kobo.274.1">auditing and</span><a id="_idIndexMarker330"/><span class="koboSpan" id="kobo.275.1"> securing AD and LDAP configurations can help organizations strengthen their directory services’ security and defend against </span><span class="No-Break"><span class="koboSpan" id="kobo.276.1">potential threats.</span></span></p>
<h1 id="_idParaDest-128"><a id="_idTextAnchor126"/><span class="koboSpan" id="kobo.277.1">PowerShell and Kerberos</span></h1>
<p><span class="koboSpan" id="kobo.278.1">PowerShell can</span><a id="_idIndexMarker331"/><span class="koboSpan" id="kobo.279.1"> be effectively used to</span><a id="_idIndexMarker332"/><span class="koboSpan" id="kobo.280.1"> perform a wide range of security tests against Kerberos, a widely used authentication protocol. </span><span class="koboSpan" id="kobo.280.2">In this section, we will explore how PowerShell can be employed to assess the security of Kerberos implementations, identify vulnerabilities, and enhance </span><span class="No-Break"><span class="koboSpan" id="kobo.281.1">system defenses.</span></span></p>
<p><span class="koboSpan" id="kobo.282.1">Kerberos is a network authentication protocol that uses secret-key cryptography to authenticate users and services on a network. </span><span class="koboSpan" id="kobo.282.2">It’s employed in many Windows-based environments and is known for its robust security mechanisms. </span><span class="koboSpan" id="kobo.282.3">However, like any technology, Kerberos </span><a id="_idIndexMarker333"/><span class="koboSpan" id="kobo.283.1">can have vulnerabilities</span><a id="_idIndexMarker334"/><span class="koboSpan" id="kobo.284.1"> that could be exploited by malicious actors. </span><span class="koboSpan" id="kobo.284.2">PowerShell can be utilized to uncover these </span><span class="No-Break"><span class="koboSpan" id="kobo.285.1">vulnerabilities proactively.</span></span></p>
<h2 id="_idParaDest-129"><a id="_idTextAnchor127"/><span class="koboSpan" id="kobo.286.1">The enumeration of Kerberos tickets</span></h2>
<p><span class="koboSpan" id="kobo.287.1">PowerShell provides</span><a id="_idIndexMarker335"/><span class="koboSpan" id="kobo.288.1"> cmdlets such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.289.1">Get-KerberosTicket</span></strong><span class="koboSpan" id="kobo.290.1"> that allow security testers to enumerate Kerberos tickets, revealing valuable information about active sessions and potential attack vectors, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.291.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.292.1">
Get-KerberosTicket | Format-Table -Property UserName, ServiceName, StartTime, EndTime</span></pre> <p><span class="koboSpan" id="kobo.293.1">This command lists the active Kerberos tickets, providing insights into which users and services are authenticated and when these </span><span class="No-Break"><span class="koboSpan" id="kobo.294.1">tickets expire.</span></span></p>
<h2 id="_idParaDest-130"><a id="_idTextAnchor128"/><span class="koboSpan" id="kobo.295.1">Service Principal Name (SPN) enumeration</span></h2>
<p><span class="koboSpan" id="kobo.296.1">PowerShell can be</span><a id="_idIndexMarker336"/><span class="koboSpan" id="kobo.297.1"> used </span><a id="_idIndexMarker337"/><span class="koboSpan" id="kobo.298.1">to discover SPNs associated with services, which are crucial for Kerberos authentication. </span><span class="koboSpan" id="kobo.298.2">Attackers may target misconfigured SPNs to gain unauthorized access. </span><span class="koboSpan" id="kobo.298.3">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">Get-ADServiceAccount</span></strong><span class="koboSpan" id="kobo.300.1"> to list service accounts and </span><span class="No-Break"><span class="koboSpan" id="kobo.301.1">their SPNs:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.302.1">
Get-ADServiceAccount -Filter *</span></pre> <p><span class="koboSpan" id="kobo.303.1">This can help to identify any unnecessary or improperly </span><span class="No-Break"><span class="koboSpan" id="kobo.304.1">configured SPNs.</span></span></p>
<h2 id="_idParaDest-131"><a id="_idTextAnchor129"/><span class="koboSpan" id="kobo.305.1">Credential harvesting with Mimikatz</span></h2>
<p><span class="koboSpan" id="kobo.306.1">Mimikatz, a powerful </span><a id="_idIndexMarker338"/><span class="koboSpan" id="kobo.307.1">post-exploitation</span><a id="_idIndexMarker339"/><span class="koboSpan" id="kobo.308.1"> tool, can be integrated into PowerShell to extract credentials from memory. </span><span class="koboSpan" id="kobo.308.2">By loading the </span><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">Mimikatz</span></strong><span class="koboSpan" id="kobo.310.1"> module, you can access its functions to harvest credentials, including </span><span class="No-Break"><span class="koboSpan" id="kobo.311.1">Kerberos tickets:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.312.1">
Invoke-Mimikatz -Command '"ajcblyth::tickets"'</span></pre> <p><span class="koboSpan" id="kobo.313.1">This can expose stored Kerberos tickets and plaintext passwords, highlighting the importance of </span><a id="_idIndexMarker340"/><span class="koboSpan" id="kobo.314.1">securing </span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">sensitive </span></span><span class="No-Break"><a id="_idIndexMarker341"/></span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">credentials.</span></span></p>
<h2 id="_idParaDest-132"><a id="_idTextAnchor130"/><span class="koboSpan" id="kobo.317.1">Detecting golden ticket attacks</span></h2>
<p><span class="koboSpan" id="kobo.318.1">PowerShell can </span><a id="_idIndexMarker342"/><span class="koboSpan" id="kobo.319.1">be employed to detect golden ticket attacks, a sophisticated threat vector where an attacker forges a </span><a id="_idIndexMarker343"/><span class="koboSpan" id="kobo.320.1">Kerberos </span><strong class="bold"><span class="koboSpan" id="kobo.321.1">Ticket Granting Ticket</span></strong><span class="koboSpan" id="kobo.322.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.323.1">TGT</span></strong><span class="koboSpan" id="kobo.324.1">). </span><span class="koboSpan" id="kobo.324.2">Tools such as PowerShellMafia/PowerSploit offer modules to check the integrity of TGTs and identify </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">potential compromises:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.326.1">
Import-Module PowerSploit
Invoke-Kerberoast</span></pre> <p><span class="koboSpan" id="kobo.327.1">This command checks for vulnerable TGTs that can be cracked offline, helping to identify </span><span class="No-Break"><span class="koboSpan" id="kobo.328.1">potential attacks.</span></span></p>
<h2 id="_idParaDest-133"><a id="_idTextAnchor131"/><span class="koboSpan" id="kobo.329.1">Kerberos ticket renewal analysis</span></h2>
<p><span class="koboSpan" id="kobo.330.1">Kerberos tickets </span><a id="_idIndexMarker344"/><span class="koboSpan" id="kobo.331.1">are typically renewed during a user’s session. </span><span class="koboSpan" id="kobo.331.2">PowerShell scripts can monitor ticket renewals and highlight anomalies. </span><span class="koboSpan" id="kobo.331.3">For instance, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.332.1">New-TimeSpan</span></strong><span class="koboSpan" id="kobo.333.1"> cmdlet to calculate the duration between ticket issuance </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">and renewal:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.335.1">
$ticket = Get-KerberosTicket
$renewalDuration = (New-TimeSpan -Start $ticket.StartTime -End $ticket.EndTime).TotalMinutes
if ($renewalDuration -gt 1440) {
    Write-Host "Abnormally renewal detected."
</span><span class="koboSpan" id="kobo.335.2">}</span></pre> <p><span class="koboSpan" id="kobo.336.1">This can help detect prolonged sessions that might be indicative of </span><span class="No-Break"><span class="koboSpan" id="kobo.337.1">unauthorized access.</span></span></p>
<h2 id="_idParaDest-134"><a id="_idTextAnchor132"/><span class="koboSpan" id="kobo.338.1">Analyzing event logs</span></h2>
<p><span class="koboSpan" id="kobo.339.1">PowerShell can </span><a id="_idIndexMarker345"/><span class="koboSpan" id="kobo.340.1">parse Windows event logs to identify suspicious Kerberos-related events. </span><span class="koboSpan" id="kobo.340.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">Get-WinEvent</span></strong><span class="koboSpan" id="kobo.342.1"> cmdlet can be used to filter and analyze security event logs for specific </span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">Kerberos events:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.344.1">
Get-WinEvent -LogName Security | Where-Object { $_.Id -eq 4769 }</span></pre> <p><span class="koboSpan" id="kobo.345.1">This allows security professionals to identify failed authentication attempts or other </span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">unusual activities.</span></span></p>
<h2 id="_idParaDest-135"><a id="_idTextAnchor133"/><span class="koboSpan" id="kobo.347.1">Password spray attacks</span></h2>
<p><span class="koboSpan" id="kobo.348.1">PowerShell can be</span><a id="_idIndexMarker346"/><span class="koboSpan" id="kobo.349.1"> employed to conduct password spray attacks against Kerberos. </span><span class="koboSpan" id="kobo.349.2">Tools such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.350.1">Invoke-SprayKerberos</span></strong><span class="koboSpan" id="kobo.351.1"> can be used to test the strength of user passwords and identify </span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">weak credentials:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.353.1">
Invoke-SprayKerberos -UserList users.txt -Password Summer2023 -Domain snowcapcyber.com</span></pre> <p><span class="koboSpan" id="kobo.354.1">This helps to highlight users with weak passwords that could </span><span class="No-Break"><span class="koboSpan" id="kobo.355.1">be exploited.</span></span></p>
<p><span class="koboSpan" id="kobo.356.1">PowerShell serves as a versatile and indispensable tool to conduct security tests against Kerberos implementations. </span><span class="koboSpan" id="kobo.356.2">By leveraging its capabilities, security professionals can proactively identify vulnerabilities, detect potential threats, and enhance the security of their network infrastructure. </span><span class="koboSpan" id="kobo.356.3">However, it’s important to note that security testing should always be conducted with proper authorization and in compliance with applicable laws and regulations. </span><span class="koboSpan" id="kobo.356.4">Regularly auditing Kerberos configurations and monitoring for anomalies can play a vital role in safeguarding sensitive authentication mechanisms and preventing </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">unauthorized access.</span></span></p>
<h1 id="_idParaDest-136"><a id="_idTextAnchor134"/><span class="koboSpan" id="kobo.358.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.359.1">This chapter delved into the multifaceted applications of PowerShell in penetration testing across SMB, AD, and LDAP. </span><span class="koboSpan" id="kobo.359.2">Through a series of practical examples, we unveiled how PowerShell serves as an indispensable tool to enumerate, profile, and exploit vulnerabilities in these critical components of </span><span class="No-Break"><span class="koboSpan" id="kobo.360.1">enterprise networks.</span></span></p>
<p><span class="koboSpan" id="kobo.361.1">In the next chapter, we will learn about how PowerShell can be used as part of a vulnerability assessment against SQL databases. </span><span class="koboSpan" id="kobo.361.2">Particular attention will be paid to Microsoft SQL, PostgreSQL, </span><span class="No-Break"><span class="koboSpan" id="kobo.362.1">and MySQL.</span></span></p>
</div>
</body></html>