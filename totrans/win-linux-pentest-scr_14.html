<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer320">
<h1 id="_idParaDest-278"><em class="italic"><a id="_idTextAnchor277"/>Chapter 15</em>: Going Beyond the Foothold</h1>
<p>On this crazy ball flying through space that we call home, there are few things as exciting as seeing that Meterpreter session pop up after firing off an exploit. Sometimes, your compromise has yielded you a domain administrator and you can pretty much do anything you want; you can probably just log in to other systems on the domain to gather yourself a handful of compromised computers and grab the loot you find on them. However, the more likely scenario is that you just successfully pulled off an exploit on one of only a few machines that are actually visible from your position in the network due to firewalling and segmentation – you’ve established a foothold. The word <em class="italic">foothold</em> is borrowed from rock climbing terminology – it’s a spot in the rock face where you can place your feet for security as you prepare to progress further. Getting a foothold in a pen test means you’ve found a hole in the rock of your client’s defense that you can use to launch yourself up, but the climbing lies before you.</p>
<p>In this chapter, we’re going to do the following:</p>
<ul>
<li>Review concepts and methods for leveraging a foothold position</li>
<li>Introduce enumeration from our foothold position </li>
<li>Discuss pivoting through the network</li>
<li>Leverage pilfered credentials to compromise systems deeper in our target’s network</li>
</ul>
<h1 id="_idParaDest-279"><a id="_idTextAnchor278"/>Technical requirements</h1>
<p>The technical requirements for this chapter are as follows:</p>
<ul>
<li>Kali Linux.</li>
<li>A Windows environment with several hosts on different LANs is ideal.</li>
</ul>
<h1 id="_idParaDest-280"><a id="_idTextAnchor279"/>Gathering goodies – enumeration with post modules</h1>
<p>The big happy family of Metasploit modules designed to turn your foothold into total compromise are called <strong class="bold">post modules</strong>. There are a few types of post module, but there are two primary <a id="_idIndexMarker1025"/>subfamilies – <em class="italic">gather</em> and <em class="italic">manage</em>. First, let’s draw a distinction between the post manage and post gather modules:</p>
<ul>
<li>The post manage modules are what I like to call compromise management tools. In other <a id="_idIndexMarker1026"/>words, they allow us to manage the compromise we’ve accomplished, mainly by modifying features of the host.</li>
<li>The post gather modules are just what they sound like: they allow us to gather information from <a id="_idIndexMarker1027"/>the target that will inform further compromise. Pushing past the initial foothold will require more information; a full penetration of the target network is an iterative process. Don’t expect to only do recon and footprinting once at the beginning of the assessment – you’ll be doing it again at your foothold.</li>
</ul>
<p>We don’t have enough room to dive into all of the post modules, but you’ll always need to do some enumeration once you’ve cracked that outer shell. You need to understand where you are in the network and what kind of environment you’re in. So, let’s take a look at some core enumeration with gather modules. </p>
<p>For our example, we’ve just compromised a Windows 7 Enterprise machine on our client’s main office network and we have a Meterpreter session. We’re about to discover that this machine has another NIC attached to a hidden network. Later in the chapter, we’ll take a look at this scenario to demonstrate pivoting our way into that hidden network. For now, let’s explore the environment of our foothold PC.</p>
<h2 id="_idParaDest-281"><a id="_idTextAnchor280"/>ARP enumeration with Meterpreter</h2>
<p>Once we’re established with Meterpreter, we control the machine (at least in the user context of the <a id="_idIndexMarker1028"/>payload execution, but we’ll talk about escalation later). We <a id="_idIndexMarker1029"/>can play with our fun Meterpreter toys, or we can just go old school and play around with the command line. Let’s kick off Windows’ <strong class="source-inline">ipconfig</strong>. Thankfully, this command is already built into Meterpreter:</p>
<div>
<div class="IMG---Figure" id="_idContainer300">
<img alt="Figure 15.1 – ipconfig in a Meterpreter session " height="1284" src="image/Figure_15.01_B17616.jpg" width="889"/>
</div>
</div>
<p class="figure-caption">Figure 15.1 – ipconfig in a Meterpreter session</p>
<p>Check that out – a <strong class="source-inline">192.168.249.0/24</strong> network that isn’t visible to our Kali box. If you read the <a id="_idIndexMarker1030"/>early chapters of this book, you’re already deeply in <a id="_idIndexMarker1031"/>love with ARP, so let’s get acquainted with this network. Simply pass the <strong class="source-inline">arp</strong> command to Meterpreter:</p>
<div>
<div class="IMG---Figure" id="_idContainer301">
<img alt="Figure 15.2 – The remote ARP table in Meterpreter " height="1197" src="image/Figure_15.02_B17616.jpg" width="767"/>
</div>
</div>
<p class="figure-caption">Figure 15.2 – The remote ARP table in Meterpreter</p>
<p>Quite an effective <a id="_idIndexMarker1032"/>host enumeration from beyond the perimeter. All that’s happening here is that Meterpreter is dumping the host’s ARP table instead of sending data into the network to find other targets; we used our foothold as a layer 2 spy, reporting its intel back to us. If there’s a computer in our foothold’s broadcast domain(s) and it has announced its presence via ARP replies, we have its IP address and MAC address mapping right here.</p>
<p class="callout-heading">Beware of ARP Counterintelligence</p>
<p class="callout">Remember that this result is what our foothold <em class="italic">believes</em> is the correct mapping. If there’s any ARP poisoning going on, the poisoned table is what you’re seeing.</p>
<p>Let’s make sense of this result in our lab. Since this is an ARP table, it will include things such as multicast and broadcast addresses – those can be ignored. What’s interesting to us is that there’s another host on the hidden network – <strong class="source-inline">192.168.249.154</strong>. Now we have a lead on one possible direction to further compromise. Let’s keep that in mind for later – first, let’s grab some loot from our foothold PC. It may come in handy as we leap from host to host.</p>
<h2 id="_idParaDest-282"><a id="_idTextAnchor281"/>Forensic analysis with Meterpreter – stealing deleted files</h2>
<p>There is a digital equivalent of just tossing whole documents into the trash instead of through a cross-cut shredder: deleting the file off your computer. Most IT folks are aware that when you delete a file in Windows, the operating system simply marks that space as free. This is far more efficient than actually erasing everything, but it also means old data can be very stubborn. There are known techniques for recovering deleted files and plenty of freeware tools for it. Metasploit takes that functionality and turns it into a friendly looting module.</p>
<p>When you’re interacting with a Meterpreter session and you’d like to get back to the Metasploit console, use the <strong class="source-inline">background</strong> command to put your session on the back burner. You can then use the <strong class="source-inline">sessions</strong> command to list your Meterpreter sessions and use the <strong class="source-inline">-i</strong> flag to interact with one. In our lab environment, I have only one session so far – but when you’re in the field, you may have several. These modules can be set up like ordinary exploits from the console, or they can be called with the <strong class="source-inline">run</strong> command from within Meterpreter – definitely an awesome feature for those times when you know exactly what you want to do. However, in the field, we’ll often need reminders of what modules Metasploit has in store for us and the options they offer. So, let’s background our session and try searching for what we want: some forensics work. Type <strong class="source-inline">search type:post forensics</strong> and hit <em class="italic">Enter</em>:</p>
<div>
<div class="IMG---Figure" id="_idContainer302">
<img alt="Figure 15.3 – Searching for forensics modules " height="748" src="image/Figure_15.03_B17616.jpg" width="1424"/>
</div>
</div>
<p class="figure-caption">Figure 15.3 – Searching for forensics modules</p>
<p>The <strong class="source-inline">search</strong> command lets us narrow our search down to a <a id="_idIndexMarker1033"/>module type, and forensics are part of the post modules. After the <strong class="source-inline">type</strong> parameter is set, we simply provide our search term, <strong class="source-inline">forensics</strong>. We want to try some deleted file enumeration and recovery, so let’s use <strong class="source-inline">post/windows/gather/forensics/recovery_files</strong>, which is in index position 1, with <strong class="source-inline">use 1</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer303">
<img alt="Figure 15.4 – Configuring the deleted file recovery module " height="470" src="image/Figure_15.04_B17616.jpg" width="1372"/>
</div>
</div>
<p class="figure-caption">Figure 15.4 – Configuring the deleted file recovery module</p>
<p>You can set <strong class="source-inline">TIMEOUT</strong> for whatever you like; the default is one hour. If you set it to <strong class="source-inline">0</strong>, then it won’t stop <a id="_idIndexMarker1034"/>running until it’s found everything it can. Of course, this can take a long time. Type <strong class="source-inline">run</strong> to get started:</p>
<div>
<div class="IMG---Figure" id="_idContainer304">
<img alt="Figure 15.5 – Deleted files with unique IDs " height="524" src="image/Figure_15.05_B17616.jpg" width="912"/>
</div>
</div>
<p class="figure-caption">Figure 15.5 – Deleted files with unique IDs</p>
<p>If you don’t specify a file extension, the module will just look for all deleted files. Note that each one gets a unique ID. The <strong class="source-inline">FILES=</strong> option in the module can be used for either specifying extensions or by choosing an individual file by ID. I’ve found a file I’d like to recover, so I run the command again with the file ID in the <strong class="source-inline">FILES</strong> parameter:</p>
<div>
<div class="IMG---Figure" id="_idContainer305">
<img alt="Figure 15.6 – Recovering deleted files " height="360" src="image/Figure_15.06_B17616.jpg" width="1388"/>
</div>
</div>
<p class="figure-caption">Figure 15.6 – Recovering deleted files</p>
<p>The scanner runs <a id="_idIndexMarker1035"/>over the file again, matches the ID, and dumps it <a id="_idIndexMarker1036"/>into my bag o’ loot. Showing a deleted document with confidential data in it to an executive is a powerful statement for your exit meeting.</p>
<h2 id="_idParaDest-283"><a id="_idTextAnchor282"/>Internet Explorer enumeration – discovering internal web resources</h2>
<p>I know, I know – Internet Explorer? Really? Even though Chrome and Firefox are all the rage these days, you’ll <a id="_idIndexMarker1037"/>be <a id="_idIndexMarker1038"/>surprised at the role Internet Explorer still plays in the enterprise. And yes, I specified Internet Explorer over Edge.</p>
<p>Enterprises are often running applications on servers and appliances with administrator consoles that are typically accessed through a browser. Why are they not very often optimized for newer browsers? I can’t say for sure; it depends on the vendor. But it’s important to be cognizant of the role Internet Explorer plays. Getting your hands on Internet Explorer history, cookies, and stored credentials will allow you to enumerate important internal resources and inform future attacks against them. If you score some credentials, you may even be able to log in. Make sure to leverage your position at or beyond the foothold when you do this – that way, the application will see a login from a familiar client.</p>
<p>Enumeration is very easy in this case, too; no options to worry about. Just execute <strong class="source-inline">run post/windows/gather/enum_ie</strong> inside your Meterpreter session:</p>
<div>
<div class="IMG---Figure" id="_idContainer306">
<img alt="Figure 15.7 – Raiding Internet Explorer for goodies " height="249" src="image/Figure_15.07_B17616.jpg" width="953"/>
</div>
</div>
<p class="figure-caption">Figure 15.7 – Raiding Internet Explorer for goodies</p>
<p>Despite IE clinging <a id="_idIndexMarker1039"/>on for dear life, you can still raid the target <a id="_idIndexMarker1040"/>for artifacts from modern browsers, too – the <strong class="source-inline">post/windows/gather/forensics/browser_history</strong> module will seek <a id="_idIndexMarker1041"/>out artifacts from Skype, Firefox, and Chrome.</p>
<p>Now that we’ve rummaged through the pockets of our foothold system, let’s start looking at how to take the next step.</p>
<h1 id="_idParaDest-284"><a id="_idTextAnchor283"/>Network pivoting with Metasploit</h1>
<p>Let’s back up to the <a id="_idIndexMarker1042"/>beginning of the chapter, where we found <a id="_idIndexMarker1043"/>our dual-homed Windows 7 box, and look at a real-world foothold and pivot scenario. We have valid credentials, though we only have a password hash that we dumped from another machine. We’ll be <a id="_idIndexMarker1044"/>passing them to our target with the <strong class="source-inline">psexec</strong> exploit. Don’t worry, we’ll take a closer look at <strong class="bold">pass-the-hash</strong> (<strong class="bold">PtH</strong>) attacks shortly. For now, let’s grab our foothold:</p>
<div>
<div class="IMG---Figure" id="_idContainer307">
<img alt="Figure 15.8 – Configuring a psexec module with a captured hash " height="1015" src="image/Figure_15.08_B17616.jpg" width="1089"/>
</div>
</div>
<p class="figure-caption">Figure 15.8 – Configuring a psexec module with a captured hash</p>
<p>We are <a id="_idIndexMarker1045"/>targeting <strong class="source-inline">192.168.108.153</strong>, so we configure the <a id="_idIndexMarker1046"/>target with <strong class="source-inline">set RHOSTS 192.168.108.153</strong>. We use <strong class="source-inline">set SMBPass</strong> to configure our captured credentials, along with <strong class="source-inline">set SMBUser</strong>. Then, we fire off the attack with <strong class="source-inline">run</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer308">
<img alt="Figure 15.9 – Running ipconfig on the target to find additional networks " height="808" src="image/Figure_15.09_B17616.jpg" width="1106"/>
</div>
</div>
<p class="figure-caption">Figure 15.9 – Running ipconfig on the target to find additional networks</p>
<p>Magic sparks fly <a id="_idIndexMarker1047"/>through the air as our Meterpreter session <a id="_idIndexMarker1048"/>is established. The first thing I’ll do is issue a quick <strong class="source-inline">ipconfig</strong> to see what other hosts can be seen at the link layer. Immediately, we can see an additional interface assigned the IP address <strong class="source-inline">192.168.249.153</strong> with a netmask of <strong class="source-inline">255.255.255.0</strong>. Bingo! We’ve compromised a dual-homed host.</p>
<h2 id="_idParaDest-285"><a id="_idTextAnchor284"/>Just a quick review of subnetting</h2>
<p>Remember that an IPv4 <a id="_idIndexMarker1049"/>address is 32 bits long, split into four groups of 8 bits each. With CIDR notation, an IP address is followed by a slash and a number that represents the amount of bits needed to represent the network portion of the address; the remaining bits would then be assigned to hosts. Therefore, you can always subtract the number <a id="_idIndexMarker1050"/>at the end of the CIDR notation from 32 to get the number of bits for host assignment. Let’s look at a couple of examples.</p>
<p><strong class="source-inline">192.168.105.0/24</strong> means that the first 24 bits identify the network. To understand this, let’s see <strong class="source-inline">192.168.105.0</strong> in binary:</p>
<pre class="source-code">11000000.10101000.01101001.00000000</pre>
<p>When assigning addresses in this subnet, we’d only change the final 8 bits, with the highest value, <strong class="source-inline">11111111</strong>, being the broadcast address of this subnet:</p>
<pre class="source-code">11000000.10101000.01101001.<strong class="bold">00000000</strong></pre>
<pre class="source-code">          Network           <strong class="bold">Hosts</strong></pre>
<p>Calculating netmasks from the CIDR notation and vice versa is easy – whatever bits make up the network portion, turn those into all ones and turn the host’s portion into all zeros. Then, convert that value into an IP address. That’ll be your netmask:</p>
<pre class="source-code">11111111.11111111.11111111.<strong class="bold">00000000</strong></pre>
<pre class="source-code">   255     255      255       <strong class="bold">0</strong></pre>
<p>Here’s one more example for the road, <strong class="source-inline">10.14.140.0/19</strong>:</p>
<pre class="source-code">11111111.11111111.111<strong class="bold">00000.00000000</strong></pre>
<pre class="source-code">   255     255      224       <strong class="bold">0</strong></pre>
<p>Now that we’re caught up on our networking basics, let’s look at how we can build routes into our discovered networks for deeper enumeration.</p>
<h2 id="_idParaDest-286"><a id="_idTextAnchor285"/>Launching Metasploit into the hidden network with autoroute</h2>
<p>At the Meterpreter <a id="_idIndexMarker1051"/>prompt, fire off the <strong class="source-inline">run post/multi/manage/autoroute</strong> command. You’ll see that <a id="_idIndexMarker1052"/>the host’s routing table is automatically analyzed:</p>
<div>
<div class="IMG---Figure" id="_idContainer309">
<img alt="Figure 15.10 – Using autoroute with a Meterpreter session " height="218" src="image/Figure_15.10_B17616.jpg" width="1359"/>
</div>
</div>
<p class="figure-caption">Figure 15.10 – Using autoroute with a Meterpreter session</p>
<p>This creates a <a id="_idIndexMarker1053"/>route into <a id="_idIndexMarker1054"/>the hidden subnet, managed by the Meterpreter session on our foothold box (which we will call our pivot point):</p>
<div>
<div class="IMG---Figure" id="_idContainer310">
<img alt="Figure 15.11 – Visual representation of pivoting " height="458" src="image/Figure_15.11_B17616.jpg" width="1044"/>
</div>
</div>
<p class="figure-caption">Figure 15.11 – Visual representation of pivoting</p>
<p>The output is somewhat anticlimactic – but keep in mind that that subnet is now available to Metasploit as if you were on the LAN. To test this theory, I’m going to look for FTP servers on the hidden network. I background my Meterpreter session with the <strong class="source-inline">background</strong> command and jump into the auxiliary modules to grab the native port scanner with <strong class="source-inline">use auxiliary/scanner/portscan/tcp</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer311">
<img alt="Figure 15.12 – Portscanning via our routes " height="149" src="image/Figure_15.12_B17616.jpg" width="669"/>
</div>
</div>
<p class="figure-caption">Figure 15.12 – Portscanning via our routes</p>
<p>Note that <strong class="source-inline">RHOSTS</strong> can <a id="_idIndexMarker1055"/>take a subnet, so I <a id="_idIndexMarker1056"/>set the hidden network with <strong class="source-inline">set RHOSTS 10.0.0.0/24</strong>. Threading can speed up the scan but also overwhelm the network and/or make a lot of noise, so configure <strong class="source-inline">set THREADS</strong> with caution. (Hint: I wouldn’t use <strong class="source-inline">set THREADS 100</strong> in a production network on a gig.) Of course, I’m just looking for FTP, so I configure <strong class="source-inline">set PORTS 21</strong>, but you can add more ports with commas or provide a range. It’s an auxiliary module, so we fire it off with <strong class="source-inline">run</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer312">
<img alt="Figure 15.13 – Completing the port scan via our newly configured route " height="310" src="image/Figure_15.13_B17616.jpg" width="780"/>
</div>
</div>
<p class="figure-caption">Figure 15.13 – Completing the port scan via our newly configured route</p>
<p>We found port <strong class="source-inline">21</strong> open on <strong class="source-inline">192.168.249.154</strong>. Remember that you can’t see this host from your Kali box; this response is courtesy of Meterpreter running on our foothold Windows 7 pivot point and routing traffic to the target network. This is pretty great, but there’s something missing – the ability to fire off our favorite Kali tools outside of the Metasploit Framework, including our own juicy Python scripts we worked so hard on. What we need is a port-forwarding mechanism. Have no fear, Meterpreter heard your cry.</p>
<p>Let’s get back into our established session with <strong class="source-inline">sessions -i 4</strong>. The <strong class="source-inline">-i</strong> flag means <em class="italic">interact</em> and <a id="_idIndexMarker1057"/>the number <strong class="source-inline">4</strong> specifies <a id="_idIndexMarker1058"/>the session. When you’re neck-deep in someone’s network, you might have a dozen Meterpreter sessions established – in which case, <strong class="source-inline">sessions</strong> is your friend. Anyway, let’s get back to our humble single session and execute <strong class="source-inline">portfwd -h</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer313">
<img alt="Figure 15.14 – Configuring portfwd " height="402" src="image/Figure_15.14_B17616.jpg" width="1063"/>
</div>
</div>
<p class="figure-caption">Figure 15.14 – Configuring portfwd</p>
<p>Let’s take a closer look at these options, in a logical order rather than the order in which they appear:</p>
<ul>
<li><strong class="source-inline">-R</strong> is a reverse port forward. I know, I know: <em class="italic">how can you go forward in reverse?</em> This just specifies the direction taken when establishing this route. Why would we need this? The simple way of thinking about port forwarding in a pivoting scenario is that you, the attacker, want to reach a service running on a target via your pivot point. However, think back to our previous chapters when we were hosting the payloads on our machine. We might want the target to have requests forwarded to us via the pivot point. This is a reverse port forward.</li>
<li><strong class="source-inline">-L</strong> specifies the local host. It’s optional except for two scenarios – you’re doing a reverse port forward, or you have multiple local interfaces with different addresses and you need the traffic to pass through a specific one. Note that if you do set this option, you must use the address specified here when connecting through the port forward.</li>
<li><strong class="source-inline">-l</strong> specifies the local port to listen on. You’ll be pointing your tools at the local host and the port specified here in order to reach the target on the desired port.</li>
<li><strong class="source-inline">-i</strong> assigns an <em class="italic">index</em> to your port forward route. You didn’t think we could only have one route at a time, did you? We can have multiple port forwards to multiple hosts and ports. You’ll need indices to keep up.</li>
<li><strong class="source-inline">-p</strong> is the <a id="_idIndexMarker1059"/>remote port <a id="_idIndexMarker1060"/>that we’re forwarding our traffic to. This is where it gets a little confusing if you’re leveraging the reverse port forward: this option is the remote port to listen on. For example, a payload could be configured to connect to the pivot point on port <strong class="source-inline">9000</strong>.</li>
<li><strong class="source-inline">-r</strong> is simply the remote IP address.</li>
</ul>
<p>I create the relay with the <strong class="source-inline">portfwd add -L 192.168.108.211 -l 1066 -p 21 -r 192.168.249.154</strong> command. This tells Meterpreter to establish a local listener on port <strong class="source-inline">1066</strong> and forward any requests to the target on port <strong class="source-inline">21</strong>. In short, the address <strong class="source-inline">192.168.108.211:1066</strong> has just become, for all intents and purposes, <strong class="source-inline">192.168.249.154:21</strong>. Meterpreter will confirm the setup:</p>
<div>
<div class="IMG---Figure" id="_idContainer314">
<img alt="Figure 15.15 – New portfwd relay up and running " height="102" src="image/Figure_15.15_B17616.jpg" width="1168"/>
</div>
</div>
<p class="figure-caption">Figure 15.15 – New portfwd relay up and running</p>
<p>Go ahead and point your tools at this proxy. Just to confirm access, I try to connect to the local listener with netcat:</p>
<div>
<div class="IMG---Figure" id="_idContainer315">
<img alt="Figure 15.16 – Chatting with a service behind the foothold " height="92" src="image/Figure_15.16_B17616.jpg" width="454"/>
</div>
</div>
<p class="figure-caption">Figure 15.16 – Chatting with a service behind the foothold</p>
<p>Here we are, chatting with a service running on another subnet that our Kali box can’t see. If you’ve just finished the previous chapter, then you will recognize the FTP service running here as the vulnerable one we just learned how to compromise. With your foothold and an established pivot point, you now have a paved road straight to delivering shellcode on a machine deeper in the target network.</p>
<p>There’s an <a id="_idIndexMarker1061"/>important clue for <a id="_idIndexMarker1062"/>understanding how this works on the FTP server at the end of our <strong class="source-inline">portfwd</strong> chain. Check out what this looks like on the FTP server when we run a netstat:</p>
<div>
<div class="IMG---Figure" id="_idContainer316">
<img alt="Figure 15.17 – Running netstat on the target FTP server " height="45" src="image/Figure_15.17_B17616.jpg" width="869"/>
</div>
</div>
<p class="figure-caption">Figure 15.17 – Running netstat on the target FTP server</p>
<p>Is that the IP address of your Kali box? Of course not – that’s the Meterpreter host that we’ve compromised. We can thus exploit trust relationships to bypass firewalls using this method. Now that we’re here, it’s time to exploit these new channels to conduct some attacks down the line.</p>
<h1 id="_idParaDest-287"><a id="_idTextAnchor286"/>Escalating your pivot – passing attacks down the line</h1>
<p>Let me paint a scenario for you. From inside the restricted network you were able to plug into, you’ve just <a id="_idIndexMarker1063"/>established your foothold on a Windows 7 Enterprise machine with a NIC facing an internal <strong class="source-inline">192.168.249.0/24</strong> network. You can’t see this network from your position, so using your Meterpreter session, you establish routing via your Windows 7 pivot point. After some further reconnaissance, you determine that <strong class="source-inline">192.168.249.128</strong> is running an FTP service. However, you can’t connect to it from your pivot point. After watching the LAN, you notice traffic passing between <strong class="source-inline">192.168.249.128</strong> and <strong class="source-inline">192.168.249.130</strong>, so you suspect a trust relationship between those two hosts. You also see the Windows user <strong class="source-inline">Phil</strong> frequently, so it could be an administrator’s account that is used on different machines or a shared local account for the purposes of setting up these hosts.</p>
<p>I already tried to pivot to <strong class="source-inline">192.168.249.128:21</strong> with <strong class="source-inline">portfwd</strong>, and I tried connecting with the Win 7 pivot point’s native FTP client, but no cigar. There’s a firewall blocking our traffic. It seems we have a better shot from <strong class="source-inline">192.168.249.130</strong>, but that host is on the hidden network. This means we’ll need to leverage our pivot point to compromise a host beyond our <a id="_idIndexMarker1064"/>foothold. Let’s take a look at how we can leverage what we’ve captured so far to escalate beyond the foothold.</p>
<h2 id="_idParaDest-288"><a id="_idTextAnchor287"/>Using your captured goodies</h2>
<p>In pen testing, you’ll do the occasional bit of off-the-cuff magic. Most of the time, however, you’ll be <a id="_idIndexMarker1065"/>relying on simple, tried-and-true methods to take small steps elsewhere in the enterprise. One such trick is reusing credentials that you find. I don’t care if I find a password under someone’s keyboard (yes, people still do that) or after shoulder surfing someone logging into a teller system in a bank – I always know I can be surprised at what that password will get me into. Let me tell you a couple of war stories to demonstrate what I mean:</p>
<ul>
<li>I was once on an assessment at a financial institution when I managed to get domain administrator access. I extracted all the hashes from the domain to crack offline. One of the passwords that I recovered in cleartext was for an account called <strong class="source-inline">BESAdmin</strong>, which is associated with BlackBerry Enterprise. Weeks later, I was at a totally different client, but I noticed during the assessment that their IT services contractor was the same company as used by the  previous client. I found a <strong class="source-inline">BESAdmin</strong> account there, too. When I got to the third client using the same contractor with another <strong class="source-inline">BESAdmin</strong> account, I tried to log in with the recovered password and voilà – it worked. The convenience of a single password allowed me to effectively compromise a domain administrator account for dozens of companies that used that contractor.</li>
<li>I was at another client site for a company that manages paid-parking structures. At the entrance of these structures is a small machine that accepts a credit card and prints tickets and receipts. All these XP Embedded machines (about 100 in total) check in with a Microsoft SQL database every 5 minutes. You guessed it – they authenticate with a privileged domain account. I was able to downgrade authentication so that the cracking effort took 45 seconds. That password not only got me into the database and all of the payment machines, but it also got me into a few other systems off the domain.</li>
</ul>
<p>Both scenarios depict some practices that aren’t very secure, but what’s interesting is when I present my findings to the IT staff. Most of the time, they are already aware of the implications of these practices! They feel trapped by dated configurations and stubborn management. I’ve had IT administrators pull me aside and thank me for giving them ammunition to deploy a layer of defense they’ve been asking for. I think password attacks are very important because of the total value they can provide to a client.</p>
<p>Let’s get back to <a id="_idIndexMarker1066"/>our scenario and depict a similar attack. We’re going to use credentials on our pivot point to penetrate deeper into the network. This time, however, we don’t have time to crack the password. How can we use a password without cracking it first?</p>
<h2 id="_idParaDest-289"><a id="_idTextAnchor288"/>Quit stalling and Pass-the-Hash – exploiting password equivalents in Windows</h2>
<p>Remember that Windows passwords are special (it isn’t a compliment this time) in that they aren’t salted. If my <a id="_idIndexMarker1067"/>password is <strong class="source-inline">Phil</strong>, then the NTLM hash you find will always be <strong class="source-inline">2D281E7302DD11AA5E9B5D9CB1D6704A</strong>. Windows never stores or transmits a password in any <a id="_idIndexMarker1068"/>readable form; it only verifies hashes. There’s an obvious consequence to this and it’s exploited with the <strong class="bold">Pass-the-Hash</strong> (<strong class="bold">PtH</strong>) attack.</p>
<p>Why did Microsoft decide to not use salts? Microsoft has stated that salting isn’t necessary due to the other security measures in place, but I can’t think of a security practitioner who would agree. The real reason is likely due to those recurring themes in Windows design: backward compatibility and interoperability. A salt is almost like having an extra password for every password, so systems would need mechanisms for exchanging this data securely. This is a tall order, but would it be worth it? Salting is considered a bare-minimum single layer of defense, not a panacea for password security threats.</p>
<p>Check out the following account names and NTLM hashes. The hashes would be difficult to crack without powerful resources (good luck, reader!), so knowing the actual password isn’t an option. What do we know about these accounts and what can we infer about their relationships to other accounts?</p>
<ul>
<li><strong class="source-inline">Administrator</strong>: <strong class="source-inline">5723BB80AB0FB9E9A477C4C090C05983</strong></li>
<li><strong class="source-inline">user</strong>: <strong class="source-inline">3D477F4EAA3D384F823E036E0B236343</strong></li>
<li><strong class="source-inline">updater</strong>: <strong class="source-inline">C4C537BADA97B2D64F82DBDC68804561</strong></li>
<li><strong class="source-inline">Jim-Bob</strong>: <strong class="source-inline">5723BB80AB0FB9E9A477C4C090C05983</strong></li>
<li><strong class="source-inline">Guest</strong>: <strong class="source-inline">45D4E70573820A932CF1CAC1BE2866C2</strong></li>
<li><strong class="source-inline">Exchange</strong>: <strong class="source-inline">7194830BD866352FD9EB0633B781A810</strong></li>
</ul>
<p>That’s right, Eagle Eye, the <strong class="source-inline">Administrator</strong> password is the exact same as the <strong class="source-inline">Jim-Bob</strong> password. With salted hashes, we’d have no way of knowing this fact from just a glance; but in the Windows world, after literally a moment’s review, we know that <strong class="source-inline">Jim-Bob</strong> is using the same password on his personal account as the <strong class="source-inline">Administrator</strong> account. What we can infer, then, is that <strong class="source-inline">Jim-Bob</strong> is the administrator. If we can’t crack the hashes, how does this help us? Well, for one, now we know that targeting <strong class="source-inline">Jim-Bob</strong> with other password attacks such as a phishing scam or key logging provides a decent chance of grabbing the almighty <strong class="source-inline">Administrator</strong> account. Let’s get back to the other consequence of unsalted hashes: the fact that in Windows, the naked hash is a password equivalent, which means passing the hash to an authentication mechanism is literally the same thing as typing the password.</p>
<p>Jump back into your Meterpreter <a id="_idIndexMarker1069"/>session and confirm that you’re running as <strong class="source-inline">SYSTEM</strong>; if not, escalate with <strong class="source-inline">getsystem</strong>. Next, we’ll execute our built-in hash-dumping module with <strong class="source-inline">hashdump</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer317">
<img alt="Figure 15.18 – Using hashdump in a Meterpreter session " height="197" src="image/Figure_15.18_B17616.jpg" width="1339"/>
</div>
</div>
<p class="figure-caption">Figure 15.18 – Using hashdump in a Meterpreter session</p>
<p>You need <a id="_idIndexMarker1070"/>to run as <strong class="source-inline">SYSTEM</strong> to have unchecked access to all of Windows. <strong class="source-inline">getsystem</strong> is a wonderful escalation module that will attempt a few different classic tricks, such as named pipe impersonation and token cloning. We’ll cover this and more in <a href="B17616_16_Final_VK_ePub.xhtml#_idTextAnchor292"><em class="italic">Chapter 16</em></a>, <em class="italic">Escalating Privileges</em>.</p>
<p>The <strong class="source-inline">hashdump</strong> module does the heavy lifting and puts together everything that it finds quite nicely. We’re going to proceed with <strong class="source-inline">psexec</strong> for passing the hash. Background your Meterpreter session with the <strong class="source-inline">background</strong> command so we can configure the <strong class="source-inline">psexec</strong> module. Issue the <strong class="source-inline">use exploit/windows/smb/psexec</strong> command to get the module on deck, then run <strong class="source-inline">show options</strong>. </p>
<p>Now, there are two things to consider here: our <strong class="source-inline">RHOST</strong> and the Meterpreter payload type. Recall that our target, <strong class="source-inline">192.168.249.130</strong>, is not visible from our Kali box, but we’ve established <a id="_idIndexMarker1071"/>routing to the target subnet with the <strong class="source-inline">autoroute</strong> module. Metasploit will automatically route this attack via our pivot point! That being said, that’s also why we’ll use <strong class="source-inline">bind_tcp</strong> instead of connecting back since our Kali box is not visible to the target.</p>
<p>For <strong class="source-inline">set SMBPass</strong>, use the <strong class="source-inline">LM:NTLM</strong> format from <strong class="source-inline">hashdump</strong>. You can mix and match, by the way; for example, we could take the hashes from the <strong class="source-inline">Jim-Bob</strong> account in our preceding example but set <strong class="source-inline">SMBUser</strong> to <strong class="source-inline">Administrator</strong>. This will simply try the <strong class="source-inline">Jim-Bob</strong> unknown password against the <strong class="source-inline">Administrator</strong> account. In our scenario, we’re trying our luck with the <strong class="source-inline">Phil</strong> account. Finally, fire it off with <strong class="source-inline">exploit</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer318">
<img alt="Figure 15.19 – Passing the hash behind the foothold " height="1023" src="image/Figure_15.19_B17616.jpg" width="1281"/>
</div>
</div>
<p class="figure-caption">Figure 15.19 – Passing the hash behind the foothold</p>
<p>Now we’re sporting two fancy Meterpreter sessions – session 1 is via our foothold into the hidden network, and <a id="_idIndexMarker1072"/>session 2 is with the host we suspect has a trust relationship with the FTP server. When you’re playing around in your lab, you may be used to a single Meterpreter session; be prepared to organize your sessions when you leverage Metasploit’s power for pivoting. </p>
<p>Let’s try the good old-fashioned <strong class="source-inline">portfwd</strong> again. By establishing it within our <em class="italic">second</em> Meterpreter session, the traffic will actually come from the trusted host:</p>
<div>
<div class="IMG---Figure" id="_idContainer319">
<img alt="Figure 15.20 – The netcat session via the compromised trusted host " height="348" src="image/Figure_15.20_B17616.jpg" width="922"/>
</div>
</div>
<p class="figure-caption">Figure 15.20 – The netcat session via the compromised trusted host</p>
<p>And there you have it – we’ve <a id="_idIndexMarker1073"/>bypassed a restrictive firewall by compromising the trusted host. It’s one thing to somehow bypass controls directly from our box, leaving a trail of evidence pointing at the IP address associated with a network drop in the conference room near the front door. It’s another thing altogether to see the source as a trusted host inside the firewall. Imagine the potential of chaining targets together as we work our way in.</p>
<h1 id="_idParaDest-290"><a id="_idTextAnchor289"/>Summary</h1>
<p>In this chapter, we introduced some of the options available to us once we’ve established our foothold in a client’s environment. We covered the initial recon and enumeration that allows us to springboard off our foothold into secure areas of the network, including discovering hidden networks after compromising dual-homed hosts, ARP-scanning hidden networks, and the gathering of sensitive and deleted data. From there, we enhanced our understanding of the pivot concept by setting up routes into the hidden network and enabling port forwarding to allow interaction with hosts on the hidden network with Kali’s tools. Finally, we pressed forward by leveraging credentials on our pivot host to compromise a computer inside the perimeter.</p>
<p>In the next chapter, we’ll explore the power of privilege escalation: taking our lowly foothold and turning it into a privileged compromise to gain access to critical resources. Tying this together with the knowledge from this chapter will prepare you for sophisticated movement within the target’s environment.</p>
<h1 id="_idParaDest-291"><a id="_idTextAnchor290"/>Questions</h1>
<p>Answer the following questions to check your knowledge of this chapter:</p>
<ol>
<li>I have just established a Meterpreter session with a dual-homed host, so I configure and execute the <strong class="source-inline">portscan</strong> module to search for hosts on the other network. I am curious about the status of the scan, so I pull up Wireshark on my machine. There’s no scan traffic visible. What’s wrong?</li>
<li>I just issued the following command in Meterpreter, but nothing happened: <strong class="source-inline">execute -f ipconfig</strong>. Why didn’t I see the output of <strong class="source-inline">ipconfig</strong>?</li>
<li>I don’t need to specify ________ when running a module within Meterpreter, since the command is sent to that system only.</li>
<li>A deep packet analysis of the Meterpreter ARP scan will reveal the IP address of our attacking Kali box. (True | False)</li>
<li>Using fewer threads during a Meterpreter port scan reduces the risk of our traffic tripping an IDS. (True | False)</li>
<li>When configuring a PtH attack, the salt must be specified. (True | False)</li>
<li>My PtH attack works because I see a new Meterpreter session; however, it dies about 2 seconds later. Is there anything I can do to keep the session alive?</li>
</ol>
<h1 id="_idParaDest-292"><a id="_idTextAnchor291"/>Further reading</h1>
<p>For more information regarding the topics that were covered in this chapter, take a look at the following resources:</p>
<ul>
<li>Microsoft TechNet presentation and discussion on PtH attacks (<a href="https://technet.microsoft.com/en-us/dn785092.aspx">https://technet.microsoft.com/en-us/dn785092.aspx</a>)</li>
</ul>
</div>
</div></body></html>