<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer345">
<h1 id="_idParaDest-293"><em class="italic"><a id="_idTextAnchor292"/>Chapter 16</em>: Escalating Privileges</h1>
<p>When we consider the penetration of any system – whether it’s a computer system or physical access to a building, for example – no one is the king of the castle when the initial compromise takes place. That’s what makes real-world attacks so insidious and hard to detect; the attackers work their way up from such an insignificant position that no one sees them coming. For example, take the physical infiltration of a secure building. After months of research, I’m finally able to swipe the janitor’s key and copy it without him knowing. Now, I can get into the janitor’s closet at the periphery of the building. Do I own the building? No. Do I have a foothold that will likely allow me a perspective that wasn’t possible before? Absolutely. Maybe pipes and wires are passing through the closet. Maybe the closet is adjacent to a secure room.</p>
<p>The principle of privilege escalation involves leveraging what’s available in our low-privilege position to increase our permissions. This may involve stealing access that belongs to a high-privilege account or exploiting a flaw that tricks a system into executing something at an elevated privilege. We’ll take a look at both perspectives in this chapter by covering the following topics:</p>
<ul>
<li>Climbing the ladder with Armitage</li>
<li>Local exploits with Metasploit</li>
<li>Escalation with WMIC and PS Empire</li>
<li>Looting domain controllers with vssadmin</li>
</ul>
<h1 id="_idParaDest-294"><a id="_idTextAnchor293"/>Technical requirements</h1>
<p>For this chapter, you will need the following:</p>
<ul>
<li>Kali Linux</li>
<li>Windows 7 SP1 running on a VM</li>
<li>Windows Server 2012 configured as a domain controller</li>
</ul>
<h1 id="_idParaDest-295"><a id="_idTextAnchor294"/>Climbing the ladder with Armitage</h1>
<p>Privilege<a id="_idIndexMarker1074"/> escalation is a funny topic nowadays because the tools at our disposal do so much behind the scenes. It’s easy to take systems for granted when we’re playing with Metasploit and the Armitage frontend. In a Meterpreter session, for example, we can execute <strong class="source-inline">getsystem</strong>, and often, we get the <strong class="source-inline">SYSTEM</strong> privilege in a matter of seconds. How is this accomplished so effortlessly? First, we’ll look at a couple of core concepts in Windows: named pipes and security contexts.</p>
<h2 id="_idParaDest-296"><a id="_idTextAnchor295"/>Named pipes and security contexts</h2>
<p>Yes, you’re right; the<a id="_idIndexMarker1075"/> word <em class="italic">pipe</em> in this <a id="_idIndexMarker1076"/>context<a id="_idIndexMarker1077"/> is related to pipelines in the Unix-like <a id="_idIndexMarker1078"/>world (and, as we covered in <a href="B17616_09_Final_VK_ePub.xhtml#_idTextAnchor165"><em class="italic">Chapter 9</em></a>, <em class="italic">Powershell Fundamentals</em>, pipelines in PowerShell). The pipelines we worked with were unnamed and resided in the shell. The named pipe concept, on the other hand, gives the pipe a name, and by having a name, it utilizes the filesystem so that interaction with it is like interacting with a file. Remember the purpose of our pipelines – to take the output of a command and pipe it as input to another command. This is the easier way of looking at it – behind the scenes, each command fires off a process. So, what the pipe is doing is allowing processes to communicate with each other with shared data. This is just one of several methods for achieving <strong class="bold">inter-process communication</strong> (<strong class="bold">IPC</strong>). Hence, to <a id="_idIndexMarker1079"/>put it together, a named pipe is a file that processes can interact with to achieve IPC.</p>
<p>Don’t forget one of the enduring themes of our adventures through Windows security: Microsoft has always liked doing things their way. Named pipes in Windows have some important distinctions from the concept in Unix-like systems. For one, whereas named pipes can persist beyond the process lifetime in Unix, in Windows, they disappear when the last reference to them disappears. Another Windows quirk is that named pipes, although they work a lot like files, cannot be mounted in the filesystem. They have their own filesystem and are referenced with <strong class="source-inline">\\.\pipe\[name]</strong>. Functions are available to the software developer to work with named pipes (for example, <strong class="source-inline">CreateFile</strong>, <strong class="source-inline">WriteFile</strong>, and <strong class="source-inline">CloseHandle</strong>), but the user isn’t going to see them.</p>
<p>There are some situations in which a named pipe is visible to the user in Windows. You, the wily power user, saw this concept at work while debugging with WinDbg.</p>
<p>Let’s examine the concept, as implemented in Windows, a little deeper. I gave examples of functions for working with named pipes previously. Those are <strong class="source-inline">pipe client</strong> functions. The initial creation of the named pipe can be done with the <strong class="source-inline">CreateNamedPipe</strong> function – a <strong class="source-inline">pipe server</strong> function. The creator of a named pipe is a <strong class="source-inline">pipe server</strong>, and the application attaching to and using the named pipe is a pipe client. The client connects to the server end of the named pipe and uses <strong class="source-inline">CreateFile</strong> and <strong class="source-inline">WriteFile</strong> to communicate with the pipe. Although named pipes can only be created locally, it is possible to work with remote named pipes. The period in the named pipe path is swapped with a hostname to communicate with remote pipes:</p>
<div>
<div class="IMG---Figure" id="_idContainer321">
<img alt="Figure 16.1 – Visual depiction of named pipes " height="375" src="image/Figure_16.01_B17616.jpg" width="1650"/>
</div>
</div>
<p class="figure-caption">Figure 16.1 – Visual depiction of named pipes</p>
<p>The server-client <a id="_idIndexMarker1080"/>terminology is no accident. <strong class="source-inline">pipe server</strong> creates<a id="_idIndexMarker1081"/> the<a id="_idIndexMarker1082"/> named <a id="_idIndexMarker1083"/>pipe and handles pipe client requests.</p>
<h2 id="_idParaDest-297"><a id="_idTextAnchor296"/>Impersonating the security context of a pipe client</h2>
<p>If you’re<a id="_idIndexMarker1084"/> new<a id="_idIndexMarker1085"/> to this concept, you probably read<a id="_idIndexMarker1086"/> the title of this section and thought, <em class="italic">oh, named pipe client impersonation? I wonder what wizard’s hacking tool we’ll be installing next!</em> Nope. This is normal behavior and is implemented with the <strong class="source-inline">ImpersonateNamedPipeClient</strong> function. The security professional in you is probably thinking that allowing security context impersonation in IPC is just plain nutty, but the software designer in you may be familiar with the original innocent logic that allows for more efficient architecture. Suppose that a privileged process creates a named pipe. Thus, you have a situation where pipe client requests are being read and managed by a privileged pipe server. Impersonation allows the pipe server to reduce its privilege while processing pipe client requests. Naturally, allowing impersonation per se means that a pipe server with lower privilege could impersonate a privileged pipe client and do naughty things on the client’s behalf. Well, this won’t do. Thankfully, pipe clients can set flags in their <strong class="source-inline">CreateFile</strong> function calls to limit this impersonation, but they don’t have to. It’s not unusual to see this skipped.</p>
<h2 id="_idParaDest-298"><a id="_idTextAnchor297"/>Superfluous pipes and pipe creation race conditions</h2>
<p>I know <a id="_idIndexMarker1087"/>what<a id="_idIndexMarker1088"/> the hacker in you is saying now: <em class="italic">it seems that the entire named pipe server-client concept relies on the assumption that the named pipe exists and the pipe server is available</em>. A brilliant deduction! A process could very well attempt to connect to the named pipe without knowing whether the pipe server has even created it yet. The server may have crashed, or the server end has simply not been created – regardless, a unique vulnerability appears if this happens: the pipe client’s security context can get snatched up by a process that merely creates the requested pipe! This can easily be exploited in situations where an application is designed to keep requesting a named pipe until it succeeds.</p>
<p>A similar situation occurs when a malicious process creates a named pipe before the legitimate process gets the chance to – a race condition. In the Unix-like world, named pipes are also <a id="_idIndexMarker1089"/>called <strong class="bold">FIFOs</strong> in honor of their <em class="italic">first-in, first-out</em> structure. This is pretty much how flowing through a pipe works, so it’s fitting. Anyway, a consequence of this FIFO structure in a named pipe creation race condition is that the first pipe server to create the named pipe will get the first pipe client that requests it. If you know for a fact that a privileged pipe client is going to be making a specific request, the attacker just needs to be the first in line to usurp the client’s security context.</p>
<h2 id="_idParaDest-299"><a id="_idTextAnchor298"/>Moving past the foothold with Armitage</h2>
<p>Now that we<a id="_idIndexMarker1090"/> have a theoretical background about how <strong class="source-inline">getsystem</strong> does its thing, let’s jump back into leveraging Armitage for the post phase. If it seems like we’re bouncing around a bit, it’s because I think it’s important to know what’s going on behind the scenes when the tool removes the hurdles for you. Armitage, for example, will attempt escalation automatically once you gain your foothold on a target. Let’s take a look.</p>
<p>In this scenario, I’ve just managed to sniff a password off the wire. It’s being used on a local administrative appliance by a user who I know is a server administrator, so on a hunch, I attempt to authenticate to the domain controller. It’s unfortunate how often this works in the real world, but it’s a valuable training opportunity. Anyway, in Armitage, I identify the domain controller, right-click on the icon and select <strong class="bold">Login</strong>, and then select <strong class="bold">psexec</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer322">
<img alt="Figure 16.2 – Pass the Hash in Armitage " height="906" src="image/Figure_16.02_B17616.jpg" width="1275"/>
</div>
</div>
<p class="figure-caption">Figure 16.2 – Pass the Hash in Armitage</p>
<p>The password <a id="_idIndexMarker1091"/>works and the scary lightning bolts entomb the poor server. As I watch, I notice <strong class="bold">NT AUTHORITY\SYSTEM</strong> appear under the host. I authenticated as an administrator and Armitage was nice enough to escalate up to <strong class="source-inline">SYSTEM</strong> for me:</p>
<div>
<div class="IMG---Figure" id="_idContainer323">
<img alt="Figure 16.3 – Depiction of host compromise in Armitage " height="899" src="image/Figure_16.03_B17616.jpg" width="1182"/>
</div>
</div>
<p class="figure-caption">Figure 16.3 – Depiction of host compromise in Armitage</p>
<p>Now, we’re going <a id="_idIndexMarker1092"/>to put some automation into the concept of pivoting – and Armitage makes it too easy.</p>
<h2 id="_idParaDest-300"><a id="_idTextAnchor299"/>Armitage pivoting</h2>
<p>We covered <a id="_idIndexMarker1093"/>pivoting at the MSF console and it was easy enough. Armitage makes the process laughably simple. Remember that Armitage shines as a red-teaming tool, so setting up fast pivots lets even a humble team spread into the network like a plague. </p>
<p>I right-click on the target and select my Meterpreter session, followed by <strong class="bold">Interact</strong>, then <strong class="bold">Command shell</strong>. Now, I can interact with CMD as <strong class="source-inline">SYSTEM</strong>. A quick <strong class="source-inline">ipconfig</strong> reveals the presence of another interface attached to a <strong class="source-inline">10.108.108.0/24</strong> subnet:</p>
<div>
<div class="IMG---Figure" id="_idContainer324">
<img alt="Figure 16.4 – ipconfig on the compromised host within Armitage " height="897" src="image/Figure_16.04_B17616.jpg" width="1184"/>
</div>
</div>
<p class="figure-caption">Figure 16.4 – ipconfig on the compromised host within Armitage</p>
<p>I see you getting out your paper and pencil to write down the subnet mask and gateway. Now, envision<a id="_idIndexMarker1094"/> me reaching out of this book in slow motion to slap it out of your hand. Armitage has you covered and hates it when you work too hard. Let’s right-click on the target and find our Meterpreter session again; this time, select <strong class="bold">Pivoting</strong>, followed by <strong class="bold">Setup</strong>. As you can see, Armitage already knows about the visible subnets. All we need to do is click <strong class="bold">Add Pivot</strong> after selecting the subnet we need to branch into:</p>
<div>
<div class="IMG---Figure" id="_idContainer325">
<img alt="Figure 16.5 – The Add Pivot dialog in Armitage " height="354" src="image/Figure_16.05_B17616.jpg" width="477"/>
</div>
</div>
<p class="figure-caption">Figure 16.5 – The Add Pivot dialog in Armitage</p>
<p>You’ll end up back at the main display. The difference is that now, when a particular scanner asks you for a network range, you can punch in your new one. Armitage has the pivot configured and knows how to route the probes accordingly.</p>
<p>Keeping with the tradition of cool Hollywood-hacker-movie visuals, the pivot is visualized with green arrows pointing at all the hosts that have been learned through the pivot point, from<a id="_idIndexMarker1095"/> which the arrows originate:</p>
<div>
<div class="IMG---Figure" id="_idContainer326">
<img alt="Figure 16.6 – Depiction of host enumeration past the foothold in Armitage " height="900" src="image/Figure_16.06_B17616.jpg" width="1383"/>
</div>
</div>
<p class="figure-caption">Figure 16.6 – Depiction of host enumeration past the foothold in Armitage</p>
<p>One of the important basic facts of the post phase is that it’s iterative. You’ve just put your foot forward, so now, you can direct modules to the systems hidden behind your pivot point. Armitage knows what it’s doing and configures Metasploit behind the scenes, so everything is routed the way it needs to be. Point and click hacking!</p>
<p>At this point, we’ll look at an example of a local exploit – something you’d pull off within your<a id="_idIndexMarker1096"/> established non-SYSTEM session.</p>
<h1 id="_idParaDest-301"><a id="_idTextAnchor300"/>When the easy way fails – local exploits</h1>
<p>Every lab demonstration is going to have certain assumptions built into it. One of the assumptions so far is that Armitage/Metasploit was able to achieve <strong class="source-inline">SYSTEM</strong> via <strong class="source-inline">getsystem</strong>. As we learned in our crash course on named pipes, there are defenses against this sort of thing, and we’re often blind when we execute <strong class="source-inline">getsystem</strong>. It’s always thought of as a mere attempt with no guarantee of results.</p>
<p>Let’s take a look at an example. In this lab computer, we compromised a lowly user account with snatched credentials. After verifying that I’m running as a low-privilege account (called <strong class="bold">User</strong>) with <strong class="source-inline">getuid</strong>, I background <a id="_idIndexMarker1097"/>the session and execute <strong class="source-inline">search exploits local</strong>. This query will search through all exploits with <strong class="source-inline">local</strong> as a keyword. Before we fire off our chosen local escalation exploit, let’s take a stroll back through kernel land, where the local escalation vulnerability is quite the pest.</p>
<h2 id="_idParaDest-302"><a id="_idTextAnchor301"/>Kernel pool overflow and the danger of data types</h2>
<p>There’s a function <a id="_idIndexMarker1098"/>in the <a id="_idIndexMarker1099"/>Windows kernel that’s responsible for getting messages from a sending thread that have been forwarded over to the receiving thread for interthread communication: <strong class="source-inline">xxxInterSendMsgEx</strong>. Certain message types need a buffer returned, so allocated space needs to be defined; a call to the <strong class="source-inline">Win32AllocPoolWithQuota</strong> function is made after determining the needed buffer size. How this is determined is important. There are two considerations: the message type and the arguments that were passed to the system call requiring the message to be sent. If the expected returned data is a string, then we have the question of how the characters are encoded; good ol’-fashioned ASCII or WCHAR. Whereas ASCII is a specific character encoding with a standardized size of 8 bits per character, WCHAR means <em class="italic">wide character</em> and more broadly refers to character sets that use more space than 8 bits. Back in the <a id="_idIndexMarker1100"/>late 1980s, the <strong class="bold">Universal Coded Character Set</strong> (<strong class="bold">UCS</strong>) appeared, standardized as ISO/IEC 10646. It was designed to support multiple languages and could use 16 or even 32 bits per character. The UCS character repertoire is synchronized with the popular Unicode standard, and today’s popular Unicode encoding formats include UTF-8, UTF-16, and UTF-32, with only UTF-8 having the same space requirement per character as ASCII. Thus, allocating space for the ASCII-encoded message <strong class="source-inline">Hello, World!</strong> will require 13 bytes of memory. However, in a 32-bit WCHAR format, I’ll need 52 bytes for the same message. </p>
<p>Back to the inter-thread communication in the kernel, the <strong class="source-inline">CopyOutputString</strong> function goes about its business of filling up the kernel buffer while converting characters as needed using two criteria – the data type of the receiving window and the requested data type of the last argument passed to the message call. This gives us a total of four combinations that are handled in four different ways, as follows:</p>
<div>
<div class="IMG---Figure" id="_idContainer327">
<img alt="Table 16.1" height="497" src="image/Table_16.01_B17616.jpg" width="1376"/>
</div>
</div>
<p>The key here is that these different actions will result in different data lengths, but the buffer has already been allocated by <strong class="source-inline">xxxInterSendMsgEx</strong> via <strong class="source-inline">Win32AllocPoolWithQuota</strong>. I think you see where this is going, so let’s fast forward to our Metasploit module, which is ready to create a scenario whereby the pool will <a id="_idIndexMarker1101"/>overflow, allowing<a id="_idIndexMarker1102"/> us to execute code with kernel power.</p>
<h2 id="_idParaDest-303"><a id="_idTextAnchor302"/>Let’s get lazy – Schlamperei privilege escalation on Windows 7</h2>
<p>This particular<a id="_idIndexMarker1103"/> kernel flaw was addressed<a id="_idIndexMarker1104"/> by Microsoft with the bulletin MS13-053 and its associated patches. The Metasploit module that locally exploits MS13-053 is<a id="_idIndexMarker1105"/> called <strong class="bold">Schlamperei</strong>. It’s borrowed from German and means laziness, sloppiness, and inefficiency. Think that’s unfair? Set it up in Metasploit with <strong class="source-inline">use exploit/windows/local/ms13_053_schlamperei</strong> and then <strong class="source-inline">show options</strong>. Prepare yourself for a long list of options!</p>
<p>I’m just kidding – there’s only one option, and that’s for defining the Meterpreter session where this will be attempted:</p>
<div>
<div class="IMG---Figure" id="_idContainer328">
<img alt="Figure 16.7 – Local escalation to SYSTEM via the exploit module " height="801" src="image/Figure_16.07_B17616.jpg" width="1302"/>
</div>
</div>
<p class="figure-caption">Figure 16.7 – Local escalation to SYSTEM via the exploit module</p>
<p>This is just <a id="_idIndexMarker1106"/>one <a id="_idIndexMarker1107"/>quick and dirty example, so I encourage you to review all of the local exploits at your disposal. Get familiar with them and their respective vulnerabilities and target types.</p>
<p>Now, we’re going to dive into the magic world of leveraging Windows’ built-in administrative abilities.</p>
<h1 id="_idParaDest-304"><a id="_idTextAnchor303"/>Escalation with WMIC and PS Empire</h1>
<p>Let’s get the<a id="_idIndexMarker1108"/> basic <a id="_idIndexMarker1109"/>definitions out of the way. WMIC is the name of a tool and it stands for <strong class="bold">Windows Management Instrumentation Command</strong>. The command part refers to a command-line interface; presumably, WMICLI was deemed too long. The tool allows us to perform WMI operations. WMI is the Windows infrastructure for operations and management data. In addition to providing management data to other parts of Windows and other products altogether, it’s possible to automate administrative tasks both locally and remotely with WMI scripts and applications. Often, administrators access this interface through PowerShell. Keep in mind that proper treatment of WMIC deserves its own book, so consider this an introduction. There are great resources online and in bookstores if you’re curious.</p>
<p>For now, we’re interested in this remote administration stuff I just mentioned. There are a couple of important facts for us to consider as a pen tester, as follows:</p>
<ul>
<li>WMIC commands fired off at the command line leave no traces of software or code lying around. While WMI activity can be logged, many organizations fail to turn it on or review the logs. WMI is another Windows feature that tends to fly under the radar.</li>
<li>In almost any Windows environment, WMI and PowerShell can’t be blocked.</li>
</ul>
<p>Bringing this together, we realize that we can use WMIC to remotely administer a Windows host while leveraging the target’s PowerShell functionality.</p>
<h2 id="_idParaDest-305"><a id="_idTextAnchor304"/>Quietly spawning processes with WMIC</h2>
<p>For this exercise, I’m <a id="_idIndexMarker1110"/>recruiting a Windows 7 attack PC for firing off WMI commands against a Windows Server 2012 target. You now have two attackers – Kali and Windows.</p>
<p>Let’s poke around with WMIC for a minute to get an idea of what it looks like. Open up the <strong class="source-inline">CMD</strong> command prompt and execute <strong class="source-inline">wmic</strong>. This will put you in an interactive session. Now, execute <strong class="source-inline">useraccount list /format:list</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer329">
<img alt="Figure 16.8 – User accounts from WMIC " height="497" src="image/Figure_16.08_B17616.jpg" width="572"/>
</div>
</div>
<p class="figure-caption">Figure 16.8 – User accounts from WMIC</p>
<p>WMIC returns local <a id="_idIndexMarker1111"/>user accounts in a handy format. Not terribly exciting. Where the fun lies is in remote administration. Now, try using the <strong class="source-inline">node:[IP address] /user:[DOMAIN]\[User] computersystem list brief /format:list</strong> command. You’ll be prompted for the user’s password:</p>
<div>
<div class="IMG---Figure" id="_idContainer330">
<img alt="Figure 16.9 – System information from WMIC " height="160" src="image/Figure_16.09_B17616.jpg" width="821"/>
</div>
</div>
<p class="figure-caption">Figure 16.9 – System information from WMIC</p>
<p>Well now, this is a little more interesting. The fun isn’t over yet, though. Try using the <strong class="source-inline">path win32_process call create "calc.exe"</strong> command, while still retaining the <strong class="source-inline">node:[</strong><em class="italic">IP address</em><strong class="source-inline">] /user:[</strong><em class="italic">DOMAIN</em><strong class="source-inline">]\[</strong><em class="italic">User</em><strong class="source-inline">]</strong> header. Don’t forget to pass <strong class="source-inline">Y</strong> when prompted:</p>
<div>
<div class="IMG---Figure" id="_idContainer331">
<img alt="Figure 16.10 – Executing a process with WMIC " height="140" src="image/Figure_16.10_B17616.jpg" width="832"/>
</div>
</div>
<p class="figure-caption">Figure 16.10 – Executing a process with WMIC</p>
<p>Check that<a id="_idIndexMarker1112"/> out; <strong class="source-inline">Method execution successful</strong>. <strong class="source-inline">Out Parameters</strong> tells us what the host kicked back to us; we can see a PID and a <strong class="source-inline">ReturnValue</strong> of <strong class="source-inline">0</strong> (meaning no errors). Now, head on over to your target system and look for the friendly calculator on the screen. Wait, where is it? Perhaps the command failed after all.</p>
<p>Let’s take a look inside Windows Task Manager:</p>
<div>
<div class="IMG---Figure" id="_idContainer332">
<img alt="Figure 16.11 – The running task from our target’s point of view " height="444" src="image/Figure_16.11_B17616.jpg" width="480"/>
</div>
</div>
<p class="figure-caption">Figure 16.11 – The running task from our target’s point of view</p>
<p>It did execute <strong class="source-inline">calc.exe</strong>. Confirm the PID as well – it’s the instance that was kicked off by our <a id="_idIndexMarker1113"/>command. If you’ve ever written scripts or other programs that launch a process, even when you try to hide it, seeing a command window flicker on the screen for a split second is a familiar experience and we usually hope the user won’t see it. Quietly kicking off PowerShell? Priceless.</p>
<h2 id="_idParaDest-306"><a id="_idTextAnchor305"/>Creating a PowerShell Empire agent with remote WMIC</h2>
<p>Let’s fire up <a id="_idIndexMarker1114"/>Empire<a id="_idIndexMarker1115"/> with <strong class="source-inline">./empire</strong> (inside its directory) and configure a listener. At the main prompt, type <strong class="source-inline">listeners</strong> followed by <strong class="source-inline">uselistener http</strong>. Name it whatever you like, though I called it WMIC to distinguish this attack:</p>
<div>
<div class="IMG---Figure" id="_idContainer333">
<img alt="Figure 16.12 – Setting up our listener in Powershell Empire " height="270" src="image/Figure_16.12_B17616.jpg" width="1381"/>
</div>
</div>
<p class="figure-caption">Figure 16.12 – Setting up our listener in Powershell Empire</p>
<p>Back at the main menu, you can execute <strong class="source-inline">listeners</strong> again to confirm that it’s up and running. Now, we need a stager. Keep in mind that stagers are PowerShell commands wrapped up in something designed to get them executed. For example, you could generate a BAT file that you then have to get onto the target machine to have executed. Here, we’re using WMI to create a process remotely – we just need the raw command. Therefore, the specific stager you choose is less important because we’re just nabbing the command out of it. In my case, I picked the BAT file option by executing <strong class="source-inline">usestager</strong> <strong class="source-inline">windows/launcher_bat</strong>. The only option that matters right now is configuring the listener to associate the resulting agent with – remember the name you set earlier. If you <a id="_idIndexMarker1116"/>did <a id="_idIndexMarker1117"/> WMIC like me, then the command is <strong class="source-inline">set Listener WMIC</strong> (don’t forget that it’s case-sensitive). Fire off <strong class="source-inline">execute</strong> and your BAT file will be dropped into the <strong class="source-inline">tmp</strong> folder. Open it up with your favorite editor and extract the PowerShell command on its own:</p>
<div>
<div class="IMG---Figure" id="_idContainer334">
<img alt="Figure 16.13 – Creating our launcher BAT file linked to the listener " height="187" src="image/Figure_16.13_B17616.jpg" width="1353"/>
</div>
</div>
<p class="figure-caption">Figure 16.13 – Creating our launcher BAT file linked to the listener</p>
<p>As a testament to how clever antimalware vendors can be, I tried to send an Empire staging command as a <strong class="source-inline">TXT</strong> file through Gmail and it was flagged as a virus. I was hoping that using plaintext would make things easier, but sure enough, it was yet another hurdle for the bad guys.</p>
<p>Now, let’s head back to the Windows attack machine, PowerShell command in tow. I’m preparing my WMIC command against the target. Note that I’m not using the interactive session. That’s because it has a character limit, and you’ll need as much space as you can get with this long string. Therefore, I dump it into an ordinary CMD session and pass the command as an argument to <strong class="source-inline">wmic</strong>.</p>
<p>Don’t forget that the <strong class="source-inline">win32_process call create</strong> argument must be wrapped in quotation marks.</p>
<p>I wish I could tell you that this will feel like one of those action movies where the tough guy casually walks away from an explosion without turning around to look at it, but in reality, it will look like the calculator spawn. You’ll get a PID and <strong class="source-inline">ReturnValue = 0</strong>. I encourage you to imagine the explosion thing anyway:</p>
<div>
<div class="IMG---Figure" id="_idContainer335">
<img alt="Figure 16.14 – Dropping the command in WMIC " height="358" src="image/Figure_16.14_B17616.jpg" width="1385"/>
</div>
</div>
<p class="figure-caption">Figure 16.14 – Dropping the command in WMIC</p>
<p>Let’s hop on over to the Kali attacker where our Empire listener was faithfully waiting for the agent to report back to base. Sure enough, we can see our new agent configured and ready to<a id="_idIndexMarker1118"/> be<a id="_idIndexMarker1119"/> tasked. Try the <strong class="source-inline">info</strong> command to confirm the host and the username whose security context the agent is using. Note that the PID is displayed here, too – it will match the PID from your WMIC Out Parameters.</p>
<h2 id="_idParaDest-307"><a id="_idTextAnchor306"/>Escalating your agent to SYSTEM via access token theft</h2>
<p>Just last <a id="_idIndexMarker1120"/>week, I <a id="_idIndexMarker1121"/>went <a id="_idIndexMarker1122"/>to the county fair with my family. My daughter went on her first roller coaster, my wife saw pig racing, and we drank slushy lemonade until we were all sugared out. When you first arrive, you go to the ticket booth and buy one of two options – a book of individual tickets that you can use like cash to access the rides or a wristband that gives you unlimited access to everything. Access tokens in Windows are similar (minus the pig racing part). When a user successfully authenticates to Windows, an access token is generated. Every process that’s executed on behalf of that user will have a copy of this token, and the tokens are used to verify the security context of the process or thread that possesses it. This way, you don’t have numerous pieces operating under a given user, requiring password authentication.</p>
<p>Suppose, however, that someone stole my wristband at the county fair. That person could then ride on the carousel with my privileges, even though the wristband was obtained via a legitimate cash transaction. There are methods for stealing a token from a process running in the <strong class="source-inline">SYSTEM</strong> security context, giving us full control. Now that we have an agent running on our target, let’s task it with token theft. First, we need to know what processes are running. Remember that we can use <strong class="source-inline">tasklist</strong> to see what’s running<a id="_idIndexMarker1123"/> and <a id="_idIndexMarker1124"/>capture <a id="_idIndexMarker1125"/>the PIDs for everything.</p>
<p>Task the Empire agent with <strong class="source-inline">shell tasklist</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer336">
<img alt="Figure 16.15 – tasklist in our PowerShell Empire session " height="818" src="image/Figure_16.15_B17616.jpg" width="1393"/>
</div>
</div>
<p class="figure-caption">Figure 16.15 – tasklist in our PowerShell Empire session</p>
<p>After identifying a process ID to rob, task the agent with <strong class="source-inline">steal_token</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer337">
<img alt="Figure 16.16 – SYSTEM token stolen! " height="367" src="image/Figure_16.16_B17616.jpg" width="1264"/>
</div>
</div>
<p class="figure-caption">Figure 16.16 – SYSTEM token stolen!</p>
<p>Now, let’s look<a id="_idIndexMarker1126"/> at <a id="_idIndexMarker1127"/>raiding <a id="_idIndexMarker1128"/>a compromised domain controller. Once again, we’ll be living off the land by leveraging Windows administrative tools.</p>
<h1 id="_idParaDest-308"><a id="_idTextAnchor307"/>Dancing in the shadows – looting domain controllers with vssadmin</h1>
<p>So, you achieved <a id="_idIndexMarker1129"/>domain administrator in your client’s environment. Congratulations! Now what?</p>
<p>In a section about pressing forward from initial compromise and a chapter about escalating privileges, we need a little outside-of-the-box thinking. We’ve covered a lot of technical ground, but don’t forget the whole idea – you’re conducting an assessment for a client, and the value of your results isn’t just a bunch of screenshots with green text in them. When you’re having a drink with your hacker friends and you tell them about your domain administrator compromise, they understand what that means. But when you’re presenting your findings for the executive management of a client? I’ve had countless executives ask me point-blank, so what? Shaking them by the shoulders while shouting I got domain admin by sniffing their printer isn’t going to convince anyone. Now, let me contrast that with the meetings I’ve had with clients in which I tell them that I now have 68% of their 3,000 employees’ passwords in a spreadsheet, with more coming in every hour. I promise you, that will get their attention.</p>
<p>When it comes to looting an environment for passwords, there are different ways of doing it and they all have different implications. For example, walking around an office looking for passwords written down is surprisingly effective. This would normally happen during a physical assessment, but we used to occasionally do this as part of an audit with no sneaking around necessary. This sort of thing may get you on a security camera’s footage. We’ve covered some of the technical methods too – pretty much anything involving a payload can be detected by antivirus software. Whenever you can leverage built-in mechanisms for a task, you stand less risk of setting off alarms. We learned this with PowerShell. There’s another administrative tool that, depending on the environment, may be allowed as part of a backup procedure: <strong class="source-inline">vssadmin</strong>, the Volume Shadow Copy Service administration tool.</p>
<p>Shadow copies are also called snapshots; they’re copies of replicas, which are point-in-time backups of protected files, shares, and folders. Replicas are created by the <strong class="bold">Data Protection Manager</strong> (<strong class="bold">DPM</strong>) server. After<a id="_idIndexMarker1130"/> the initial creation of a replica, it’s periodically updated with deltas to the protected data. The shadow copy is<a id="_idIndexMarker1131"/> a full copy of the data as of the last synchronization. We care about it here because, in every environment that I’ve ever worked in, the Windows system is included in the replica, including two particularly tasty little files: <strong class="source-inline">NTDS.dit</strong> and the <strong class="source-inline">SYSTEM</strong> registry hive. <strong class="source-inline">NTDS.dit</strong> is the actual database file for Active Directory; as such, it’s only found on domain controllers. The <strong class="source-inline">SYSTEM</strong> hive is a critical component of the Windows registry and contains a lot of configuration data and hardware information. However, what we need is the <strong class="source-inline">SYSKEY</strong> key that was used to encrypt the password data.</p>
<p>When you’re ready to poke around, fire up <strong class="source-inline">vssadmin</strong> on your domain controller and take a look at the options:</p>
<div>
<div class="IMG---Figure" id="_idContainer338">
<img alt="Figure 16.17 – vssadmin help screen " height="462" src="image/Figure_16.17_B17616.jpg" width="1202"/>
</div>
</div>
<p class="figure-caption">Figure 16.17 – vssadmin help screen</p>
<p>Let’s dive into <a id="_idIndexMarker1132"/>how to create a shadow and steal stuff from it.</p>
<h2 id="_idParaDest-309"><a id="_idTextAnchor308"/>Extracting the NTDS database and SYSTEM hive from a shadow copy</h2>
<p>It’s a good idea<a id="_idIndexMarker1133"/> to<a id="_idIndexMarker1134"/> first <a id="_idIndexMarker1135"/>list any <a id="_idIndexMarker1136"/>existing shadow copies with <strong class="source-inline">vssadmin List Shadows</strong>. Sometimes, shadow copies are created regularly, and having a recent snapshot means you can jump ahead to copying out the database and hive. This makes stealth slightly easier. Assuming no shadow copies exist (or they’re old), run the <strong class="source-inline">CMD</strong> prompt as an <strong class="source-inline">Administrator</strong> and create a shadow copy for the C: drive:</p>
<p class="source-code">&gt; vssadmin Create Shadow /For=C:</p>
<p>You’ll see the following confirmation:</p>
<div>
<div class="IMG---Figure" id="_idContainer339">
<img alt="Figure 16.18 – Successful shadow copy " height="98" src="image/Figure_16.18_B17616.jpg" width="641"/>
</div>
</div>
<p class="figure-caption">Figure 16.18 – Successful shadow copy</p>
<p>Make a note of the shadow copy volume name, as you’ll need to refer to it during the copy operation. You’ll just use the good old-fashioned <strong class="source-inline">copy</strong> for this, substituting what you’d normally call <strong class="source-inline">C:</strong> with <strong class="source-inline">\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1</strong>. The NTDS database is stored in the NTDS directory under Windows, and you’ll find <strong class="source-inline">SYSTEM</strong> inside the <strong class="source-inline">system32\config</strong> folder. You can place the files wherever you want; it’s a temporary location as you prepare to exfiltrate them. You should consider how you’ll be getting them off the domain controller, though. For example, if there’s a shared folder that you can access across the network, that’ll be an ideal spot to place them:</p>
<p class="source-code">&gt; copy <strong class="source-inline">\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit</strong> c:\</p>
<p class="source-code">&gt; copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\system32\config\SYSTEM c:\</p>
<p>Again, here’s the confirmation:</p>
<div>
<div class="IMG---Figure" id="_idContainer340">
<img alt="Figure 16.19 – Copying the goods out of the shadow copy " height="92" src="image/Figure_16.19_B17616.jpg" width="641"/>
</div>
</div>
<p class="figure-caption">Figure 16.19 – Copying the goods out of the shadow copy</p>
<p>Now, we <a id="_idIndexMarker1137"/>have <a id="_idIndexMarker1138"/>our<a id="_idIndexMarker1139"/> goodies – but <a id="_idIndexMarker1140"/>they’re sitting on the target. How do we get them home? Let’s take a look at one method.</p>
<h2 id="_idParaDest-310"><a id="_idTextAnchor309"/>Exfiltration across the network with cifs</h2>
<p>I could just <a id="_idIndexMarker1141"/>tell <a id="_idIndexMarker1142"/>you to pick your favorite way of pulling the files off the domain controller. And I will: use your favorite method to get your loot. Sometimes, you can sneakernet them out with a USB stick. For now, let’s review attaching your Kali box to a share, as this will not only be a common way to recover the Active Directory information in this case, but it’s handy for a whole range of tasks in Windows environments. First, we need to install <strong class="source-inline">cifs-utils</strong>. Thankfully, it’s already included in the repository:</p>
<p class="source-code"># apt-get install cifs-utils</p>
<p>Once it’s installed, use <strong class="source-inline">mount -t cifs</strong> to specify the location of the share. Note that I didn’t pass the password as an argument, as that would necessitate exposing it in plaintext. It may not matter during the attack, but you’ll want to be considerate of the screenshot for <a id="_idIndexMarker1143"/>your<a id="_idIndexMarker1144"/> report. Omitting the password will cause you to be prompted for it:</p>
<div>
<div class="IMG---Figure" id="_idContainer341">
<img alt="Figure 16.20 – Target C: drive locally mounted in Kali " height="496" src="image/Figure_16.20_B17616.jpg" width="1198"/>
</div>
</div>
<p class="figure-caption">Figure 16.20 – Target C: drive locally mounted in Kali</p>
<p>There – no explosions, nothing exciting, just a new folder on my system that I can use like any local folder. I’ll use <strong class="source-inline">cp</strong> to nab the files off the domain controller. And just like that, we have the Active Directory database residing in our Kali attack box, and the only thing left behind on the domain controller is the shadow copy that the administrators expect to be there. But wait – what if there were no shadow copies and we had to create one? Then we left behind a shadow copy that is <em class="italic">not</em> expected. <strong class="source-inline">vssadmin Delete Shadows</strong> is your friend for tidying up your tracks. I recommend doing it right after you’ve extracted the files you need from the shadow copy. </p>
<h2 id="_idParaDest-311"><a id="_idTextAnchor310"/>Password hash extraction with libesedb and ntdsxtract</h2>
<p>And now, without <a id="_idIndexMarker1145"/>further <a id="_idIndexMarker1146"/>ado, the<a id="_idIndexMarker1147"/> real <a id="_idIndexMarker1148"/>fun part. When I first started using this technique, the process was a little more tedious; today, you can have everything extracted and formatted for John with only <em class="italic">two</em> commands. There is a caveat, however: We need to prep Kali to build the <strong class="source-inline">libesedb</strong> suite properly. We can have all of this done automatically with utilities such as <strong class="source-inline">autoconf</strong>, a wizard of a tool that will generate scripts that automatically configure the software package. A detailed review of what we are about to install is outside the scope of this discussion, so I encourage you to check out the man pages offline. </p>
<p>Here are the commands, line by line. Let each one finish before proceeding. It may take a few minutes, so go refill your coffee mug:</p>
<p class="source-code"># git clone https://github.com/libyal/libesedb</p>
<p class="source-code"># git clone https://github.com/csababarta/ntdsxtract</p>
<p class="source-code"># cd libesedb</p>
<p class="source-code"># apt-get install git autoconf automake autopoint libtool pkg-config</p>
<p class="source-code"># ./synclibs.sh</p>
<p class="source-code"># ./autogen.sh</p>
<p class="source-code"># chmod +x configure</p>
<p class="source-code"># ./configure</p>
<p class="source-code"># make</p>
<p class="source-code"># make install</p>
<p class="source-code"># ldconfig</p>
<p>If you’re looking at that command and thinking, <em class="italic">isn’t </em><strong class="source-inline">git</strong><em class="italic"> already installed?</em>, then yes, but this command will update it. Keep in mind that you’ll need <strong class="source-inline">pip</strong> for Python 2, so install that with <strong class="source-inline">apt-get install python-pip</strong> if you haven’t already – then, run <strong class="source-inline">python -m pip install pycrypto</strong> to get the low-level crypto modules needed by <strong class="source-inline">ntdsxtract</strong>.</p>
<p>Once everything has been configured and ready to rock, you should be able to just fire off <strong class="source-inline">esedbexport</strong>. We’re going to tell the utility to export all of the tables inside the NTDS database. There are two tables in particular that we need for hash extraction:</p>
<p class="source-code"># esedbexport -m tables ntds.dit</p>
<p>You’ll see the following output:</p>
<div>
<div class="IMG---Figure" id="_idContainer342">
<img alt="Figure 16.21 – Exporting the tables from our captured NTDS.dit file " height="818" src="image/Figure_16.21_B17616.jpg" width="908"/>
</div>
</div>
<p class="figure-caption">Figure 16.21 – Exporting the tables from our captured NTDS.dit file</p>
<p>And<a id="_idIndexMarker1149"/> now, the <a id="_idIndexMarker1150"/>moment<a id="_idIndexMarker1151"/> of truth. We can pass the data table<a id="_idIndexMarker1152"/> and link table to the <strong class="source-inline">dsusers</strong> Python script, along with the location of the <strong class="source-inline">SYSTEM</strong> hive (which contains the <strong class="source-inline">SYSKEY</strong> key), and ask the script to nicely format our hashes into a cracker-friendly format:</p>
<p class="source-code"># cd ntdsxtract</p>
<p class="source-code"># python dsusers.py /root/ntds/ntds.dit.export/datatable /root/ntds/ntds.dit.export/link_table /root/ntds --syshive /root/ntds/SYSTEM --passwordhashes --lmoutfile /root/ntds/lm.txt --ntoutfile /root/ntds/nt.txt --pwdformat ophc</p>
<p>I encourage you to study the actual database contents for things such as password history. This information allowed me to maximize the impact of my findings on clients. Why would I need to do that? Because organizations with aggressive password change policies, such<a id="_idIndexMarker1153"/> as 45<a id="_idIndexMarker1154"/> days, will sometimes try to argue that none of my hashes are valid. And <a id="_idIndexMarker1155"/>sometimes, they’re<a id="_idIndexMarker1156"/> right. Check the histories; the ones where the user who just logged in the day before the assessment are probably using the same password:</p>
<div>
<div class="IMG---Figure" id="_idContainer343">
<img alt="Figure 16.22 – Extracted domain records " height="1689" src="image/Figure_16.22_B17616.jpg" width="1380"/>
</div>
</div>
<p class="figure-caption">Figure 16.22 – Extracted domain records</p>
<p>John knows what to do with the formatted text files. As you can see, I recovered one of my passwords in about 30 seconds when I passed the <strong class="source-inline">john --fork=2 nt.txt</strong> command:</p>
<div>
<div class="IMG---Figure" id="_idContainer344">
<img alt="Figure 16.23 – John successfully recovering a password " height="370" src="image/Figure_16.23_B17616.jpg" width="1393"/>
</div>
</div>
<p class="figure-caption">Figure 16.23 – John successfully recovering a password</p>
<p>Some environments will yield thousands of hashes. Even John running on a humble CPU will start cracking the low-hanging fruit very quickly. Another area to consider for offline research is GPU<a id="_idIndexMarker1157"/> cracking, which<a id="_idIndexMarker1158"/> leverages<a id="_idIndexMarker1159"/> the <a id="_idIndexMarker1160"/>FLOPS of a graphics processor to crack passwords at wild rates. Especially on shorter assessments, it can make a tremendous difference. </p>
<h1 id="_idParaDest-312"><a id="_idTextAnchor311"/>Summary</h1>
<p>In this chapter, we looked behind the scenes at some basic privilege escalation techniques. We reviewed how Metasploit accomplishes this automatically, but also how it may be possible with local exploits. We did a quick review of the post phase with Armitage and revisited pivoting. We reviewed PowerShell Empire and created stealthy agents with remote WMI commands. Then, we looked at using an Empire module to steal access tokens while reviewing the underlying concept. Finally, we explored a technique for extracting hashes from a domain controller by exploiting built-in backup mechanisms. Overall, we demonstrated several attacks that employed functionality that is built into Windows, increasing our stealth and providing useful configuration recommendations for the client.</p>
<p>In the final chapter, we’ll be looking at persistence – techniques that allow our established access to persist through reboots and reconfiguration. With a foundation in maintaining our access, we allow ourselves time to gather as much information as possible, hence increasing the value of the assessment for the client.</p>
<h1 id="_idParaDest-313"><a id="_idTextAnchor312"/>Questions</h1>
<p>Answer the following questions to test your knowledge of this chapter:</p>
<ol>
<li>Named pipes are also known as _____ in Unix-like systems.</li>
<li>An ASCII character is always 8 bits long, whereas a WCHAR character is always 16 bits long. (True | False)</li>
<li>What does WMI stand for?</li>
<li>What does IPC stand for?</li>
<li>In addition to a returned error code, a successful remote WMI process call will also return the _____, which you can then use to verify your agent’s context.</li>
<li>Shadow copies are copies of what?</li>
<li>What’s the crucial piece of information contained in the <strong class="source-inline">SYSTEM</strong> hive for extracting hashes from the NTDS database?</li>
</ol>
<h1 id="_idParaDest-314"><a id="_idTextAnchor313"/>Further reading</h1>
<p>For more information regarding the topics that were covered in this chapter, take a look at the following resources:</p>
<ul>
<li>Named pipe documentation: <a href="https://docs.microsoft.com/en-us/windows/desktop/ipc/named-pipes%0D">https://docs.microsoft.com/en-us/windows/desktop/ipc/named-pipes</a></li>
<li>WMI reference documentation: <a href="https://docs.microsoft.com/en-us/windows/desktop/wmisdk/wmi-reference">https://docs.microsoft.com/en-us/windows/desktop/wmisdk/wmi-reference</a> </li>
</ul>
</div>
</div></body></html>