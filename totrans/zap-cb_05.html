<html><head></head><body>
<div class="IMG---Figure" id="_idContainer152">
<h1 class="chapter-number" id="_idParaDest-152"><a id="_idTextAnchor200"/><span class="koboSpan" id="kobo.1.1">5</span></h1>
<h1 id="_idParaDest-153"><a id="_idTextAnchor201"/><span class="koboSpan" id="kobo.2.1">Testing of Session Management</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Welcome to </span><a href="B18829_05.xhtml#_idTextAnchor200"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.4.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.5.1">! </span><span class="koboSpan" id="kobo.5.2">In this chapter, we will walk you through the recipes related to session management. </span><span class="koboSpan" id="kobo.5.3">The topics covered in this chapter will showcase to you how to use OWASP ZAP to capture and use session tokens that can then be used in multiple types </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">of attacks.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.9.1">Testing for </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">cookie attributes</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Testing for cross-site request </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">forgery (CSRF)</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Testing for </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">logout functionality</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Testing for </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">session hijacking</span></span></li>
</ul>
<h1 id="_idParaDest-154"><a id="_idTextAnchor202"/><span class="koboSpan" id="kobo.17.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.18.1">For this chapter, you will need to install OWASP ZAP Proxy and OWASP Juice Shop on your machine to intercept traffic between the browser and OWASP Juice Shop. </span><span class="koboSpan" id="kobo.18.2">In addition, utilize your PortSwigger account for access to the PortSwigger Academy labs that will be used in this chapter’s recipes. </span><span class="koboSpan" id="kobo.18.3">Lastly, the use of the Mutillidae II Docker environment is required to complete some of </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">the attacks.</span></span></p>
<h2 id="_idParaDest-155"><a id="_idTextAnchor203"/><span class="koboSpan" id="kobo.20.1">Mutillidae setup</span></h2>
<p><span class="koboSpan" id="kobo.21.1">Mutillidae is </span><a id="_idIndexMarker258"/><span class="koboSpan" id="kobo.22.1">an open source, insecure, and vulnerable web application used for training and learning with various types of vulnerability to be exploited with hints and help. </span><span class="koboSpan" id="kobo.22.2">This will help </span><a id="_idIndexMarker259"/><span class="koboSpan" id="kobo.23.1">you learn how to perform attacks ranging </span><a id="_idIndexMarker260"/><span class="koboSpan" id="kobo.24.1">from easy to more complicated. </span><span class="koboSpan" id="kobo.24.2">You can find more information about the project at </span><a href="https://owasp.org/www-project-mutillidae-ii/"><span class="koboSpan" id="kobo.25.1">https://owasp.org/www-project-mutillidae-ii/</span></a><span class="koboSpan" id="kobo.26.1">. </span><span class="koboSpan" id="kobo.26.2">We are going to be using the Docker image for the simplicity </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">of setup.</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.28.1">The first step is to git clone or download the </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">GitHub repository:</span></span></li>
</ol>
<p><a href="https://github.com/Nanjuan/mutillidae-docker-nes"><span class="No-Break"><span class="koboSpan" id="kobo.30.1">https://github.com/Nanjuan/mutillidae-docker-nes</span></span></a></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.31.1">Once you have downloaded the GitHub repository, navigate to that folder in your terminal and view the file to make sure it looks as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.32.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.33.1">.1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer127">
<span class="koboSpan" id="kobo.35.1"><img alt="Figure 5.1 – Downloaded Mutillidae Repository" src="image/Figure_05.01_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.36.1">Figure 5.1 – Downloaded Mutillidae Repository</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.37.1">When you </span><a id="_idIndexMarker261"/><span class="koboSpan" id="kobo.38.1">are inside the Mutillidae directory, run the following Docker command: </span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.39.1">docker compose up -d</span></strong></pre></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer128">
<span class="koboSpan" id="kobo.40.1"><img alt="Figure 5.2 – Mutillidae directory" src="image/Figure_05.02_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.41.1">Figure 5.2 – Mutillidae directory</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.42.1">Once Docker has finished setting up the environment, open your browser and navigate to localhost. </span><span class="koboSpan" id="kobo.42.2">You might notice that the localhost URL will redirect to </span><strong class="source-inline"><span class="koboSpan" id="kobo.43.1">localhost/database-offline.php</span></strong><span class="koboSpan" id="kobo.44.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.45.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.46.1">.3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer129">
<span class="koboSpan" id="kobo.48.1"><img alt="Figure 5.3 – Localhost of Mutillidae" src="image/Figure_05.03_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.49.1">Figure 5.3 – Localhost of Mutillidae</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.50.1">Next, press </span><a id="_idIndexMarker262"/><span class="koboSpan" id="kobo.51.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.52.1">Click here</span></strong><span class="koboSpan" id="kobo.53.1"> button in </span><em class="italic"><span class="koboSpan" id="kobo.54.1">step 1, </span></em><span class="koboSpan" id="kobo.55.1">as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.56.1">Figure 5</span></em></span><em class="italic"><span class="koboSpan" id="kobo.57.1">.3</span></em><span class="koboSpan" id="kobo.58.1">. </span><span class="koboSpan" id="kobo.58.2">This will pop up a message. </span><span class="No-Break"><span class="koboSpan" id="kobo.59.1">Click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.60.1">OK</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer130">
<span class="koboSpan" id="kobo.62.1"><img alt="Figure 5.4 – Click here message" src="image/Figure_05.04_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.63.1">Figure 5.4 – Click here message</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.64.1">After </span><a id="_idIndexMarker263"/><span class="koboSpan" id="kobo.65.1">you click </span><strong class="bold"><span class="koboSpan" id="kobo.66.1">OK</span></strong><span class="koboSpan" id="kobo.67.1">, the application will redirect to the Mutillidae main page, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.68.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.69.1">.5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.70.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer131">
<span class="koboSpan" id="kobo.71.1"><img alt="Figure 5.5 – Mutillidae home page" src="image/Figure_05.05_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.72.1">Figure 5.5 – Mutillidae home page</span></p>
<p><span class="koboSpan" id="kobo.73.1">This completes </span><span class="No-Break"><span class="koboSpan" id="kobo.74.1">the setup.</span></span><a id="_idTextAnchor204"/></p>
<h1 id="_idParaDest-156"><a id="_idTextAnchor205"/><span class="koboSpan" id="kobo.75.1">Testing for cookie attributes</span></h1>
<p><span class="koboSpan" id="kobo.76.1">Cookies are text files stored by websites on your computer. </span><span class="koboSpan" id="kobo.76.2">Websites utilize cookies to track users’ activities, provide a personalized experience, and/or for session management. </span><span class="koboSpan" id="kobo.76.3">Therefore, in most cases, cookies contain a wealth of private information about users, which makes them a target </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">for criminals.</span></span></p>
<p><span class="koboSpan" id="kobo.78.1">Due to the </span><a id="_idIndexMarker264"/><span class="koboSpan" id="kobo.79.1">sensitivity of the data that could be stored in the cookies, the industry has created cookie attributes to help secure the cookie’s data. </span><span class="koboSpan" id="kobo.79.2">Here are the attributes that could be set and an explanation of </span><span class="No-Break"><span class="koboSpan" id="kobo.80.1">each one:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.81.1">The </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.82.1">Secure attribute</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.83.1">:</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.84.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.85.1">Secure</span></strong> <a id="_idIndexMarker265"/><span class="koboSpan" id="kobo.86.1">attribute ensures that the cookie is </span><a id="_idIndexMarker266"/><span class="koboSpan" id="kobo.87.1">sent over HTTPS to prevent </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">man-in-the-middle attacks.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.89.1">The </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.90.1">HttpOnly attribute</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">:</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.92.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">HttpOnly</span></strong> <a id="_idIndexMarker267"/><span class="koboSpan" id="kobo.94.1">attribute is set to prevent </span><a id="_idIndexMarker268"/><span class="koboSpan" id="kobo.95.1">client-side scripts from accessing the cookie data. </span><span class="koboSpan" id="kobo.95.2">This attribute is used as another layer of protection against cross-site </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">scripting attacks.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.97.1">The </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.98.1">Domain attribute</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">:</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.100.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.101.1">Domain</span></strong> <a id="_idIndexMarker269"/><span class="koboSpan" id="kobo.102.1">attribute is used to set the scope </span><a id="_idIndexMarker270"/><span class="koboSpan" id="kobo.103.1">of where the cookie can be used. </span><span class="koboSpan" id="kobo.103.2">If the domain in the request URL does not match the domain in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1">Domain</span></strong><span class="koboSpan" id="kobo.105.1"> attribute, the cookie will </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">be invalid.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.107.1">The </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.108.1">Path attribute</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">:</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.110.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">Path</span></strong> <a id="_idIndexMarker271"/><span class="koboSpan" id="kobo.112.1">attribute is set to specify the path the cookie can use. </span><span class="koboSpan" id="kobo.112.2">If the </span><a id="_idIndexMarker272"/><span class="koboSpan" id="kobo.113.1">path matches, then the cookie will be sent in </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">the request.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.115.1">The </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.116.1">Expires attribute</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.117.1">:</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.118.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.119.1">Expires</span></strong> <a id="_idIndexMarker273"/><span class="koboSpan" id="kobo.120.1">attribute is set to specify the </span><a id="_idIndexMarker274"/><span class="koboSpan" id="kobo.121.1">lifetime of </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">the cookie.</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.123.1">The </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.124.1">SameSite attribute</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.125.1">:</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.126.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">SameSite</span></strong> <a id="_idIndexMarker275"/><span class="koboSpan" id="kobo.128.1">attribute is set to limit sending the cookie </span><a id="_idIndexMarker276"/><span class="koboSpan" id="kobo.129.1">with cross-site requests. </span><span class="koboSpan" id="kobo.129.2">This attribute </span><a id="_idIndexMarker277"/><span class="koboSpan" id="kobo.130.1">is used to limit sharing cookies with third parties and as a protection from </span><strong class="bold"><span class="koboSpan" id="kobo.131.1">cross-site request forgery</span></strong><span class="koboSpan" id="kobo.132.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.133.1">CSRF</span></strong><span class="koboSpan" id="kobo.134.1">) attacks. </span><span class="koboSpan" id="kobo.134.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.135.1">SameSite</span></strong><span class="koboSpan" id="kobo.136.1"> attribute can be set to one of these values, </span><strong class="bold"><span class="koboSpan" id="kobo.137.1">Strict</span></strong><span class="koboSpan" id="kobo.138.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.139.1">Lax</span></strong><span class="koboSpan" id="kobo.140.1">, or </span><strong class="bold"><span class="koboSpan" id="kobo.141.1">None</span></strong><span class="koboSpan" id="kobo.142.1">. </span><span class="koboSpan" id="kobo.142.2">If you set the value to </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">None</span></strong><span class="koboSpan" id="kobo.144.1">, the cookie will be sent in cross-site requests. </span><span class="koboSpan" id="kobo.144.2">If you set the value to </span><strong class="source-inline"><span class="koboSpan" id="kobo.145.1">Strict</span></strong><span class="koboSpan" id="kobo.146.1">, the cookie will only be sent to the site where it originated. </span><span class="koboSpan" id="kobo.146.2">If you set the value to </span><strong class="source-inline"><span class="koboSpan" id="kobo.147.1">Lax</span></strong><span class="koboSpan" id="kobo.148.1">, the cookie will be sent if the URL equals the cookie’s domain, even if it was originated by a </span><span class="No-Break"><span class="koboSpan" id="kobo.149.1">third party.</span></span></p>
<h2 id="_idParaDest-157"><a id="_idTextAnchor206"/><span class="koboSpan" id="kobo.150.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.151.1">For this recipe, you will need to start ZAP and ensure that it is intercepting the communications between the server and your browser. </span><span class="koboSpan" id="kobo.151.2">In addition, you need a user account for </span><a id="_idIndexMarker278"/><span class="koboSpan" id="kobo.152.1">the PortSwigger </span><span class="No-Break"><span class="koboSpan" id="kobo.153.1">Academy (</span></span><a href="http://portswigger.net/web-security"><span class="No-Break"><span class="koboSpan" id="kobo.154.1">portswigger.net/web-security</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.155.1">).</span></span></p>
<h2 id="_idParaDest-158"><a id="_idTextAnchor207"/><span class="koboSpan" id="kobo.156.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.157.1">By default, ZAP has rules in the Passive Scanner that alert if one of the previously defined </span><a id="_idIndexMarker279"/><span class="koboSpan" id="kobo.158.1">attributes is not set. </span><span class="koboSpan" id="kobo.158.2">In this recipe, we are going to start a PortSwigger lab to see the cookie alert in ZAP. </span><span class="koboSpan" id="kobo.158.3">The following steps guide you through </span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">this process:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.160.1">The first step is to browse </span><a href="http://portswigger.net/web-security"><span class="koboSpan" id="kobo.161.1">portswigger.net/web-security</span></a><span class="koboSpan" id="kobo.162.1"> and click on </span><strong class="bold"><span class="koboSpan" id="kobo.163.1">All Labs</span></strong><span class="koboSpan" id="kobo.164.1"> in the top </span><span class="No-Break"><span class="koboSpan" id="kobo.165.1">navigation bar.</span></span></li>
<li><span class="koboSpan" id="kobo.166.1">Once you are on the Labs page, click on </span><strong class="bold"><span class="koboSpan" id="kobo.167.1">Exploiting cross-site scripting to steal cookies &gt;&gt;</span></strong><span class="koboSpan" id="kobo.168.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.169.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.170.1">.6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.171.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer132">
<span class="koboSpan" id="kobo.172.1"><img alt="Figure 5.6 – The PortSwigger lab" src="image/Figure_05.06_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.173.1">Figure 5.6 – The PortSwigger lab</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.174.1"> Click on </span><strong class="bold"><span class="koboSpan" id="kobo.175.1">Access the lab</span></strong><span class="koboSpan" id="kobo.176.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.177.1">Figure 5</span></em></span><em class="italic"><span class="koboSpan" id="kobo.178.1">.7</span></em><span class="koboSpan" id="kobo.179.1">, and </span><span class="No-Break"><span class="koboSpan" id="kobo.180.1">log in:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer133">
<span class="koboSpan" id="kobo.181.1"><img alt="Figure 5.7 – Accessing the lab" src="image/Figure_05.07_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.182.1">Figure 5.7 – Accessing the lab</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.183.1">The lab </span><a id="_idIndexMarker280"/><span class="koboSpan" id="kobo.184.1">provides a vulnerable application. </span><span class="koboSpan" id="kobo.184.2">Once the application is opened, add it to the scope in ZAP by clicking on the </span><strong class="bold"><span class="koboSpan" id="kobo.185.1">New Context</span></strong><span class="koboSpan" id="kobo.186.1"> button in ZAP and choosing the application as the </span><strong class="bold"><span class="koboSpan" id="kobo.187.1">Top Node</span></strong><span class="koboSpan" id="kobo.188.1"> in the </span><strong class="bold"><span class="koboSpan" id="kobo.189.1">New Context</span></strong><span class="koboSpan" id="kobo.190.1"> window, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.191.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.192.1">.8</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.193.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer134">
<span class="koboSpan" id="kobo.194.1"><img alt="Figure 5.8 – The New Context window" src="image/Figure_05.08_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.195.1">Figure 5.8 – The New Context window</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.196.1">Click on </span><a id="_idIndexMarker281"/><span class="koboSpan" id="kobo.197.1">the target icon to only show findings for </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">in-scope applications.</span></span></li>
<li><span class="koboSpan" id="kobo.199.1">Right-click the Contexts and click on </span><strong class="bold"><span class="koboSpan" id="kobo.200.1">Spider…</span></strong><span class="koboSpan" id="kobo.201.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.202.1">Figure 5</span></em></span><em class="italic"><span class="koboSpan" id="kobo.203.1">.9</span></em><span class="koboSpan" id="kobo.204.1">, to spider </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">the website:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer135">
<span class="koboSpan" id="kobo.206.1"><img alt="Figure 5.9 – Spidering" src="image/Figure_05.09_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.207.1">Figure 5.9 – Spidering</span></p>
<p><span class="koboSpan" id="kobo.208.1">Doing so will add the spider to the bottom window of ZAP if it was not there, and you will see the </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">progress bar.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.210.1">Once the spidering is complete, click on the </span><strong class="bold"><span class="koboSpan" id="kobo.211.1">Alerts</span></strong><span class="koboSpan" id="kobo.212.1"> tab in the bottom window. </span><span class="koboSpan" id="kobo.212.2">You can </span><a id="_idIndexMarker282"/><span class="koboSpan" id="kobo.213.1">see that ZAP discovered that this application’s cookie does not contain the </span><strong class="source-inline"><span class="koboSpan" id="kobo.214.1">HttpOnly</span></strong><span class="koboSpan" id="kobo.215.1"> flag and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">SameSite</span></strong><span class="koboSpan" id="kobo.217.1"> attribute, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.218.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.219.1">.10</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.220.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer136">
<span class="koboSpan" id="kobo.221.1"><img alt="Figure 5.10 – Cookie alerts" src="image/Figure_05.10_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.222.1">Figure 5.10 – Cookie alerts</span></p>
<h2 id="_idParaDest-159"><a id="_idTextAnchor208"/><span class="koboSpan" id="kobo.223.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.224.1">In this lab, we have seen how ZAP can be used to test for missing cookie security attributes. </span><span class="koboSpan" id="kobo.224.2">ZAP contains built-in rules to trigger an alert if a cookie does not contain the security cookie attributes. </span><span class="koboSpan" id="kobo.224.3">ZAP discovers these findings passively; an active scan is </span><a id="_idTextAnchor209"/><span class="No-Break"><span class="koboSpan" id="kobo.225.1">not required.</span></span></p>
<h1 id="_idParaDest-160"><a id="_idTextAnchor210"/><span class="koboSpan" id="kobo.226.1">Testing for cross-site request forgery (CSRF)</span></h1>
<p><span class="koboSpan" id="kobo.227.1">In this </span><a id="_idIndexMarker283"/><span class="koboSpan" id="kobo.228.1">recipe, we will cover how to perform CSRF, where we will be able to post a comment as a different user. </span><span class="koboSpan" id="kobo.228.2">The application needs to be secure as a CSRF vulnerability allows the attacker to take advantage and get users to change sensitive information without </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">them knowing.</span></span></p>
<h2 id="_idParaDest-161"><a id="_idTextAnchor211"/><span class="koboSpan" id="kobo.230.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.231.1">To prepare for this recipe, please start ZAP and Mutillidae II. </span><span class="koboSpan" id="kobo.231.2">Make sure that ZAP intercepts traffic from the Mutillidae II application. </span><span class="koboSpan" id="kobo.231.3">You will also need a testing account in Mutillidae II to post </span><span class="No-Break"><span class="koboSpan" id="kobo.232.1">the message.</span></span></p>
<h2 id="_idParaDest-162"><a id="_idTextAnchor212"/><span class="koboSpan" id="kobo.233.1">How to do it...</span></h2>
<ol>
<li value="1"><span class="koboSpan" id="kobo.234.1">The first </span><a id="_idIndexMarker284"/><span class="koboSpan" id="kobo.235.1">step is to log in to Mutillidae II with the account you created and navigate to the blog, and while the proxy is enabled, submit a blog post in the application Using the drop-down, go to OWASP 2013, then to A8 - Cross Site Request Forgery (CSRF), and then to Add to your Blog. </span><span class="koboSpan" id="kobo.235.2">With the proxy enabled, submit a blog post in </span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">the application:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer137">
<span class="koboSpan" id="kobo.237.1"><img alt="Figure 5.11 – The Mutillidae Add Blog page" src="image/Figure_05.11_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.238.1">Figure 5.11 – The Mutillidae Add Blog page</span></p>
<div>
<div class="IMG---Figure" id="_idContainer138">
<span class="koboSpan" id="kobo.239.1"><img alt="Figure 5.12 – Mutillidae Current Blog Entries" src="image/Figure_05.12_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.240.1">Figure 5.12 – Mutillidae Current Blog Entries</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.241.1">Go to </span><a id="_idIndexMarker285"/><span class="koboSpan" id="kobo.242.1">ZAP Proxy and right click on the POST request, and click on </span><strong class="bold"><span class="koboSpan" id="kobo.243.1">Generate Anti-CSRF </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.244.1">test FORM</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer139">
<span class="koboSpan" id="kobo.246.1"><img alt="Figure 5.13 – Generate Anti-CSRF Test FORM" src="image/Figure_05.13_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.247.1">Figure 5.13 – Generate Anti-CSRF Test FORM</span></p>
<p><span class="koboSpan" id="kobo.248.1">This will open a screen with the fields and CSRF token on </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">the page:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer140">
<span class="koboSpan" id="kobo.250.1"><img alt="Figure 5.14 – Blog Entry csrf-token field" src="image/Figure_05.14_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.251.1">Figure 5.14 – Blog Entry csrf-token field</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.252.1">Log in </span><a id="_idIndexMarker286"/><span class="koboSpan" id="kobo.253.1">as another user in the same browser, and then on the form, we are going to enter a random CSRF token and the attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.254.1">blog entry:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer141">
<span class="koboSpan" id="kobo.255.1"><img alt="Figure 5.15 – Mutillidae CSRF token field manipulation" src="image/Figure_05.15_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.256.1">Figure 5.15 – Mutillidae CSRF token field manipulation</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.257.1">Notice </span><a id="_idIndexMarker287"/><span class="koboSpan" id="kobo.258.1">that after clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.259.1">Submit</span></strong><span class="koboSpan" id="kobo.260.1"> button on the ZAP anti-CSRF form, the page redirects to the blog page with your blog entry submitted by the anti-CSRF form created by </span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">ZAP Proxy:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer142">
<span class="koboSpan" id="kobo.262.1"><img alt="Figure 5.16– The CSRF payload" src="image/Figure_05.16_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.263.1">Figure 5.16– The CSRF payload</span></p>
<h2 id="_idParaDest-163"><a id="_idTextAnchor213"/><span class="koboSpan" id="kobo.264.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.265.1">For this recipe, you were able to submit a request without any CSRF token to a victim user. </span><span class="koboSpan" id="kobo.265.2">This is done by abusing a misconfiguration on the application code that allows a request to be accepted without validating the CSRF token and the user that is logged into </span><span class="No-Break"><span class="koboSpan" id="kobo.266.1">the </span><a id="_idTextAnchor214"/><span class="koboSpan" id="kobo.267.1">application.</span></span></p>
<h1 id="_idParaDest-164"><a id="_idTextAnchor215"/><span class="koboSpan" id="kobo.268.1">Testing for logout functionality</span></h1>
<p><span class="koboSpan" id="kobo.269.1">This recipe focuses on testing the logout mechanism of the website. </span><span class="koboSpan" id="kobo.269.2">The logout mechanism </span><a id="_idIndexMarker288"/><span class="koboSpan" id="kobo.270.1">is important in applications to terminate active sessions. </span><span class="koboSpan" id="kobo.270.2">Some attacks, such as cross-site scripting and CSRF, depend on having an active session present for a user account. </span><span class="koboSpan" id="kobo.270.3">Therefore, having well-built and configured logout functionality to terminate active sessions after a predefined time frame or after the user logout can help prevent cross-site scripting and </span><span class="No-Break"><span class="koboSpan" id="kobo.271.1">CSRF attacks.</span></span></p>
<p><span class="koboSpan" id="kobo.272.1">There are three elements that session termination requires and that should be </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">tested for:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.274.1">The first one is a logout function. </span><span class="koboSpan" id="kobo.274.2">This usually appears as the logout button on most websites. </span><span class="koboSpan" id="kobo.274.3">The button should be present on all pages, and it should be noticeable so that the user cannot miss it when they decide to </span><span class="No-Break"><span class="koboSpan" id="kobo.275.1">log out.</span></span></li>
<li><span class="koboSpan" id="kobo.276.1">The second is the session timeout period. </span><span class="koboSpan" id="kobo.276.2">The session timeout period specifies the length of the inactivity period before a session </span><span class="No-Break"><span class="koboSpan" id="kobo.277.1">is terminated.</span></span></li>
<li><span class="koboSpan" id="kobo.278.1">The third is server-side session termination. </span><span class="koboSpan" id="kobo.278.2">The application must ensure that the session state is terminated on the server side when a user logs out or the timeout period has </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">been surpassed.</span></span></li>
</ul>
<h2 id="_idParaDest-165"><a id="_idTextAnchor216"/><span class="koboSpan" id="kobo.280.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.281.1">To get ready for this lab, ensure that OWASP Juice Shop is running and that ZAP is intercepting the communications between the browser and OWASP </span><span class="No-Break"><span class="koboSpan" id="kobo.282.1">Juice Shop.</span></span></p>
<h2 id="_idParaDest-166"><a id="_idTextAnchor217"/><span class="koboSpan" id="kobo.283.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.284.1">In this lab, we will test to see whether the session is terminated on the server side when a user has logged out. </span><span class="koboSpan" id="kobo.284.2">Follow these steps to see how to </span><span class="No-Break"><span class="koboSpan" id="kobo.285.1">do this:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.286.1">Start the OWASP Juice </span><span class="No-Break"><span class="koboSpan" id="kobo.287.1">Shop application.</span></span></li>
<li><span class="koboSpan" id="kobo.288.1">Start ZAP and add OWASP Juice Shop to </span><span class="No-Break"><span class="koboSpan" id="kobo.289.1">the scope.</span></span></li>
<li><span class="koboSpan" id="kobo.290.1">Open Juice Shop and go to the </span><span class="No-Break"><span class="koboSpan" id="kobo.291.1">login page.</span></span></li>
<li><span class="koboSpan" id="kobo.292.1">Open ZAP and add a breakpoint by clicking on the green circle </span><strong class="bold"><span class="koboSpan" id="kobo.293.1">Set break on all requests and responses</span></strong><span class="koboSpan" id="kobo.294.1"> button. </span><span class="koboSpan" id="kobo.294.2">The green circle button will then </span><span class="No-Break"><span class="koboSpan" id="kobo.295.1">turn red.</span></span></li>
<li><span class="koboSpan" id="kobo.296.1">Log in </span><a id="_idIndexMarker289"/><span class="koboSpan" id="kobo.297.1">as the administrator. </span><span class="koboSpan" id="kobo.297.2">The administrator credentials are </span><a href="mailto:admin@juice-sh.op"><span class="koboSpan" id="kobo.298.1">admin@juice-sh.op</span></a><span class="koboSpan" id="kobo.299.1"> for the email address and </span><strong class="source-inline"><span class="koboSpan" id="kobo.300.1">admin123</span></strong><span class="koboSpan" id="kobo.301.1"> as </span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">the password.</span></span></li>
<li><span class="koboSpan" id="kobo.303.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.304.1">Step</span></strong><span class="koboSpan" id="kobo.305.1"> button until you see the response to the login request that contains the token ID, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.306.1">Figure 5</span></em></span><em class="italic"><span class="koboSpan" id="kobo.307.1">.17</span></em><span class="koboSpan" id="kobo.308.1">. </span><span class="koboSpan" id="kobo.308.2">Then click </span><span class="No-Break"><span class="koboSpan" id="kobo.309.1">on </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.310.1">Continue</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.311.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer143">
<span class="koboSpan" id="kobo.312.1"><img alt="Figure 5.17 – JWT token ID" src="image/Figure_05.17_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.313.1">Figure 5.17 – JWT token ID</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.314.1">In the Juice Shop application, click on </span><strong class="bold"><span class="koboSpan" id="kobo.315.1">Account</span></strong><span class="koboSpan" id="kobo.316.1">, then </span><strong class="bold"><span class="koboSpan" id="kobo.317.1">Orders &amp; Payments</span></strong><span class="koboSpan" id="kobo.318.1">, and then click on </span><strong class="bold"><span class="koboSpan" id="kobo.319.1">Order History</span></strong><span class="koboSpan" id="kobo.320.1">, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.321.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.322.1">.18</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.323.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer144">
<span class="koboSpan" id="kobo.324.1"><img alt="Figure 5.18 – Order History to Orders &amp; Payment" src="image/Figure_05.18_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.325.1">Figure 5.18 – Order History to Orders &amp; Payment</span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.326.1">Log out </span><a id="_idIndexMarker290"/><span class="koboSpan" id="kobo.327.1">of Juice Shop by clicking on </span><strong class="bold"><span class="koboSpan" id="kobo.328.1">Account</span></strong><span class="koboSpan" id="kobo.329.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.330.1">then </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.331.1">Logout</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.332.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.333.1">Open ZAP, and in the </span><strong class="bold"><span class="koboSpan" id="kobo.334.1">History</span></strong><span class="koboSpan" id="kobo.335.1"> tab, search for the GET request to the following </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">/rest/order-history</span></strong><span class="koboSpan" id="kobo.337.1"> URL, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.338.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.339.1">.19</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer145">
<span class="koboSpan" id="kobo.341.1"><img alt="Figure 5.19 – The GET request of /rest/order-history" src="image/Figure_05.19_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.342.1">Figure 5.19 – The GET request of /rest/order-history</span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.343.1">Right-click the request and select </span><strong class="bold"><span class="koboSpan" id="kobo.344.1">Open/Resend with Request Editor…</span></strong><span class="koboSpan" id="kobo.345.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.346.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.347.1">.20</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.348.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer146">
<span class="koboSpan" id="kobo.349.1"><img alt="Figure 5.20 – Request Editor" src="image/Figure_05.20_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.350.1">Figure 5.20 – Request Editor</span></p>
<p><span class="koboSpan" id="kobo.351.1">This will </span><a id="_idIndexMarker291"/><span class="koboSpan" id="kobo.352.1">open the </span><strong class="bold"><span class="koboSpan" id="kobo.353.1">Manual Request Editor</span></strong><span class="koboSpan" id="kobo.354.1">. </span><span class="koboSpan" id="kobo.354.2">In the request editor, you can edit </span><span class="No-Break"><span class="koboSpan" id="kobo.355.1">the request.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.356.1">Click on </span><strong class="bold"><span class="koboSpan" id="kobo.357.1">Send</span></strong><span class="koboSpan" id="kobo.358.1"> to resend </span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">the request:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer147">
<span class="koboSpan" id="kobo.360.1"><img alt="Figure 5.21 – Manual Request Editor Send" src="image/Figure_05.21_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.361.1">Figure 5.21 – Manual Request Editor Send</span></p>
<ol>
<li value="12"><span class="koboSpan" id="kobo.362.1">After sending the request, the </span><strong class="bold"><span class="koboSpan" id="kobo.363.1">Response</span></strong><span class="koboSpan" id="kobo.364.1"> tab will open, which will include the server response. </span><span class="koboSpan" id="kobo.364.2">You can see that the request was accepted, and the response included the order history of the admin user, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.365.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.366.1">.22</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer148">
<span class="koboSpan" id="kobo.368.1"><img alt="Figure 5.22 – Order history response" src="image/Figure_05.22_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.369.1">Figure 5.22 – Order history response</span></p>
<h2 id="_idParaDest-167"><a id="_idTextAnchor218"/><span class="koboSpan" id="kobo.370.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.371.1">In this lab, we resent a request as the admin user after the user has already signed out. </span><span class="koboSpan" id="kobo.371.2">The request </span><a id="_idIndexMarker292"/><span class="koboSpan" id="kobo.372.1">was accepted by the server, and a response was sent with the user’s information, which proves that even though we have logged out as the admin user, the application has not terminated the admin user’s session in the backend, which allowed us to perform </span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">unauthorized action.</span></span></p>
<h2 id="_idParaDest-168"><a id="_idTextAnchor219"/><span class="koboSpan" id="kobo.374.1">There’s more...</span></h2>
<p><span class="koboSpan" id="kobo.375.1">Other types of logout functionality tests, such as session timeout, can be tested by waiting at incremental times (i.e., 15 minutes, 30 minutes, 1 hour, 1 day). </span><span class="koboSpan" id="kobo.375.2">To test, log in to the application and set a timer. </span><span class="koboSpan" id="kobo.375.3">Wait at incremental times to hopefully obtain a successful logout. </span><span class="koboSpan" id="kobo.375.4">Once the time has passed, attempt to refresh the web application page, perform an action on the application, or resend a request to trigger a session timeout </span><span class="No-Break"><span class="koboSpan" id="kobo.376.1">on applications.</span></span></p>
<h2 id="_idParaDest-169"><a id="_idTextAnchor220"/><span class="koboSpan" id="kobo.377.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.378.1">A similar attack that exploits session variables is Session Puzzling or Session Variable Overloading. </span><span class="koboSpan" id="kobo.378.2">Applications that use session variables for multiple purposes are vulnerable </span><a id="_idIndexMarker293"/><span class="koboSpan" id="kobo.379.1">to this kind of attack. </span><span class="koboSpan" id="kobo.379.2">The following link contains more information about this type of </span><span class="No-Break"><span class="koboSpan" id="kobo.380.1">attack: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/06-Session_Management_Testing/08-Testing_for_Session_Puzzling"><span class="No-Break"><span class="koboSpan" id="kobo.381.1">https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/06-Session_Management_Testing/08-Testing_for_Sess</span><span id="_idTextAnchor221"/><span class="koboSpan" id="kobo.382.1">ion_Puzzling</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.383.1">.</span></span></p>
<h1 id="_idParaDest-170"><a id="_idTextAnchor222"/><span class="koboSpan" id="kobo.384.1">Testing for session hijacking</span></h1>
<p><span class="koboSpan" id="kobo.385.1">In this recipe, we will be walking through how to hijack a session by exploiting a web session’s control mechanism, known as the session token, and using this token, aka cookie, to take </span><a id="_idIndexMarker294"/><span class="koboSpan" id="kobo.386.1">over an unsuspecting user’s session. </span><span class="koboSpan" id="kobo.386.2">Common compromises are due to tokens being predictable through session sniffing, malicious </span><a id="_idIndexMarker295"/><span class="koboSpan" id="kobo.387.1">JavaScript code (i.e., XSS, CSRF), or </span><strong class="bold"><span class="koboSpan" id="kobo.388.1">machine-in-the-middle</span></strong><span class="koboSpan" id="kobo.389.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.390.1">MiTM</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">) attacks.</span></span></p>
<p><span class="koboSpan" id="kobo.392.1">We will use MiTM attacks to steal a session token via a cross-site scripting attack and replay the stolen token on another user that will compromise their session, logging into that user’s authenticated Juice </span><span class="No-Break"><span class="koboSpan" id="kobo.393.1">Shop account.</span></span></p>
<h2 id="_idParaDest-171"><a id="_idTextAnchor223"/><span class="koboSpan" id="kobo.394.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.395.1">To prepare for this recipe, please start ZAP and OWASP Juice Shop. </span><span class="koboSpan" id="kobo.395.2">Make sure that ZAP intercepts traffic at the OWASP Juice Shop application home page, and register/create two </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">different users.</span></span></p>
<h2 id="_idParaDest-172"><a id="_idTextAnchor224"/><span class="koboSpan" id="kobo.397.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.398.1">We’ll lead you through steps on how to conduct session hijacking by utilizing two users in OWASP Juice Shop, capturing a session cookie or token via MiTM and loading this into a different user’s request, hijacking that session, and authenticating to a </span><span class="No-Break"><span class="koboSpan" id="kobo.399.1">user’s account.</span></span></p>
<p><span class="koboSpan" id="kobo.400.1">The following steps guide you through </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">this process:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.402.1">Open ZAP’s </span><strong class="bold"><span class="koboSpan" id="kobo.403.1">Manual Explore</span></strong><span class="koboSpan" id="kobo.404.1"> page, enter the Juice Shop URL, and click on </span><strong class="bold"><span class="koboSpan" id="kobo.405.1">Launch Browser</span></strong><span class="koboSpan" id="kobo.406.1">, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.407.1">Figure 5</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.408.1">.23</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.409.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer149">
<span class="koboSpan" id="kobo.410.1"><img alt="Figure 5.23 – Manual Explore in the Juice Shop URL" src="image/Figure_05.23_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.411.1">Figure 5.23 – Manual Explore in the Juice Shop URL</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.412.1">Start by </span><a id="_idIndexMarker296"/><span class="koboSpan" id="kobo.413.1">going to </span><strong class="bold"><span class="koboSpan" id="kobo.414.1">Account</span></strong><span class="koboSpan" id="kobo.415.1"> to </span><strong class="bold"><span class="koboSpan" id="kobo.416.1">Lo</span><a id="_idTextAnchor225"/><span class="koboSpan" id="kobo.417.1">gin</span></strong><span class="koboSpan" id="kobo.418.1"> to </span><strong class="bold"><span class="koboSpan" id="kobo.419.1">Not Yet </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.420.1">a Customer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.421.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.422.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.423.1">User1@email.com</span></strong><span class="koboSpan" id="kobo.424.1"> with any password and anything for the </span><span class="No-Break"><span class="koboSpan" id="kobo.425.1">security question.</span></span></li>
<li><span class="koboSpan" id="kobo.426.1">After creating the first user, repeat </span><em class="italic"><span class="koboSpan" id="kobo.427.1">step 1</span></em><span class="koboSpan" id="kobo.428.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.429.1">step 2</span></em><span class="koboSpan" id="kobo.430.1"> to create </span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">a </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.432.1">User2@email.com</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.434.1">Log in to Juice Shop with the </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.435.1">User1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.436.1"> account.</span></span></li>
<li><span class="koboSpan" id="kobo.437.1">Set break on all requests and responses and refresh the logged-in web page </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">of </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.439.1">User1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.440.1">.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.441.1">This can be achieved either through the </span><strong class="bold"><span class="koboSpan" id="kobo.442.1">Manual Explore</span></strong><span class="koboSpan" id="kobo.443.1"> browser that was launched or in the </span><span class="No-Break"><span class="koboSpan" id="kobo.444.1">Workspace Window:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer150">
<span class="koboSpan" id="kobo.445.1"><img alt="Figure 5.24 – Set break on all requests and responses" src="image/Figure_05.24_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.446.1">Figure 5.24 – Set break on all requests and responses</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.447.1">In ZAP, you will see a new tab open called </span><strong class="bold"><span class="koboSpan" id="kobo.448.1">Break</span></strong><span class="koboSpan" id="kobo.449.1">, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.450.1">Figure 5</span></em></span><em class="italic"><span class="koboSpan" id="kobo.451.1">.25</span></em><span class="koboSpan" id="kobo.452.1">, in the </span><strong class="bold"><span class="koboSpan" id="kobo.453.1">Workspace Window</span></strong><span class="koboSpan" id="kobo.454.1"> that captured the </span><em class="italic"><span class="koboSpan" id="kobo.455.1">User1</span></em><span class="koboSpan" id="kobo.456.1"> session (</span><span class="No-Break"><span class="koboSpan" id="kobo.457.1">JWT) token.</span></span></li>
<li><span class="koboSpan" id="kobo.458.1">Copy all </span><a id="_idIndexMarker297"/><span class="koboSpan" id="kobo.459.1">text between </span><strong class="bold"><span class="koboSpan" id="kobo.460.1">token=</span></strong><span class="koboSpan" id="kobo.461.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.462.1">Upgrade-Insecure-Requests</span></strong><span class="koboSpan" id="kobo.463.1"> from </span><span class="No-Break"><span class="koboSpan" id="kobo.464.1">the request:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer151">
<span class="koboSpan" id="kobo.465.1"><img alt="Figure 5.25 – Captured session token" src="image/Figure_05.25_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.466.1">Figure 5.25 – Captured session token</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.467.1">Log out of </span><em class="italic"><span class="koboSpan" id="kobo.468.1">User1</span></em><span class="koboSpan" id="kobo.469.1"> and log in </span><span class="No-Break"><span class="koboSpan" id="kobo.470.1">with </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.471.1">User2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.473.1">While logged in as </span><em class="italic"><span class="koboSpan" id="kobo.474.1">User2</span></em><span class="koboSpan" id="kobo.475.1">, open the browser </span><strong class="bold"><span class="koboSpan" id="kobo.476.1">Inspect</span></strong><span class="koboSpan" id="kobo.477.1"> tool and go to the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.478.1">Storage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.479.1"> tab.</span></span></li>
<li><span class="koboSpan" id="kobo.480.1">In the cookies’ jar, click to open the drop-down menu and select the Juice </span><span class="No-Break"><span class="koboSpan" id="kobo.481.1">Shop URL.</span></span></li>
<li><span class="koboSpan" id="kobo.482.1">Replace the token element of </span><em class="italic"><span class="koboSpan" id="kobo.483.1">User2</span></em><span class="koboSpan" id="kobo.484.1"> with the session token of </span><em class="italic"><span class="koboSpan" id="kobo.485.1">User1</span></em><span class="koboSpan" id="kobo.486.1"> and hit </span><em class="italic"><span class="koboSpan" id="kobo.487.1">Enter</span></em><span class="koboSpan" id="kobo.488.1"> on </span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">the keyboard.</span></span></li>
<li><span class="koboSpan" id="kobo.490.1">Refresh the browser web page and open the </span><strong class="bold"><span class="koboSpan" id="kobo.491.1">Account</span></strong><span class="koboSpan" id="kobo.492.1"> menu of Juice Shop. </span><span class="koboSpan" id="kobo.492.2">It will now show </span><em class="italic"><span class="koboSpan" id="kobo.493.1">User1</span></em><span class="koboSpan" id="kobo.494.1"> as being logged in instead of </span><em class="italic"><span class="koboSpan" id="kobo.495.1">User2</span></em><span class="koboSpan" id="kobo.496.1">, successfully hijacking </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.497.1">User1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.498.1">’s session.</span></span></li>
</ol>
<h2 id="_idParaDest-173"><a id="_idTextAnchor226"/><span class="koboSpan" id="kobo.499.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.500.1">The act of </span><a id="_idIndexMarker298"/><span class="koboSpan" id="kobo.501.1">taking control of a user’s session without the user’s knowledge or consent is known as session hijacking. </span><span class="koboSpan" id="kobo.501.2">This may be accomplished by obtaining </span><a id="_idIndexMarker299"/><span class="koboSpan" id="kobo.502.1">the user’s </span><strong class="bold"><span class="koboSpan" id="kobo.503.1">JSON Web Token</span></strong><span class="koboSpan" id="kobo.504.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.505.1">JWT</span></strong><span class="koboSpan" id="kobo.506.1">), a token used to authenticate users in a </span><span class="No-Break"><span class="koboSpan" id="kobo.507.1">web application.</span></span></p>
<p><span class="koboSpan" id="kobo.508.1">An attacker who obtains a victim’s JWT can impersonate the victim and acquire access to the victim’s account. </span><span class="koboSpan" id="kobo.508.2">This is accomplished by putting the stolen JWT in the HTTP header of a web application request. </span><span class="koboSpan" id="kobo.508.3">Because the JWT seems to be authentic and provided by the application, the application will treat the request as if it came from </span><span class="No-Break"><span class="koboSpan" id="kobo.509.1">the victim.</span></span></p>
<p><span class="koboSpan" id="kobo.510.1">Attackers can gain a victim’s JWT in a variety of ways, including phishing attacks, MiTM attacks, and exploiting weaknesses in the application or the </span><span class="No-Break"><span class="koboSpan" id="kobo.511.1">victim’s device.</span></span></p>
<h2 id="_idParaDest-174"><a id="_idTextAnchor227"/><span class="koboSpan" id="kobo.512.1">There’s more...</span></h2>
<p><span class="koboSpan" id="kobo.513.1">ZAP can scan for JWT token vulnerabilities by going into </span><strong class="bold"><span class="koboSpan" id="kobo.514.1">Options</span></strong><span class="koboSpan" id="kobo.515.1"> and scrolling down to the </span><strong class="bold"><span class="koboSpan" id="kobo.516.1">JWT</span></strong><span class="koboSpan" id="kobo.517.1"> settings within </span><strong class="bold"><span class="koboSpan" id="kobo.518.1">General</span></strong><span class="koboSpan" id="kobo.519.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.520.1">Enable Client Configuration Scan</span></strong><span class="koboSpan" id="kobo.521.1">. </span><span class="koboSpan" id="kobo.521.2">Later, in </span><a href="B18829_10.xhtml#_idTextAnchor362"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.522.1">Chapter 10</span></em></span></a><span class="koboSpan" id="kobo.523.1">, </span><em class="italic"><span class="koboSpan" id="kobo.524.1">Advanced Attack Techniques</span></em><span class="koboSpan" id="kobo.525.1">, within the </span><em class="italic"><span class="koboSpan" id="kobo.526.1">Working with JSON Web Tokens</span></em><span class="koboSpan" id="kobo.527.1"> recipe, we’ll review how this is used and abused in ZAP. </span><span class="koboSpan" id="kobo.527.2">In addition, these tokens can be decoded using the </span><strong class="bold"><span class="koboSpan" id="kobo.528.1">Encode/Decode/Hash</span></strong><span class="koboSpan" id="kobo.529.1"> tool to see what is contained within, such as the header algorithm, username, password, token expiration, and so on. </span><span class="koboSpan" id="kobo.529.2">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.530.1">Chapter 12</span></em></span><span class="koboSpan" id="kobo.531.1">, we’ll further discuss the structure of JWT tokens, how to decode them, and showcase attacks that can </span><span class="No-Break"><span class="koboSpan" id="kobo.532.1">be attempted.</span></span></p>
<h2 id="_idParaDest-175"><a id="_idTextAnchor228"/><span class="koboSpan" id="kobo.533.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.534.1">Consider </span><a id="_idIndexMarker300"/><span class="koboSpan" id="kobo.535.1">further reading to understand session hijacking and to understand remediations for this type </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">of attack:</span></span></p>
<ul>
<li><a href="https://owasp.org/www-community/attacks/Session_hijacking_attack#"><span class="No-Break"><span class="koboSpan" id="kobo.537.1">https://owasp.org/www-community/attacks/Session_hijacking_attack#</span></span></a></li>
<li><a href="https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html"><span class="No-Break"><span class="koboSpan" id="kobo.538.1">https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html</span></span></a></li>
<li><a href="https://owasp.deteact.com/cheat/cheatsheets/Input_Validation_Cheat_Sheet.html"><span class="No-Break"><span class="koboSpan" id="kobo.539.1">https://owasp.deteact.com/cheat/cheatsheets/Input_Validation_Cheat_Sheet.html</span></span></a></li>
</ul>
</div>
</body></html>