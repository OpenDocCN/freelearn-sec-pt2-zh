<html><head></head><body>
<div id="_idContainer193">
<h1 class="chapter-number" id="_idParaDest-202"><a id="_idTextAnchor262"/><span class="koboSpan" id="kobo.1.1">7</span></h1>
<h1 id="_idParaDest-203"><a id="_idTextAnchor263"/><span class="koboSpan" id="kobo.2.1">Validating (Data) Inputs – Part 2</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Here in </span><a href="B18829_07.xhtml#_idTextAnchor262"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.4.1">Chapter 7</span></em></span></a><span class="koboSpan" id="kobo.5.1">, we will continue with input validation. </span><span class="koboSpan" id="kobo.5.2">We will cover </span><strong class="bold"><span class="koboSpan" id="kobo.6.1">code injection</span></strong><span class="koboSpan" id="kobo.7.1">, which </span><a id="_idIndexMarker335"/><span class="koboSpan" id="kobo.8.1">enables the attacker to insert custom code into the program </span><a id="_idIndexMarker336"/><span class="koboSpan" id="kobo.9.1">that it will then run. </span><span class="koboSpan" id="kobo.9.2">We will then take a look at </span><strong class="bold"><span class="koboSpan" id="kobo.10.1">command injection</span></strong><span class="koboSpan" id="kobo.11.1">, which uses pre-existing code to run commands, typically in the context of </span><a id="_idIndexMarker337"/><span class="koboSpan" id="kobo.12.1">a shell. </span><span class="koboSpan" id="kobo.12.2">We’ll discuss </span><strong class="bold"><span class="koboSpan" id="kobo.13.1">server-side template injection</span></strong><span class="koboSpan" id="kobo.14.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.15.1">SSTI</span></strong><span class="koboSpan" id="kobo.16.1">), which is when user input is inserted in an unsafe manner in </span><a id="_idIndexMarker338"/><span class="koboSpan" id="kobo.17.1">a template, resulting in remote code execution on the server. </span><span class="koboSpan" id="kobo.17.2">Lastly, we will cover </span><strong class="bold"><span class="koboSpan" id="kobo.18.1">Server-Side Request Forgery</span></strong><span class="koboSpan" id="kobo.19.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.20.1">SSRF</span></strong><span class="koboSpan" id="kobo.21.1">), which exploits the server functionality to read or alter </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">internal resourc</span><a id="_idTextAnchor264"/><span class="koboSpan" id="kobo.23.1">es.</span></span></p>
<p><span class="koboSpan" id="kobo.24.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.26.1">Testing for </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">code injection</span></span></li>
<li><span class="koboSpan" id="kobo.28.1">Testing for </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">command injection</span></span></li>
<li><span class="koboSpan" id="kobo.30.1">Testing for server-side </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">template injection</span></span></li>
<li><span class="koboSpan" id="kobo.32.1">Testing for server-side </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">request forgery</span></span></li>
</ul>
<h1 id="_idParaDest-204"><a id="_idTextAnchor265"/><span class="koboSpan" id="kobo.34.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.35.1">For this chapter, it is required that you install OWASP ZAP and utilize your PortSwigger account for access to the PortSwigger </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">Academy la</span><a id="_idTextAnchor266"/><span class="koboSpan" id="kobo.37.1">bs.</span></span></p>
<h1 id="_idParaDest-205"><a id="_idTextAnchor267"/><span class="koboSpan" id="kobo.38.1">Testing for code injection</span></h1>
<p><span class="koboSpan" id="kobo.39.1">Code injection is </span><a id="_idIndexMarker339"/><span class="koboSpan" id="kobo.40.1">a vulnerability that involves injecting code into the application that is then interpreted or executed by the application. </span><span class="koboSpan" id="kobo.40.2">This vulnerability allows an attacker to get information from the backend of the application all the way up to fully compromising </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">the application.</span></span></p>
<p><span class="koboSpan" id="kobo.42.1">In this recipe, we will walk you through the </span><em class="italic"><span class="koboSpan" id="kobo.43.1">Remote code execution via web shell upload</span></em><span class="koboSpan" id="kobo.44.1"> PortSwigger lab to create and upload a new file via the web application feature that includes the code </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">injection payload.</span></span></p>
<h2 id="_idParaDest-206"><a id="_idTextAnchor268"/><span class="koboSpan" id="kobo.46.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.47.1">This lab requires a PortSwigger Academy account and ZAP to intercept requests and responses from the server to </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">your browser.</span></span></p>
<h2 id="_idParaDest-207"><a id="_idTextAnchor269"/><span class="koboSpan" id="kobo.49.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.50.1">In this lab, you will be </span><a id="_idIndexMarker340"/><span class="koboSpan" id="kobo.51.1">exposed to a vulnerable image upload feature that does not validate the files uploaded by users before putting them on the </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">server’s storage.</span></span></p>
<p><span class="koboSpan" id="kobo.53.1">You will exploit this flaw by uploading a simple PHP web shell and utilizing it to exfiltrate the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.54.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.55.1">home/carlos/secret</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.56.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.57.1">Navigate to the </span><em class="italic"><span class="koboSpan" id="kobo.58.1">Remote code execution via web shell upload</span></em><span class="koboSpan" id="kobo.59.1"> PortSwigger Academy lab and obtain the credentials provided in the lab description. </span><span class="koboSpan" id="kobo.59.2">The following URL points to the </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">lab: </span></span><a href="https://portswigger.net/web-security/file-upload/lab-file-upload-remote-code-execution-via-web-shell-upload"><span class="No-Break"><span class="koboSpan" id="kobo.61.1">https://portswigger.net/web-security/file-upload/lab-file-upload-remote-code-execution-via-web-shell-upload</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.62.1">:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.63.1">With the browser proxied to ZAP, log into the PortSwigger Academy website to launch </span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">the lab.</span></span></li>
<li><span class="koboSpan" id="kobo.65.1">Once you launch the lab, navigate to </span><strong class="bold"><span class="koboSpan" id="kobo.66.1">My Account</span></strong><span class="koboSpan" id="kobo.67.1"> and log in with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.68.1">wiener</span></strong><span class="koboSpan" id="kobo.69.1"> account, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.70.1">peter</span></strong><span class="koboSpan" id="kobo.71.1"> as the password. </span><span class="koboSpan" id="kobo.71.2">This is also provided on the lab instruction page, where you click to launch </span><span class="No-Break"><span class="koboSpan" id="kobo.72.1">the application.</span></span></li>
<li><span class="koboSpan" id="kobo.73.1">From the </span><strong class="bold"><span class="koboSpan" id="kobo.74.1">My Account</span></strong><span class="koboSpan" id="kobo.75.1"> page, click </span><strong class="bold"><span class="koboSpan" id="kobo.76.1">Choose File</span></strong><span class="koboSpan" id="kobo.77.1"> and select any imag</span><a id="_idTextAnchor270"/><span class="koboSpan" id="kobo.78.1">e you have to upload. </span><span class="koboSpan" id="kobo.78.2">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.79.1">Figure 7</span></em></span><em class="italic"><span class="koboSpan" id="kobo.80.1">.1</span></em><span class="koboSpan" id="kobo.81.1">, you can see I have selected an Avatar picture of myself and uploaded the photo. </span><span class="koboSpan" id="kobo.81.2">After you upload the picture, click on </span><strong class="bold"><span class="koboSpan" id="kobo.82.1">back to my account</span></strong><span class="koboSpan" id="kobo.83.1">, and you will notice now you can see the </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">image uploaded.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer169">
<span class="koboSpan" id="kobo.85.1"><img alt="Figure 7.1 – The My Account page" src="image/Figure_7.01_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.86.1">Figure 7.1 – The My Account page</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.87.1">Next, check the ZAP Sites window for the request that the application used to obtain the </span><a id="_idIndexMarker341"/><span class="koboSpan" id="kobo.88.1">avatar image from the </span><strong class="bold"><span class="koboSpan" id="kobo.89.1">My Account</span></strong><span class="koboSpan" id="kobo.90.1"> page, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.91.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.92.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer170">
<span class="koboSpan" id="kobo.94.1"><img alt="Figure 7.2 – The avatar image request" src="image/Figure_7.02_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.95.1">Figure 7.2 – The avatar image request</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.96.1">Then right-click on the image, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.97.1">Figure 7</span></em></span><em class="italic"><span class="koboSpan" id="kobo.98.1">.3</span></em><span class="koboSpan" id="kobo.99.1">, and click on </span><strong class="bold"><span class="koboSpan" id="kobo.100.1">Open/Resend with </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.101.1">Request Editor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.102.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer171">
<span class="koboSpan" id="kobo.103.1"><img alt="Figure 7.3 – The Open/Resend with Request Editor option" src="image/Figure_7.03_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.104.1">Figure 7.3 – The Open/Resend with Request Editor option</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.105.1">From here, you can minimize the current </span><strong class="bold"><span class="koboSpan" id="kobo.106.1">Request Editor</span></strong><span class="koboSpan" id="kobo.107.1"> window to create a new file with </span><a id="_idIndexMarker342"/><span class="koboSpan" id="kobo.108.1">the code injection payload. </span><span class="koboSpan" id="kobo.108.2">The file you are going to create is named </span><strong class="source-inline"><span class="koboSpan" id="kobo.109.1">exploit.php</span></strong><span class="koboSpan" id="kobo.110.1">, and the code inside the file is shown </span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">as follows:</span></span><pre class="console"><span class="koboSpan" id="kobo.112.1">
&lt;?php echo file_get_contents('/home/carlos/secret'); ?&gt;</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.113.1">After you have created the payload file and saved it, go ahead and upload the file in the same way you uploaded the </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">profile image.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.115.1">Notice that once you select the </span><strong class="source-inline"><span class="koboSpan" id="kobo.116.1">exploit.php</span></strong><span class="koboSpan" id="kobo.117.1"> file to upload as the avatar image, the name of the file is shown before you upload the file, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.118.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.119.1">.4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer172">
<span class="koboSpan" id="kobo.121.1"><img alt="Figure 7.4 – Upload image feature" src="image/Figure_7.04_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.122.1">Figure 7.4 – Upload image feature</span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.123.1">Once you upload the exploit file, you can go back to ZAP, and in the </span><strong class="bold"><span class="koboSpan" id="kobo.124.1">Manual Request Editor</span></strong><span class="koboSpan" id="kobo.125.1"> window that you minimized earlier, change the path at the end of your URL to </span><strong class="source-inline"><span class="koboSpan" id="kobo.126.1">/files/avatars/exploit.php</span></strong><span class="koboSpan" id="kobo.127.1"> and send the request. </span><span class="koboSpan" id="kobo.127.2">Notice that it </span><a id="_idIndexMarker343"/><span class="koboSpan" id="kobo.128.1">returns a random generated string. </span><span class="koboSpan" id="kobo.128.2">This is the solution needed to complete the lab that demonstrates how we can read the file inside the server located in the same path we used for our </span><strong class="source-inline"><span class="koboSpan" id="kobo.129.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.130.1">home/carlos/secret</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.131.1"> exploit.</span></span></li>
<li><span class="koboSpan" id="kobo.132.1">Congratulations! </span><span class="koboSpan" id="kobo.132.2">You have read a file inside a server by exploiting a code injection vulnerability on </span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">the application.</span></span></li>
</ol>
<h2 id="_idParaDest-208"><a id="_idTextAnchor271"/><span class="koboSpan" id="kobo.134.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.135.1">Code injection is a technique for injecting arbitrary code into a program or process to execute it. </span><span class="koboSpan" id="kobo.135.2">This can be done for several reasons, such as testing, debugging, or malevolent objectives, such </span><span class="No-Break"><span class="koboSpan" id="kobo.136.1">as malware.</span></span></p>
<p><span class="koboSpan" id="kobo.137.1">Code injection can happen in a variety </span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">of ways:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.139.1">Buffer overflow</span></strong><span class="koboSpan" id="kobo.140.1">: A buffer </span><a id="_idIndexMarker344"/><span class="koboSpan" id="kobo.141.1">overflow vulnerability happens when software attempts to store more data than it is meant to contain in a buffer (a temporary data storage space). </span><span class="koboSpan" id="kobo.141.2">This can overwrite nearby memory, allowing an attacker to execute </span><span class="No-Break"><span class="koboSpan" id="kobo.142.1">arbitrary code.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.143.1">SQL injection</span></strong><span class="koboSpan" id="kobo.144.1">: SQL injection is a kind of code injection in which an attacker may </span><a id="_idIndexMarker345"/><span class="koboSpan" id="kobo.145.1">send malicious SQL statements to a database server via a </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">susceptible application.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.147.1">Cross-site scripting (XSS)</span></strong><span class="koboSpan" id="kobo.148.1">: XSS is a kind of code injection in which an attacker </span><a id="_idIndexMarker346"/><span class="koboSpan" id="kobo.149.1">injects malicious code into a web page, which is subsequently executed by the </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">victim’s browser.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.151.1">Remote code execution (RCE)</span></strong><span class="koboSpan" id="kobo.152.1">: RCE is a kind of code injection in which an attacker </span><a id="_idIndexMarker347"/><span class="koboSpan" id="kobo.153.1">is able to execute code on a remote machine by exploiting a vulnerability in a network service </span><span class="No-Break"><span class="koboSpan" id="kobo.154.1">or application.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.155.1">Code injection can be avoided by using effective input validation and sanitization, safe coding techniques, and frequent security updates </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">and </span><a id="_idTextAnchor272"/><span class="koboSpan" id="kobo.157.1">patches.</span></span></p>
<h1 id="_idParaDest-209"><a id="_idTextAnchor273"/><span class="koboSpan" id="kobo.158.1">Testing for command injection</span></h1>
<p><span class="koboSpan" id="kobo.159.1">Command injection is a vulnerability that enables an attacker to execute commands on the application’s underlying operating system (the host). </span><span class="koboSpan" id="kobo.159.2">This vulnerability occurs when the application </span><a id="_idIndexMarker348"/><span class="koboSpan" id="kobo.160.1">takes unsanitized and unvalidated user input and executes it in a system command. </span><span class="koboSpan" id="kobo.160.2">Some examples of system commands are </span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">grep</span></strong><span class="koboSpan" id="kobo.162.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">exec</span></strong><span class="koboSpan" id="kobo.164.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">system</span></strong><span class="koboSpan" id="kobo.166.1">. </span><span class="koboSpan" id="kobo.166.2">The system commands differ depending on the programming language that the application is developed with. </span><span class="koboSpan" id="kobo.166.3">Usually, to perform the command injection attack, you provide the application with the expected input and then a special character to execute the desired commands right after the expected input (command). </span><span class="koboSpan" id="kobo.166.4">Special characters, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">|</span></strong><span class="koboSpan" id="kobo.168.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.169.1">&amp;</span></strong><span class="koboSpan" id="kobo.170.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.171.1">;</span></strong><span class="koboSpan" id="kobo.172.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.173.1">|</span></strong><span class="koboSpan" id="kobo.174.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">||</span></strong><span class="koboSpan" id="kobo.176.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">&amp;</span></strong><span class="koboSpan" id="kobo.178.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">&amp;&amp;</span></strong><span class="koboSpan" id="kobo.180.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">\n</span></strong><span class="koboSpan" id="kobo.182.1"> append more commands to the executed command. </span><span class="koboSpan" id="kobo.182.2">Using these special characters, you can execute more commands at the same time. </span><span class="koboSpan" id="kobo.182.3">The severity of the vulnerability is determined by the permissions granted to the application’s user account. </span><span class="koboSpan" id="kobo.182.4">It could be as critical as viewing the passwords stored in the system, exfiltrating data, or interacting with other systems on </span><span class="No-Break"><span class="koboSpan" id="kobo.183.1">the network.</span></span></p>
<p><span class="koboSpan" id="kobo.184.1">In this recipe, we will walk through the </span><em class="italic"><span class="koboSpan" id="kobo.185.1">OS command injection, simple case</span></em><span class="koboSpan" id="kobo.186.1"> lab in PortSwigger’s Web Security Academy and learn how to exploit the vulnerability of successfully triggering commands that </span><span class="No-Break"><span class="koboSpan" id="kobo.187.1">we input.</span></span></p>
<h2 id="_idParaDest-210"><a id="_idTextAnchor274"/><span class="koboSpan" id="kobo.188.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.189.1">You will need to start ZAP and ensure it intercepts the request and responses between your browser and the PortSwigger </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">Academy lab.</span></span></p>
<h2 id="_idParaDest-211"><a id="_idTextAnchor275"/><span class="koboSpan" id="kobo.191.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.192.1">To demonstrate how to exploit a common injection vulnerability, we are going to use one of PortSwigger’s Web Security Academy labs. </span><span class="koboSpan" id="kobo.192.2">ZAP will intercept the traffic, and we will modify a request to exploit </span><span class="No-Break"><span class="koboSpan" id="kobo.193.1">the vulnerability.</span></span></p>
<p><span class="koboSpan" id="kobo.194.1">The following </span><a id="_idIndexMarker349"/><span class="koboSpan" id="kobo.195.1">steps walk you through completing the lab and exploiting </span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">the vulnerability:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.197.1">Start ZAP, and in your browser, navigate to PortSwigger Academy. </span><span class="koboSpan" id="kobo.197.2">Log in and click on the </span><strong class="bold"><span class="koboSpan" id="kobo.198.1">All </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.199.1">Labs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.200.1"> button.</span></span></li>
<li><span class="koboSpan" id="kobo.201.1">Scroll down to the </span><strong class="bold"><span class="koboSpan" id="kobo.202.1">OS command injection</span></strong><span class="koboSpan" id="kobo.203.1"> section, and click on the </span><strong class="bold"><span class="koboSpan" id="kobo.204.1">OS command injection, simple case</span></strong><span class="koboSpan" id="kobo.205.1"> lab, found </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">at </span></span><a href="https://portswigger.net/web-security/os-command-injection/lab-simple"><span class="No-Break"><span class="koboSpan" id="kobo.207.1">https://portswigger.net/web-security/os-command-injection/lab-simple</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.208.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer173">
<span class="koboSpan" id="kobo.209.1"><img alt="Figure 7.5 – The OS command injection lab" src="image/Figure_7.05_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.210.1">Figure 7.5 – The OS command injection lab</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.211.1">Click on </span><strong class="bold"><span class="koboSpan" id="kobo.212.1">Access the lab</span></strong><span class="koboSpan" id="kobo.213.1">, and the vulnerable application will open in a </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">new tab.</span></span></li>
<li><span class="koboSpan" id="kobo.215.1">Add the application to the scope to limit the results you see to only </span><span class="No-Break"><span class="koboSpan" id="kobo.216.1">the scope.</span></span></li>
<li><span class="koboSpan" id="kobo.217.1">In this application, the function to check the stock level of every item shown is vulnerable to command injection vulnerability. </span><span class="koboSpan" id="kobo.217.2">Therefore, open any item, scroll to the bottom until you can select the </span><strong class="bold"><span class="koboSpan" id="kobo.218.1">Check stock</span></strong><span class="koboSpan" id="kobo.219.1"> button, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.220.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.221.1">.6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer174">
<span class="koboSpan" id="kobo.223.1"><img alt="Figure 7.6 – The Check stock button" src="image/Figure_7.06_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.224.1">Figure 7.6 – The Check stock button</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.225.1">We clicked </span><a id="_idIndexMarker350"/><span class="koboSpan" id="kobo.226.1">on the button to generate the request. </span><span class="koboSpan" id="kobo.226.2">Now that the request has been sent, find it in the </span><strong class="bold"><span class="koboSpan" id="kobo.227.1">History</span></strong><span class="koboSpan" id="kobo.228.1"> tab of ZAP. </span><span class="koboSpan" id="kobo.228.2">It will be a </span><strong class="source-inline"><span class="koboSpan" id="kobo.229.1">POST</span></strong><span class="koboSpan" id="kobo.230.1"> HTTP request to </span><strong class="source-inline"><span class="koboSpan" id="kobo.231.1">/product/stock</span></strong><span class="koboSpan" id="kobo.232.1">, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.233.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.234.1">.7</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer175">
<span class="koboSpan" id="kobo.236.1"><img alt="Figure 7.7 – A POST request to /product/stock" src="image/Figure_7.07_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.237.1">Figure 7.7 – A POST request to /product/stock</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.238.1">Right-click the request and click on </span><strong class="bold"><span class="koboSpan" id="kobo.239.1">Open/Resend with Request Editor</span></strong><span class="koboSpan" id="kobo.240.1">, also known as </span><strong class="bold"><span class="koboSpan" id="kobo.241.1">Manual </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.242.1">Request Editor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.243.1">.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.244.1">Manual Request Editor</span></strong><span class="koboSpan" id="kobo.245.1"> will open in a new window. </span><span class="koboSpan" id="kobo.245.2">To exploit the vulnerability, add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.246.1">|</span></strong><span class="koboSpan" id="kobo.247.1"> pipe symbol and a command right after </span><strong class="source-inline"><span class="koboSpan" id="kobo.248.1">storeId=1</span></strong><span class="koboSpan" id="kobo.249.1">. </span><span class="koboSpan" id="kobo.249.2">For this step, add </span><strong class="source-inline"><span class="koboSpan" id="kobo.250.1">|pwd</span></strong><span class="koboSpan" id="kobo.251.1">, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.252.1">Figure 7</span></em></span><em class="italic"><span class="koboSpan" id="kobo.253.1">.8</span></em><span class="koboSpan" id="kobo.254.1">, to see which directory we are in, and click on the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.255.1">Send</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.256.1"> button:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer176">
<span class="koboSpan" id="kobo.257.1"><img alt="Figure 7.8 – The storeId request" src="image/Figure_7.08_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.258.1">Figure 7.8 – The storeId request</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.259.1">As you can see, the request we have sent with the system command has been executed, and now </span><a id="_idIndexMarker351"/><span class="koboSpan" id="kobo.260.1">we can see that the directory we are in </span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">/home/peter-IkA8ei</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.264.1">Now, for fun, let’s create a file. </span><span class="koboSpan" id="kobo.264.2">Go back to the </span><strong class="bold"><span class="koboSpan" id="kobo.265.1">Request</span></strong><span class="koboSpan" id="kobo.266.1"> tab of </span><strong class="bold"><span class="koboSpan" id="kobo.267.1">Manual Request Editor</span></strong><span class="koboSpan" id="kobo.268.1"> and add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">|</span></strong><span class="koboSpan" id="kobo.270.1"> pipe symbol and </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">cat &gt; CommandInjection.txt</span></strong><span class="koboSpan" id="kobo.272.1">, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.273.1">Figure 7</span></em></span><em class="italic"><span class="koboSpan" id="kobo.274.1">.9</span></em><span class="koboSpan" id="kobo.275.1">. </span><span class="koboSpan" id="kobo.275.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.276.1">200</span></strong><span class="koboSpan" id="kobo.277.1"> HTTP response status code tells us that the request </span><span class="No-Break"><span class="koboSpan" id="kobo.278.1">was successful:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer177">
<span class="koboSpan" id="kobo.279.1"><img alt="Figure 7.9 –  The CommandInjection request" src="image/Figure_7.09_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.280.1">Figure 7.9 –  The CommandInjection request</span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.281.1">Now, to see the </span><a id="_idIndexMarker352"/><span class="koboSpan" id="kobo.282.1">file we have created, repeat the same steps, but this time add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.283.1">|</span></strong><span class="koboSpan" id="kobo.284.1"> pipe symbol and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">ls</span></strong><span class="koboSpan" id="kobo.286.1"> command, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.287.1">Figure 7</span></em></span><em class="italic"><span class="koboSpan" id="kobo.288.1">.10</span></em><span class="koboSpan" id="kobo.289.1">, and click </span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">on </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.291.1">Send</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.292.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer178">
<span class="koboSpan" id="kobo.293.1"><img alt="Figure 7.10 – The ls command in request" src="image/Figure_7.10_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.294.1">Figure 7.10 – The ls command in request</span></p>
<ol>
<li value="12"><span class="koboSpan" id="kobo.295.1">In the response, you can see that the command was executed successfully, and we can see the file we have created listed, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.296.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.297.1">.11</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer179">
<span class="koboSpan" id="kobo.299.1"><img alt="Figure 7.11 – The executed command injection" src="image/Figure_7.11_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.300.1">Figure 7.11 – The executed command injection</span></p>
<p><span class="koboSpan" id="kobo.301.1">This concludes this lab. </span><span class="koboSpan" id="kobo.301.2">In this lab, you successfully exploited a command </span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">injection vulnerability.</span></span></p>
<h2 id="_idParaDest-212"><a id="_idTextAnchor276"/><span class="koboSpan" id="kobo.303.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.304.1">Since the application </span><a id="_idIndexMarker353"/><span class="koboSpan" id="kobo.305.1">is vulnerable to command injections, it does not validate the user input. </span><span class="koboSpan" id="kobo.305.2">Therefore, we could execute system commands, see which directory we were in, and create files. </span><span class="koboSpan" id="kobo.305.3">We could also delete files if we </span><span class="No-Break"><span class="koboSpan" id="kobo.306.1">wanted to.</span></span></p>
<p><span class="koboSpan" id="kobo.307.1">Remediation measures for command injection vulnerabilities can be prevented by sanitizing the </span><span class="No-Break"><span class="koboSpan" id="kobo.308.1">user’s input.</span></span></p>
<h2 id="_idParaDest-213"><a id="_idTextAnchor277"/><span class="koboSpan" id="kobo.309.1">There’s more...</span></h2>
<p><span class="koboSpan" id="kobo.310.1">ZAP Active Scan can detect </span><a id="_idIndexMarker354"/><span class="koboSpan" id="kobo.311.1">the command injection vulnerability. </span><span class="koboSpan" id="kobo.311.2">Run an active scan on the application, navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.312.1">Alerts</span></strong><span class="koboSpan" id="kobo.313.1"> tab after it has finished, and search for the presence of </span><strong class="bold"><span class="koboSpan" id="kobo.314.1">Remote OS Command Injection</span></strong><span class="koboSpan" id="kobo.315.1">. </span><span class="koboSpan" id="kobo.315.2">In the alert, more information is provided about the vulnerability, and in the </span><strong class="bold"><span class="koboSpan" id="kobo.316.1">Attack</span></strong><span class="koboSpan" id="kobo.317.1"> field, you will see the successful payload. </span><span class="koboSpan" id="kobo.317.2">Using the payload observed in the </span><strong class="bold"><span class="koboSpan" id="kobo.318.1">Attack</span></strong><span class="koboSpan" id="kobo.319.1"> field, you can recreate the attack to view the password file or more. </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.320.1">Figure 7</span></em></span><em class="italic"><span class="koboSpan" id="kobo.321.1">.12</span></em><span class="koboSpan" id="kobo.322.1"> is a screenshot of </span><span class="No-Break"><span class="koboSpan" id="kobo.323.1">the alert:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer180">
<span class="koboSpan" id="kobo.324.1"><img alt="Figure 7.12 – The Alerts tab attack description" src="image/Figure_7.12_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.325.1">Figure 7.12 – The Alerts tab attack description</span></p>
<h2 id="_idParaDest-214"><a id="_idTextAnchor278"/><span class="koboSpan" id="kobo.326.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.327.1">Commix is an open source tool developed to automatically detect and exploit command injection vulnerability exploitation. </span><span class="koboSpan" id="kobo.327.2">It is also included as a tool in Kali Linux. </span><span class="koboSpan" id="kobo.327.3">To learn more about </span><a id="_idIndexMarker355"/><span class="koboSpan" id="kobo.328.1">Commix, please visit the tool’s GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">page (</span></span><a href="https://github.com/commixproject/commix"><span class="No-Break"><span class="koboSpan" id="kobo.330.1">https://github.com/commixproject/</span><span id="_idTextAnchor279"/><span class="koboSpan" id="kobo.331.1">commix</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.332.1">).</span></span></p>
<h1 id="_idParaDest-215"><a id="_idTextAnchor280"/><span class="koboSpan" id="kobo.333.1">Testing for server-side template injection</span></h1>
<p><span class="koboSpan" id="kobo.334.1">In this recipe, you </span><a id="_idIndexMarker356"/><span class="koboSpan" id="kobo.335.1">will learn how to conduct a basic SSTI attack using a lab from PortSwigger Academy. </span><span class="koboSpan" id="kobo.335.2">Because of the insecure construction of an ERB template, the application in this lab is vulnerable to SSTI. </span><span class="koboSpan" id="kobo.335.3">You will learn what SSTI is by completing the lab. </span><span class="koboSpan" id="kobo.335.4">First, read the ERB documentation to learn how to run arbitrary code, then delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">morale.txt</span></strong><span class="koboSpan" id="kobo.337.1"> file from Carlos’s </span><span class="No-Break"><span class="koboSpan" id="kobo.338.1">home directory.</span></span></p>
<p><span class="koboSpan" id="kobo.339.1">Furthermore, you will learn how server-side templates work and how this leads to attackers exploiting vulnerabilities to gain control over </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">the server.</span></span></p>
<h2 id="_idParaDest-216"><a id="_idTextAnchor281"/><span class="koboSpan" id="kobo.341.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.342.1">Start up your local ZAP tool and log in to your PortSwigger Academy account, then go to the </span><em class="italic"><span class="koboSpan" id="kobo.343.1">Basic server-side template injection</span></em><span class="koboSpan" id="kobo.344.1"> lab </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">at </span></span><a href="https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-basic"><span class="No-Break"><span class="koboSpan" id="kobo.346.1">https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-basic</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.347.1">.</span></span></p>
<h2 id="_idParaDest-217"><a id="_idTextAnchor282"/><span class="koboSpan" id="kobo.348.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.349.1">A good first </span><a id="_idIndexMarker357"/><span class="koboSpan" id="kobo.350.1">step toward exploitation is to fuzz the template by injecting a sequence of special characters commonly used in template expressions, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.351.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.352.1">
${{&lt;%[%'"}}%\</span></pre>
<p><span class="koboSpan" id="kobo.353.1">So when fuzzing produces an error or result, such as the use of mathematical equations, this will indicate that the template is vulnerable to injection as the server is attempting to evaluate the payload. </span><span class="koboSpan" id="kobo.353.2">Doing so is important in identifying its context before being able to </span><span class="No-Break"><span class="koboSpan" id="kobo.354.1">exploit it:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.355.1">First, click </span><strong class="bold"><span class="koboSpan" id="kobo.356.1">View Details</span></strong><span class="koboSpan" id="kobo.357.1"> to learn more about the first product. </span><span class="koboSpan" id="kobo.357.2">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">GET</span></strong><span class="koboSpan" id="kobo.359.1"> request uses the message parameter to render; then you will get the </span><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">Unfortunately this product is out of stock</span></strong><span class="koboSpan" id="kobo.361.1"> message on the home page, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.362.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.363.1">.13</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.364.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer181">
<span class="koboSpan" id="kobo.365.1"><img alt="Figure 7.13 – The GET request displaying an out-of-stock message" src="image/Figure_7.13_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.366.1">Figure 7.13 – The GET request displaying an out-of-stock message</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.367.1">Looking up the ERB documentation (the </span><em class="italic"><span class="koboSpan" id="kobo.368.1">See also</span></em><span class="koboSpan" id="kobo.369.1"> section has a link to the documentation), you can see that the syntax for an expression is </span><strong class="source-inline"><span class="koboSpan" id="kobo.370.1">&lt;%= someExpression %&gt;</span></strong><span class="koboSpan" id="kobo.371.1">, which is used to evaluate an expression and render the results on the page. </span><span class="koboSpan" id="kobo.371.2">You can also generate an error using the expression, which will disclose information that the template is using Ruby ERB. </span><span class="koboSpan" id="kobo.371.3">(see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.372.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.373.1">.14</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.374.1">):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer182">
<span class="koboSpan" id="kobo.375.1"><img alt="Figure 7.14 – Internal Server Error disclosing Ruby ERB" src="image/Figure_7.14_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.376.1">Figure 7.14 – Internal Server Error disclosing Ruby ERB</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.377.1">Enter the </span><a id="_idIndexMarker358"/><span class="koboSpan" id="kobo.378.1">URL of a test payload after </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">message=</span></strong><span class="koboSpan" id="kobo.380.1"> containing a simple mathematical operation using the ERB </span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">expression syntax:</span></span><pre class="console"><span class="koboSpan" id="kobo.382.1">
- https://your-lab-id.web-security-academy.net/?message=&lt;%25%3d+8*11+%25&gt;</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.383.1">You will notice that the math equation is solved and rendered to the page of the web application shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.384.1">Figure 7</span></em></span><em class="italic"><span class="koboSpan" id="kobo.385.1">.15</span></em><span class="koboSpan" id="kobo.386.1">. </span><span class="koboSpan" id="kobo.386.2">This will appear in the same place as before, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.387.1">Figure 7</span></em></span><em class="italic"><span class="koboSpan" id="kobo.388.1">.16</span></em><span class="koboSpan" id="kobo.389.1">. </span><span class="koboSpan" id="kobo.389.2">This indicates that we may have an </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1">SSTI vulnerability:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer183">
<span class="koboSpan" id="kobo.391.1"><img alt="Figure 7.15 – The math operation rendered to the web page" src="image/Figure_7.15_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.392.1">Figure 7.15 – The math operation rendered to the web page</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.393.1">Refer to the Ruby documentation and use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">system()</span></strong><span class="koboSpan" id="kobo.395.1"> method. </span><span class="koboSpan" id="kobo.395.2">This method can be used to execute arbitrary operating system commands. </span><span class="koboSpan" id="kobo.395.3">You can test that the commands work with a simple </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">Linux command:</span></span><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.397.1">&lt;%= system("pwd") %&gt;</span></strong></pre><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.398.1">&lt;%= system("ls -a") %&gt;</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.399.1">Here we </span><a id="_idIndexMarker359"/><span class="koboSpan" id="kobo.400.1">can see the result of the command displayed back in the </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">web application:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer184">
<span class="koboSpan" id="kobo.402.1"><img alt="Figure 7.16 – The pwd command result" src="image/Figure_7.16_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.403.1">Figure 7.16 – The pwd command result</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.404.1">Now that we can see the server is executing commands to print the current working directory as well as listing all files, let’s build a payload that will delete a file from </span><span class="No-Break"><span class="koboSpan" id="kobo.405.1">Carlos’s directory:</span></span><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.406.1">&lt;%= system("rm /home/carlos/morale.txt") %&gt;</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.407.1">Successful execution of the lab will result in a congratulations screen </span><span class="No-Break"><span class="koboSpan" id="kobo.408.1">being displayed:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer185">
<span class="koboSpan" id="kobo.409.1"><img alt="Figure 7.17 – Lab solved" src="image/Figure_7.17_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.410.1">Figure 7.17 – Lab solved</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.411.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.412.1">If the </span><a id="_idIndexMarker360"/><span class="koboSpan" id="kobo.413.1">command results in an error message or does not execute, convert the payload to be URL encoded, for </span><span class="No-Break"><span class="koboSpan" id="kobo.414.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.415.1">%3C%25%3D%20system%28%22ls%20-a%22%29%20%25%3E</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.416.1">.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.417.1">Use the OWASP ZAP </span><strong class="bold"><span class="koboSpan" id="kobo.418.1">Encode/Decode/Hash</span></strong><span class="koboSpan" id="kobo.419.1"> tool or the </span><em class="italic"><span class="koboSpan" id="kobo.420.1">Ctrl + E </span></em><span class="koboSpan" id="kobo.421.1">shortcut, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.422.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.423.1">.18</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer186">
<span class="koboSpan" id="kobo.425.1"><img alt="Figure 7.18 – The Encode/Decode/Hash tool" src="image/Figure_7.18_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.426.1">Figure 7.18 – The Encode/Decode/Hash tool</span></p>
<h2 id="_idParaDest-218"><a id="_idTextAnchor283"/><span class="koboSpan" id="kobo.427.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.428.1">You can </span><a id="_idIndexMarker361"/><span class="koboSpan" id="kobo.429.1">use static template files in your application thanks to template engines such as Smarty for PHP, Freemarker for Java, or Jinja2 for Python. </span><span class="koboSpan" id="kobo.429.2">The template engine replaces variables in the template file with actual user-provided values at runtime and converts the template into an HTML file that is sent to </span><span class="No-Break"><span class="koboSpan" id="kobo.430.1">the client.</span></span></p>
<p><span class="koboSpan" id="kobo.431.1">By submitting invalid syntax, a resulting error message will indicate to an attacker what template engine is being used and, in some cases, which version. </span><span class="koboSpan" id="kobo.431.2">This allows an attacker insight into crafting malicious payloads or invalid syntax into a template to execute </span><span class="No-Break"><span class="koboSpan" id="kobo.432.1">server-side commands.</span></span></p>
<h2 id="_idParaDest-219"><a id="_idTextAnchor284"/><span class="koboSpan" id="kobo.433.1">There’s more...</span></h2>
<p><span class="koboSpan" id="kobo.434.1">Developers use server-side templates to preemptively load a web page with custom user data directly on the server. </span><span class="koboSpan" id="kobo.434.2">It is common for web frameworks to generate HTML code dynamically, where the template contains the static parts of the desired HTML output as well as the syntax that describes how dynamic content will </span><span class="No-Break"><span class="koboSpan" id="kobo.435.1">be inserted.</span></span></p>
<p><span class="koboSpan" id="kobo.436.1">The template </span><a id="_idIndexMarker362"/><span class="koboSpan" id="kobo.437.1">engines then process template files, assisting in the fusion of dynamic data into web pages. </span><span class="koboSpan" id="kobo.437.2">When an HTTP request is received, the template engine generates the HTML </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">output response.</span></span></p>
<h2 id="_idParaDest-220"><a id="_idTextAnchor285"/><span class="koboSpan" id="kobo.439.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.440.1">GitHub SSTI </span><span class="No-Break"><span class="koboSpan" id="kobo.441.1">payloads: </span></span><a href="https://github.com/payloadbox/ssti-payloads"><span class="No-Break"><span class="koboSpan" id="kobo.442.1">https://github.com/payloadbox/ssti-payloads</span></span></a></p>
<p><span class="koboSpan" id="kobo.443.1">For further reading on template frameworks, visit the </span><span class="No-Break"><span class="koboSpan" id="kobo.444.1">followi</span></span><a href="https://www.smarty.net/"><span class="No-Break"><span class="koboSpan" id="kobo.445.1">ng links:</span></span></a></p>
<p><a href="https://www.smarty.net/"><span class="No-Break"><span class="koboSpan" id="kobo.446.1">For PHP:</span></span></a></p>
<ul>
<li><a href="https://www.smarty.net/"><span class="No-Break"><span class="koboSpan" id="kobo.447.1">Sma</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.448.1">rty: </span></span><a href="https://www.smarty.net/"><span class="No-Break"><span class="koboSpan" id="kobo.449.1">https://www.smarty.net/</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.450.1">Twig: </span></span><a href="https://twig.symfony.com/"><span class="No-Break"><span class="koboSpan" id="kobo.451.1">https://twig.symfony.com/</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.452.1">PHPTAL: </span></span><a href="https://phptal.org/"><span class="No-Break"><span class="koboSpan" id="kobo.453.1">https://phptal.org/</span></span></a></li>
</ul>
<p><span class="No-Break"><span class="koboSpan" id="kobo.454.1">For Java:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.455.1">JSP/JSTL: </span></span><a href="https://www.oracle.com/java/technologies/jstl-documentation.html"><span class="No-Break"><span class="koboSpan" id="kobo.456.1">https://www.oracle.com/java/technologies/jstl-documentation.html</span></span></a></li>
<li><span class="koboSpan" id="kobo.457.1">Apache </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">Velocity: </span></span><a href="https://velocity.apache.org/"><span class="No-Break"><span class="koboSpan" id="kobo.459.1">https://velocity.apache.org/</span></span></a></li>
<li><span class="koboSpan" id="kobo.460.1">Apache </span><span class="No-Break"><span class="koboSpan" id="kobo.461.1">FreeMarker: </span></span><a href="https://freemarker.apache.org/"><span class="No-Break"><span class="koboSpan" id="kobo.462.1">https://freemarker.apache.org/</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.463.1">Thymeleaf: </span></span><a href="https://www.thymeleaf.org/"><span class="No-Break"><span class="koboSpan" id="kobo.464.1">https://www.thymeleaf.org/</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.465.1">Pippo: </span></span><a href="http://www.pippo.ro/"><span class="No-Break"><span class="koboSpan" id="kobo.466.1">http://www.pippo.ro/</span></span></a></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.467.1">Groovy Server Pages</span></strong><span class="koboSpan" id="kobo.468.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.469.1">GSP</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.470.1">): </span></span><a href="https://gsp.grails.org/latest/guide/index.html"><span class="No-Break"><span class="koboSpan" id="kobo.471.1">https://gsp.grails.org/latest/guide/index.html</span></span></a></li>
</ul>
<p><span class="No-Break"><span class="koboSpan" id="kobo.472.1">For </span></span><span class="No-Break"><a id="_idIndexMarker363"/></span><span class="No-Break"><span class="koboSpan" id="kobo.473.1">Python:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.474.1">Jinja2: </span></span><a href="https://pypi.org/project/Jinja2/"><span class="No-Break"><span class="koboSpan" id="kobo.475.1">https://pypi.org/project/Jinja2/</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.476.1">Mako: </span></span><a href="https://www.makotemplates.org/"><span class="No-Break"><span class="koboSpan" id="kobo.477.1">https://www.makotemplates.org/</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.478.1">Tornado: </span></span><a href="https://pypi.org/project/tornado/"><span class="No-Break"><span class="koboSpan" id="kobo.479.1">https://pypi.org/project/tornado/</span></span></a></li>
</ul>
<p><span class="No-Break"><span class="koboSpan" id="kobo.480.1">For </span></span><span class="No-Break"><a id="_idIndexMarker364"/></span><span class="No-Break"><span class="koboSpan" id="kobo.481.1">Ruby:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.482.1">ERB: </span></span><a href="https://ruby-doc.org/stdlib-3.1.2/libdoc/erb/rdoc/index.html"><span class="No-Break"><span class="koboSpan" id="kobo.483.1">https://ruby-doc.org/stdlib-3.1.2/libdoc/erb/rdoc/index.html</span></span></a></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.484.1">system()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.485.1">: </span></span><a href="https://www.rubyguides.com/2018/12/ruby-system/"><span class="No-Break"><span class="koboSpan" id="kobo.486.1">https://www.rubyguides.com/2018/12/ruby-system/</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.487.1">Haml: </span></span><a href="https://rubygems.org/gems/haml/versions/5.1.2"><span class="No-Break"><span class="koboSpan" id="kobo.488.1">https://rubygems.org/gems/haml/versions/5.1.2</span></span></a></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.489.1">Slim: </span></span><a href="https://rubygems.org/gems/slim/versions/4.1.0"><span class="No-Break"><span class="koboSpan" id="kobo.490.1">https://rubygems.org/gems/slim/vers</span><span id="_idTextAnchor286"/><span class="koboSpan" id="kobo.491.1">ions/4.1.0</span></span></a></li>
</ul>
<h1 id="_idParaDest-221"><a id="_idTextAnchor287"/><span class="koboSpan" id="kobo.492.1">Testing for server-side request forgery</span></h1>
<p><span class="koboSpan" id="kobo.493.1">Internal and external resources routinely interact with web applications. </span><span class="koboSpan" id="kobo.493.2">While you would expect </span><a id="_idIndexMarker365"/><span class="koboSpan" id="kobo.494.1">only the intended resource to receive the data you supply, improper data management might result in SSRF, a kind of injection attack. </span><span class="koboSpan" id="kobo.494.2">A successful SSRF attack can grant the attacker access to restricted operations, internal services, or internal files within the program or the company. </span><span class="koboSpan" id="kobo.494.3">In this recipe, we will show how to perform an SSRF attack on a backend system to search for an internal IP address and subsequently remove </span><span class="No-Break"><span class="koboSpan" id="kobo.495.1">the user.</span></span></p>
<h2 id="_idParaDest-222"><a id="_idTextAnchor288"/><span class="koboSpan" id="kobo.496.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.497.1">Start up your local ZAP tool and log in to your PortSwigger Academy account, then go to the </span><em class="italic"><span class="koboSpan" id="kobo.498.1">Basic SSRF against another back-end system</span></em><span class="koboSpan" id="kobo.499.1"> lab </span><span class="No-Break"><span class="koboSpan" id="kobo.500.1">at </span></span><a href="https://portswigger.net/web-security/ssrf/lab-basic-ssrf-against-backend-system"><span class="No-Break"><span class="koboSpan" id="kobo.501.1">https://portswigger.net/web-security/ssrf/lab-basic-ssrf-against-backend-system</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.502.1">.</span></span></p>
<h2 id="_idParaDest-223"><a id="_idTextAnchor289"/><span class="koboSpan" id="kobo.503.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.504.1">We’ll utilize the PortSwigger Academy </span><em class="italic"><span class="koboSpan" id="kobo.505.1">Basic SSRF versus another back-end system</span></em><span class="koboSpan" id="kobo.506.1"> lab in this recipe. </span><span class="koboSpan" id="kobo.506.2">SSRF is an attack where an attacker sends malicious requests from a susceptible server to a target server, gaining access to otherwise restricted resources or information. </span><span class="koboSpan" id="kobo.506.3">Backend systems are the infrastructure and components that enable a website or application to function. </span><span class="koboSpan" id="kobo.506.4">These systems are often invisible to the end user and are in charge of functions such as data storage and processing, request and response management, and </span><span class="No-Break"><span class="koboSpan" id="kobo.507.1">system integration.</span></span></p>
<p><span class="koboSpan" id="kobo.508.1">Backend systems include </span><span class="No-Break"><span class="koboSpan" id="kobo.509.1">the following:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.510.1">Databases</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.511.1">Application servers</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.512.1">Integration systems</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.513.1">Backend systems, in general, are a significant aspect of a website’s or application’s overall architecture and are responsible for most of the behind-the-scenes work that allows the program to </span><span class="No-Break"><span class="koboSpan" id="kobo.514.1">run successfully.</span></span></p>
<p><span class="koboSpan" id="kobo.515.1">This lab </span><a id="_idIndexMarker366"/><span class="koboSpan" id="kobo.516.1">contains a stock check feature that retrieves data from an internal system and then scans the internal IP address range for an admin interface, which is then used to remove the </span><span class="No-Break"><span class="koboSpan" id="kobo.517.1">user Carlos.</span></span></p>
<p><span class="koboSpan" id="kobo.518.1">The following steps walk you through completing the lab and exploiting </span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">the vulnerability:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.520.1">Visit the web application and capture the traffic via a Manual or Automated Scan </span><span class="No-Break"><span class="koboSpan" id="kobo.521.1">in ZAP.</span></span></li>
<li><span class="koboSpan" id="kobo.522.1">Next, visit any product and click on </span><strong class="bold"><span class="koboSpan" id="kobo.523.1">Check stock</span></strong><span class="koboSpan" id="kobo.524.1">, using </span><strong class="bold"><span class="koboSpan" id="kobo.525.1">Break Set</span></strong><span class="koboSpan" id="kobo.526.1">, intercept the request, or select the path from the </span><strong class="bold"><span class="koboSpan" id="kobo.527.1">Sites</span></strong><span class="koboSpan" id="kobo.528.1"> window, right-clicking and going to </span><strong class="bold"><span class="koboSpan" id="kobo.529.1">Manual Request Editor</span></strong><span class="koboSpan" id="kobo.530.1">, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.531.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.532.1">.19</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.533.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer187">
<span class="koboSpan" id="kobo.534.1"><img alt="Figure 7.19 – Locate stockAPI from the Sites window" src="image/Figure_7.19_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.535.1">Figure 7.19 – Locate stockAPI from the Sites window</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.536.1">Change </span><a id="_idIndexMarker367"/><span class="koboSpan" id="kobo.537.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.538.1">stockApi</span></strong><span class="koboSpan" id="kobo.539.1"> parameter value to </span><strong class="source-inline"><span class="koboSpan" id="kobo.540.1">http://192.168.0.1:8080/admin/...</span></strong><span class="koboSpan" id="kobo.541.1">, which will let us access the administrator’s portal, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.542.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.543.1">.20</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.544.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer188">
<span class="koboSpan" id="kobo.545.1"><img alt="Figure 7.20 – The stockAPI request in Manual Request Editor" src="image/Figure_7.20_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.546.1">Figure 7.20 – The stockAPI request in Manual Request Editor</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.547.1">Highlight </span><a id="_idIndexMarker368"/><span class="koboSpan" id="kobo.548.1">the final octet of the IP address (the number </span><strong class="source-inline"><span class="koboSpan" id="kobo.549.1">1</span></strong><span class="koboSpan" id="kobo.550.1">) and right-click to open in </span><strong class="bold"><span class="koboSpan" id="kobo.551.1">Fuzzer</span></strong><span class="koboSpan" id="kobo.552.1"> (shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.553.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.554.1">.21</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.555.1">):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer189">
<span class="koboSpan" id="kobo.556.1"><img alt="Figure 7.21 – The Fuzz stockAPI parameter value" src="image/Figure_7.21_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.557.1">Figure 7.21 – The Fuzz stockAPI parameter value</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.558.1">In </span><strong class="bold"><span class="koboSpan" id="kobo.559.1">Fuzz Locations</span></strong><span class="koboSpan" id="kobo.560.1">, click </span><strong class="bold"><span class="koboSpan" id="kobo.561.1">Add</span></strong><span class="koboSpan" id="kobo.562.1"> twice to open a menu and switch </span><strong class="bold"><span class="koboSpan" id="kobo.563.1">Type</span></strong><span class="koboSpan" id="kobo.564.1"> to </span><strong class="bold"><span class="koboSpan" id="kobo.565.1">Numberzz</span></strong><span class="koboSpan" id="kobo.566.1">. </span><span class="koboSpan" id="kobo.566.2">Then, fill in the following fields with the </span><span class="No-Break"><span class="koboSpan" id="kobo.567.1">values provided:</span></span><ul><li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.568.1">From</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.569.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.570.1">1</span></strong></span></li><li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.571.1">To</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">255</span></strong></span></li></ul></li>
<li><span class="koboSpan" id="kobo.574.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.575.1">Add</span></strong><span class="koboSpan" id="kobo.576.1"> to complete the payload (shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.577.1">Figure 7</span></em></span><em class="italic"><span class="koboSpan" id="kobo.578.1">.22</span></em><span class="koboSpan" id="kobo.579.1"> and </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.580.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.581.1">.23</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.583.1">Click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.584.1">Start Fuzzer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.585.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer190">
<span class="koboSpan" id="kobo.586.1"><img alt="Figure 7.22 – Fuzzing the API endpoint" src="image/Figure_7.22_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.587.1">Figure 7.22 – Fuzzing the API endpoint</span></p>
<div>
<div class="IMG---Figure" id="_idContainer191">
<span class="koboSpan" id="kobo.588.1"><img alt="Figure 7.23 – The Numberzz payload" src="image/Figure_7.23_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.589.1">Figure 7.23 – The Numberzz payload</span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.590.1">Click on the </span><strong class="bold"><span class="koboSpan" id="kobo.591.1">Status</span></strong><span class="koboSpan" id="kobo.592.1"> column in the Fuzzer </span><strong class="bold"><span class="koboSpan" id="kobo.593.1">Information</span></strong><span class="koboSpan" id="kobo.594.1"> window to sort the attack by status code. </span><span class="koboSpan" id="kobo.594.2">You will see an entry with a status of </span><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">200</span></strong><span class="koboSpan" id="kobo.596.1"> that showcases there is </span><a id="_idIndexMarker369"/><span class="koboSpan" id="kobo.597.1">a successful IP address for an admin page at </span><span class="No-Break"><span class="koboSpan" id="kobo.598.1">that location.</span></span></li>
<li><span class="koboSpan" id="kobo.599.1">Open the request again in </span><strong class="bold"><span class="koboSpan" id="kobo.600.1">Manual Request Editor</span></strong><span class="koboSpan" id="kobo.601.1">, and change the path in </span><strong class="bold"><span class="koboSpan" id="kobo.602.1">stockApi</span></strong><span class="koboSpan" id="kobo.603.1"> to the </span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">following string:</span></span><pre class="console"><span class="koboSpan" id="kobo.605.1">
/admin/delete?username=carlos</span></pre></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.606.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.607.1">Convert the parameters into </span><span class="No-Break"><span class="koboSpan" id="kobo.608.1">HTML-encoded strings.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.609.1">Send the request to delete </span><span class="No-Break"><span class="koboSpan" id="kobo.610.1">the user.</span></span></li>
</ol>
<h2 id="_idParaDest-224"><a id="_idTextAnchor290"/><span class="koboSpan" id="kobo.611.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.612.1">SSRF is a form of attack in which an application that interacts with the internal/external network or the host itself is exploited. </span><span class="koboSpan" id="kobo.612.2">An example would be the mishandling of URL parameter </span><a id="_idIndexMarker370"/><span class="koboSpan" id="kobo.613.1">factors or webhook customization, where users specify webhook handlers or callback URLs. </span><span class="koboSpan" id="kobo.613.2">Attackers can also interact with requests of another service to provide specific functionality. </span><span class="koboSpan" id="kobo.613.3">Most often, user data is sent to be processed by the server and, if improperly handled, can then be used to perform specific </span><span class="No-Break"><span class="koboSpan" id="kobo.614.1">injection attacks.</span></span></p>
<p><span class="koboSpan" id="kobo.615.1">SSRF attacks entail convincing a server to make a request to an external resource on the attacker’s behalf. </span><span class="koboSpan" id="kobo.615.2">For </span><a id="_idIndexMarker371"/><span class="koboSpan" id="kobo.616.1">example, even if a </span><strong class="bold"><span class="koboSpan" id="kobo.617.1">web application firewall</span></strong><span class="koboSpan" id="kobo.618.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.619.1">WAF</span></strong><span class="koboSpan" id="kobo.620.1">) is blocking regular requests, an attacker may be able to carry out an SSRF attack by discovering a means to circumvent </span><span class="No-Break"><span class="koboSpan" id="kobo.621.1">the WAF.</span></span></p>
<p><span class="koboSpan" id="kobo.622.1">An attacker might achieve this by utilizing a bypass method to avoid detection by the WAF. </span><span class="koboSpan" id="kobo.622.2">An attacker, for example, might use URL encoding, Unicode encoding, or other ways to change the look of the request in a way that the WAF does not identify as malicious. </span><span class="koboSpan" id="kobo.622.3">An attacker might also circumvent a WAF by discovering a weakness in the application that allows them to launch an </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">SSRF attack.</span></span></p>
<p><span class="koboSpan" id="kobo.624.1">For example, an attacker may discover a weakness in the application’s input validation that allows them to inject a URL into a form field that the server will execute on their behalf, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.625.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.626.1">.24</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.627.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer192">
<span class="koboSpan" id="kobo.628.1"><img alt="Figure 7.24 – Diagram of an SSRF attack" src="image/Figure_7.24_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.629.1">Figure 7.24 – Diagram of an SSRF attack</span></p>
<h2 id="_idParaDest-225"><a id="_idTextAnchor291"/><span class="koboSpan" id="kobo.630.1">There’s more...</span></h2>
<p><span class="koboSpan" id="kobo.631.1">The HTTP </span><a id="_idIndexMarker372"/><span class="koboSpan" id="kobo.632.1">protocol is not the only protocol where SSRF can occur. </span><span class="koboSpan" id="kobo.632.2">HTTP is used first in requests, but if an application performs a second request, it may use a variety of other protocols, such as FTP, SMB, SMTP, or others and/or schemes such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">file:/</span></strong><span class="koboSpan" id="kobo.634.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.635.1">data:/</span></strong><span class="koboSpan" id="kobo.636.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.637.1">dict:/</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.638.1">and more.</span></span></p>
<p><span class="koboSpan" id="kobo.639.1">In addition, SSRF is frequently used in cloud environments to gain access to and steal credentials or access tokens from metadata services, such as metadata servers in AWS or </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">Azure environments.</span></span></p>
<p><span class="koboSpan" id="kobo.641.1">Lastly, consider </span><a id="_idIndexMarker373"/><span class="koboSpan" id="kobo.642.1">other attacks, such as </span><strong class="bold"><span class="koboSpan" id="kobo.643.1">XML External Entity</span></strong><span class="koboSpan" id="kobo.644.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.645.1">XXE</span></strong><span class="koboSpan" id="kobo.646.1">) that can be leveraged to exploit an </span><span class="No-Break"><span class="koboSpan" id="kobo.647.1">SSRF vulnerability.</span></span></p>
<h2 id="_idParaDest-226"><a id="_idTextAnchor292"/><span class="koboSpan" id="kobo.648.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.649.1">For more information on XXE, visit </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.650.1">Chapter 13</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.651.1">.</span></span></p>
</div>
</body></html>