<html><head></head><body>
<div class="IMG---Figure" id="_idContainer221">
<h1 class="chapter-number" id="_idParaDest-227"><a id="_idTextAnchor293"/><span class="koboSpan" id="kobo.1.1">8</span></h1>
<h1 id="_idParaDest-228"><a id="_idTextAnchor294"/><span class="koboSpan" id="kobo.2.1">Business Logic Testing</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Hooray! </span><span class="koboSpan" id="kobo.3.2">You’re a third of the way through. </span><span class="koboSpan" id="kobo.3.3">In this chapter, we will be covering </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">business logic flaws</span></strong><span class="koboSpan" id="kobo.5.1">. </span><span class="koboSpan" id="kobo.5.2">Business</span><a id="_idIndexMarker374"/><span class="koboSpan" id="kobo.6.1"> logic flaws are types of errors where an attacker finds ways of using an application’s actual handling stream in a manner that has a negative impact on </span><span class="No-Break"><span class="koboSpan" id="kobo.7.1">the associations.</span></span></p>
<p><span class="koboSpan" id="kobo.8.1">Here, you will learn how to bypass the frontend GUI application and send data directly to the backend for processing by forging requests. </span><span class="koboSpan" id="kobo.8.2">We’ll also discover how to manipulate and disrupt designed business process flows by simply keeping active sessions open and failing to submit transactions within the </span><em class="italic"><span class="koboSpan" id="kobo.9.1">expected</span></em><span class="koboSpan" id="kobo.10.1"> time frame in the </span><em class="italic"><span class="koboSpan" id="kobo.11.1">Test for process timing</span></em><span class="koboSpan" id="kobo.12.1"> recipe. </span><span class="koboSpan" id="kobo.12.2">Furthermore, we will learn about workflow vulnerabilities that include any flaw that enables an attacker to abuse a system or application in such a way that they can avoid (not follow) the workflow that was planned </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1">or built.</span></span></p>
<p><span class="koboSpan" id="kobo.14.1">Lastly, we’ll look at unexpected file type uploads, where the application might only accept certain file types, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.15.1">.csv</span></strong><span class="koboSpan" id="kobo.16.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.17.1">.txt</span></strong><span class="koboSpan" id="kobo.18.1"> files, to be submitted for processing and might not check the uploaded file’s content or extension. </span><span class="koboSpan" id="kobo.18.2">This could produce unexpected system or database results or provide attackers with new vulnerabilities </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">to exploit.</span></span><a id="_idTextAnchor295"/></p>
<p><span class="koboSpan" id="kobo.20.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.22.1">Test ability to </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">forge requests</span></span></li>
<li><span class="koboSpan" id="kobo.24.1">Test for </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">process timing</span></span></li>
<li><span class="koboSpan" id="kobo.26.1">Testing for the circumvention </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">of workflows</span></span></li>
<li><span class="koboSpan" id="kobo.28.1">Test upload of unexpected file types with a </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">malicious payload</span></span></li>
</ul>
<h1 id="_idParaDest-229"><a id="_idTextAnchor296"/><span class="koboSpan" id="kobo.30.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.31.1">You will need to install the OWASP ZAP Proxy in order to utilize your PortSwigger account for access to the PortSwigger Academy labs that will be used in this </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">chapter’s recipes.</span></span><a id="_idTextAnchor297"/></p>
<h1 id="_idParaDest-230"><a id="_idTextAnchor298"/><span class="koboSpan" id="kobo.33.1">Test ability to forge requests</span></h1>
<p><span class="koboSpan" id="kobo.34.1">Attackers use</span><a id="_idIndexMarker375"/><span class="koboSpan" id="kobo.35.1"> forged requests to deliver data directly to the application’s backend for processing instead of using its </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">frontend GUI.</span></span></p>
<p><span class="koboSpan" id="kobo.37.1">The attacker attempts to submit HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.38.1">GET</span></strong><span class="koboSpan" id="kobo.39.1">/</span><strong class="source-inline"><span class="koboSpan" id="kobo.40.1">POST</span></strong><span class="koboSpan" id="kobo.41.1"> requests with data values that are not permitted, protected against, or anticipated by the business logic of the application using an intercepting proxy; in this case, OWASP ZAP. </span><span class="koboSpan" id="kobo.41.2">In this recipe, the attacker (you) will exploit a defect in the application’s logic to make a purchase of a leather jacket at an </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">unanticipated cost.</span></span></p>
<h2 id="_idParaDest-231"><a id="_idTextAnchor299"/><span class="koboSpan" id="kobo.43.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.44.1">This lab requires a PortSwigger Academy account and ZAP to be able to intercept requests and responses from the server to </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">your browser.</span></span></p>
<h2 id="_idParaDest-232"><a id="_idTextAnchor300"/><span class="koboSpan" id="kobo.46.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.47.1">In this section, we will be using PortSwigger Academy’s </span><em class="italic"><span class="koboSpan" id="kobo.48.1">Excessive trust in client-side control</span></em><span class="koboSpan" id="kobo.49.1"> lab to change the price of the product by editing the request. </span><span class="koboSpan" id="kobo.49.2">Please follow these instructions to complete </span><span class="No-Break"><span class="koboSpan" id="kobo.50.1">this lab:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.51.1">Navigate to the URL with the browser proxied to ZAP and log in to the PortSwigger Academy website to launch </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">the lab:</span></span></li>
</ol>
<p><a href="https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-excessive-trust-in-client-side-controls"><span class="No-Break"><span class="koboSpan" id="kobo.53.1">https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-excessive-trust-in-client-side-controls</span></span></a></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.54.1">Once you access the lab, log in to the lab application under </span><strong class="bold"><span class="koboSpan" id="kobo.55.1">My Account</span></strong><span class="koboSpan" id="kobo.56.1"> and use the provided </span><strong class="bold"><span class="koboSpan" id="kobo.57.1">Username</span></strong><span class="koboSpan" id="kobo.58.1">/</span><strong class="bold"><span class="koboSpan" id="kobo.59.1">Password</span></strong><span class="koboSpan" id="kobo.60.1"> of </span><strong class="source-inline"><span class="koboSpan" id="kobo.61.1">wiener</span></strong><span class="koboSpan" id="kobo.62.1">/</span><strong class="source-inline"><span class="koboSpan" id="kobo.63.1">peter</span></strong><span class="koboSpan" id="kobo.64.1">. </span><span class="koboSpan" id="kobo.64.2">You won’t be able to complete a purchase without being </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">logged in.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.66.1">You’ll also notice the account has a store credit balance </span><span class="No-Break"><span class="koboSpan" id="kobo.67.1">of </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.68.1">$100.00</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.70.1">Attempt to buy the first item, </span><strong class="bold"><span class="koboSpan" id="kobo.71.1">Lightweight ‘l33t’ Leather Jacket</span></strong><span class="koboSpan" id="kobo.72.1">, by adding it to the cart and going through the entire process </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">to buy.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.74.1">The order gets rejected as you don’t have enough store credit, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.75.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.76.1">.1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer194">
<span class="koboSpan" id="kobo.78.1"><img alt="Figure 8.1 – Failed purchase of a lightweight jacket" src="image/Figure_8.1_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.79.1">Figure 8.1 – Failed purchase of a lightweight jacket</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.80.1">In ZAP, go </span><a id="_idIndexMarker376"/><span class="koboSpan" id="kobo.81.1">to </span><strong class="bold"><span class="koboSpan" id="kobo.82.1">History</span></strong><span class="koboSpan" id="kobo.83.1"> and look over the order process. </span><span class="koboSpan" id="kobo.83.2">You’ll notice that when you add an item to your cart, the corresponding request contains a </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">price parameter.</span></span></li>
<li><span class="koboSpan" id="kobo.85.1">Remove the item from your cart but stay on the page that says </span><strong class="bold"><span class="koboSpan" id="kobo.86.1">Cart </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.87.1">is empty</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.89.1">Right-click on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.90.1">POST &lt;url&gt;/cart</span></strong><span class="koboSpan" id="kobo.91.1"> request and open in </span><strong class="bold"><span class="koboSpan" id="kobo.92.1">Open/Resend With </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.93.1">Request Editor…</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.94.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.95.1">Within the Request Editor, change the price to an arbitrary integer and ensure there are two zeros at the end to account for change (that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.96.1">1700</span></strong><span class="koboSpan" id="kobo.97.1">), and then send the request, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.98.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.99.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer195">
<span class="koboSpan" id="kobo.101.1"><img alt="Figure 8.2 – Request with changed item price " src="image/Figure_8.2_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.102.1">Figure 8.2 – Request with changed item price</span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.103.1">On the web </span><a id="_idIndexMarker377"/><span class="koboSpan" id="kobo.104.1">page, refresh the cart and notice that the item has come back but confirm that the price was changed based on your input (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.105.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.106.1">.3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.107.1">):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer196">
<span class="koboSpan" id="kobo.108.1"><img alt="Figure 8.3 – Changed item back in the cart " src="image/Figure_8.3_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.109.1">Figure 8.3 – Changed item back in the cart</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.110.1">Repeat this</span><a id="_idIndexMarker378"/><span class="koboSpan" id="kobo.111.1"> process to set the price to any amount less than your available </span><span class="No-Break"><span class="koboSpan" id="kobo.112.1">store credit.</span></span></li>
<li><span class="koboSpan" id="kobo.113.1">Complete the order to solve the lab, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.114.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.115.1">.4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer197">
<span class="koboSpan" id="kobo.117.1"><img alt="Figure 8.4 – Completed purchase order " src="image/Figure_8.4_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.118.1">Figure 8.4 – Completed purchase order</span></p>
<h2 id="_idParaDest-233"><a id="_idTextAnchor301"/><span class="koboSpan" id="kobo.119.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.120.1">These flaws are exploited by looking over the project documentation for field functionality that can be inferred or predicted, or ones that are hidden. </span><span class="koboSpan" id="kobo.120.2">In order to avoid following the</span><a id="_idIndexMarker379"/><span class="koboSpan" id="kobo.121.1"> standard business logic procedure, insert logically </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">sound data.</span></span></p>
<h2 id="_idParaDest-234"><a id="_idTextAnchor302"/><span class="koboSpan" id="kobo.123.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.124.1">For other similar cases, refer to </span><span class="No-Break"><span class="koboSpan" id="kobo.125.1">the following:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.126.1">Testing for Exposed </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.127.1">Session Variables</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.128.1">:</span></span></li>
</ul>
<p><a href="https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/04-Testing_for_Exposed_Session_Variables"><span class="No-Break"><span class="koboSpan" id="kobo.129.1">https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/04-Testing_for_Exposed_Session_Variables</span></span></a></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.130.1">Testing for Cross-Site </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.131.1">Request Forgery</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.132.1">:</span></span></li>
</ul>
<p><a href="https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/05-Testing_for_Cross_Site_Request_Forgery"><span class="No-Break"><span class="koboSpan" id="kobo.133.1">https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/05-Testing_for_Cross_Site_Request_Forgery</span></span></a></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.134.1">Testing for Account Enumeration and Guessable </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.135.1">User Account</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.136.1">:</span></span></li>
</ul>
<p><a href="https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/03-Identity_Management_Testing/04-Testing_for_Account_Enumeration_and_Guessable_User_Account"><span class="No-Break"><span class="koboSpan" id="kobo.137.1">https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/03-Identity_Management_Testing/04-Testing_for_Account_Enumeration_and_Guessable_User_Account</span></span></a><span class="hidden"><a id="_idTextAnchor303"/></span></p>
<h1 id="_idParaDest-235"><a id="_idTextAnchor304"/><span class="koboSpan" id="kobo.138.1">Test for process timing</span></h1>
<p><span class="koboSpan" id="kobo.139.1">Process timing test is a type </span><a id="_idIndexMarker380"/><span class="koboSpan" id="kobo.140.1">of business logic testing that focuses on finding flows in how applications accomplish certain processes, such as authentication. </span><span class="koboSpan" id="kobo.140.2">In the process timing testing, the tester looks at how long it takes the application to process valid versus invalid inputs or actions. </span><span class="koboSpan" id="kobo.140.3">The tester validates that an attacker is unable to determine the behavior of an application based on the time it takes the application to finish an action. </span><span class="koboSpan" id="kobo.140.4">In the authentication example, by monitoring the process timing, based on the timing variation between entering valid credentials versus invalid credentials, an attacker can determine whether the credentials are valid without having to depend on </span><span class="No-Break"><span class="koboSpan" id="kobo.141.1">the GUI.</span></span></p>
<h2 id="_idParaDest-236"><a id="_idTextAnchor305"/><span class="koboSpan" id="kobo.142.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.143.1">For this recipe, you will need to start PortSwigger’s </span><em class="italic"><span class="koboSpan" id="kobo.144.1">Username enumerations via response timing</span></em><span class="koboSpan" id="kobo.145.1"> lab and ensure that ZAP is intercepting traffic between the lab application and </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">your browser.</span></span></p>
<h2 id="_idParaDest-237"><a id="_idTextAnchor306"/><span class="koboSpan" id="kobo.147.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.148.1">The following</span><a id="_idIndexMarker381"/><span class="koboSpan" id="kobo.149.1"> step-by-step tutorial demonstrates how to use process timing to find the correct </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">login information:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.151.1">Navigate to the following URL with the browser proxied to ZAP and log in to the PortSwigger Academy website to launch </span><span class="No-Break"><span class="koboSpan" id="kobo.152.1">the lab:</span></span></li>
</ol>
<p><a href="https://portswigger.net/web-security/authentication/password-based/lab-username-enumeration-via-response-timing"><span class="No-Break"><span class="koboSpan" id="kobo.153.1">https://portswigger.net/web-security/authentication/password-based/lab-username-enumeration-via-response-timing</span></span></a></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.154.1">Open the </span><em class="italic"><span class="koboSpan" id="kobo.155.1">Username enumerations via response timing</span></em><span class="koboSpan" id="kobo.156.1"> lab and start ZAP to intercept the communications between your browser and </span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">the lab.</span></span></li>
<li><span class="koboSpan" id="kobo.158.1">Create a context and add the application URL to it, and click on the target symbol to display only requests from the application in the </span><strong class="bold"><span class="koboSpan" id="kobo.159.1">Sites Tree</span></strong><span class="koboSpan" id="kobo.160.1"> and the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.161.1">History</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.162.1"> tabs.</span></span></li>
<li><span class="koboSpan" id="kobo.163.1">Attempt to log in using any different usernames and passwords five times; as you can see in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.164.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.165.1">.5</span></em><span class="koboSpan" id="kobo.166.1">, your IP address has </span><span class="No-Break"><span class="koboSpan" id="kobo.167.1">been blocked.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer198">
<span class="koboSpan" id="kobo.168.1"><img alt="Figure 8.5 – User account blocked for 30 minutes " src="image/Figure_8.5_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.169.1">Figure 8.5 – User account blocked for 30 minutes</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.170.1">If the IP address </span><a id="_idIndexMarker382"/><span class="koboSpan" id="kobo.171.1">is blocked, we won’t be able to perform a brute-force attack. </span><span class="koboSpan" id="kobo.171.2">To get around this issue, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.172.1">X-Forwarded-For</span></strong><span class="koboSpan" id="kobo.173.1"> HTTP header, which will allow us to spoof the IP address. </span><span class="koboSpan" id="kobo.173.2">Now, select the </span><strong class="source-inline"><span class="koboSpan" id="kobo.174.1">POST</span></strong><span class="koboSpan" id="kobo.175.1"> request that is sent when you try to log in; the URL for the request ends in </span><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">/login</span></strong><span class="koboSpan" id="kobo.177.1">, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.178.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.179.1">.6</span></em><span class="koboSpan" id="kobo.180.1">. </span><span class="koboSpan" id="kobo.180.2">Right-click the request and select the </span><strong class="bold"><span class="koboSpan" id="kobo.181.1">Open/Resend With Request </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.182.1">Editor…</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.183.1"> option:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer199">
<span class="koboSpan" id="kobo.184.1"><img alt="Figure 8.6 – POST request of login " src="image/Figure_8.6_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.185.1">Figure 8.6 – POST request of login</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.186.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.187.1">Request Editor</span></strong><span class="koboSpan" id="kobo.188.1"> window will open. </span><span class="koboSpan" id="kobo.188.2">In the </span><strong class="bold"><span class="koboSpan" id="kobo.189.1">Request</span></strong><span class="koboSpan" id="kobo.190.1"> tab, scroll down to the end of the HTTP headers and add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">X-Forwarded-For</span></strong><span class="koboSpan" id="kobo.192.1"> header at the end. </span><span class="koboSpan" id="kobo.192.2">Let’s set the value of the header to </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">100</span></strong><span class="koboSpan" id="kobo.194.1">, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.195.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.196.1">.7</span></em><span class="koboSpan" id="kobo.197.1">. </span><span class="koboSpan" id="kobo.197.2">Change the values of the username and password and click on </span><strong class="bold"><span class="koboSpan" id="kobo.198.1">Send</span></strong><span class="koboSpan" id="kobo.199.1">. </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.200.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.201.1">.7</span></em><span class="koboSpan" id="kobo.202.1"> also shows the </span><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">username</span></strong><span class="koboSpan" id="kobo.204.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.205.1">password</span></strong><span class="koboSpan" id="kobo.206.1"> fields highlighted; the values for the fields in the picture are </span><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">admin</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.208.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.209.1">admin</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.211.1">As you can see, the request was </span><span class="No-Break"><span class="koboSpan" id="kobo.212.1">sent successfully.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer200">
<span class="koboSpan" id="kobo.213.1"><img alt="Figure 8.7 – X-Forwarded-For header " src="image/Figure_8.7_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.214.1">Figure 8.7 – X-Forwarded-For header</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.215.1">To be able to change the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">X-Forwarded-For</span></strong><span class="koboSpan" id="kobo.217.1"> field automatically and constantly, we will need to download </span><strong class="bold"><span class="koboSpan" id="kobo.218.1">Community Scripts</span></strong><span class="koboSpan" id="kobo.219.1">. </span><span class="koboSpan" id="kobo.219.2">This is needed in order to</span><a id="_idIndexMarker383"/><span class="koboSpan" id="kobo.220.1"> brute-force the </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">password</span></strong><span class="koboSpan" id="kobo.222.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.223.1">username</span></strong><span class="koboSpan" id="kobo.224.1"> fields. </span><span class="koboSpan" id="kobo.224.2">Here are the instructions to download </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.225.1">Community Scripts</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">:</span></span><ol><li><span class="koboSpan" id="kobo.227.1">So to start, open the </span><strong class="bold"><span class="koboSpan" id="kobo.228.1">Manage Add-ons</span></strong><span class="koboSpan" id="kobo.229.1"> window by clicking the three-cube icon, as highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.230.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.231.1">.8</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.232.1">:</span></span></li></ol></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer201">
<span class="koboSpan" id="kobo.233.1"><img alt="Figure 8.8 – Manage Add-Ons icon " src="image/Figure_8.8_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.234.1">Figure 8.8 – Manage Add-Ons icon</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.235.1">Once the </span><strong class="bold"><span class="koboSpan" id="kobo.236.1">Manage Add-ons</span></strong><span class="koboSpan" id="kobo.237.1"> window opens, navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.238.1">Marketplace</span></strong><span class="koboSpan" id="kobo.239.1"> tab and search for </span><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">Community Scripts</span></strong><span class="koboSpan" id="kobo.241.1">. </span><span class="koboSpan" id="kobo.241.2">Check the checkbox next to it and click on </span><strong class="bold"><span class="koboSpan" id="kobo.242.1">Install Selected</span></strong><span class="koboSpan" id="kobo.243.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.244.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.245.1">.9</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.246.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer202">
<span class="koboSpan" id="kobo.247.1"><img alt="Figure 8.9 – Marketplace Community Scripts " src="image/Figure_8.9_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.248.1">Figure 8.9 – Marketplace Community Scripts</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.249.1">After </span><strong class="bold"><span class="koboSpan" id="kobo.250.1">Community Scripts</span></strong><span class="koboSpan" id="kobo.251.1"> has been installed, click on the plus icon next to the </span><strong class="bold"><span class="koboSpan" id="kobo.252.1">Sites</span></strong><span class="koboSpan" id="kobo.253.1"> tab and select </span><strong class="bold"><span class="koboSpan" id="kobo.254.1">Scripts</span></strong><span class="koboSpan" id="kobo.255.1"> to add the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.256.1">Scripts</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.257.1"> tab.</span></span></li>
<li><span class="koboSpan" id="kobo.258.1">Expand the </span><strong class="bold"><span class="koboSpan" id="kobo.259.1">Fuzzer HTTP Processor</span></strong><span class="koboSpan" id="kobo.260.1"> section and enable </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">random_x_forwarded_for_ip.js</span></strong><span class="koboSpan" id="kobo.262.1"> by right-clicking it and clicking on </span><strong class="bold"><span class="koboSpan" id="kobo.263.1">Enable Script(s)</span></strong><span class="koboSpan" id="kobo.264.1">, as</span><a id="_idIndexMarker384"/><span class="koboSpan" id="kobo.265.1"> shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.266.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.267.1">.10</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer203">
<span class="koboSpan" id="kobo.269.1"><img alt="Figure 8.10 – Enable Script(s) " src="image/Figure_8.10_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.270.1">Figure 8.10 – Enable Script(s)</span></p>
<p><span class="koboSpan" id="kobo.271.1">The following is the code of the script just in case it is removed from </span><span class="No-Break"><span class="koboSpan" id="kobo.272.1">Community Scripts:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.273.1">
function processMessage(utils, message) {
     var random_ip = Math.floor(Math.random() * 254)+ "." </span><span class="koboSpan" id="kobo.273.2">+ Math.floor(Math.random() * 254) + "." </span><span class="koboSpan" id="kobo.273.3">+ Math.floor(Math.random() * 254) + "." </span><span class="koboSpan" id="kobo.273.4">+ Math.floor(Math.random() * 254);
     message.getRequestHeader().setHeader("X-Forwarded-For", random_ip);
}
function processResult(utils, fuzzResult){
     return true;
}
function getRequiredParamsNames(){
     return [];
}
function getOptionalParamsNames(){
     return [];
}</span></pre>
<ol>
<li value="8"><span class="koboSpan" id="kobo.274.1">Now, right-click</span><a id="_idIndexMarker385"/><span class="koboSpan" id="kobo.275.1"> the last request we sent, where we added the </span><strong class="source-inline"><span class="koboSpan" id="kobo.276.1">X-Forwarded-For</span></strong><span class="koboSpan" id="kobo.277.1"> header; the source of the request should say </span><strong class="bold"><span class="koboSpan" id="kobo.278.1">Manual</span></strong><span class="koboSpan" id="kobo.279.1">. </span><span class="koboSpan" id="kobo.279.2">Click on </span><strong class="bold"><span class="koboSpan" id="kobo.280.1">Open</span></strong><span class="koboSpan" id="kobo.281.1">/</span><strong class="bold"><span class="koboSpan" id="kobo.282.1">Resend with Request Editor…</span></strong><span class="koboSpan" id="kobo.283.1">, and the request will open in the </span><strong class="bold"><span class="koboSpan" id="kobo.284.1">Request Editor</span></strong><span class="koboSpan" id="kobo.285.1"> window. </span><span class="koboSpan" id="kobo.285.2">Set the password to a very long password (300+ characters); in this request, I added </span><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">thezaplife</span></strong><span class="koboSpan" id="kobo.287.1"> 21 times as the password, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.288.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.289.1">.11</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer204">
<span class="koboSpan" id="kobo.291.1"><img alt="Figure 8.11 – Request Editor setting the password " src="image/Figure_8.11_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.292.1">Figure 8.11 – Request Editor setting the password</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.293.1">Right-click the last login request in the </span><strong class="bold"><span class="koboSpan" id="kobo.294.1">History</span></strong><span class="koboSpan" id="kobo.295.1"> tab – it should be the request to which we have added the long password, and the source of the request should say </span><strong class="bold"><span class="koboSpan" id="kobo.296.1">Manual</span></strong><span class="koboSpan" id="kobo.297.1">. </span><span class="koboSpan" id="kobo.297.2">Select </span><strong class="bold"><span class="koboSpan" id="kobo.298.1">Attack</span></strong><span class="koboSpan" id="kobo.299.1"> and click on </span><strong class="bold"><span class="koboSpan" id="kobo.300.1">Fuzz…</span></strong><span class="koboSpan" id="kobo.301.1">, which will open the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.302.1">Fuzzer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.303.1"> window.</span></span></li>
<li><span class="koboSpan" id="kobo.304.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.305.1">Message Processors</span></strong><span class="koboSpan" id="kobo.306.1"> tab, and click on </span><strong class="bold"><span class="koboSpan" id="kobo.307.1">Add…</span></strong><span class="koboSpan" id="kobo.308.1">, which will open the </span><strong class="bold"><span class="koboSpan" id="kobo.309.1">Add Message Processor</span></strong><span class="koboSpan" id="kobo.310.1"> window. </span><span class="koboSpan" id="kobo.310.2">In the </span><strong class="bold"><span class="koboSpan" id="kobo.311.1">Script</span></strong><span class="koboSpan" id="kobo.312.1"> field, select the script that we</span><a id="_idIndexMarker386"/><span class="koboSpan" id="kobo.313.1"> added earlier and click on </span><strong class="bold"><span class="koboSpan" id="kobo.314.1">Add</span></strong><span class="koboSpan" id="kobo.315.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.316.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.317.1">.12</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.318.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer205">
<span class="koboSpan" id="kobo.319.1"><img alt="Figure 8.12 – Message Processors " src="image/Figure_8.12_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.320.1">Figure 8.12 – Message Processors</span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.321.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.322.1">Fuzz Locations</span></strong><span class="koboSpan" id="kobo.323.1"> tab. </span><span class="koboSpan" id="kobo.323.2">In this step, we will brute force the username, so select the username and click on </span><strong class="bold"><span class="koboSpan" id="kobo.324.1">Add</span></strong><span class="koboSpan" id="kobo.325.1">. </span><span class="koboSpan" id="kobo.325.2">When you click on </span><strong class="bold"><span class="koboSpan" id="kobo.326.1">Add</span></strong><span class="koboSpan" id="kobo.327.1">, the </span><strong class="bold"><span class="koboSpan" id="kobo.328.1">Payloads</span></strong><span class="koboSpan" id="kobo.329.1"> window will open; click on </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.330.1">Add</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.331.1"> again.</span></span></li>
<li><span class="koboSpan" id="kobo.332.1">When the </span><strong class="bold"><span class="koboSpan" id="kobo.333.1">Add Payload</span></strong><span class="koboSpan" id="kobo.334.1"> window appears, select </span><strong class="bold"><span class="koboSpan" id="kobo.335.1">Strings</span></strong><span class="koboSpan" id="kobo.336.1"> as the type and enter the list of the usernames provided in the lab. </span><span class="koboSpan" id="kobo.336.2">The usernames are seen when you click on the </span><strong class="bold"><span class="koboSpan" id="kobo.337.1">Candidate usernames</span></strong><span class="koboSpan" id="kobo.338.1"> link on the lab home page before accessing the lab. </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.339.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.340.1">.13</span></em><span class="koboSpan" id="kobo.341.1"> shows the list of usernames in the payload. </span><span class="koboSpan" id="kobo.341.2">When you have entered the usernames, click on </span><strong class="bold"><span class="koboSpan" id="kobo.342.1">Add</span></strong><span class="koboSpan" id="kobo.343.1">, and then </span><strong class="bold"><span class="koboSpan" id="kobo.344.1">OK</span></strong><span class="koboSpan" id="kobo.345.1"> in the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.346.1">Payloads</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.347.1"> window.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer206">
<span class="koboSpan" id="kobo.348.1"><img alt="Figure 8.13 – Add Payload " src="image/Figure_8.13_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.349.1">Figure 8.13 – Add Payload</span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.350.1">Then, click</span><a id="_idIndexMarker387"/><span class="koboSpan" id="kobo.351.1"> on </span><strong class="bold"><span class="koboSpan" id="kobo.352.1">Start Fuzzer</span></strong><span class="koboSpan" id="kobo.353.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.354.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.355.1">.14</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.356.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer207">
<span class="koboSpan" id="kobo.357.1"><img alt="Figure 8.14 – Start Fuzzer of added payload " src="image/Figure_8.14_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.358.1">Figure 8.14 – Start Fuzzer of added payload</span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.359.1">The username</span><a id="_idIndexMarker388"/><span class="koboSpan" id="kobo.360.1"> with the longest RTT time is the correct username. </span><span class="koboSpan" id="kobo.360.2">In my case, the longest RTT time is associated with the username </span><strong class="source-inline"><span class="koboSpan" id="kobo.361.1">activestat</span></strong><span class="koboSpan" id="kobo.362.1">, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.363.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.364.1">.15</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.366.1">Keep a note of the five usernames with the longest RTT time; if you didn’t find the password for the first username, you can try the rest of </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">the usernames.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer208">
<span class="koboSpan" id="kobo.368.1"><img alt="Figure 8.15 – RTT time of password payloads " src="image/Figure_8.15_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.369.1">Figure 8.15 – RTT time of password payloads</span></p>
<ol>
<li value="16"><span class="koboSpan" id="kobo.370.1">Now that we have the username, we have to brute force the password. </span><span class="koboSpan" id="kobo.370.2">But first, we have to resend the request using </span><strong class="bold"><span class="koboSpan" id="kobo.371.1">Request Editor</span></strong><span class="koboSpan" id="kobo.372.1"> to change the username. </span><span class="koboSpan" id="kobo.372.2">Right-click the last login </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">POST</span></strong><span class="koboSpan" id="kobo.374.1"> request in the </span><strong class="bold"><span class="koboSpan" id="kobo.375.1">History</span></strong><span class="koboSpan" id="kobo.376.1"> tab, and select </span><strong class="bold"><span class="koboSpan" id="kobo.377.1">Open</span></strong><span class="koboSpan" id="kobo.378.1">/</span><strong class="bold"><span class="koboSpan" id="kobo.379.1">Resend with </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.380.1">Request Editor…</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.382.1">Once the </span><strong class="bold"><span class="koboSpan" id="kobo.383.1">Request Editor</span></strong><span class="koboSpan" id="kobo.384.1"> window opens, change the username to the username with the longest RTT time. </span><span class="koboSpan" id="kobo.384.2">In my case, the username will be </span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">activestat</span></strong><span class="koboSpan" id="kobo.386.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.387.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.388.1">.16</span></em><span class="koboSpan" id="kobo.389.1">. </span><span class="koboSpan" id="kobo.389.2">Click </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1">on </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.391.1">Send</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.392.1">.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer209">
<span class="koboSpan" id="kobo.393.1"><img alt="Figure 8.16 – Username of activestat " src="image/Figure_8.16_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.394.1">Figure 8.16 – Username of activestat</span></p>
<ol>
<li value="18"><span class="koboSpan" id="kobo.395.1">Find the</span><a id="_idIndexMarker389"/><span class="koboSpan" id="kobo.396.1"> request in the </span><strong class="bold"><span class="koboSpan" id="kobo.397.1">History</span></strong><span class="koboSpan" id="kobo.398.1"> tab, right-click it, hover over </span><strong class="bold"><span class="koboSpan" id="kobo.399.1">Attack</span></strong><span class="koboSpan" id="kobo.400.1">, then click </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">on </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.402.1">Fuzz…</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.403.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.404.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.405.1">Message Processors</span></strong><span class="koboSpan" id="kobo.406.1"> tab, and click on </span><strong class="bold"><span class="koboSpan" id="kobo.407.1">Add</span></strong><span class="koboSpan" id="kobo.408.1">, which will open the </span><strong class="bold"><span class="koboSpan" id="kobo.409.1">Add Message </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.410.1">Processor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.411.1"> window.</span></span></li>
<li><span class="koboSpan" id="kobo.412.1">When the </span><strong class="bold"><span class="koboSpan" id="kobo.413.1">Add Message Processor</span></strong><span class="koboSpan" id="kobo.414.1"> window opens, select the script that we added earlier in the </span><strong class="bold"><span class="koboSpan" id="kobo.415.1">Script</span></strong><span class="koboSpan" id="kobo.416.1"> field, and click on </span><strong class="bold"><span class="koboSpan" id="kobo.417.1">Add</span></strong><span class="koboSpan" id="kobo.418.1">, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.419.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.420.1">.13</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.421.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.422.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.423.1">Fuzz Locations</span></strong><span class="koboSpan" id="kobo.424.1"> tab, select </span><strong class="bold"><span class="koboSpan" id="kobo.425.1">password</span></strong><span class="koboSpan" id="kobo.426.1">, and click on </span><strong class="bold"><span class="koboSpan" id="kobo.427.1">Add</span></strong><span class="koboSpan" id="kobo.428.1">. </span><span class="koboSpan" id="kobo.428.2">When the </span><strong class="bold"><span class="koboSpan" id="kobo.429.1">Payloads</span></strong><span class="koboSpan" id="kobo.430.1"> window opens, click on </span><strong class="bold"><span class="koboSpan" id="kobo.431.1">Add</span></strong><span class="koboSpan" id="kobo.432.1"> again. </span><span class="koboSpan" id="kobo.432.2">When the </span><strong class="bold"><span class="koboSpan" id="kobo.433.1">Add Payload</span></strong><span class="koboSpan" id="kobo.434.1"> window appears, select </span><strong class="bold"><span class="koboSpan" id="kobo.435.1">Strings</span></strong><span class="koboSpan" id="kobo.436.1"> as the type and enter the list of the passwords provided in the lab. </span><span class="koboSpan" id="kobo.436.2">The passwords are seen when you click on the </span><strong class="bold"><span class="koboSpan" id="kobo.437.1">Candidate passwords</span></strong><span class="koboSpan" id="kobo.438.1"> link on the lab home page before accessing the lab. </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.439.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.440.1">.17</span></em><span class="koboSpan" id="kobo.441.1"> shows the list of passwords in the payload. </span><span class="koboSpan" id="kobo.441.2">When you have entered the passwords, click on </span><strong class="bold"><span class="koboSpan" id="kobo.442.1">Add</span></strong><span class="koboSpan" id="kobo.443.1">, and then </span><strong class="bold"><span class="koboSpan" id="kobo.444.1">OK</span></strong><span class="koboSpan" id="kobo.445.1"> in the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.446.1">Payloads</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.447.1"> window.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer210">
<span class="koboSpan" id="kobo.448.1"><img alt="Figure 8.17 – Candidate password payloads " src="image/Figure_8.17_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.449.1">Figure 8.17 – Candidate password payloads</span></p>
<ol>
<li value="22"><span class="koboSpan" id="kobo.450.1">Then, click</span><a id="_idIndexMarker390"/><span class="koboSpan" id="kobo.451.1"> on </span><strong class="bold"><span class="koboSpan" id="kobo.452.1">Start Fuzzer</span></strong><span class="koboSpan" id="kobo.453.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.454.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.455.1">.19</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.456.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer211">
<span class="koboSpan" id="kobo.457.1"><img alt="Figure 8.18 – Start Fuzzer of payload " src="image/Figure_8.18_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.458.1">Figure 8.18 – Start Fuzzer of payload</span></p>
<ol>
<li value="23"><span class="koboSpan" id="kobo.459.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.460.1">Fuzzer</span></strong><span class="koboSpan" id="kobo.461.1"> tab, sort on the </span><strong class="bold"><span class="koboSpan" id="kobo.462.1">Code</span></strong><span class="koboSpan" id="kobo.463.1"> column by clicking on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.464.1">Code</span></strong><span class="koboSpan" id="kobo.465.1"> word. </span><span class="koboSpan" id="kobo.465.2">The correct</span><a id="_idIndexMarker391"/><span class="koboSpan" id="kobo.466.1"> password will show </span><strong class="source-inline"><span class="koboSpan" id="kobo.467.1">302 Found</span></strong><span class="koboSpan" id="kobo.468.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.469.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.470.1">.20</span></em><span class="koboSpan" id="kobo.471.1">. </span><span class="koboSpan" id="kobo.471.2">The correct password is listed in the </span><strong class="bold"><span class="koboSpan" id="kobo.472.1">Payloads</span></strong><span class="koboSpan" id="kobo.473.1"> column, and in my case, it </span><span class="No-Break"><span class="koboSpan" id="kobo.474.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">montana</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.476.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer212">
<span class="koboSpan" id="kobo.477.1"><img alt="Figure 8.19 – 302 Found of correct password " src="image/Figure_8.19_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.478.1">Figure 8.19 – 302 Found of correct password</span></p>
<ol>
<li value="24"><span class="koboSpan" id="kobo.479.1">Now that we have the correct username and password, let’s try to log in to the web page using these details. </span><span class="koboSpan" id="kobo.479.2">If your login is successful, the application will display your username and email, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.480.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.481.1">.21</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.482.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer213">
<span class="koboSpan" id="kobo.483.1"><img alt="Figure 8.20 – Display of solved lab " src="image/Figure_8.20_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.484.1">Figure 8.20 – Display of solved lab</span></p>
<h2 id="_idParaDest-238"><a id="_idTextAnchor307"/><span class="koboSpan" id="kobo.485.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.486.1">Many system login processes require a username and password. </span><span class="koboSpan" id="kobo.486.2">If you look closely, when guessing usernames, when the correct username is found but an incorrect password is entered, it takes longer than when an incorrect username and incorrect password are</span><a id="_idIndexMarker392"/><span class="koboSpan" id="kobo.487.1"> both entered. </span><span class="koboSpan" id="kobo.487.2">This would allow us to find the correct username even if the correct password is unknown. </span><span class="koboSpan" id="kobo.487.3">From there, it would be much easier to guess the password if the username is known than try to guess both. </span><span class="koboSpan" id="kobo.487.4">Process timing attacks of this type allow the attacker to determine whether they have a valid username by analyzing the time it takes for the process to complete, rather than relying on </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">GUI messages.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.489.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.490.1">A fuzzing assault on both the username and password simultaneously (aka cluster bombing), can also be used to brute-force the login. </span><span class="koboSpan" id="kobo.490.2">However, if feasible, it is considerably more efficient to enumerate a valid </span><span class="No-Break"><span class="koboSpan" id="kobo.491.1">username first.</span></span></p>
<h2 id="_idParaDest-239"><a id="_idTextAnchor308"/><span class="koboSpan" id="kobo.492.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.493.1">For other similar cases, visit </span><span class="No-Break"><span class="koboSpan" id="kobo.494.1">the following:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.495.1">Testing for Cookies </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.496.1">Attributes</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/02-Testing_for_Cookies_Attributes"><span class="No-Break"><span class="koboSpan" id="kobo.498.1">https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/02-Testing_for_Cookies_Attributes</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.499.1">Test Session </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.500.1">Timeout</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.501.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/07-Testing_Session_Timeout"><span class="No-Break"><span class="koboSpan" id="kobo.502.1">https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/07-Testing_Session_Timeout</span></span></a></li>
</ul>
<h1 id="_idParaDest-240"><span class="koboSpan" id="kobo.503.1">T</span><a id="_idTextAnchor309"/><span class="koboSpan" id="kobo.504.1">esting for the circumvention of w</span><a id="_idTextAnchor310"/><span class="koboSpan" id="kobo.505.1">orkflows</span></h1>
<p><span class="koboSpan" id="kobo.506.1">The workflow must be</span><a id="_idIndexMarker393"/><span class="koboSpan" id="kobo.507.1"> stopped with all actions and new activities </span><em class="italic"><span class="koboSpan" id="kobo.508.1">rolled back</span></em><span class="koboSpan" id="kobo.509.1"> or canceled if the user fails to complete particular stages in the right/precise order, as required by the application’s business logic. </span><span class="koboSpan" id="kobo.509.2">This lab makes assumptions that are inherently fallible about the sequence of events in the application’s purchasing business workflow. </span><span class="koboSpan" id="kobo.509.3">In this recipe, the attacker (you) will exploit a defect to purchase a leather jacket at no additional cost to </span><span class="No-Break"><span class="koboSpan" id="kobo.510.1">the user.</span></span></p>
<h2 id="_idParaDest-241"><a id="_idTextAnchor311"/><span class="koboSpan" id="kobo.511.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.512.1">For this recipe, you will need to start PortSwigger’s </span><em class="italic"><span class="koboSpan" id="kobo.513.1">Insufficient workflow validation</span></em><span class="koboSpan" id="kobo.514.1"> lab and ensure that ZAP is intercepting traffic between the lab application and </span><span class="No-Break"><span class="koboSpan" id="kobo.515.1">your browser.</span></span></p>
<h2 id="_idParaDest-242"><a id="_idTextAnchor312"/><span class="koboSpan" id="kobo.516.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.517.1">In this lab, we will demonstrate how to circumvent the item purchasing workflow by adding an item to the cart without an increase in price. </span><span class="koboSpan" id="kobo.517.2">Follow these steps to circumvent the </span><span class="No-Break"><span class="koboSpan" id="kobo.518.1">purchasing workflow:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.519.1">Navigate to the URL with the browser proxied to ZAP and log in to the PortSwigger Academy website to launch </span><span class="No-Break"><span class="koboSpan" id="kobo.520.1">the lab:</span></span></li>
</ol>
<p><a href="https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation"><span class="No-Break"><span class="koboSpan" id="kobo.521.1">https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation</span></span></a></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.522.1">With ZAP running and intercepting, log in to the lab application using the username and password provided: </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">wiener</span></strong><span class="koboSpan" id="kobo.524.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">peter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">, respectively.</span></span></li>
<li><span class="koboSpan" id="kobo.527.1">Go to the application home page and buy any item that you </span><em class="italic"><span class="koboSpan" id="kobo.528.1">can</span></em><span class="koboSpan" id="kobo.529.1"> afford with your store credit, such as the </span><em class="italic"><span class="koboSpan" id="kobo.530.1">Babbage </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.531.1">Web Spray</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.532.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.533.1">Look at the proxy </span><strong class="bold"><span class="koboSpan" id="kobo.534.1">History</span></strong><span class="koboSpan" id="kobo.535.1"> tab to look for the order when you </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">placed it:</span></span></li>
</ol>
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.537.1">POST /cart/checkout</span></strong></span></p>
<p><span class="koboSpan" id="kobo.538.1">This request redirects you to an order </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">confirmation page.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.540.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">GET /cart/order-confirmation?order-confirmation=true</span></strong><span class="koboSpan" id="kobo.542.1"> request </span><a id="_idIndexMarker394"/><span class="koboSpan" id="kobo.543.1">in ZAP’s Request Editor. </span><span class="koboSpan" id="kobo.543.2">See </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.544.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.545.1">.22</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.546.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer214">
<span class="koboSpan" id="kobo.547.1"><img alt="Figure 8.21 – GET request of Babbage Web Spray " src="image/Figure_8.21_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.548.1">Figure 8.21 – GET request of Babbage Web Spray</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.549.1">Next, add the leather jacket to </span><span class="No-Break"><span class="koboSpan" id="kobo.550.1">your basket.</span></span></li>
<li><span class="koboSpan" id="kobo.551.1">In the same Request Editor, resend the order confirmation request (as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.552.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.553.1">.21</span></em><span class="koboSpan" id="kobo.554.1">) and observe that the order is completed without the cost being deducted from your </span><span class="No-Break"><span class="koboSpan" id="kobo.555.1">store credit.</span></span></li>
<li><span class="koboSpan" id="kobo.556.1">Your </span><strong class="bold"><span class="koboSpan" id="kobo.557.1">History</span></strong><span class="koboSpan" id="kobo.558.1"> tab will show the successful request of the leather jacket being ordered. </span><span class="koboSpan" id="kobo.558.2">See </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.559.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.560.1">.23</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.561.1">.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.562.1">The lab </span><span class="No-Break"><span class="koboSpan" id="kobo.563.1">is solved.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer215">
<span class="koboSpan" id="kobo.564.1"><img alt="Figure 8.22 – Purchased leather jacket and completed lab " src="image/Figure_8.22_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.565.1">Figure 8.22 – Purchased leather jacket and completed lab</span></p>
<h2 id="_idParaDest-243"><a id="_idTextAnchor313"/><span class="koboSpan" id="kobo.566.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.567.1">Workflow flaws</span><a id="_idIndexMarker395"/><span class="koboSpan" id="kobo.568.1"> include any defect that enables an attacker to abuse a system or application such that they can avoid (not perform) the workflow that was planned or built. </span><span class="koboSpan" id="kobo.568.2">Vulnerabilities related to business logic workflows are unique; each system or application contains its own workflows to accomplish a task or a process. </span><span class="koboSpan" id="kobo.568.3">Therefore, manual misuse cases must be carefully developed with requirements and use cases specific to the workflow. </span><span class="koboSpan" id="kobo.568.4">If an exchange initiates an action, that response will be reversed and eliminated if the process is unsuccessful. </span><span class="koboSpan" id="kobo.568.5">The workflow of the application must contain controls to guarantee that the user’s transactions/actions are occurring in the </span><span class="No-Break"><span class="koboSpan" id="kobo.569.1">proper sequence.</span></span></p>
<p><span class="koboSpan" id="kobo.570.1">Due to a vulnerability’s specific nature for bypassing programmed logic, use cases are meticulous and require manual scrutiny to establish the correct requirements that avoid the circumvention of </span><span class="No-Break"><span class="koboSpan" id="kobo.571.1">the workflows.</span></span></p>
<h2 id="_idParaDest-244"><a id="_idTextAnchor314"/><span class="koboSpan" id="kobo.572.1">See also</span></h2>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.573.1">OWASP Abuse Case Cheat </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.574.1">Sheet</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.575.1">: </span></span><a href="https://cheatsheetseries.owasp.org/cheatsheets/Abuse_Case_Cheat_Sheet.html"><span class="No-Break"><span class="koboSpan" id="kobo.576.1">https://cheatsheetseries.owasp.org/cheatsheets/Abuse_Case_Cheat_Sheet.html</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.577.1">Testing Directory Traversal/File </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.578.1">Include</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.579.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/01-Testing_Directory_Traversal_File_Include"><span class="No-Break"><span class="koboSpan" id="kobo.580.1">https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/01-Testing_Directory_Traversal_File_Include</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.581.1">Testing for Bypassing Authorization </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.582.1">Schema</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.583.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/05-Authorization_Testing/02-Testing_for_Bypassing_Authorization_Schema"><span class="No-Break"><span class="koboSpan" id="kobo.584.1">https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/05-Authorization_Testing/02-Testing_for_Bypassing_Authorization_Schema</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.585.1">Testing for Session Management </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.586.1">Schema</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.587.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/06-Session_Management_Testing/01-Testing_for_Session_Management_Schema"><span class="No-Break"><span class="koboSpan" id="kobo.588.1">https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/06-Session_Management_Testing/01-Testing_for_Session_Management_Schema</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.589.1">Test Business Logic Data </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.590.1">Validation</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.591.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/01-Test_Business_Logic_Data_Validation"><span class="No-Break"><span class="koboSpan" id="kobo.592.1">https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/01-Test_Business_Logic_Data_Validation</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.593.1">Test Ability to Forge </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.594.1">Requests</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.595.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/02-Test_Ability_to_Forge_Requests"><span class="No-Break"><span class="koboSpan" id="kobo.596.1">https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/02-Test_Ability_to_Forge_Requests</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.597.1">Test Integrity </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.598.1">Checks</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.599.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/03-Test_Integrity_Checks"><span class="No-Break"><span class="koboSpan" id="kobo.600.1">https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/03-Test_Integrity_Checks</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.601.1">Test for Process </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.602.1">Timing</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.603.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/04-Test_for_Process_Timing"><span class="No-Break"><span class="koboSpan" id="kobo.604.1">https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/04-Test_for_Process_Timing</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.605.1">Test Number of Times a Function Can be Used </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.606.1">Limits</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.607.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/05-Test_Number_of_Times_a_Function_Can_Be_Used_Limits"><span class="No-Break"><span class="koboSpan" id="kobo.608.1">https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/05-Test_Number_of_Times_a_Function_Can_Be_Used_Limits</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.609.1">Test Defenses Against Application </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.610.1">Mis-use</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/07-Test_Defenses_Against_Application_Misuse"><span class="No-Break"><span class="koboSpan" id="kobo.612.1">https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/07-Test_Defenses_Against_Application_Misuse</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.613.1">Test Upload of Unexpected File </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.614.1">Types</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.615.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/08-Test_Upload_of_Unexpected_File_Types"><span class="No-Break"><span class="koboSpan" id="kobo.616.1">https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/08-Test_Upload_of_Unexpected_File_Types</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.617.1">Test Upload of Malicious </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.618.1">Files</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/09-Test_Upload_of_Malicious_Files"><span class="No-Break"><span class="koboSpan" id="kobo.620.1">https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/09-Test_Upload_of_Malicious_Files</span></span></a></li>
</ul>
<h1 id="_idParaDest-245"><a id="_idTextAnchor315"/><span class="koboSpan" id="kobo.621.1">Testing upload of unexpected file types with a malicious payload</span></h1>
<p><span class="koboSpan" id="kobo.622.1">Many business </span><a id="_idIndexMarker396"/><span class="koboSpan" id="kobo.623.1">processes in applications allow for the upload and modification of data supplied via uploaded files. </span><span class="koboSpan" id="kobo.623.2">The business process must examine the files and only accept specific </span><em class="italic"><span class="koboSpan" id="kobo.624.1">authorized</span></em><span class="koboSpan" id="kobo.625.1"> file types. </span><span class="koboSpan" id="kobo.625.2">The business logic is responsible for determining which files are </span><em class="italic"><span class="koboSpan" id="kobo.626.1">authorized</span></em><span class="koboSpan" id="kobo.627.1"> and whether they are application/system specific. </span><span class="koboSpan" id="kobo.627.2">In this recipe, we will attack an exploitable file upload option via profile avatar. </span><span class="koboSpan" id="kobo.627.3">Since certain file extensions are banned, the simple defense will be circumvented through traditional </span><span class="No-Break"><span class="koboSpan" id="kobo.628.1">obfuscation techniques.</span></span></p>
<p><span class="koboSpan" id="kobo.629.1">The user will upload a basic PHP web shell that will be used to exfiltrate the contents of a file secret in </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">/home/carlos/</span></strong><span class="koboSpan" id="kobo.631.1"> to complete </span><span class="No-Break"><span class="koboSpan" id="kobo.632.1">the lab.</span></span></p>
<h2 id="_idParaDest-246"><a id="_idTextAnchor316"/><span class="koboSpan" id="kobo.633.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.634.1">For this recipe, you will need to start PortSwigger’s </span><em class="italic"><span class="koboSpan" id="kobo.635.1">Web shell upload via obfuscated file extension</span></em><span class="koboSpan" id="kobo.636.1"> lab and ensure that ZAP is intercepting traffic between the lab application and </span><span class="No-Break"><span class="koboSpan" id="kobo.637.1">your browser.</span></span></p>
<h2 id="_idParaDest-247"><a id="_idTextAnchor317"/><span class="koboSpan" id="kobo.638.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.639.1">In this recipe, we will exploit a file upload option to upload a file and use it to exfiltrate data. </span><span class="koboSpan" id="kobo.639.2">Follow these instructions to see how to accomplish the file upload and the </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">data exfiltration:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.641.1">Navigate to the following URL with the browser proxied to ZAP and log in to the PortSwigger Academy website to launch </span><span class="No-Break"><span class="koboSpan" id="kobo.642.1">the lab:</span></span></li>
</ol>
<p><a href="https://portswigger.net/web-security/file-upload/lab-file-upload-web-shell-upload-via-obfuscated-file-extension"><span class="No-Break"><span class="koboSpan" id="kobo.643.1">https://portswigger.net/web-security/file-upload/lab-file-upload-web-shell-upload-via-obfuscated-file-extension</span></span></a></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.644.1">Log in using the username and password (</span><strong class="source-inline"><span class="koboSpan" id="kobo.645.1">wiener</span></strong><span class="koboSpan" id="kobo.646.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.647.1">peter</span></strong><span class="koboSpan" id="kobo.648.1">, respectively), upload any </span><strong class="source-inline"><span class="koboSpan" id="kobo.649.1">.jpg</span></strong><span class="koboSpan" id="kobo.650.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.651.1">.png</span></strong><span class="koboSpan" id="kobo.652.1"> image as your avatar, then click </span><strong class="bold"><span class="koboSpan" id="kobo.653.1">Back to My Account</span></strong><span class="koboSpan" id="kobo.654.1"> to return</span><a id="_idIndexMarker397"/><span class="koboSpan" id="kobo.655.1"> to your account page. </span><span class="koboSpan" id="kobo.655.2">See </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.656.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.657.1">.24</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer216">
<span class="koboSpan" id="kobo.659.1"><img alt="Figure 8.23 – Uploading avatar file " src="image/Figure_8.23_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.660.1">Figure 8.23 – Uploading avatar file</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.661.1">Go to </span><strong class="bold"><span class="koboSpan" id="kobo.662.1">History</span></strong><span class="koboSpan" id="kobo.663.1"> and look for your uploaded image that was retrieved using a </span><strong class="source-inline"><span class="koboSpan" id="kobo.664.1">GET</span></strong><span class="koboSpan" id="kobo.665.1"> request </span><span class="No-Break"><span class="koboSpan" id="kobo.666.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">/files/avatars/&lt;YOUR-IMAGE&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.668.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.669.1">Open this request in the </span><span class="No-Break"><span class="koboSpan" id="kobo.670.1">Request Editor.</span></span></li>
<li><span class="koboSpan" id="kobo.671.1">Create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1">exploit.php</span></strong><span class="koboSpan" id="kobo.673.1"> on your machine that contains a script for obtaining the contents of Carlos’s secret – for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.674.1">&lt;?php echo </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.675.1">file_get_contents('/home/carlos/secret'); ?&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.677.1">Try using this script as your avatar. </span><span class="koboSpan" id="kobo.677.2">As shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.678.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.679.1">.25</span></em><span class="koboSpan" id="kobo.680.1">, the answer shows that you are only permitted to submit JPG and </span><span class="No-Break"><span class="koboSpan" id="kobo.681.1">PNG files.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer217">
<span class="koboSpan" id="kobo.682.1"><img alt="Figure 8.24 – Upload exploit.php fail " src="image/Figure_8.24_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.683.1">Figure 8.24 – Upload exploit.php fail</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.684.1">In ZAP’s </span><strong class="bold"><span class="koboSpan" id="kobo.685.1">History</span></strong><span class="koboSpan" id="kobo.686.1"> tab, find the </span><strong class="source-inline"><span class="koboSpan" id="kobo.687.1">POST /my-account/avatar</span></strong><span class="koboSpan" id="kobo.688.1"> request that was used to submit the </span><span class="No-Break"><span class="koboSpan" id="kobo.689.1">file upload.</span></span></li>
<li><span class="koboSpan" id="kobo.690.1">In the Request Editor, open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.691.1">POST /my-account/avatar</span></strong><span class="koboSpan" id="kobo.692.1"> request and find the part of the body that relates to your PHP file. </span><span class="koboSpan" id="kobo.692.2">In the </span><strong class="bold"><span class="koboSpan" id="kobo.693.1">Content-Disposition</span></strong><span class="koboSpan" id="kobo.694.1"> header, change </span><a id="_idIndexMarker398"/><span class="koboSpan" id="kobo.695.1">the value of the filename parameter to include a URL-encoded null byte, followed by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.696.1">.jpg</span></strong><span class="koboSpan" id="kobo.697.1"> extension, </span><strong class="source-inline"><span class="koboSpan" id="kobo.698.1">filename="exploit.php%00.jpg"</span></strong><span class="koboSpan" id="kobo.699.1"> (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.700.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.701.1">.26</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.702.1">):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer218">
<span class="koboSpan" id="kobo.703.1"><img alt="Figure 8.25 – Request body of file uploaded, exploit.php " src="image/Figure_8.25_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.704.1">Figure 8.25 – Request body of file uploaded, exploit.php</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.705.1">Click on </span><strong class="bold"><span class="koboSpan" id="kobo.706.1">Send</span></strong><span class="koboSpan" id="kobo.707.1"> to send the request; as you can see, the file was </span><span class="No-Break"><span class="koboSpan" id="kobo.708.1">uploaded successfully.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.709.1">Notice that in the response’s message, the uploaded filename and format is </span><strong class="source-inline"><span class="koboSpan" id="kobo.710.1">exploit.php</span></strong><span class="koboSpan" id="kobo.711.1">, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.712.1">Figure 8</span></em></span><em class="italic"><span class="koboSpan" id="kobo.713.1">.27</span></em><span class="koboSpan" id="kobo.714.1">, which suggests that the null byte and </span><strong class="source-inline"><span class="koboSpan" id="kobo.715.1">.jpg</span></strong><span class="koboSpan" id="kobo.716.1"> extension have </span><span class="No-Break"><span class="koboSpan" id="kobo.717.1">been removed:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer219">
<span class="koboSpan" id="kobo.718.1"><img alt="Figure 8.26 – Successful upload of exploit.php " src="image/Figure_8.26_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.719.1">Figure 8.26 – Successful upload of exploit.php</span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.720.1">From the </span><strong class="bold"><span class="koboSpan" id="kobo.721.1">Sites</span></strong><span class="koboSpan" id="kobo.722.1"> window, open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.723.1">GET /files/avatars/&lt;YOUR-IMAGE&gt;</span></strong><span class="koboSpan" id="kobo.724.1"> request</span><a id="_idIndexMarker399"/><span class="koboSpan" id="kobo.725.1"> in the Request Editor. </span><span class="koboSpan" id="kobo.725.2">In the path, replace the name of your image file with </span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1">exploit.php</span></strong><span class="koboSpan" id="kobo.727.1"> and send the request. </span><span class="koboSpan" id="kobo.727.2">Observe that Carlos’s secret was returned in the response, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.728.1">Figure 8</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.729.1">.28</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.730.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer220">
<span class="koboSpan" id="kobo.731.1"><img alt="Figure 8.27 – Response with Carlos’ secret (blurred out) " src="image/Figure_8.27_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.732.1">Figure 8.27 – Response with Carlos’ secret (blurred out)</span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.733.1">Submit the secret to solve </span><span class="No-Break"><span class="koboSpan" id="kobo.734.1">the lab.</span></span></li>
</ol>
<h2 id="_idParaDest-248"><a id="_idTextAnchor318"/><span class="koboSpan" id="kobo.735.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.736.1">Due to the fact that the upload process promptly rejects a file if it lacks a specified extension, we had to use an obfuscation technique to trick the system into thinking that we were uploading a </span><strong class="source-inline"><span class="koboSpan" id="kobo.737.1">.jpg</span></strong><span class="koboSpan" id="kobo.738.1"> file. </span><span class="koboSpan" id="kobo.738.2">This differs from uploading malicious files in that a wrong file format isn’t generally deemed </span><em class="italic"><span class="koboSpan" id="kobo.739.1">malicious</span></em><span class="koboSpan" id="kobo.740.1">, although it may still be harmful to the </span><span class="No-Break"><span class="koboSpan" id="kobo.741.1">saved data.</span></span></p>
<p><span class="koboSpan" id="kobo.742.1">In the example </span><a id="_idIndexMarker400"/><span class="koboSpan" id="kobo.743.1">with the lab, the application only accepted specific file formats, </span><strong class="source-inline"><span class="koboSpan" id="kobo.744.1">.jpg</span></strong><span class="koboSpan" id="kobo.745.1"> files, for processing. </span><span class="koboSpan" id="kobo.745.2">For low assurance file validation, the program didn’t check the uploaded file’s content or, in other cases, the extension itself (high assurance file validation). </span><span class="koboSpan" id="kobo.745.3">This can cause the application or server to provide unexpected system or database results, or enable new ways for attackers to </span><span class="No-Break"><span class="koboSpan" id="kobo.746.1">take advantage.</span></span></p>
<h2 id="_idParaDest-249"><a id="_idTextAnchor319"/><span class="koboSpan" id="kobo.747.1">See also</span></h2>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.748.1">Test File Extensions Handling for Sensitive </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.749.1">Information</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.750.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/03-Test_File_Extensions_Handling_for_Sensitive_Information"><span class="No-Break"><span class="koboSpan" id="kobo.751.1">https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/03-Test_File_Extensions_Handling_for_Sensitive_Information</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.752.1">Test Upload of Malicious </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.753.1">Files</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.754.1">: </span></span><a href="https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/10-Business_Logic_Testing/09-Test_Upload_of_Malicious_Files"><span class="No-Break"><span class="koboSpan" id="kobo.755.1">https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/10-Business_Logic_Testing/09-Test_Upload_of_Malicious_Files</span></span></a></li>
</ul>
</div>
</body></html>